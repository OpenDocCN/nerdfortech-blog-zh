<html>
<head>
<title>How to configure a reverse proxy for Web Services on AWS using Ansible.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Ansible 在 AWS 上配置 Web 服务的反向代理。</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-configure-a-reverse-proxy-for-web-services-on-aws-using-ansible-playbook-bacc44e692a?source=collection_archive---------12-----------------------#2021-06-07">https://medium.com/nerd-for-tech/how-to-configure-a-reverse-proxy-for-web-services-on-aws-using-ansible-playbook-bacc44e692a?source=collection_archive---------12-----------------------#2021-06-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/3c76439d7f165ef6425982c4c05383d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k84KEXRYDJm_MIZP08y7Fw.png"/></div></figure><p id="459a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">本文将介绍如何为 web 服务提供 ec2 实例，以及如何使用 Ansible 通过 AWS 为这些 Web 服务设置负载平衡器。</p><p id="ac96" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我介绍什么是负载平衡器以及如何为 web 服务配置负载平衡器之前，我们先来看一个场景。</p><p id="4fa5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您有一台可以同时管理 1000 台客户机的 web 服务器。突然，对该特定服务器的请求增加到 1500 个客户端。很可能网站会崩溃或者被终止。为了避免这种情况，需要设置另一个目标 web 服务器。在这种情况下，将客户机连接到哪个目标 web 服务器以及如何连接是一个挑战！</p><p id="535d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了解决这一挑战，在前端设置了一个主服务器，客户端从不访问目标 web 服务器。相反，他们的请求发送到主服务器，主服务器将请求发送到目标 web 服务器。当目标 web 服务器回复主 web 服务器时，它会被发送回客户端。这个概念被称为<strong class="io hj">反向代理</strong>。</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es jk"><img src="../Images/a32c0c2d05e494f38296d969c47f66cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F0BIqYJ5LzuUwrbkb5m-Xw.png"/></div></div></figure><h1 id="9621" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">T3 什么是负载均衡器？ </strong></h1><p id="296e" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">负载平衡器是在各种后端服务器之间分配网络流量的有效方式。它也被称为服务器场或服务器池。它将客户端请求或网络负载分配给目标 web 服务器。负载平衡器基于循环概念工作，这确保了高可靠性和可用性。</p><blockquote class="kx ky kz"><p id="b445" class="im in la io b ip iq ir is it iu iv iw lb iy iz ja lc jc jd je ld jg jh ji jj hb bi translated">在您的 web 服务器基础设施前放置一个负载平衡器有助于确保任何流量高峰都不会导致站点停机。</p></blockquote><h1 id="077c" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak"> <em class="kr">【高可用性代理】</em> </strong></h1><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es le"><img src="../Images/89b8b73a2429b3beec8f89734a2b9d36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wl9H3_nkrRdPeBM0SU6wzQ.png"/></div></div></figure><p id="071f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">HAProxy 代表高可用性代理，是一个流行的开源软件 TCP/HTTP 负载平衡器，可以配置为反向代理。它最常见的用途是通过在多个服务器(例如，web、应用程序、数据库)之间分配工作负载来提高服务器环境的性能和可靠性。它用于高流量服务，如:GitHub、Imgur、Instagram 和 Twitter。</p><p id="96b0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">更多关于哈普洛克西:<a class="ae lf" href="https://www.haproxy.org/#desc" rel="noopener ugc nofollow" target="_blank">https://www.haproxy.org/#desc</a></p><p id="0342" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们进入配置部分。</p><p id="068b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在本文中，您将学习如何在 AWS 上创建一个类似如下所示的设置:</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es lg"><img src="../Images/a3e18952042955f487c41ce933249ac1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vorx2LPbjSUO6ldku67Piw.png"/></div></div></figure><p id="a696" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为此，您需要在 AWS 上启动 4 个 ec2 实例，1 个作为主服务器(负载平衡器), 3 个作为后端 web 服务器。我们将要执行的步骤:</p><ol class=""><li id="18df" class="lh li hi io b ip iq it iu ix lj jb lk jf ll jj lm ln lo lp bi translated">使用 Ansible 提供 EC2 实例</li><li id="e167" class="lh li hi io b ip lq it lr ix ls jb lt jf lu jj lm ln lo lp bi translated">使用动态清单的概念检索实例的 IP 地址</li><li id="dc33" class="lh li hi io b ip lq it lr ix ls jb lt jf lu jj lm ln lo lp bi translated">使用角色配置 web 服务器。</li><li id="5f9a" class="lh li hi io b ip lq it lr ix ls jb lt jf lu jj lm ln lo lp bi translated">使用 Ansible 角色配置负载平衡器。</li><li id="f89b" class="lh li hi io b ip lq it lr ix ls jb lt jf lu jj lm ln lo lp bi translated">负载平衡器的目标节点应该根据 web 服务器的状态自动更新。</li></ol><p id="e253" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要了解如何在 AWS 上启动 ec2 实例，以及如何使用 Ansible playbook 为 Web 服务器配置 ec2 实例，阅读下面的链接是继续阅读本文的先决条件:</p><div class="lv lw ez fb lx ly"><a href="https://priyankaa2023.medium.com/automating-provisioning-and-configuration-of-amazon-ec2-instance-ansible-dd34df237a0c" rel="noopener follow" target="_blank"><div class="lz ab dw"><div class="ma ab mb cl cj mc"><h2 class="bd hj fi z dy md ea eb me ed ef hh bi translated">Amazon ec2 实例 Ansible 的自动化供应和配置。</h2><div class="mf l"><h3 class="bd b fi z dy md ea eb me ed ef dx translated">在本文中，您将了解到我们如何能够自动化启动 ec2 实例到配置它的整个设置…</h3></div><div class="mg l"><p class="bd b fp z dy md ea eb me ed ef dx translated">priyankaa2023.medium.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm ik ly"/></div></div></a></div><h2 id="654f" class="mn ju hi bd jv mo mp mq jz mr ms mt kd ix mu mv kh jb mw mx kl jf my mz kp na bi translated"><strong class="ak"> <em class="kr"> 1。使用 Ansible </em> </strong>提供 EC2 实例</h2><p id="659c" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">为 webserver 启动 ec2 实例的剧本代码如下所示:</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nd"><img src="../Images/0db7c6b2effe8ed7dcb4da8f10804f24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Y_T5dsljIbuVBzwh7lgOw.png"/></div></div></figure><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es ne"><img src="../Images/40ca5c37cfa687ac3833c946f5bfd942.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tnlt9QKungA0MF_cYbc9ig.png"/></div></div></figure><h2 id="362f" class="mn ju hi bd jv mo mp mq jz mr ms mt kd ix mu mv kh jb mw mx kl jf my mz kp na bi translated"><strong class="ak"> <em class="kr"> 2。使用动态清单的概念检索实例的 IP 地址</em> </strong></h2><p id="6fcc" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">请阅读我下面的文章，了解什么是 Ansible 动态库存以及如何使用动态库存在 AWS 上检索实例的公共 IP。</p><div class="lv lw ez fb lx ly"><a href="https://priyankaa2023.medium.com/automating-provisioning-and-configuration-of-amazon-ec2-instance-ansible-dd34df237a0c" rel="noopener follow" target="_blank"><div class="lz ab dw"><div class="ma ab mb cl cj mc"><h2 class="bd hj fi z dy md ea eb me ed ef hh bi translated">Amazon ec2 实例 Ansible 的自动化供应和配置。</h2><div class="mf l"><h3 class="bd b fi z dy md ea eb me ed ef dx translated">在本文中，您将了解到我们如何能够自动化启动 ec2 实例到配置它的整个设置…</h3></div><div class="mg l"><p class="bd b fp z dy md ea eb me ed ef dx translated">priyankaa2023.medium.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm ik ly"/></div></div></a></div><pre class="jl jm jn jo fd nf ng nh ni aw nj bi"><span id="beea" class="mn ju hi ng b fi nk nl l nm nn">To list public IP of instances running on AWS using dynamic inventory<strong class="ng hj"> <br/>$ ansible ec2 --list-hosts</strong></span></pre><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nd"><img src="../Images/348bf33be7be18f5ed58b04279d12e68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nmf0Uae4YxpEcIs1_tzCDg.png"/></div></div></figure><h2 id="7280" class="mn ju hi bd jv mo mp mq jz mr ms mt kd ix mu mv kh jb mw mx kl jf my mz kp na bi translated"><strong class="ak"> <em class="kr"> 3。使用职责角色</em>配置 Web 服务器</strong></h2><p id="44d6" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">为此，您需要创建一个 Ansible 角色来将这些实例配置为 Apache Web 服务器，以作为后端/目标 Web 服务器。<strong class="io hj"> <em class="la">使用</em> </strong> <a class="ae lf" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html" rel="noopener ugc nofollow" target="_blank"> <strong class="io hj"> <em class="la">可变角色</em> </strong> </a>的目的是，角色让您根据已知的文件结构自动加载相关的变量、文件、任务、处理程序和其他可变工件。此外，将内容按角色分组后，您可以轻松地重用它们并与其他用户共享。</p><p id="5531" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一个角色有一个定义好的目录结构，有八个主要的标准目录。您必须在每个角色中至少包括其中一个目录。您可以省略角色不使用的任何目录。</p><p id="7230" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> <em class="la">为 Apache 创建角色:</em> </strong></p><p id="8f60" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在您的工作区中创建一个名为 roles 的目录。进入目录内部，使用命令<code class="du no np nq ng b">ansible-galaxy init &lt;role_name&gt;</code>创建一个角色，以创建角色目录结构。</p><pre class="jl jm jn jo fd nf ng nh ni aw nj bi"><span id="73b6" class="mn ju hi ng b fi nk nl l nm nn">#Create ansible role, apache within directory, roles<br/><strong class="ng hj">$ ansible-galaxy init apache</strong></span></pre><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nr"><img src="../Images/a4926a92510debebb59f1897d254ff36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YiyMigYtqse4ZUQYSu_ihA.png"/></div></div></figure><p id="cfe2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在你需要在<strong class="io hj">任务</strong>目录的“main.yml”文件中写下下面的任务脚本，如上图所示:</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><ul class=""><li id="f0aa" class="lh li hi io b ip iq it iu ix lj jb lk jf ll jj ns ln lo lp bi translated">第一步，使用<strong class="io hj">包</strong>模块，在目标节点上安装 httpd 软件。</li><li id="deac" class="lh li hi io b ip lq it lr ix ls jb lt jf lu jj ns ln lo lp bi translated">接下来，使用<strong class="io hj">复制</strong>模块，将网页从源复制到目的地，/var/www/html。这里的源文件 index.php 需要放到<strong class="io hj">文件</strong>目录中，以便在运行角色时自动加载。</li><li id="7251" class="lh li hi io b ip lq it lr ix ls jb lt jf lu jj ns ln lo lp bi translated">最后，服务模块用于启动和启用 httpd 服务。</li></ul><p id="23b6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你可能已经注意到在上面的 tasks/main.yml 文件中，我已经通知了 handler 来避免不必要的一次又一次重新启动服务，而不是当网页中有变化时<strong class="io hj"> handler </strong>会在收到通知时重新启动服务。因此，为此您需要在 handlers/main.yml 文件中为处理程序编写脚本，如下所示(参见上面的角色目录结构)。</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><p id="fdfc" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，您已经编写了所有必需的文件，您还可以从角色目录结构中删除不需要的目录(可选)。</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nt"><img src="../Images/019df1bd5e03ad05ca590b62dcff5059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qN4o_mKv40HDZPlAu9NVjg.png"/></div></div></figure><p id="d5a6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，创建完角色后，需要将角色路径更新到/etc/ansible/ansible.cfg 文件中，如下所示:</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nu"><img src="../Images/31d5849bdca40119c0ecbe727200701f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*prhNlRzY1iZYUksQz2gDpA.png"/></div></div></figure><p id="c10e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">此外，您需要创建一个剧本，其中包括上述 apache 角色，您需要在指定的主机上进行 httpd 配置。要获取有关主机组的信息，请运行如下所示的动态清单 python 脚本:</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nu"><img src="../Images/5c26c61ec42452a21e4b8d398808937b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AxdXHkVtnrtG1akXZYfL9g.png"/></div></div></figure><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nd"><img src="../Images/dd71f29fc080b83644e5f9a89cffbaed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P94lzeD4UWGXHYletm_DyQ.png"/></div></div></figure><p id="fa1c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用突出显示的组名来配置 web 服务器。运行下面的行动手册代码，为 httpd web 服务器配置这组实例:</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es ne"><img src="../Images/31320d61a24fbb9eda970fcd8a1a3acd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h4mEuZuxcs0PqnMG1CTX-g.png"/></div></div></figure><p id="f264" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">太棒了！！让我们前进到 HAProxy 配置部分！</p><h2 id="6c46" class="mn ju hi bd jv mo mp mq jz mr ms mt kd ix mu mv kh jb mw mx kl jf my mz kp na bi translated"><strong class="ak">4<em class="kr">。为反向代理</em>提供 EC2 实例</strong></h2><p id="4440" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">要进行 HAProxy 配置，您需要提供一个 ec2 实例，并为 HAProxy 负载平衡器配置它。使用与上面相同的脚本来启动 ec2 实例(只需将上面文件中的标记名更改为“haproxy”并计数为 1，如下所示)。</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nv"><img src="../Images/7c7251a5f7cda2b09ccb7a3220e586aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xSn0mjq4lxSngzPL4wfFjA.png"/></div></div></figure><h2 id="932c" class="mn ju hi bd jv mo mp mq jz mr ms mt kd ix mu mv kh jb mw mx kl jf my mz kp na bi translated">5.<strong class="ak"> <em class="kr">使用角色配置负载平衡器</em> </strong></h2><p id="3c20" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">随着实例的启动，现在您需要在 Ansible 的帮助下配置它。为此，创建一个 Ansible 角色，就像我们为 web 服务器所做的那样。</p><p id="54cb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> <em class="la">为 HA 代理 LB 创建角色:</em> </strong></p><p id="607d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在工作区的同一个“roles”目录中创建一个名为“haproxy”的角色。</p><pre class="jl jm jn jo fd nf ng nh ni aw nj bi"><span id="33cf" class="mn ju hi ng b fi nk nl l nm nn">#Create ansible role, haproxy within directory, roles<br/><strong class="ng hj">$ ansible-galaxy init haproxy</strong></span><span id="2640" class="mn ju hi ng b fi nw nl l nm nn">#To list roles present<br/><strong class="ng hj">$ ansible-galaxy role list</strong></span></pre><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nx"><img src="../Images/4a110202c1aaa54ee2e4f15486c0bb96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XcQA4jd04qJeTL5RroPYAA.png"/></div></div></figure><p id="38af" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">类似地，如前所述，创建任务，将实例配置为 HA 代理负载平衡器，作为反向代理<strong class="io hj">。</strong>在“任务”目录的“main.yml”文件中写下下面提到的脚本。</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><ul class=""><li id="b050" class="lh li hi io b ip iq it iu ix lj jb lk jf ll jj ns ln lo lp bi translated">第一步，使用<strong class="io hj">包</strong>模块，安装 haproxy 软件</li><li id="098b" class="lh li hi io b ip lq it lr ix ls jb lt jf lu jj ns ln lo lp bi translated">接下来，使用<strong class="io hj">模板</strong>模式将 HA 代理的配置文件 haproxy.cfg 从控制器节点复制到受管节点。<strong class="io hj"> <em class="la">模板模块不同于复制模块允许我们使用</em></strong><a class="ae lf" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.html" rel="noopener ugc nofollow" target="_blank"><strong class="io hj"><em class="la">jinja 2</em></strong><strong class="io hj"><em class="la">将模板动态渲染到文件</em> </strong>。这里，<strong class="io hj"> notify </strong>关键字用于通知处理程序在后端服务器有任何变化时重启服务。</a></li><li id="c8f1" class="lh li hi io b ip lq it lr ix ls jb lt jf lu jj ns ln lo lp bi translated">最后，<strong class="io hj">服务</strong>模块用于启动 HAProxy 服务。</li></ul><p id="5f06" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在，您需要创建自己的自定义配置文件 haproxy.cfg，并将其放入角色的 templates 目录中。</p><p id="aeaa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj"> <em class="la">创建自定义 haproxy.cfg 文件:</em> </strong></p><p id="df87" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您需要在您的控制器节点中有 haproxy.cfg 文件，以将其复制到<strong class="io hj"> templates </strong>目录中并进一步自定义。</p><pre class="jl jm jn jo fd nf ng nh ni aw nj bi"><span id="5e25" class="mn ju hi ng b fi nk nl l nm nn">#Copy haproxy.cfg file to templates directory of the haproxy role</span><span id="0938" class="mn ju hi ng b fi nw nl l nm nn"><strong class="ng hj">cp /etc/haproxy/haproxy.cfg  /&lt;workspace&gt;/roles/haproxy/templates/ haproxy.cfg</strong></span></pre><p id="4d46" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">默认情况下，前端绑定到端口 5000。将端口号更改为 8080。后端有'应用程序'块，你需要给你的后端服务器的 IP 到后端应用程序。应用一个<code class="du no np nq ng b">for</code>循环来配置后端 IP。现在，您可以根据需要启动任意数量的 web 服务器，并且不需要手动配置<code class="du no np nq ng b">/etc/httpd/httpd.conf</code>内部的 IP。它将自动从清单中获取 IP。</p><pre class="jl jm jn jo fd nf ng nh ni aw nj bi"><span id="f9f8" class="mn ju hi ng b fi nk nl l nm nn">backend app    <br/>balance     roundrobin <br/>{% for i in groups ["tag_Name_web_server"] %}    <br/>server   app{{ loop.index }} {{ i }}:80 check <br/>{% endfor %}</span></pre><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nv"><img src="../Images/480f3317b7e86921aa5f68aaabfb92cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VM4iZZp281yojazwPzhnyQ.png"/></div></div></figure><p id="0376" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，由于在上面的 tasks/main.yml 文件中我通知了 handler so，为此，我们需要将下面的脚本写入到 main.yml 文件的<strong class="io hj">角色的</strong>处理程序目录中。</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><p id="7e41" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在您已经创建了所有必需的文件，正如您可以从下面的角色目录结构中检查到的。此外，您可以从角色中删除不需要的目录(可选)。</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nd"><img src="../Images/5dbde53a4f2bddb5152ebe1e3dc69396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HTMDo5OP2NJRfsAN-2eSUg.png"/></div></div></figure><p id="e193" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，您需要一个剧本来针对负载平衡器的主机组运行。通过运行动态清单 python 脚本获取组名，如下所示:</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nd"><img src="../Images/646194b6a5d39dd3a5c5ad139a30ff5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MQPri7XvegjKC6SxPYbF6Q.png"/></div></div></figure><p id="5bb5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，您需要针对主机组“tag_Name_haproxy”编写并运行剧本代码，如下所示，以便为 haproxy 负载平衡器配置实例。</p><figure class="jl jm jn jo fd ij"><div class="bz dy l di"><div class="nb nc l"/></div></figure><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nv"><img src="../Images/a7f2efa3a94722229a3d9512477672ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tchzXETo0Qe3EkNlJPdkvg.png"/></div></div></figure><p id="2406" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一切就绪！！是时候看 Ansible 大放异彩了！</p><p id="7129" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以从 AWS Web 控制台检查所有实例是否都已启动并运行。</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es ny"><img src="../Images/325a3c13bdee80c22008fe3920fbed3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0lxeaT5lGmRN7jEKOosncg.png"/></div></div></figure><h1 id="b834" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak"> <em class="kr">输出</em> </strong></h1><p id="e601" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">行动手册成功运行，主 web 服务器可以使用负载平衡器访问三个目标 web 服务器，如下所示:</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nz"><img src="../Images/d955b7cb75464a96f3ab04a8c0bd5954.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GGFloSCu44yPtaBeJGeGbg.png"/></div></div></figure><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nz"><img src="../Images/bbb2d83b8e3730b089d18823dc10d1b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WvcS71W0XnpGEr-uenNiYw.png"/></div></div></figure><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nz"><img src="../Images/7f7176f21e6a473c38c7c5af5141a60a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IceFodrgtib-lonEFbNAgQ.png"/></div></div></figure><p id="54d6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Tada！！你做得很好！</p><h1 id="9587" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">下面总结一下你做了什么！</h1><p id="380c" class="pw-post-body-paragraph im in hi io b ip ks ir is it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj hb bi translated">使用 Ansible，我们联系 AWS，启动 Amazon ec2 实例，然后分别为负载平衡器和反向代理配置它们，以获得所需的设置。将 HAProxy 添加到您的基础设施中，不仅提高了 web 服务的可用性，还为后端服务器增加了一层额外的保护。</p><p id="e285" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要弄清楚的一件有趣的事情是，我在自动化工具的帮助下完成了整个设置，甚至没有进入实例。这就是自动化的力量！！</p><p id="6456" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你可以从下面的 GitHub 链接中得到我在上面用过的代码:</p><div class="lv lw ez fb lx ly"><a href="https://github.com/P-Bharti20/ansible_reverse_proxy" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab dw"><div class="ma ab mb cl cj mc"><h2 class="bd hj fi z dy md ea eb me ed ef hh bi translated">p-bharti 20/ansi ble _ reverse _ proxy</h2><div class="mf l"><h3 class="bd b fi z dy md ea eb me ed ef dx translated">使用 ansi ble-P-bharti 20/ansi ble _ reverse _ proxy 为 AWS 上的 web 服务配置反向代理</h3></div><div class="mg l"><p class="bd b fp z dy md ea eb me ed ef dx translated">github.com</p></div></div><div class="mh l"><div class="oa l mj mk ml mh mm ik ly"/></div></div></a></div><p id="15e8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">感谢您的阅读……如有任何疑问，请在下方留言。您可以通过与我联系:</p><div class="lv lw ez fb lx ly"><a href="https://www.linkedin.com/in/priyanka-bhartii/" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab dw"><div class="ma ab mb cl cj mc"><h2 class="bd hj fi z dy md ea eb me ed ef hh bi translated">Priyanka Bharti -本科生- BIT Sindri | LinkedIn</h2><div class="mf l"><h3 class="bd b fi z dy md ea eb me ed ef dx translated">目前是三年级学生在计算机科学与工程领域在 Birsa 理工学院，辛德里…</h3></div><div class="mg l"><p class="bd b fp z dy md ea eb me ed ef dx translated">www.linkedin.com</p></div></div><div class="mh l"><div class="ob l mj mk ml mh mm ik ly"/></div></div></a></div><p id="c5a5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">敬请期待如此精彩的内容！</p><figure class="jl jm jn jo fd ij er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es oc"><img src="../Images/5a7a34d0698d7f08687d261649b384d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r5VeD2fV04iDy8xfmaauHA.png"/></div></div></figure></div></div>    
</body>
</html>