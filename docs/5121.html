<html>
<head>
<title>How to call block of code in an optimized way.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何以优化的方式调用代码块？</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-call-block-of-code-in-an-optimized-way-46eb4707a87c?source=collection_archive---------5-----------------------#2021-08-30">https://medium.com/nerd-for-tech/how-to-call-block-of-code-in-an-optimized-way-46eb4707a87c?source=collection_archive---------5-----------------------#2021-08-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="bdf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我们将考虑如何以一种“智能”的方式在某个特定队列上执行代码块，即，是同步调用它(作为常规方法)还是必须使用<a class="ae jd" href="https://developer.apple.com/documentation/dispatch/dispatchqueue/1780621-getspecific" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">dispatch queue . get { set } Specific(key:)</strong></a><strong class="ih hj"/>方法在自定义队列上调度执行</p><p id="31f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近我在检查 XMPP 在 iOS 平台上的实现。在<a class="ae jd" href="https://github.com/robbiehanson/XMPPFramework" rel="noopener ugc nofollow" target="_blank"> XMPPFramework </a>中，我发现一些 Obj-C 代码允许在一些特定的队列上调度代码的执行:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="45cd" class="jn jo hi jj b fi jp jq l jr js">void *xmppQueueTag; //pointer to anything</span><span id="c4ec" class="jn jo hi jj b fi jt jq l jr js">- (void) init {<br/>   // ......<br/>  xmppQueueTag = &amp;xmppQueueTag;<br/>  xmppQueue = dispatch_queue_create("xmpp", DISPATCH_QUEUE_SERIAL);<br/>  dispatch_queue_set_specific(xmppQueue, xmppQueueTag, xmppQueueTag,<br/>NULL); //mark queue with key<br/>}</span><span id="ecde" class="jn jo hi jj b fi jt jq l jr js">- (void) runSync {<br/>  // check if code is running on specific queue. If true then run block, otherwise schedule synchronous execution</span><span id="a25a" class="jn jo hi jj b fi jt jq l jr js">  if (dispatch_get_specific(xmppQueueTag))<br/>     block(); // run block<br/>  else // schedule synchronous execution <br/>     dispatch_sync(xmppQueue, block);<br/>  }<br/>}</span></pre><p id="7d26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<strong class="ih hj"> runSync </strong>方法中，如果从预期队列中调用块代码，则执行块代码，否则计划在其上运行。</p><p id="416e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常我在主线程上安排“智能”执行。有一个线程的类属性:<strong class="ih hj"> Thread.isMainThread. </strong></p><p id="8d18" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记住，主队列是一个串行队列，只有一个线程(主线程)在这个队列上执行。在其他情况下，尽管 queue 是一个串行队列，但这并不意味着同一个线程正在其上运行。这意味着在这样的队列中只有一个操作是活动的，但是操作可以在不同的线程上执行。</p><p id="7345" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以在 Swift 中以典型的方式调用上面的代码(Obj-C ),即使用“桥接”。然而，最好不要混合 Swift 和 Obj-C 代码，尽管 UIView 和 UIViewController 是 NSObject 的后代，并且使用 Obj-C 运行时。但是模型、业务逻辑可以变得免费…</p><p id="04a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">DispatchQueue 中有适当的通用类方法:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="9327" class="jn jo hi jj b fi jp jq l jr js">class func getSpecific&lt;T&gt;(key: DispatchSpecificKey&lt;T&gt;) -&gt; T? //read<br/>func setSpecific&lt;T&gt;(key: DispatchSpecificKey&lt;T&gt;, value: T?) // write</span></pre><p id="06cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们添加了一些与队列的关联。在 Obj-C 代码中“队列值”是变量(<strong class="ih hj"> xmppQueueTag </strong>)的指针(地址)</p><p id="1de4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以我们可以检查线程的调度队列有一些特定的键值(下面代码中的随机固定值):</p><figure class="je jf jg jh fd ju"><div class="bz dy l di"><div class="jv jw l"/></div></figure><p id="c90f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">方法<strong class="ih hj"> runOnQueue </strong>允许在预期队列上运行时立即调用块(<strong class="ih hj"> checkIfQueue </strong>返回 true)，否则，根据<em class="jx"> dispatchSync </em>参数，该块将在特定队列上异步或同步运行。方法<strong class="ih hj"> TestQueue </strong>失败，如果它没有按预期启动，抛出 assert。方法<strong class="ih hj"> getSpecific(key </strong>:)返回固定的随机初始化的构造函数值，如果它是从我们的自定义队列中调度的，否则它返回 nil。</p><p id="628c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请记住，来自另一个线程的同步调用会导致死锁，如果调用线程等待调用者…</p></div><div class="ab cl jy jz gp ka" role="separator"><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd ke"/><span class="kb bw bk kc kd"/></div><div class="hb hc hd he hf"><p id="1adf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本教程中，我们设法创建了一个示例方法，允许以一种优化的、智能的方式调用一些特定队列上的代码块。</p></div></div>    
</body>
</html>