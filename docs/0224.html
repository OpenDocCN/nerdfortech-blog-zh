<html>
<head>
<title>Mirroring of Live Traffic in Kubernetes using Istio Traffic Mirroring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Istio 流量镜像对 Kubernetes 中的实时流量进行镜像</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/mirroring-of-live-traffic-in-kubernetes-using-istio-traffic-mirroring-36f8c4d32fe8?source=collection_archive---------0-----------------------#2020-07-25">https://medium.com/nerd-for-tech/mirroring-of-live-traffic-in-kubernetes-using-istio-traffic-mirroring-36f8c4d32fe8?source=collection_archive---------0-----------------------#2020-07-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="f30c" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">为什么需要流量镜像？</h2></div><p id="ff82" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上一篇文章<a class="ae jt" rel="noopener" href="/@pavan1999.kumar/weighted-routing-in-kubernetes-using-istio-5d9bdb495032"><strong class="iz hj">Kubernetes 中使用 Istio </strong> </a>的加权路由中，我们已经了解了如何通过让 25%的客户使用版本:v2 来将流量从版本:v1 迁移到版本:v2。当客户对新版本感到满意时，我们将总流量从版本:v1 迁移到版本:v2，零宕机。假设您部署了一个电子商务网站，现在是黑色星期五。你的网站比平时有更多的顾客。使用版本:v2 的客户面临着诸如 UI 缓慢、图像加载不当等问题。导致这些问题的原因是应用程序没有经过实时流量测试。在预生产环境中，已经进行了负载测试，但是使用的是历史流量/人工流量。很难预测应用程序将如何响应实时流量。感谢 Istio 的流量镜像功能。流量镜像也称为阴影，是一个强大的概念，允许功能团队以尽可能小的风险将更改引入生产。通过流量镜像功能，实际应用的实时流量被发送到镜像服务。</p><h2 id="72c4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke jg kf kg kh jk ki kj kk jo kl km kn ko bi translated">使用 Istio 流量镜像的优势:</h2><ol class=""><li id="ac66" class="kp kq hi iz b ja kr jd ks jg kt jk ku jo kv js kw kx ky kz bi translated">以尽可能小的风险带来生产环境的变化。</li><li id="cf05" class="kp kq hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">降低维护生产前环境的成本和工作量。</li><li id="acba" class="kp kq hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">使用实时流量测试新版本的应用程序。</li><li id="eb2e" class="kp kq hi iz b ja la jd lb jg lc jk ld jo le js kw kx ky kz bi translated">识别应用程序中的错误和问题会更快。</li></ol><p id="5ea5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您现在可能会想，当流量同时发送到实际服务和镜像服务时，发送给客户的响应会出现混乱。这里可以看到 Istio 的真正魔力。当实时流量被发送到镜像服务时，镜像服务不响应请求。它仅仅是实时流量的接收器。</p><p id="18a9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们现在开始行动吧。</p><blockquote class="lf lg lh"><p id="55a7" class="ix iy li iz b ja jb ij jc jd je im jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">在您决定启用 Istio 的特性之前，请确保使用以下标签来标记您的名称空间<strong class="iz hj"> istio-injection=enabled。</strong>当您标记名称空间时，注入 webhook 被启用，在该名称空间中创建的任何新 pod 将自动启用 sidecar 代理(envoy 代理)。</p></blockquote><p id="6f85" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在部署包含服务版本:v1 内容的网页的 Pod</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="lr ls l"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">版本:v1 的 Pod 规格文件</figcaption></figure><p id="2a10" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过 ClusterIP 服务公开您的 pod，因为我们将在集群内使用 curl 命令测试流量镜像。您可以将服务公开为负载平衡器，并在浏览器中测试它。因为我已经在 Oracle Virtual Box 中安装了我的 Kubernetes 集群，所以我将通过 ClusterIP 公开 pod，并使用 curl 命令来测试流量镜像。</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="08ca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，当 curl 命令被执行时，请求只被发送到版本:v1</p><blockquote class="lf lg lh"><p id="d5e4" class="ix iy li iz b ja jb ij jc jd je im jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated"><em class="hi">【root @ master istio-medium】#</em><strong class="iz hj"><em class="hi">kubectl run curl-test—image = odise/busybox-curl—RM-it—/bin/sh-c " while true；做 curl 网络服务；睡眠 1；搞定"</em></strong><em class="hi"><br/>&lt;html&gt;&lt;正文&gt; &lt; h1 &gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;T99】/body&gt;T101】/html&gt;T14】</em></p></blockquote><p id="c43b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们配置虚拟服务和目标规则来配置流量镜像</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="lr ls l"/></div></figure><p id="65ae" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们试着理解上面的文件在做什么。当 Istio 安装在您的 Kubernetes 集群中时，会部署许多 CRD。我们现在要关注的 CRD 是虚拟服务和目的地规则。虚拟服务为 Kubernetes 服务定义了一组流量路由规则。和目的地规则指定一旦满足路由规则，流量应该被路由到哪里。让我们详细研究一下 YAML 的档案。</p><p id="b569" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">虚拟服务:</strong></p><p id="a348" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">a)名称:指定虚拟服务的名称</p><p id="e340" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">b)主机:流量发送到的主机。这里的主机是我们的 Kubernetes 服务的 DNS 名称</p><p id="6dc9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">c) http:它是 http 流量的路由规则列表</p><p id="88de" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">d)子集:在相应的目的地规则中定义的业务应该被定向到的子集的名称</p><p id="195b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">e)权重:要转发给服务版本的通信量</p><p id="a0ea" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">f)镜像:应该镜像流量的目的地服务</p><p id="cb44" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">g) mirror_percent:由镜像字段镜像的流量的百分比</p><p id="856f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">目的地规则:</strong></p><p id="cf9e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">a)名称:目标规则的名称</p><p id="6ef2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">b)主机:流量发送到的主机。这里的主机是我们的 Kubernetes 服务的 DNS 名称</p><p id="5902" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">c)子集:代表服务的各个版本的命名集</p><p id="1019" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">d)子集名称:子集的名称</p><p id="250b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">e)标签:用于选择窗格的标签图</p><p id="77a1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在部署一个具有新版本 v2 的新 pod。该 pod 将由 web-service 服务选择器选取。</p><figure class="lm ln lo lp fd lq"><div class="bz dy l di"><div class="lr ls l"/></div></figure><blockquote class="lf lg lh"><p id="5ac9" class="ix iy li iz b ja jb ij jc jd je im jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">[root @ master istio-medium]#<strong class="iz hj">ku bectl run curl-test—image = odise/busybox-curl-it—/bin/sh-c " while true；do 日期；curl 网络服务；睡眠 1；done "</strong><br/>Fri 07 月 24 日 18:03:12 UTC 2020<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>Fri Jul 24 18:03:13 UTC 2020<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>Fri 7 月 24 日 18:03:14 UTC 2020<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>Fri Jul 24 18:03:15 UTC 2020<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>Fri 07 月 24 日 18:03:16 UTC 2020<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>Fri Jul 24 18:03:17 UTC 2020<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>Fri 7 月 24 日 18:03:18 UTC 2020<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>Fri 2020 年 7 月 24 日 18:03:19 UTC&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>Fri 07 月 24 日 18:03:20 UTC 2020&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是 V1 版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>世界协调时 2020 年 7 月 24 日 18:03:21</p></blockquote><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es lx"><img src="../Images/8c6788f2101a7135d40b1338723771f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uwdXaXdH1rMu1C2N1cw4pQ.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">对版本:v1 的请求</figcaption></figure><p id="191d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以推断出所有的请求都指向版本:v1，版本:v2 在做什么。让我们看看版本:v2 的日志</p><blockquote class="lf lg lh"><p id="c8bd" class="ix iy li iz b ja jb ij jc jd je im jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">[root @ master ~]#<strong class="iz hj">kubectl logs-f httpd-v2-c httpd</strong></p><p id="77d1" class="ix iy li iz b ja jb ij jc jd je im jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated">127 . 0 . 0 . 1—[24/Jul/2020:18:03:12+0000]" GET/HTTP/1.1 " 200 58<br/>127 . 0 . 0 . 1—[24/Jul/2020:18:03:13+0000]" GET/HTTP/1.1 " 200 58<br/>127 . 0 . 0 . 1—[24/Jul HTTP/1.1 " 200 58<br/>127 . 0 . 0 . 1—[24/Jul/2020:18:03:19+0000]" GET/HTTP/1.1 " 200 58<br/>127 . 0 . 0 . 1—[24/Jul/2020:18:03:20+0000]" GET/HTTP/1.1 " 200 58<br/></p></blockquote><figure class="lm ln lo lp fd lq er es paragraph-image"><div class="er es me"><img src="../Images/9184202028735abb9d1067de3b9e3c0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:710/format:webp/0*fZD_y6M0zZDRrN92.jpg"/></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">你看到了吗？</figcaption></figure><p id="ae1a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你看到了吗？我的版本:v2 pod 从哪里获得流量？Istio 幕后的数据平面和控制平面正在让这一切成为现实。应用程序的实际版本响应客户的请求。同时，流量的副本也正在发送到版本:v2。这就是我们可以在版本:v2 中看到流量的原因</p><p id="824c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们想象一下基亚利的交通流量。这是 Istio 提供的一个插件，用于更好地可视化你的服务网格。</p><blockquote class="lf lg lh"><p id="2b58" class="ix iy li iz b ja jb ij jc jd je im jf lj jh ji jj lk jl jm jn ll jp jq jr js hb bi translated"><strong class="iz hj"> <em class="hi"> istioctl 仪表盘 kiali </em> </strong></p></blockquote><figure class="lm ln lo lp fd lq er es paragraph-image"><div role="button" tabindex="0" class="ly lz di ma bf mb"><div class="er es mf"><img src="../Images/26e0ce0b7d4f0119923ae8aa18f39a3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9uAkAHmm8xH7wIFIDTd_dw.png"/></div></div><figcaption class="lt lu et er es lv lw bd b be z dx translated">显示交通流量的 Kiali 仪表盘</figcaption></figure><p id="4102" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">恭喜，我们已经成功地用实时交通测试了我们的应用。现在让我们应用<a class="ae jt" rel="noopener" href="/@pavan1999.kumar/weighted-routing-in-kubernetes-using-istio-5d9bdb495032"> <strong class="iz hj">加权路由</strong> </a>将流量从版本:v1 缓慢迁移到版本:v2</p></div><div class="ab cl mg mh gp mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="hb hc hd he hf"><h1 id="1bdd" class="mn jv hi bd jw mo mp mq ka mr ms mt ke io mu ip kh ir mv is kk iu mw iv kn mx bi translated">先决条件</h1><div class="my mz ez fb na nb"><a rel="noopener follow" target="_blank" href="/@pavan1999.kumar/introduction-to-istio-service-mesh-2bc68d2ffdac"><div class="nc ab dw"><div class="nd ab ne cl cj nf"><h2 class="bd hj fi z dy ng ea eb nh ed ef hh bi translated">Istio 服务网格简介</h2><div class="ni l"><h3 class="bd b fi z dy ng ea eb nh ed ef dx translated">什么是 Istio 服务网格？</h3></div><div class="nj l"><p class="bd b fp z dy ng ea eb nh ed ef dx translated">medium.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np mc nb"/></div></div></a></div><div class="my mz ez fb na nb"><a rel="noopener follow" target="_blank" href="/@pavan1999.kumar/how-to-install-istio-using-istioctl-1557db1cd62d"><div class="nc ab dw"><div class="nd ab ne cl cj nf"><h2 class="bd hj fi z dy ng ea eb nh ed ef hh bi translated">如何使用 istioctl 安装 Istio</h2><div class="ni l"><h3 class="bd b fi z dy ng ea eb nh ed ef dx translated">正如我在之前的文章中所讨论的，我们将致力于一些实时场景，在这些场景中，我们将能够…</h3></div><div class="nj l"><p class="bd b fp z dy ng ea eb nh ed ef dx translated">medium.com</p></div></div><div class="nk l"><div class="nq l nm nn no nk np mc nb"/></div></div></a></div><h1 id="126c" class="mn jv hi bd jw mo nr mq ka mr ns mt ke io nt ip kh ir nu is kk iu nv iv kn mx bi translated">被推荐的</h1><div class="my mz ez fb na nb"><a rel="noopener follow" target="_blank" href="/@pavan1999.kumar/weighted-routing-in-kubernetes-using-istio-5d9bdb495032"><div class="nc ab dw"><div class="nd ab ne cl cj nf"><h2 class="bd hj fi z dy ng ea eb nh ed ef hh bi translated">Kubernetes 中使用 Istio 的加权路由</h2><div class="ni l"><h3 class="bd b fi z dy ng ea eb nh ed ef dx translated">让我们假设您的客户正在使用您的应用程序的版本:v1。应用程序的新版本:v2 是…</h3></div><div class="nj l"><p class="bd b fp z dy ng ea eb nh ed ef dx translated">medium.com</p></div></div><div class="nk l"><div class="nw l nm nn no nk np mc nb"/></div></div></a></div><div class="my mz ez fb na nb"><a rel="noopener follow" target="_blank" href="/@pavan1999.kumar/mtls-in-istio-970f0666b867"><div class="nc ab dw"><div class="nd ab ne cl cj nf"><h2 class="bd hj fi z dy ng ea eb nh ed ef hh bi translated">伊斯蒂奥的 MTLS</h2><div class="ni l"><h3 class="bd b fi z dy ng ea eb nh ed ef dx translated">通过插入现有 CA 证书在 Istio 服务网格中设置相互 TLS</h3></div><div class="nj l"><p class="bd b fp z dy ng ea eb nh ed ef dx translated">medium.com</p></div></div><div class="nk l"><div class="nx l nm nn no nk np mc nb"/></div></div></a></div></div></div>    
</body>
</html>