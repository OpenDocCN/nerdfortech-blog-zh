<html>
<head>
<title>NestJs: Firebase Auth secured NestJs app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NestJs: Firebase Auth安全的NestJs应用程序</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/nestjs-firebase-auth-secured-nestjs-resource-server-9649bcebd0de?source=collection_archive---------0-----------------------#2020-09-27">https://medium.com/nerd-for-tech/nestjs-firebase-auth-secured-nestjs-resource-server-9649bcebd0de?source=collection_archive---------0-----------------------#2020-09-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/28d9d2b263f3794331d96d249d20ead0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cv4L0s62AKaMR2FHvX0k8w.png"/></div></div></figure><p id="a10a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">NestJs是用TypeScript和/或JavaScript编写的优秀的NodeJs框架。它的效率和可伸缩性使您能够创建一系列不同的应用程序后端。这使得在你的应用中有一个严格的安全机制变得非常重要。这篇文章将帮助你通过Firebase Auth保护你的NestJs APIs。</p><h1 id="112d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> <em class="km">步骤#1 </em> </strong>:创建一个Firebase项目，添加一个web app。</h1><p id="4ba9" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在这里按照步骤<a class="ae ks" rel="noopener" href="/@sharma.vikashkr/firebase-how-to-setup-an-app-in-firebase-9ddbacfe8ad1">进行</a>。</p><h1 id="3279" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">步骤#2 </strong>:创建一个NestJs项目。</h1><p id="acb1" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">同样，我更喜欢使用Nest CLI。如果您没有Nest CLI，请使用以下命令通过NPM下载该软件包:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="3b16" class="lc jp hi ky b fi ld le l lf lg"><strong class="ky hj">$ npm install -g @nestjs/cli</strong></span></pre><p id="2298" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个NestJs应用程序(我将我的项目命名为'<em class="lh">firebase-auth '</em>)；给出您选择的任何名称)，在您的首选文件夹中打开一个控制台，并运行命令:</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="f82c" class="lc jp hi ky b fi ld le l lf lg"><strong class="ky hj">$ nest new firebase-auth</strong></span></pre><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es li"><img src="../Images/b3e1f3abe62ced99e8029c0aad1fbf8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/1*fctuha9Fuq5k8Ua0VAep3w.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">创建新的NestJs项目</figcaption></figure><h1 id="a195" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> <em class="km">步骤#3 </em> </strong>:安装firebase依赖项</h1><p id="32b8" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在新项目中使用控制台，并将'<em class="lh"> firebase-admin </em>'包添加到项目中。</p><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="33d0" class="lc jp hi ky b fi ld le l lf lg"><strong class="ky hj">$ npm install — save firebase-admin</strong></span></pre><h1 id="3374" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> <em class="km">第四步</em> </strong>:创建firebase服务帐号</h1><p id="d92e" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在firebase控制台中创建一个服务帐户，并下载服务帐户JSON文件。在这里跟随<a class="ae ks" rel="noopener" href="/@sharma.vikashkr/firebase-how-to-setup-a-firebase-service-account-836a70bb6646">的步骤</a>。</p><h1 id="9db8" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> <em class="km">步骤#5 </em> </strong>:下载项目中的服务账号JSON</h1><p id="8fc0" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在您喜欢的IDE中打开项目。创建一个文件夹，在src里面说'<em class="lh"> auth </em>'。将服务帐户JSON文件复制到该文件夹中。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/ebb4434cf7d1dc1c970af1992663de24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T73ioNqbbrwlAO1OVu33ig.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">添加库firebase-admin</figcaption></figure><h1 id="0ca5" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">步骤#6 </strong>:允许resolveJsonModule</h1><p id="84b2" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在tsconfig.json文件中设置“resolveJsonModule”:true。这允许在Typescript中导入JSON文件。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/911c4b2bd1582f461b59b5c326cb5a0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tWCwwBJWQIJCTkZU87gniQ.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">允许TS中的JSON模块解析</figcaption></figure><h1 id="7b98" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> <em class="km">步骤#7 </em> </strong>:创建认证中间件</h1><p id="a9dd" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在auth文件夹中创建一个NestJs中间件，比如'<em class="lh"> preauth.middlewate.ts </em>'。使用服务帐户JSON创建常量JSON对象。导入firebase-admin SDK并使用常量JSON进行初始化。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/f316c582e1fe4a2eb2c3a8085913048d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f2GcZAmqC6vZ76iA2WvUCg.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">初始化Firebase管理SDK</figcaption></figure><h1 id="b2a5" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> <em class="km">步骤#8 </em> </strong>:验证firebase承载令牌</h1><p id="d254" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">修改中间件内部的'<em class="lh">使用</em>方法从请求中读取承载令牌，并使用firebase-admin验证令牌。最后，将包含用户电子邮件的对象设置为请求对象。<br/>注意:@ Line#33，我不会保护没有授权头的请求。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/5365f58e8565f575416112ca341de747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gRKTFiIcLc5pppn7UlT0xQ.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">通过Firebase Admin SDK验证令牌</figcaption></figure><h1 id="917a" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> <em class="km">步骤#9 </em> </strong>:注册中间件</h1><p id="079e" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">为所有请求在根模块中注册中间件。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/a1bcd488b6a114c8d92568b7a376b6b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KLhEqEAE-eG84ywVxf9Eeg.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">注册中间件</figcaption></figure><h1 id="ae2d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> <em class="km">步骤#10 </em> </strong>:创建控制器进行验证。</h1><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es ls"><img src="../Images/f08759df56a927c41df2767cd369b911.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*6pGqonj0ABlPDa2KGQPRTw.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">测试控制器</figcaption></figure><h1 id="9ef9" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">步骤#11:运行并验证故障场景</h1><pre class="kt ku kv kw fd kx ky kz la aw lb bi"><span id="55a3" class="lc jp hi ky b fi ld le l lf lg"><strong class="ky hj">$ npm run dev</strong></span></pre><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/f4f07b2088a66c095a4e3594b5fe8a92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*2cTaHmTmLnNutSYIXnWWiA.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">没有授权</figcaption></figure><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es lu"><img src="../Images/14269c555d48d978c2d918e5a6ab8842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*eFKS_lYFRYFqAQVrvoGLCg.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">无效授权</figcaption></figure><h1 id="e47d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> <em class="km">步骤#12 </em> </strong>:创建一个firebase用户并验证成功场景</h1><p id="168d" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">对于成功的流，创建任何客户机来接受firebase登录并获取有效的firebase idToken。将此令牌用作授权头中的无记名令牌。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lv"><img src="../Images/4c23b937c869dacd7fe39767a5375a49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u08jpVMl56OXvMYdlr_6Ow.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">在Firebase控制台中添加用户</figcaption></figure><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/2fbea0e5f9ff3d85a3789e3bd5bcfd1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fPY85EhnS6TOcJUddL9svg.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">有效授权</figcaption></figure><blockquote class="lx ly lz"><p id="f5a2" class="iq ir lh is b it iu iv iw ix iy iz ja ma jc jd je mb jg jh ji mc jk jl jm jn hb bi translated">代码库:【https://github.com/sharmavikashkr/firebase-auth-nestjs】T5<br/>T6】</p></blockquote></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><p id="63c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用PassportJs -&gt; <a class="ae ks" href="https://sharma-vikashkr.medium.com/nestjs-firebase-auth-secured-nestjs-app-using-passport-60e654681cff" rel="noopener">在NestJs中进行Firebase auth此处</a>。</p></div></div>    
</body>
</html>