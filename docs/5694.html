<html>
<head>
<title>AWS CDK BucketDeployment — should you use it ?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS CDK BucketDeployment —您应该使用它吗？</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/aws-cdk-bucketdeployment-should-you-use-it-a4c040c64ac0?source=collection_archive---------2-----------------------#2021-11-02">https://medium.com/nerd-for-tech/aws-cdk-bucketdeployment-should-you-use-it-a4c040c64ac0?source=collection_archive---------2-----------------------#2021-11-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2d50" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有问题的 CDK 构造是<a class="ae jd" href="https://docs.aws.amazon.com/cdk/api/latest/python/aws_cdk.aws_s3_deployment/BucketDeployment.html" rel="noopener ugc nofollow" target="_blank"> BucketDeployment </a>，它是 S3 部署模块或包的一部分。从 constructs api 文档中，您会读到:</p><p id="15e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du je jf jg jh b"><strong class="ih hj">BucketDeployment</strong></code>用的内容填充 S3 桶。来自其他 S3 存储桶或本地磁盘的 zip 文件。</p><p id="091e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">用例</strong>:由 CloudFront 服务的位于 S3 的站点。</p><p id="644e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于那些寻求简单方法来管理该部署，然后使 CloudFront 发行版失效的人来说，这个构造看起来是一个很有吸引力的选择。你会问，有那么简单吗？是的，它是。下面是参考 api 参数的一个片段，其中的“destination_bucket”和“distribution”将是您希望与您的用例相关联的内容。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/5b3d0be96cebfce0c84c0b8af98747c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZpSX3skk2j_XWXj-W6mRg.png"/></div></div></figure><p id="9041" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于使用 CICD 的应用程序，当您在堆栈中包含 BucketDeployment 时，可以将构建构件传递给构造，以推送到 S3 存储桶，然后由为您提供的自定义 lambda 发出无效请求。这对我和我为之工作的客户都有效，因为我们不必处理交叉帐户权限，因为堆栈和 cdk 代码已经处理了它们。</p><p id="4cfe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">哪里出了问题</strong>:</p><p id="b7c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">随着项目的扩大和站点的增长，我们看到了我们使用这个构造的两个好处的压力:</p><p id="d802" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> S3 部署</strong>:</p><ul class=""><li id="bf04" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">构建工件的部署由 lambda 处理，它将所需的资产作为 zip 文件下载下来，然后提取内容以上传相关文件。看到问题了吗？</li><li id="3227" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">下载一个 zip 文件并解压。在 lambda 中，您有两倍大小的站点工件，在文件系统上可以达到 512Mb，除非您有额外的存储空间由 EFS 管理。对于非 vpc 依赖的应用程序架构，这是不必要的依赖。</li></ul><p id="218a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Cloudfront 失效</strong>:</p><ul class=""><li id="e601" class="ju jv hi ih b ii ij im in iq jw iu jx iy jy jc jz ka kb kc bi translated">无效化似乎对我们很有效，但事实并非如此。<a class="ae jd" href="https://github.com/aws/aws-cdk/issues/15891" rel="noopener ugc nofollow" target="_blank">等待无效完成失败</a>谈论从 8 月 21 日起注意到的一个持续问题。</li><li id="c51e" class="ju jv hi ih b ii kd im ke iq kf iu kg iy kh jc jz ka kb kc bi translated">我们注意到多个失效并行发生，状态为“进行中”,最终定制资源超时，构建失败。在许多情况下，构建和失效可能已经生效，并且构建会被标记为失败。有人可能会说，最好提醒你注意背景中可能需要注意的任何问题。</li></ul></div><div class="ab cl ki kj gp kk" role="separator"><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn ko"/><span class="kl bw bk km kn"/></div><div class="hb hc hd he hf"><h1 id="db61" class="kp kq hi bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">我们最后得到了什么？</h1><p id="42ca" class="pw-post-body-paragraph if ig hi ih b ii ln ik il im lo io ip iq lp is it iu lq iw ix iy lr ja jb jc hb bi translated">我们最终移除了 BucketDeployment 构造，并选择在基础设施部署后使用 aws cli 处理静态站点部署和 CloudFront 失效。</p><p id="eb7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">构建背后的想法是值得称赞的，随着对注意到的问题的进一步改进，从长远来看，这可以帮助许多人。</p></div></div>    
</body>
</html>