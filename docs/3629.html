<html>
<head>
<title>Realtime Polling web application with Python FastApi WebSockets, PyMongo, HTML &amp; JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Python FastApi WebSockets、PyMongo、HTML 和 JavaScript 实时轮询 web 应用程序</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/polling-web-application-with-python-fastapi-websockets-pymongo-html-javascript-832c931eca59?source=collection_archive---------1-----------------------#2021-06-17">https://medium.com/nerd-for-tech/polling-web-application-with-python-fastapi-websockets-pymongo-html-javascript-832c931eca59?source=collection_archive---------1-----------------------#2021-06-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="13ab" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">让我们通过使用这些<br/> 1 来构建一个全栈实时投票 web 应用程序。<strong class="il hj"> Python 的 FastApi <br/> 2。Websockets。<br/> 3。</strong>T5】py mango<br/>4。HTML，CSS，JavaScript 。<br/> <strong class="il hj"> 5。</strong><a class="ae jh" href="https://www.chartjs.org/" rel="noopener ugc nofollow" target="_blank"><strong class="il hj">chart . js</strong></a><strong class="il hj">(</strong>对于轮询图，我们要用<strong class="il hj">)。</strong></p></blockquote><figure class="jj jk jl jm fd jn er es paragraph-image"><a href="https://www.freepik.com/vectors/background"><div class="er es ji"><img src="../Images/8e8f776169ed239ebbc994d29a3e58ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2-wEuz6-nQ8kJURaGWxHGw.jpeg"/></div></a><figcaption class="jq jr et er es js jt bd b be z dx translated"><a class="ae jh" href="https://www.freepik.com/vectors/background" rel="noopener ugc nofollow" target="_blank">rawpixel.com 创建的背景向量</a></figcaption></figure><p id="3e55" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">坚持住！难道我刚才说的是<strong class="il hj"> WebSockets </strong>🤨？</p><h2 id="ba5c" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ju ki kj kk jv kl km kn jw ko kp kq kr bi translated">以下是 WebSockets 的原因:</h2><p id="3c0b" class="pw-post-body-paragraph ii ij hi il b im ks io ip iq kt is it ju ku iw ix jv kv ja jb jw kw je jf jg hb bi translated">我们都知道，我们可以使用 Http 调用将用户的投票发送到服务器。但是如果你想建立一个实时的网络应用程序，我们需要使用 WebSockets。让我解释清楚:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es kx"><img src="../Images/cf36d3de5437204f90e8d3436d0c5d97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MR93UDmIATqcAqWR8kOSww.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">Http 协议工作流</figcaption></figure><p id="1af3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">当我们使用 Http 协议作为我们的数据传输机制时，Http 协议是单向的。这意味着服务器只有在客户端请求时才会发送数据&amp;关闭连接。<br/>即，将为每个 HTTP 请求创建一个新的 TCP 连接。</p><h1 id="b6c5" class="lc jy hi bd jz ld le lf kd lg lh li kh lj lk ll kk lm ln lo kn lp lq lr kq ls bi translated">WebSockets</h1><p id="7a15" class="pw-post-body-paragraph ii ij hi il b im ks io ip iq kt is it ju ku iw ix jv kv ja jb jw kw je jf jg hb bi translated"><strong class="il hj"> WebSockets </strong>是<strong class="il hj">双向</strong>连接，它创建一个有状态协议，这意味着客户端&amp;服务器之间的连接可以保持活动。所以我们不需要为每个服务器请求创建一个新的 TCP 连接，相反我们可以使用相同的连接。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lt"><img src="../Images/e03c849300cae59180dc0b1392560dd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p4XqxARPFqstoloPlbT7yQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">WebSocket 协议工作流</figcaption></figure><blockquote class="if ig ih"><p id="a7a5" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">我从这篇精彩的文章(什么是 web socket，它与 HTTP 有什么不同？)，查看此<a class="ae jh" href="https://www.geeksforgeeks.org/what-is-web-socket-and-how-it-is-different-from-the-http/" rel="noopener ugc nofollow" target="_blank">条</a></p></blockquote><h1 id="61bc" class="lc jy hi bd jz ld le lf kd lg lh li kh lj lk ll kk lm ln lo kn lp lq lr kq ls bi translated">使用 FastAPI Websockets、Html 和 JS 轮询网站</h1><p id="9f59" class="pw-post-body-paragraph ii ij hi il b im ks io ip iq kt is it ju ku iw ix jv kv ja jb jw kw je jf jg hb bi translated">我们用 Python 的<strong class="il hj"> FastAPI WebSockets &amp; Html，js(尤其是 chart.js)搭建一个披萨 vs 汉堡投票网站。</strong></p><p id="1560" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">这是我们输出的图像。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es lu"><img src="../Images/f71cfdef42af565d0a550a272a04b768.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-t_-LoQLwWBgW4rRRcPbcQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">比萨 vs 汉堡实时轮询应用程序示例输出</figcaption></figure><h2 id="26aa" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ju ki kj kk jv kl km kn jw ko kp kq kr bi translated">我们将首先构建我们的后端</h2><p id="f5aa" class="pw-post-body-paragraph ii ij hi il b im ks io ip iq kt is it ju ku iw ix jv kv ja jb jw kw je jf jg hb bi translated">注意:在创建我们的项目之前。我只是想让你知道，在这个项目中，我将只使用 3 个文件。<br/> 1。application.py(这里我写 websocket apis，是 M <strong class="il hj"> iddleware </strong>)。<br/> 2。pizzaVsburger.html(这里我将写 html 代码，显示如上图的条形图，它是<strong class="il hj">前端</strong>)。<br/> 3。main.js(这里将编写我们的 javascript 功能)。<br/> 4。我将使用 MongoDB 作为我们的数据库，来存储我们的用户投票。(<strong class="il hj">后端</strong>)</p><p id="1b96" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">我将反复修改这三个文件中的代码。你在这里看到的任何代码块，它们只属于这些文件。我还会提到代码块所属的文件名。</p><h2 id="6a2d" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ju ki kj kk jv kl km kn jw ko kp kq kr bi translated">设置项目的虚拟环境</h2><p id="8683" class="pw-post-body-paragraph ii ij hi il b im ks io ip iq kt is it ju ku iw ix jv kv ja jb jw kw je jf jg hb bi translated">让我们创建名为<strong class="il hj"> pizzaVsburger </strong>的项目文件夹。在该文件夹中，我们将设置项目的虚拟环境。<br/>我假设你已经在本地机器上安装了<strong class="il hj">python</strong>&amp;<strong class="il hj">virtualenv</strong>。如果没有，请按照本指南进行安装。<br/>然后我们将创建我们的<strong class="il hj">后端虚拟环境</strong>，其中将安装您项目的所有后端 python 依赖项。<br/>运行该命令:</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="bac5" class="jx jy hi lw b fi ma mb l mc md">virtualenv backend</span></pre><p id="0b73" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">运行该命令后，将创建包含 2 个子文件夹(Lib &amp; Scripts)&amp; a . git ignore &amp; pyvenv . CFG 文件的后端文件夹</p><p id="8b89" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">我们需要安装一些依赖项，这样我们就可以编写我们的后端 API。在命令提示符下运行这些命令。</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="a0a6" class="jx jy hi lw b fi ma mb l mc md">backend\Scripts\activate<br/>pip install fastapi "uvicorn[standard]" numpy</span></pre><p id="9d7e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated"><strong class="il hj"> FastAPI </strong>编写我们的后端 API&amp;<strong class="il hj">uvicon</strong>为我们的应用程序创建 ASGI 服务器。</p><h2 id="45b2" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ju ki kj kk jv kl km kn jw ko kp kq kr bi translated">使用 FastAPI 编写 WebSocket APIs</h2><p id="7bbf" class="pw-post-body-paragraph ii ij hi il b im ks io ip iq kt is it ju ku iw ix jv kv ja jb jw kw je jf jg hb bi translated">接下来，我们需要在后端文件夹中创建一个<strong class="il hj"> application.py </strong>文件，在这里我们将编写我们的 WebSocket APIs。</p><p id="1068" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">我正在设置与 MongoDB 客户端的连接，这样我们就可以存储用户投票并初始化应用程序。</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="eb05" class="jx jy hi lw b fi ma mb l mc md">from fastapi import <strong class="lw hj">FastAPI</strong><br/>from pymongo import <strong class="lw hj">MongoClient</strong><br/><br/><strong class="lw hj"># App initialization</strong><br/>app = FastAPI()<br/><br/><strong class="lw hj"># Setting up connection with MongoDB</strong><br/><strong class="lw hj">client</strong> = MongoClient("mongodb://localhost:27017/")<br/><strong class="lw hj">database </strong>= client["pizzaVsburger"]<br/><strong class="lw hj"># database's table which stores the user votes.<br/>collection </strong>= database["votes"] </span></pre><blockquote class="if ig ih"><p id="a5f6" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">我们已经连接了<strong class="il hj"> MongoDB </strong>，接下来我们需要一个默认端点，它返回我们的投票<strong class="il hj"> html 页面</strong> &amp;我将其命名为 pizzaVsburger.html<strong class="il hj"/>。</p><p id="98bb" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">所以我们需要从<strong class="il hj"> fastapi.templating </strong>中导入并使用<strong class="il hj"> Jinja2Templates </strong>来返回 html 文件作为输出。</p></blockquote><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="27e5" class="jx jy hi lw b fi ma mb l mc md">from fastapi import FastAPI<strong class="lw hj"><br/></strong>from fastapi.templating import Jinja2Templates<br/>from pymongo import MongoClient<br/><br/><strong class="lw hj"># App initialization</strong><br/>app = FastAPI()<br/><br/><strong class="lw hj"># Setting up connection with MongoDB</strong><br/><strong class="lw hj">client</strong> = MongoClient("mongodb://localhost:27017/")<br/><strong class="lw hj">database </strong>= client["pizzaVsburger"]<br/><strong class="lw hj"># database's table which stores the user votes.<br/>collection </strong>= database["votes"]</span><span id="b960" class="jx jy hi lw b fi me mb l mc md"><strong class="lw hj"># Templates directory, in which our html &amp; javascript files are stored.</strong><br/>templates = Jinja2Templates(directory="templates")<br/>app.mount("/templates", StaticFiles(directory="templates", html=True), name="templates")</span><span id="02e4" class="jx jy hi lw b fi me mb l mc md"><strong class="lw hj"># API which returns HTML file as response.<br/></strong>@app.websocket("/")<br/>async def get(request: Request):<br/><strong class="lw hj">    # Here in list 1 represent pizza's vote &amp; 0 represents burger's.<br/></strong>    votes = [1,0]<br/>    return templates.TemplateResponse("pizzaVsburger.html", {'request': request, 'votes', })</span></pre><p id="efc6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">让我们运行上面的代码，检查下面的命令。</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="7f07" class="jx jy hi lw b fi ma mb l mc md">uvicorn application:app --reload</span></pre><p id="8867" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">运行上述代码后，application.py 文件在<strong class="il hj">默认端口 8000 </strong>上运行。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div class="er es mf"><img src="../Images/606f8c105e0e957f52e0bdd75fed9f9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*a7iuC6X3HCjt_EodCBKSkw.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">使用 uvicorn 在本地运行 fastapi</figcaption></figure><p id="c8ed" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">下面是点击<a class="ae jh" href="http://localhost:8000" rel="noopener ugc nofollow" target="_blank"> http://localhost:8000 </a>后的输出</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div class="er es mg"><img src="../Images/e21ad06e101f805de269ba0ddee5d1ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*eyAtA_x8R5jzDEbq4kadow.png"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">披萨与汉堡投票应用程序出错</figcaption></figure><p id="f7f3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">如果我们在模板目录中有<strong class="il hj">pizzaVsburger.html</strong>文件，上面的代码是有效的。所以我们需要创建<strong class="il hj">模板</strong>文件夹在后台目录【pizzaVsburger.html】中添加<strong class="il hj">文件</strong>在里面。</p><h2 id="d9c8" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ju ki kj kk jv kl km kn jw ko kp kq kr bi translated">让我们为投票应用程序编写 HTML 代码</h2><p id="84b8" class="pw-post-body-paragraph ii ij hi il b im ks io ip iq kt is it ju ku iw ix jv kv ja jb jw kw je jf jg hb bi translated">创建<strong class="il hj">pizzaVsburger.html 文件后，</strong>添加这段代码。这是我们项目的前端部分。</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="c621" class="jx jy hi lw b fi ma mb l mc md">&lt;html lang="en"&gt;<br/>   &lt;head&gt;<br/>      &lt;title&gt;Pizza Vs Burger&lt;/title&gt;<br/>      &lt;script src="./templates/js/main.js"&gt;&lt;/script&gt;<br/>   &lt;/head&gt;<br/>   &lt;body&gt;<br/>      &lt;div style="width:50%; display: block; margin: 0px auto; text-align: center;"&gt;<br/>         &lt;h1&gt;Legendary Battle&lt;/h1&gt;<br/>      &lt;d<br/>   &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="bed0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">让我们刷新页面，然后我们得到这个</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mh"><img src="../Images/f061c10bf82e37ed1b6857e2c5d32015.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*30wcSUsFrYjw82kWM-B5kg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">比萨 vs 汉堡投票 web 应用程序的基本 Html 页面。</figcaption></figure><p id="43c4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">实际工作开始了。我们已经准备好了 websocket &amp; html 页面，剩下的工作是一个条形图，它显示了投票&amp;一个在 MongDB 中存储数据(用户投票)的端点。</p><h2 id="ea33" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ju ki kj kk jv kl km kn jw ko kp kq kr bi translated">让我们编写一个 API，它将投票存储在 MongoDB 的投票表中。将这些内容添加到 application.py 文件中</h2><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="3767" class="jx jy hi lw b fi ma mb l mc md">@app.websocket("/sendVote")<br/>async def user_vote(websocket: WebSocket):<br/>    <strong class="lw hj"><em class="ik">"""<br/>    This is a websocket method, which responds to the call /sendVote.<br/>    Client will use this websocket api as a medium to send their votes.<br/>    """</em></strong><em class="ik"><br/>    </em>await websocket.accept()<br/>    try:<br/>        while True:<br/>            data = await websocket.receive()<br/>            if data['type'] != 'websocket.disconnect':<br/>                vote = {<br/>                    'pizza': 1,<br/>                    'burger': 0<br/>                } if data['text'] == 'pizza' else {<br/>                    'pizza': 0,<br/>                    'burger': 1<br/>                }<br/>                add_vote(vote)<br/>            <br/>            await websocket.send_json(data)<br/>    except Exception as ex:<br/>        return ex</span><span id="7874" class="jx jy hi lw b fi me mb l mc md">def add_vote(vote):<br/>    <strong class="lw hj"><em class="ik">"""<br/>    This method stores the user votes in 'votes' table of pizzaVsburger database in MongoDB<br/>    """</em></strong><em class="ik"><br/>    </em>collection.insert_one(vote)</span></pre><p id="c36d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">从上面的代码中，当我们点击上面的端点“/sendVote”时，我们从 javascript 中发送“pizza”或“burger”作为<strong class="il hj">数据[‘text’]的</strong>值。<br/>我们在<strong class="il hj"> main.js </strong>中的 javascript 代码。</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="e3ab" class="jx jy hi lw b fi ma mb l mc md">var ws = new WebSocket("ws://localhost:8000/sendVote");</span><span id="46e0" class="jx jy hi lw b fi me mb l mc md">/**<br/>Function will be called on clicking vote button from pizzaVsburger.html<br/>*/<br/>function myVote(voteTo) {<br/>    var vote = voteTo === 'pizza' ? 0 : 1;<br/>    pollingChart.data.datasets[0].data[vote] += 1;<br/>    pollingChart.update();<br/>    sendMessage(voteTo);<br/>}<br/><br/>/**<br/>Function will send the vote to server by using websocket.<br/>*/<br/>function sendMessage(votedTo) {<br/>    ws.send(votedTo);<br/>    event.preventDefault();<br/>}</span></pre><p id="3280" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">我们通过单击按钮从 html 页面调用 myVote('string ')方法。</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="1438" class="jx jy hi lw b fi ma mb l mc md">&lt;html lang="en"&gt;<br/>   &lt;head&gt;<br/>      &lt;title&gt;Pizza Vs Burger&lt;/title&gt;<br/>      &lt;script src="./templates/js/main.js"&gt;&lt;/script&gt;<br/>   &lt;/head&gt;<br/>   &lt;body&gt;<br/>      &lt;div style="width:50%; display: block; margin: 0px auto; text-align: center;"&gt;<br/>         &lt;h1&gt;Legendary Battle&lt;/h1&gt;<br/>         &lt;br&gt;<br/>         &lt;button onclick="myVote('pizza')"&gt;Pizza&lt;/button&gt;<br/>         &lt;button onclick="myVote('burger')"&gt;Burger&lt;/button&gt;<br/>      &lt;div&gt;<br/>   &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="b890" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">输出:</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mi"><img src="../Images/cc1950bbe8588a927c95952d21485953.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yfmgZ5Ia81cbBs21EKgmVg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">工作比萨 vs 汉堡 web 应用程序，其中没有图表</figcaption></figure><p id="3b32" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">如果我点击<strong class="il hj"> Pizza </strong>按钮，它将调用 main.js 文件中的 my vote(‘Pizza’)。然后 myVote 方法要调用 sendMessage(vote)方法，实际上是用数据['text']打 websocket 的 api " <strong class="il hj"> /sendVote </strong>"作为' pizza '。<br/>然后在服务器中，sendVote api 要添加“披萨栏中的 1”&amp;“汉堡栏中的 0”。</p><p id="0860" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">我正在使用<a class="ae jh" href="https://www.mongodb.com/cloud/atlas/lp/try2?utm_source=google&amp;utm_campaign=gs_footprint_row_search_brand_phrase_intent_test_atlas_desktop&amp;utm_term=mongodb&amp;utm_medium=cpc_paid_search&amp;utm_ad=p&amp;utm_ad_campaign_id=11295578158&amp;gclid=CjwKCAjw_JuGBhBkEiwA1xmbRUnChPOdeSEEPxVbCh-3mnuWBuWff5FiVHkQ8rYhKtW3P4F_VTbf0BoCczkQAvD_BwE" rel="noopener ugc nofollow" target="_blank"><strong class="il hj">MongoDB Compass</strong></a>，在我们的数据库中查看我的投票。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mj"><img src="../Images/15012fbc495dcc52a44dfaa5db18f51c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZwwghMDvagPG6uEcRJAQIQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">显示 pizzaVsburger 数据库的 MongoDB 指南针</figcaption></figure><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mk"><img src="../Images/18b96541ff23cb0cf4025a15c0b727fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DbCdXAulJ6nOB_wBYp-GUQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">选票集合存储在 MongoDB 的 pizzaVsburger 数据库中</figcaption></figure><p id="6d93" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">所以，我在我们的 html 页面中随机点击了披萨和汉堡按钮，我将这些投票存储在我们的 MongoDB 中</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ml"><img src="../Images/6b5536f8b23b38bcf7b9fbaf6beeaaaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBJ_0YyzFh8va_Awh52UEw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">存储在投票集合(MongoDB)中的用户投票</figcaption></figure><p id="a447" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">酷，工作正常！！😎</p><h2 id="524d" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ju ki kj kk jv kl km kn jw ko kp kq kr bi translated">让我们使用 Chart.js 在 html 页面中创建一个条形图</h2><p id="b307" class="pw-post-body-paragraph ii ij hi il b im ks io ip iq kt is it ju ku iw ix jv kv ja jb jw kw je jf jg hb bi translated">我们在前端有投票按钮，API 作为中间件，MongoDB 作为后端。现在我们需要在 pizzaVsburger.html 页面中可视化投票。</p><p id="44de" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">我用的是<a class="ae jh" href="https://www.chartjs.org/" rel="noopener ugc nofollow" target="_blank"> chart.js(是开源的 HTML5 charts lib) </a>。Chart.js 是一个很棒的 javascript 库，它为网站提供了简单、灵活的 javascript 图表。</p><p id="a5f8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">首先，我们需要在我们的<strong class="il hj">pizzaVsburger.html 文件</strong>中添加这些行。</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="c1ef" class="jx jy hi lw b fi ma mb l mc md">&lt;html lang="en"&gt;<br/>   &lt;head&gt;<br/>      &lt;title&gt;Pizza Vs Burger&lt;/title&gt;<br/>      &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"&gt;<br/>      &lt;style&gt;<br/>         .btn-primary {<br/>            margin: 6px;<br/>            background: #fff;<br/>            color: #000;<br/>            border: 1px solid black;<br/>         }<br/>      &lt;/style&gt;<br/>      &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"&gt;&lt;/script&gt;<br/>      &lt;script src="https://cdn.jsdelivr.net/gh/emn178/chartjs-plugin-labels/src/chartjs-plugin-labels.js"&gt;&lt;/script&gt;<br/>      &lt;script src="./templates/js/main.js"&gt;&lt;/script&gt;<br/>   &lt;/head&gt;<br/>   &lt;body translate="no"&gt;<br/>      &lt;div style="width:50%; display: block; margin: 0px auto; text-align: center;"&gt;<br/>         &lt;h1&gt;Legendary Battle&lt;/h1&gt;<br/>         &lt;br&gt;<br/>         &lt;canvas id="mycanvas"&gt;&lt;/canvas&gt;<br/>         &lt;div class="row"&gt;<br/>         &lt;button class="btn btn-primary col" onclick="myVote('pizza')"&gt;<br/>            Vote Pizza<br/>         &lt;/button&gt;<br/>         &lt;button class="btn btn-primary col" onclick="myVote('burger')"&gt;Vote Burger&lt;/button&gt;<br/>         &lt;/div&gt;<br/>      &lt;/div&gt;<br/>      &lt;script&gt;<br/>         setUpChart({{ votes }})<br/>      &lt;/script&gt;<br/>   &lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="ae84" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">在上面的代码中，我使用了 chart.js 提供的 bootstrap 和几个 javascript 文件。<br/>我们需要从 application.py 的默认 get 方法发送{ { votes } },&amp;显示我们投票的条形图，<strong class="il hj">修改</strong> <strong class="il hj"> main.js </strong>文件如下。</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="9b52" class="jx jy hi lw b fi ma mb l mc md">pollingChart;<br/><br/>function setUpChart(dataVotes) {<br/>var ctx_live = document.getElementById("mycanvas");<br/>         var myChart = new Chart(ctx_live, {<br/>         type: 'bar',<br/>           data: {<br/>             labels: ['Pizza', 'Burger'],<br/>             datasets: [{<br/>               label: 'Pizza Vs Burger',<br/>               data: <strong class="lw hj">dataVotes</strong>,<br/>               fill: false,<br/>               backgroundColor: ['#00eefa','#37dbff'],<br/>               borderColor: '#000',<br/>               borderWidth: 1<br/>             }]<br/>           },<br/>           options: {<br/>             plugins: {<br/>               labels: {<br/>                 render: 'image',<br/>                 textMargin: -130,<br/>                 images: [<br/>                   {<br/>                     src: 'https://image.freepik.com/free-vector/cute-pizza-cartoon-vector-icon-illustration-fast-food-icon-concept-flat-cartoon-style_138676-2588.jpg',<br/>                     width: 120,<br/>                     height: 120<br/>                   },<br/>                   {<br/>                     src: 'https://image.freepik.com/free-vector/cute-burger-holding-knife-fork-cartoon-fast-food-icon-concept-isolated-flat-cartoon-style_138676-2204.jpg',<br/>                     width: 120,<br/>                     height: 120<br/>                   }<br/>                 ]<br/>               }<br/>             },<br/>             scales: {<br/>               yAxes: [{<br/>                 ticks: {<br/>                   beginAtZero: true<br/>                 }<br/>               }]<br/>             }<br/>           }<br/>         });<br/><br/>pollingChart = myChart;<br/>}</span></pre><p id="6dd5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">从上面的代码中，我们正在设置我们的条形图&amp;从<strong class="il hj"/><a class="ae jh" href="https://freepik.com" rel="noopener ugc nofollow" target="_blank"><strong class="il hj">【freepik.com】</strong></a><strong class="il hj">(你可以从这个网站获得免费的&amp;高级图片)在我们的条形图上添加图片。<br/> </strong> <br/>在上面的代码中，函数<strong class="il hj"> setUpChart(dataVotes) </strong>将把 dataVotes 作为输入。这里的 dataVotes 值将是一个包含两个值的数组。<br/> <strong class="il hj"> dataVotes =【披萨投票数，汉堡投票数】。<br/> </strong> &amp;我们从 websocket api 中检索它们。让我们在我们的<strong class="il hj">应用程序中添加这些行</strong></p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="82d2" class="jx jy hi lw b fi ma mb l mc md">def get_votes():<br/>  <strong class="lw hj">  <em class="ik">"""<br/>    Method returns all the votes from 'votes' table of pizzaVsburger database in MongoDB<br/>    """</em></strong><em class="ik"><br/>    </em>x = [vote for vote in collection.find()]<br/>    return x</span></pre><p id="b663" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">&amp;我们将 user_vote 方法&amp; default get 方法修改为</p><pre class="jj jk jl jm fd lv lw lx ly aw lz bi"><span id="a993" class="jx jy hi lw b fi ma mb l mc md">@app.get("/")<br/>async def get(request: Request):<br/>    <strong class="lw hj"><em class="ik">"""<br/>    GET method to return html page, when user hit's the endpoint '/'.<br/>    This method first gets all the votes from the votes table from Mongo Database<br/>    &amp; counts the votes for Pizza &amp; Burger &amp; return html file the votes in a single list.<br/>    output format: votes = [(pizza votes),(burger votes)]<br/>    """</em></strong><em class="ik"><br/>    </em>votes = [[x['pizza'], x['burger']] for i, x in enumerate(get_votes())]</span><span id="c9cf" class="jx jy hi lw b fi me mb l mc md">    user_votes = np.array(votes)<br/>    response = np.sum(user_votes, 0)<br/>    votes = list(response)</span><span id="ac43" class="jx jy hi lw b fi me mb l mc md">    return templates.TemplateResponse("pizzaVsburger.html", {'request': request, 'votes': votes})</span><span id="f5a6" class="jx jy hi lw b fi me mb l mc md">"""-------------------------------------------------------------"""</span><span id="eca0" class="jx jy hi lw b fi me mb l mc md">@app.websocket("/sendVote")<br/>async def user_vote(websocket: WebSocket):<br/>    <strong class="lw hj"><em class="ik">"""<br/>    This is a websocket method, which responds to the call /sendVote.<br/>    Client will use this websocket api as a medium to send their votes.<br/>    """</em></strong><em class="ik"><br/>    </em>await websocket.accept()<br/>    try:<br/>        while True:<br/>            data = await websocket.receive()<br/>            if data['type'] != 'websocket.disconnect':<br/>                vote = {<br/>                    'pizza': 1,<br/>                    'burger': 0<br/>                } if data['text'] == 'pizza' else {<br/>                    'pizza': 0,<br/>                    'burger': 1<br/>                }<br/>                add_vote(vote)<br/>            else:<br/>                data = get_votes()<br/>            await websocket.send_json(data)<br/>    except Exception as ex:<br/>        return ex</span></pre><h2 id="1d4f" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ju ki kj kk jv kl km kn jw ko kp kq kr bi translated">最后，这是输出</h2><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es mm"><img src="../Images/7ed8fc36c61c3042fbffcd9ac93ee8b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*noW6nx5YrTjwlajvUGDwqg.gif"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">比萨与汉堡的最终输出 gif 图像</figcaption></figure><p id="7a5f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">此处是该项目的 Github 回购链接<a class="ae jh" href="https://github.com/vinaynvd/pizzaVsburger" rel="noopener ugc nofollow" target="_blank">😀</a>。</p><h2 id="49e7" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ju ki kj kk jv kl km kn jw ko kp kq kr bi translated">结论:</h2><p id="b246" class="pw-post-body-paragraph ii ij hi il b im ks io ip iq kt is it ju ku iw ix jv kv ja jb jw kw je jf jg hb bi translated">我们建立了可怕的实时比萨饼对汉堡投票网站。您可以用这种方式构建出色的实时 web 应用程序。提出你酷的实时网络应用的想法，并在这里发表评论。</p><p id="35b1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ju iv iw ix jv iz ja jb jw jd je jf jg hb bi translated">如果你喜欢这篇文章，想表达一些爱和支持，请给我买一杯☕咖啡😀</p><figure class="jj jk jl jm fd jn er es paragraph-image"><a href="https://www.buymeacoffee.com/vinaynvd"><div class="er es mn"><img src="../Images/d56406ef45ed1b62a42b5e1c12718758.png" data-original-src="https://miro.medium.com/v2/resize:fit:340/format:webp/0*BKfsxBMXLRY5i-Zc.png"/></div></a><figcaption class="jq jr et er es js jt bd b be z dx translated"><a class="ae jh" href="https://www.buymeacoffee.com/vinaynvd" rel="noopener ugc nofollow" target="_blank">https://www.buymeacoffee.com/vinaynvd</a></figcaption></figure></div></div>    
</body>
</html>