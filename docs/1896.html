<html>
<head>
<title>Sample VoIP Calling App in Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android 中的示例 VoIP 通话应用</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/sample-voip-calling-app-in-android-6db96d6b268b?source=collection_archive---------1-----------------------#2021-04-12">https://medium.com/nerd-for-tech/sample-voip-calling-app-in-android-6db96d6b268b?source=collection_archive---------1-----------------------#2021-04-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ffeeefe174200fc4a130e47cf8ec8a7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yXMt3zv-_5d1i6YYgT5UqA.png"/></div></div></figure><p id="b3e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文描述了使用 CometChat Pro 设计和实现一个简单的 VoIP 呼叫应用程序。CometChat Pro 是 Messaging &amp; Call SDK，它为开发人员集成聊天提供了大量功能。使用 CometChat Pro UI Kit，开发人员可以轻松地将实时消息和呼叫支持集成到他们的应用程序中。到本文结束时，您将创建一个功能完整的示例 VoIP 呼叫应用程序。</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="js jt l"/></div></figure><h1 id="4b63" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">使用的关键组件和库</h1><p id="f771" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated"><strong class="is hj"> CometChat Android UI Kit </strong> —一个随时可用的 UI Kit 库，它将帮助我们在几分钟内开发示例应用中的实时消息传递&amp;呼叫支持。</p><p id="bad5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Firebase </strong> —当应用程序不在前台时，我们将使用 Firebase 推送通知来接收事件。</p><p id="8e17" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> ConnectionService </strong> —一个抽象类，它将帮助你在一个示例应用中建立 VoIP 呼叫。它使用一个内置的系统 UI 来管理一个呼叫，也称为<em class="kx">系统管理的</em>。如果您希望使用自己的用户界面来管理通话，您可以使用<em class="kx">自我管理服务。</em></p><h1 id="b451" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">先决条件</h1><p id="b59f" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">在深入了解更多细节之前，请确保您已经检查了以下几点。<br/> <em class="kx"> —您系统中安装的 Android studio。<br/> —运行您的应用程序的 Android 设备或仿真器。</em></p><ul class=""><li id="e2e3" class="ky kz hi is b it iu ix iy jb la jf lb jj lc jn ld le lf lg bi translated">我们将从从 GitHub 获取代码开始。<br/> <br/>您可以从<a class="ae lh" href="https://github.com/developerspace-samples/VoIP-Call-Sample" rel="noopener ugc nofollow" target="_blank">样例 VoIP 调用库</a>中<strong class="is hj">克隆</strong>项目。</li></ul><pre class="jo jp jq jr fd li lj lk ll aw lm bi"><span id="7e12" class="ln jv hi lj b fi lo lp l lq lr">// Clone this repository</span><span id="3c21" class="ln jv hi lj b fi ls lp l lq lr"><em class="kx">git clone </em><a class="ae lh" href="https://github.com/developerspace-samples/VoIP-Call-Sample.git" rel="noopener ugc nofollow" target="_blank">https://github.com/developerspace-samples/VoIP-Call-Sample.git</a></span></pre><ul class=""><li id="7369" class="ky kz hi is b it iu ix iy jb la jf lb jj lc jn ld le lf lg bi translated">运行该应用程序需要 CometChat 帐户。</li></ul><p id="3b44" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在 CometChat 中创建您的帐户，并用您的帐户替换凭据。</p><figure class="jo jp jq jr fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/2dd6ad431528773f01f8f1421aa8deb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*9uQ_TqkxBtY_j7ZbD4j9Yw.png"/></div></figure><p id="e32b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另外，请确保在 CometChat 中设置推送通知扩展。<br/> <a class="ae lh" href="https://prodocs.cometchat.com/docs/android-extensions-enhanced-push-notification" rel="noopener ugc nofollow" target="_blank">请点击这里了解如何在 CometChat 中设置推送通知。</a></p><ul class=""><li id="86d0" class="ky kz hi is b it iu ix iy jb la jf lb jj lc jn ld le lf lg bi translated">下一步是设置 Firebase 帐户并创建一个新项目。项目创建完成后，在 Firebase 项目中设置一个 Android 应用程序，并在您的“<strong class="is hj"> app </strong>”文件夹中添加<strong class="is hj"><em class="kx">Google-services . JSON</em></strong>文件</li></ul><blockquote class="lu lv lw"><p id="b4a5" class="iq ir kx is b it iu iv iw ix iy iz ja lx jc jd je ly jg jh ji lz jk jl jm jn hb bi translated"><a class="ae lh" href="https://firebase.google.com/docs/android/setup" rel="noopener ugc nofollow" target="_blank">点击这里了解如何在安卓应用</a>中设置 Firebase</p></blockquote><ul class=""><li id="3c82" class="ky kz hi is b it iu ix iy jb la jf lb jj lc jn ld le lf lg bi translated">一旦上述配置完成，你就可以在 Android Studio 中打开项目了。您会发现该项目包含两个包'<strong class="is hj"> app' </strong>这是我们的示例应用程序，而'<strong class="is hj"> uiKit' </strong>是 CometChat 提供的库。</li><li id="0871" class="ky kz hi is b it ma ix mb jb mc jf md jj me jn ld le lf lg bi translated">在'<strong class="is hj"> app </strong>中，你会找到'<strong class="is hj"> utils </strong>'包，在这个包下我们有处理推送通知和 VoIP 呼叫的文件。</li></ul><h1 id="fc94" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">PushNotificationService</h1><p id="7e18" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">它扩展了 FirebaseMessageService，后者用于处理从 Firebase 接收的推送通知。我们用它来通知当用户不活动时发送给他们的消息。我们还通过它处理呼入和呼出的电话。</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="mf jt l"/></div></figure><p id="2f3f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> onMessageReceived() : </strong>每当您收到来自 firebase 的推送通知时，就会触发该方法。</p><p id="ce4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">cometchathelper . processmessage()</strong>:该方法由 CometChat SDK 提供，用于从远程消息中作为 JSON 对象接收的“<strong class="is hj"> <em class="kx">数据</em> </strong>”中获取 BaseMessage。</p><blockquote class="lu lv lw"><p id="95e1" class="iq ir kx is b it iu iv iw ix iy iz ja lx jc jd je ly jg jh ji lz jk jl jm jn hb bi translated">BaseMessage 是 comet chat<br/><a class="ae lh" href="https://docs.cometchat.io/android/v2.0/javadocs/com/cometchat/pro/models/BaseMessage.html" rel="noopener ugc nofollow" target="_blank">https://docs . comet chat . io/Android/v 2.0/javadocs/com/comet chat/pro/models/base message . html</a>中消息的基础模型</p></blockquote><p id="3d5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">initiateCallService(Call:Call)</strong>:该方法用于每当接收到呼叫类型消息时，通过 ConnectionService 发起呼叫。</p><blockquote class="lu lv lw"><p id="6bbf" class="iq ir kx is b it iu iv iw ix iy iz ja lx jc jd je ly jg jh ji lz jk jl jm jn hb bi translated">Call 是 CometChat SDK 中使用的一类消息。<a class="ae lh" href="https://docs.cometchat.io/android/v2.0/javadocs/com/cometchat/pro/core/Call.html" rel="noopener ugc nofollow" target="_blank">https://docs . comet chat . io/Android/v 2.0/javadocs/com/comet chat/pro/core/call . html</a></p></blockquote><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="mf jt l"/></div></figure><p id="45da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">showMessageNotification(base message:base message，title: String，alert: String) : </strong>该方法用于显示和处理特定用户收到的消息通知。</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="mf jt l"/></div></figure><p id="ee61" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae lh" href="https://github.com/team-developerspace/VoIP-Samples/blob/master/app/src/main/java/com/developerspace/voipcalling/utils/PushNotificationService.kt" rel="noopener ugc nofollow" target="_blank">点击此处获取<strong class="is hj">pushnotificationservice . kt</strong></a>的完整代码</p></div><div class="ab cl mg mh gp mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="hb hc hd he hf"><h1 id="b901" class="ju jv hi bd jw jx mn jz ka kb mo kd ke kf mp kh ki kj mq kl km kn mr kp kq kr bi translated">CallConnectionService</h1><p id="7112" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">CallConnectionService 是自定义的 ConnectionService 类，它与应用程序绑定在一起以处理传入和传出的呼叫。你会在其中找到<em class="kx"> onCreateIncomingConnection()、onCreateOutgoingConnection()</em>方法。</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="mf jt l"/></div></figure><p id="0461" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">onCreateIncomingConnection():</strong>每当 telecom manager . addnewincomingcall()成功接收到一个调用时，就会触发该方法。</p><p id="a171" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">onCreateIncomingConnectionFailed():</strong>每当 telecom manager . addnewincomingcall()未能接收到调用时，该方法被触发。</p><p id="893d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">onCreateOutgoingConnection()</strong>:每当成功执行 telecomManager.placeCall()以发出外拨呼叫时，就会触发此方法。</p><p id="9a5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">onCreateOutgoingConnectionFailed():</strong>每当 telecomManager.placeCall() get 未能发出呼出呼叫时，该方法被触发。</p><p id="3d01" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">目前，我们使用 CALL_PROVIDER 作为 ConnectionService 的功能。因此，您可以看到您的系统的本地来电和去电用户界面。如果你不想显示你自己的用户界面，你可以把它改成 SELF_MANAGED。</p><p id="c299" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae lh" href="https://github.com/team-developerspace/VoIP-Samples/blob/master/app/src/main/java/com/developerspace/voipcalling/utils/CallConnectionService.kt" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">点击此处获取 callconnectionservice . kt</strong></a>的完整代码</p><h1 id="5853" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">呼叫连接</h1><p id="1f5f" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">它是一个连接类，用于在用户收到呼入或呼出时启动连接。它通常帮助 ConnectionService 类处理连接请求及其回调。它包括某些方法，如<em class="kx"> onAnswer()、onReject()、onHold()、onDestroy()等。</em>每当用户收到一个来电，如果用户接受了呼叫，那么 onAnswer()将被触发。类似地，如果用户拒绝调用，那么 onReject()被触发。</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="mf jt l"/></div></figure><p id="86ca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> onAnswer() </strong>:每当该方法被触发时，我们使用<em class="kx"> CometChat.acceptCall() </em>，这将启动 CometChat 调用服务并启动调用会话。</p><p id="b969" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> onReject() </strong>:每当该方法被触发时，我们使用<em class="kx"> CometChat.rejectCall() </em>，这将拒绝 CometChat 呼叫服务并结束呼叫会话。</p><p id="a4bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> onDisconnect() </strong>:每当呼叫的发起者在接收者接受呼叫之前结束呼叫，就会触发该方法。这将结束通话，使其成为未接来电。</p><p id="e3fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae lh" href="https://github.com/team-developerspace/VoIP-Samples/blob/master/app/src/main/java/com/developerspace/voipcalling/utils/CallConnection.kt" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">点击此处查看 CallConnection.kt </strong> </a>的完整代码</p><h1 id="7848" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">调用处理程序</h1><p id="77c7" class="pw-post-body-paragraph iq ir hi is b it ks iv iw ix kt iz ja jb ku jd je jf kv jh ji jj kw jl jm jn hb bi translated">它是一个用于在您的应用程序中处理和集成 ConnectionService 的类。以下是您的应用程序中使用的方法。</p><p id="0b12" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"><em class="kx">startIncomingCall(Call Call):</em></strong>每当你需要开始一个来电的时候，都会用到这个方法。在这个方法中，您将找到<em class="kx">telecom manager . addnewincomingcall()</em>。该方法触发连接服务，并显示系统来电 UI 来处理来电。</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="mf jt l"/></div></figure><p id="0113" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"><em class="kx">startOutgoingCall(Call Call):</em></strong>该方法用于启动正在进行的呼叫，即每当用户试图发起呼叫时。在这个方法中，你会找到<em class="kx">telecom manager . place call()</em>。此方法代表您的应用程序拨打 VoIP 电话。</p><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="mf jt l"/></div></figure><p id="35a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae lh" href="https://github.com/team-developerspace/VoIP-Samples/blob/master/app/src/main/java/com/developerspace/voipcalling/utils/CallHandler.kt" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj">点击此处查看 CallHandler.kt </strong> </a>的完整代码</p></div><div class="ab cl mg mh gp mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="hb hc hd he hf"><p id="5b2b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">参考资料:</p><div class="ms mt ez fb mu mv"><a href="https://developer.android.com/reference/kotlin/android/telecom/ConnectionService" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab dw"><div class="mx ab my cl cj mz"><h2 class="bd hj fi z dy na ea eb nb ed ef hh bi translated">ConnectionService | Android 开发者</h2><div class="nc l"><h3 class="bd b fi z dy na ea eb nb ed ef dx translated">AccessibilityServiceMagnificationController . OnMagnificationChangedListener</h3></div><div class="nd l"><p class="bd b fp z dy na ea eb nb ed ef dx translated">developer.android.com</p></div></div><div class="ne l"><div class="nf l ng nh ni ne nj io mv"/></div></div></a></div><div class="ms mt ez fb mu mv"><a href="https://firebase.google.com/docs/android/setup" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab dw"><div class="mx ab my cl cj mz"><h2 class="bd hj fi z dy na ea eb nb ed ef hh bi translated">将 Firebase 添加到您的 Android 项目</h2><div class="nc l"><h3 class="bd b fi z dy na ea eb nb ed ef dx translated">安装或更新 Android Studio 至其最新版本。确保您的项目满足这些要求:目标…</h3></div><div class="nd l"><p class="bd b fp z dy na ea eb nb ed ef dx translated">firebase.google.com</p></div></div><div class="ne l"><div class="nk l ng nh ni ne nj io mv"/></div></div></a></div><div class="ms mt ez fb mu mv"><a href="https://prodocs.cometchat.com/" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab dw"><div class="mx ab my cl cj mz"><h2 class="bd hj fi z dy na ea eb nb ed ef hh bi translated">CometChat Pro 文档</h2><div class="nc l"><h3 class="bd b fi z dy na ea eb nb ed ef dx translated">将语音、视频和文本聊天快速添加到您的网站和移动应用程序中。</h3></div><div class="nd l"><p class="bd b fp z dy na ea eb nb ed ef dx translated">prodocs.cometchat.com</p></div></div><div class="ne l"><div class="nl l ng nh ni ne nj io mv"/></div></div></a></div><div class="ms mt ez fb mu mv"><a href="https://firebase.google.com/docs/cloud-messaging/android/receive" rel="noopener  ugc nofollow" target="_blank"><div class="mw ab dw"><div class="mx ab my cl cj mz"><h2 class="bd hj fi z dy na ea eb nb ed ef hh bi translated">在 Android 应用程序| Firebase 中接收消息</h2><div class="nc l"><h3 class="bd b fi z dy na ea eb nb ed ef dx translated">根据接收应用程序的前台/后台状态，Firebase 通知的行为会有所不同。如果你…</h3></div><div class="nd l"><p class="bd b fp z dy na ea eb nb ed ef dx translated">firebase.google.com</p></div></div><div class="ne l"><div class="nm l ng nh ni ne nj io mv"/></div></div></a></div></div></div>    
</body>
</html>