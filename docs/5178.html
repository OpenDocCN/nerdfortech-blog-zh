<html>
<head>
<title>Change Retrofit Base URL on Runtime.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运行时更改翻新基础URL。</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/change-retrofit-base-url-on-runtime-2036ef1dee44?source=collection_archive---------0-----------------------#2021-09-05">https://medium.com/nerd-for-tech/change-retrofit-base-url-on-runtime-2036ef1dee44?source=collection_archive---------0-----------------------#2021-09-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="629f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之间切换多个基本网址喜欢产品|开发改造容易。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/3f9b997489d744178294dc856ca89bce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8IOK-CnOvbbyuYyCcwOPvA.png"/></div></div></figure><p id="03d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">🗡Hi，很高兴在这里见到你。在这篇文章中，我们将实现一个简短的技术来改变改造基础网址。</p><h1 id="2c6a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">简介</strong></h1><p id="0cae" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><strong class="ih hj">改型</strong>是Square开发的一款用于Android、Java和Kotlin的类型安全HTTP客户端。该库提供了一个强大的框架，用于验证API并与之交互，以及使用<a class="ae ks" href="http://square.github.io/okhttp/" rel="noopener ugc nofollow" target="_blank"> OkHttp </a>发送网络请求。</p><p id="12bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们通过提供默认的基本url来实例化改造实例。</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="87ba" class="ky jq hi ku b be kz la l lb lc">return new Retrofit.Builder()<br/>            .client(okHttpClient)<br/>            .baseUrl(BuildConfig.PRODUCTION_BASE_URL)<br/>            .addConverterFactory(-)<br/>            .addCallAdapterFactory(-)<br/>            .build();</span></pre><p id="fde3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题报告</strong></p><p id="ad9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">运行时在不同的url之间切换很困难。为了解决这个困难，开发者被迫在应用程序中使用两个改型实例。为了避免在应用程序中出现这两种或两种以上的改型，我们开发人员使用了不同的技术，例如</p><ol class=""><li id="5cfc" class="ld le hi ih b ii ij im in iq lf iu lg iy lh jc li lj lk ll bi translated">更新动态URL——冗长乏味</li><li id="d057" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">借助共享首选项✅更改主机URL的拦截器</li><li id="435a" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">将BASE_URL直接存储在共享Pref中—</li><li id="d104" class="ld le hi ih b ii lm im ln iq lo iu lp iy lq jc li lj lk ll bi translated">reinit ok http/翻新—</li></ol><p id="f13e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更多..</p><p id="8601" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lr">这里，我们将实施方法2。</em></p><p id="f92a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们通过设置依赖项来深入了解一下。</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="fc7e" class="ky jq hi ku b be kz la l lb lc">ext {<br/>      okHttpVersion = "4.8.1"<br/>      retrofitVersion = "2.9.0"<br/>      hiltVersion = "2.38.1"<br/>}<br/>// Implementation<br/>// OkHttp<br/>implementation "com.squareup.okhttp3:okhttp:$rootProject.okHttpVersion"<br/>implementation "com.squareup.okhttp3:logging-interceptor:$rootProject.okHttpVersion"<br/><br/>// Retrofit2<br/>implementation "com.squareup.retrofit2:retrofit:$rootProject.retrofitVersion"<br/>implementation "com.squareup.retrofit2:converter-gson:$rootProject.retrofitVersion"<br/>implementation "com.github.akarnokd:rxjava3-retrofit-adapter:3.0.0"<br/>implementation "com.squareup.retrofit2:converter-protobuf:$rootProject.retrofitVersion"<br/><br/>// Hilt<br/>implementation "com.google.dagger:hilt-android:$rootProject.hiltVersion"<br/>annotationProcessor "com.google.dagger:hilt-android-compiler:$rootProject.hiltVersion"<br/>annotationProcessor 'androidx.hilt:hilt-compiler:1.0.0'</span></pre><blockquote class="ls lt lu"><p id="eb65" class="if ig lr ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated">App.java</p><p id="5abf" class="if ig lr ih b ii ij ik il im in io ip lv ir is it lw iv iw ix lx iz ja jb jc hb bi translated">带匕首2刀柄。</p></blockquote><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="af6c" class="ky jq hi ku b be kz la l lb lc">@HiltAndroidApp<br/>public class App extends Application {<br/><br/>    @Override<br/>    public void onCreate() {<br/>        super.onCreate();<br/>        Hawk.init(this).build();<br/>        AppLog.init();<br/>    }<br/><br/>    @Override<br/>    protected void attachBaseContext(Context base) {<br/>        super.attachBaseContext(base);<br/>        MultiDex.install(this);<br/>    }<br/>}</span></pre><p id="0fdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，创建一个带有两个助手函数的preference helper(SharedPrefManager)来读/写当前环境选择模式的状态。</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="1763" class="ky jq hi ku b be kz la l lb lc"> // Store &amp; Get Prod or Dev Environment<br/><br/> void setProdEnvironmentStatus(boolean status);<br/> boolean isProdEnvironment();</span></pre><p id="00d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，创建<strong class="ih hj">拦截器</strong>来处理切换环境工作。😮</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="ly lz l"/></div></figure><p id="b223" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于默认的基本url，将使用DEVELOPMENT_BASE_URL注入更新，假定为应用程序的默认选择。</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="5e66" class="ky jq hi ku b be kz la l lb lc">@Provides<br/>@Singleton<br/>public Retrofit provideRetrofitClient(ProtoConverterFactory protoConverterFactory, RxJava3CallAdapterFactory rxJava3CallAdapterFactory, OkHttpClient okHttpClient) {return new Retrofit.Builder()<br/>            .client(okHttpClient)<br/>            .baseUrl(BuildConfig.DEVELOPMENT_BASE_URL)<br/>            .addConverterFactory(protoConverterFactory)<br/>            .addCallAdapterFactory(rxJava3CallAdapterFactory)<br/>            .build();<br/>}</span></pre><p id="4496" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">现在</strong>提供<strong class="ih hj">HostSelectionInterceptor</strong>依赖给NetworkModule.java的hant as，</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="7508" class="ky jq hi ku b be kz la l lb lc">@Provides<br/>@Singleton<br/>public HostSelectionInterceptor provideHostSelectionInterceptor(PreferenceHelper preferenceHelper) {<br/>    return new HostSelectionInterceptor(preferenceHelper);<br/>}</span></pre><p id="263b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，将这个拦截器提供给我们的OkHttpClient构建器，如下所示。</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="02d8" class="ky jq hi ku b be kz la l lb lc">@Provides<br/>@Singleton<br/>public OkHttpClient provideOkHttpClient(@ApplicationContext Context context, HttpLoggingInterceptor httpLoggingInterceptor, HostSelectionInterceptor hostSelectionInterceptor) {<br/><br/>    long cacheSize = 5 * 1024 * 1024;<br/>    Cache mCache = new Cache(context.getCacheDir(), cacheSize);<br/>    if (BuildConfig.DEBUG) {<br/>        return new OkHttpClient().newBuilder()<br/>                .cache(mCache)<br/>                .retryOnConnectionFailure(true)<br/>                .connectTimeout(200, TimeUnit.SECONDS)<br/>                .readTimeout(200, TimeUnit.SECONDS)<br/>                .addInterceptor(httpLoggingInterceptor)<br/>                .addInterceptor(hostSelectionInterceptor)<br/>                .followRedirects(true)<br/>                .followSslRedirects(true)<br/>                .build();<br/><br/>    } else {<br/>        return new OkHttpClient().newBuilder()<br/>                .connectTimeout(200, TimeUnit.SECONDS)<br/>                .readTimeout(200, TimeUnit.SECONDS)<br/>                .retryOnConnectionFailure(true)<br/>                .followRedirects(true)<br/>                .followSslRedirects(true)<br/>                .addInterceptor(hostSelectionInterceptor)<br/>                .build();<br/>    }<br/><br/>}</span></pre><p id="d7fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们只需提供@ <strong class="ih hj"> Inject </strong>注释，就可以<strong class="ih hj">将</strong><strong class="ih hj">HostSelectionInterceptor</strong>注入到我们的视图模型或活动中。</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="055a" class="ky jq hi ku b be kz la l lb lc">@Inject<br/>    HostSelectionInterceptor hostSelectionInterceptor;</span></pre><p id="d95d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">最后</strong>，我们可以在这些环境之间切换，只需更改共享偏好设置上的选择模式状态，并调用<strong class="ih hj">HostSelectionInterceptor</strong>中的<strong class="ih hj"> setHostBaseUrl </strong>函数。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es ma"><img src="../Images/44e22776b2f3b4717529da6f0106c60b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*xQnn65qsfYsvVNUm.gif"/></div></figure><p id="a35d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“开发”和“生产”环境的微调开关示例。</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="ac1c" class="ky jq hi ku b be kz la l lb lc">private void doSetupHostSelection() {<br/><br/>    ArrayAdapter&lt;String&gt; arrayAdapter = new CustomSpinnerAdapter(this).spinnerAdapter();<br/>    //Setting the ArrayAdapter data on the Spinner<br/>    arrayAdapter.add("DEV");<br/>    arrayAdapter.add("PROD");<br/>    getViewDataBinding().spinnerHostSelection.setAdapter(arrayAdapter);<br/><br/><br/>// selector    <br/>getViewDataBinding().spinnerHostSelection.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {<br/>        @Override<br/>        public void onItemSelected(AdapterView&lt;?&gt; parent, View view, int position, long id) {<br/><br/>            if (position == 0) {<br/>                preferenceHelper.setProdEnvironmentStatus(false);<br/>                hostSelectionInterceptor.setHostBaseUrl();<br/><br/>            } else {<br/>                preferenceHelper.setProdEnvironmentStatus(true);<br/>                hostSelectionInterceptor.setHostBaseUrl();<br/>            }<br/>        }<br/><br/>        @Override<br/>        public void onNothingSelected(AdapterView&lt;?&gt; parent) {<br/><br/>        }<br/>    });<br/><br/>}</span></pre><p id="876b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个函数<strong class="ih hj"> setHostBaseUrl </strong>将完成剩下的工作。</p><pre class="je jf jg jh fd kt ku kv bn kw kx bi"><span id="0c8a" class="ky jq hi ku b be kz la l lb lc">public void setHostBaseUrl() {<br/>    if (preferenceHelper.isProdEnvironment()) {<br/>        this.host = HttpUrl.parse(BuildConfig.PRODUCTION_BASE_URL);<br/>    } else {<br/>        this.host = HttpUrl.parse(BuildConfig.DEVELOPMENT_BASE_URL);<br/>    }<br/>}</span></pre><p id="b85e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这些…感谢您的阅读…</p><blockquote class="mb"><p id="2330" class="mc md hi bd me mf mg mh mi mj mk jc dx translated">Ps:上面的实现只是一个样本，我们如何使用不同的网址进行改造。这种技术的实现取决于您的需求。</p></blockquote><p id="18a6" class="pw-post-body-paragraph if ig hi ih b ii ml ik il im mm io ip iq mn is it iu mo iw ix iy mp ja jb jc hb bi translated">抓住这个想法并以你最好的方式实现它！</p><p id="3d41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如有任何困惑或建议，请填写评论部分🐧</p></div></div>    
</body>
</html>