<html>
<head>
<title>Analyze Terraform costs with Infracost ( The GitOps Way )</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Infracost 分析地形成本(GitOps 方法)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/terraforming-the-cost-with-infracost-c28dc6c981c9?source=collection_archive---------2-----------------------#2022-04-09">https://medium.com/nerd-for-tech/terraforming-the-cost-with-infracost-c28dc6c981c9?source=collection_archive---------2-----------------------#2022-04-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1c39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用基础成本分析土地改造成本</p><p id="9320" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Terraform 是各种组织使用的主要 IAC 工具之一。在我之前的文章中，我已经解释了 Atlantis 和 GitHub 操作如何被用来以 GitOps 的方式提供基础设施。但是成本呢？GitOps 方法显然使部署变得容易了。开发人员/运营工程师将开始轻松提高 PR，并不断合并它们。但是谁来记录成本呢？我们不能指派一名工程师一直记录成本。假设有 100 个拉动式请求，工程师无法从 AWS 计算器中真正计算出所有 PR 的成本。如果有一种工具可以根据基础设施的变化来评估增量/减量，那会怎么样？啊，太酷了，不是吗？接下来是<a class="ae jd" href="https://www.infracost.io/docs/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> Infracost </strong> </a>进入画面。Infracost 显示 Terraform 的云成本估计。它可以让 DevOps、SRE 和工程师们在终端或拉式请求中做出更改之前，查看成本明细并了解成本。这为您的团队提供了一个安全网，因为人们可以在工作流程中讨论成本。使用众多集成中的一个，DevOps、SRE 和工程师们在做出改变之前在拉请求中看到成本估计。这为您的团队提供了一个安全网，因为人们可以提前了解云成本，并在您的工作流程中讨论它们。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/506519ec6ed19de981f8e31342c7d0ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*iMPewL3xNdcNAxXc.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">基础成本</figcaption></figure><h1 id="c317" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">整个故事是关于什么的？(TLDR)</h1><ol class=""><li id="d6a5" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">用 GitOps 方法识别和分析成本。</li><li id="e820" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">集成 Infracost 和 GitHub 动作。</li></ol><h1 id="59e3" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">先决条件</h1><ol class=""><li id="6605" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">GitHub 账户。</li><li id="f66f" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">AWS 账户。</li></ol><h1 id="3120" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">故事资源</h1><ol class=""><li id="aa67" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">GitHub 链接:【https://github.com/pavan-kumar-99/medium-manifests T4】</li><li id="9428" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">GitHub 分支:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/tree/infracost" rel="noopener ugc nofollow" target="_blank"> infracost </a></li></ol><h1 id="8ffb" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置基础成本</h1><p id="15a1" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">注册一个免费的 API 密钥，CLI 使用该密钥从我们的云定价 API 中检索价格，例如获取价格，例如类型。没有云凭证或秘密被<a class="ae jd" href="https://www.infracost.io/docs/faq/#what-data-is-sent-to-the-cloud-pricing-api" rel="noopener ugc nofollow" target="_blank">发送</a>到 API，你也可以<a class="ae jd" href="https://www.infracost.io/docs/cloud_pricing_api/self_hosted/" rel="noopener ugc nofollow" target="_blank">自托管</a>它。</p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="96be" class="lq jv hi lm b fi lr ls l lt lu">$ brew install infracost</span><span id="d421" class="lq jv hi lm b fi lv ls l lt lu">$ infracost --version</span><span id="1f1c" class="lq jv hi lm b fi lv ls l lt lu">$ infracost register</span></pre><h1 id="6a54" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置 GitHub 操作</h1><p id="bf5e" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq li is it iu lj iw ix iy lk ja jb jc hb bi translated">要了解更多关于 GitHub 动作以及如何将 terraform 与 GitHub 动作集成的信息，我之前的一篇文章<a class="ae jd" rel="noopener" href="/nerd-for-tech/creating-a-gke-cluster-with-github-actions-dd34e2de50a6"> <strong class="ih hj">这里</strong> </a>已经做了很好的解释。所以让我们看看作为本文一部分的实际 Github 工作流文件。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="7250" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，作为这个例子的一部分，我将在 AWS 中创建一个 EC2 实例。因此，如果您看到工作流文件，您会注意到我们为 AWS 添加了几个秘密，还添加了我们之前生成的 InfraCost API 密钥。这个工作流程是这样设计的，一旦有一个 pull 请求提交给分支机构 infracost(第 4 行)，</p><ol class=""><li id="7b67" class="ks kt hi ih b ii ij im in iq ly iu lz iy ma jc kz la lb lc bi translated">检查存储库。</li><li id="bc0c" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">安装 terraform 二进制文件。</li><li id="a736" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">初始化地形目录。</li><li id="3385" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">地形图。</li><li id="b7c7" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">Terraform 显示，保存计划输出。</li><li id="292b" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">初始化 Infracost API。</li><li id="c4f7" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">生成 Infracost JSON。</li><li id="8eb3" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">分析成本并对拉动请求进行评论。</li></ol><p id="974c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">干得好。我们都准备好用 GitOps 方法分析成本了。但在此之前，让我们创建必要的 GitHub 秘密。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mb"><img src="../Images/68b7266ffa77307a56c8d2da4d386d2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xu9P1QNcYEtqI5tmM7Fvjw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">GitHub 秘密</figcaption></figure><p id="3266" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为本文的一部分，我们需要以下秘密。</p><ol class=""><li id="49f5" class="ks kt hi ih b ii ij im in iq ly iu lz iy ma jc kz la lb lc bi translated">AWS_ACCESS_KEY_ID</li><li id="95ce" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">AWS_SECRET_ACCESS_KEY</li><li id="9666" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">INFRACOST_API_KEY</li></ol><p id="6b90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完成了。现在让我们来看看 Infracost 的运行情况。我已经创建了一个 Terraform 脚本来创建 EC2 实例。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mc"><img src="../Images/4f1eb45318e529501fcc0d54ab2dd3c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b0McJDYHNmWMa8icb-jJhg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">EC2 实例</figcaption></figure><p id="0a04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们通过将实例类型从 t2.medium 更改为 t3.medium 来创建一个 pull 请求。！激动吗？我也是！！！！</p><p id="40a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们检查一下对我<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/pull/22" rel="noopener ugc nofollow" target="_blank">提出的</a>拉动请求的评论。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es md"><img src="../Images/d39adb8453a6d0d78f7494bfee41acb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RQ7dLxYvu3LjvfStyKWpZw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">关于成本的评论</figcaption></figure><p id="15b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，如果您仔细观察注释，您应该会看到一个表格，显示以前的成本、新的成本和差异(增量或减量)。以及资源配置及其规格和定价的精确输出。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es me"><img src="../Images/8c3b7f9b8b29fb442268a0c6d257a74c.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*pC8CdAMD-4tNDgoK.gif"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">我看着我所有的钱去了哪里</figcaption></figure><p id="ea11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">清理</strong></p><pre class="jf jg jh ji fd ll lm ln lo aw lp bi"><span id="edc2" class="lq jv hi lm b fi lr ls l lt lu">$ Delete the worflow files from your Github</span></pre><p id="a26b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">啊，这些是用 GitOps 方法分析成本所需的所有步骤。我希望你喜欢这篇文章。请随意分享您在成本分析和降低成本活动中的想法和经验。如果您在部署过程中遇到任何问题，请在此处提出问题<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/issues" rel="noopener ugc nofollow" target="_blank"/>或随时通过我的电子邮件(<strong class="ih hj">pavan1999.kumar@gmail.com</strong>)联系我。此外，如有任何疑问/咨询，请点击此处 联系 Kubernetes <a class="ae jd" href="https://linktr.ee/bettercallpavan" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">。</strong></a></p><p id="5b53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是我的一些其他文章，你可能会感兴趣</p><p id="6144" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">直到下一次…..</p><h1 id="a59c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">被推荐的</h1><div class="mf mg ez fb mh mi"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/terraforming-the-gitops-way-9417cf4abf58"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hj fi z dy mn ea eb mo ed ef hh bi translated">地球化吉托普斯之路！！！</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">使用 Atlantis(拉式请求自动化)通过 GitOps 建立 Terraform。</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">medium.com</p></div></div><div class="mr l"><div class="ms l mt mu mv mr mw jo mi"/></div></div></a></div><div class="mf mg ez fb mh mi"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/using-hashicorp-vault-as-a-certificate-issuer-in-cert-manager-9e19d7239d3d"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hj fi z dy mn ea eb mo ed ef hh bi translated">在证书管理器中将 Hashicorp Vault 用作证书颁发者</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">在证书管理器中将 vault PKI 后端配置为证书提供商</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">medium.com</p></div></div><div class="mr l"><div class="mx l mt mu mv mr mw jo mi"/></div></div></a></div><div class="mf mg ez fb mh mi"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/deep-dive-into-thanos-part-i-f72ecba39f76"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hj fi z dy mn ea eb mo ed ef hh bi translated">深入灭霸——第一部分</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">使用灭霸和普罗米修斯操作员监控 Kubernetes 的工作负载</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">medium.com</p></div></div><div class="mr l"><div class="my l mt mu mv mr mw jo mi"/></div></div></a></div><div class="mf mg ez fb mh mi"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/chaos-engineering-in-kubernetes-using-chaos-mesh-431c1587ef0a"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hj fi z dy mn ea eb mo ed ef hh bi translated">基于混沌网格的 Kubernetes 混沌工程</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">基于混沌网格的 Kubernetes 混沌工程</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">用混沌 Meshmedium.com 研究库伯内特的混沌工程</p></div></div><div class="mr l"><div class="mz l mt mu mv mr mw jo mi"/></div></div></a></div></div></div>    
</body>
</html>