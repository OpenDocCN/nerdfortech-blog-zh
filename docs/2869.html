<html>
<head>
<title>Stripe multiple accounts with Laravel Cashier</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Laravel 收银机将多个账户分条</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/stripe-multiple-accounts-with-laravel-cashier-31573f86ee4e?source=collection_archive---------8-----------------------#2021-05-22">https://medium.com/nerd-for-tech/stripe-multiple-accounts-with-laravel-cashier-31573f86ee4e?source=collection_archive---------8-----------------------#2021-05-22</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><figure class="ew ey ih ii ij ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et ig"><img src="../Images/efb144f88589b5da5a870482b7342e40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3dTmF-8tnwejW7ER"/></div></div><figcaption class="ir is eu es et it iu bd b be z dy translated"><a class="ae iv" href="https://unsplash.com/@homajob?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">斯科特·格雷厄姆</a>在<a class="ae iv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="a38c" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我试图解决的问题如下。假设您有两家公司销售几乎相同类型的套餐，但每家公司都位于不同的国家，适用不同的法律，因此您开设了两个 stripe 帐户，并希望将它们集成到您当前运行的支持一个 Stripe 帐户的应用程序中。</p><p id="a9d3" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">开箱即用的 Laravel 收银机支持一个条纹账户，你把你的关键和秘密，你都设置好了。</p><p id="5edf" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><strong class="iy hk">作为一个想法，这个解决方案只对登录用户有效。</strong></p><p id="1723" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">所以我是这样解决我的问题的。我有来自两个不同国家的客户。在此基础上，我根据这些国家划分了我的计划，因此我的计划、国家和用户表如下所示。</p><figure class="ju jv jw jx fe ik"><div class="bz dz l di"><div class="jy jz l"/></div></figure><p id="a7c9" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">查看 vendor/laravel/cashier/src/billable . PHP 中的收银员代码，我们注意到许多调用如下所示:</p><pre class="ju jv jw jx fe ka kb kc kd aw ke bi"><span id="5e7d" class="kf kg hj kb b fj kh ki l kj kk">StripeCustomer::retrieve($this-&gt;stripe_id, $this-&gt;stripeOptions());<br/><br/>StripePaymentIntent::create($options, $this-&gt;stripeOptions());<br/><br/>StripePaymentIntent::retrieve($paymentIntent, $this-&gt;stripeOptions());</span></pre><p id="9ce2" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><strong class="iy hk">$ this-&gt;stripe options()</strong>实现为:</p><pre class="ju jv jw jx fe ka kb kc kd aw ke bi"><span id="714f" class="kf kg hj kb b fj kh ki l kj kk">// <!-- -->vendor/laravel/cashier/src/Concerns/ManagesCustomer<!-- -->.php<br/><br/><em class="kl">/**<br/> * Get the default Stripe API options for the current Billable model.<br/> *<br/> * </em><strong class="kb hk"><em class="kl">@param  </em></strong><em class="kl">array  $options<br/> * </em><strong class="kb hk"><em class="kl">@return </em></strong><em class="kl">array<br/> */<br/></em><strong class="kb hk">public function </strong>stripeOptions(<strong class="kb hk">array </strong>$options = [])<br/>{<br/>    <strong class="kb hk">return </strong>Cashier::<em class="kl">stripeOptions</em>($options);<br/>}</span></pre><p id="73e2" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">这又来自于:</p><pre class="ju jv jw jx fe ka kb kc kd aw ke bi"><span id="1527" class="kf kg hj kb b fj kh ki l kj kk">// vendor/laravel/cashier/src/Cashier.php</span><span id="8f71" class="kf kg hj kb b fj km ki l kj kk"><em class="kl">/**<br/> * Get the default Stripe API options.<br/> *<br/> * </em><strong class="kb hk"><em class="kl">@param  </em></strong><em class="kl">array  $options<br/> * </em><strong class="kb hk"><em class="kl">@return </em></strong><em class="kl">array<br/> */<br/></em><strong class="kb hk">public static function </strong>stripeOptions(<strong class="kb hk">array </strong>$options = [])<br/>{<br/>    <strong class="kb hk">return </strong><em class="kl">array_merge</em>([<br/>        <strong class="kb hk">'api_key' </strong>=&gt; config(<strong class="kb hk">'cashier.secret'</strong>),<br/>        <strong class="kb hk">'stripe_version' </strong>=&gt; <strong class="kb hk">static</strong>::<strong class="kb hk"><em class="kl">STRIPE_VERSION</em></strong>,<br/>    ], $options);<br/>}</span></pre><p id="11f4" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">解决方案是用代码在<strong class="iy hk"> $options </strong>数组中设置适当的秘密来覆盖<strong class="iy hk">可收费的</strong>特征。为了实现我们的目标，我们创建了一个表，其中存储了每个国家的条带帐户，如下所示:</p><figure class="ju jv jw jx fe ik"><div class="bz dz l di"><div class="jy jz l"/></div></figure><p id="c7e3" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">到目前为止，我们知道我们有来自不同国家的用户，每个国家都有一个条纹帐户。我们在用户模型中覆盖了<strong class="iy hk"> stripeOptions </strong>，它看起来像下面这样:</p><figure class="ju jv jw jx fe ik"><div class="bz dz l di"><div class="jy jz l"/></div></figure><p id="4b0b" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated"><strong class="iy hk">提示:</strong>作为一种安全措施，不要存储来自任何平台的普通密钥和秘密。一个解决方案是加密敏感字段。其思想是在插入时加密数据，并在需要时解密。有很多库可以帮助你做到这一点。</p><p id="97e3" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">另一件事，我做了，以确保我的解决方案的工作，我必须从收银台覆盖支付控制器。为此，我们首先采用我们的控制器，而不是来自供应商的控制器:</p><pre class="ju jv jw jx fe ka kb kc kd aw ke bi"><span id="5779" class="kf kg hj kb b fj kh ki l kj kk">$this-&gt;app-&gt;bind(\Laravel\Cashier\Http\Controllers\PaymentController::class, \App\Http\Controllers\PaymentController::class);</span></pre><p id="cfcc" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">这一行你需要放入<strong class="iy hk"> AppServiceProvider。</strong>最终的解决方案看起来有点像下图。</p><figure class="ju jv jw jx fe ik"><div class="bz dz l di"><div class="jy jz l"/></div></figure></div></div>    
</body>
</html>