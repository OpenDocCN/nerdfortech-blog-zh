<html>
<head>
<title>Using Git Submodule and Develop Mode to Manage Python Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Git子模块和开发模式管理Python项目</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/using-git-submodule-and-develop-mode-to-manage-python-projects-887489ee9a53?source=collection_archive---------6-----------------------#2019-12-23">https://medium.com/nerd-for-tech/using-git-submodule-and-develop-mode-to-manage-python-projects-887489ee9a53?source=collection_archive---------6-----------------------#2019-12-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="efda" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">【更新时间:2020年12月27日】</em></p><p id="42a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为一名软件工程师，我们从事的项目依赖于我们同时从事的另一个项目，这种情况并不少见。该场景可能如下所示:</p><p id="17c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们有两个项目，每个项目都有自己的Git存储库:</p><ul class=""><li id="ece1" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">一个公共库，比如说<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>，被许多项目使用。这个库是独立的，有自己的测试套件和文档。</li><li id="9677" class="je jf hi ih b ii jr im js iq jt iu ju iy jv jc jj jk jl jm bi translated">一个名为<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>的项目依赖于<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>。</li></ul><p id="3652" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我们在做<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>的时候，我们可能也需要同时更新<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>。如果<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>和<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>恰好都是Python项目，我们可以使用setuptools的<a class="ae jw" href="https://setuptools.readthedocs.io/en/latest/setuptools.html#development-mode" rel="noopener ugc nofollow" target="_blank">开发模式</a>(开发模式)和<a class="ae jw" href="https://git-scm.com/book/en/v2/Git-Tools-Submodules" rel="noopener ugc nofollow" target="_blank"> Git子模块</a>(子模块)让工作更简单。本文演示了如何使用开发模式和子模块来处理这种情况。希望需要管理这种类型的工作流的人会发现这篇文章很有帮助。</p><p id="2b5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>和<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>在本文的其余部分中用作示例，该示例假设代码在具有以下条件的虚拟环境中运行:</p><ul class=""><li id="83ae" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">Ubuntu 20.04</li><li id="1063" class="je jf hi ih b ii jr im js iq jt iu ju iy jv jc jj jk jl jm bi translated">Python 3.9</li><li id="82d2" class="je jf hi ih b ii jr im js iq jt iu ju iy jv jc jj jk jl jm bi translated">Git 2.25</li></ul><h1 id="439c" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">挑战</h1><p id="c1dd" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">首先，对于Python项目开发，我们通常会设置一个虚拟环境，并将所有依赖项安装到虚拟环境中。然后，我们开始我们的项目，也就是本例中的<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>。但是，<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>需要<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>，我们也同时在做。如果我们以通常的方式安装<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>，例如pip install，我们就不能使用Git来跟踪<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>的变化。这是发展模式来解决的问题。</p><p id="54d5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二，<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>被很多项目使用，包括<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>。一方面，在开发过程中，<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>可能需要坚持使用<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>、<em class="jd">、</em>的特定版本或分支，但其他项目可能需要不同版本的<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>。为了确保我们在处理<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>时使用正确的分支或版本<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>，我们可以将依赖项设置为Git子模块。</p><h1 id="18a8" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">什么是发展模式？</h1><p id="2de6" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">开发模式允许项目既可安装又可编辑。</p><p id="8088" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，我们从PyPi安装一个Python包。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="254b" class="li jy hi jq b fi lj lk l ll lm">$ pip install &lt;package_name&gt;</span></pre><p id="9b91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，我们从本地软件包安装它。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="3e28" class="li jy hi jq b fi lj lk l ll lm">$ pip install &lt;path_to_local_archive&gt;</span></pre><p id="0e05" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论哪种方式，软件包都将安装在我们的(虚拟)环境中。例如，当我们将Python包安装到虚拟环境中时，该包将被复制到/virtual _ environment/lib/Python 3.9/site-packages/。如果我们想将<a class="ae jw" href="https://github.com/shunsvineyard/commonlib" rel="noopener ugc nofollow" target="_blank"> commonlib </a>安装到我们的虚拟环境中，我们可以:</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="55ca" class="li jy hi jq b fi lj lk l ll lm">$ git clone https://github.com/shunsvineyard/commonlib.git <br/>$ pip install commonlib/</span></pre><p id="702d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装完成后，将在site-packages文件夹中显示为已安装的软件包。我们可以使用<code class="du jn jo jp jq b">ls</code>命令来检查它。例如，结果可能如下所示:</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="4d4f" class="li jy hi jq b fi lj lk l ll lm">(demoenv) shunsvineyard@INSPIRON7000:~$ ls -l ~/demoenv/lib/python3.9/site-packages/ <br/>total 332 <br/>drwxr-xr-x  2 shunsvineyard shunsvineyard   4096 Nov  9 22:12 __pycache__ <br/>drwxr-xr-x  3 shunsvineyard shunsvineyard   4096 Dec 26 21:25 commonlib <br/>drwxr-xr-x  2 shunsvineyard shunsvineyard   4096 Dec 26 21:25 commonlib-0.0.1-py3.9.egg-info <br/>-rw-r--r--  1 shunsvineyard shunsvineyard     53 Nov  9 22:34 commonlib.egg-link <br/>-rw-r--r--  1 shunsvineyard shunsvineyard     52 Nov  9 22:34 easy-install.pth <br/>-rw-r--r--  1 shunsvineyard shunsvineyard    126 Nov  9 21:42 easy_install.py<br/>…</span></pre><p id="a531" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开发模式创建从包到虚拟环境的链接。在开发模式下，可以安装一个Python包，允许我们在安装后编辑代码。因此，当我们更改代码时，更改会在虚拟环境中立即生效。</p><p id="5094" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要以开发模式安装Python包，请使用命令</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="8710" class="li jy hi jq b fi lj lk l ll lm">$ pip install -e &lt;path to the package&gt;</span></pre><p id="28a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>为例，结果可能如下:</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="297b" class="li jy hi jq b fi lj lk l ll lm">(demoenv) shunsvineyard@INSPIRON7000:~$ python -m pip install -e commonlib/ <br/>Obtaining file:///home/shunsvineyard/commonlib <br/>Installing collected packages: commonlib <br/> Running setup.py develop for commonlib <br/>Successfully installed commonlib <br/>(demoenv) shunsvineyard@INSPIRON7000:~$ ls -l ~/demoenv/lib/python3.9/site-packages/ <br/>total 324 <br/>drwxr-xr-x  2 shunsvineyard shunsvineyard   4096 Nov  9 22:12 __pycache__ <br/>-rw-r--r--  1 shunsvineyard shunsvineyard     31 Dec 26 22:28 commonlib.egg-link <br/>-rw-r--r--  1 shunsvineyard shunsvineyard     30 Dec 26 22:28 easy-install.pth <br/>-rw-r--r--  1 shunsvineyard shunsvineyard    126 Nov  9 21:42 easy_install.py<br/>…</span></pre><p id="ec12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们打开文件<code class="du jn jo jp jq b"><em class="jd">commonlib.egg-link</em></code>，我们会看到它链接到哪里。举个例子，</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="7aeb" class="li jy hi jq b fi lj lk l ll lm">(demoenv) shunsvineyard@INSPIRON7000:~$ cat ~/demoenv/lib/python3.9/site-packages/commonlib.egg-link <br/>/home/shunsvineyard/commonlib</span></pre><p id="601d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，开发模式仅适用于本地项目或VCS网址。如果我们试图从PyPi安装一个包作为开发模式，下面的错误信息将会显示。以<code class="du jn jo jp jq b"><em class="jd">numpy</em></code>为例，</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="f2b4" class="li jy hi jq b fi lj lk l ll lm">$ pip install -e numpy <br/>numpy should either be a path to a local project or a VCS url beginning with svn+, git+, hg+, or bzr+</span></pre><h1 id="cd22" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">什么是Git子模块？</h1><p id="8d9e" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">Git子模块是另一个Git存储库中的Git存储库。就好像一个Git存储库引用了另一个Git存储库。比如<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>对<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>有依赖关系。如果<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>是<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>的Git子模块，下图说明了它们的关系。</p><figure class="la lb lc ld fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es ln"><img src="../Images/648ae22d583a0e8475e92a4c0af3808d.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/0*uw5SsTuv3AwOAaAS.png"/></div></div></figure><p id="3536" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Git子模块允许我们将一个Git存储库作为另一个Git存储库的子目录。当我们克隆<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>的时候，在<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>子模块引用中定义的一个特定的<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>将会从<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>库下载。通过这种方式，我们可以将另一个存储库(即<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>)克隆到我们的项目(即<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>)中，并将提交分开。</p><p id="b3c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下章节使用<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>和<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>演示开发模式和子模块的设置和工作流程。下面几节还假设我们从头开始做所有的事情，包括设置Git存储库。</p><h1 id="4059" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">设置项目</h1><p id="e390" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">假设<em class="jd"> commonlib </em>提供了一个简单且唯一的特性:问候。项目布局和代码如下所示:</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="1abf" class="li jy hi jq b fi lj lk l ll lm">commonlib/<br/> ├── LICENSE<br/> ├── README.rst<br/> ├── commonlib<br/> │   ├── __init__.py<br/> │   └── greeting.py<br/> └── setup.py</span></pre><p id="9324" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> greeting.py </strong></p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="8b67" class="li jy hi jq b fi lj lk l ll lm">def greeting(name: str):<br/>    """Print a simple greeting with the name."""<br/>    print(f"Howdy, {name}")</span></pre><p id="c886" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> setup.py </strong></p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="3668" class="li jy hi jq b fi lj lk l ll lm">import pathlib<br/>import setuptools<br/><br/># The directory containing this file<br/>HERE = pathlib.Path(__file__).parent<br/><br/># The text of the README file<br/>README = (HERE / "README.rst").read_text()<br/><br/># This call to setup() does all the work<br/>setuptools.setup(<br/>    name="commonlib",<br/>    version="0.0.1",<br/>    description="A simple Python package",<br/>    long_description=README,<br/>    long_description_content_type="text/x-rst",<br/>    author="Author Name",<br/>    author_email="author@email.com",<br/>    license="MIT",<br/>    classifiers=[<br/>        "License :: OSI Approved :: MIT License",<br/>        "Programming Language :: Python"<br/>    ],<br/>    packages=setuptools.find_packages(),<br/>    python_requires="&gt;=3"<br/>)</span></pre><p id="b4e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(完整的例子可以在<a class="ae jw" href="https://github.com/shunsvineyard/commonlib" rel="noopener ugc nofollow" target="_blank">https://github.com/shunsvineyard/commonlib</a>找到)</p><p id="44cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经准备好为<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>和<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>建立Git存储库了。在此之前，我们需要设置一个Git服务器。这个示例使用localhost(即127.0.0.1)作为Git服务器。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="8906" class="li jy hi jq b fi lj lk l ll lm">$ sudo useradd git<br/>$ sudo passwd git<br/>$ su git<br/>$ cd ~<br/>$ git init –bare commonlib<br/>$ git init –bare myproj</span></pre><h1 id="b640" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">为commonlib设置Git仓库</h1><p id="2c3f" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">有了Git服务器之后，我们可以将现有的<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>添加到Git服务器中。返回到本地用户。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="416e" class="li jy hi jq b fi lj lk l ll lm">user:~$ cd commonlib/<br/>user:~/commonlib$ git init<br/>user:~/commonlib$ git add –all<br/>user:~/commonlib$ git commit -a -m "Initialize commonlib repository"<br/>user:~/commonlib$ git remote add origin git@127.0.0.1:commonlib<br/>user:~/commonlib $ git push -u origin master</span></pre><h1 id="eafa" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">为myproj设置Git存储库</h1><p id="25d9" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">对于<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>，我们可以做和<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>类似的事情。项目布局和代码如下所示:</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="4d2f" class="li jy hi jq b fi lj lk l ll lm">myproj/<br/>├── LICENSE<br/>├── README.rst<br/>├── app.py<br/>└── setup.py</span></pre><p id="cced" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> app.py </strong></p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="b225" class="li jy hi jq b fi lj lk l ll lm">from commonlib import greeting<br/><br/>def run():<br/>    greeting.greeting("Git Submodule")<br/><br/>if __name__ == "__main__":<br/>    run()</span></pre><p id="1457" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> setup.py </strong></p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="ff05" class="li jy hi jq b fi lj lk l ll lm">import pathlib<br/>import setuptools<br/><br/># The directory containing this file<br/>HERE = pathlib.Path(__file__).parent<br/><br/># The text of the README file<br/>README = (HERE / "README.rst").read_text()<br/><br/># This call to setup() does all the work<br/>setuptools.setup(<br/>    name="myproj",<br/>    version="0.0.1",<br/>    description="A simple Python project",<br/>    long_description=README,<br/>    long_description_content_type="text/x-rst",<br/>    url="https://github.com/shunsvineyard/myproj",<br/>    author="Author Name",<br/>    author_email="author@email.com",<br/>    license="MIT",<br/>    classifiers=[<br/>        "License :: OSI Approved :: MIT License",<br/>        "Programming Language :: Python"<br/>    ],<br/>    packages=setuptools.find_packages(),<br/>    python_requires="&gt;=3"<br/>)</span></pre><p id="d73b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，将现有代码添加到Git服务器。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="f199" class="li jy hi jq b fi lj lk l ll lm">user:~$ cd myproj/<br/>user:~/myproj$ git init<br/>user:~/myproj$ git add –all<br/>user:~/myproj$ git commit -a -m "Initialize myprojrepository"<br/>user:~/myproj$ git remote add origin git@127.0.0.1: myproj<br/>user:~/myproj$ git push -u origin master</span></pre><h1 id="811e" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">设置Git子模块</h1><p id="32e5" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">尽管Git子模块为各种情况提供了许多特性，但使用最多的两个用例是1。添加一个存储库作为子模块；2 .更新子模块。</p><h1 id="4181" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">添加一个存储库作为子模块</h1><p id="be14" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">可以通过以下命令将现有存储库添加为另一个存储库的子模块:</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="b9c3" class="li jy hi jq b fi lj lk l ll lm">user:~$ cd myproj/<br/>user:~/myproj$ git submodule add git@127.0.0.1:commonlib<br/>user:~/myproj$ git submodule init<br/>user:~/myproj$ git commit -a -m "Add commonlib as submodule"<br/>user:~/myproj$ git push</span></pre><p id="f709" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加子模块后，将创建一个子模块引用，即一个<code class="du jn jo jp jq b">.gitmodules</code>文件。它可能如下所示:</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="1478" class="li jy hi jq b fi lj lk l ll lm">(demoenv) shunsvineyard@INSPIRON7000:~/workspace/myproj$ ls -al<br/>total 40<br/>drwxrwxr-x  4 shunsvineyard shunsvineyard 4096 Dec 20 07:20 .<br/>drwxrwxr-x 10 shunsvineyard shunsvineyard 4096 Dec 20 06:47 ..<br/>drwxrwxr-x  9 shunsvineyard shunsvineyard 4096 Dec 20 07:22 .git<br/>-rw-rw-r--  1 shunsvineyard shunsvineyard 1233 Dec 20 06:44 .gitignore<br/>-rw-rw-r--  1 shunsvineyard shunsvineyard   73 Dec 20 07:20 .gitmodules<br/>-rw-rw-r--  1 shunsvineyard shunsvineyard 1067 Dec 20 06:44 LICENSE<br/>-rw-rw-r--  1 shunsvineyard shunsvineyard  278 Dec 20 06:58 README.rst<br/>-rw-rw-r--  1 shunsvineyard shunsvineyard  123 Dec 20 06:57 app.py<br/>drwxrwxr-x  3 shunsvineyard shunsvineyard 4096 Dec 20 07:20 commonlib<br/>-rw-rw-r--  1 shunsvineyard shunsvineyard  724 Dec 20 06:57 setup.py</span></pre><p id="fd0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们打开文件<code class="du jn jo jp jq b">.gitmodules</code>，我们可以看到它记录了子模块的信息。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="dbe8" class="li jy hi jq b fi lj lk l ll lm">$ cat .gitmodules<br/>[submodule "commonlib"]<br/>        path = commonlib<br/>        url = git@127.0.0.1:commonlib</span></pre><p id="7f1b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:<code class="du jn jo jp jq b">.gitmodules</code>中子模块的url可以是相对路径。例如，<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>和<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>都位于Git服务器的同一个文件夹中。网址可以简化为<code class="du jn jo jp jq b">../<em class="jd">commonlib</em></code>。</p><p id="08bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们使用Github来托管我们的存储库，子模块可能如下所示:</p><figure class="la lb lc ld fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lv"><img src="../Images/a6b19278aad89ab1da77170d68860794.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jioPid9y6F9Yufbs.png"/></div></div></figure><p id="4ae1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(示例<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>，可在<a class="ae jw" href="https://github.com/shunsvineyard/myproj" rel="noopener ugc nofollow" target="_blank">https://github.com/shunsvineyard/myproj</a>找到)</p><h1 id="a8e9" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">更新子模块</h1><p id="e8ab" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">通常，有两种情况我们可能想要更新子模块:1 .由于一些代码更改而更新子模块。2.将子模块更新到较新或特定的版本。</p><h2 id="6aab" class="li jy hi bd jz lw lx ly kd lz ma mb kh iq mc md kl iu me mf kp iy mg mh kt mi bi translated">情况1:由于代码更改而更新子模块</h2><p id="6bb0" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">子模块只是另一个Git存储库中的一个Git存储库。当我们在一个子模块上做一些改变时，我们做的事情和我们通常在一个常规的Git存储库上做的事情是一样的。</p><p id="b6a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，我们在<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>中添加了一个名为greeting2的新函数。</p><p id="a93a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> greeting.py </strong></p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="b53b" class="li jy hi jq b fi lj lk l ll lm">def greeting2(name: str):<br/>    """Print a simple greeting with the name."""<br/>    print(f"How are you, {name}?")</span></pre><p id="9c2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们为子模块做的事情和为常规存储库做的事情一样:提交变更和推送变更。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="cfec" class="li jy hi jq b fi lj lk l ll lm">user:~$ cd myproj/commonlib<br/>user:~/myproj/commonlib$ git status<br/>On branch master<br/>Your branch is up to date with 'origin/master'.<br/><br/>Changes not staged for commit:<br/>  (use "git add &lt;file&gt;..." to update what will be committed)<br/>  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)<br/><br/>        modified:   greeting.py<br/><br/>no changes added to commit (use "git add" and/or "git commit -a")<br/><br/>user:~/myproj/commonlib$ git commit -a -m "Added a new greeting function."<br/>user:~/myproj/commonlib$ git push</span></pre><p id="5042" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们提交和推送子模块变更之后，我们可以看到主项目的子模块引用，即<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>，也发生了变更，然后我们可以做同样的事情来更新引用。然后，<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>会附加更新的<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="4685" class="li jy hi jq b fi lj lk l ll lm">user:~/myproj/commonlib$ cd ../<br/>user:~/myproj$ git status<br/>On branch master<br/>Your branch is up to date with 'origin/master'.<br/><br/>Changes not staged for commit:<br/>  (use "git add &lt;file&gt;..." to update what will be committed)<br/>  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)<br/><br/>        modified:   commonlib (new commits)<br/><br/>no changes added to commit (use "git add" and/or "git commit -a")<br/><br/>user:~/myproj$ git commit -a -m "Update submodule, commonlib"<br/>user:~/myproj$ git push</span></pre><h2 id="8f65" class="li jy hi bd jz lw lx ly kd lz ma mb kh iq mc md kl iu me mf kp iy mg mh kt mi bi translated">情况2:将子模块更新到新的或特定的版本</h2><p id="50dd" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">当其他人修改<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>或添加新功能时，我们可能希望将<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>子模块更新到最新版本。</p><p id="24ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">比如有人在<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>中增加了一个叫greeting3的新功能。</p><p id="151a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> greeting.py </strong></p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="0dcc" class="li jy hi jq b fi lj lk l ll lm">def greeting3():<br/>    """Print a simple greeting with the name."""<br/>    print("How's going?")</span></pre><p id="957b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面突出显示了提交哈希。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="d4e4" class="li jy hi jq b fi lj lk l ll lm">user2:~$ git clone git@127.0.0.1:commonlib<br/>user2:~$ cd commonlib<br/>user2:~/commonlib$ vim commonlib/greeting.py # add greeting3 function as the following<br/>user2:~/commonlib$ git commit -a -m "Added greeting3 function."<br/>user2:~/commonlib$ git push<br/>user2:~/commonlib$ git log<br/>commit 7735cf8460acd03f92e7c0529486c86ec83b2c0e (HEAD -&gt; master, origin/master, origin/HEAD)<br/>Author: user2 &lt;user2@email.com&gt;<br/>Date:   Sun Dec 22 00:27:09 2019 +0000<br/><br/>    Added greeting3 function.</span></pre><p id="89c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将子模块更新到较新或特定版本的方法是更新子模块指向的提交散列。</p><p id="da9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Git子模块官方文档说，“子模块库停留在一个分离的头部状态，指向一个特定的提交。更改提交只需签出不同的标签或提交，然后将更改添加到父存储库中。”</p><p id="6afb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是一个更新子模块提交hash<strong class="ih hj">7735 cf 8460 ACD 03 f 92 e7c 0529486 c 86 EC 83 B2 c0e</strong><code class="du jn jo jp jq b">.</code>的例子</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="de2f" class="li jy hi jq b fi lj lk l ll lm">user:~/myproj$ cd commonlib<br/>user:~/myproj/commonlib$ git pull<br/>user:~/myproj/commonlib$ git checkout 7735cf8460acd03f92e7c0529486c86ec83b2c0e<br/>Note: checking out '7735cf8460acd03f92e7c0529486c86ec83b2c0e'.<br/><br/>You are in 'detached HEAD' state. You can look around, make experimental<br/>changes and commit them, and you can discard any commits you make in this<br/>state without impacting any branches by performing another checkout.<br/><br/>If you want to create a new branch to retain commits you create, you may<br/>do so (now or later) by using -b with the checkout command again. Example:<br/><br/>  git checkout -b &lt;new-branch-name&gt;<br/><br/>HEAD is now at 7735cf8 Added greeting3 function.<br/>user:~/myproj/commonlib$ cd ..<br/>user:~/myproj$ git status<br/>On branch master<br/>Your branch is up to date with 'origin/master'.<br/><br/>Changes not staged for commit:<br/>  (use "git add &lt;file&gt;..." to update what will be committed)<br/>  (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)<br/><br/>        modified:   commonlib (new commits)<br/><br/>no changes added to commit (use "git add" and/or "git commit -a")<br/>user:~/myproj$ git commit -a -m "Update submodule, commonlib, to the newer one."<br/>user:~/myproj$ git push</span></pre><h1 id="2602" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">用Git子模块设置开发模式</h1><p id="68d8" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">开发模式是setuptools的能力，所以和写一个<code class="du jn jo jp jq b">setup.py</code>打包一个Python项目没什么区别。但是，当一个Python项目中有另一个Python项目作为其中的子模块，并且希望安装子模块作为开发模式时，我们需要将子模块添加到主项目的requirements.txt文件中。例如，<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>的requirements.txt可以如下。</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="3239" class="li jy hi jq b fi lj lk l ll lm"># Install commonlib as development mode<br/>-e ./commonlib # Path to the submodule</span></pre><p id="f034" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，当我们安装<code class="du jn jo jp jq b"><em class="jd">myproj</em></code>的依赖项时，<code class="du jn jo jp jq b"><em class="jd">commonlib</em></code>将自动安装为开发模式。</p><p id="d7b1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，如果子模块也有其依赖项，我们也可以将安装说明添加到主项目的<code class="du jn jo jp jq b">requirements.txt file</code>中。举个例子，</p><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="13ce" class="li jy hi jq b fi lj lk l ll lm"># Install the dependencies for commonlib<br/>-r ./commonlib/requirements.txt<br/><br/># Install commonlib as development mode<br/>-e ./commonlib # Path to the submodule</span></pre><h1 id="63b0" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">工作流程</h1><p id="15e1" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">当我们处理一个包含几个小项目的大项目时，我们需要同时处理主项目和它的从属项目。在这种情况下，我们通常以团队的形式与他人合作。建议的工作流程分为两个阶段:设置阶段和工作阶段。</p><p id="32bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">设置阶段</strong></p><p id="b294" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个阶段准备代码和工作环境。</p><ul class=""><li id="a9d6" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">创建虚拟环境</li><li id="9429" class="je jf hi ih b ii jr im js iq jt iu ju iy jv jc jj jk jl jm bi translated">使用<code class="du jn jo jp jq b"><em class="jd">--recurse-submodules</em></code>下载源代码。<code class="du jn jo jp jq b"><em class="jd">--recurse-submodules</em></code>将下载所有子模块。</li></ul><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="2f7e" class="li jy hi jq b fi lj lk l ll lm">$ git clone --recurse-submodules &lt;URL_to_the_repository&gt;<!-- --> </span></pre><ul class=""><li id="7416" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">检查分行。通常，当我们处理一个特性或者修复一个bug时，我们会创建一个分支。我们应该避免直接与主(或开发)分支一起工作。更多信息可以在<a class="ae jw" href="https://guides.github.com/introduction/flow/" rel="noopener ugc nofollow" target="_blank">https://guides.github.com/introduction/flow/</a>找到</li></ul><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="1265" class="li jy hi jq b fi lj lk l ll lm">$ git checkout &lt;branch_name&gt;<!-- --> </span></pre><ul class=""><li id="c54e" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">将依赖项安装到虚拟环境中。</li></ul><pre class="la lb lc ld fd le jq lf lg aw lh bi"><span id="af25" class="li jy hi jq b fi lj lk l ll lm">$ pip install -r requirements.txt</span></pre><p id="e478" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">工作阶段</strong></p><p id="d9ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一阶段表明我们正在处理真正的问题。除了代码更改之外，还有两种情况我们需要修改子模块。</p><p id="269a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">情况1:如果我们需要对一个子模块进行一些代码修改:</strong></p><ol class=""><li id="6486" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc mj jk jl jm bi translated">创建此变更的一个分支，并为子模块代码变更创建一个拉式请求(PR)。</li><li id="904b" class="je jf hi ih b ii jr im js iq jt iu ju iy jv jc mj jk jl jm bi translated">在PR被批准并且分支被合并之后，更新子模块到PR刚刚被合并的提交。</li></ol><p id="f953" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">案例2:有人更新了一个存储库，它是我们的子模块，我们想要将子模块更新到更新的提交:</strong></p><ol class=""><li id="7214" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc mj jk jl jm bi translated">使用子模块文件夹上的git pull来获取更改。</li><li id="008c" class="je jf hi ih b ii jr im js iq jt iu ju iy jv jc mj jk jl jm bi translated">将子模块的提交散列更新为我们想要的值。</li><li id="0216" class="je jf hi ih b ii jr im js iq jt iu ju iy jv jc mj jk jl jm bi translated"><code class="du jn jo jp jq b">cd</code>到主项目并提交子模块的变更</li></ol><h1 id="9af2" class="jx jy hi bd jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">结论</h1><p id="3ace" class="pw-post-body-paragraph if ig hi ih b ii kv ik il im kw io ip iq kx is it iu ky iw ix iy kz ja jb jc hb bi translated">当我们同时处理多个相关的项目时，很容易出错。当我们不得不在这种情况下工作时，开发模式和子模块提供了一种管理我们项目的简单方法。一开始使用开发模式和子模块可能并不简单。但是一旦我们熟悉了使用它，开发模式和子模块的结合防止了我们犯错误，提高了我们的生产力。</p></div><div class="ab cl mk ml gp mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="hb hc hd he hf"><p id="eef9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">原载于2019年12月23日</em><a class="ae jw" href="https://shunsvineyard.info/2019/12/23/using-git-submodule-and-develop-mode-to-manage-python-projects/" rel="noopener ugc nofollow" target="_blank"><em class="jd">https://shunsvineyard . info</em></a><em class="jd">。</em></p></div></div>    
</body>
</html>