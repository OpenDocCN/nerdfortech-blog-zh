<html>
<head>
<title>Facebook login with GraphQl Powered API in Laravel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Laravel 中使用 GraphQl 驱动的 API 进行脸书登录</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/facebook-login-with-graphql-powered-api-in-laravel-796e4c98411e?source=collection_archive---------7-----------------------#2021-06-26">https://medium.com/nerd-for-tech/facebook-login-with-graphql-powered-api-in-laravel-796e4c98411e?source=collection_archive---------7-----------------------#2021-06-26</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><figure class="ew ey ih ii ij ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et ig"><img src="../Images/40ea94a970aa3a473dc6b28a9795e54c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Qeap5noDERY86SEo"/></div></div><figcaption class="ir is eu es et it iu bd b be z dy translated"><a class="ae iv" href="https://unsplash.com/@firmbee?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Firmbee.com</a>在<a class="ae iv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="66d0" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">在这篇文章中，我将带你通过<a class="ae iv" href="https://laravel.com/docs/8.x/socialite" rel="noopener ugc nofollow" target="_blank"> Laravel 的交际花</a>包和 GraphQl 完成脸书登录集成。为此你需要有一些关于 GraphQl 的基础知识，你可以看看我下面创建的系列:</p><div class="ju jv fa fc jw jx"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/build-a-forum-with-graphql-powered-api-in-laravel-part-1-de032d13d628"><div class="jy ab dx"><div class="jz ab ka cl cj kb"><h2 class="bd hk fj z dz kc eb ec kd ee eg hi bi translated">在 Laravel 中用 GraphQL Powered API 构建一个论坛[第 1 部分]</h2><div class="ke l"><h3 class="bd b fj z dz kc eb ec kd ee eg dy translated">首先让我们把这个拿出来。GraphQl 是什么？三言两语大概是这样的:</h3></div><div class="kf l"><p class="bd b fq z dz kc eb ec kd ee eg dy translated">medium.com</p></div></div><div class="kg l"><div class="kh l ki kj kk kg kl ip jx"/></div></div></a></div><p id="f5b3" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">要开始使用 Socialite，请使用 Composer 包管理器将包添加到项目的依赖项中:</p><pre class="km kn ko kp fe kq kr ks kt aw ku bi"><span id="3bcd" class="kv kw hj kr b fj kx ky l kz la">composer require laravel/socialite</span></pre><p id="6047" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">在 providers 中注入 socialite 类，在<strong class="iy hk"> config/app.php </strong>文件中别名数组。</p><pre class="km kn ko kp fe kq kr ks kt aw ku bi"><span id="0fa0" class="kv kw hj kr b fj kx ky l kz la">....<br/>....<br/>'providers' =&gt; [<br/>    ....<br/>    ....<br/>    Laravel\Socialite\SocialiteServiceProvider::class,<br/>],</span><span id="4d7b" class="kv kw hj kr b fj lb ky l kz la">'aliases' =&gt; [<br/>    ....<br/>    ....<br/>    'Socialite' =&gt; Laravel\Socialite\Facades\Socialite::class,<br/>],<br/>....<br/>....</span></pre><h1 id="36a8" class="lc kw hj bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">迁移用户身份验证表中的脸书 ID</h1><p id="db38" class="pw-post-body-paragraph iw ix hj iy b iz lz jb jc jd ma jf jg jh mb jj jk jl mc jn jo jp md jr js jt hc bi translated">要在 Laravel 应用程序中使用脸书登录，您的 Users 表必须有一个 facebook_id，所以通过运行下面的命令添加它。</p><pre class="km kn ko kp fe kq kr ks kt aw ku bi"><span id="42c2" class="kv kw hj kr b fj kx ky l kz la">php artisan make:migration add_facebook_id_column_in_users_table --table=users</span></pre><p id="e37c" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">打开<strong class="iy hk">timestamp _ add _ Facebook _ id _ column _ in _ users _ table . PHP</strong>，将以下代码放入其中。</p><pre class="km kn ko kp fe kq kr ks kt aw ku bi"><span id="6d2c" class="kv kw hj kr b fj kx ky l kz la">/**<br/>     * Run the migrations.<br/>     *<br/>     * @return void<br/>     */<br/>    public function up()<br/>    {<br/>        Schema::table('users', function (Blueprint $table) {<br/>            <!-- -->$table-&gt;string(<strong class="kr hk">'facebook_id'</strong>)-&gt;<strong class="kr hk">unique</strong>()-&gt;<strong class="kr hk">nullable</strong>();<br/>        });<br/>    }<br/><br/>    /**<br/>     * Reverse the migrations.<br/>     *<br/>     * @return void<br/>     */<br/>    public function down()<br/>    {<br/>        Schema::table('users', function (Blueprint $table) {<br/>            $table-&gt;dropColumn('facebook_id');<br/>        });<br/>    }</span></pre><h1 id="05a9" class="lc kw hj bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">注册脸书应用 ID 和密码</h1><p id="919c" class="pw-post-body-paragraph iw ix hj iy b iz lz jb jc jd ma jf jg jh mb jj jk jl mc jn jo jp md jr js jt hc bi translated">接下来，访问<a class="ae iv" href="https://developers.facebook.com/apps" rel="noopener ugc nofollow" target="_blank">developers.facebook.com/apps</a>工具，创建脸书应用 id 和密码，然后在<strong class="iy hk">配置/服务</strong>文件中注册 id 和密码。</p><pre class="km kn ko kp fe kq kr ks kt aw ku bi"><span id="e75e" class="kv kw hj kr b fj kx ky l kz la">return [<br/>    ....<br/>    'facebook' =&gt; [<br/>        'client_id' =&gt; 'App id goes here',<br/>        'client_secret' =&gt; 'Secret goes herre',<br/>        'redirect' =&gt; 'http://localhost:8000/auth/facebook/callback',<br/>    ],<br/>]</span></pre><p id="6d87" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">在我们完成应用程序的配置和迁移后，我们将创建用于脸书认证的突变。</p><p id="140e" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我想到的第一个变化是将在前端显示的重定向链接的生成，从我的角度来看，该变化看起来像这样:</p><figure class="km kn ko kp fe ik"><div class="bz dz l di"><div class="me mf l"/></div></figure><p id="d293" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">为了实现我们的目标，我们需要覆盖一些来自社交网站核心的类，这样我们才能获得重定向 url。我们需要这样做，因为我们需要访问的方法是受保护的，我们不能访问它。我采用的解决方案是这样的:</p><figure class="km kn ko kp fe ik"><div class="bz dz l di"><div class="me mf l"/></div></figure><p id="a556" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我们的突变类会是这样的:</p><figure class="km kn ko kp fe ik"><div class="bz dz l di"><div class="me mf l"/></div></figure><p id="db49" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">现在让我们来测试一下:</p><figure class="km kn ko kp fe ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et mg"><img src="../Images/f60ee35f23147e00511640bacdf27a72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*16UOTA5mQrbGEaA2cmjhxg.png"/></div></div></figure><p id="8724" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">在您访问该链接后，您将被重定向到脸书以批准所请求的信息，如果一切顺利，您将被重定向回我们的申请。重定向链接将类似于:</p><pre class="km kn ko kp fe kq kr ks kt aw ku bi"><span id="65e9" class="kv kw hj kr b fj kx ky l kz la"><a class="ae iv" href="https://314eea898cd5.ngrok.io/auth/facebook/callback?code=AQDHpfVI_OL6LKj2ypb1h3239hIRM2R6oiAPvo2ozdlLvOPzGwCm7sxLWPuJAIZPIdYBSXSqxA5Z-uE8IVOGPgdlsZvm40yPoRzIXVAqqViLqqhdF-G3v5O5DzgiJiZwgi4coRA7Pu5gg88T1pBawZ3gyfwxL-YBI2Q5LWqlExMZ4sAjyVzZxwpX6_AwuzmIUoD3x7GHh3fWh1cgeztpnfOpsfydhjTew5Kxqc_EYzv4I-DgwqQBkC5owUra30N1Fvm6QOzzWF4GSx6H44xCRBkS14zeCyWntbIbQ7l-Kc5uh0caR35NAxwSnMoKXCe9kQk#_=_" rel="noopener ugc nofollow" target="_blank">https://314eea898cd5.ngrok.io/auth/facebook/callback?code=AQDHpfVI_OL6LKj2ypb1h3239hIRM2R6oiAPvo2ozdlLvOPzGwCm7sxLWPuJAIZPIdYBSXSqxA5Z-uE8IVOGPgdlsZvm40yPoRzIXVAqqViLqqhdF-G3v5O5DzgiJiZwgi4coRA7Pu5gg88T1pBawZ3gyfwxL-YBI2Q5LWqlExMZ4sAjyVzZxwpX6_AwuzmIUoD3x7GHh3fWh1cgeztpnfOpsfydhjTew5Kxqc_EYzv4I-DgwqQBkC5owUra30N1Fvm6QOzzWF4GSx6H44xCRBkS14zeCyWntbIbQ7l-Kc5uh0caR35NAxwSnMoKXCe9kQk#_=_</a></span></pre><p id="b1c3" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我们例子中的回调将由前端框架(next.js，nuxt.js …)处理。他们将使用脸书提供的代码调用一个突变，以获得访问令牌。</p><p id="4229" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">为了创建登录，我使用了<strong class="iy hk"> laravel/passport </strong>。我们在教程中使用的东西在下面的文章中有详细介绍:</p><div class="ju jv fa fc jw jx"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/build-a-forum-with-graphql-powered-api-in-laravel-part-2-auth-ede9b57a3cf0"><div class="jy ab dx"><div class="jz ab ka cl cj kb"><h2 class="bd hk fj z dz kc eb ec kd ee eg hi bi translated">在 Laravel 中用 GraphQL 驱动的 API 构建一个论坛—[第 2 部分] Auth</h2><div class="ke l"><h3 class="bd b fj z dz kc eb ec kd ee eg dy translated">在这一部分中，我们将讨论用户的认证。为此，我们将使用 Laravel 护照。运行…</h3></div><div class="kf l"><p class="bd b fq z dz kc eb ec kd ee eg dy translated">medium.com</p></div></div><div class="kg l"><div class="mh l ki kj kk kg kl ip jx"/></div></div></a></div><p id="9878" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我们将使用与普通用户登录相同的方法，只是我们需要为脸书创建一个新的授权类型，它将接受您将被重定向回的代码，通过该代码，我们可以获得用户数据。</p><p id="87a2" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">我们需要做的另一件事是创建另一个方法，该方法将接受<strong class="iy hk">代码</strong>作为参数，以便向脸书 API 发出请求，它看起来像这样:</p><pre class="km kn ko kp fe kq kr ks kt aw ku bi"><span id="ff7a" class="kv kw hj kr b fj kx ky l kz la"><strong class="kr hk">public function </strong>getUser(<strong class="kr hk">string </strong>$code): ?User<br/>{<br/>    <strong class="kr hk">if </strong>($this-&gt;<strong class="kr hk">user</strong>) {<br/>        <strong class="kr hk">return </strong>$this-&gt;<strong class="kr hk">user</strong>;<br/>    }<br/><br/>    $response = $this-&gt;getAccessTokenResponse($code);<br/><br/>    $this-&gt;<strong class="kr hk">user </strong>= $this-&gt;mapUserToObject($this-&gt;getUserByToken(<br/>        $token = Arr::<em class="mi">get</em>($response, <strong class="kr hk">'access_token'</strong>)<br/>    ));<br/><br/>    <strong class="kr hk">return </strong>$this-&gt;<strong class="kr hk">user</strong>-&gt;setToken($token)<br/>        -&gt;setRefreshToken(Arr::<em class="mi">get</em>($response, <strong class="kr hk">'refresh_token'</strong>))<br/>        -&gt;setExpiresIn(Arr::<em class="mi">get</em>($response, <strong class="kr hk">'expires_in'</strong>));<br/>}</span></pre><p id="76e7" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">下一步是为 facebook 创建新的授权类型。我所做的是看看<strong class="iy hk">通行证</strong>是如何制作的，并遵循几乎相同的步骤，你可以在这里找到它:</p><pre class="km kn ko kp fe kq kr ks kt aw ku bi"><span id="f22e" class="kv kw hj kr b fj kx ky l kz la">vendor/league/oauth2-server/src/Grant/PasswordGrant.php</span></pre><p id="6459" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">在我们的例子中，当函数<strong class="iy hk"> validateUser </strong>被调用时，我们向脸书发出请求，根据所提供的代码获取用户的详细信息，如果一切顺利，我们将创建该用户。最终代码如下所示:</p><figure class="km kn ko kp fe ik"><div class="bz dz l di"><div class="me mf l"/></div></figure><p id="1ad3" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">创建授权类型后，我们需要注册它，为此我们创建了一个服务提供者，它看起来像这样:</p><figure class="km kn ko kp fe ik"><div class="bz dz l di"><div class="me mf l"/></div></figure><p id="f360" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">剩下的工作就是创建变异，用脸书提供的代码处理登录。这种变异看起来与下面的类似:</p><pre class="km kn ko kp fe kq kr ks kt aw ku bi"><span id="b583" class="kv kw hj kr b fj kx ky l kz la"># AuthPayload response<br/>type AuthPayload {<br/>  # access token<br/>  access_token: String!</span><span id="590b" class="kv kw hj kr b fj lb ky l kz la"># refresh token<br/>  refresh_token: String!</span><span id="363f" class="kv kw hj kr b fj lb ky l kz la"># expires in<br/>  expires_in: Int!</span><span id="99db" class="kv kw hj kr b fj lb ky l kz la"># token type<br/>  token_type: String!</span><span id="0d58" class="kv kw hj kr b fj lb ky l kz la"># User profile<br/>  user: User!<br/>}</span><span id="0302" class="kv kw hj kr b fj lb ky l kz la">type Mutation {<br/><br/>  socialLogin(code: String!): AuthPayload<br/>}</span></pre><p id="b6c5" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">变异的代码看起来像这样:</p><figure class="km kn ko kp fe ik"><div class="bz dz l di"><div class="me mf l"/></div></figure><p id="bbb9" class="pw-post-body-paragraph iw ix hj iy b iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt hc bi translated">现在让我们来测试一下</p><figure class="km kn ko kp fe ik es et paragraph-image"><div role="button" tabindex="0" class="il im di in bf io"><div class="es et mj"><img src="../Images/50e0998d443e384eed9f2697683a1a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QGPAVpQQo7t3Ib5yFAObPQ.png"/></div></div></figure></div></div>    
</body>
</html>