<html>
<head>
<title>Referential Data Validations with yupjs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用yupjs验证引用数据</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/referential-data-validations-with-yupjs-98639bc04dd3?source=collection_archive---------27-----------------------#2021-05-23">https://medium.com/nerd-for-tech/referential-data-validations-with-yupjs-98639bc04dd3?source=collection_archive---------27-----------------------#2021-05-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c59acfb42afd681f789ff62a462ae633.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwL7W8i_iK_6Zgp4qNsqjA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">班加罗尔乌尔索尔湖。绍拉夫·萨胡在Unsplash上拍摄的照片</figcaption></figure><p id="0bc0" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">注意:这篇博客最初发布在我的个人网站上:<a class="ae js" href="https://mrsauravsahu.tech/posts/45/" rel="noopener ugc nofollow" target="_blank">用yupjs (mrsauravsahu.tech) </a>验证参考数据</p><h1 id="92ce" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">什么是数据验证？</h1><p id="4fff" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">数据验证是根据业务需求检查给定值是否符合特定标准的过程。</p><p id="69fa" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">对于任何输入——UI输入字段或API输入主体，数据验证都是至关重要的。任何随意的输入都不应该被信任。数据验证在确保这些输入在我们的应用程序中产生意想不到的副作用之前严格地通过正确的管道中发挥着至关重要的作用。</p><h1 id="2121" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">JavaScript世界中的数据验证</h1><p id="89e6" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在JavaScript项目中，浏览器和node.js，也就是说，有几个npm包可用于进行数据验证。我个人用过joi和yupjs。</p><p id="7f5c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">joi是我长期以来进行数据验证的首选。它与hapijs合作得非常好，并且有一个很好的社区围绕着它。相信我，我对joi没有任何意见，只是我觉得和yupjs一起工作更容易。</p><p id="c71a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">yupjs也是一个数据验证库，它从joi获得了很多特性，但更侧重于客户端验证，并且可以很容易地扩展。</p><h1 id="408d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">数据验证的一个例子</h1><p id="d944" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">对传入的“数据传输对象”的每个属性进行数据验证。只是一种奇特的方式🎓也就是说，从原始输入中创建一个对象，并在实际存储或用于应用程序的其他地方之前进行清理和处理。</p><p id="0a60" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们以一个简单的注册页面为例。我们将有两个输入，DTO将具有如下所示的形状:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="991c" class="lf ju hi lb b fi lg lh l li lj">type SignUpDto = {<br/>  userName: string | undefined,<br/>  password: string | undefined<br/>}</span></pre><p id="364a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这里的简单数据验证是:</p><ul class=""><li id="5462" class="lk ll hi iw b ix iy jb jc jf lm jj ln jn lo jr lp lq lr ls bi translated">用户名和密码字段是必需的</li><li id="f43d" class="lk ll hi iw b ix lt jb lu jf lv jj lw jn lx jr lp lq lr ls bi translated">用户名的最大长度应为12</li><li id="682c" class="lk ll hi iw b ix lt jb lu jf lv jj lw jn lx jr lp lq lr ls bi translated">密码的最小长度应为8</li></ul><p id="d470" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">等等。</p><h1 id="3965" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">输入yupjs</h1><p id="5345" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">为了实现这一点，yupjs使用了一个称为模式的概念来进行验证。我相信你会发现yupjs库和joi非常相似，所以让我们来看看。用户名和密码的简单验证可以写成如下所示:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="494f" class="lf ju hi lb b fi lg lh l li lj">import * as yup from 'yup'</span><span id="c92c" class="lf ju hi lb b fi ly lh l li lj">type SignUpDto = {<br/>  userName: string | undefined,<br/>  password: string | undefined<br/>}</span><span id="7aaa" class="lf ju hi lb b fi ly lh l li lj">const signUpSchema = yup.object({<br/>  userName: yup<br/>    .string()<br/>    .required('please enter a username')<br/>    .max(12),<br/>  password: yup<br/>    .string()<br/>    .required('please enter a password')<br/>    .min(8)<br/>})</span></pre><p id="52b4" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如您所见，您还可以为每个验证定义定制错误消息。现在这个<code class="du lz ma mb lb b">signUpSchema</code>实际上可以用来对数据进行验证，如下所示:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="568d" class="lf ju hi lb b fi lg lh l li lj">const signUp: SignUpDto = {<br/>  userName: 'sample',<br/>  password: undefined<br/>}</span><span id="593a" class="lf ju hi lb b fi ly lh l li lj">signUpSchema.validate(signUp, { abortEarly: false })<br/>  .then(console.log)<br/>  .catch(console.error)</span><span id="523d" class="lf ju hi lb b fi ly lh l li lj">&gt;<br/>ValidationError: please enter a password<br/>    at finishTestRun (.../node_modules/yup/lib/util/runTests.js:63:20)<br/>    at .../node_modules/yup/lib/util/runTests.js:17:5<br/>    at finishTestRun (.../node_modules/yup/lib/util/runTests.js:67:9)<br/>    at .../node_modules/yup/lib/util/createValidation.js:72:127 {<br/>  value: { userName: 'mrsauravsahu', password: undefined },<br/>  path: undefined,<br/>  type: undefined,<br/>  errors: [ 'please enter a password' ],<br/>  inner: [<br/>    ValidationError: please enter a password<br/>        at createError (/Users/sauravsahu/Documents/personal/code/yuppers/node_modules/yup/lib/util/createValidation.js:54:21)<br/>        at /Users/sauravsahu/Documents/personal/code/yuppers/node_modules/yup/lib/util/createValidation.js:72:107 {<br/>      value: undefined,<br/>      path: 'password',<br/>      type: 'required',<br/>      errors: [Array],<br/>      inner: [],<br/>      params: [Object]<br/>    }<br/>  ]<br/>}</span></pre><p id="564a" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">正如我们所看到的，我们得到了关于为什么在<code class="du lz ma mb lb b">inner</code>属性中验证失败的详细解释。我映射了<code class="du lz ma mb lb b">inner</code>属性，只保留了路径和值字段——这足以让我的前端应用程序理解要显示什么本地化的消息。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="dbd8" class="lf ju hi lb b fi lg lh l li lj">signUpSchema.validate(signUp, { abortEarly: false })<br/>  .then(console.log)<br/>  .catch(err =&gt; {<br/>    var validationErrors = err.inner.map((error: any) =&gt; ({ type: error.type, path: error.path }))<br/>    console.error(JSON.stringify(validationErrors, undefined, 2))<br/>  })</span><span id="ade3" class="lf ju hi lb b fi ly lh l li lj">&gt;<br/>[<br/>  {<br/>    "type": "required",<br/>    "path": "password"<br/>  }<br/>]</span></pre><p id="793e" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这很好，yupjs支持许多不同类型的开箱即用的验证，这里列出了— <a class="ae js" href="https://github.com/jquense/yup#api" rel="noopener ugc nofollow" target="_blank"> yupjs API </a></p><h1 id="6cd3" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">什么是引用验证？</h1><p id="9b1e" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">与某些仅依赖于属性的一个键的验证规则不同，更复杂的验证也可以引用其他属性。yupjs允许我们用<code class="du lz ma mb lb b">test</code>方法引用DTO的其他属性。</p><p id="0d8f" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在我们的例子中，假设我们想要确保密码不包含字符串形式的用户名，也就是说，如果用户名是<code class="du lz ma mb lb b">sample</code>，密码就不能是<code class="du lz ma mb lb b">123saMplE456</code>，因为单词<code class="du lz ma mb lb b">sample</code>出现在密码中。</p><p id="c1dc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">为了验证这个密码，我们还需要参考用户名字段。我们可以用yupjs的<code class="du lz ma mb lb b">test</code>方法来写这个。让我们修改我们的模式，如下所示。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="d226" class="lf ju hi lb b fi lg lh l li lj">const signUpSchema = yup.object({<br/>   userName: yup<br/>     .string()<br/>     .required('please enter a username')<br/>     .max(12),<br/>   password: yup<br/>     .string()<br/>     .required('please enter a password')<br/>     .min(8)<br/>+    .test('contains-username', (password, context) =&gt; {<br/>+      const { userName } = context.parent;<br/>+      const userNameString = userName ?? '';<br/>+      const containsUserName = (password ?? '').toLowerCase().includes(userNameString.toLowerCase())<br/>+<br/>+      return !containsUserName<br/>+    })<br/> })</span></pre><p id="8a9c" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">正如你所看到的，我添加了缺省值和零合并操作符，比如<code class="du lz ma mb lb b">userName</code>和<code class="du lz ma mb lb b">password</code>可能是falsey。</p><p id="c816" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，如果我们尝试验证我们的示例用户，我们会得到这个验证错误，这正是我们想要的。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="ff74" class="lf ju hi lb b fi lg lh l li lj">[<br/>  {<br/>    "type": "contains-username",<br/>    "path": "password"<br/> }<br/>]</span></pre><p id="a1da" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">对于<code class="du lz ma mb lb b">test</code>方法，第一个参数是验证的名称，对我们来说，它是<code class="du lz ma mb lb b">contains-username</code>，第二个方法是实际的测试函数，它获得当前值和验证的上下文，我们可以用这个上下文选择<code class="du lz ma mb lb b">userName</code>。</p><h1 id="a0d7" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">结论</h1><p id="940f" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">yupjs是一个非常通用的数据验证库。它既可以在浏览器中使用，也可以在node.js中使用。引用验证轻而易举，这些方法也可以很容易地进行单元测试。</p><p id="475d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">yupjs还包含将对象从一种形状转换为另一种形状的转换方法。我目前正在<a class="ae js" href="https://github.com/daily-vocab/daily-vocab" rel="noopener ugc nofollow" target="_blank">每日语音应用</a>上享受睡衣</p><p id="ddfe" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">祝你愉快！继续编码。</p><p id="ba43" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">- <a class="ae js" href="https://poly.work/mrsauravsahu" rel="noopener ugc nofollow" target="_blank"> mrsauravsahu </a></p></div></div>    
</body>
</html>