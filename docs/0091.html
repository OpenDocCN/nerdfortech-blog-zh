<html>
<head>
<title>Home DevOps Pipeline: A junior engineer’s tale (3/4)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">家庭开发管道:一个初级工程师的故事(3/4)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/home-devops-pipeline-a-junior-engineers-tale-3-4-5f61c5245934?source=collection_archive---------2-----------------------#2020-02-12">https://medium.com/nerd-for-tech/home-devops-pipeline-a-junior-engineers-tale-3-4-5f61c5245934?source=collection_archive---------2-----------------------#2020-02-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="217a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">内容:</em> <a class="ae je" rel="noopener" href="/@t3chflicks/home-devops-pipeline-a-junior-engineers-tale-1-4-336ed07a6ec0"> <em class="jd"> 1 </em> </a> <em class="jd">，</em> <a class="ae je" rel="noopener" href="/@t3chflicks/home-devops-pipeline-a-junior-engineers-tale-2-4-7be3e3c292c"> <em class="jd"> 2 </em> </a> <em class="jd">，(</em> <a class="ae je" rel="noopener" href="/@t3chflicks/home-devops-pipeline-a-junior-engineers-tale-3-4-5f61c5245934"> <em class="jd"> 3 </em> </a> <em class="jd">)，</em> <a class="ae je" rel="noopener" href="/@t3chflicks/home-devops-pipeline-a-junior-engineers-tale-4-4-5db7c1610e3e"> <em class="jd"> 4 </em> </a></p><p id="3006" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这一系列文章中，我将解释我是如何使用几个 Raspberry Pis 和许多软件构建自己的家庭开发环境的。在本文中，我将介绍管道的部署部分。</p><blockquote class="jf"><p id="aa62" class="jg jh hi bd ji jj jk jl jm jn jo jc dx translated"><a class="ae je" href="https://github.com/sk-t3ch/home-repo" rel="noopener ugc nofollow" target="_blank">🔗在 Github 上获取 Home DevOps 管道代码📔</a></p></blockquote><h1 id="b76d" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">部署</h1><h2 id="f553" class="kn jq hi bd jr ko kp kq jv kr ks kt jz iq ku kv kd iu kw kx kh iy ky kz kl la bi translated">Ansible</h2><p id="da9e" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">关于 Drone 的另一个伟大的事情是可用的插件<a class="ae je" href="http://plugins.drone.io" rel="noopener ugc nofollow" target="_blank">——我们将使用</a><a class="ae je" href="https://docs.ansible.com/ansible/latest/user_guide/basic_concepts.html" rel="noopener ugc nofollow" target="_blank"> Ansible </a>插件作为在多台机器上运行 ssh 命令的工具。我们也将利用<a class="ae je" href="https://docs.drone.io/secret/repository/" rel="noopener ugc nofollow" target="_blank">无人机机密</a>作为安全部署某些配置值的方法。</p><p id="702e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我见过的一般部署方法通常包括发布到 AWS，然后神奇的事情发生了，使用云形成模板，你的栈就创建好了。</p><p id="a00b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，我们希望在房屋回购中保留房屋。为此，我们希望部署到本地网络上的特定机器上。对我来说，这是一个负载的其他 Raspberry Pis 可以做很多事情，从控制我的 3D 打印机，到作为 CCTV 摄像机的网络工作。</p><p id="37a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，我们将像这样使用 Ansible:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="914c" class="kn jq hi ll b fi lp lq l lr ls">kind: pipeline<br/>name: commitPipeline</span><span id="c880" class="kn jq hi ll b fi lt lq l lr ls">trigger:<br/>  event:<br/>     - push</span><span id="275b" class="kn jq hi ll b fi lt lq l lr ls">platform:<br/>  os: linux<br/>  arch: arm</span><span id="e993" class="kn jq hi ll b fi lt lq l lr ls">steps:<br/>  - name: trigger-rebuild-of-image<br/>    image: plugins/ansible:1<br/>    environment:<br/>      repo_username:<br/>        from_secret: repo_username<br/>      repo_password:<br/>        from_secret: repo_password<br/>    settings:<br/>      private_key:<br/>        from_secret: ansible_private_key<br/>      playbook: ansible/playbook.yml<br/>      inventory: ansible/inventory.yml</span></pre><p id="7be8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Ansible 执行的动作在<code class="du lu lv lw ll b">playbook.yml</code>中找到，我们想要在其上执行的机器在<code class="du lu lv lw ll b">inventory.yml</code>中描述:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="e0f2" class="kn jq hi ll b fi lp lq l lr ls"># playbook.yml<br/>- hosts: cameras</span><span id="e450" class="kn jq hi ll b fi lt lq l lr ls">tasks:</span><span id="e7c6" class="kn jq hi ll b fi lt lq l lr ls">- name: .ssh directory<br/>  file:<br/>    path: ~/.ssh<br/>    owner: pi<br/>    group: pi<br/>    state: directory</span><span id="6742" class="kn jq hi ll b fi lt lq l lr ls">- name: put key in<br/>  copy:<br/>    content: "{{ lookup('env','ansible_private_key') }}"<br/>    dest: ~/.ssh/deploy_key<br/>    owner: pi<br/>    group: pi<br/>    mode: 0600<br/>    become: pi</span><span id="7657" class="kn jq hi ll b fi lt lq l lr ls">- name: clone the repo<br/>  git:  <br/>    repo: ssh://git@git.&lt;domain&gt;/&lt;username&gt;/cctv.git<br/>    dest: /home/pi/cctv<br/>    key_file: ~/.ssh/deploy_key<br/>    accept_hostkey: yes<br/>    force: yes</span><span id="13ed" class="kn jq hi ll b fi lt lq l lr ls">- name: Rebuild docker image<br/>   shell:<br/>   cmd: docker-compose up --remove-orphans --force-recreate --build -d<br/>  chdir: /home/pi/cctv</span><span id="2712" class="kn jq hi ll b fi lt lq l lr ls">- name: remove private key<br/>   shell:<br/>   cmd: rm ~/.ssh/deploy_key</span></pre><p id="ca29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="1471" class="kn jq hi ll b fi lp lq l lr ls"># invetory.yml<br/>all:<br/>  hosts:<br/>    drone.&lt;domain&gt;:<br/>  children:<br/>    cameras:<br/>      hosts:<br/>        192.168.0.41:<br/>        192.168.0.42:<br/>      vars:<br/>        ansible_ssh_user: pi</span></pre><p id="4d03" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢 ansible，我的 CCTV 摄像机更新部署流程大大简化了。</p><figure class="lg lh li lj fd lx"><div class="bz dy l di"><div class="ly lz l"/></div></figure><h2 id="d722" class="kn jq hi bd jr ko kp kq jv kr ks kt jz iq ku kv kd iu kw kx kh iy ky kz kl la bi translated">部署到 AWS</h2><p id="f61e" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">在家部署很有趣，也很棒，但训练轮必须脱落。现实世界中的开发涉及到云，在我工作的公司，这意味着 AWS。</p><p id="f5a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将您的服务部署到 AWS EC2 机器也应该有一个测试步骤，但是最常见的架构(x86)与 Raspberry Pi 上的 arm 架构非常不同。如果我们的构建将被部署到 x86 机器上，我们不应该使用 arm 机器来测试它们。我们必须部署 x86 无人驾驶飞机。</p><p id="6f42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，情节再次扭曲，为了使用我们的环境部署无人机 x86 runner，我们需要使用仅针对 x86 而非 arm 构建的无人机/云编队映像。但是我们可以自己重建它，就像我在我的<a class="ae je" href="https://github.com/sk-t3ch/home-repo" rel="noopener ugc nofollow" target="_blank">代码</a>中展示的那样。像一个好孩子一样，我也在 dockerhub 上发布了<a class="ae je" href="https://hub.docker.com/r/t3chflicks/aws-cfn" rel="noopener ugc nofollow" target="_blank">的图片</a>供他人使用。</p><figure class="lg lh li lj fd lx er es paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="er es ma"><img src="../Images/ab88159faa978001759e62fc3a23a987.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MvIcm-Vt6cAwJ__y"/></div></div><figcaption class="mh mi et er es mj mk bd b be z dx translated">照片由<a class="ae je" href="https://unsplash.com/@waguluz_?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">安德里亚斯·瓦格纳</a>在<a class="ae je" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</figcaption></figure><p id="d94f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用它，我们现在可以像这样部署 AWS 机器:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="d0d5" class="kn jq hi ll b fi lp lq l lr ls">kind: pipeline<br/>name: commitPipeline</span><span id="76a4" class="kn jq hi ll b fi lt lq l lr ls">trigger:<br/>  event:<br/>    - push</span><span id="70d0" class="kn jq hi ll b fi lt lq l lr ls">platform:<br/>  os: linux<br/>  arch: arm</span><span id="8947" class="kn jq hi ll b fi lt lq l lr ls">steps:<br/>  - name: validate-seeder-infrastructure<br/>    image: registry.&lt;domain&gt;/aws-cfn<br/>    settings:<br/>      mode: validate<br/>      template: infrastructure.yml<br/>    environment:<br/>      AWS_ACCESS_KEY_ID:<br/>        from_secret: aws_id<br/>      AWS_SECRET_ACCESS_KEY:<br/>        from_secret: aws_key</span></pre><p id="bace" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署完成后，我们可以通过在. drone.yml 中指定架构或删除任何架构声明来运行 x86 构建，因为 x86 是默认的。</p><p id="072f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还在这里重建了一个 AWS-CLI 映像<a class="ae je" href="https://hub.docker.com/r/t3chflicks/aws-cli" rel="noopener ugc nofollow" target="_blank"/>。</p></div><div class="ab cl ml mm gp mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="hb hc hd he hf"><p id="fd7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经介绍了管道的部署部分，在本系列的下一篇文章中，我们将介绍监控方法并讨论一些问题。在这里查看<a class="ae je" rel="noopener" href="/@t3chflicks/home-devops-pipeline-a-junior-engineers-tale-4-4-5db7c1610e3e"/>。</p><p id="fbf4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">内容:</em> <a class="ae je" rel="noopener" href="/@t3chflicks/home-devops-pipeline-a-junior-engineers-tale-1-4-336ed07a6ec0"> <em class="jd"> 1 </em> </a> <em class="jd">，</em> <a class="ae je" rel="noopener" href="/@t3chflicks/home-devops-pipeline-a-junior-engineers-tale-2-4-7be3e3c292c"> <em class="jd"> 2 </em> </a> <em class="jd">，(</em> <a class="ae je" rel="noopener" href="/@t3chflicks/home-devops-pipeline-a-junior-engineers-tale-3-4-5f61c5245934"> <em class="jd"> 3 </em> </a> <em class="jd">)，</em> <a class="ae je" rel="noopener" href="/@t3chflicks/home-devops-pipeline-a-junior-engineers-tale-4-4-5db7c1610e3e"> <em class="jd"> 4 </em> </a></p><blockquote class="jf"><p id="e3de" class="jg jh hi bd ji jj jk jl jm jn jo jc dx translated"><a class="ae je" href="https://github.com/sk-t3ch/home-repo" rel="noopener ugc nofollow" target="_blank">🔗在 Github 上获取 Home DevOps 管道代码📔</a></p></blockquote><h1 id="2184" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">感谢阅读</h1><p id="83b2" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">我希望你喜欢这篇文章。如果你喜欢这种风格，可以去看看<a class="ae je" href="https://t3chflicks.org/Projects/home-devops-pipeline" rel="noopener ugc nofollow" target="_blank">T3chFlicks.org</a>了解更多专注于科技的教育内容(<a class="ae je" href="https://www.youtube.com/channel/UC0eSD-tdiJMI5GQTkMmZ-6w" rel="noopener ugc nofollow" target="_blank"> YouTube </a>、<a class="ae je" href="https://www.instagram.com/t3chflicks/" rel="noopener ugc nofollow" target="_blank"> Instagram </a>、<a class="ae je" href="https://www.facebook.com/t3chflicks" rel="noopener ugc nofollow" target="_blank">脸书</a>、<a class="ae je" href="https://twitter.com/t3chflicks" rel="noopener ugc nofollow" target="_blank"> Twitter </a>)。</p></div></div>    
</body>
</html>