<html>
<head>
<title>Maximising CI capacity in Azure DevOps Pipelines with self-hosted Docker agents for multiple workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助面向多个工作流的自托管 Docker 代理，最大化 Azure DevOps 管道中的 CI 容量</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/maximising-ci-capacity-in-azure-devops-pipelines-with-self-hosted-docker-agents-for-multiple-ae80b9b25074?source=collection_archive---------5-----------------------#2021-02-25">https://medium.com/nerd-for-tech/maximising-ci-capacity-in-azure-devops-pipelines-with-self-hosted-docker-agents-for-multiple-ae80b9b25074?source=collection_archive---------5-----------------------#2021-02-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="76ef" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你像我一样，在 Azure DevOps 中管理一个自托管代理池，并且发现你想要更多的容量，那么 Docker 可能是你的解决方案。通过在 Docker 中运行 Azure Pipelines 代理，您可以利用可用的资源，而无需引入新的虚拟机，也不会增加代理池的运行和维护成本。使用 Docker，您可以在一台机器上运行多个构建代理实例，并利用它来扩展您的 CI 容量。</p><h1 id="2a67" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">文档文件</h1><p id="579f" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">让我们快速浏览 docker 文件，最终<a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/Dockerfile" rel="noopener ugc nofollow" target="_blank">满足了我们所有的用例</a>。</p><h2 id="132a" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">基地</h2><p id="9930" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">最初的步骤使用转义字符“` ”,因为默认的“\”会干扰安装路径，这使事情变得简单了一些。我以 mcr.microsoft.com/dotnet/framework/runtime:4.8 的<a class="ae kn" href="https://hub.docker.com/_/microsoft-dotnet-framework-runtime" rel="noopener ugc nofollow" target="_blank">和</a>为基础图片。我已经测试了各种其他基础映像，例如<a class="ae kn" href="https://hub.docker.com/_/microsoft-windows-servercore" rel="noopener ugc nofollow" target="_blank"> windows-servercore </a>、<a class="ae kn" href="https://hub.docker.com/_/microsoft-windows-nanoserver" rel="noopener ugc nofollow" target="_blank"> windows-nanoserver </a>和<a class="ae kn" href="https://hub.docker.com/_/microsoft-dotnet" rel="noopener ugc nofollow" target="_blank"> dotnet </a>映像，但所有这些都缺少一些工具或功能。另一个潜在的基础映像是<a class="ae kn" href="https://hub.docker.com/_/microsoft-dotnet-framework-sdk/" rel="noopener ugc nofollow" target="_blank">mcr.microsoft.com/dotnet/framework/sdk:4.8</a>映像，它附带安装了 Visual Studio 2019 构建工具&amp;测试工具，但没有附带 SQL Server 数据工具，这为我排除了它。自己安装 Visual Studio 比尝试修补已经安装的程序要容易得多。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="b506" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您使用<a class="ae kn" href="https://hub.docker.com/_/microsoft-dotnet-framework-sdk/" rel="noopener ugc nofollow" target="_blank">mcr.microsoft.com/dotnet/framework/sdk:4.8</a>作为您的基本映像，您可以跳过这段代码中安装 Visual Studio 构建工具以及 Visual Studio 工具代理的部分。<a class="ae kn" href="https://docs.microsoft.com/en-us/visualstudio/install/workload-component-id-vs-build-tools?view=vs-2019" rel="noopener ugc nofollow" target="_blank">你可以在微软的文档</a>中阅读更多关于各种 Visual Studio 工作流和组件的信息。</p><h2 id="6417" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">饭桶</h2><p id="5287" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">接下来我需要安装 Git。我选择使用 MinGit 安装。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="eb7d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">MinGit 带来了一个有趣的问题，默认的<code class="du lj lk ll lm b">gitconfig</code>文件有一个指向自身的无限循环，所以我简单地下载了那个文件并删除了循环，将它复制到我的 Docker 映像中并覆盖了默认文件。你可以在 GitLab 上阅读更多关于这个问题<a class="ae kn" href="https://gitlab.com/gitlab-org/gitlab/-/issues/239013#note_400463268" rel="noopener ugc nofollow" target="_blank">的报道。我的<code class="du lj lk ll lm b">gitconfig</code>文件是 GitHub </a>上的<a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/gitconfig" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="307b" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">NodeJS</h2><p id="e94d" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">接下来我需要安装 NodeJS。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="e6e5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我需要支持新的和遗留的节点模块，并且发现 NodeJS 10.x 的最新版本已经足够了。如果您不需要支持遗留系统，我强烈建议您使用 NodeJS 的最新稳定版本。</p><h2 id="7fc8" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">Java 语言(一种计算机语言，尤用于创建网站)</h2><p id="f964" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">为了支持 Java 构建，以及管道中的各种静态分析工具，Java JDK 和 JRE 都是必要的。令人欣慰的是，开放的 JDK 和开放的 JRE 是现成的，易于安装。但是，有必要设置这两个环境变量并更新路径以引用安装。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><h2 id="aa26" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">努格特</h2><p id="e95c" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">安装 NuGet.exe 并将其作为路径的一部分对于设置为运行的代理非常有用。NET 构建，尽管这不是完全必要的，因为有管道任务来安装可以添加到<code class="du lj lk ll lm b">azure-pipelines.yml</code>中的 NuGet。将 NuGet 直接安装到代理上的主要好处是，您可以使用 docker 文件中的<code class="du lj lk ll lm b">nuget</code> CLI 来验证您可能拥有的任何私有提要。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><h2 id="b034" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">码头工人</h2><p id="a3a3" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">下一步假设在启动容器时，主机的 Docker 安装被安装到正在运行的容器中。这允许各种构建过程在管道中运行 Docker 任务。如果主机的 Docker 安装没有安装到运行容器中，当从 Azure DevOps 查看 Docker 代理时，运行 Docker 的功能将完全不存在。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><h2 id="abb8" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">无头铬合金</h2><p id="710c" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">有必要在 Docker 代理中直接安装一个无头浏览器来运行 UI 测试。我选择用 Chocolatey 安装谷歌浏览器。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="70c8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">基本的 Windows 映像不再安装任何字体——然而，出于明显的原因，为了让 Chrome 工作，字体需要安装在操作系统上，这是<code class="du lj lk ll lm b"><a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/FontsToAdd.tar" rel="noopener ugc nofollow" target="_blank">FontsToAdd.tar</a></code>和<code class="du lj lk ll lm b"><a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/Add-Font.ps1" rel="noopener ugc nofollow" target="_blank">Add-Font.ps1</a></code>负责的。</p><h2 id="79aa" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">清理和设置入口点</h2><p id="7c75" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">最后一部分只是清理所有临时安装目录和文件，然后为正在运行的容器设置入口点。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="b894" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du lj lk ll lm b"><a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/start.ps1" rel="noopener ugc nofollow" target="_blank">start.ps1</a></code>文件与微软提供的<a class="ae kn" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops#create-and-build-the-dockerfile" rel="noopener ugc nofollow" target="_blank">文件略有不同，Azure Pipelines 代理的安装和运行目录不再是<code class="du lj lk ll lm b">C:\azp\agent</code>而是<code class="du lj lk ll lm b">C:\agent</code>。</a></p><h2 id="a425" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">完整的文档</h2><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><h1 id="84f5" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Docker 中心图像</h1><p id="6142" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">如果你需要，你可以从<a class="ae kn" href="https://hub.docker.com/r/krylixza/azure-pipelines-windows-build-agent" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>拉 Docker 镜像。</p><pre class="lc ld le lf fd ln lm lo lp aw lq bi"><span id="c563" class="ko jl hi lm b fi lr ls l lt lu">docker pull krylixza/azure-pipelines-windows-build-agent:1.0.0.38</span></pre></div></div>    
</body>
</html>