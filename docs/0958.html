<html>
<head>
<title>Maximising CI capacity in Azure DevOps Pipelines with self-hosted Docker agents for multiple workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">借助面向多个工作流的自托管Docker代理，最大化Azure DevOps管道中的CI容量</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/maximising-ci-capacity-in-azure-devops-pipelines-with-self-hosted-docker-agents-for-multiple-ae80b9b25074?source=collection_archive---------5-----------------------#2021-02-25">https://medium.com/nerd-for-tech/maximising-ci-capacity-in-azure-devops-pipelines-with-self-hosted-docker-agents-for-multiple-ae80b9b25074?source=collection_archive---------5-----------------------#2021-02-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/></div><div class="ab cl if ig gp ih" role="separator"><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik il"/><span class="ii bw bk ij ik"/></div><div class="hb hc hd he hf"><p id="76ef" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你像我一样，在Azure DevOps中管理一个自托管代理池，并且发现你想要更多的容量，那么Docker可能是你的解决方案。通过在Docker中运行Azure Pipelines代理，您可以利用可用的资源，而无需引入新的虚拟机，也不会增加代理池的运行和维护成本。使用Docker，您可以在一台机器上运行多个构建代理实例，并利用它来扩展您的CI容量。</p><h1 id="2a67" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">文档文件</h1><p id="579f" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">让我们快速浏览docker文件，最终<a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/Dockerfile" rel="noopener ugc nofollow" target="_blank">满足了我们所有的用例</a>。</p><h2 id="132a" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">基地</h2><p id="9930" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">最初的步骤使用转义字符“` ”,因为默认的“\”会干扰安装路径，这使事情变得简单了一些。我以mcr.microsoft.com/dotnet/framework/runtime:4.8的<a class="ae kn" href="https://hub.docker.com/_/microsoft-dotnet-framework-runtime" rel="noopener ugc nofollow" target="_blank">和</a>为基础图片。我已经测试了各种其他基础映像，例如<a class="ae kn" href="https://hub.docker.com/_/microsoft-windows-servercore" rel="noopener ugc nofollow" target="_blank"> windows-servercore </a>、<a class="ae kn" href="https://hub.docker.com/_/microsoft-windows-nanoserver" rel="noopener ugc nofollow" target="_blank"> windows-nanoserver </a>和<a class="ae kn" href="https://hub.docker.com/_/microsoft-dotnet" rel="noopener ugc nofollow" target="_blank"> dotnet </a>映像，但所有这些都缺少一些工具或功能。另一个潜在的基础映像是<a class="ae kn" href="https://hub.docker.com/_/microsoft-dotnet-framework-sdk/" rel="noopener ugc nofollow" target="_blank">mcr.microsoft.com/dotnet/framework/sdk:4.8</a>映像，它附带安装了Visual Studio 2019构建工具&amp;测试工具，但没有附带SQL Server数据工具，这为我排除了它。自己安装Visual Studio比尝试修补已经安装的程序要容易得多。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="b506" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您使用<a class="ae kn" href="https://hub.docker.com/_/microsoft-dotnet-framework-sdk/" rel="noopener ugc nofollow" target="_blank">mcr.microsoft.com/dotnet/framework/sdk:4.8</a>作为您的基本映像，您可以跳过这段代码中安装Visual Studio构建工具以及Visual Studio工具代理的部分。<a class="ae kn" href="https://docs.microsoft.com/en-us/visualstudio/install/workload-component-id-vs-build-tools?view=vs-2019" rel="noopener ugc nofollow" target="_blank">你可以在微软的文档</a>中阅读更多关于各种Visual Studio工作流和组件的信息。</p><h2 id="6417" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">饭桶</h2><p id="5287" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">接下来我需要安装Git。我选择使用MinGit安装。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="eb7d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">MinGit带来了一个有趣的问题，默认的<code class="du lj lk ll lm b">gitconfig</code>文件有一个指向自身的无限循环，所以我简单地下载了那个文件并删除了循环，将它复制到我的Docker映像中并覆盖了默认文件。你可以在GitLab 上阅读更多关于这个问题<a class="ae kn" href="https://gitlab.com/gitlab-org/gitlab/-/issues/239013#note_400463268" rel="noopener ugc nofollow" target="_blank">的报道。我的<code class="du lj lk ll lm b">gitconfig</code>文件是GitHub </a>上的<a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/gitconfig" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="307b" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">NodeJS</h2><p id="e94d" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">接下来我需要安装NodeJS。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="e6e5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我需要支持新的和遗留的节点模块，并且发现NodeJS 10.x的最新版本已经足够了。如果您不需要支持遗留系统，我强烈建议您使用NodeJS的最新稳定版本。</p><h2 id="7fc8" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">Java 语言(一种计算机语言，尤用于创建网站)</h2><p id="f964" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">为了支持Java构建，以及管道中的各种静态分析工具，Java JDK和JRE都是必要的。令人欣慰的是，开放的JDK和开放的JRE是现成的，易于安装。但是，有必要设置这两个环境变量并更新路径以引用安装。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><h2 id="aa26" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">努格特</h2><p id="e95c" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">安装NuGet.exe并将其作为路径的一部分对于设置为运行的代理非常有用。NET构建，尽管这不是完全必要的，因为有管道任务来安装可以添加到<code class="du lj lk ll lm b">azure-pipelines.yml</code>中的NuGet。将NuGet直接安装到代理上的主要好处是，您可以使用docker文件中的<code class="du lj lk ll lm b">nuget</code> CLI来验证您可能拥有的任何私有提要。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><h2 id="b034" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">码头工人</h2><p id="a3a3" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">下一步假设在启动容器时，主机的Docker安装被安装到正在运行的容器中。这允许各种构建过程在管道中运行Docker任务。如果主机的Docker安装没有安装到运行容器中，当从Azure DevOps查看Docker代理时，运行Docker的功能将完全不存在。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><h2 id="abb8" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">无头铬合金</h2><p id="710c" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">有必要在Docker代理中直接安装一个无头浏览器来运行UI测试。我选择用Chocolatey安装谷歌浏览器。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="70c8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">基本的Windows映像不再安装任何字体——然而，出于明显的原因，为了让Chrome工作，字体需要安装在操作系统上，这是<code class="du lj lk ll lm b"><a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/FontsToAdd.tar" rel="noopener ugc nofollow" target="_blank">FontsToAdd.tar</a></code>和<code class="du lj lk ll lm b"><a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/Add-Font.ps1" rel="noopener ugc nofollow" target="_blank">Add-Font.ps1</a></code>负责的。</p><h2 id="79aa" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">清理和设置入口点</h2><p id="7c75" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">最后一部分只是清理所有临时安装目录和文件，然后为正在运行的容器设置入口点。</p><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="b894" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du lj lk ll lm b"><a class="ae kn" href="https://github.com/KrylixZA/Azure-Pipelines-Docker-Agents/blob/main/build-agent/windows/start.ps1" rel="noopener ugc nofollow" target="_blank">start.ps1</a></code>文件与微软提供的<a class="ae kn" href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops#create-and-build-the-dockerfile" rel="noopener ugc nofollow" target="_blank">文件略有不同，Azure Pipelines代理的安装和运行目录不再是<code class="du lj lk ll lm b">C:\azp\agent</code>而是<code class="du lj lk ll lm b">C:\agent</code>。</a></p><h2 id="a425" class="ko jl hi bd jm kp kq kr jq ks kt ku ju ix kv kw jy jb kx ky kc jf kz la kg lb bi translated">完整的文档</h2><figure class="lc ld le lf fd lg"><div class="bz dy l di"><div class="lh li l"/></div></figure><h1 id="84f5" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">Docker中心图像</h1><p id="6142" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">如果你需要，你可以从<a class="ae kn" href="https://hub.docker.com/r/krylixza/azure-pipelines-windows-build-agent" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>拉Docker镜像。</p><pre class="lc ld le lf fd ln lm lo lp aw lq bi"><span id="c563" class="ko jl hi lm b fi lr ls l lt lu">docker pull krylixza/azure-pipelines-windows-build-agent:1.0.0.38</span></pre></div></div>    
</body>
</html>