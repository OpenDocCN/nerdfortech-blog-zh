<html>
<head>
<title>Recursive DNS+AD-Blocker — Part 3: Installing Unbound with DNSSEC on Synology NAS with Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">递归DNS+广告拦截器—第3部分:用Docker在Synology NAS上安装未绑定的DNSSEC</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/recursive-dns-ad-blocker-part-3-installing-unbound-with-dnssec-on-synology-nas-with-docker-d40bb36035dc?source=collection_archive---------1-----------------------#2021-05-04">https://medium.com/nerd-for-tech/recursive-dns-ad-blocker-part-3-installing-unbound-with-dnssec-on-synology-nas-with-docker-d40bb36035dc?source=collection_archive---------1-----------------------#2021-05-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b295" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">安装启用了DNSSEC的SecNS Unbound非常容易，让我们看看如何将它配置为之前在本系列文章的第1部分中在Raspberry上配置的Unbound实例。</h2></div><h2 id="e775" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">介绍</h2><p id="e3e3" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">正如我们在<a class="ae ko" rel="noopener" href="/nerd-for-tech/recursive-dns-ad-blocker-part-2-installing-pi-hole-without-caching-on-synology-nas-with-docker-5363bc7258f4"> <strong class="jx hj">递归DNS+广告拦截器—第2部分:使用Docker </strong> </a>在Synology NAS上安装没有缓存的Pi-hole一样，为了拥有一个冗余的<em class="kp">Pi-hole+未绑定的</em>堆栈(详见<a class="ae ko" href="https://giannicostanzi.medium.com/recursive-dns-resolver-with-ad-blocking-features-dea766d4f703" rel="noopener"> <strong class="jx hj">具有广告拦截功能的递归DNS解析器</strong> </a> <strong class="jx hj"> ) </strong>在我的家庭网络中，我也将未绑定的服务器加倍，再次选择我的Synology NAS作为一个伟大的目标。</p><h2 id="95b9" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">选择正确的图像</h2><p id="863f" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">由于在第1部分<em class="kp">中</em>我们没有在Pi-hole中启用<em class="kp"> DNSSEC </em>验证，我们想在我们的递归DNS解析器中启用它。经过一段时间的挖掘和一些测试，我选择了由<em class="kp"> SecNS </em>提供的图像，即<a class="ae ko" href="https://hub.docker.com/r/secns/unbound" rel="noopener ugc nofollow" target="_blank"><strong class="jx hj"><em class="kp">SecNS/unbound</em></strong></a><em class="kp">。</em>该图像已经配置为启用DNSSEC验证，因此它符合我们的目的。</p><h2 id="4444" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">未绑定容器首次运行</h2><p id="5d5d" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">如<em class="kp"> Synology Docker </em>上<em class="kp"> Pi-hole </em>安装的<em class="kp">部分2 </em>所示，浏览注册表，搜索<em class="kp">secns/unbounded</em>并下载(拉取)该图像。</p><p id="1a14" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">在启动容器之前，我准备了以下文件夹，在File Station应用程序中创建它们:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="bab6" class="ix iy hi la b fi le lf l lg lh">/volume1/docker/unbound/usr_local_etc_unbound</span></pre><p id="3085" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">(我使用了<em class="kp"> usr_local_etc_unbound </em>，因为我将把其中包含的一些文件映射到容器内的<em class="kp"> /usr/local/etc/unbound </em>文件夹中。可以选择最符合自己口味的命名约定)。</p><p id="19dc" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">我建议您启动映像并创建一个新的容器，而不设置卷和网络映射，只是为了检索一些文件。假设您创建了一个名为<em class="kp"> secns-unbound1 </em>的容器，那么您可以使用以下命令从Synology NAS的CLI(作为root)中检索主配置文件/<em class="kp">usr/local/etc/unbound/unbound . conf</em>:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="0dde" class="ix iy hi la b fi le lf l lg lh">docker cp secns-unbound1:/<em class="kp">usr/local/etc/unbound/unbound.conf /volume1/docker/unbound/usr_local_etc_unbound/</em></span></pre><p id="ac2d" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">如果你不想以root用户的身份使用CLI，你可以在容器内的临时路径<em class="kp"> /mnt </em>上挂载<em class="kp">/volume 1/docker/unbound/usr _ local _ etc _ unbound/</em>。然后你可以双击Synology Docker应用程序中的容器，点击Terminal选项卡，然后创建一个新的<em class="kp"> bash </em>会话。在该会话中，您可以运行以下命令来完成与使用<em class="kp"> docker cp </em>相同的任务:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="18e3" class="ix iy hi la b fi le lf l lg lh">cp /<em class="kp">usr/local/etc/unbound/unbound.conf /mnt</em></span></pre><figure class="kv kw kx ky fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es li"><img src="../Images/91b56c3569eebe4b7f05fafebbc698cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QwFRFiGlUmpxGEwno0DiyA.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">mount/volume 1/unbound/usr _ local _ etc _ unbound到容器的/mnt文件夹</figcaption></figure><figure class="kv kw kx ky fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es lu"><img src="../Images/becc92024241717b96771034ab2aa90a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Qq3sicaJUYuLrDzeeaXDg.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">将容器的unbound.conf复制到/mnt(即/volume 1/docker/unbound/usr _ local _ etc _ unbound)</figcaption></figure><p id="0bbf" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">现在，您可以定制<em class="kp"> unbound.conf </em>文件，稍后我们将以只读模式挂载到/<em class="kp">usr/local/etc/unbound/unbound . conf</em>。</p><h2 id="8cdb" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">未绑定的控件证书和密钥</h2><p id="02f2" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">如果您想监控您的非绑定性能，您可以使用<em class="kp"> unbound_control </em>(非绑定Linux安装中包含的实用程序)或Python模块<em class="kp"> unbound_console </em>进行查询(更多细节将在另一篇文章中介绍)。如果您查看一下<em class="kp">/etc/unbounded</em>(在linux上)或/usr/local/etc/unbounded(在SecNS未绑定映像上)的内容，您可以看到以下4个文件:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="996c" class="ix iy hi la b fi le lf l lg lh">unbound_control.key<br/>unbound_control.pem<br/>unbound_server.pem<br/><br/>unbound_server.key</span></pre><p id="de3a" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">为了连接到未绑定的控件服务，前3个文件是必需的，因此如果您想要与之交互，您必须从容器中获取这3个文件。你可以按照对<em class="kp"> unbound.conf </em>的描述来完成这个任务(通过<em class="kp"> docker cp </em>或者通过挂载<em class="kp">临时文件夹</em>)。</p><p id="dfea" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">在我的家庭安装中，我没有特别的安全顾虑，我从我的Unbound Raspberry安装中获得了这4个文件，然后我将它们复制到<em class="kp">/volume 1/docker/Unbound/usr _ local _ etc _ unbounded</em>中，并在RO模式下将它们一个接一个地挂载到SecNS Unbound映像上(即容器中的每个<em class="kp">unbounded _ XXX . yyy</em>文件挂载到<em class="kp">/usr/local/etc/unbounded/XXX . yyy</em>)。这样，我可以在我的Raspberry上使用<em class="kp"> unbound_control </em>命令来监控Raspberry和Synology Docker未绑定实例，而无需指定不同的pem和密钥文件(当您启动<em class="kp"> unbound_control </em>工具时，它默认使用未绑定服务器的<em class="kp"> /etc/unbound.conf </em>配置文件来了解它可以在哪里找到控件和服务器<em class="kp"> pem </em>文件以及<em class="kp"> </em>控件<em class="kp">密钥</em></p><h2 id="8906" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">自定义unbound.conf</h2><p id="bc9a" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">遵循我在SecNS未绑定容器上使用的配置(我将只显示未注释的指令)。有关配置的更多详细信息，您可以查看具有广告拦截功能的<a class="ae ko" href="https://giannicostanzi.medium.com/recursive-dns-resolver-with-ad-blocking-features-dea766d4f703" rel="noopener"> <strong class="jx hj">递归DNS解析器</strong> </a> <strong class="jx hj"> </strong>，在这里您可以看到我的Raspberry未绑定配置以及更多行内注释(配置略有不同，我没有统一两个配置文件，我只是用Raspberry上的定制修改了容器文件)。</p><p id="ab69" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">请注意，在我的Raspberry配置中，我已经将默认TCP和UDP DNS端口从53更改为50053，但是如果端口53已经为Pi-hole DNS服务公开，您完全可以保留默认端口53，然后通过<em class="kp"> Docker的网络映射</em>将其作为50053(或任何您喜欢的端口)向外界公开。</p><figure class="kv kw kx ky fd lj"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">SecNS未绑定容器unbound.conf文件</figcaption></figure><h2 id="af06" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">为最终用途重新配置容器</h2><p id="2454" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">在将容器投入生产之前，让我们在停止时从Synology Docker应用程序修改它的配置。选择容器并按修改。</p><p id="1c6f" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated"><strong class="jx hj">卷绑定</strong></p><p id="2fef" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">选择卷选项卡，然后为每个文件按添加文件。</p><p id="f481" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">在图中可以看到，我已经安装了配置文件和从我的Raspberry安装中复制的4个SSL相关文件(不需要，如前所述)。我将展示双击容器可以看到的最终结果。</p><figure class="kv kw kx ky fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es lx"><img src="../Images/44af5eab7eace8724246986612a0d49a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NWpSOiWcYoGTZioMJPwyEg.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">将外部配置文件映射到未绑定容器中的原始文件上</figcaption></figure><p id="3b89" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated"><strong class="jx hj">端口映射</strong></p><p id="f2ce" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">然后，我暴露了TCP和UDP的端口50053。我需要公开它们，因为我希望我在Raspberry上运行的Pi-hole指向Raspberry和Synology NAS容器的未绑定实例，否则，如果您希望仅从在同一docker实例和同一<em class="kp">非默认桥接网络</em>上运行的Pi-hole指向未绑定实例，您不需要向外界公开未绑定的DNS端口。我还展示了端口8953/TCP，这是使用<em class="kp"> unbound_control </em>或<em class="kp"> unbound_console </em>监控未绑定性能所需的端口。</p><figure class="kv kw kx ky fd lj er es paragraph-image"><div role="button" tabindex="0" class="lk ll di lm bf ln"><div class="er es ly"><img src="../Images/42e851e4dfbc0bdc0340022c35cbaf9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kNZV0Ga_Res-NtjV173e8g.png"/></div></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">发布DNS和未绑定的控制端口</figcaption></figure><h2 id="207e" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">验证DNSSEC</h2><p id="492f" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">详细的DNSSEC测试在第1部分中显示，顺便说一句，我在这里显示一个快速测试。我从我的Raspberry运行了以下命令，指向nas.homenetwork IP地址上的SecNS Unbound exposed on port<em class="kp">50053/UDP</em>:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="f500" class="ix iy hi la b fi le lf l lg lh"># You should get the bold values in order to confirm DNSSEC is working</span><span id="e36a" class="ix iy hi la b fi lz lf l lg lh"># delv tool is provided by <em class="kp">dnsutils</em> package<br/><strong class="la hj">delv </strong><a class="ae ko" href="http://twitter.com/127" rel="noopener ugc nofollow" target="_blank"><strong class="la hj">@</strong></a><strong class="la hj">nas.homenetwork -p 50053 internetsociety.org A +rtrace +multiline</strong><br/>;; fetch: internetsociety.org/A<br/><strong class="la hj">;; fetch: internetsociety.org/DNSKEY<br/>;; fetch: internetsociety.org/DS</strong><br/>;; fetch: org/DNSKEY<br/>;; fetch: org/DS<br/>;; fetch: ./DNSKEY<br/><strong class="la hj">; fully validated</strong><br/>internetsociety.org.    300 IN A 104.18.16.166<br/>internetsociety.org.    300 IN A 104.18.17.166<br/>internetsociety.org.    300 IN <strong class="la hj">RRSIG</strong> A 13 2 300 (<br/>          20210418094324 20210416074324 34505 internetsociety.org.                <br/>          vSNyWVP0EivHHRAyiqvwJqV+5N2FgUlrBq++xzsmdafn<br/>          4zhz4CGuIBWbljDSxD2bmJYDFxfHOtR9QDX9YEHc2Q== )</span><span id="3b29" class="ix iy hi la b fi lz lf l lg lh"><strong class="la hj">dig </strong><a class="ae ko" href="http://twitter.com/127" rel="noopener ugc nofollow" target="_blank"><strong class="la hj">@</strong></a><strong class="la hj">nas.homenetwork -p 50053 internetsociety.org. A +dnssec +multiline</strong>; &lt;&lt;&gt;&gt; DiG 9.11.5-P4–5.1+deb10u3-Raspbian &lt;&lt;&gt;&gt; <a class="ae ko" href="http://twitter.com/127" rel="noopener ugc nofollow" target="_blank">@</a>x.x.x.x -p 50053 internetsociety.org. A +dnssec +multiline<br/>; (1 server found)<br/>;; global options: +cmd<br/>;; Got answer:<br/>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 38788<br/>;; flags: qr rd ra <strong class="la hj">ad</strong>; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1;; OPT PSEUDOSECTION:<br/>; EDNS: version: 0, flags: <strong class="la hj">do</strong>; udp: 4096<br/>;; QUESTION SECTION:<br/>;internetsociety.org. IN A;; ANSWER SECTION:<br/>internetsociety.org. 11 IN A 104.18.16.166<br/>internetsociety.org. 11 IN A 104.18.17.166<br/><strong class="la hj">internetsociety.org. 11 IN RRSIG</strong> A 13 2 300 (<br/> 20210418094324 20210416074324 34505 internetsociety.org.<br/> vSNyWVP0EivHHRAyiqvwJqV+5N2FgUlrBq++xzsmdafn<br/> 4zhz4CGuIBWbljDSxD2bmJYDFxfHOtR9QDX9YEHc2Q== );; Query time: 1 msec<br/>;; SERVER: nas.homenetwork#50053(x.x.x.x)<br/>;; WHEN: Sat Apr 17 10:48:13 CEST 2021<br/>;; MSG SIZE rcvd: 195</span></pre><h2 id="6676" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">2xPi-孔+2x未绑定冗余</h2><p id="dd43" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">现在我们已经在Raspberry上配置了一个Pi-hole +非绑定堆栈，在Synology NAS上配置了一个Pi-hole+非绑定堆栈，通过从每个Pi-hole指向两个非绑定实例，我们最终可以得到一个更加冗余的解决方案。这可以通过Pi-hole GUI上的<em class="kp">设置→ DNS配置</em>面板完成，根据需要定义第二个自定义上游DNS服务器。</p><p id="7eee" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">这里我发现了一个大问题，我不能指定一个FQDN(完全限定域名)来指向一个自定义DNS，所以在我运行在Synology Docker上的Pi-hole上我不能通过名字来指向运行在同一个Docker网络上的Unbound(es:<em class="kp">sec ns-un bound 1</em>)。我可以在与我的Pi-hole容器共享的网络上用命令<em class="kp">docker inspect secns-un bound 1</em>检查docker分配给<em class="kp"> secns-unbound1 </em>的IP，但是如果从头开始重新创建容器，它可能会改变。作为一个解决方案，我选择了一个私有IP地址192.168.1.100，它位于我的家庭局域网之外，因此，流向该IP的流量通过默认路由被定向到我的<em class="kp"> MikroTik </em>路由器，作为一个特殊的IP地址用作上行DNS。</p><p id="04ad" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">假设我家局域网是10.0.0.0/24，家里路由器是10.0.0.254，NAS是10.0.0.100。我可以将运行在10.0.0.100上的Pi-hole配置为IP 192.168.1.100的上游DNS。</p><p id="4c23" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">从Pi-hole到SecNS Unbound的DNS查询退出源IP为10.0.0.100、目标IP为192.168.1.100的NAS。MikroTik路由器接收流量(必须使用10 . 0 . 0 . 0/24之外的IP <strong class="jx hj">，否则NAS会尝试直接到达它，而不将流量发送到其默认网关，除非您直接将路由器IP地址指定为DNS ),然后它用10 . 0 . 0 . 0 . 254(局域网上路由器IP的SNAT)替换源10 . 0 . 0 . 0 . 100，用10 . 0 . 0 . 0 . 100替换目的地192.168.1.100NAS接收查询并将其发送到SecNS Unbound的内部地址。现在，对查询源的未绑定回复:在这里，您可以看到有必要拥有一个源NAT，否则，如果源是10.0.0.100，Pi-hole将直接从NAS的IP(也是10.0.0.100)接收回复，而不是它期望的192.168.1.100。因此，由于SNAT，回复返回到MikroTik路由器，与之前的SNAT/DNAT相反，带有源192.168.1.100和目的地10.0.0.100的响应数据包到达NAS，然后NAS将其发送到Pi-hole容器的内部IP。</strong></p><p id="7de3" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">您可以用MikroTik用这两行代码实现这个SNAT/DNAT(第二行代码看起来很奇怪，因为源地址和目的地址是相同的，但这是因为目的地址已经被DNAT更改了，这发生在SNAT之前):</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="25d3" class="ix iy hi la b fi le lf l lg lh"><strong class="la hj">/ip firewall nat </strong></span><span id="dd75" class="ix iy hi la b fi lz lf l lg lh"><strong class="la hj">add action=dst-nat</strong> chain=dstnat in-interface=lan_bridge src-address=10.0.0.100 dst-address=192.168.1.100 <strong class="la hj">to-address=10.0.0.100</strong></span><span id="3bcf" class="ix iy hi la b fi lz lf l lg lh"><strong class="la hj">add action=src-nat</strong> chain=srcnat out-interface=lan_bridge src-address=10.0.0.100 dst-address=10.0.0.100 <strong class="la hj">to-address=10.0.0.254</strong></span></pre><p id="e363" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">不幸的是，SNAT/DNAT解决方案无法在可配置性较低且更常见的家用路由器上实现，因此使用由<em class="kp"> docker inspect </em>显示的ip可能是唯一的解决方案，除非您有像Raspberry这样的linux机器，在这种情况下，您可以通过指向Raspberry的ip和特定端口，然后将SNAT/DNAT与<em class="kp"> iptables、</em>一起应用，其逻辑与我的MikroTik示例相同:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="dfaa" class="ix iy hi la b fi le lf l lg lh"># Suppose Raspberry has IP 10.0.0.200 on eth0 and NAS 10.0.0.100<br/># As you can see, we swap src/dst ip addresses with SNAT/DNAT</span><span id="58cb" class="ix iy hi la b fi lz lf l lg lh"># First we translate the destination address to NAS IP address <br/># with DNAT</span><span id="e4c5" class="ix iy hi la b fi lz lf l lg lh">iptables -t nat -A PREROUTING -i eth0 -s 10.0.0.100 -d 10.0.0.200 -j DNAT --to-destination <strong class="la hj">10.0.0.100</strong></span><span id="432f" class="ix iy hi la b fi lz lf l lg lh"># As on MikroTik, DNAT already happened, so we match 10.0.0.100 as<br/># both source and destination and change source to Raspberry IP <br/># address whit SNAT</span><span id="fe8b" class="ix iy hi la b fi lz lf l lg lh">iptables -t nat -A POSTROUTING -o eth0 -s 10.0.0.100 -d <strong class="la hj">10.0.0.100</strong> -j SNAT --to 10.0.0.200</span><span id="fe01" class="ix iy hi la b fi lz lf l lg lh"># Enable IP forwarding "on the fly" to test if everything works<br/>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><span id="b596" class="ix iy hi la b fi lz lf l lg lh"># If you want to enable it permanently, edit <!-- -->/etc/sysctl.conf<br/># and set the following<br/>net.ipv4.ip_forward = 1</span></pre><p id="9299" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">我还尝试了一个更简单的解决方案，将NAS 10.0.0.100的IP和端口50053指定为上游DNS，该端口由未绑定的容器映射，但我发现回复返回到内部网桥lan 172.18.1.1的GW IP的Pi-hole容器，而不是10.0.0.100:</p><pre class="kv kw kx ky fd kz la lb lc aw ld bi"><span id="98bf" class="ix iy hi la b fi le lf l lg lh">root@pihole-nocache:/# nslookup<br/>&gt; server 10.0.0.100<br/>Default server: 10.0.0.100<br/>Address: 10.0.0.100#53<br/>&gt; set port=50053<br/>&gt; google.it<br/>;; <strong class="la hj">reply from unexpected source: 172.18.1.1</strong>#50053, <strong class="la hj">expected 10.0.0.100</strong>#50053<br/>;; reply from unexpected source: 172.18.1.1#50053, expected 10.0.0.100#50053<br/>;; reply from unexpected source: 172.18.1.1#50053, expected 10.0.0.100#50053</span></pre><h2 id="f4ad" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">结论</h2><p id="513d" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">我希望这篇文章对您有所帮助，如果您想避免SNAT/DNAT来实现同一个Docker实例上的容器之间的无绑定通信，请留言告诉我:)</p><p id="6a42" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">在本系列的下一篇文章中，我将向您展示我是如何实现一个监控脚本的，该脚本从Pi-hole服务器收集指标并上传到InfluxDB2服务器，以允许我在Grafana仪表板上绘制有用的信息:</p><div class="ma mb ez fb mc md"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/recursive-dns-ad-blocker-part-4-pihole2influxdb2-how-to-monitor-your-pi-hole-servers-b2f03de2baf2"><div class="me ab dw"><div class="mf ab mg cl cj mh"><h2 class="bd hj fi z dy mi ea eb mj ed ef hh bi translated">递归DNS+广告拦截器—第4部分:pihole 2 influxd 2—如何监控您的pihole服务器</h2><div class="mk l"><p class="bd b fp z dy mi ea eb mj ed ef dx translated">medium.com</p></div></div><div class="ml l"><div class="mm l mn mo mp ml mq lo md"/></div></div></a></div></div></div>    
</body>
</html>