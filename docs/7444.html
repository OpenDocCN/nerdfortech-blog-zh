<html>
<head>
<title>Restricting access to services deployed on Aks using nginx-ingress controller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 nginx-ingress 控制器限制对部署在 Aks 上的服务的访问</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/restricting-access-to-services-deployed-on-aks-using-nginx-ingress-conroller-89291df69036?source=collection_archive---------1-----------------------#2022-10-31">https://medium.com/nerd-for-tech/restricting-access-to-services-deployed-on-aks-using-nginx-ingress-conroller-89291df69036?source=collection_archive---------1-----------------------#2022-10-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2ddf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在使用部署在 azure kubernetes services (AKS)上的服务时，我们可能需要在我们的集群之外公开这些服务。</p><p id="6360" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，我们需要为需要公开的服务创建一个入口资源。</p><h2 id="a639" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">什么是 ingress？</h2><p id="811d" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">入口将来自群集外部的 HTTP 和 HTTPS 路由暴露给群集中的服务。流量路由由入口资源上定义的规则控制。</p><p id="7490" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是由 ingress 管理的流量概述:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es kd"><img src="../Images/eb6e389624fb458de2c3649a0e7248a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_FhZf00AIH1zi2cHsSRsaQ.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">进入</figcaption></figure><h1 id="94e1" class="kt je hi bd jf ku kv kw jj kx ky kz jn la lb lc jq ld le lf jt lg lh li jw lj bi translated">先决条件</h1><p id="079b" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">为了创建入口资源，我们必须在集群中安装一个入口控制器。</p><p id="c431" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用 helm 安装 nginx-ingress 控制器(除 nginx 外，还有许多其他 ingress 控制器)，如下所示:</p><pre class="ke kf kg kh fd lk ll lm ln aw lo bi"><span id="b53f" class="jd je hi ll b fi lp lq l lr ls">NAMESPACE=ingress-basic<br/>helm repo add ingress-nginx <a class="ae lt" href="https://kubernetes.github.io/ingress-nginx" rel="noopener ugc nofollow" target="_blank">https://kubernetes.github.io/ingress-nginx</a><br/>helm repo update<br/>helm install ingress-nginx ingress-nginx/ingress-nginx \<br/>  --create-namespace \<br/>  --namespace $NAMESPACE \<br/>  --set controller.service.externalTrafficPolicy=Local \<br/>  --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz</span></pre><h2 id="7fde" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">创建入口资源</h2><p id="dde4" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">现在我们的集群有了入口控制器，我们可以开始为我们的服务创建入口资源。</p><p id="9119" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，我们需要获取入口控制器提供的外部 ip</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lu"><img src="../Images/55e0b7a5fb487c1d3ad9830a7d227902.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uaeCoCkD_3bPVSODKoNcww.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">外部 Ip</figcaption></figure><p id="f962" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们有了外部 Ip，我们就可以创建一个入口。在本例中，我们为部署在集群中的 keycloak 服务创建一个入口。</p><pre class="ke kf kg kh fd lk ll lm ln aw lo bi"><span id="9ba8" class="jd je hi ll b fi lp lq l lr ls">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: keycloak-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: "nginx"<br/>    nginx.ingress.kubernetes.io/ssl-passthrough: "true"<br/>spec:<br/>  rules:<br/>  - host: keycloak.YOUR-EXTERNAL-IP.nip.io<br/>    http:<br/>      paths:<br/>      - path: /<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: keycloak<br/>            port:<br/>              number: 8080</span></pre><p id="b263" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们只需要应用这个 yaml 文件。</p><pre class="ke kf kg kh fd lk ll lm ln aw lo bi"><span id="ddc6" class="jd je hi ll b fi lp lq l lr ls">kubectl apply -f "PATH to your ingress yaml file"</span></pre><p id="0e04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过访问主机地址来检查我们的入口资源是否工作，我们将被重定向到 keycloak 欢迎页面。</p><h2 id="2369" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">IP 白名单</h2><p id="151f" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">现在我们到了最有趣的部分，我们的入口资源工作正常，但是拥有该主机地址的每个人都可以访问它。</p><p id="8c85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了防止任何人访问我们公开的服务，我们将向入口资源添加一些“白名单静态 ip ”,以便只允许来自该 Ip 的流量，否则我们将返回禁止的错误消息。</p><p id="a954" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为此，我们需要回到入口定义并添加该属性:</p><pre class="ke kf kg kh fd lk ll lm ln aw lo bi"><span id="7f3c" class="jd je hi ll b fi lp lq l lr ls">nginx.ingress.kubernetes.io/whitelist-source-range: "41.231.58.146"</span></pre><p id="087e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以添加由“，”分隔的多个 IP，或者像这样的子网“41.231.X.X/32”</p><p id="a510" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，最终的入口资源定义如下:</p><pre class="ke kf kg kh fd lk ll lm ln aw lo bi"><span id="8b35" class="jd je hi ll b fi lp lq l lr ls">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: keycloak-ingress<br/>  annotations:<br/>    kubernetes.io/ingress.class: "nginx"<br/>    nginx.ingress.kubernetes.io/ssl-passthrough: "true"<br/>    nginx.ingress.kubernetes.io/whitelist-source-range: "41.231.58.146"<br/>spec:<br/>  rules:<br/>  - host: keycloak.EXTERNAL-IP.nip.io<br/>    http:<br/>      paths:<br/>      - path: /<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: keycloak<br/>            port:<br/>              number: 8080</span></pre><p id="1f3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们需要通过再次应用来应用此修改:</p><pre class="ke kf kg kh fd lk ll lm ln aw lo bi"><span id="e77a" class="jd je hi ll b fi lp lq l lr ls">kubectl apply -f "PATH to your ingress yaml file"</span></pre><p id="d8e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不会。如果我们试图从不在白名单中的 Ip 访问我们的资源，我们会收到类似这样的消息:</p><figure class="ke kf kg kh fd ki er es paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="er es lv"><img src="../Images/e9ca18ab5319bfd1471c2bc2f9cf46f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ztM34TL0-eNYlR2Tetes_Q.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">测试白名单 Ip</figcaption></figure></div></div>    
</body>
</html>