<html>
<head>
<title>ActiveRecord Callbacks with Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Rails的ActiveRecord回调</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/activerecord-callbacks-33bc437ac19b?source=collection_archive---------13-----------------------#2021-03-29">https://medium.com/nerd-for-tech/activerecord-callbacks-33bc437ac19b?source=collection_archive---------13-----------------------#2021-03-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="942a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你能想象意外地将坏数据保存到你的数据库中吗？如果坏数据进入数据库，您可以在控制器中添加额外的逻辑来处理它们。但是如果我们可以在创建对象之前处理它呢？</p><p id="9333" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了验证之外，使用回调可以防止坏数据被插入到数据库中。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f29555a04407bfd1c509a73cd51aa83a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y4pW5e5A5PRN7D1e_vYxbw.png"/></div></div></figure><h1 id="38ee" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">什么是回调？</h1><p id="9b12" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">回调是在对象生命周期的特定时刻被调用的方法。对象的生命周期是从它的创建到它的销毁——在对象的创建和销毁之间是读取和更新的时刻。</p><h1 id="6531" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">第一步</h1><p id="d23c" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">为了使用回调，我们必须在模型中定义一个回调函数来使用这个回调函数。例如，如果我们有一个允许人们创建帐户的web应用程序，我们可能会有这样的内容:</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="6a9a" class="kx jq hi kt b fi ky kz l la lb">class User &lt; ApplicationRecord<br/>  validates_presence_of :first_name, :last_name</span><span id="2b2b" class="kx jq hi kt b fi lc kz l la lb"><strong class="kt hj">  </strong>private<strong class="kt hj"><br/></strong>  def ensure_name_is_titlecase<br/>    self.first_name.titlecase<br/>    self.last_name.titlecase<br/>  end<br/>end</span></pre><p id="5e9e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时用户可能会不小心用小写字母键入他们的名字。然后在他们的主页上，我们可以试着欢迎用户，但是用户看到他们的名字是小写的！我们需要一种方法来避免这种尴尬。</p><h1 id="8e31" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">第二步</h1><p id="2dc9" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">在定义了我们需要的方法之后，我们会让ActiveRecord知道何时执行<code class="du ld le lf kt b">ensure_name_is_titlecase</code>。</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="0a7e" class="kx jq hi kt b fi ky kz l la lb">class User &lt; ApplicationRecord<br/>  validates_presence_of :first_name, :last_name<br/>  <strong class="kt hj">before_validation :ensure_name_is_titlecase</strong></span><span id="4066" class="kx jq hi kt b fi lc kz l la lb">  private<strong class="kt hj"><br/></strong>  def ensure_name_is_titlecase<br/>    self.first_name.titlecase<br/>    self.last_name.titlecase<br/>  end<br/>end</span></pre><p id="530c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">宏<code class="du ld le lf kt b">before_validation</code>表明，它作为输入的方法将在每次验证之前执行。</p><p id="aa90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面是触发验证的常见ActiveRecord方法的列表:</p><ul class=""><li id="d9b7" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc ll lm ln lo bi translated"><code class="du ld le lf kt b">save</code></li><li id="7182" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">save!</code></li><li id="0451" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">update</code></li><li id="b050" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">update!</code></li><li id="6ad1" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">valid?</code></li></ul><p id="8cdd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du ld le lf kt b">before_validation :ensure_name_is_titlecase</code>、<strong class="ih hj">、</strong>，<code class="du ld le lf kt b">ensure_name_is_titlecase</code>方法将在每个验证方法之前运行。</p><h1 id="aa81" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">第三步</h1><p id="3959" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">但是如果我们不想让程序浪费时间运行某些回调函数呢？除了在任何验证方法之前，我们可以指定运行回调的生命周期事件！</p><pre class="je jf jg jh fd ks kt ku kv aw kw bi"><span id="6ca1" class="kx jq hi kt b fi ky kz l la lb">class User &lt; ApplicationRecord<br/>  validates_presence_of :first_name, :last_name<br/>  before_validation :ensure_name_is_titlecase, <strong class="kt hj">on: </strong><strong class="kt hj">[ :create, :update ]</strong></span><span id="834c" class="kx jq hi kt b fi lc kz l la lb">  private<strong class="kt hj"><br/></strong>  def ensure_name_is_titlecase<br/>    self.first_name.titlecase<br/>    self.last_name.titlecase<br/>  end<br/>end</span></pre><p id="0b36" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个代码片段中，我们指定希望回调只在创建和更新生命周期事件上运行。这样，我们就不会运行不必要的方法了！</p></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><h1 id="2cb7" class="jp jq hi bd jr js mb ju jv jw mc jy jz ka md kc kd ke me kg kh ki mf kk kl km bi translated"><strong class="ak">普通回调宏</strong></h1><p id="4e04" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated"><strong class="ih hj">创建对象时</strong></p><ul class=""><li id="2444" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc ll lm ln lo bi translated"><code class="du ld le lf kt b">before_validation</code></li><li id="76a9" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">after_validation</code></li><li id="00a9" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">before_save</code></li><li id="3ee5" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">after_save</code></li><li id="86a4" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">before_create</code></li><li id="e0ab" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">after_create</code></li></ul><p id="9e54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">更新对象时</strong></p><ul class=""><li id="464e" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc ll lm ln lo bi translated"><code class="du ld le lf kt b">before_validation</code></li><li id="7113" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">after_validation</code></li><li id="b2c7" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">before_save</code></li><li id="f289" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">after_save</code></li><li id="d080" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">before_update</code></li><li id="a6f9" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">after_update</code></li></ul><p id="2aa2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">摧毁一个物体时</strong></p><ul class=""><li id="1de0" class="lg lh hi ih b ii ij im in iq li iu lj iy lk jc ll lm ln lo bi translated"><code class="du ld le lf kt b">before_destroy</code></li><li id="9eb8" class="lg lh hi ih b ii lp im lq iq lr iu ls iy lt jc ll lm ln lo bi translated"><code class="du ld le lf kt b">after_destroy</code></li></ul></div></div>    
</body>
</html>