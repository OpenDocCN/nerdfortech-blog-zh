<html>
<head>
<title>How to handle 100k rows decision table in Drools-Part2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Drools-Part2 中处理 100k 行决策表</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-handle-100k-rows-decision-table-in-drools-part2-2b7fb4de3532?source=collection_archive---------4-----------------------#2021-02-21">https://medium.com/nerd-for-tech/how-to-handle-100k-rows-decision-table-in-drools-part2-2b7fb4de3532?source=collection_archive---------4-----------------------#2021-02-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="08d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如我在上一篇文章中所描述的，我们在解决 100k 行决策表时遇到了一个性能问题。</p><h1 id="fc49" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">解决方案 2:预编译电子表格规则</h1><figure class="kd ke kf kg fd kh er es paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="er es kc"><img src="../Images/b4a005f47d7a246e64a5cab470af0f48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vorsfGNDoDvje_1L4wRHDQ.jpeg"/></div></div></figure><p id="c8bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">顺着解决方案 1 的纵向思路，我觉得可以改善问题对应的情况:</p><ol class=""><li id="55ec" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">不要在运行时动态加载 Excel 数据，让我们在构建时预编译它</li><li id="9e72" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">使用 drools 电子表格决策表，以便它可以被 KIE 工作台“版本控制”；</li></ol><p id="92dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当 drools 使用规则模板+ Excel 来触发规则时，它实际上做的是:</p><ol class=""><li id="4c6b" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">使用 ExternalSpreadsheetCompiler 将规则模板和规则数据(即 Excel 文件)编译成 drl(Drools 规则语言)</li><li id="3df7" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">Drools 引擎将 drl 编译成 java 字节码</li><li id="b87c" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">java 字节码形成的规则在 JVM 中被激发</li></ol><p id="2afc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么我们能在运行时之前做第一步吗？更好的是，我们能完成转型的前两步吗？</p><p id="a8c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">幸运的是，答案是肯定的，drools 已经提供了一个友好的 maven 插件(kie-maven-plugin)来预编译 drl，或者将 drools 感知规则格式转换成 java 字节。它被称为<a class="ae jd" href="http://blog.athico.com/2018/02/the-drools-executable-model-is-alive.html#:~:text=The%20purpose%20of%20the%20executable,lambda's%20for%20the%20index%20evaluation." rel="noopener ugc nofollow" target="_blank"> Drools 可执行模型</a>。</p><p id="0cd5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一石二鸟，它使什么是好的更好。为了应用 drools 可执行模型解决方案，我们需要将原始 Excel 格式转换为 drools 感知电子表格决策表。它可以由“kie-workbench”管理，因此问题 2 得到解决。我们需要做的只是将 drools 语法“header”添加到决策表中。</p><figure class="kd ke kf kg fd kh er es paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="er es lc"><img src="../Images/a4d6a74b15ddd7827d808d7505ef8ded.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SPCDXF9NqHzDOK44gXUbFw.png"/></div></div></figure><p id="078f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如你所看到的:</p><p id="db9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B7: f1: ClientObject </strong>，是事实声明；</p><p id="fa35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> B8: descr 匹配$param </strong>，是条件逻辑</p><p id="5fd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> C8: f1.setPass($param) </strong>，是动作逻辑；</p><p id="d83c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样。</p><p id="1bd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们快速回顾一下变化，然后测试性能改进。</p><p id="f2d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">解决方案 2 存储在<a class="ae jd" href="https://github.com/ryanzhang/drools-bigtable/tree/precompile-rule-solution" rel="noopener ugc nofollow" target="_blank">预编译-规则-解决方案</a>分支中。</p><figure class="kd ke kf kg fd kh"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="7cad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">kie-maven-plugin 为我们做的是:</p><ol class=""><li id="3531" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">使用 drools-model-compiler 转换电子表格决策表，生成 10206 java 代码(注意，它甚至比 drl 文件更好)</li><li id="846a" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">生成的 java 代码被编译成字节码并打包成 jar</li></ol><p id="15d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，当 myapp 客户端代码加载 jar 文件时，它会直接调用字节码，而无需分析 Excel 文件和 drl 解析器等。</p><p id="e55f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重要的是，业务逻辑仍然被包装成它自己的项目，而不是泄漏到通用的应用程序代码和生命周期中。</p><p id="c2c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看解决方案 2 的性能:</p><figure class="kd ke kf kg fd kh"><div class="bz dy l di"><div class="ld le l"/></div></figure><p id="56bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将性能数据放入表格中进行比较:</p><figure class="kd ke kf kg fd kh"><div class="bz dy l di"><div class="ld le l"/></div></figure><h1 id="0c0a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">赞成</h1><p id="772a" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">通过应用 drools 可执行模型，我们获得了两个明显的优势。</p><ol class=""><li id="048f" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">运行时性能明显提高。</li><li id="be97" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">电子表格决策表可由“kie-workbench”监控</li></ol><p id="e451" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时候，当一些用户开始采用面向规则的应用程序框架时，这一点并不明显。但是从规则治理的角度来看，这是非常重要的，比如版本控制你的规则数据，部署测试和发布你的业务规则。在 kie workbench 的帮助下，所有这些特性都是现成的。</p><h1 id="0fc8" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">欺骗</h1><p id="9051" class="pw-post-body-paragraph if ig hi ih b ii lf ik il im lg io ip iq lh is it iu li iw ix iy lj ja jb jc hb bi translated">我认为解决方案 2 有两个缺点。</p><ol class=""><li id="e194" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">编译时间相当长</li></ol><p id="8776" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于 10k 行数，1.5 分钟的编译时间似乎是可以接受的。它实际上生成并编译了 10k 个小 java 文件。</p><p id="a7a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是对于 100k 行的数字，它不能得出一个合理的编译时间。大约需要 15 分钟完成。这将变得非常尴尬，无论是开发经验还是 CICD 的经验。只是当规则变成一定级别的金额时，花费了太多的精力。</p><p id="3926" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.当行数太大时，比如 100k 行，性能提升非常小。</p><p id="97e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对比预编译它的巨大努力，性能增益并没有我们从表中的对比数据中看到的那么大。</p><p id="720b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于一定数量的决策表，预编译规则似乎可以显著提高运行时性能。我认为这值得一试。</p><p id="4102" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，当决策表达到 100k 时，似乎仍然不能产生很好的结果。</p><p id="3d3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而在现实中，关键字或条件值变得非常大是很常见的。因此，我们仍然需要一些更好的解决方案来处理 100k 的行决策表。</p><p id="be58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的下一篇文章中，我将展示一种不同的方法(我称之为横向思维)来转换事实和规则的维度以提高性能。</p></div></div>    
</body>
</html>