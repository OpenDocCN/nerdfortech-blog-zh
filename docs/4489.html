<html>
<head>
<title>Building a Vertx application with RxJava 3 API Bindings</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 RxJava 3 API 绑定构建 Vertx 应用程序</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/building-a-vertx-application-with-rxjava-3-api-bindings-e373077d7002?source=collection_archive---------6-----------------------#2021-07-23">https://medium.com/nerd-for-tech/building-a-vertx-application-with-rxjava-3-api-bindings-e373077d7002?source=collection_archive---------6-----------------------#2021-07-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7aea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Eclipse Vertx 有一个很棒的 codegen 机制，可以将其基于<em class="jd">事件循环</em>的异步编程模型带到不同的平台，包括其他异步库，如<a class="ae je" href="https://github.com/ReactiveX/RxJava" rel="noopener ugc nofollow" target="_blank"> RxJava2/3 </a>和<a class="ae je" href="https://smallrye.io/smallrye-mutiny/" rel="noopener ugc nofollow" target="_blank"> SmallRye 哗变</a>以及不同的语言，如 Kotlin、Kotlin 协同例程，甚至 Node/Typescript、PHP 等。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="jl jm di jn bf jo"><div class="er es jf"><img src="../Images/886aac470d16b610f3337655049a2ecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xUpUuE_39Cz_fbfa_G6okQ.jpeg"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated"><a class="ae je" href="https://unsplash.com/@justin73?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Mèng Jiǎ </a>在<a class="ae je" href="https://unsplash.com/s/photos/china-landscape?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="ed78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们将重构我们在<a class="ae je" href="https://itnext.io/building-restful-apis-with-eclipse-vertx-4ce89d8eeb74" rel="noopener ugc nofollow" target="_blank">上一篇文章</a>中所做的 RESTful APIs，并用 RxJava 3 重新实现它。RxJava 3 完全实现了<a class="ae je" href="http://www.reactive-streams.org/" rel="noopener ugc nofollow" target="_blank">反应流规范</a>。</p><p id="bfa7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">打开浏览器，进入<a class="ae je" href="https://start.vertx.io" rel="noopener ugc nofollow" target="_blank"> Vertx Starter </a>，创建一个 Vertx 项目框架。不要忘记将<em class="jd"> RxJava 3 </em>添加到依赖项中。</p><p id="d3cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您正在处理一个现有的项目，直接添加<em class="jd"> rxjava3 </em>依赖项。</p><pre class="jg jh ji jj fd jv jw jx jy aw jz bi"><span id="e978" class="ka kb hi jw b fi kc kd l ke kf">&lt;dependency&gt;<br/>    &lt;groupId&gt;io.vertx&lt;/groupId&gt;<br/>    &lt;artifactId&gt;vertx-rx-java3&lt;/artifactId&gt;<br/>&lt;/dependency&gt;</span></pre><p id="0cd4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将项目源代码导入 IDE，例如 Intellij IDEA。</p><p id="8861" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先让我们来看看<code class="du kg kh ki jw b">MainVerticle</code>。</p><pre class="jg jh ji jj fd jv jw jx jy aw jz bi"><span id="28ef" class="ka kb hi jw b fi kc kd l ke kf">import io.vertx.rxjava3.core.AbstractVerticle;<br/>import io.vertx.rxjava3.ext.web.Router;<br/>import io.vertx.rxjava3.ext.web.RoutingContext;<br/>import io.vertx.rxjava3.ext.web.handler.BodyHandler;<br/>import io.vertx.rxjava3.ext.web.validation.ValidationHandler;<br/>import io.vertx.rxjava3.json.schema.SchemaParser;<br/>import io.vertx.rxjava3.json.schema.SchemaRouter;<br/>import io.vertx.rxjava3.pgclient.PgPool;<br/>// other imports</span><span id="8ca4" class="ka kb hi jw b fi kj kd l ke kf">@Slf4j<br/>public class MainVerticle extends AbstractVerticle {</span><span id="d676" class="ka kb hi jw b fi kj kd l ke kf">    @Override<br/>    public Completable rxStart() {}<br/>    <br/>     //create routes<br/>    private Router routes(PostsHandler handlers) {}<br/>    <br/>    private PgPool pgPool() {}<br/>}</span></pre><p id="c8ea" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如你所见，我们从<code class="du kg kh ki jw b">io.vertx.rxjava3</code>导入了所有的基本类，并使用 RxJava 3 API，而不是 Vertx 内置的<code class="du kg kh ki jw b">Future</code>和<code class="du kg kh ki jw b">Promise</code>。在这个实现中，我们覆盖了返回 RxJava <code class="du kg kh ki jw b">Completable</code>的<code class="du kg kh ki jw b">rxStart</code>。</p><p id="948b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，我们转到<code class="du kg kh ki jw b">PostRepository</code>类。</p><pre class="jg jh ji jj fd jv jw jx jy aw jz bi"><span id="1998" class="ka kb hi jw b fi kc kd l ke kf">import io.reactivex.rxjava3.core.Flowable;<br/>import io.reactivex.rxjava3.core.Single;<br/>import io.vertx.rxjava3.pgclient.PgPool;<br/>import io.vertx.rxjava3.sqlclient.Row;<br/>import io.vertx.rxjava3.sqlclient.RowSet;<br/>import io.vertx.rxjava3.sqlclient.SqlResult;<br/>import io.vertx.rxjava3.sqlclient.Tuple;<br/>// other imports...</span><span id="3645" class="ka kb hi jw b fi kj kd l ke kf">@Slf4j<br/>public class PostRepository {</span><span id="3da5" class="ka kb hi jw b fi kj kd l ke kf">    private static Function&lt;Row, Post&gt; MAPPER = (row) -&gt;<br/>        Post.of(<br/>            row.getUUID("id"),<br/>            row.getString("title"),<br/>            row.getString("content"),<br/>            row.getLocalDateTime("created_at")<br/>        );<br/></span><span id="69d8" class="ka kb hi jw b fi kj kd l ke kf">    private final PgPool client;</span><span id="feeb" class="ka kb hi jw b fi kj kd l ke kf">    private PostRepository(PgPool _client) {<br/>        this.client = _client;<br/>    }</span><span id="a9a5" class="ka kb hi jw b fi kj kd l ke kf">    //factory method<br/>    public static PostRepository create(PgPool client) {<br/>        return new PostRepository(client);<br/>    }</span><span id="54f4" class="ka kb hi jw b fi kj kd l ke kf">    public Flowable&lt;Post&gt; findAll() {<br/>        return this.client<br/>            .query("SELECT * FROM posts")<br/>            .rxExecute()<br/>            .flattenAsFlowable(<br/>                rows -&gt; StreamSupport.stream(rows.spliterator(), false)<br/>                    .map(MAPPER)<br/>                    .collect(Collectors.toList())<br/>            );<br/>    }<br/></span><span id="6bf8" class="ka kb hi jw b fi kj kd l ke kf">    public Single&lt;Post&gt; findById(UUID id) {<br/>        Objects.requireNonNull(id, "id can not be null");<br/>        return client.preparedQuery("SELECT * FROM posts WHERE id=$1").rxExecute(Tuple.of(id))<br/>            .map(RowSet::iterator)<br/>            .flatMap(iterator -&gt; iterator.hasNext() ? Single.just(MAPPER.apply(iterator.next())) : Single.error(new PostNotFoundException(id)));<br/>    }</span><span id="cadc" class="ka kb hi jw b fi kj kd l ke kf">    public Single&lt;UUID&gt; save(Post data) {<br/>        return client.preparedQuery("INSERT INTO posts(title, content) VALUES ($1, $2) RETURNING (id)")<br/>            .rxExecute(Tuple.of(data.getTitle(), data.getContent()))<br/>            .map(rs -&gt; rs.iterator().next().getUUID("id"));<br/>    }</span><span id="3fd6" class="ka kb hi jw b fi kj kd l ke kf">    public Single&lt;Integer&gt; saveAll(List&lt;Post&gt; data) {<br/>        var tuples = data.stream()<br/>            .map(d -&gt; Tuple.of(d.getTitle(), d.getContent()))<br/>            .collect(Collectors.toList());</span><span id="19c5" class="ka kb hi jw b fi kj kd l ke kf">        return client.preparedQuery("INSERT INTO posts (title, content) VALUES ($1, $2)")<br/>            .rxExecuteBatch(tuples)<br/>            .map(SqlResult::rowCount);<br/>    }</span><span id="b852" class="ka kb hi jw b fi kj kd l ke kf">    public Single&lt;Integer&gt; update(Post data) {<br/>        return client.preparedQuery("UPDATE posts SET title=$1, content=$2 WHERE id=$3")<br/>            .rxExecute(Tuple.of(data.getTitle(), data.getContent(), data.getId()))<br/>            .map(SqlResult::rowCount);<br/>    }</span><span id="a8da" class="ka kb hi jw b fi kj kd l ke kf">    public Single&lt;Integer&gt; deleteAll() {<br/>        return client.query("DELETE FROM posts").rxExecute()<br/>            .map(SqlResult::rowCount);<br/>    }</span><span id="696a" class="ka kb hi jw b fi kj kd l ke kf">    public Single&lt;Integer&gt; deleteById(UUID id) {<br/>        Objects.requireNonNull(id, "id can not be null");<br/>        return client.preparedQuery("DELETE FROM posts WHERE id=$1").rxExecute(Tuple.of(id))<br/>            .map(SqlResult::rowCount);<br/>    }</span><span id="b145" class="ka kb hi jw b fi kj kd l ke kf">}</span></pre><p id="0b97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个类中，我们使用基于 RxJava 3 API 的<code class="du kg kh ki jw b">PgPool</code>来代替，它包装了原始的 Vertx <code class="du kg kh ki jw b">PgPool</code>并添加了额外的 RxJava 3 API 支持。所有方法都类似于以前的 Vertx 版本，这里我们使用一个<code class="du kg kh ki jw b">rxExecute</code>方法来执行 SQL 查询，返回的结果被切换到 RxJava 3 世界。</p><p id="9dd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们来看看<code class="du kg kh ki jw b">PostsHandler</code>。</p><pre class="jg jh ji jj fd jv jw jx jy aw jz bi"><span id="966f" class="ka kb hi jw b fi kc kd l ke kf">import io.vertx.rxjava3.ext.web.RoutingContext;<br/>//other imports</span><span id="3752" class="ka kb hi jw b fi kj kd l ke kf">@Slf4j<br/>class PostsHandler {</span><span id="25ae" class="ka kb hi jw b fi kj kd l ke kf">    PostRepository posts;</span><span id="705e" class="ka kb hi jw b fi kj kd l ke kf">    private PostsHandler(PostRepository _posts) {<br/>        this.posts = _posts;<br/>    }</span><span id="3ee5" class="ka kb hi jw b fi kj kd l ke kf">    //factory method<br/>    public static PostsHandler create(PostRepository posts) {<br/>        return new PostsHandler(posts);<br/>    }</span><span id="e9c3" class="ka kb hi jw b fi kj kd l ke kf">    public void all(RoutingContext rc) {<br/>//        var params = rc.queryParams();<br/>//        var q = params.get("q");<br/>//        var limit = params.get("limit") == null ? 10 : Integer.parseInt(params.get("q"));<br/>//        var offset = params.get("offset") == null ? 0 : Integer.parseInt(params.get("offset"));<br/>//        LOGGER.log(Level.INFO, " find by keyword: q={0}, limit={1}, offset={2}", new Object[]{q, limit, offset});<br/>        this.posts.findAll().takeLast(10).toList()<br/>            .subscribe(<br/>                data -&gt; rc.response().end(Json.encode(data))<br/>            );<br/>    }</span><span id="62e2" class="ka kb hi jw b fi kj kd l ke kf">    public void get(RoutingContext rc) throws PostNotFoundException {<br/>        var params = rc.pathParams();<br/>        var id = params.get("id");<br/>        var uuid = UUID.fromString(id);<br/>        this.posts.findById(uuid)<br/>            .subscribe(<br/>                post -&gt; rc.response().end(Json.encode(post)),<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );</span><span id="6970" class="ka kb hi jw b fi kj kd l ke kf">    }<br/></span><span id="a9cb" class="ka kb hi jw b fi kj kd l ke kf">    public void save(RoutingContext rc) {<br/>        //rc.getBodyAsJson().mapTo(PostForm.class)<br/>        var body = rc.getBodyAsJson();<br/>        log.info("request body: {0}", body);<br/>        var form = body.mapTo(CreatePostCommand.class);<br/>        this.posts<br/>            .save(Post.builder()<br/>                .title(form.getTitle())<br/>                .content(form.getContent())<br/>                .build()<br/>            )<br/>            .subscribe(<br/>                savedId -&gt; rc.response()<br/>                    .putHeader("Location", "/posts/" + savedId)<br/>                    .setStatusCode(201)<br/>                    .end()</span><span id="72aa" class="ka kb hi jw b fi kj kd l ke kf">            );<br/>    }</span><span id="d193" class="ka kb hi jw b fi kj kd l ke kf">    public void update(RoutingContext rc) {<br/>        var params = rc.pathParams();<br/>        var id = params.get("id");<br/>        var body = rc.getBodyAsJson();<br/>        log.info("\npath param id: {}\nrequest body: {}", id, body);<br/>        var form = body.mapTo(CreatePostCommand.class);<br/>        this.posts.findById(UUID.fromString(id))<br/>            .flatMap(<br/>                post -&gt; {<br/>                    post.setTitle(form.getTitle());<br/>                    post.setContent(form.getContent());</span><span id="7b95" class="ka kb hi jw b fi kj kd l ke kf">                    return this.posts.update(post);<br/>                }<br/>            )<br/>            .subscribe(<br/>                data -&gt; rc.response().setStatusCode(204).end(),<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );</span><span id="8d27" class="ka kb hi jw b fi kj kd l ke kf">    }</span><span id="5ad6" class="ka kb hi jw b fi kj kd l ke kf">    public void delete(RoutingContext rc) {<br/>        var params = rc.pathParams();<br/>        var id = params.get("id");</span><span id="915d" class="ka kb hi jw b fi kj kd l ke kf">        var uuid = UUID.fromString(id);<br/>        this.posts.findById(uuid)<br/>            .flatMap(<br/>                post -&gt; this.posts.deleteById(uuid)<br/>            )<br/>            .subscribe(<br/>                data -&gt; rc.response().setStatusCode(204).end(),<br/>                throwable -&gt; rc.fail(404, throwable)<br/>            );</span><span id="a7c1" class="ka kb hi jw b fi kj kd l ke kf">    }</span><span id="0f1e" class="ka kb hi jw b fi kj kd l ke kf">}</span></pre><p id="83f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du kg kh ki jw b">subscribe</code>方法中，使用 RxJava 3 特有的<code class="du kg kh ki jw b">RoutingContext</code>来发送响应。</p><p id="5f97" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重构<code class="du kg kh ki jw b">DataInitializer</code>以使用 RxJava 3 API 绑定。</p><pre class="jg jh ji jj fd jv jw jx jy aw jz bi"><span id="e2f4" class="ka kb hi jw b fi kc kd l ke kf">@Slf4j<br/>public class DataInitializer {</span><span id="f270" class="ka kb hi jw b fi kj kd l ke kf">    private PgPool client;</span><span id="c4af" class="ka kb hi jw b fi kj kd l ke kf">    public DataInitializer(PgPool client) {<br/>        this.client = client;<br/>    }</span><span id="c84c" class="ka kb hi jw b fi kj kd l ke kf">    public static DataInitializer create(PgPool client) {<br/>        return new DataInitializer(client);<br/>    }</span><span id="2f9e" class="ka kb hi jw b fi kj kd l ke kf">    public void run() {<br/>        log.info("Data initialization is starting...");</span><span id="d121" class="ka kb hi jw b fi kj kd l ke kf">        Tuple first = Tuple.of("Hello Quarkus", "My first post of Quarkus");<br/>        Tuple second = Tuple.of("Hello Again, Quarkus", "My second post of Quarkus");</span><span id="8c00" class="ka kb hi jw b fi kj kd l ke kf">        client<br/>            .rxWithTransaction(<br/>                (SqlConnection tx) -&gt; tx.query("DELETE FROM posts").rxExecute()<br/>                    .flatMap(result -&gt; tx.preparedQuery("INSERT INTO posts (title, content) VALUES ($1, $2)").rxExecuteBatch(List.of(first, second)))<br/>                    .toMaybe()<br/>            )<br/>            .flatMapSingle(d -&gt; client.query("SELECT * FROM posts").rxExecute())<br/>            .subscribe(<br/>                (data) -&gt; {<br/>                    data.forEach(row -&gt; {<br/>                        log.info("saved row: {}", row.toJson());<br/>                    });<br/>                },<br/>                err -&gt; log.warn("failed to initializing: {}", err.getMessage())<br/>            );<br/>    }<br/>}</span></pre><p id="4678" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kg kh ki jw b">MainVerticle</code>类中<code class="du kg kh ki jw b">rxStart</code>方法的完整代码。</p><pre class="jg jh ji jj fd jv jw jx jy aw jz bi"><span id="bca9" class="ka kb hi jw b fi kc kd l ke kf">@Override<br/>public Completable rxStart() {<br/>    log.info("Starting HTTP server...");<br/>    InternalLoggerFactory.setDefaultFactory(Slf4JLoggerFactory.INSTANCE);</span><span id="7410" class="ka kb hi jw b fi kj kd l ke kf">    //Create a PgPool instance<br/>    var pgPool = pgPool();</span><span id="1ad7" class="ka kb hi jw b fi kj kd l ke kf">    //Creating PostRepository<br/>    var postRepository = PostRepository.create(pgPool);</span><span id="aaa8" class="ka kb hi jw b fi kj kd l ke kf">    //Creating PostHandler<br/>    var postHandlers = PostsHandler.create(postRepository);</span><span id="76d1" class="ka kb hi jw b fi kj kd l ke kf">    // Initializing the sample data<br/>    var initializer = DataInitializer.create(pgPool);<br/>    initializer.run();</span><span id="700d" class="ka kb hi jw b fi kj kd l ke kf">    // Configure routes<br/>    var router = routes(postHandlers);</span><span id="4c89" class="ka kb hi jw b fi kj kd l ke kf">    // Create the HTTP server<br/>    return vertx.createHttpServer()<br/>        // Handle every request using the router<br/>        .requestHandler(router)<br/>        // Start listening<br/>        .rxListen(8888)<br/>        // to Completable<br/>        .ignoreElement()<br/>        ;<br/>}</span></pre><p id="2c9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在您可以运行应用程序了。</p><pre class="jg jh ji jj fd jv jw jx jy aw jz bi"><span id="8a73" class="ka kb hi jw b fi kc kd l ke kf">mvn clean compile exec:java</span></pre><p id="e447" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从我的 github 获取<a class="ae je" href="https://github.com/hantsy/vertx-sandbox/tree/master/rxjava3" rel="noopener ugc nofollow" target="_blank">源代码，如果你还在使用 RxJava 2，这里还包括一个</a><a class="ae je" href="https://github.com/hantsy/vertx-sandbox/tree/master/rxjava2" rel="noopener ugc nofollow" target="_blank"> RxJava 2 版本</a>。</p></div></div>    
</body>
</html>