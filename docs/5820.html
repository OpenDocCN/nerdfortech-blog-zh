<html>
<head>
<title>Deep Dive into Cortex Metrics — Part I</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入探究皮层指标—第一部分</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/deep-dive-into-cortex-part-i-c228e01f8c58?source=collection_archive---------1-----------------------#2021-11-21">https://medium.com/nerd-for-tech/deep-dive-into-cortex-part-i-c228e01f8c58?source=collection_archive---------1-----------------------#2021-11-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="baaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">深入探究 Cortex Metrics.io 第一部分</p><p id="bad2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您的应用程序运行在 Kubernetes 上吗？它是高度可扩展的吗？你对它的工作方式满意吗？等等，你是怎么监控他们的？啊，普罗米修斯对吧？太棒了，您有没有想过您的 Prometheus 集群的可伸缩性和高可用性如何？在此之前，这里有一封来自你老板的邮件，要求你找出你的网站在去年圣诞节收到的 http_requests 的数量，或者让我们把它变成印度风格。你的老板想知道上一个 Sankranthi(一年前)访问过你的网站的客户数量(http_requests 总数)。现在你试着进入你的普罗米修斯/格拉夫纳服务器。您刚刚意识到没有找到度量标准。你现在怎么跟老板说？在这种情况出现之前，让我们试着用大脑皮层来解决这个问题。Cortex 是一个<a class="ae jd" href="https://cncf.io/" rel="noopener ugc nofollow" target="_blank"> CNCF </a>孵化项目，为 Prometheus 提供横向可扩展、高度可用的多租户长期存储。Cortex 主要用作 Prometheus 的<a class="ae jd" href="https://prometheus.io/docs/operating/configuration/#remote_write" rel="noopener ugc nofollow" target="_blank">远程写</a>目的地，公开 Prometheus 兼容的查询 API。如 Cortex <a class="ae jd" href="https://cortexmetrics.io/docs/" rel="noopener ugc nofollow" target="_blank">文档</a>中所述</p><ul class=""><li id="df92" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><strong class="ih hj">横向可扩展:</strong> Cortex 可以跨一个集群中的多台机器运行，超过单台机器的吞吐量和存储量。这使您能够将指标从多个 Prometheus 服务器发送到单个 Cortex 集群，并在一个位置对所有数据运行“全局聚合”查询。</li><li id="1253" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">高可用:</strong>在集群中运行时，Cortex 可以在机器之间复制数据。这使您能够在机器出现故障时保持图表中的空白。</li><li id="1306" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">多租户:</strong> Cortex 可以在单个集群中隔离来自多个不同独立 Prometheus 源的数据和查询，允许不可信方共享同一个集群。</li><li id="abb8" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><strong class="ih hj">长期存储:</strong> Cortex 支持 S3、GCS、Swift 和微软 Azure 长期存储指标数据。这使您能够将数据存储得比任何一台机器的寿命都长，并将这些数据用于长期容量规划。</li></ul><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/8d6508c6d253b6652ef0c8895873e054.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uTIZxl1G8bd5ug5rspuNzQ.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">图片来源:皮质</figcaption></figure><h1 id="50e7" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">整个故事是关于什么的？(TLDR)</h1><ol class=""><li id="9c6e" class="je jf hi ih b ii lg im lh iq li iu lj iy lk jc ll jk jl jm bi translated">了解皮质成分。</li><li id="fbee" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc ll jk jl jm bi translated">使用 Cortex、Prometheus Operator 和 AWS S3(对象存储)实现 HA-Prometheus。- <a class="ae jd" href="https://pavan1999-kumar.medium.com/deep-dive-into-cortex-metrics-part-ii-666f74cb781a" rel="noopener">第二部分</a></li></ol><h1 id="77c2" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">故事资源</h1><ol class=""><li id="765b" class="je jf hi ih b ii lg im lh iq li iu lj iy lk jc ll jk jl jm bi translated">GitHub 链接:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests</a></li><li id="effc" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc ll jk jl jm bi translated">GitHub 分支:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/tree/cortex" rel="noopener ugc nofollow" target="_blank">皮层</a></li></ol><h2 id="ae40" class="lm kj hi bd kk ln lo lp ko lq lr ls ks iq lt lu kw iu lv lw la iy lx ly le lz bi translated">了解 Cortex 组件</h2><p id="6b86" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated">在本文的第一部分，让我们从理解大脑皮层中存在的组件开始。在本文的第二部分中，我们将致力于构建一个 cortex 集群。所以让我们用一张来自 Cortex 官方网站的非常有用的架构图来详细解开每个组件的神秘感，了解它们的用法。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es md"><img src="../Images/cf671334f209ec15c9be00ddf2b192df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ndTSiWpuj1JKqevxPMtr0Q.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">皮质建筑</figcaption></figure><h2 id="811a" class="lm kj hi bd kk ln lo lp ko lq lr ls ks iq lt lu kw iu lv lw la iy lx ly le lz bi translated">a)普罗米修斯</h2><p id="bd8e" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated">Prometheus 实例负责使用 Prometheus 远程写入 API 从各种目标抓取样本并将其推送到 Cortex。Cortex 要求每个 HTTP 请求都带有一个报头，指定请求的租户 ID(默认情况下使用字符串 fake)。请求认证和授权由外部反向代理处理。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div class="er es me"><img src="../Images/8d65885d5f084c80fd8d0ba350510abe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*uJomsNWGdq4G0B6IeteYhA.png"/></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">用于远程推送的普罗米修斯配置</figcaption></figure><p id="3864" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> b)块存储</strong></p><p id="716a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">块存储是基于<a class="ae jd" href="https://prometheus.io/docs/prometheus/latest/storage/" rel="noopener ugc nofollow" target="_blank">普罗米修斯 TSDB </a>的 Cortex 存储引擎:它将每个租户的时间序列存储到他们自己的 TSDB 中，后者将他们的序列写出到磁盘块中(默认为 2h 块范围周期)。数据块存储支持的后端包括:</p><ul class=""><li id="2523" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><a class="ae jd" href="https://aws.amazon.com/s3" rel="noopener ugc nofollow" target="_blank">亚马逊 S3 </a></li><li id="01fc" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://cloud.google.com/storage/" rel="noopener ugc nofollow" target="_blank">谷歌云存储</a></li><li id="da04" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://azure.microsoft.com/en-us/services/storage/" rel="noopener ugc nofollow" target="_blank">微软 Azure 存储</a></li><li id="9cb9" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://wiki.openstack.org/wiki/Swift" rel="noopener ugc nofollow" target="_blank"> OpenStack Swift </a>(实验性)</li><li id="debf" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://thanos.io/storage.md/#filesystem" rel="noopener ugc nofollow" target="_blank">本地文件系统</a>(仅单节点)</li></ul><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mf"><img src="../Images/82d3ef159caf81a280afe0402db67ea4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5OR0gdKPOZsv-WdkerZ3HA.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">存储流架构</figcaption></figure><p id="3736" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b . 1)<a class="ae jd" href="https://cortexmetrics.io/docs/blocks-storage/store-gateway/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">store-gateway</strong></a>负责查询块，由<a class="ae jd" href="https://cortexmetrics.io/docs/blocks-storage/querier/" rel="noopener ugc nofollow" target="_blank">查询者</a>在查询时使用。运行块存储时需要存储网关。</p><p id="feba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b . 2)<a class="ae jd" href="https://cortexmetrics.io/docs/blocks-storage/compactor/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">压缩器</strong> </a>负责将较小的块合并和重复数据删除为较大的块，以减少给定租户的长期存储中存储的块的数量，并更有效地查询它们。它还保持<a class="ae jd" href="https://cortexmetrics.io/docs/blocks-storage/bucket-index/" rel="noopener ugc nofollow" target="_blank">桶索引</a>更新，因此，它是一个必需的组件。</p><h2 id="eb6b" class="lm kj hi bd kk ln lo lp ko lq lr ls ks iq lt lu kw iu lv lw la iy lx ly le lz bi translated">c)分销商</h2><p id="1abd" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated"><strong class="ih hj">经销商</strong>服务负责处理来自 Prometheus 的样品。这是系列样品写入路径的第一站。一旦分销商收到来自 Prometheus 的样本，将验证每个样本的正确性，并确保其在配置的租户限制范围内，如果特定租户的限制未被覆盖，则返回默认限制。然后，有效样本被分成批次，并行发送到多个<a class="ae jd" href="https://cortexmetrics.io/docs/architecture/#ingester" rel="noopener ugc nofollow" target="_blank">吸入器</a>。分销商是无状态的，可以根据需要扩大和缩小规模。</p><h2 id="401c" class="lm kj hi bd kk ln lo lp ko lq lr ls ks iq lt lu kw iu lv lw la iy lx ly le lz bi translated">c)饮食</h2><p id="77d6" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated"><strong class="ih hj"> ingester </strong>服务负责将传入的序列写入写入路径上的<a class="ae jd" href="https://cortexmetrics.io/docs/architecture/#storage" rel="noopener ugc nofollow" target="_blank">长期存储后端</a>，并返回内存中的序列样本以供读取路径上的查询。</p><p id="8037" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">传入的序列不会立即写入存储，而是保留在内存中，并定期刷新到存储(默认情况下，块存储 12 小时，块存储 2 小时)。由于这个原因，<a class="ae jd" href="https://cortexmetrics.io/docs/architecture/#querier" rel="noopener ugc nofollow" target="_blank">查询程序</a>可能需要在读取路径上执行查询时，从吸入器和长期存储器中提取样本。吸入器是半状态的。</p><h2 id="0306" class="lm kj hi bd kk ln lo lp ko lq lr ls ks iq lt lu kw iu lv lw la iy lx ly le lz bi translated">奎利尔</h2><p id="bcc6" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated">query er 服务使用 PromQL 查询语言处理查询。</p><p id="77c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查询程序从吸入器和长期存储器中获取系列样本:吸入器保存尚未刷新到长期存储器中的内存系列。由于复制因素，查询者可能会收到重复的样本；为了解决这个问题，对于给定的时间序列，查询程序在内部使用相同的时间戳对个样本进行重复数据删除。</p><p id="cada" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查询程序是无状态的，可以根据需要伸缩。</p><h2 id="6161" class="lm kj hi bd kk ln lo lp ko lq lr ls ks iq lt lu kw iu lv lw la iy lx ly le lz bi translated">e)查询前端</h2><p id="151d" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated"><strong class="ih hj">查询前端</strong>是一个<strong class="ih hj">可选服务</strong>，提供查询者的 API 端点，可以用来加速读取路径。当查询前端就绪时，传入的查询请求应该被定向到查询前端，而不是查询者。为了执行实际的查询，集群中仍然需要 querier 服务。</p><h2 id="143c" class="lm kj hi bd kk ln lo lp ko lq lr ls ks iq lt lu kw iu lv lw la iy lx ly le lz bi translated">f)标尺</h2><p id="085b" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated"><strong class="ih hj">标尺</strong>是一个<strong class="ih hj">可选服务</strong>,执行 PromQL 查询来记录规则和警报。统治者需要一个数据库来存储每个租户的记录规则和警报。</p><h2 id="2646" class="lm kj hi bd kk ln lo lp ko lq lr ls ks iq lt lu kw iu lv lw la iy lx ly le lz bi translated">g)报警管理器</h2><p id="d8fd" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated"><strong class="ih hj"> alertmanager </strong>是一个<strong class="ih hj">可选服务</strong>，负责接受来自<a class="ae jd" href="https://cortexmetrics.io/docs/architecture/#ruler" rel="noopener ugc nofollow" target="_blank"> ruler </a>的警报通知，对其进行去重和分组，并将其路由到正确的通知通道，如 email、PagerDuty 或 OpsGenie。</p><h2 id="2289" class="lm kj hi bd kk ln lo lp ko lq lr ls ks iq lt lu kw iu lv lw la iy lx ly le lz bi translated">高可用性跟踪器</h2><p id="3d96" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated">分配器具有一个<strong class="ih hj">高可用性(HA)跟踪器</strong>。启用后，分发服务器会对来自冗余 Prometheus 服务器的传入样本进行重复数据删除。这允许您拥有相同 Prometheus 服务器的多个 HA 副本，将相同的系列写入 Cortex，然后在 Cortex distributor 中对这些系列进行重复数据删除。</p><p id="dd7a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">HA Tracker 需要一个键值(KV)存储来协调当前选择的副本。经销商将只接受来自现任领导的样品。默认情况下，带有一个或没有标签(副本和集群的标签)的样本将被接受，并且永远不会进行重复数据删除。</p><p id="ca33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">HA tracker 支持的 KV 存储有:</p><ul class=""><li id="e6e3" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated"><a class="ae jd" href="https://www.consul.io/" rel="noopener ugc nofollow" target="_blank">领事</a></li><li id="170f" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated"><a class="ae jd" href="https://etcd.io/" rel="noopener ugc nofollow" target="_blank"> Etcd </a></li></ul><h1 id="da67" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">结论</h1><p id="1162" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq ma is it iu mb iw ix iy mc ja jb jc hb bi translated">这些是大脑皮层中存在的各种成分。在本文的第二部分中，我已经解释了如何建立一个 HA-Prometheus，对 cortex 实例进行远程写入，然后 cortex 将其推送到对象存储进行保留(S3 桶)。</p><p id="81b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">直到下一次…..</p><h1 id="ecd8" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">被推荐的</h1><div class="mg mh ez fb mi mj"><a href="https://pavan1999-kumar.medium.com/deep-dive-into-cortex-metrics-part-ii-666f74cb781a" rel="noopener follow" target="_blank"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">深入探究皮层指标第二部分</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">深入探究 Cortex Metrics.io 第二部分</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">pavan1999-kumar.medium.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx kc mj"/></div></div></a></div><div class="mg mh ez fb mi mj"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/kubernetes-cluster-autoscaler-in-action-6172a023f542"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">Kubernetes 集群自动缩放器正在运行</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">使用 Kubernetes 集群自动缩放器有效节约成本</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">medium.com</p></div></div><div class="ms l"><div class="my l mu mv mw ms mx kc mj"/></div></div></a></div><div class="mg mh ez fb mi mj"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/running-apache-spark-on-eks-with-aws-spot-instances-f8ce91d319b9"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">使用 AWS Spot 实例在 EKS 上运行 Apache Spark</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">通过 AWS Spot 实例为 EKS 上的 Apache Spark 工作负载有效节约成本</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">medium.com</p></div></div><div class="ms l"><div class="mz l mu mv mw ms mx kc mj"/></div></div></a></div><div class="mg mh ez fb mi mj"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/free-and-automatic-ssl-certificates-in-kubernetes-using-cert-manager-6fb65ac63d5"><div class="mk ab dw"><div class="ml ab mm cl cj mn"><h2 class="bd hj fi z dy mo ea eb mp ed ef hh bi translated">使用证书管理器在 Kubernetes 中免费提供自动 SSL 证书</h2><div class="mq l"><h3 class="bd b fi z dy mo ea eb mp ed ef dx translated">使用证书管理器获得免费的自动 SSL 证书，让我们加密</h3></div><div class="mr l"><p class="bd b fp z dy mo ea eb mp ed ef dx translated">medium.com</p></div></div><div class="ms l"><div class="na l mu mv mw ms mx kc mj"/></div></div></a></div></div></div>    
</body>
</html>