<html>
<head>
<title>Batch Operation — S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">批量操作— S3</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/batch-operation-s3-da8827dc55dd?source=collection_archive---------1-----------------------#2022-01-21">https://medium.com/nerd-for-tech/batch-operation-s3-da8827dc55dd?source=collection_archive---------1-----------------------#2022-01-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/dee1bba12e1c1fa1562666199540df8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J48u5m2zBds1Lq7JclZLgQ.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">布莱恩·麦高恩在<a class="ae hv" href="https://unsplash.com/s/photos/army-robot?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><p id="95b3" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对大规模S3对象执行操作</p><p id="bfa3" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">SDK测试的学分:<a class="jt ju ge" href="https://medium.com/u/4b740541af70?source=post_page-----da8827dc55dd--------------------------------" rel="noopener" target="_blank"> Parikshit Maheshwari </a></p><p id="6e59" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当使用S3作为数据湖进行删除时，很多时候，我们不得不执行某些具有批量性质的操作。例如，一旦我们在配置单元中删除了一个表分区，我们就应用一个删除策略标记，这样该分区中的所有对象都会根据标记值自动从S3中删除。逐个标记如此大量的对象是非常耗时的。如果我们使用lambda，它甚至会超时。为了避免这种情况，我们可以使用S3批处理操作。</p><p id="5999" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">批处理操作的体系结构如下:</p><figure class="jw jx jy jz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es jv"><img src="../Images/c7d334cf05b3115289c2677eb978f2ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*llR3aVMt2S0-YxlfdBOwhQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">作者图片</figcaption></figure><p id="49a9" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">批处理运算符有三个组成部分:</p><p id="620a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">作业:</strong>这是批处理操作符中的基本工作单元。它包含对一组对象运行指定操作所需的所有信息。</p><p id="dbc0" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">操作:</strong>是API动作，比如替换标签。作业&amp;操作有一对一的映射。</p><p id="85a5" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">任务:</strong> It任务是一个作业的执行单元。该作业将为清单文件中指定的每个对象创建一个任务。</p><p id="5637" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建批处理作业:</p><p id="4c27" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">先决条件:</p><p id="f127" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">货单文件:</strong>我们可以创建CSV格式的货单，也可以从S3库存中创建。在本例中，我将使用CSV创建它。下面是我的清单文件的内容。</p><pre class="jw jx jy jz fd ka kb kc kd aw ke bi"><span id="118a" class="kf kg hy kb b fi kh ki l kj kk">&lt;bucket-name&gt;,path/to/file/5849_scheduler.logs<br/>&lt;bucket-name&gt;,path/to/file/5849_webserver.logs<br/>&lt;bucket-name&gt;,path/to/file/5898-scheduler.logs</span></pre><p id="f522" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="kl">注意:此清单文件不支持正则表达式或通配符，对象键应为完整路径。我们可以利用AWS S3库存来获取文件列表。</em></p><p id="a2da" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz"> IAM角色</strong>有权访问清单、实际对象和报告将驻留的所有存储桶位置。我用下面的策略创建了一个角色。</p><pre class="jw jx jy jz fd ka kb kc kd aw ke bi"><span id="6b3f" class="kf kg hy kb b fi kh ki l kj kk">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:PutObjectTagging",<br/>                "s3:PutObjectVersionTagging"<br/>            ],<br/>            "Resource": [<br/>                "arn:aws:s3:::&lt;bucket_name&gt;/path/to/data/*",<br/>            ]<br/>        },<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:GetObject",<br/>                "s3:GetObjectVersion",<br/>                "s3:GetBucketLocation"<br/>            ],<br/>            "Resource": [<br/>                "arn:aws:s3:::&lt;bucket_name&gt;/path/to/manifest.csv"<br/>            ]<br/>        },<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "s3:PutObject",<br/>                "s3:GetBucketLocation"<br/>            ],<br/>            "Resource": [<br/>                "arn:aws:s3:::&lt;bucket_name&gt;/path/to/report/*"<br/>            ]<br/>        }<br/>    ]<br/>}</span></pre><p id="4903" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，我们为这个角色添加了一个信任策略，以便s3可以承担这个角色:</p><pre class="jw jx jy jz fd ka kb kc kd aw ke bi"><span id="ce34" class="kf kg hy kb b fi kh ki l kj kk">{<br/>  "Version": "2012-10-17",<br/>  "Statement": [<br/>    {<br/>      "Effect": "Allow",<br/>      "Principal": {<br/>        "Service": "batchoperations.s3.amazonaws.com"<br/>      },<br/>      "Action": "sts:AssumeRole"<br/>    }<br/>  ]<br/>}</span></pre><p id="0e72" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们使用控制台创建S3批处理作业。记住，创建这个批处理作业操作员的角色/身份应该对我们上面创建的角色拥有<strong class="ix hz"> s3:CreateJob </strong>权限和<strong class="ix hz"> iam:PassRole </strong>权限。</p><figure class="jw jx jy jz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es km"><img src="../Images/e5cf1bfd77be251c0ea0837f55f1be78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FsiSgfAZJ99Aej5NhZfDbw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">作者图片</figcaption></figure><p id="74fe" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我选择了原因CSV作为清单类型，并添加了清单文件路径。然后我点击下一步。</p><figure class="jw jx jy jz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kn"><img src="../Images/517c17f019635a3cce8750733a5ba932.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CepP-QQ0CZwH8UDM0Z_w5w.png"/></div></div></figure><p id="949e" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在操作下，我选择了<strong class="ix hz">“替换所有对象标签”</strong>，并提供了标签键值对。</p><figure class="jw jx jy jz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ko"><img src="../Images/eb25d58c635ea495871773331a355fd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r0dsyrXys_gonGnCpupPIw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">作者图片</figcaption></figure><p id="1138" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">向下滚动并填写权限详细信息</p><figure class="jw jx jy jz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kp"><img src="../Images/406fadf03db73c679068b8334ad09f23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8GI6kmdImrTSGbVAlp1IPQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">作者图片</figcaption></figure><p id="842d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">填好后点击下一步按钮。在下一页上查看，然后单击创建作业。这将创建作业，并进入<strong class="ix hz"><em class="kl">状态，等待您确认运行</em> </strong>状态。选择作业并单击运行作业。这将运行作业。它会显示完成百分比。一旦完成将显示以下屏幕。</p><figure class="jw jx jy jz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kq"><img src="../Images/e69e13c8042403bce76cc173962fa129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2A9cGkiepV2Y-hnl9s-pOA.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">作者图片</figcaption></figure><p id="1e08" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">就是这样。我们可以单击作业id，查看其详细信息以及报告位置。在这篇博客中，我们看到了如何为S3操作创建批处理作业。尽管我们从控制台完成了所有工作，但我们也可以从CLI/SDK完成。在使用SDK/CLI时，我们需要有清单文件的ETag，AWS <strong class="ix hz">帐户id </strong>，<strong class="ix hz">桶ARN </strong> &amp;我们需要将<strong class="ix hz">报告格式</strong>(S3 batch operations _ CSV _ 2018 08 20)&amp;<strong class="ix hz">confirmation required</strong>传递为False。最后一个参数将允许作业立即运行。</p><p id="f259" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">批量操作需要自己的甜蜜时间。作业在完成之前要经历以下几个阶段。</p><pre class="jw jx jy jz fd ka kb kc kd aw ke bi"><span id="7bc8" class="kf kg hy kb b fi kh ki l kj kk">Preparing -&gt; suspended -&gt; Ready -&gt; Active -&gt; Completing -&gt; Complete</span></pre><p id="19d2" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其他可能的状态有<code class="du kr ks kt kb b">Failed | Cancelling | Cancelled</code>。</p><p id="b73f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可能需要一种事件驱动的方式，以便在作业完成后得到通知。多亏了Eventbridge，我们可以使用规则实现同样的功能。我们从CloudTrail中过滤状态变更事件，并通知涉众。相同的过滤器模式如下所示:</p><pre class="jw jx jy jz fd ka kb kc kd aw ke bi"><span id="0733" class="kf kg hy kb b fi kh ki l kj kk">{<br/>    "source": [<br/>        "aws.s3"<br/>    ],<br/>    "detail-type": [<br/>        "AWS Service Event via CloudTrail"<br/>    ],<br/>    "detail": {<br/>        "eventSource": [<br/>            "s3.amazonaws.com"<br/>        ],<br/>        "eventName": [<br/>            "JobStatusChanged"<br/>        ],<br/>        "serviceEventDetails": {<br/>            "status": [<br/>                "Complete"<br/>            ]<br/>        }<br/>    }<br/>}</span></pre><p id="b988" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以插入SNS或Lambda来获取事件消息。</p><figure class="jw jx jy jz fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ku"><img src="../Images/b363c9961e1bb352c169be737ca85858.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_klD0NK4UnZhUIaRG2iDNw.png"/></div></div></figure><p id="3adb" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">云计算快乐！！</p></div></div>    
</body>
</html>