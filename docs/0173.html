<html>
<head>
<title>Knock Knock, can you open the Firewall? (Linux &amp; MikroTik practical examples)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">咚咚咚，能打开防火墙吗？(Linux和MikroTik实际例子)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/knock-knock-can-you-open-the-firewall-linux-mikrotik-practical-examples-6ee16742c988?source=collection_archive---------0-----------------------#2020-06-15">https://medium.com/nerd-for-tech/knock-knock-can-you-open-the-firewall-linux-mikrotik-practical-examples-6ee16742c988?source=collection_archive---------0-----------------------#2020-06-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="cf4c" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">简单的扫描器可以持续扫描公共网络的IP地址，而不会放弃从互联网访问您的家庭网络资源，如果没有暴露在这些扫描器下的服务，岂不是很神奇？</h2></div><h2 id="77b5" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">介绍</h2><p id="4dc4" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">许多在家里有服务器或NAS的人需要通过他们家庭路由器上的所谓端口转发技术在互联网上发布一些服务。公开服务使它们可以被端口扫描器检测到，端口扫描器可以了解您的家庭网络中正在运行什么机器或服务器，它们运行什么版本的软件，以及哪些漏洞可能会影响它们。这种分析可能是想要渗透到您的内部网的恶意用户的第一步。</p><h2 id="c5fd" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">linux knockd守护进程解决方案</h2><p id="d34e" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">几年前，我的家用路由器是一台简单的低功率alix-1c微型计算机，我已经通过使用<a class="ae kp" href="https://linux.die.net/man/1/knockd" rel="noopener ugc nofollow" target="_blank"> port knock server knockd </a>完成了不将服务暴露给端口扫描器的任务:正如链接的手册页所解释的那样，该服务监听网络接口上接收的每个数据包，并可以在接收到单个数据包或更有用的数据包序列时执行特定命令。如手册页上的示例所示，您可以告诉knockd，当它在指定的时间内看到特定的数据包序列时，插入一个<em class="ko"> iptables </em>规则，然后等待几秒钟，并在计时器到期时执行另一个命令。</p><p id="34c8" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">让我们假设<strong class="jx hj">您有一个IP地址为192.168.0.100的服务器，正在侦听端口22/TCP上的ssh连接，您希望在公共网络</strong>上的端口1022/TCP上公开该连接，但只有在路由器看到15秒时间帧内收到的一系列数据包(如2222/TCP、3333/UDP、4444/TCP)时，才会使用<strong class="jx hj">。</strong></p><p id="3f81" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">为了完成我上面所说的，我将配置一个永久的端口转发规则，即<strong class="jx hj">将在linux路由器<strong class="jx hj">的<em class="ko">面向互联网的</em>接口</strong>上接收的目的端口为1022/TCP </strong> <strong class="jx hj">的数据包，如ppp0，转换为目的端口为22/TCP和目的IP地址为192.168.0.100 </strong>的数据包。这是在iptables的<em class="ko"> NAT </em>表的<em class="ko">预路由</em>链中完成的。然后，我将跳转到一个特殊的<em class="ko"> KNOCKD_FWD_RULES </em>(我将它命名为FWD_RULES，因为我也可以有一个特殊的链用于<em class="ko"> KNOCKD_INPUT_RULES </em>，用于与去往linux路由器的流量相关的规则)链，就在允许<em class="ko">建立的规则之后，在<em class="ko">过滤器</em>表的<em class="ko">转发</em>链中相关的</em>流量(已经被授权)并配置<em class="ko"> knockd</em></p><h2 id="407d" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">Linux实现示例</h2><p id="0637" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">Iptables配置(它必须适应您的配置，这里我考虑一个新的防火墙，在链上有一个丢弃策略，即丢弃所有没有明确允许的内容):</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div><figcaption class="lc ld et er es le lf bd b be z dx translated">基本Iptables设置</figcaption></figure><p id="b1a2" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">Knockd配置:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div><figcaption class="lc ld et er es le lf bd b be z dx translated">Knockd Linux守护进程配置</figcaption></figure><p id="b26a" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated"><strong class="jx hj">注意:</strong>我们只为TCP SYN数据包开门，因为来自外部的后续数据包将与允许数据包属于相关或已建立连接的第一转发规则相匹配。</p><p id="2c05" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">现在，当您在家庭网络之外需要连接到家庭服务器时，您可以执行以下操作:</p><ol class=""><li id="f3ec" class="lg lh hi jx b jy kq kb kr ji li jm lj jq lk kn ll lm ln lo bi translated">使用myhomenetwork.no-ip.org之类的FQDN，将这三个神奇的数据包发送到您家庭路由器的公共IP地址(例如，您可以在无IP地址上免费注册3个IP地址)</li><li id="c313" class="lg lh hi jx b jy lp kb lq ji lr jm ls jq lt kn ll lm ln lo bi translated">在发送神奇的数据包序列后的10秒钟内建立SSH连接</li></ol><p id="666b" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">因此，让我们尝试从一个存在于互联网上的带有IP x.x.x.x的客户端进行连接</p><pre class="kv kw kx ky fd lu lv lw lx aw ly bi"><span id="adb9" class="ix iy hi lv b fi lz ma l mb mc">ssh -p 1022 myhomenetwork.no-ip.org<br/>[<strong class="lv hj">timeout</strong> - firewall closed]</span><span id="fe13" class="ix iy hi lv b fi md ma l mb mc"># Send the magic sequence of packets from client x.x.x.x<br/><strong class="lv hj">nmap -Pn -sS -p 2222 myhomenetwork.no-ip.org<br/>nmap -Pn -sU -p 3333 myhomenetwork.no-ip.org<br/>nmap -Pn -sS -p 4444 myhomenetwork.no-ip.org</strong><br/>[<strong class="lv hj">firewall opens the door</strong>, new connections allowed from x.x.x.x]<br/>sleep 2s</span><span id="c76f" class="ix iy hi lv b fi md ma l mb mc">ssh -p 1022 myhomenetwork.no-ip.org<br/>[<strong class="lv hj">connection established</strong>]<br/>[<strong class="lv hj">firewall closes the door</strong>, no NEW connections are allowed from x.x.x.x]<br/>[<strong class="lv hj">established connection from x.x.x.x keeps going on</strong>]</span></pre><p id="682d" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">我发现这种方法的美妙之处在于:</p><ul class=""><li id="ccb6" class="lg lh hi jx b jy kq kb kr ji li jm lj jq lk kn me lm ln lo bi translated">您的防火墙只对您的客户端公共ip地址开放，并且只开放10秒钟，因此该服务只对生成神奇数据包序列的IP地址开放。</li><li id="16f3" class="lg lh hi jx b jy lp kb lq ji lr jm ls jq lt kn me lm ln lo bi translated">该服务在10秒钟后停止公开，如果您在这一小段时间内建立了连接，在从<em class="ko"> KNOCKD_FWD_RULES </em>中删除特殊规则后，它不会停止，因为您的流量在<em class="ko"> FORWARD </em>链的开始处匹配<em class="ko"> established connections的</em> accept规则。这意味着，如果你的客户端与数十个其他客户端连接在一个公共IP地址上，你的服务将只对同一公共地址后面的其他客户端开放10秒钟，然后它将“消失”。</li></ul><p id="b6d3" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">正如您在我上面链接的knockd手册页上看到的，您可以实现更复杂的行为，例如，通过使用一个包含可用于触发knockd事件的序列列表的文件，每次使用序列时，它都会失效，以避免有人在嗅探您的客户端连接的网络并理解您使用的<em class="ko">神奇序列</em>时受到回复攻击。</p><h2 id="8dd6" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">敲MikroTik的门</h2><p id="7c4d" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">3年前，我在我的家庭网络中从Linux路由器转移到MikroTik HAP路由器，我想通过使用<em class="ko"> RouterOS </em>提供的工具实现一种knockd。我们没有针对RouterOS的knockd实现，但是我们可以使用动态<em class="ko">地址列表</em>来实现上一节的示例，这是一种对IP地址进行分组的有用方法，可以用作防火墙规则中的匹配条件，并且允许您添加带有到期时间的IP地址。</p><p id="e636" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">我们可以做以下事情:</p><ol class=""><li id="f5ec" class="lg lh hi jx b jy kq kb kr ji li jm lj jq lk kn ll lm ln lo bi translated">检查ppp0接口上是否接收到目的端口为2222/TCP且SYN标志为on的数据包，并将源IP地址添加到<em class="ko"> KNOCK_FIRST </em>地址列表中，过期时间为15秒。</li><li id="8e04" class="lg lh hi jx b jy lp kb lq ji lr jm ls jq lt kn ll lm ln lo bi translated">检查是否通过KNOCK_FIRST地址列表中的IP地址在ppp0接口上接收到目的端口为3333/UDP的数据包，并将源IP地址添加到<em class="ko"> KNOCK_SECOND </em>地址列表，过期时间为10秒(我减少了超时时间，因为完成<em class="ko">魔术序列</em>需要更少的数据包)。</li><li id="e69e" class="lg lh hi jx b jy lp kb lq ji lr jm ls jq lt kn ll lm ln lo bi translated">检查ppp0接口上的KNOCK_SECOND地址列表中的IP地址是否接收到目标端口为4444/TCP且SYN标志为on的数据包，并将源IP地址添加到TRUSTED_SOURCES地址列表中，过期时间为10秒，这是客户端必须开始连接临时公开服务的时间范围。</li><li id="7571" class="lg lh hi jx b jy lp kb lq ji lr jm ls jq lt kn ll lm ln lo bi translated">实现一个转发规则，允许从TRUSTED_SOURCES到IP 192.168.0.100的端口22/TCP上的intranet服务的新会话(我们仍然允许已建立的/相关的会话继续进行，而不检查源)。</li></ol><h2 id="efa0" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">MikroTik实现示例</h2><p id="9ba0" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">这是MikroTik的实现:</p><figure class="kv kw kx ky fd kz"><div class="bz dy l di"><div class="la lb l"/></div><figcaption class="lc ld et er es le lf bd b be z dx translated">RouterOS配置</figcaption></figure><p id="278d" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">在这里，您可以看到以更易读的语法高亮格式显示的配置(我使用的是带有MikroTik语法高亮显示的Sublime-Text):</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mf"><img src="../Images/75de7cc42ce63c92aba9b896d05fbb59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q_4pYbxGDNOGVjAQZMpzNQ.png"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">RouterOS配置</figcaption></figure><p id="5adf" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">您可以使用以下命令监控地址列表中公共IP地址的插入:</p><pre class="kv kw kx ky fd lu lv lw lx aw ly bi"><span id="f976" class="ix iy hi lv b fi lz ma l mb mc">[admin@MikroTik] &gt; /ip firewall address-list print <br/>Flags: X - disabled, D - dynamic <br/># LIST              ADDRESS CREATION-TIME TIMEOUT <br/>0 D KNOCK_FIRST     x.x.x.x jun/15/2020   15:17:30 12s <br/>1 D KNOCK_SECOND    x.x.x.x jun/15/2020   15:17:30 8s <br/>2 D TRUSTED_SOURCES x.x.x.x jun/15/2020   15:17:30 9s</span></pre><h2 id="c9d6" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">从移动客户端敲门</h2><p id="7fc4" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">在前面的章节中，我已经向您展示了如何使用nmap从计算机敲门，但是如果您需要通过智能手机或平板电脑连接到您的家庭服务器呢？您可以很容易地找到端口敲门应用程序，如iOS上的Port Knock，它允许您指定要发送的TCP/UDP数据包的序列，发送神奇序列后要探测的端口，甚至允许您通过SSH等协议建立连接(我更喜欢使用专用客户端，如iOS上的Prompt)。也许我们使用的10秒超时太短了，如果你计划通过移动设备使用不同的应用程序进行端口敲门和SSH连接，我认为你可以安全地将它增加到20-30秒。</p><p id="47a4" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated">下面是一个端口敲门iOS应用程序配置的例子，它敲门到端口2222/TCP、3333/UDP、4444/TCP上的myhomenetwork.no-ip.org，然后探测端口1022/TCP以检查它是否打开，为您提供关于您的家庭路由器接收神奇序列的即时反馈(它还在敲门后使用用户<em class="ko"> myuser </em>启动到端口1022的SSH连接，但是如果您想使用其他客户端进行SSH连接，可以省略这一步)</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mm"><img src="../Images/8bae79eaf0aa7df784a75f326d73cbcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ky7Rdd0nLjjbZdHzR9WsSg.jpeg"/></div></div></figure><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mm"><img src="../Images/806d1e8a3282bad7b49ad27632b558c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qb9heAvX_YOcQ3N1ddPMpA.jpeg"/></div></div></figure><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mm"><img src="../Images/632da3b808fc1b11ebd35059b74e768c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GKNkBSN1yekqxcinAcWcKA.jpeg"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">IOS端口敲门</figcaption></figure><h2 id="6ccf" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">结论</h2><p id="fdfc" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">我希望这篇文章对那些想让自己的家庭网络少受互联网威胁的人有用。同样，您可以在将MikroTik云路由器应用到您的网络中之前，或者在说服自己购买他们令人惊叹的路由器之前，尝试一下我在EVE-NG上展示的配置。</p></div><div class="ab cl mn mo gp mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="hb hc hd he hf"><p id="d5a8" class="pw-post-body-paragraph jv jw hi jx b jy kq ij ka kb kr im kd ji ks kf kg jm kt ki kj jq ku kl km kn hb bi translated"><em class="ko">原载于2020年6月15日http://networkingpills.wordpress.com</em><a class="ae kp" href="https://networkingpills.wordpress.com/2020/06/15/knock-knock-can-you-open-the-firewall-mikrotik-practical-example/" rel="noopener ugc nofollow" target="_blank"><em class="ko"/></a><em class="ko">。</em></p></div></div>    
</body>
</html>