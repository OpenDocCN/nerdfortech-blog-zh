<html>
<head>
<title>Helm &amp; Kubernetes | Create Helm Charts and how to push them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Helm &amp; Kubernetes |创建掌舵图以及如何推动它们</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/helm-kubernetes-create-helm-charts-and-how-to-push-them-c741edf11f1e?source=collection_archive---------4-----------------------#2021-03-26">https://medium.com/nerd-for-tech/helm-kubernetes-create-helm-charts-and-how-to-push-them-c741edf11f1e?source=collection_archive---------4-----------------------#2021-03-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c4bc5ba2c003e1191882eaa901771a16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jaGtLFVPkmteahal"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">戴维·诺克斯在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="16a4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这篇文章中，我想谈谈什么是 Helm，如何安装和使用它，以及如何将它的图像推送到 artifactory。这听起来像是一大堆东西，实际上也是，但这是 CI/CD 中非常重要的一步，所以我会尽可能解释清楚。</p><h1 id="9e9a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">什么是头盔</h1><p id="1498" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">简而言之，<a class="ae iu" href="https://helm.sh" rel="noopener ugc nofollow" target="_blank"> Helm </a>是 Kubernetes 的一个包管理器，它允许开发者和运营商更容易地将应用和服务打包、配置和部署到 Kubernetes 集群上。</p><p id="6e81" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Helm 有机会为 Kubernetes 设置变量，然后您可以将这些变量分配给不同的 Kubernetes 对象。</p><p id="9fa0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者用<a class="ae iu" href="https://helm.sh" rel="noopener ugc nofollow" target="_blank">官网</a>的话说:</p><blockquote class="kw kx ky"><p id="4853" class="iv iw kz ix b iy iz ja jb jc jd je jf la jh ji jj lb jl jm jn lc jp jq jr js hb bi translated">Helm 帮助您管理 Kubernetes 应用程序——Helm 图表帮助您定义、安装和升级最复杂的 Kubernetes 应用程序。</p><p id="cab9" class="iv iw kz ix b iy iz ja jb jc jd je jf la jh ji jj lb jl jm jn lc jp jq jr js hb bi translated">图表易于创建、版本化、共享和发布，所以开始使用 Helm，停止复制和粘贴。</p></blockquote><h1 id="486d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">如何安装头盔</h1><p id="5333" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated"><a class="ae iu" href="https://brew.sh/index_de" rel="noopener ugc nofollow" target="_blank">家酿</a>:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="3320" class="lm ju hi li b fi ln lo l lp lq">$ brew install helm</span></pre><p id="606d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://chocolatey.org/" rel="noopener ugc nofollow" target="_blank">巧克力</a>:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="f6ae" class="lm ju hi li b fi ln lo l lp lq">$ choco install kubernetes-helm</span></pre><p id="ee1f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">来源:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="1372" class="lm ju hi li b fi ln lo l lp lq">$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3<br/>$ chmod 700 get_helm.sh<br/>$ ./get_helm.sh</span></pre><p id="4389" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有关如何安装 Helm 的更多信息，请访问<a class="ae iu" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank">官方网站</a>。</p><h1 id="418d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">头盔如何工作</h1><p id="cb33" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">要使用 Helm，您的电脑上需要安装 Kubernetes。如果情况不是这样，安装<a class="ae iu" href="https://kubernetes.io/de/docs/setup/minikube/" rel="noopener ugc nofollow" target="_blank"> MiniKube </a>或者在 Docker 桌面中启用 Kubernetes 集群。</p><h2 id="607b" class="lm ju hi bd jv lr ls lt jz lu lv lw kd jg lx ly kh jk lz ma kl jo mb mc kp md bi translated">单线安装</h2><p id="d6c2" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">Helm 管理您的所有 Kubernetes 文件，并安装、更改和删除其所有内容。Helm 会自动应用其“模板”目录中的每个 Kubernetes Yaml 文件。只需一个简单的 cli 命令就可以安装整个 K8s 应用程序:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="ae95" class="lm ju hi li b fi ln lo l lp lq">$ helm install APP_NAME CHART_NAME</span></pre><h2 id="8e96" class="lm ju hi bd jv lr ls lt jz lu lv lw kd jg lx ly kh jk lz ma kl jo mb mc kp md bi translated">中央值存储</h2><p id="9f70" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">这还不是全部。Helm 有一个<a class="ae iu" href="https://helm.sh/docs/chart_template_guide/values_files/" rel="noopener ugc nofollow" target="_blank"> Values.yaml 文件</a>，其中可以存储定义 Kubernetes 对象所需的所有数据。然后，您的 K8s 文件可以引用这个 Values.yaml 文件并使用这些值。使用 Helm 你可以防止在不同的 K8s 资源中复制粘贴 10 次完全相同的名字。我们稍后会看一个例子，所以请继续阅读。</p><h2 id="55a9" class="lm ju hi bd jv lr ls lt jz lu lv lw kd jg lx ly kh jk lz ma kl jo mb mc kp md bi translated">部署时覆盖值</h2><p id="eb84" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">使用 Helm，您可以在部署时覆盖 Values.yaml 文件的一些值。您可以通过添加— set 标志并在后面添加一个键和值来实现这一点。<a class="ae iu" href="https://helm.sh/docs/helm/helm_install/#options" rel="noopener ugc nofollow" target="_blank">安装命令</a>可能看起来像这样:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="8a92" class="lm ju hi li b fi ln lo l lp lq">$ helm install APP_NAME CHART_NAME --set deployment.image=nginx</span></pre><h2 id="85a5" class="lm ju hi bd jv lr ls lt jz lu lv lw kd jg lx ly kh jk lz ma kl jo mb mc kp md bi translated">包装图表</h2><p id="500e" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">有了 Helm，你不仅有机会在本地运行你的 Helm-Charts，不，你还可以打包它们并上传到你的个人 Helm-Repo。如果你有一个舵图准备部署，你只需要运行:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="095b" class="lm ju hi li b fi ln lo l lp lq">$ helm package CHART_NAME --version=MAJOR.MINOR.PATCH</span></pre><p id="c195" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你实际上不必使用 M.M.P 版本控制，但是使用<a class="ae iu" href="https://semver.org/lang/de/" rel="noopener ugc nofollow" target="_blank">语义版本控制</a>确实是一个好的实践。</p><p id="1ac6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">无聊的理论说够了，我们先来举个小例子。</p><h1 id="f6b1" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Nginx 示例</h1><p id="67b7" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">首先，这个例子非常简单，只需在集群或 MiniKube 上部署一个带有服务的 Nginx 应用程序。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="3a9f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如您在这里看到的，实际上只有一个绑定了服务的基本部署。现在，我们将尝试为这个应用程序创建一个新的舵图。</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="f569" class="lm ju hi li b fi ln lo l lp lq">$ helm create HELM-CHART-NAME</span></pre><p id="d76a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将在项目的根目录下创建一个新的舵图。如果您打开该文件夹，您将看到它包含几个子目录和 yaml 文件。</p><ol class=""><li id="5af5" class="mg mh hi ix b iy iz jc jd jg mi jk mj jo mk js ml mm mn mo bi translated">第一个是图表目录。你暂时不必理会它。</li><li id="331a" class="mg mh hi ix b iy mp jc mq jg mr jk ms jo mt js ml mm mn mo bi translated">第二个是<a class="ae iu" href="https://helm.sh/docs/chart_template_guide/helm_ignore_file/" rel="noopener ugc nofollow" target="_blank">。helmignore </a>文件。它具有与类似的属性。git 忽略 git 的文件。您可以配置打包时哪些文件不会添加到您的 helm hart 中。</li><li id="8ae8" class="mg mh hi ix b iy mp jc mq jg mr jk ms jo mt js ml mm mn mo bi translated">Chart.yaml 文件包含一些关于图表本身和应用程序版本的信息。每次改完都可以改。</li><li id="0f9a" class="mg mh hi ix b iy mp jc mq jg mr jk ms jo mt js ml mm mn mo bi translated">values.yaml 文件包含模板目录中文件所需的所有值。</li><li id="bc46" class="mg mh hi ix b iy mp jc mq jg mr jk ms jo mt js ml mm mn mo bi translated">模板目录包含 Helm 执行的每个文件。有些文件是默认存在的，在大多数情况下你可以忽略它们。如果部署成功，它们可以帮助您创建入口或生成控制台输出。</li></ol><h2 id="8a94" class="lm ju hi bd jv lr ls lt jz lu lv lw kd jg lx ly kh jk lz ma kl jo mb mc kp md bi translated">使用 values.yaml 文件</h2><ol class=""><li id="fc11" class="mg mh hi ix b iy kr jc ks jg mu jk mv jo mw js ml mm mn mo bi translated">将 K8s 文件添加到模板目录中。</li><li id="118a" class="mg mh hi ix b iy mp jc mq jg mr jk ms jo mt js ml mm mn mo bi translated">查看您的 K8s 文件，搜索您可以替换的值，通常有很多，并将它们添加到您的 values.yaml 文件中。</li></ol><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="91a2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这看起来比这个大 K8s 文件简单多了，对吧？这会儿没用，所以我们也需要改变其他文件，使用这个文件的值。</p><figure class="ld le lf lg fd ij"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="0526" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用来引用这些值。值，然后是文件中定义的层次结构。通过这种方式，您可以确保在您需要的地方有相同的值，并且打字错误几乎是过去的事情。</p><h2 id="32ca" class="lm ju hi bd jv lr ls lt jz lu lv lw kd jg lx ly kh jk lz ma kl jo mb mc kp md bi translated">安装您的第一个图表</h2><p id="558d" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">至此，您已经配置了第一个图表。您现在可以安装它:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="ce0e" class="lm ju hi li b fi ln lo l lp lq">$ helm install nginx-app nginx-chart</span></pre><p id="2b0a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果一切正常，您应该能够在 localhost:30001 上看到 nginx 欢迎屏幕</p><p id="8d68" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您想升级您的部署，您可以只使用设置命令来改变，例如图像。</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="77fe" class="lm ju hi li b fi ln lo l lp lq">$ helm upgrade nginx-app --set nginx.deployment.image=nginx:1.7</span></pre><p id="d665" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在那之后，你现在应该看到豆荚被换出了正确的图像。</p><h2 id="ec20" class="lm ju hi bd jv lr ls lt jz lu lv lw kd jg lx ly kh jk lz ma kl jo mb mc kp md bi translated">打包您的图表</h2><p id="ddf0" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">如果您不仅希望在本地部署图表，还必须将它们打包并推送到 artifactory。重要的是，您已经将所有不想打包的文件添加到。helmignore 文件。如果已经是这种情况，只需运行:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="897e" class="lm ju hi li b fi ln lo l lp lq">$ helm package nginx-chart --version=1.0.0</span></pre><p id="674d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这将在舵图表的基础上创建一个新的舵包。看起来像是:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="9b74" class="lm ju hi li b fi ln lo l lp lq">nginx-chart-1.0.0.tgz</span></pre><h2 id="52c5" class="lm ju hi bd jv lr ls lt jz lu lv lw kd jg lx ly kh jk lz ma kl jo mb mc kp md bi translated">推动你的图表</h2><p id="6437" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">为了推动我们的图表，我们可以使用旋度。在我看来这是最简单的方法。</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="0b6f" class="lm ju hi li b fi ln lo l lp lq">$ curl -u username:password -T nginx-chart-1.0.0.tgz \<br/><a class="ae iu" href="https://YOUR-HELM-CHART" rel="noopener ugc nofollow" target="_blank">https://YOUR-HELM-CHAR</a>T-REPO/nginx-chart-1.0.0.tgz</span></pre><p id="06ff" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">另一种方法是直接使用头盔:</p><pre class="ld le lf lg fd lh li lj lk aw ll bi"><span id="98fe" class="lm ju hi li b fi ln lo l lp lq">$ helm push <!-- -->nginx-chart-1.0.0.tgz<!-- --> \ <br/><a class="ae iu" href="https://YOUR-HELM-CHART-REPO" rel="noopener ugc nofollow" target="_blank">http://</a><a class="ae iu" href="https://YOUR-HELM-CHART-REPO" rel="noopener ugc nofollow" target="_blank">username:password</a>@<a class="ae iu" href="https://YOUR-HELM-CHART" rel="noopener ugc nofollow" target="_blank">YOUR-HELM-CHAR</a>T-REPO</span></pre><p id="5c3f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这之后，你应该可以在你的头盔-海图-注册表中看到你推送的海图。</p><h1 id="274f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">反射</h1><h1 id="748b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">什么进展顺利？</h1><p id="876c" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">这个包装非常好用。它在第一次尝试时工作得非常好，并且不需要任何配置。此外，初始化工作相当不错，不需要太多的变化。</p><h1 id="40fd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">有哪些需要改进的地方？</h1><p id="6d22" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">唯一不顺利的是，我在部署中使用了错误的 values.yaml 文件值。因为您可以在以后描述 Kubernetes 对象，或者直接在您的 IDE 中看到它，如果某个值是可能的，那么解决它是相当容易的。</p><p id="e971" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望你能学到一些东西。快乐驾驶！😊</p></div></div>    
</body>
</html>