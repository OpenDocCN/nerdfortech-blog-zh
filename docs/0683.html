<html>
<head>
<title>Working on Bulk Data with MongoDB, Node.js &amp; Streams!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MongoDB、Node.js和Streams处理批量数据！</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/transform-export-bulk-database-response-without-memory-overflow-using-mongodb-node-js-streams-bcbb3415dd9c?source=collection_archive---------0-----------------------#2021-02-04">https://medium.com/nerd-for-tech/transform-export-bulk-database-response-without-memory-overflow-using-mongodb-node-js-streams-bcbb3415dd9c?source=collection_archive---------0-----------------------#2021-02-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ce2cdaf9edb273a5e1919bfac434142b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s6bek84hFgXJBt88"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@casparrubin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卡斯帕·卡米尔·鲁宾</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="c4f4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最近，我不得不在MongoDB <strong class="ix hj"> ~50 Mn </strong>文档中查询一个非常大的数据集，并且大约有<strong class="ix hj"> ~0.5 Mn </strong>的响应被处理并以所需的格式导出到<code class="du jt ju jv jw b"><em class="jx">csv</em></code>文件。</p><p id="6882" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注:如果赶时间，完整的解决方案附在最后，否则，我会推荐通读。</p><p id="cc41" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了更好地理解，我们将继续一个例子，在这个例子中，我们将需要填充数据库中的空数据列。</p><p id="ffe6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以，我在这里是为了让你更容易，如果你遇到类似的事情。我将把解决方案分成几个小部分:</p><ol class=""><li id="da1e" class="jy jz hi ix b iy iz jc jd jg ka jk kb jo kc js kd ke kf kg bi translated">从文件<em class="jx">获取查询输入。xlsx(可选)</em></li><li id="13f7" class="jy jz hi ix b iy kh jc ki jg kj jk kk jo kl js kd ke kf kg bi translated">设置数据库连接，准备触发🔥</li><li id="568e" class="jy jz hi ix b iy kh jc ki jg kj jk kk jo kl js kd ke kf kg bi translated">自定义流来转换数据<em class="jx">(可选)</em></li><li id="36e1" class="jy jz hi ix b iy kh jc ki jg kj jk kk jo kl js kd ke kf kg bi translated">csv字符串流:生成CSV友好数据<em class="jx">(可选)</em></li><li id="91d7" class="jy jz hi ix b iy kh jc ki jg kj jk kk jo kl js kd ke kf kg bi translated">将数据导出到输出<em class="jx"> (process.stdout或。csv文件)</em></li></ol><p id="040d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jx">够了，该码了！</em></p></div><div class="ab cl km kn gp ko" role="separator"><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr ks"/><span class="kp bw bk kq kr"/></div><div class="hb hc hd he hf"><h1 id="9988" class="kt ku hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">从文件中输入查询数据进行查询</h1><p id="a222" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">从中读取数据。xlsx文件，我会用<code class="du jt ju jv jw b"><em class="jx">xlsx</em></code>包。带有一些要填充的字段的示例输入文件:</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/3067fe25f82f3de6471de1be3ee2fde0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iFCs9kPC5ZdCI9vTNFHkag.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">输入参数的input.xlsx文件</figcaption></figure><p id="84ab" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这里，我们需要从数据库中的用户集合中填充<strong class="ix hj">名称、电子邮件</strong>。首先，我们在一个数组中收集来自工作表<em class="jx"> (userId) </em>的输入，并查询数据库。</p><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">读书。查询参数的xlsx文件</figcaption></figure><p id="a561" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们有了查询的参数。让我们进行下一步。</p><h1 id="c6f4" class="kt ku hi bd kv kw md ky kz la me lc ld le mf lg lh li mg lk ll lm mh lo lp lq bi translated">设置数据库连接</h1><p id="94cd" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">是时候连接数据库了，我们将使用<code class="du jt ju jv jw b">connectDB</code>函数发起一个连接，并在<code class="du jt ju jv jw b">main</code>函数<em class="jx">(魔法发生的地方)</em>中调用它。</p><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">节点中的mongoDB连接</figcaption></figure><p id="9b7e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你仔细观察，我们没有用promise处理数据库查询响应，而是使用了一个游标，这将是我们的<a class="ae iu" href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream" rel="noopener ugc nofollow" target="_blank"> <strong class="ix hj"> ReadableStream。</strong> </a></p><p id="6792" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用流，我们通过管道将数据流传输到所需的任意多个流，在本例中，是一个自定义转换流、CSV-stringy流和输出流。</p><h1 id="8b63" class="kt ku hi bd kv kw md ky kz la me lc ld le mf lg lh li mg lk ll lm mh lo lp lq bi translated">用于数据转换的自定义流</h1><p id="f326" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">这是最有趣的部分，我们将使用<a class="ae iu" href="https://developer.mozilla.org/en-US/docs/Web/API/TransformStream" rel="noopener ugc nofollow" target="_blank"><strong class="ix hj">transform stream</strong></a><strong class="ix hj">定制一个流处理程序来转换数据。</strong></p><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">自定义流操作示例</figcaption></figure><p id="8425" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个例子中，我们转换了传入的流，就像我们将<em class="jx">的名字和</em>的姓氏组合起来形成<strong class="ix hj">的名字</strong>。</p><p id="574d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在操作之后，简单地将数据传递给<code class="du jt ju jv jw b">this.push()</code>函数，但是在使用您自己的定制流处理管道时，要检查您要传递给下一个流的数据类型，以及管道中的下一个流是否支持该数据类型。</p><blockquote class="mi mj mk"><p id="26ff" class="iv iw jx ix b iy iz ja jb jc jd je jf ml jh ji jj mm jl jm jn mn jp jq jr js hb bi translated">"有些流只接受受限制的数据类型，如:缓冲区，字符串."</p></blockquote><h1 id="f129" class="kt ku hi bd kv kw md ky kz la me lc ld le mf lg lh li mg lk ll lm mh lo lp lq bi translated">CSV丝状流</h1><p id="7df5" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">现在，我们将继续使用另一个流，它将数据转换成一种<em class="jx"> csv </em>友好格式，不要担心，我们不需要实现它，一个包提供了这种现成的格式<code class="du jt ju jv jw b">csv-stringify</code>😁</p><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用csv-stringify生成csv就绪数据</figcaption></figure><p id="5991" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Stringifier返回<strong class="ix hj"> ReadableStream </strong>，我们将把它进一步传送到输出流<em class="jx"> (stdout，file)。</em></p><h1 id="5813" class="kt ku hi bd kv kw md ky kz la me lc ld le mf lg lh li mg lk ll lm mh lo lp lq bi translated">将数据导出到输出流</h1><p id="8ec6" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">最后，我们将在期望的输出流中逐块导出数据。最简单的方法是使用<code class="du jt ju jv jw b">process.stdout</code>流作为:<code class="du jt ju jv jw b">stream = stream.pipe(process.stdout)</code></p><p id="174b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这样，整个数据将在stdout(终端)上流式传输，但是如果我们想将数据存储在一个文件中，这里是如何:</p><figure class="lx ly lz ma fd ij"><div class="bz dy l di"><div class="mb mc l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">使用CSV文件作为输出流的参考</figcaption></figure><h1 id="7752" class="kt ku hi bd kv kw md ky kz la me lc ld le mf lg lh li mg lk ll lm mh lo lp lq bi translated">结论</h1><p id="6c1a" class="pw-post-body-paragraph iv iw hi ix b iy lr ja jb jc ls je jf jg lt ji jj jk lu jm jn jo lv jq jr js hb bi translated">现在，我们已经完成了所有的过程，是时候输出了👀</p><figure class="lx ly lz ma fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lw"><img src="../Images/360bc66fb7296e12e65033e90a54c6c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wBe7ph5T6onP9-kIDIpdhg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">输出. csv</figcaption></figure><p id="ca72" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是所有步骤之后的预期输出文件，数据填充在其他列中。</p><p id="ff53" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">仅此而已！🎉完整文件的链接是:</p><div class="mo mp ez fb mq mr"><a href="https://github.com/dhruv479/dhruv479/blob/main/scripts/stream-mongo-node.js" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab dw"><div class="mt ab mu cl cj mv"><h2 class="bd hj fi z dy mw ea eb mx ed ef hh bi translated">dhruv479/dhruv479</h2><div class="my l"><h3 class="bd b fi z dy mw ea eb mx ed ef dx translated">在GitHub上创建一个帐户，为dhruv479/dhruv479开发做出贡献。</h3></div><div class="mz l"><p class="bd b fp z dy mw ea eb mx ed ef dx translated">github.com</p></div></div><div class="na l"><div class="nb l nc nd ne na nf io mr"/></div></div></a></div><p id="5b95" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">希望你喜欢这篇文章，鼓掌并关注更多。</p></div></div>    
</body>
</html>