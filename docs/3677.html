<html>
<head>
<title>A guide on using HashiCorp’s consul as a KV store for a spring boot application ?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于使用HashiCorp的consul作为弹簧启动应用程序的KV商店的指南？</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/a-guide-on-using-consul-as-a-kv-store-for-a-spring-boot-application-de833979da0f?source=collection_archive---------2-----------------------#2021-06-19">https://medium.com/nerd-for-tech/a-guide-on-using-consul-as-a-kv-store-for-a-spring-boot-application-de833979da0f?source=collection_archive---------2-----------------------#2021-06-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a1a44f6236c7d4a281e19b2809ea35ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BlQ9z_UcfFlw5ctw"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">马丁·亚当斯在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="5b9d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">大家好，在开始实际的指南之前，我将简单介绍一下领事和领事的KV商店功能。</p><p id="5439" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">什么是执政官？</strong></p><p id="8c35" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Consul是HashiCorp于2014年首次发布的软件。<br/>这是一个服务网格解决方案，提供基于DNS的服务发现和分布式键值存储、分段和配置的全功能控制平面，可以单独使用或一起使用来构建完整的服务网格。</p><p id="2c0d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">领事的KV店是什么？</strong></p><p id="e9fc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Consul的KV store是Consul中可用的特性之一，能够存储分布式键值。</p><p id="d8af" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它主要用于动态配置、特征标记、协调、领导者选举，除此之外还有许多其他用途。</p><p id="e79e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">其简单的HTTP API使其易于使用，可以被视为一种行业标准。</p><p id="80ae" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然而，在我的指南中，我将向您解释如何使用consul的KV store功能进行动态配置。</p><p id="1e07" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我考虑了一个简单的spring boot应用程序，它将使用spring consul在运行时将consul值绑定到spring boot应用程序。</p><p id="98bf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">先决条件</strong></p><p id="e4e9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">需要安装哈希公司咨询软件。为此，您可以遵循以下步骤。</p><ol class=""><li id="6aee" class="jt ju hi ix b iy iz jc jd jg jv jk jw jo jx js jy jz ka kb bi translated">下载咨询软件(<a class="ae iu" href="https://www.consul.io/downloads" rel="noopener ugc nofollow" target="_blank">https://www.consul.io/downloads</a>)</li><li id="398c" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">接下来解压缩下载的包</li><li id="b219" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">将可执行文件(如果在Windows操作系统中安装)放在要启动consul代理的文件夹下</li><li id="1581" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">接下来启动命令提示符，并转到consul exec所在的路径</li><li id="d384" class="jt ju hi ix b iy kc jc kd jg ke jk kf jo kg js jy jz ka kb bi translated">接下来，通过键入以下命令检查consul是否可用。</li></ol><p id="b96c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">领事</p><p id="1b9f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果一切正常，你会看到下面的屏幕-</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kh"><img src="../Images/433c485a6f2bbbd258e1ef5b43c663f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aX2CNpBO2Nec-kRFsnAN2A.png"/></div></div></figure><p id="ffdb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">6.最后，我们将通过执行以下命令运行consul代理</p><p id="bc08" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">咨询代理-开发</p><p id="a24a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如下图所示。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es km"><img src="../Images/187b3968af7e7e9d83ae43462fb78a8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NIUbAtubHc7i0mhG-xzsSg.png"/></div></div></figure><blockquote class="kn ko kp"><p id="2df4" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">注意:咨询代理仅推荐用于开发模式。如果希望在consul启动时保留键值对，可以使用以下命令运行consul代理，consul agent-server-bind = 127 . 0 . 0 . 1-data-dir =。/data-bootstrap-expect = 1-node = agent-one-ui</p></blockquote><p id="6561" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦安装了consul，你可以通过点击浏览器http://localhost:8500 url来检查它。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ku"><img src="../Images/3638dd5a9d6ef94aedc9b01f0c753241.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5FWpt3gYTi6j2axueNYPZA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">领事浏览器</figcaption></figure><blockquote class="kn ko kp"><p id="81e1" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">注意:如果您有任何问题，请检查默认端口号8500是否可用，否则您需要更改端口号。</p></blockquote><p id="dc7b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦consul启动，我们需要创建consul键值对和文件夹结构。我们可以使用consul UI逐个创建KV对，或者使用带有文件导入的命令提示符一次性生成所有密钥。</p><p id="e056" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是用于在consul中创建kv对的命令consul KV import @/your-file-path/filename . JSON。</p><p id="a13e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是屏幕-</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kv"><img src="../Images/2ebd955c1bfee0fdce5654139146383f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*53W2XQS-XGjG3y3i4uAcGw.png"/></div></div></figure><blockquote class="kn ko kp"><p id="f1ee" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">注意:为了使用文件系统立即创建KV对，我们必须以base 64格式对值进行编码，否则我们将在输入字节4错误处得到非法的base64数据</p></blockquote><p id="5dc0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是我用过的文件-</p><figure class="ki kj kk kl fd ij"><div class="bz dy l di"><div class="kw kx l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">生成KV对的JSON文件</figcaption></figure><blockquote class="kn ko kp"><p id="5707" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">注意:在这个文件中，我们用base 64格式对实际值进行了编码</p></blockquote><p id="b7ba" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面是生成密钥后consul文件夹结构的屏幕-</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ky"><img src="../Images/13f5dc8e00ed823966bd933fca293122.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QE4J07rOGd6o997DqQE3Hg.png"/></div></div></figure><blockquote class="kn ko kp"><p id="e07c" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">注意:如果您想从consul UI创建一个键，您不需要对值进行编码。</p></blockquote><p id="b9b7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">此外，文件夹名称应始终以“<strong class="ix hj">config</strong>name”开头，后跟应用程序主类名，如下所示</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/519d2bb62d4ad39f11b2267ec841b63f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2qTybBDMKwHQnaFUSyv-XA.png"/></div></div></figure><p id="6020" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">现在让我们创建一个循序渐进的指南，以便在一个简单的spring boot应用程序中使用KV pair进行咨询。</strong></p><p id="5802" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了启用consul，我们需要在您的build.gradle文件中包含此依赖项，如下所示</p><figure class="ki kj kk kl fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><blockquote class="kn ko kp"><p id="dcf1" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">注意:spring actuator是强制性的，因此consul会不断检查spring boot应用程序的健康状态</p></blockquote><p id="dc26" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，我们需要创建一个bootstrap.properties文件，并配置这些consul属性，如下所示</p><figure class="ki kj kk kl fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><blockquote class="kn ko kp"><p id="281d" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">注意:应用程序名称应该与已经提到的领事“<strong class="ix hj">配置</strong>”文件夹下创建的文件夹名称相匹配。</p></blockquote><p id="26e9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，我们需要创建一个ApplicationConfig类，并启用@value注释将来自consul的值绑定到应用程序，如下所示</p><figure class="ki kj kk kl fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><blockquote class="kn ko kp"><p id="83e9" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">注意:<strong class="ix hj"> @RefreshScope </strong>注释用于在consul的值发生变化时立即刷新值，而无需重新启动应用程序</p></blockquote><p id="ee37" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，我们需要将@EnableDiscoveryClient注释添加到主应用程序中，如下所示</p><figure class="ki kj kk kl fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="300e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，运行应用程序，如果一切正常，您可以看到如下所示的消息。</p><figure class="ki kj kk kl fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/0445ededae7f0e2d36d48096646539ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wDkTvNNUwCNGQNm8ZRWlHQ.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">应用程序已向consul注册</figcaption></figure><blockquote class="kn ko kp"><p id="1f1e" class="iv iw kq ix b iy iz ja jb jc jd je jf kr jh ji jj ks jl jm jn kt jp jq jr js hb bi translated">注意:如果在consul中未正确配置密钥，或者在spring boot应用程序中将密钥更改为另一个名称，则会出现此错误<strong class="ix hj">无法解析值“$ { spring.consul.test }”</strong>中的占位符“spring . consul . test”，这意味着consul it无法绑定应用程序密钥。</p></blockquote><p id="3ff2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是我们如何使用consul的KV store特性进行动态配置，这在您想要在运行时配置值时非常有用。</p><p id="0dbf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">希望这对我的开发伙伴有所帮助。</p><p id="d666" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请分享你的反馈，无论谁读了这篇文章，这将在某种程度上鼓励我。T13】</p><p id="c26a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> GitHub链接:</strong><a class="ae iu" href="https://github.com/mousumi8/spring-boot-consul/tree/master" rel="noopener ugc nofollow" target="_blank">https://github.com/mousumi8/spring-boot-consul/tree/master</a></p><p id="028c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">参考资料:</strong>https://spring.io/projects/spring-cloud-consulT2，<a class="ae iu" href="https://www.hashicorp.com/products/consul" rel="noopener ugc nofollow" target="_blank">https://www.hashicorp.com/products/consul</a></p></div></div>    
</body>
</html>