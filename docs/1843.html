<html>
<head>
<title>Terraform Import Existing AWS Resources</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform 导入现有 AWS 资源</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/terraform-import-existing-aws-resources-c1f1b4b19f87?source=collection_archive---------0-----------------------#2021-04-10">https://medium.com/nerd-for-tech/terraform-import-existing-aws-resources-c1f1b4b19f87?source=collection_archive---------0-----------------------#2021-04-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/a6fd54db6d0fdb3c5e58cdd89a30e41e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f8s0aV5vLBL7I-Gpg1R6AA.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">还有…也许是高级的😂</figcaption></figure><div class=""/><p id="11e3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用变量和条件语句</p><h1 id="086f" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">在我们开始之前…</h1><p id="b67f" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">确保您有一个 AWS 帐户，以便在您自己的环境中进行测试。你还需要知道如何编写一些基本的地形。在这篇文章中[大部分]我们不会写高级的地形。事实上，在这篇文章发表前几天，我自己从未在 terraform 内部编写过条件语句，直到工作中出现了某种情况。</p><p id="c9b3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="kv">使用案例:</em></p><p id="8ffb" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您的工作场所最近(像大多数公司一样)采用基础设施作为代码(以云不可知的形式)工具 Terraform。最近，已经使用模块(可重用代码)在 terraform 中建立了基础设施，但是您现在需要将所有 ec2 实例、rds 数据库和弹性 IP 导入到您的存储库中。</p><p id="f48a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">令人欣慰的是，HashiCorp 有很好的文档，我们将参考这些文档。</p><h1 id="5f31" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated"><strong class="ak">调教</strong></h1><p id="ebf8" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">在我的 AWS 帐户中，我已经手动启动了 2 个 ec2 实例(t2.micro —免费层)、一个免费层 MySQL rds 实例和 2 个弹性 IP。</p><figure class="kx ky kz la fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kw"><img src="../Images/397b6d7d20c6a47f8792c9b73f036389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tslsJwmJPd4SDSjUnTLNpw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">ec2 实例</figcaption></figure><figure class="kx ky kz la fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lb"><img src="../Images/fb16ae23d29297de11b6da79b4043d82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4dBmxYnbPp_vq7i3NgXE6w.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">弹性 ips</figcaption></figure><figure class="kx ky kz la fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lc"><img src="../Images/a71892f681688d07968148d60a282815.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K-qrG7KSh1j7A798Bqp3mQ.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">rds MySQL 实例</figcaption></figure><h1 id="89fd" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">地形模块</h1><p id="5e07" class="pw-post-body-paragraph iu iv hx iw b ix kq iz ja jb kr jd je jf ks jh ji jj kt jl jm jn ku jp jq jr hb bi translated">许多公司使用被称为可重用代码的模块。模块看起来更整洁，但是“子模块”也称为资源块配置是模块(父模块)的动力，我将简要地指出父模块和子模块的区别。让我们回顾一下我们的地形代码。导入后，当我们从 terraform 计划中获得更多详细信息时，我们可以对我们的 terraform 配置进行更改和添加。</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="c6f0" class="li jt hx le b fi lj lk l ll lm"># --- ec2 instance resources --- #</span><span id="99a0" class="li jt hx le b fi ln lk l ll lm">resource "aws_instance" "tfimportec2" {<br/>ami = var.ami[var.region]<br/>#ami IS REGION SPECIFIC - please check which region you are in if you receive an error<br/>instance_type = var.instance_override == false ? var.instance_type : var.no_instance_type_change<br/>key_name = "tf-demo"<br/>}</span><span id="8c4c" class="li jt hx le b fi ln lk l ll lm">resource "aws_eip" "tfeip1" {<br/>vpc = true <br/>tags = {<br/>  Name = "Tf-eip"<br/> }<br/>}</span><span id="7c78" class="li jt hx le b fi ln lk l ll lm">resource "aws_eip_association" "eip_assoc1" {<br/>instance_id   = aws_instance.tfimportec2.id<br/>allocation_id = aws_eip.tfeip1.id<br/>}</span><span id="00c4" class="li jt hx le b fi ln lk l ll lm"># --- Rds instance resource--- #</span><span id="3b56" class="li jt hx le b fi ln lk l ll lm">resource "aws_db_instance" "tfdatabase" {<br/>engine         = "mysql"<br/>engine_version = "8.0.20"<br/>instance_class = "db.t2.micro"<br/>name           = "tf-import-mysql"<br/>allocated_storage = 20<br/>availability_zone = "us-east-1c"<br/>skip_final_snapshot = true<br/>backup_retention_period = 0<br/>apply_immediately = true<br/>username = var.username</span></pre><p id="1f02" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在我们已经有了一个基线代码(它可能会出错，但是我们会在出现错误时处理它)</p><h1 id="e030" class="js jt hx bd ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp bi translated">地形条件句</h1><div class="hh hi ez fb hj lo"><a href="https://www.terraform.io/docs/language/expressions/conditionals.html" rel="noopener  ugc nofollow" target="_blank"><div class="lp ab dw"><div class="lq ab lr cl cj ls"><h2 class="bd hy fi z dy lt ea eb lu ed ef hw bi translated">条件表达式-配置语言- Terraform</h2><div class="lv l"><h3 class="bd b fi z dy lt ea eb lu ed ef dx translated">实践:尝试 HashiCorp Learn 上的创建动态表达式教程。条件表达式使用…的值</h3></div><div class="lw l"><p class="bd b fp z dy lt ea eb lu ed ef dx translated">www.terraform.io</p></div></div><div class="lx l"><div class="ly l lz ma mb lx mc hp lo"/></div></div></a></div><p id="0aeb" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这是使用变量、值或 null 来完成不同导入情况的关键。</p><p id="659a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用案例:</p><p id="e51c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您的公司有一个使用旧实例类型的旧客户。您不想停止它们的 ec2 实例或强制重新创建，所以您需要一个值来覆盖它。Terraform conditional 使用简单的逻辑来实现这个目标。我们将涵盖条件的一个选项，以免混淆:</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="c4ac" class="li jt hx le b fi lj lk l ll lm">condition ? true_val : false_val</span></pre><p id="e761" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们将其与 aws_instance 资源的 instance_type 属性进行比较。</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="61ea" class="li jt hx le b fi lj lk l ll lm">instance_type = var.instance_override == false ? var.instance_type : var.set_instance_type</span></pre><p id="9552" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">解释:我们的 instance_type 的值将等于变量 instance_override 的值(这是一个布尔值类型—真/假)，它等于“假”然后(？)terraform 将评估并选择正确的陈述(位于:)。如果 instance_override 的值等于“true ”,则该语句将被呈现为 false，并为我们提供 var.set_instance_type 的值或 false 语句:var.set_instance_type 或(:)的 right</p><p id="35e9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">因此，如果我们想要覆盖当前的实例类型，将 var.instance_override 设置为 true，并将 set_instance_type 的变量更改为类似 t3.micro 的值。</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="f23b" class="li jt hx le b fi lj lk l ll lm"># --- Partent Module Variables ---child module variables should be empty or default to false ---</span><span id="5b06" class="li jt hx le b fi ln lk l ll lm">variable "instance_override" {<br/>type = bool<br/>default = true<br/>}</span><span id="6bad" class="li jt hx le b fi ln lk l ll lm">variable "instance_type" {<br/>type = string<br/>default = "t3.micro"<br/>}</span></pre><p id="2da2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">新地形图:</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="f987" class="li jt hx le b fi lj lk l ll lm"># module.instance.aws_instance.tfimportec2[0] will be updated in-place<br/>  ~ resource "aws_instance" "tfimportec2" {<br/>        id                           = "i-078654854b88d8fe8"<br/>      ~ instance_type                = "t2.micro" -&gt; "t3.micro"<br/>        tags                         = {<br/>            "Name"              = "ec2One"<br/>            "Terraform Managed" = "False"<br/>        }<br/>        # (27 unchanged attributes hidden)</span><span id="94cc" class="li jt hx le b fi ln lk l ll lm"># (6 unchanged blocks hidden)<br/>    }</span></pre><p id="c6cc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在让我们开始将 ec2 实例导入到模块中…下面首先是父模块。</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="5c45" class="li jt hx le b fi lj lk l ll lm"># --- PARENT MODULE --- this calls on the child module which contains the meat and potatoes of the config --- #</span><span id="085f" class="li jt hx le b fi ln lk l ll lm">module "instance" {<br/>source = "../"</span><span id="f435" class="li jt hx le b fi ln lk l ll lm">#note: if you are using a git repo you can use the same link from the clone/download option for the source attribute above, but it will only read from master. Check terraform doucmentation on how to read from branches other than master</span><span id="e189" class="li jt hx le b fi ln lk l ll lm">instance_override = var.instance_override <br/># or you can just enter the boolen value above true or false</span><span id="c528" class="li jt hx le b fi ln lk l ll lm">set_instance_type = var.set_instance_type<br/># or you can enter the instance_type in "string" format</span><span id="906a" class="li jt hx le b fi ln lk l ll lm">region = var.region<br/>#or you can enter the region in "string" format<br/>}</span></pre><p id="b9a2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">注意:子模块变量取代父模块变量，除非它们在模块块中明确定义。最佳实践是让子模块变量为 null 或空" "，这样您就可以在父模块变量中设置它们。</p><p id="cd2a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">导入我们的 AWS 资源的命令:</p><p id="fa03" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae md" href="https://www.terraform.io/docs/cli/commands/import.html" rel="noopener ugc nofollow" target="_blank">https://www.terraform.io/docs/cli/commands/import.html</a></p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="332d" class="li jt hx le b fi lj lk l ll lm">terraform init</span></pre><p id="77fc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Ec2 导入:</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="0e5d" class="li jt hx le b fi lj lk l ll lm">terraform import module.&lt;module name&gt;.aws_instance.&lt;instance name from tf&gt; &lt;instance id from aws&gt;</span><span id="68cf" class="li jt hx le b fi ln lk l ll lm">terraform import module.instance.aws_instance.tfimportec2 i-078654854b88d8fe8</span><span id="e336" class="li jt hx le b fi ln lk l ll lm">Elastic ip assocaited with the instance:</span><span id="0d5b" class="li jt hx le b fi ln lk l ll lm">terraform import module.instance.aws_eip.tfeip1 eipalloc-0f6e1a3dc02ffdf90</span><span id="e65f" class="li jt hx le b fi ln lk l ll lm">terraform import module.instance.aws_eip_association.eip_assoc1 eipassoc-098a46cff0b605ded</span></pre><p id="e1ef" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在尝试导入上述 3 个资源…</p><p id="2a0c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在我们导入之前，您可以看到我目前在 terraform 状态下没有资源</p><figure class="kx ky kz la fd hk er es paragraph-image"><div class="er es me"><img src="../Images/811b30dbbaf67b10f4c70fd441416f39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/format:webp/1*4mO_phnfju0di8Wd_er2vg.png"/></div></figure><p id="3732" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在导入 ec2 实例，然后运行:</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="222b" class="li jt hx le b fi lj lk l ll lm">terraform state list</span></pre><p id="300d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">嘣！我们进去了</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="1eb1" class="li jt hx le b fi lj lk l ll lm">~/Desktop/tfimporttest/modules -- terraform import module.instance.aws_instance.tfimportec2 i-078654854b88d8fe8<br/>module.instance.aws_instance.tfimportec2: Importing from ID "i-078654854b88d8fe8"...<br/>module.instance.aws_instance.tfimportec2: Import prepared!<br/>  Prepared aws_instance for import<br/>module.instance.aws_instance.tfimportec2: Refreshing state... [id=i-078654854b88d8fe8]</span><span id="4f16" class="li jt hx le b fi ln lk l ll lm">Import successful!</span><span id="3ee7" class="li jt hx le b fi ln lk l ll lm">The resources that were imported are shown above. These resources are now in<br/>your Terraform state and will henceforth be managed by Terraform.</span><span id="d0ed" class="li jt hx le b fi ln lk l ll lm">~/Desktop/tfimporttest/modules -- terraform state list<br/>module.instance.aws_instance.tfimportec2 </span></pre><p id="0255" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在运行 terraform 计划，然后您可以添加任何属性来满足该计划。你要看到更新到位不是<strong class="iw hy"> <em class="kv">替换</em> </strong>或者<strong class="iw hy">#部队替换。</strong></p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="ad5f" class="li jt hx le b fi lj lk l ll lm"># module.instance.aws_instance.tfimportec2 will be updated in-place<br/>  ~ resource "aws_instance" "tfimportec2" {<br/>      - iam_instance_profile         = "Ec2Full" -&gt; null<br/>        id                           = "i-078654854b88d8fe8"<br/>      ~ tags                         = {<br/>          - "Name"              = "ec2One" -&gt; null<br/>          - "Terraform Managed" = "False" -&gt; null<br/>        }<br/>        # (27 unchanged attributes hidden)</span><span id="c6a5" class="li jt hx le b fi ln lk l ll lm"># (6 unchanged blocks hidden)<br/>    }<br/></span></pre><figure class="kx ky kz la fd hk er es paragraph-image"><div class="er es mf"><img src="../Images/3c15aa0832a3c7ecacfcfa559d89cb50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*VYuy9sw0PPKRFkFCYk7gOA.png"/></div></figure><p id="b55a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">您将在上面的资源计划中看到，我们需要在资源配置中添加一些东西，以防止删除一些属性(例如，标签，我是实例配置文件)</p><p id="f733" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">新配置:</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="d1ee" class="li jt hx le b fi lj lk l ll lm"># --- CHILD MODULE --- #<br/>resource "aws_instance" "tfimportec2" {<br/>iam_instance_profile  = "Ec2Full"<br/>ami = var.ami[var.region]<br/>#ami IS REGION SPECIFIC - please check which region you are in if you receive an errorinstance_type = var.instance_override == false ? var.instance_type : var.set_instance_typekey_name = "tf-demo"<br/>tags = {<br/>"Name"              = "ec2One"<br/>"Terraform Managed" = "False"<br/> }<br/>}</span></pre><p id="af33" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，导入您想要的以及我们在最终计划中想要的其余任何资源，然后最后讨论“count =”属性，该属性将改变您如何导入从多个相同资源中调配的每个资源。</p><p id="8aaf" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">快速查看导入 rds 资源:</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="040b" class="li jt hx le b fi lj lk l ll lm">terraform import module.&lt;module name&gt;.aws_db_instance.&lt;db instance name from tf&gt; &lt;name of rds db&gt;</span><span id="aea1" class="li jt hx le b fi ln lk l ll lm">terraform import module.instance.aws_db_instance.tfdatabase tf-import-mysql</span></pre><p id="1e97" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在我们的资源应该都显示在 terraform 状态列表下:</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="8bc4" class="li jt hx le b fi lj lk l ll lm">~/Desktop/tfimporttest/modules  terraform state list<br/>module.instance.aws_db_instance.tfdatabase<br/>module.instance.aws_eip.tfeip1<br/>module.instance.aws_eip_association.eip_assoc1<br/>module.instance.aws_instance.tfimportec2</span></pre><p id="eecc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">我仍然有几个更新，但非常小，没有替换:</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="ec49" class="li jt hx le b fi lj lk l ll lm"># module.instance.aws_db_instance.tfdatabase will be updated in-place<br/>  ~ resource "aws_db_instance" "tfdatabase" {<br/>      + apply_immediately                     = true<br/>      ~ backup_retention_period               = 7 -&gt; 0<br/>      ~ copy_tags_to_snapshot                 = true -&gt; false<br/>        id                                    = "tf-import-mysql"<br/>      - max_allocated_storage                 = 21 -&gt; null<br/>        tags                                  = {}<br/>        # (39 unchanged attributes hidden)</span><span id="c48c" class="li jt hx le b fi ln lk l ll lm"># (1 unchanged block hidden)<br/>    }</span><span id="067b" class="li jt hx le b fi ln lk l ll lm"># module.instance.aws_eip.tfeip1 will be updated in-place<br/>  ~ resource "aws_eip" "tfeip1" {<br/>        id                   = "eipalloc-0f6e1a3dc02ffdf90"<br/>      ~ tags                 = {<br/>          ~ "Name" = "eip1" -&gt; "Tf-eip"<br/>        }<br/>        # (11 unchanged attributes hidden)</span><span id="c014" class="li jt hx le b fi ln lk l ll lm"># (1 unchanged block hidden)<br/>    }</span><span id="ba58" class="li jt hx le b fi ln lk l ll lm">Plan: 0 to add, 2 to change, 0 to destroy.</span></pre><p id="4fc3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">任何资源上的 Count 参数:<br/>当导入带有如下 count 参数的资源时，您的 terraform 导入命令必须用单引号将资源的值(count)括起来。</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="a214" class="li jt hx le b fi lj lk l ll lm"># --- ec2 instance resources --- #</span><span id="63ab" class="li jt hx le b fi ln lk l ll lm"># --- CHILD MODULE --- #</span><span id="da20" class="li jt hx le b fi ln lk l ll lm">resource "aws_instance" "tfimportec2" {<br/>count = var.count_id<br/>iam_instance_profile         = "Ec2Full"<br/>ami = var.ami[var.region]<br/>#ami IS REGION SPECIFIC - please check which region you are in if you receive an error<br/>instance_type = var.instance_override == false ? var.instance_type : var.set_instance_type<br/>key_name = "tf-demo"<br/>tags = {<br/>"Name"              = "ec2One"<br/>"Terraform Managed" = "False"<br/> }<br/>}</span><span id="b863" class="li jt hx le b fi ln lk l ll lm"># --- PARENT MODULE ---</span><span id="ea7f" class="li jt hx le b fi ln lk l ll lm">module "instance" {<br/>source = "../"</span><span id="9322" class="li jt hx le b fi ln lk l ll lm"><br/>instance_override = true<br/>set_instance_type = var.instance_type<br/>region = var.region<br/>count = var.count_id<br/>}</span><span id="ec57" class="li jt hx le b fi ln lk l ll lm">#---- add this variable in to both the child and parent module for consistency --- #</span><span id="0357" class="li jt hx le b fi ln lk l ll lm">variable "count_id" {<br/>type = number<br/>default = 2<br/>}</span></pre><p id="0faf" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">导入计数为 2 的 aws_instance，我们将执行设置部分中显示的第二个实例:</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="95f6" class="li jt hx le b fi lj lk l ll lm">terraform import 'module.instance.aws_instance.tfimportec2[1]' i-02cd6a5f093b9e204</span></pre><p id="68c2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">[1]作为第二个实例，因为我们已经导入了第一个实例，它应该是具有正确 id 的[0]。对于 eip 和 eip_association，您必须在导入之前使用 count.index 值。</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="d1f8" class="li jt hx le b fi lj lk l ll lm">resource "aws_eip" "tfeip1" {<br/>count = var.count_id<br/>instance = aws_instance.tfimportec2[count.index].id<br/>vpc = true<br/>tags = {<br/>Name = "Tf-eip"<br/> }<br/>}</span><span id="1dc5" class="li jt hx le b fi ln lk l ll lm">resource "aws_eip_association" "eip_assoc1" {<br/>count = var.count_id<br/>instance_id   = aws_instance.tfimportec2[count.index].id<br/>allocation_id = aws_eip.tfeip1[count.index].id<br/>}</span><span id="41a2" class="li jt hx le b fi ln lk l ll lm">~/Desktop/tfimporttest/modules  terraform import 'module.instance.aws_instance.tfimportec2[1]' i-02cd6a5f093b9e204<br/>module.instance.aws_instance.tfimportec2[1]: Importing from ID "i-02cd6a5f093b9e204"...<br/>module.instance.aws_instance.tfimportec2[1]: Import prepared!<br/>  Prepared aws_instance for import<br/>module.instance.aws_instance.tfimportec2[1]: Refreshing state... [id=i-02cd6a5f093b9e204]</span><span id="bd6c" class="li jt hx le b fi ln lk l ll lm">Import successful!</span><span id="8f85" class="li jt hx le b fi ln lk l ll lm">The resources that were imported are shown above. These resources are now in<br/>your Terraform state and will henceforth be managed by Terraform.</span><span id="7fff" class="li jt hx le b fi ln lk l ll lm">~/Desktop/tfimporttest/modules  terraform import 'module.instance.aws_eip.tfeip1[1]' eipalloc-03a089d76beec0c7a                                module.instance.aws_eip.tfeip1[1]: Importing from ID "eipalloc-03a089d76beec0c7a"...<br/>module.instance.aws_eip.tfeip1[1]: Import prepared!<br/>  Prepared aws_eip for import<br/>module.instance.aws_eip.tfeip1[1]: Refreshing state... [id=eipalloc-03a089d76beec0c7a]</span><span id="c718" class="li jt hx le b fi ln lk l ll lm">Import successful!</span><span id="7108" class="li jt hx le b fi ln lk l ll lm">The resources that were imported are shown above. These resources are now in<br/>your Terraform state and will henceforth be managed by Terraform.</span><span id="e879" class="li jt hx le b fi ln lk l ll lm">~/Desktop/tfimporttest/modules  terraform import module.'instance.aws_eip_association.eip_assoc1[1]' eipassoc-03a089d76beec0c7a<br/>module.instance.aws_eip_association.eip_assoc1[1]: Importing from ID "eipassoc-03a089d76beec0c7a"...<br/>module.instance.aws_eip_association.eip_assoc1[1]: Import prepared!<br/>  Prepared aws_eip_association for import<br/>module.instance.aws_eip_association.eip_assoc1[1]: Refreshing state... [id=eipassoc-03a089d76beec0c7a]</span><span id="27c6" class="li jt hx le b fi ln lk l ll lm">Import successful!</span><span id="d4c2" class="li jt hx le b fi ln lk l ll lm">The resources that were imported are shown above. These resources are now in<br/>your Terraform state and will henceforth be managed by Terraform.</span></pre><p id="bed9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在我们已经导入了所有的资源，我们可以运行下面的命令并将其全部删除。</p><pre class="kx ky kz la fd ld le lf lg aw lh bi"><span id="e518" class="li jt hx le b fi lj lk l ll lm">terraform destroy --auto-approve </span></pre><p id="7dfb" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">感谢阅读！如果有任何不清楚的地方，请评论，如果我能帮忙的话，我会回复的！</p></div></div>    
</body>
</html>