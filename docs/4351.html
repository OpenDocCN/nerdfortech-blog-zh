<html>
<head>
<title>Ruby on Rails: Using Tempfile and Fog-AWS Gem to read excel files saved in AWS S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby on Rails:使用 Tempfile 和 Fog-AWS Gem 读取保存在 AWS S3 中的 excel 文件</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/ruby-on-rails-using-tempfile-and-fog-aws-gem-to-read-excel-files-saved-in-aws-s3-3f52faca51de?source=collection_archive---------4-----------------------#2021-07-17">https://medium.com/nerd-for-tech/ruby-on-rails-using-tempfile-and-fog-aws-gem-to-read-excel-files-saved-in-aws-s3-3f52faca51de?source=collection_archive---------4-----------------------#2021-07-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a757beb9257188730c61ffe1c0567c9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dS53Dc4LdVBl_mOj_-4OWA.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图片由<a class="ae iu" href="https://pixabay.com/users/williamscreativity-17210051/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=5469712" rel="noopener ugc nofollow" target="_blank">Williams 创作</a>来自<a class="ae iu" href="https://pixabay.com/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></figcaption></figure><p id="cd8e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3(AWS 简单存储服务)</a>已经成为人们存储文件或图像等对象的流行云服务。更有可能的是，我们需要在应用程序中实现从<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>访问文件或将文件上传到<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>的功能。最近，我也遇到一个需要阅读一堆。xlsx 文件存储在我的 Rails 应用程序中的<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>中，我只是想读取内容，所以将所有文件永久保存在我们的应用程序中并不是一个好主意。在尝试了一些解决方案后，我发现<a class="ae iu" href="https://github.com/fog/fog-aws" rel="noopener ugc nofollow" target="_blank"> Fog-AWS </a> Gem 和 Ruby 类方法:<a class="ae iu" href="https://ruby-doc.org/stdlib-2.5.3/libdoc/tempfile/rdoc/Tempfile.html" rel="noopener ugc nofollow" target="_blank"> Tempfile </a>是实现结果能够满足需要的有用方法。为了分享我如何使用它们，我写了这篇文章。本文分为两部分:第一部分是关于如何使用<a class="ae iu" href="https://github.com/fog/fog-aws" rel="noopener ugc nofollow" target="_blank"> Fog-AWS </a> Gem 来访问存储在<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>中的文件，第二部分是关于如何使用 Ruby Class <a class="ae iu" href="https://ruby-doc.org/stdlib-2.5.3/libdoc/tempfile/rdoc/Tempfile.html" rel="noopener ugc nofollow" target="_blank"> Tempfile </a>方法来存储。xlsx 文件，并在 Rails 应用程序中打开它。</p><h1 id="087e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">访问存储在 AWS S3 中的文件</h1><p id="0f6d" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated"><a class="ae iu" href="https://github.com/fog/fog-aws" rel="noopener ugc nofollow" target="_blank"> Fog-AWS </a>是一个有用的宝石，可以从<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>访问文件，或者从你的 Rails 应用程序上传文件到<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>。只需将这一行添加到您的应用程序的 Gemfile 中，并运行<code class="du kw kx ky kz b">bundle install</code>，然后您就可以开始使用<a class="ae iu" href="https://github.com/fog/fog-aws" rel="noopener ugc nofollow" target="_blank"> Fog-AWS </a>。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="6782" class="li ju hi kz b fi lj lk l ll lm">gem 'fog-aws'</span></pre><h2 id="ebc5" class="li ju hi bd jv ln lo lp jz lq lr ls kd jg lt lu kh jk lv lw kl jo lx ly kp lz bi translated">初始化与 AWS S3 的连接</h2><p id="d70c" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">在从<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>访问文件之前，您需要先连接它。<a class="ae iu" href="https://github.com/fog/fog-aws" rel="noopener ugc nofollow" target="_blank"> Fog-AWS </a>提供一个类<code class="du kw kx ky kz b"><a class="ae iu" href="https://github.com/fog/fog-aws/blob/master/lib/fog/aws/storage.rb" rel="noopener ugc nofollow" target="_blank">Fog::Storage</a></code>来初始化连接。有两种方法连接<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>。一个是使用<code class="du kw kx ky kz b">aws_access_key_id</code>和<code class="du kw kx ky kz b">aws_secret_access_key</code></p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="3c96" class="li ju hi kz b fi lj lk l ll lm">s3 = Fog::Storage.new(<br/>  provider: 'AWS', <br/>  region: 'us-west-2', <br/>  <!-- -->aws_access_key_id<!-- -->: <!-- -->YOUR_<!-- -->S3_ACCESS_KEY,<br/>  <!-- -->aws_secret_access_key: YOUR_<!-- -->S3_SECRET_KEY<br/>)</span></pre><p id="9df9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您的应用程序部署在<a class="ae iu" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html" rel="noopener ugc nofollow" target="_blank"> AWS EC2 </a>上，那么您可以使用另一种方式连接到<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>。那就是使用<a class="ae iu" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html" rel="noopener ugc nofollow" target="_blank"> AWS IAM 角色</a>。通过设置可以访问<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>的特定 EC2 IAM 角色，您的应用程序可以通过在初始化连接时设置<code class="du kw kx ky kz b">use_iam_profile = true</code>来连接到<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="4533" class="li ju hi kz b fi lj lk l ll lm">s3 = Fog::Storage.new(<br/>  provider: 'AWS', <br/>  region: 'us-west-2', <br/>  use_iam_profile: true<br/>)</span></pre></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><h2 id="1cf3" class="li ju hi bd jv ln lo lp jz lq lr ls kd jg lt lu kh jk lv lw kl jo lx ly kp lz bi translated">列出 AWS S3 存储桶中的所有文件和访问文件</h2><p id="323d" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">你可以在一个特定的<a class="ae iu" href="https://searchaws.techtarget.com/definition/AWS-bucket" rel="noopener ugc nofollow" target="_blank"> AWS S3 桶</a>中列出所有的文件。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="91c9" class="li ju hi kz b fi lj lk l ll lm">s3_files = s3.directories.new(key: 'my-bucket').files</span></pre><p id="94a5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了在 AWS S3 中访问文件，类<code class="du kw kx ky kz b"><a class="ae iu" href="https://github.com/fog/fog-aws/blob/master/lib/fog/aws/storage.rb" rel="noopener ugc nofollow" target="_blank">Fog::Storage</a></code>提供了<code class="du kw kx ky kz b">get</code>方法来获取我们需要的文件。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="3ffa" class="li ju hi kz b fi lj lk l ll lm">s3_file = s3.directories.new(key: 'my-bucket')<br/>                        .files<br/>                        .get('my_folder/test.xlsx')</span></pre><p id="ba7d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从 AWS S3 获取文件后，我们不能直接打开它，因为它只是一个如下的<code class="du kw kx ky kz b"><a class="ae iu" href="http://fog.io.s3-website-us-east-1.amazonaws.com/0.10.0/rdoc/Fog/Storage/AWS/File.html" rel="noopener ugc nofollow" target="_blank">Fog::Storage::AWS::File</a></code>对象，我们应该通过 URL 解析它。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="38f0" class="li ju hi kz b fi lj lk l ll lm">&lt;Fog::Storage::AWS::File<br/>    key="my_folder/test.xlsx",<br/>    cache_control=nil,<br/>    content_disposition=nil,<br/>    content_encoding=nil,<br/>    content_length=5488,<br/>    content_md5=nil,<br/>    content_type="binary/octet-stream",<br/>    etag="38eed92f509046d915583875dd45454f",<br/>    expires=nil,<br/>    last_modified=2021-07-13 03:41:48 +0000,<br/>    metadata={"x-amz-id-2"=&gt;"XXX", "x-amz-request-id"=&gt;"XXX"},<br/>    owner=nil,<br/>    storage_class=nil,<br/>    encryption=nil,<br/>    encryption_key=nil,<br/>    version=nil,<br/>    kms_key_id=nil<br/>  &gt;</span></pre></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><h2 id="7e3f" class="li ju hi bd jv ln lo lp jz lq lr ls kd jg lt lu kh jk lv lw kl jo lx ly kp lz bi translated">创建文件 URL 并解析文件</h2><p id="a23f" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">类<code class="du kw kx ky kz b"><a class="ae iu" href="https://github.com/fog/fog-aws/blob/master/lib/fog/aws/storage.rb" rel="noopener ugc nofollow" target="_blank">Fog::Storage</a></code>提供了创建文件 URL 的 URL 方法。它还允许我们设置 URL 过期的时间。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="ff2b" class="li ju hi kz b fi lj lk l ll lm">s3 = Fog::Storage.new(<br/>  provider: 'AWS', <br/>  region: 'us-west-2', <br/>  use_iam_profile: true<br/>)<br/>s3_file = s3.directories.new(key: 'my-bucket')<br/>                        .files<br/>                        .get('my_folder/test.xlsx')<br/><strong class="kz hj">url = s3_file.url(Time.zone.now + 60)</strong></span></pre><p id="5a4c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在文件 URL 准备好之后，我们可以使用 Ruby 类<code class="du kw kx ky kz b"><a class="ae iu" href="https://docs.ruby-lang.org/en/2.1.0/URI.html" rel="noopener ugc nofollow" target="_blank">URI</a></code>提供的<code class="du kw kx ky kz b">parse</code>方法通过它的 URL 解析文件。解析结果是 Ruby 类<code class="du kw kx ky kz b"><a class="ae iu" href="https://ruby-doc.org/stdlib-2.5.1/libdoc/stringio/rdoc/StringIO.html" rel="noopener ugc nofollow" target="_blank">StringIO</a></code>的一个对象，如下</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="4d1f" class="li ju hi kz b fi lj lk l ll lm">s3_temp_file = URI.parse(url).open</span><span id="397a" class="li ju hi kz b fi mh lk l ll lm">=&gt;#&lt;StringIO:0x0000555e74fe1438 @base_uri=#&lt;URI::HTTPS https://my-bucket.s3-us-west-2.amazonaws.com/my_folder/test.xlsx?X-Amz-Expires=60&amp;X-Amz-Date=20210713T151552Z&amp;X-Amz-Security-Token=XXX#X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIARPKY2DTZXLCOCK65/20210713/us-west-2/s3/aws4_request&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=XXX&gt;, @meta={"x-amz-id-2"=&gt;"XXX", "x-amz-request-id"=&gt;"4MNS2VFY3DT0JKAT", "date"=&gt;"Tue, 13 Jul 2021 15:16:02 GMT", "last-modified"=&gt;"Tue, 13 Jul 2021 03:41:48 GMT", "etag"=&gt;"\"38eed92f509046d915583875dd45454f\"", "accept-ranges"=&gt;"bytes", "content-type"=&gt;"binary/octet-stream", "server"=&gt;"AmazonS3", "content-length"=&gt;"5488"}, <a class="ae iu" href="http://twitter.com/metas" rel="noopener ugc nofollow" target="_blank">@metas</a>={"x-amz-id-2"=&gt;["t+D6xAC6o1MrEwhHjyBFkPdQoBfvTmfQh4ytJ/lAheZ89R/u6yj78d6Secc0AuQhfUODdwedOIQ="], "x-amz-request-id"=&gt;["4MNS2VFY3DT0JKAT"], "date"=&gt;["Tue, 13 Jul 2021 15:16:02 GMT"], "last-modified"=&gt;["Tue, 13 Jul 2021 03:41:48 GMT"], "etag"=&gt;["\"38eed92f509046d915583875dd45454f\""], "accept-ranges"=&gt;["bytes"], "content-type"=&gt;["binary/octet-stream"], "server"=&gt;["AmazonS3"], "content-length"=&gt;["5488"]}, <a class="ae iu" href="http://twitter.com/status" rel="noopener ugc nofollow" target="_blank">@status</a>=["200", "OK"]&gt;</span></pre><p id="8cdd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当阅读对象时，内容不容易使用和理解。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="e30b" class="li ju hi kz b fi lj lk l ll lm">s3_temp_file.read</span><span id="1b63" class="li ju hi kz b fi mh lk l ll lm">=&gt;"PK\x03\x04\x14\x00\x00\x00\b\x00P\x1C\xEER\aAMb\x81\x00\x00\x00\xB1\x00\x00\x00\x10\x00\x00\x00docProps/app.xmlM\x8E=\v\x021\x10D\xFF\xCAq\xBD\xB7A\xC1Bb@\xD0R\xB0\xB2\x0F{\e/\x90dC\xB2B~\xBE9\xC1\x8Fn\x1Eo\x18F\xDF\ng*\xE2\xA9\x0E-\x86T\x8F\xE3\"\x92\x0F\x00\x15\x17\x8A\xB6N]\xA7n\x1C\x97h\xA5cy\x00;\xE7\x91\xCE\x8C\xCFHI`\xAB\xD4\x1E\xA8\t\xA5\x99\xE6M\xFE\x0E\x8EF\x9Fr\x0E\x1E\xADxN\xE6\xEA\xB1pe'\xC3\xA5!\x05\r\xFFrm\xDE\xA9\xD45\xEF&amp;\xF5\x96\x1F\xD6\xF0;i^PK\x03\x04\x14\x00\x00\x00\b\x00P\x1C\xEERt\x80r,\xEF\x00\x00\x00+\x02\x00\x00\x11\x00\x00\x00docProps/core.xml\xCD\x92QK\xC30\x10\xC7\xBF\x8A\xE4\xBD\xBD\xA6\x15\x1D\xA1\xCB\x8BcO\n\x82\x03\xC5\xB7\x90\xDC\xB6`\x93\x86\xE4\xA4\xDD\xB77\xAD[\x87\xE8\a\xF01w\xFF\xFC\xEEwp\xAD\x0EB\xF7\x11\x9Fc\x1F0\x92\xC5t3\xBA\xCE'\xA1\xC3\x9A\x.....</span></pre><p id="d548" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了使用文件内容并对其进行处理，我们应该使用 Ruby 类<code class="du kw kx ky kz b">File</code>将解析结果保存为一个文件，或者使用 Ruby 类<code class="du kw kx ky kz b">Tempfile</code>将其保存为一个临时文件并打开它。在下一节中，我将分享如何使用类<code class="du kw kx ky kz b">Tempfile</code>将解析结果保存为临时文件并打开它。</p></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><h1 id="4d40" class="jt ju hi bd jv jw mi jy jz ka mj kc kd ke mk kg kh ki ml kk kl km mm ko kp kq bi translated">将 Excel 文件保存为临时文件并打开它</h1><p id="6da6" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated"><a class="ae iu" href="https://ruby-doc.org/stdlib-2.5.3/libdoc/tempfile/rdoc/Tempfile.html" rel="noopener ugc nofollow" target="_blank"> Tempfile </a>已经内置了 Ruby 类，我们不需要安装。当您创建一个<a class="ae iu" href="https://ruby-doc.org/stdlib-2.5.3/libdoc/tempfile/rdoc/Tempfile.html" rel="noopener ugc nofollow" target="_blank"> Tempfile </a>对象时，它将创建一个具有唯一文件名的临时文件，您可以对其执行所有常规文件操作，例如读取数据、写入数据、更改其权限等。当一个<a class="ae iu" href="https://ruby-doc.org/stdlib-2.5.3/libdoc/tempfile/rdoc/Tempfile.html" rel="noopener ugc nofollow" target="_blank"> Tempfile </a>对象被垃圾收集时，或者当 Ruby 解释器退出时，其关联的临时文件被自动删除</p><h2 id="d740" class="li ju hi bd jv ln lo lp jz lq lr ls kd jg lt lu kh jk lv lw kl jo lx ly kp lz bi translated">创建临时文件</h2><p id="2c91" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我们可以使用<a class="ae iu" href="https://ruby-doc.org/stdlib-2.5.3/libdoc/tempfile/rdoc/Tempfile.html" rel="noopener ugc nofollow" target="_blank"> Tempfile </a>提供的<code class="du kw kx ky kz b">new</code>或<code class="du kw kx ky kz b">create</code>方法来创建一个临时文件。下面的代码展示了使用<code class="du kw kx ky kz b">new</code>方法创建一个临时文件。这将创建一个文件名包含<code class="du kw kx ky kz b">foo</code>的临时文件</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="016e" class="li ju hi kz b fi lj lk l ll lm">tempfile = Tempfile.new('foo')<br/>=&gt; #&lt;File:/var/folders/57/m85kgny17n70l64v009zhcfhmyj0p9/T/foo20210715-83391-157to5v&gt;</span></pre><p id="7134" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将一些内容写入一个临时文件，它将返回写入了多少字符。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="6197" class="li ju hi kz b fi lj lk l ll lm">tempfile.write('hello world')<br/>=&gt; 11</span></pre><p id="bf4f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果我们想用<code class="du kw kx ky kz b">create</code>方法做和用<code class="du kw kx ky kz b">new</code>方法一样的事情，代码如下，它也创建一个文件名包含<code class="du kw kx ky kz b">foo</code>的临时文件</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="ba9c" class="li ju hi kz b fi lj lk l ll lm">Tempfile.create('foo') do |f|<br/>  f.write('hello world')<br/>end</span></pre><p id="c33f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du kw kx ky kz b">new</code>和<code class="du kw kx ky kz b">create</code>方法的唯一区别是 create 方法接受一个块。</p></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><h2 id="3c70" class="li ju hi bd jv ln lo lp jz lq lr ls kd jg lt lu kh jk lv lw kl jo lx ly kp lz bi translated">设置临时文件类型并读取文件</h2><p id="ec32" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我们可以用特定的文件类型创建一个临时文件，例如。xlsx，。CSV…等。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="8a3e" class="li ju hi kz b fi lj lk l ll lm">Tempfile.new(['foo', '.xlsx'], encoding: 'ascii-8bit')</span><span id="05f0" class="li ju hi kz b fi mh lk l ll lm">=&gt; #&lt;File:/var/folders/57/m85kgny17n70l64v009zhcfhmyj0p9/T/foo20210715-33983-e1vs8.xlsx&gt;</span></pre><p id="1d65" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我们创建了 temp 文件之后，在我们使用它之前，应该将文件内容写入 temp 文件，并且我们应该将文件设置为从第一行开始读取，因为在文件被写入一些内容之后，它将在最后一个新行中被读取，并且没有内容。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="3dcc" class="li ju hi kz b fi lj lk l ll lm">tempfile = Tempfile.new('foo')<br/>tempfile.write('hello world')<br/>tempfile.read</span><span id="dcb1" class="li ju hi kz b fi mh lk l ll lm">=&gt; ""</span></pre><p id="4e0b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以使用类<code class="du kw kx ky kz b"><a class="ae iu" href="https://ruby-doc.org/stdlib-2.5.3/libdoc/tempfile/rdoc/Tempfile.html" rel="noopener ugc nofollow" target="_blank">Tempfile</a></code>提供的<code class="du kw kx ky kz b">rewind</code>方法来设置从第一行读取的临时文件。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="c257" class="li ju hi kz b fi lj lk l ll lm">tempfile = Tempfile.new('foo')<br/>tempfile.write('hello world')<br/>tempfile.rewind<br/>tempfile.read</span><span id="854a" class="li ju hi kz b fi mh lk l ll lm">=&gt; "hello world"</span></pre><p id="26f6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，将来自<a class="ae iu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>的. xlsx 文件保存为临时文件的代码如下</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="8446" class="li ju hi kz b fi lj lk l ll lm">s3_temp_file = URI.parse(url).open            <br/>tempfile = Tempfile.new([test, '.xlsx'], encoding: 'ascii-8bit')            <br/>tempfile.write(s3_temp_file.read)            <br/>tempfile.rewind</span></pre></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><h2 id="99ef" class="li ju hi bd jv ln lo lp jz lq lr ls kd jg lt lu kh jk lv lw kl jo lx ly kp lz bi translated">打开 excel 类型的临时文件(。xlsx)</h2><p id="c8db" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">最后，我们可以开始使用临时文件。tempfile 是一个. xlsx 文件。为了读取这种文件，Gem <a class="ae iu" href="https://github.com/roo-rb/roo" rel="noopener ugc nofollow" target="_blank"> Roo </a>提供了打开它的有用方法。Gem <a class="ae iu" href="https://github.com/roo-rb/roo" rel="noopener ugc nofollow" target="_blank"> Roo </a>也支持打开其他类型的 excel 文件。csv，。xlsm..等等。</p><p id="294a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">只需将<a class="ae iu" href="https://github.com/roo-rb/roo" rel="noopener ugc nofollow" target="_blank"> Roo </a>添加到 Gemfile 并运行<code class="du kw kx ky kz b">bundle install</code>，然后我们就可以使用类<code class="du kw kx ky kz b"><a class="ae iu" href="https://www.rubydoc.info/gems/roo/2.7.1/Roo/Spreadsheet" rel="noopener ugc nofollow" target="_blank">Roo::Spreadsheet</a></code>打开临时文件。</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="02a2" class="li ju hi kz b fi lj lk l ll lm">xlsx = Roo::Spreadsheet.open(tempfile)</span></pre><p id="e170" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">之后。xlsx 文件是打开的，只需指明需要读取的工作表</p><pre class="la lb lc ld fd le kz lf lg aw lh bi"><span id="375b" class="li ju hi kz b fi lj lk l ll lm">sheet = xlsx.sheet(0)</span></pre><p id="505c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后可以使用<code class="du kw kx ky kz b"><a class="ae iu" href="https://www.rubydoc.info/gems/roo/2.7.1/Roo/Spreadsheet" rel="noopener ugc nofollow" target="_blank">Roo::Spreadsheet</a></code>提供的方法访问该表中的所有行和单元格。所有方法的详细信息可以在 Gem <a class="ae iu" href="https://github.com/roo-rb/roo" rel="noopener ugc nofollow" target="_blank"> Roo </a> Github 页面上找到。</p><h1 id="73fb" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">参考</h1><div class="mn mo ez fb mp mq"><a href="https://ruby-doc.org/stdlib-2.5.3/libdoc/tempfile/rdoc/Tempfile.html" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">临时文件</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">用于管理临时文件的实用程序类。当您创建一个 Tempfile 对象时，它将创建一个带有…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">ruby-doc.org</p></div></div></div></a></div><div class="mn mo ez fb mp mq"><a href="https://www.rubyguides.com/2019/05/ruby-tempfile/" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">如何在 Ruby 中创建临时文件</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">创建一个临时文件会给你一个空文件，在你的操作系统中有一个随机的名字</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">www.rubyguides.com</p></div></div><div class="mz l"><div class="na l nb nc nd mz ne io mq"/></div></div></a></div><div class="mn mo ez fb mp mq"><a href="https://github.com/fog/fog-aws" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">雾/雾-自动气象站</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">在使用 fog-aws 之前，将这一行添加到您的应用程序的 Gemfile:中，然后执行:或者自己安装成:这样…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">github.com</p></div></div><div class="mz l"><div class="nf l nb nc nd mz ne io mq"/></div></div></a></div><div class="mn mo ez fb mp mq"><a href="https://github.com/roo-rb/roo" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">鲁迈拉运营公司经常预算/鲁迈拉运营公司</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">Roo 实现了对所有常见电子表格类型的读访问。它可以处理:Excel 2007 - 2013 格式(xlsx，xlsm)…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">github.com</p></div></div><div class="mz l"><div class="ng l nb nc nd mz ne io mq"/></div></div></a></div><div class="mn mo ez fb mp mq"><a href="https://ruby-doc.org/stdlib-2.5.1/libdoc/stringio/rdoc/StringIO.html" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">斯特林乔</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">类别:StringIO - Ruby 2.5.1</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">ruby-doc.org</p></div></div></div></a></div><div class="mn mo ez fb mp mq"><a href="https://docs.ruby-lang.org/en/2.1.0/URI.html" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">模块 URI</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">从给定的枚举生成 URL 编码的表单数据。这会生成 HTML5 中定义的 application/x-www-form-urlencoded 数据…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">docs.ruby-lang.org</p></div></div></div></a></div><div class="mn mo ez fb mp mq"><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html" rel="noopener  ugc nofollow" target="_blank"><div class="mr ab dw"><div class="ms ab mt cl cj mu"><h2 class="bd hj fi z dy mv ea eb mw ed ef hh bi translated">什么是亚马逊 S3？</h2><div class="mx l"><h3 class="bd b fi z dy mv ea eb mw ed ef dx translated">亚马逊简单存储服务(亚马逊 S3)是互联网存储。它旨在使网络规模的计算…</h3></div><div class="my l"><p class="bd b fp z dy mv ea eb mw ed ef dx translated">docs.aws.amazon.com</p></div></div></div></a></div></div></div>    
</body>
</html>