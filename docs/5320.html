<html>
<head>
<title>Benchmarking Your Solution in Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 Go 中对您的解决方案进行基准测试</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/benchmarking-your-solution-in-go-940b528416c?source=collection_archive---------1-----------------------#2021-09-19">https://medium.com/nerd-for-tech/benchmarking-your-solution-in-go-940b528416c?source=collection_archive---------1-----------------------#2021-09-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a0a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们不加猜测地对您的解决方案进行基准测试吧！然后看有没有实质的改善？</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/6b5be37084590a2f066666b4c48ff149.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XWzZQ1DzMXY7SxMJ"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Ryan Quintal 在<a class="ae jt" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="66bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的系统启动并运行之后……在所有的重构会议之后，以确保我们的代码是干净的、可读的和可维护的。那么现在是我们改进这个系统并使它变得更好的时候了。</p><p id="3a60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通常，有几种方法可以获得更好的性能，其中大多数是通过实验实现的。会有这样的问题，如果我使用这个算法，我会得到更好的性能吗？或者如果我用这个库代替另一个库，会有什么显著的区别吗？这些问题可以通过进行基准测试来回答，而无需猜测或手动测试。</p><p id="68df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了基准测试，我们的解决方案就有了证据。如果它没有做得更好，那么我们将转移到另一个解决方案。然后所有这些解决方案可以相互比较，这将是我们更容易选择最好的一个。</p><h1 id="9190" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">从基本的开始</h1><p id="9eb3" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">让我们从一个简单的例子开始。将此代码写入<code class="du kx ky kz la b">main.go</code>文件。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="e107" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们定义了一个简单的函数来模拟某个需要时间来完成的操作，在这个例子中，它是 0 到 100 毫秒之间的随机持续时间。简单易行！</p><p id="be88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们进入基准测试代码。你可以把这个写在<code class="du kx ky kz la b">main_test.go</code>文件里。请记住，基准测试就像任何其他测试代码一样。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="bf90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以通过输入<code class="du kx ky kz la b">go test -bench=.</code>来运行测试。但是通过这样做，您不仅运行了基准测试代码，还运行了测试代码(如果您有测试代码的话)。</p><p id="6456" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以过滤掉测试，确保它只通过运行<code class="du kx ky kz la b">go test -bench=Bench</code>来运行基准测试代码。因为所有的基准函数都需要用<code class="du kx ky kz la b">Bench</code>启动。就像您定义测试函数时在函数名的开头使用单词<code class="du kx ky kz la b">Test</code>一样。如果你想更具体一点，那么你可以用你的基准函数的名字来提供标志<code class="du kx ky kz la b">-bench</code>，例如<code class="du kx ky kz la b">go test -bench=BenchmarkCalculate</code>。</p><p id="d5ba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，基准函数至少运行 1 秒钟。如果基准函数返回时没有经过第二秒，b.N 的值将按 1、2、5、10、20、50…的顺序增加，函数将再次运行。</p><p id="d793" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用命令<code class="du kx ky kz la b">go test -bench=. -benchtime=20s</code>指定基准测试持续时间。这个命令使得基准测试会话需要 20 秒才能完成。</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h1 id="09b3" class="ju jv hi bd jw jx lk jz ka kb ll kd ke kf lm kh ki kj ln kl km kn lo kp kq kr bi translated">基准 RestAPI 应用程序</h1><p id="acb5" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们将继续使用旧的<code class="du kx ky kz la b">Calculate</code>函数，并在 RestAPI 应用程序中使用它。另外，将会有一个额外的函数模拟一个名为<code class="du kx ky kz la b">CalculateSlow</code>的繁重操作。现在，让我们改变我们的<code class="du kx ky kz la b">main.go</code>文件。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="264a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个应用程序非常简单。它只包含一个使用<code class="du kx ky kz la b">Calculate</code>和<code class="du kx ky kz la b">CalculateSlow</code>的端点。我们必须将<code class="du kx ky kz la b">x</code>和<code class="du kx ky kz la b">y</code>指定为查询字符串，然后我们将得到结果。</p><p id="9d58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">标杆代码怎么样？</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="0e5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，与我们之前的代码相比，这段代码更长。这个我一点一点解释。</p><ul class=""><li id="3342" class="lp lq hi ih b ii ij im in iq lr iu ls iy lt jc lu lv lw lx bi translated">您可以像以前一样运行代码。但是现在我们有 3 个基准函数。通过运行命令<code class="du kx ky kz la b">go test -bench=Bench -benchtime=5s</code>。您将得到类似于以下内容的内容:</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ly"><img src="../Images/71ba01bf2af089f638d53eba14fb642f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*id2Tb0mPVfeBhGvEKeF3cQ.png"/></div></div></figure><ul class=""><li id="2f34" class="lp lq hi ih b ii ij im in iq lr iu ls iy lt jc lu lv lw lx bi translated">使用标志<code class="du kx ky kz la b">-benchtime=5s</code>，每个基准函数将至少运行 5 秒钟。</li><li id="c248" class="lp lq hi ih b ii lz im ma iq mb iu mc iy md jc lu lv lw lx bi translated">注意，我们已经定义了一个包级变量<code class="du kx ky kz la b">result</code>来存储我们从 API 得到的结果。所有这些都是为了避免编译器优化和消除测试中的函数，这会人为地降低基准的运行时间。</li><li id="0891" class="lp lq hi ih b ii lz im ma iq mb iu mc iy md jc lu lv lw lx bi translated">如果你切换基准函数的顺序，例如，<code class="du kx ky kz la b">BenchmarkCalculateRestAPI1</code>被首先定义，你会得到同样的结果。您会看到第一个基准函数和第二个之间的巨大差异是由一个随机整数造成的。</li><li id="4768" class="lp lq hi ih b ii lz im ma iq mb iu mc iy md jc lu lv lw lx bi translated">看到这个结果，100 万、100 万和 100 万的输入没有任何显著的不同。通过移除<code class="du kx ky kz la b">Calculate</code>函数中的随机整数，您会更好地看到这一点。</li></ul><p id="d5c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这样吗？我们能让代码变得更好吗？让我们寻找一个解决方案，比如用一个<code class="du kx ky kz la b">goroutine</code>大概？</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h1 id="9fe9" class="ju jv hi bd jw jx lk jz ka kb ll kd ke kf lm kh ki kj ln kl km kn lo kp kq kr bi translated">让它变得更好</h1><p id="0ab7" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们能不能利用 Go 给我们提供的牛逼功能让我们的代码变得更好，这个功能就是<code class="du kx ky kz la b">goroutine</code>。让我们找出答案。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="lb lc l"/></div></figure><p id="1567" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过运行命令<code class="du kx ky kz la b">go test -bench=Bench -benchtime=5s</code>，您将得到类似的结果:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es me"><img src="../Images/70a1a0728d14fc79da569a981b633425.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nQ4JYUBfdZq982oJSVnnqA.png"/></div></div></figure><p id="30c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看，因为<code class="du kx ky kz la b">Calculate</code>和<code class="du kx ky kz la b">CalculateSlow</code>同时运行，我们得到了更好的结果。注意，对于每个基准函数，我们得到大约 2 秒，这是我们在<code class="du kx ky kz la b">CalculateSlow</code>中定义的睡眠持续时间。这绝对是一个很好的解决方案。</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h1 id="572e" class="ju jv hi bd jw jx lk jz ka kb ll kd ke kf lm kh ki kj ln kl km kn lo kp kq kr bi translated">结论</h1><p id="e9a8" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">我们从一个简单的例子开始，然后用一个更好的解决方案改进了前面的代码。</p><p id="5bfb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们必须记住的是，性能调整必须在系统启动并运行之后进行。在此之前不能，否则我们将陷入过早优化。</p><p id="7d3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一些解决方案可能需要我们从袖子里拿出一些技巧，这可能会使我们的代码不那么明显和可读。这将是我们通过实现解决方案而得到的一个缺点。但是，工程就是要知道我们拥有的解决方案利大于弊。</p><p id="3d00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您的阅读和快乐编码！</p><p id="1d71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与本文相似的其他文章:</p><div class="mf mg ez fb mh mi"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/load-testing-using-locust-io-f3e6e247c74e"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hj fi z dy mn ea eb mo ed ef hh bi translated">使用 Locust.io 进行负载测试</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">在我们的应用程序或服务运行后，有一段时间我们想知道性能和负载…</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">medium.com</p></div></div><div class="mr l"><div class="ms l mt mu mv mr mw jn mi"/></div></div></a></div><div class="mf mg ez fb mh mi"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/testing-rest-api-in-go-with-testify-and-mockery-c31ea2cc88f9"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hj fi z dy mn ea eb mo ed ef hh bi translated">测试 REST API 在 Go 中的验证和模拟</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">"当低价的甜蜜被遗忘后，劣质的苦涩依然久久不散."—本杰明·富兰克林</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">medium.com</p></div></div><div class="mr l"><div class="mx l mt mu mv mr mw jn mi"/></div></div></a></div><div class="mf mg ez fb mh mi"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/setup-and-teardown-unit-test-in-go-bd6fa1b785cd"><div class="mj ab dw"><div class="mk ab ml cl cj mm"><h2 class="bd hj fi z dy mn ea eb mo ed ef hh bi translated">Go 中的设置和拆卸单元测试</h2><div class="mp l"><h3 class="bd b fi z dy mn ea eb mo ed ef dx translated">使用 Go 的标准库进行单元测试</h3></div><div class="mq l"><p class="bd b fp z dy mn ea eb mo ed ef dx translated">medium.com</p></div></div><div class="mr l"><div class="my l mt mu mv mr mw jn mi"/></div></div></a></div></div></div>    
</body>
</html>