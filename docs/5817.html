<html>
<head>
<title>Recursive DNS+AD-Blocker — Part 5: unbound2influxdb2 — How to monitor your Unbound servers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">递归 DNS+广告拦截器—第 5 部分:Unbound 2 influxd 2—如何监控未绑定的服务器</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/recursive-dns-ad-blocker-part-5-unbound2influxdb2-how-to-monitor-your-unbound-servers-977fd59df215?source=collection_archive---------1-----------------------#2021-11-20">https://medium.com/nerd-for-tech/recursive-dns-ad-blocker-part-5-unbound2influxdb2-how-to-monitor-your-unbound-servers-977fd59df215?source=collection_archive---------1-----------------------#2021-11-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="31fa" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在本文中，我将向您展示如何通过使用一个简单的 Python 脚本<a class="ae ix" href="https://github.com/MightySlaytanic/unbound2influxdb2" rel="noopener ugc nofollow" target="_blank">Unbound-to-influxd 2 . py</a>或我的<a class="ae ix" href="https://hub.docker.com/repository/docker/giannicostanzi/unbound2influxdb2" rel="noopener ugc nofollow" target="_blank">giannicostanzi/Unbound 2 influxd 2</a>docker image(您可以在 DockerHub 上找到)来收集未绑定的统计数据并将其发送到 influxdb2 bucket</h2></div><p id="5c48" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">本文与上一篇文章非常相似，<a class="ae ix" rel="noopener" href="/nerd-for-tech/recursive-dns-ad-blocker-part-4-pihole2influxdb2-how-to-monitor-your-pi-hole-servers-b2f03de2baf2">递归 DNS+广告拦截器—第 4 部分:pihole 2 influxd 2—如何监控您的 Pi-hole 服务器</a>，我们将看到如何监控我们的未绑定服务器并收集数据以在 Grafana 仪表板中可视化。</p><p id="c752" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">Unbound 允许你通过一个实用程序<em class="ju"> unbound_control </em>和通过<em class="ju"> unbound_console </em> Python 包来查询它的服务器。正如我对 Pihole 所做的那样，我构建了自己的 Python 脚本，因此我选择了 unbound_console 方式。</p><p id="3424" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">这是一个由 unbounded 返回的输出示例(它不是由<em class="ju">unbounded _ control</em>返回的本机信息，稍后您将会看到，我已经重命名了这些键并添加了一个<em class="ju"> percent_cachehits </em>键)并用<em class="ju"> json.dumps(data，indent=4) </em>格式化:</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="ka kb l"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">未绑定状态</figcaption></figure><h2 id="6ed1" class="kg kh hi bd ki kj kk kl km kn ko kp kq jh kr ks kt jl ku kv kw jp kx ky kz la bi translated">使用 Python 收集和上传数据</h2><p id="fb9b" class="pw-post-body-paragraph iy iz hi ja b jb lb ij jd je lc im jg jh ld jj jk jl le jn jo jp lf jr js jt hb bi translated">正如我收集和上传 Pihole 统计数据一样，我构建了自己的 Python 脚本来查询未绑定的服务器，并将格式化的数据上传到我的 influxdb 服务器。你可以在<a class="ae ix" href="https://github.com/MightySlaytanic/unbound2influxdb2" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到整个脚本，在那里你可以找到一个总是最新的版本。</p><p id="5621" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><strong class="ja hj">脚本环境变量</strong></p><p id="e558" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">该脚本依赖于一些环境变量:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="b3ef" class="kg kh hi lh b fi ll lm l ln lo">INFLUX_HOST="INFLUX_IP"<br/>INFLUX_PORT=8086<br/>INFLUX_ORGANIZATION="influx_org"<br/>INFLUX_BUCKET="influx_bucket"<br/>INFLUX_SERVICE_TAG="influx_service_tag"<br/>INFLUX_TOKEN="influx_token"<br/>UNBOUND_HOSTS="ip1:port1:tag1:G,ip2:port2:tag2:S,ip3:port3:tag3:N"<br/>RUN_EVERY_SECONDS=10<br/>VERBOSE="True"<br/># Create this folder and the required subfolders <br/># <strong class="lh hj">(see </strong><a class="ae ix" href="https://github.com/MightySlaytanic/unbound2influxdb2" rel="noopener ugc nofollow" target="_blank"><strong class="lh hj">README.md on GitHub</strong></a><strong class="lh hj"> for more info)</strong><br/>CONFIG_DIR="./etc/unbound"</span></pre><p id="a490" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我不会详细讨论变量，特别是<em class="ju"> CONFIG_DIR </em>，它必须包含证书和密钥，这些证书和密钥必须用于连接到未绑定的服务器。你可以直接在<a class="ae ix" href="https://github.com/MightySlaytanic/unbound2influxdb2" rel="noopener ugc nofollow" target="_blank">https://github.com/MightySlaytanic/unbound2influxdb2</a>上找到 README.md 和脚本源代码中的更多细节</p><p id="07d4" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我准备了一个导出环境变量的 shell 启动器，这对于将脚本嵌入 Docker 容器非常有用，就像我对 Pihole stats 所做的那样，它调用 python 脚本:</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="ka kb l"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">环境变量</figcaption></figure><p id="c329" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">如果将-t 标志传递给启动器脚本，它将把它传递给 unbind-to-influx db 2，并打印收集的数据，而不上传。</p><h2 id="c26e" class="kg kh hi bd ki kj kk kl km kn ko kp kq jh kr ks kt jl ku kv kw jp kx ky kz la bi translated">脚本执行</h2><p id="b5b0" class="pw-post-body-paragraph iy iz hi ja b jb lb ij jd je lc im jg jh ld jj jk jl le jn jo jp lf jr js jt hb bi translated">该脚本将永远运行，每隔<em class="ju">运行 _ 每 _ 秒</em>秒在<em class="ju">未绑定 _ 主机</em>中查询未绑定主机。</p><p id="1094" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">您可以运行带有<em class="ju"> -t </em>标志的脚本，以便从 Unbound 中检索数据，并以格式良好、易于阅读的形式打印出来，而无需上传到 InfluxDB2。您还可以通过将<em class="ju"> VERBOSE </em>设置为<em class="ju"> True 来查看调试信息。</em></p><p id="dfa9" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">脚本使用了<em class="ju"> unbound_console。RemoteControl </em>查询未绑定的服务器:</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="ka kb l"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">查询未绑定的服务器</figcaption></figure><p id="f943" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们处理返回的数据，以便用下划线而不是点来格式化字段，使运行在我们的 Raspberry 和 Docker 容器上的不同版本的 unbound 之间的命名一致(例如，一个版本使用<em class="ju"> zero_ttl </em>而不是<em class="ju"> expired </em>来计算缓存中过期元素的数量)，并避免在将值上传到<em class="ju"> influxdb2 </em>时出错(我们强制一些值为浮点型，另一些值为整数型):</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="ka kb l"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">正在为 InfluxDB2 上载准备统计字典</figcaption></figure><p id="7540" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">最后，已经打包到<em class="ju"> Python 字典</em>中的解析数据可以上传到 InfluxDB2:</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="ka kb l"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">将统计数据上传到 InfluxDB2</figcaption></figure><h2 id="7cf4" class="kg kh hi bd ki kj kk kl km kn ko kp kq jh kr ks kt jl ku kv kw jp kx ky kz la bi translated">探索关于 InfluxDB2 的数据 DB2</h2><p id="8c7a" class="pw-post-body-paragraph iy iz hi ja b jb lb ij jd je lc im jg jh ld jj jk jl le jn jo jp lf jr js jt hb bi translated">您将在您的 InfluxDB2 服务器上找到统计数据:</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="er es lp"><img src="../Images/a8f5bda4d8780b1e6e7de76aeebacfa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yjMN8rSirDBpMsWomFiOoA.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">InfluxDB2 上的测试桶</figcaption></figure><p id="afdb" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">如你所见，我们在脚本中计算的所有未绑定统计数据和<em class="ju"> percent_cachehits </em>都可以在<em class="ju">stats</em>measurement 中找到。您还会发现主机和服务作为附加标记可用于过滤查询的数据。</p><h2 id="8820" class="kg kh hi bd ki kj kk kl km kn ko kp kq jh kr ks kt jl ku kv kw jp kx ky kz la bi translated">在 Grafana 中可视化数据</h2><p id="e053" class="pw-post-body-paragraph iy iz hi ja b jb lb ij jd je lc im jg jh ld jj jk jl le jn jo jp lf jr js jt hb bi translated">现在您已经在 InfluxDB2 上拥有了所有可用的数据，很容易用未绑定的统计数据来丰富您的 Grafana 仪表板:</p><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="er es lw"><img src="../Images/fa35eb7b18b6c1ffd0142926aa26596b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B6F9qzKn8s0021d742FrOg.png"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="er es lw"><img src="../Images/a23dbc3869b590c35487bffae40857e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QVk_dLx8hPj74rD1OX7dow.png"/></div></div></figure><figure class="jv jw jx jy fd jz er es paragraph-image"><div role="button" tabindex="0" class="lq lr di ls bf lt"><div class="er es lw"><img src="../Images/1b9bb1d6f9c5d90756dc49ccba81da86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OI1cdBYlv7D9cNC9abXAYw.png"/></div></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">未绑定仪表板面板</figcaption></figure><p id="44fd" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">例如，这是我用来在上面的条形标尺面板上绘制最有趣的未绑定数据的<em class="ju"> Flux </em>查询:</p><figure class="jv jw jx jy fd jz"><div class="bz dy l di"><div class="ka kb l"/></div><figcaption class="kc kd et er es ke kf bd b be z dx translated">在之前显示的条形仪表盘上绘制 nas 统计数据的流量查询</figcaption></figure><h2 id="4fcb" class="kg kh hi bd ki kj kk kl km kn ko kp kq jh kr ks kt jl ku kv kw jp kx ky kz la bi translated">unbound 2 info lux db 2 Docker 映像</h2><p id="a878" class="pw-post-body-paragraph iy iz hi ja b jb lb ij jd je lc im jg jh ld jj jk jl le jn jo jp lf jr js jt hb bi translated">如果您已经阅读了我在本系列中的前几篇文章，您肯定期望我构建另一个 Docker 映像来嵌入我的 Python 脚本，您是对的:我已经将<em class="ju">unbound-to-influx db 2 . py</em>脚本嵌入到我的<a class="ae ix" href="https://hub.docker.com/repository/docker/giannicostanzi/unbound2influxdb2" rel="noopener ugc nofollow" target="_blank"> unbound2influxdb2 Docker 映像</a>中，您可以使用下面的命令下载它:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="2b97" class="kg kh hi lh b fi ll lm l ln lo">docker pull giannicostanzi/unbound2influxdb2:latest</span></pre><p id="3625" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">您可以在<a class="ae ix" href="https://hub.docker.com/repository/docker/giannicostanzi/unbound2influxdb2" rel="noopener ugc nofollow" target="_blank">un bound 2 info lux db 2 Docker Hub 页面</a>上找到关于如何设置环境变量和运行该映像的更多信息。</p><p id="7bd7" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">如果您愿意，您可以使用下面的命令执行一次测试运行，它应该给出与<em class="ju">un bound 2 influxd 2 . sh-t</em>相同的输出:</p><pre class="jv jw jx jy fd lg lh li lj aw lk bi"><span id="c79c" class="kg kh hi lh b fi ll lm l ln lo">docker run -t --rm \<br/> -e INFLUX_HOST="influxdb_server_ip" \<br/> -e INFLUX_PORT="8086" \<br/> -e INFLUX_ORGANIZATION="org-name" \<br/> -e INFLUX_BUCKET="bucket-name" \<br/> -e INFLUX_TOKEN="influx_token" \<br/> -e INFLUX_SERVICE_TAG="unbound-test" \<br/> -e VERBOSE="true" \<br/> -e UNBOUND_HOSTS="ip1:port1:tag_name1:enc_flag1,ip2:port2:tag_name2:enc_flag2" \<br/> -e CONFIG_DIR="/etc/unbound" \<br/> -v /path_to_local_folder/etc/unbound:/etc/unbound \<br/>giannicostanzi/unbound2influxdb2 -t</span></pre><p id="26e3" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">如果流入主机或未绑定主机运行在同一个 docker 实例上，您可以指定各自的容器名称，但这需要将<em class="ju"> unbound2influxdb2 </em>容器连接到 influxdb 和 unbound 的同一个<em class="ju">非默认桥接网络</em>，以便容器到 ip 名称解析按预期工作。例如，我让这个容器在我的 Synology NAS 上运行，连接到<em class="ju"> npm </em>网络<em class="ju">T7】(<em class="ju">influxdb 1</em>容器)和<em class="ju">服务</em>网络(<em class="ju"> unbound-secns1 </em>容器)。</em></p><p id="d74a" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">您可以从 CLI 或通过使用 Synology Docker 应用程序 GUI 来创建容器，正如我在上一篇文章中所展示的。</p><p id="1e66" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">如果未能查询一个已定义的未绑定服务器，或者未能将数据上传到 influxdb2 服务器，则该映像实现的 healthcheck 会失败。您可以使用<em class="ju"> docker ps </em>查看容器的状态(<em class="ju">健康</em>或<em class="ju">不健康</em>，如果不健康，您可以使用<em class="ju">docker logs un bound 2 info luxd 2 _ container _ name</em>检查日志。</p><h2 id="1f7c" class="kg kh hi bd ki kj kk kl km kn ko kp kq jh kr ks kt jl ku kv kw jp kx ky kz la bi translated">结论</h2><p id="7905" class="pw-post-body-paragraph iy iz hi ja b jb lb ij jd je lc im jg jh ld jj jk jl le jn jo jp lf jr js jt hb bi translated">我希望你会发现这篇文章很有用，别忘了看看我的<a class="ae ix" href="https://hub.docker.com/repository/docker/giannicostanzi/unbound2influxdb2" rel="noopener ugc nofollow" target="_blank">unbound 2 influxd 2 docker 图像</a>并访问<a class="ae ix" href="https://github.com/MightySlaytanic" rel="noopener ugc nofollow" target="_blank">我的 Github 页面</a>获取更新的脚本。如果您有任何问题，请添加评论，我会尽力帮助您！</p></div></div>    
</body>
</html>