<html>
<head>
<title>5 Most Common Spark Performance Problems</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">5个最常见的火花性能问题</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/5-most-common-spark-performance-problems-9924b863421f?source=collection_archive---------0-----------------------#2021-10-19">https://medium.com/nerd-for-tech/5-most-common-spark-performance-problems-9924b863421f?source=collection_archive---------0-----------------------#2021-10-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="0201" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我将讨论5个最常见的spark性能问题。这些都是很常见的，而且大多被忽视了，或者人们经常弄不清去哪里找。</p><p id="a168" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们通常会对从哪里开始感到困惑🤔，我应该调查Spark UI吗？或者我的集群配置？还有Spark UI下到底找什么？Spark UI提供了很多很多信息，但是有几个选项卡/部分我们应该主要寻找,“至少”不要成为这些常见问题的受害者。</p><p id="3405" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇文章将被分成6篇，每篇都有一个引发问题的讨论和详细的缓解(这里的想法是不要用一篇长文让读者昏昏欲睡😅).这是这个系列的第一篇关于基本问题讨论和热身的文章(是的，你没看错，这是热身😉).</p><p id="dd84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">坚持家伙的。让我确定指出。这些不会那么令人困惑或难以进入。此外，我敢打赌，你一定会觉得这个博客很有趣。因此，请耐心等待，让我们一起完成这一Spark优化之旅。“缓慢而稳定地”😁</p><p id="3c8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">特别要提到那些给了我这些知识的人，在这里我可以为你们写下来。</p><blockquote class="jd je jf"><p id="c034" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">多亏了Databrick的</p><p id="b7fa" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><a class="ae jk" href="https://academy.databricks.com/instructor-led-training/optimizing-apache-spark-on-databricks" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">优化Apache Spark On databricks</strong></a><strong class="ih hj"/>课程</p></blockquote><p id="9ac9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们通过理解下面的spark代码做一点热身，并尝试回答下面的问题。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="32e7" class="ju jv hi jq b fi jw jx l jy jz">Step1:</span><span id="536d" class="ju jv hi jq b fi ka jx l jy jz">spark.read.parquet(file_path).count()</span><span id="edb0" class="ju jv hi jq b fi ka jx l jy jz">execution time: ~28 sec.</span><span id="1f14" class="ju jv hi jq b fi ka jx l jy jz">Step2:</span><span id="ee18" class="ju jv hi jq b fi ka jx l jy jz">spark.read.parquet(file_path).count()</span><span id="8563" class="ju jv hi jq b fi ka jx l jy jz">execution time: ~13 sec.</span></pre><figure class="jl jm jn jo fd kc er es paragraph-image"><div class="er es kb"><img src="../Images/8fec8ce6a7d8b138eaf4495627e3e647.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*ix2V3diRUHzyd8055sfhlQ.png"/></div></figure><p id="4b7b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Q1:为什么第二步比第一步花的时间少？</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="f4d6" class="ju jv hi jq b fi jw jx l jy jz">Step3:</span><span id="6085" class="ju jv hi jq b fi ka jx l jy jz">spark.read.schema(data_schema).parquet(file_path).count()</span><span id="67a2" class="ju jv hi jq b fi ka jx l jy jz">execution time: ~13 sec.</span></pre><figure class="jl jm jn jo fd kc er es paragraph-image"><div class="er es kf"><img src="../Images/358930d303258ce8348d0af75fde5bd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:872/format:webp/1*yzuN4aO1B3w2PCnhtGUfoA.png"/></div></figure><p id="f917" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Q2:为什么第三步比第二步少了一项工作？</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="b9e9" class="ju jv hi jq b fi jw jx l jy jz">Step4:</span><span id="353b" class="ju jv hi jq b fi ka jx l jy jz">spark.read.schema(data_schema).parquet(file_path).foreach(_=&gt;())</span><span id="9603" class="ju jv hi jq b fi ka jx l jy jz">execution time: ~13 mins.</span></pre><p id="5086" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Q3:为什么foreach()比count()操作花费的时间多得多？</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="1235" class="ju jv hi jq b fi jw jx l jy jz">Step5:</span><span id="da72" class="ju jv hi jq b fi ka jx l jy jz">spark.read.schema(data_schema).parquet(file_path).foreach(lambda x: None)</span><span id="7237" class="ju jv hi jq b fi ka jx l jy jz">execution time: ~2 hrs.</span></pre><p id="8501" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Q4:为什么第5步(Python代码)比第4步(Scala代码)花费的时间多得多？</p><p id="e0b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">慢慢来，试着分析代码片段并回答上述问题。完成后，向下滚动，让我们一起走，了解以上mistrys背后的原因。</p></div><div class="ab cl kg kh gp ki" role="separator"><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl km"/><span class="kj bw bk kk kl"/></div><div class="hb hc hd he hf"><p id="449f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们回顾一下:</p><p id="df13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">A1:如果我们注意到步骤1和步骤2的代码是相同的，这意味着我们正在尝试再次读取相同的数据。此外，如果我们注意到给定的作业图像，我们可以看到有两个作业触发了作业2和作业3。Job2的目的是读取模式，从而创建具有1个任务的阶段，Job3的目的是读取实际数据，从而创建具有825个任务的另一个阶段。</p><p id="56f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在步骤2中，由于模式已经读取，spark再次跳过读取模式，因此我们只有一个包含825个任务的阶段。</p><p id="a8c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，看起来我们可能会在多次运行相同的代码时遇到性能问题(很有趣吧？)</p><p id="b320" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">A2:我们现在已经知道这个问题的答案了。从我们的A1开始，由于在后续运行中跳过了模式重新读取。</p><p id="5c82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">A3:所以count()操作在操作方面有所优化。这意味着使用列存储格式(如Parquet)可以在不读取所有数据的情况下识别记录的数量。相反，foreach()遍历所有记录来执行操作，从而导致更多的性能时间。</p><p id="508c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">答4:首先，python并不慢，事实上，在某些情况下，我们可能会看到Python比Scala快得多。在这个特定的场景中，如果我们更仔细地看代码，会发现有一个lambda函数，在python的情况下，它需要被提取并发送给执行器，执行器也需要有Python解释器来执行代码。因此，即使lambda在技术上什么都不做，序列化的成本也是巨大的(别急，我们将在最后一节详细讨论序列化，这只是给出一个想法)。</p><p id="33e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，这是我们这个系列的第一篇博客，我希望你能找到一些关于w . r . t . Spark的有趣的观点，我个人也发现这些观点很有趣，所以想与大家分享。</p><p id="6605" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将很快推出下一篇博客。敬请关注🤞。只是为了让你一窥究竟，我们将讨论Spark的<a class="ae jk" rel="noopener" href="/@adityasahu188/sparks-skew-problem-does-it-impact-performance-257cdef53680"> <strong class="ih hj">【歪斜问题】</strong> </a> <strong class="ih hj">【现已上市】</strong>。在那之前继续冲浪😛。</p></div></div>    
</body>
</html>