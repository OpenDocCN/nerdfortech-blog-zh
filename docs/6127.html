<html>
<head>
<title>Build Your Symfony and Doctrine ORM Applications with ease using Ecotone</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用生态区轻松构建您的Symfony和学说ORM应用程序</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/build-your-symfony-applications-with-ease-using-ecotone-f7bcaa11b5c4?source=collection_archive---------0-----------------------#2022-01-02">https://medium.com/nerd-for-tech/build-your-symfony-applications-with-ease-using-ecotone-f7bcaa11b5c4?source=collection_archive---------0-----------------------#2022-01-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/2105134c7e5b3ea9a9362c5b37d543cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*94_yZZjI1N_zep1uSm3X7Q.jpeg"/></div></div></figure><p id="2976" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我们将把Symfony应用程序的重构推向极限。我们将专注于完全删除样板文件，这样我们就可以只编写重要的代码，使我们能够轻松修改、维护和未来扩展。</p><p id="3057" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将从示例功能开始，我们将通过用Ecotone扩展我们的Symfony应用程序来逐步重构它。<br/>准备一杯好咖啡或茶，享受旅程:)</p><h1 id="5ef4" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">出发点</h1><p id="0098" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们的应用程序将有两个功能:-注册新用户-注册完成后激活用户</p><p id="5e95" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们的<em class="kr">用户控制器</em>收到请求，调用<em class="kr">用户服务</em>注册新用户。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="539c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们的用户服务，开始事务并使用实体管理器存储实体。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="c0aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是我们的<em class="kr">用户</em>的样子。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="a34b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们开始之前，让我们为Symfony安装生态区:</p><blockquote class="ky kz la"><p id="b032" class="iq ir kr is b it iu iv iw ix iy iz ja lb jc jd je lc jg jh ji ld jk jl jm jn hb bi translated"><em class="hi">作曲要求</em> <a class="ae le" href="https://packagist.org/packages/ecotone/" rel="noopener ugc nofollow" target="_blank"> <em class="hi">交错带/</em></a><em class="hi">symfony-bundle</em></p></blockquote><h1 id="fbdd" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">丢弃冗余事务管理</h1><p id="068d" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">伤眼的是交易管理。我们正在为每个动作(<em class="kr"> registerUser </em>，<em class="kr"> activateUser </em>)做这件事，将来的动作也需要它。让我们移除样板文件并将其放在一个地方。</p><p id="3263" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为此，我们将构建一个管道，在运行任何操作之前，我们将处理事务。</p><figure class="ks kt ku kv fd ij er es paragraph-image"><div class="er es lf"><img src="../Images/0a2b12ae81e7bb45e44e307c7adb93f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/0*qUmXeqOrcCYYLS1X.png"/></div></figure><p id="3778" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们首先将我们的动作注册为<a class="ae le" href="https://blog.ecotone.tech/cqrs-in-php/" rel="noopener ugc nofollow" target="_blank">命令处理程序</a>。这将允许我们通过将它们封装在事务中来拦截它们的执行。</p><blockquote class="ky kz la"><p id="f5ea" class="iq ir kr is b it iu iv iw ix iy iz ja lb jc jd je lc jg jh ji ld jk jl jm jn hb bi translated"><em class="hi">如果你熟悉Symfony Messenger，你就知道消息处理程序的概念。<br/>命令处理程序是更高层次的概念，描述了负责改变数据或提供副作用(如发送电子邮件)的消息处理程序。</em></p></blockquote><p id="d53d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了执行命令处理程序，我们需要用<em class="kr">控制器</em>中的<em class="kr">命令总线</em>替换我们的<em class="kr">用户服务</em>。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><pre class="ks kt ku kv fd lg lh li lj aw lk bi"><span id="e40e" class="ll jp hi lh b fi lm ln l lo lp">$this-&gt;commandBus-&gt;sendWithRouting("registerUser", $name);</span></pre><p id="a6f2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该执行命令处理程序以名称<em class="kr">“register user”注册。</em>第二个参数是有效载荷，它将作为<em class="kr">第一个参数</em>传递给我们的处理程序。</p><blockquote class="ky kz la"><p id="865f" class="iq ir kr is b it iu iv iw ix iy iz ja lb jc jd je lc jg jh ji ld jk jl jm jn hb bi translated"><em class="hi">在这个例子中，有效载荷实际上是一个单一的参数。我们可以很容易地提供数组或对象。生态区让你自由选择，看你的喜好和需求。</em></p></blockquote><p id="2773" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们将命令处理程序包装在事务中:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><pre class="ks kt ku kv fd lg lh li lj aw lk bi"><span id="df25" class="ll jp hi lh b fi lm ln l lo lp">#[Around(pointcut: CommandHandler::class)]<br/>public function transactional(MethodInvocation $methodInvocation)</span></pre><p id="9aff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">周围是<a class="ae le" href="https://docs.ecotone.tech/modelling/interceptors" rel="noopener ugc nofollow" target="_blank">拦截器</a>，它允许我们在执行处理程序之前和之后添加逻辑。这对于交易之类的事情非常有用。<br/> <em class="kr">切入点</em>告诉我们要拦截什么。在这个场景中，我们截获了所有的命令处理程序。<br/>为了继续命令处理程序调用，我们使用了<em class="kr">$ method invocation-&gt;proceed()；</em></p><h1 id="bccf" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">推向极限</h1><p id="a239" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">让我们比较激活方法和新的停用方法。</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="fe57" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你仔细观察，你会看到样板代码:</p><pre class="ks kt ku kv fd lg lh li lj aw lk bi"><span id="d67b" class="ll jp hi lh b fi lm ln l lo lp">/** @var User $user */<br/>$user = $this-&gt;entityManager-&gt;find(User::class, $id);</span><span id="8a0c" class="ll jp hi lh b fi lq ln l lo lp">// Run some action on the user</span><span id="b310" class="ll jp hi lh b fi lq ln l lo lp">$this-&gt;entityManager-&gt;persist($user);</span></pre><p id="818f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了获取用户并保持更改，我们需要创建单独的类和方法，我们想要做的就是对用户执行方法。如果我们可以直接调用实体的方法，不是更简单吗？幸运生态区解决了这个问题，因为我们被允许将实体标记为命令处理程序。</p><p id="5ecc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了获得对学说ORM的支持，我们将安装<a class="ae le" href="https://docs.ecotone.tech/modules/dbal-support" rel="noopener ugc nofollow" target="_blank">econtero Dbal</a>:</p><pre class="ks kt ku kv fd lg lh li lj aw lk bi"><span id="eb81" class="ll jp hi lh b fi lm ln l lo lp"># install ecotone/dbal:<br/>composer require ecotone/dbal</span><span id="ded0" class="ll jp hi lh b fi lq ln l lo lp"><br/># Add in services.yaml, so Ecotone can discover database connection:<br/>Enqueue\Dbal\DbalConnectionFactory:<br/> factory: ['Ecotone\Dbal\DbalConnection','createForManagerRegistry']   <br/> arguments: [ "@doctrine","default" ]</span></pre><blockquote class="ky kz la"><p id="8e02" class="iq ir kr is b it iu iv iw ix iy iz ja lb jc jd je lc jg jh ji ld jk jl jm jn hb bi translated"><em class="hi">如果安装了</em><a class="ae le" href="https://docs.ecotone.tech/modules/dbal-support" rel="noopener ugc nofollow" target="_blank"><em class="hi">econtero/dbal</em></a><em class="hi">，则默认处理事务管理。您可以移除TransactionWrapper。</em></p></blockquote><p id="61e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们需要为生态交错区启用理论ORM存储库:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="fd67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们准备用命令处理程序来标记我们的用户实体:</p><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><ol class=""><li id="f691" class="lr ls hi is b it iu ix iy jb lt jf lu jj lv jn lw lx ly lz bi translated">在生态交错区，我们称实体为<em class="kr"> #【集合体】</em></li><li id="75b0" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated">就像教条ORM一样，我们需要标记标识符<em class="kr"> #【聚合标识符】</em></li><li id="e5e6" class="lr ls hi is b it ma ix mb jb mc jf md jj me jn lw lx ly lz bi translated">并且我们将方法标记为命令处理程序:<em class="kr">#【Command handler(" activate user ")】</em></li></ol><figure class="ks kt ku kv fd ij"><div class="bz dy l di"><div class="kw kx l"/></div></figure><p id="26b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们需要在控制器中做的唯一更改是告诉activate方法实体的标识符:</p><pre class="ks kt ku kv fd lg lh li lj aw lk bi"><span id="391a" class="ll jp hi lh b fi lm ln l lo lp">$this-&gt;commandBus-&gt;sendWithRouting("activateUser", $id, metadata: ["aggregate.id" =&gt; $id]);</span></pre><h1 id="acc6" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">摘要</h1><p id="791c" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们丢弃了所有的样板代码，只在应用程序中留下了业务逻辑代码。现在，我们可以用最少的代码和测试来开发新的功能。<br/>所有的胶水代码都被移到了econtero和Symfony，让我们专注于重要的事情。</p><p id="a886" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想获得更多关于框架的信息，请访问main<a class="ae le" href="https://github.com/ecotoneframework/ecotone" rel="noopener ugc nofollow" target="_blank">econtero Github</a>。如果你想看这篇文章中描述的东西的实现，请访问<a class="ae le" href="https://github.com/ecotoneframework/php-ddd-cqrs-event-sourcing-symfony-ecotone" rel="noopener ugc nofollow" target="_blank">示例应用</a>。</p></div></div>    
</body>
</html>