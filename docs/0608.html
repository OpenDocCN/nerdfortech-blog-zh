<html>
<head>
<title>Connecting Swift AWS Lambda with SQLite</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Swift AWS Lambda与SQLite连接</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/swift-aws-lambda-sqlite-ae471f08b31f?source=collection_archive---------6-----------------------#2021-01-26">https://medium.com/nerd-for-tech/swift-aws-lambda-sqlite-ae471f08b31f?source=collection_archive---------6-----------------------#2021-01-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/3ee7de08afbdf5d47ac2fc0d4db40f35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*Qd9gmKiCTtWP_Xn0iyD3_g.jpeg"/></div><figcaption class="im in et er es io ip bd b be z dx translated">德米特里·马什金在<a class="ae iq" href="https://unsplash.com/s/photos/blocks-lego?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="55b1" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">去年在2020年，Swift正式支持AWS lambda，苹果在WWDC 2020上制作了视频，Swift与AWS Lambda配合使用。</p><p id="687b" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">目前在我的工作项目中，我们有丰富的iOS应用程序，丰富的意思是用户的所有功能都是在iOS swift中编写的，生成PDF，业务验证，计算等。它不像以前的客户-服务器应用程序。</p><p id="f6d8" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">因此，有了这个消息，我们可以尝试将这些功能转移到AWS Lambda或后端服务中，以便其他人可以使用这些功能。当然会有一些障碍，但我在<a class="ae iq" href="https://tirtavium.medium.com/the-things-you-need-to-consider-before-make-your-ios-mac-functions-run-on-aws-lambda-linux-a3ea26c9f270" rel="noopener">这里</a>分享了这些问题，这篇文章的重点是在AWS Lambda上集成swift SQLite，在使我们的swift代码库支持多平台(iOS、Mac、Linux、android)之前，我们需要考虑什么😝).</p><p id="c33e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">在这篇文章中，如标题所述，我将分享如何Swift AWS Lambda支持SQLite的源代码，您可以在我的<a class="ae iq" href="https://github.com/tirtavium/Swift-AWS-Lambda-SQLite" rel="noopener ugc nofollow" target="_blank"> <strong class="it hj"> github </strong> </a>查看。</p><p id="38b3" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">首先我们需要考虑，在你的项目中使用SQLite的目的是什么，是为了像普通RDBMS一样添加记录吗？如果是这样的话，你需要三思而行，因为AWS lambda存储仅适用于512MB，我的建议是你需要消除这种想法，并使用其他服务，如AWS DynamoDB或RDS。</p><p id="f8af" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">如果您只需要只读，因为数据库中有如此多的静态数据，并且大小小于512MB，那么您可以继续在AWS Lambda上使用您的swift代码库，在您将它部署到AWS Lambda并调用一些功能后，您还需要考虑性能成本，我的建议是第一步是针对最简单的功能，并查看该功能的性能。如果结果通过了您的用户数据的估计，您可以继续使用Lambda。</p><p id="fa44" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><strong class="it hj">先决条件</strong></p><ol class=""><li id="2886" class="jp jq hi it b iu iv iy iz jc jr jg js jk jt jo ju jv jw jx bi translated">Xcode 12，因为swift包管理器从xcode 12开始支持资源it，准确地说，它需要swift-tools-version:5.3</li><li id="81fe" class="jp jq hi it b iu jy iy jz jc ka jg kb jk kc jo ju jv jw jx bi translated">码头工人，我们需要这个为我们的lambda做容器。</li></ol><p id="bbad" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我将解释package.swift</p><figure class="kd ke kf kg fd ij"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="d484" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><strong class="it hj">产品:</strong>它有<strong class="it hj">可执行文件</strong>，名称为<strong class="it hj"> AccountServiceAWS，</strong>这需要与<strong class="it hj">源</strong>文件夹目录相匹配，您可能还需要查看项目的<strong class="it hj">库</strong>标签，因为可执行文件意味着执行的结果将是正在运行的程序，如果库结果将是要使用的库。</p><blockquote class="kj kk kl"><p id="4e6b" class="ir is km it b iu iv iw ix iy iz ja jb kn jd je jf ko jh ji jj kp jl jm jn jo hb bi translated"><strong class="it hj">注明</strong>:不支持<strong class="it hj">可执行</strong>产品<strong class="it hj">要进行<strong class="it hj">单元测试</strong>，您可以为您的业务代码创建库，并为依赖于AWS lambda运行时的东西创建可执行文件，出于示例目的，我不在此考虑。</strong></p></blockquote><p id="5cc4" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><strong class="it hj">依赖项:</strong>所有需要的<strong class="it hj"> </strong>依赖项都在这里，因为现在它只需要AWS lambda运行时、AWS lambda库和Soto库来连接到这个示例的其他AWS服务是S3。</p><p id="bac1" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><strong class="it hj"> targets: </strong> Targets是一个包的基本构造块，所以在这里它只包含1个target，包含所有需要的依赖项和资源，<strong class="it hj"> systemLibrary </strong>是安装在系统上的库，在我们的例子中，我们有<strong class="it hj"> SQLite3 </strong>这是C库，我们需要稍后在docker映像上安装它，正如您可以看到的，sources文件夹上有文件夹CSQLite3，<strong class="it hj"> testTarget </strong>用于<strong class="it hj"> </strong>单元测试。</p><p id="098a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">如果您使用Xcode，您可以直接运行项目并用curl验证它:</p><pre class="kd ke kf kg fd kq kr ks kt aw ku bi"><span id="95b8" class="kv kw hi kr b fi kx ky l kz la">$ curl --header "Content-Type: application/json" \<br/>--request POST \<br/>--data '{"id": 1}' \<br/>http://localhost:7000/invoke</span></pre><p id="1d47" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">它会这样回应</p><pre class="kd ke kf kg fd kq kr ks kt aw ku bi"><span id="f172" class="kv kw hi kr b fi kx ky l kz la">{<br/> "account":{<br/>    "ID":1,<br/>    "dateOfBirth":"10-12-1991",<br/>    "Name":"Hanif",<br/>    "email":"hanif@gmail.com"<br/> },<br/> "message":"success"<br/>}</span></pre><p id="7d76" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">这是因为我们在Package.swift中有account.db作为资源，并且因为我们在mac上运行它，但是如果我们以这种状态部署到AWS lambda，我们将得到resource_bundle_accessor的错误，因此mac和AWS Lambda之间有不同的行为。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lb"><img src="../Images/1d7c262c25530defa71e770729f277be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jV9aw66Sm6Oxdph7m2hFyA.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">资源捆绑包存取器</figcaption></figure><p id="36e7" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">为了解决这个问题，我们需要将accountData.db上传到S3桶中，下载并保存到AWS Lambda上的/tmp文件夹中，该文件夹只有512MB的存储限制。</p><p id="465e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">为了将我们的功能连接到AWS S3，我们需要索托和S3访问密钥，在您拥有它之后，您可以将其放在<strong class="it hj"> SharedResource.swift </strong></p><pre class="kd ke kf kg fd kq kr ks kt aw ku bi"><span id="4a04" class="kv kw hi kr b fi kx ky l kz la"><strong class="kr hj">static</strong> <strong class="kr hj">public</strong> <strong class="kr hj">let</strong> s3BucketName = "calculationservice"</span><span id="d489" class="kv kw hi kr b fi lg ky l kz la"><strong class="kr hj">static</strong> <strong class="kr hj">public</strong> <strong class="kr hj">let</strong> awsClient = AWSClient(</span><span id="9755" class="kv kw hi kr b fi lg ky l kz la">credentialProvider: .static(accessKeyId: "xxxx", secretAccessKey: "xxxxx"),</span><span id="cae1" class="kv kw hi kr b fi lg ky l kz la">httpClientProvider: .createNew)</span></pre><p id="85c7" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">s3BucketName是您存储的accountData.db存储桶，您需要用您的存储桶替换accessKeyId和secretAccessKey，以便能够访问accountData.db。</p><p id="3805" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">经过这一步，你可以去码头部分。</p><p id="29a9" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">首先你需要用它来构建docker容器。</p><pre class="kd ke kf kg fd kq kr ks kt aw ku bi"><span id="4bcd" class="kv kw hi kr b fi kx ky l kz la">$ docker run \<br/>   --rm \<br/>   --volume "$(pwd)/:/src" \<br/>   --workdir "/src/" \<br/>   swift:5.3.1-amazonlinux2 \<br/>  /bin/bash -c "yum -y install sqlite-devel &amp;&amp; swift build --product AccountServiceAWS -c release -Xswiftc -static-stdlib"</span></pre><p id="ac91" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">所以它使用swift:5.3.1-amazonlinux2，并安装了sqlite-devel，AccountServiceAWS是我们拥有的产品。</p><p id="7e8f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">成功之后，我们需要运行这个脚本</p><pre class="kd ke kf kg fd kq kr ks kt aw ku bi"><span id="2cdf" class="kv kw hi kr b fi kx ky l kz la">$ ./scripts/package.sh AccountServiceAWS</span></pre><p id="35f8" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">这是一个创建包上传到AWS Lambda。</p><p id="793f" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">完成后，我们可以在<em class="km">上看到结果。build/lambda/AccountServiceAWS/lambda . zip</em></p><p id="eb2e" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">这个lambda.zip需要上传到S3，因为直接上传到AWS lambda的最大容量是10MB，而我们的lambda.zip是30MB。</p><p id="9d93" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">上传后，你可以回到AWS lambda和功能代码，从亚马逊S3上传文件。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lh"><img src="../Images/9312803fe7718043f8a91560dde21d67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i4LINmSE2F91R46KvBLF4A.png"/></div></div></figure><p id="7219" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">如果这成功了，你可以用测试事件测试这个函数，并把它请求成这样。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es li"><img src="../Images/ebe389a067d36e06b7fffee5585ac861.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xtqOwERJl5lW_O9fK7kw2Q.png"/></div></div></figure><p id="ca23" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">点击测试，您将看到与您在机器终端上看到的结果相同的结果。</p><figure class="kd ke kf kg fd ij er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lj"><img src="../Images/f6d8cacf20b4732c3aabbfde3a8b13a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jJQ_GtU_UbdgxTbFM76PBw.png"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">成功</figcaption></figure><h1 id="83cf" class="lk kw hi bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated">完成，谢谢你🙏</h1></div></div>    
</body>
</html>