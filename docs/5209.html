<html>
<head>
<title>Add an API to Azure Static Web Apps with Azure Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure函数向Azure静态Web应用程序添加API</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/add-an-api-to-azure-static-web-apps-with-azure-functions-dbf0dd3fce0a?source=collection_archive---------4-----------------------#2021-09-08">https://medium.com/nerd-for-tech/add-an-api-to-azure-static-web-apps-with-azure-functions-dbf0dd3fce0a?source=collection_archive---------4-----------------------#2021-09-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="90cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">演示如何向Azure SWA添加Azure函数并返回模拟数据</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/e415de57508fbad51d5f6b4c20fd9b74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TQSzKRFIh9GvuSYLhK9KFw.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">本文图片改编自<a class="ae jt" href="https://en.wikipedia.org/wiki/2020%E2%80%932021_Thai_protests#/media/File:Protest_in_2020_Democracy_Monument_(I).jpg" rel="noopener ugc nofollow" target="_blank">文件:2020年抗议民主纪念碑(上)。jpg</a>by<a class="ae jt" href="https://commons.wikimedia.org/wiki/User:Supanut_Arunoprayote" rel="noopener ugc nofollow" target="_blank">T5】supan ut ArunoprayoteT7】</a></figcaption></figure><h1 id="a848" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">创建API</h1><h2 id="6be0" class="kt jw hi bd jx ku kv kw kb kx ky kz kf iq la lb kj iu lc ld kn iy le lf kr lg bi translated">先决条件</h2><ul class=""><li id="a8ad" class="lh li hi ih b ii lj im lk iq ll iu lm iy ln jc lo lp lq lr bi translated">安装<a class="ae jt" href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurestaticwebapps" rel="noopener ugc nofollow" target="_blank"> Azure静态Web应用</a> VS代码扩展</li><li id="ff77" class="lh li hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated">安装<a class="ae jt" href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-azurefunctions" rel="noopener ugc nofollow" target="_blank"> Azure函数</a> VS代码扩展</li></ul><h2 id="4fcb" class="kt jw hi bd jx ku kv kw kb kx ky kz kf iq la lb kj iu lc ld kn iy le lf kr lg bi translated">步伐</h2><ol class=""><li id="25f8" class="lh li hi ih b ii lj im lk iq ll iu lm iy ln jc lx lp lq lr bi translated">在根目录下创建<em class="ly"> api </em>文件夹</li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lz"><img src="../Images/620c5985dc4dc10c6c107f4184b863e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1108/format:webp/1*6nh3KplomprF523EZm7yXQ.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在根目录下创建<em class="ju"> api </em>文件夹</figcaption></figure><p id="679e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.通过将<em class="ly"> api </em>文件夹作为根项目，打开新的Visual Studio代码窗口。我认为这是一种解决办法<strong class="ih hj">正如<strong class="ih hj"> </strong>我正在努力解决静态Web Apps VS代码扩展的问题，它总是在根目录下创建<em class="ly"> api </em>项目，并覆盖现有的package.json文件。</strong></p><p id="9d99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.按下<em class="ly"> F1 </em>打开命令面板。</p><p id="1c34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.选择Azure静态Web应用程序:创建HTTP函数…</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ma"><img src="../Images/c403feaf3e4ff5afe17d2bfd0b5daf5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ckn5nlaQrFbc5MN7wWXVA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">选择Azure静态Web应用程序:创建HTTP函数…</figcaption></figure><p id="db38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.出现提示时，输入以下值:</p><ul class=""><li id="0456" class="lh li hi ih b ii ij im in iq mb iu mc iy md jc lo lp lq lr bi translated">选择一种语言[JavaScript]</li><li id="3539" class="lh li hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated">提供一个函数名[activities]</li></ul><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es me"><img src="../Images/48d8e8ca4cf334fee1e981d4fe357e31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xKenjT39Xp8fFnjaq_C8uQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">选择一种语言[JavaScript]</figcaption></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mf"><img src="../Images/94ab97df9a032259961fc493ea268034.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zpzl61JK4ngkI6GI0xm7WQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">提供一个函数名[activities]</figcaption></figure><p id="e4f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果将是生成一个带有HTTP触发函数的Azure Functions项目。项目结构类似于以下示例:</p><pre class="je jf jg jh fd mg mh mi mj aw mk bi"><span id="35d9" class="kt jw hi mh b fi ml mm l mn mo">├── .github <br/>│   └── workflows <br/>│       └── azure-static-web-apps-&lt;DEFAULT_HOSTNAME&gt;.yml <br/>│<br/>├── api <br/>│   ├── activists <br/>│   │   ├── function.json <br/>│   │   └── index.js <br/>│   ├── host.json <br/>│   ├── local.settings.json <br/>│   └── package.json <br/>│ <br/>└── (folders and files from your static web app)</span></pre><p id="f2dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.接下来，我从Svelte应用程序中提取模拟数据(activists数据),现在它将由Azure Functions项目公开。现在，<code class="du mp mq mr mh b">activists</code>函数将通过<code class="du mp mq mr mh b">get</code>调用向前端返回活动者数组。</p><ul class=""><li id="0386" class="lh li hi ih b ii ij im in iq mb iu mc iy md jc lo lp lq lr bi translated">使用以下代码更新<a class="ae jt" href="https://github.com/totsawin/abolish112-blog/commit/5a581a11036e0f1bf76c242cfa37bc6afb185bde#diff-dd8d6c3a3ff40c0eeaead6c784aa5552099611f11bc54a898ffdb060f1b7f771" rel="noopener ugc nofollow" target="_blank">API/activities/index . js</a>中的函数，以返回activities数组</li></ul><pre class="je jf jg jh fd mg mh mi mj aw mk bi"><span id="5e9a" class="kt jw hi mh b fi ml mm l mn mo">const data = require('../shared/activists-data.js');</span><span id="d813" class="kt jw hi mh b fi ms mm l mn mo">module.exports = async function (context, req) {<br/>context.log('JavaScript HTTP trigger function processed a request.');<br/>try { <br/>  const activists = data.getActivists();<br/>  context.res.status(200).json(activists);<br/>} <br/>catch (error) {<br/>  context.res.status(500).json(error);    <br/>}}</span></pre><ul class=""><li id="32a7" class="lh li hi ih b ii ij im in iq mb iu mc iy md jc lo lp lq lr bi translated">将activities数组提取到<a class="ae jt" href="https://github.com/totsawin/abolish112-blog/commit/5a581a11036e0f1bf76c242cfa37bc6afb185bde#diff-e92231b1e1825ebf61ebf31134f5e488dcc58ab87833e392df57e28792de232e" rel="noopener ugc nofollow" target="_blank">API/shared/activities-data . js</a>，由<a class="ae jt" href="https://github.com/totsawin/abolish112-blog/commit/5a581a11036e0f1bf76c242cfa37bc6afb185bde#diff-dd8d6c3a3ff40c0eeaead6c784aa5552099611f11bc54a898ffdb060f1b7f771" rel="noopener ugc nofollow" target="_blank">API/activities/index . js</a>导入</li></ul><pre class="je jf jg jh fd mg mh mi mj aw mk bi"><span id="6a7d" class="kt jw hi mh b fi ml mm l mn mo">const data = {    <br/>  activists: [ ... ] <br/>}<br/>const <strong class="mh hj">getActivists</strong> = () =&gt; { return data.activists; };<br/>module.exports = { getActivists };</span></pre><h1 id="c1c4" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">更新前端应用程序以调用API</h1><p id="a5a0" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq mt is it iu mu iw ix iy mv ja jb jc hb bi translated">回到根项目，我更新了前端应用程序<a class="ae jt" href="https://github.com/totsawin/abolish112-blog/commit/4fe4ae168fa378d411d0fb5b979295e917b3edb3#diff-d68daa8b73cec8e4419759802bbd91e9f87f8ee02f25cdb1d12582ef6de848db" rel="noopener ugc nofollow" target="_blank"> src/App.svelte </a>，以在<code class="du mp mq mr mh b">/api/activists</code>从API中检索活动者数据，并利用该响应。如果一切正常，外观和感觉应该是一样的。</p><pre class="je jf jg jh fd mg mh mi mj aw mk bi"><span id="ba76" class="kt jw hi mh b fi ml mm l mn mo">import { onMount } from 'svelte';<br/>...<br/>let activists = [];<br/> <br/>function <strong class="mh hj">getNumberOfDaysUnderDetained</strong>(detainedDuration) {<br/>  return detainedDuration.reduce((acc, {detainedDate, releasedDate }) =&gt; {<br/>    const detainedDateTemporal = Temporal.PlainDate.from(detainedDate);<br/>    const releasedDateTemporal = releasedDate ? Temporal.PlainDate.from(releasedDate): todayDate;<br/>    return acc + detainedDateTemporal.until(releasedDateTemporal, { largestUnit: 'days' }).days;<br/>},0 );<br/>}</span><span id="c78c" class="kt jw hi mh b fi ms mm l mn mo"><strong class="mh hj">onMount</strong>(async () =&gt; {<br/>  await fetch("<strong class="mh hj">/api/activists</strong>")<br/>    .then(response =&gt; response.json())<br/>    .then(data =&gt; {<br/>      activists = data.map(activist =&gt; {<br/>        return {<br/>           ...<strong class="mh hj">activist</strong>,<br/>           <strong class="mh hj">detainedDays</strong>: <strong class="mh hj">getNumberOfDaysUnderDetained</strong>(activist.detainedDuration)<br/>        };<br/>      })<br/>    }).catch(error =&gt; {<br/>      console.log(error);<br/>  });<br/>});</span><span id="2a4a" class="kt jw hi mh b fi ms mm l mn mo">...<br/>&lt;div class="individual__caption"&gt;<br/>  &lt;span&gt;{ <strong class="mh hj">activist.detainedDays</strong> } Days Held Under Pre-Trial Detention&lt;/span&gt;<br/>&lt;/div&gt;<br/>&lt;div class="individual__image"&gt;<br/>  &lt;img src="./assets/{activist.nickname}.jpg" alt="{activist.name}"/&gt;<br/>  {#if activist.detainedDuration[activist.detainedDuration.length - 1].releasedDate}<br/>    &lt;div class="stamp is-bailed"&gt;BAILED&lt;/div&gt;<br/>  {/if}<br/>&lt;/div&gt;</span><span id="8bef" class="kt jw hi mh b fi ms mm l mn mo">...</span></pre><h1 id="5c6f" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">本地运行前端和API</h1><p id="4b8c" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq mt is it iu mu iw ix iy mv ja jb jc hb bi translated">Azure Static Web Apps提供了一个模拟云环境的CLI。这个命令行界面可以在本地运行前端应用程序和API。</p><ul class=""><li id="8690" class="lh li hi ih b ii ij im in iq mb iu mc iy md jc lo lp lq lr bi translated">前端应用程序从已建立的文件夹提供，例如用于苗条的<em class="ly">公共</em>文件夹</li><li id="ddee" class="lh li hi ih b ii ls im lt iq lu iu lv iy lw jc lo lp lq lr bi translated">api从API文件夹提供，SWA CLI利用Azure Functions核心工具来提供API</li></ul><h2 id="b786" class="kt jw hi bd jx ku kv kw kb kx ky kz kf iq la lb kj iu lc ld kn iy le lf kr lg bi translated">安装命令行工具</h2><ol class=""><li id="15a9" class="lh li hi ih b ii lj im lk iq ll iu lm iy ln jc lx lp lq lr bi translated">安装Azure静态Web应用程序CLI。</li></ol><pre class="je jf jg jh fd mg mh mi mj aw mk bi"><span id="8f16" class="kt jw hi mh b fi ml mm l mn mo">npm install -g @azure/static-web-apps-cli</span></pre><p id="d052" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.安装Azure Functions核心工具最新版本。</p><pre class="je jf jg jh fd mg mh mi mj aw mk bi"><span id="f349" class="kt jw hi mh b fi ml mm l mn mo">npm i -g azure-functions-core-tools@4 --unsafe-perm true</span></pre><h2 id="5434" class="kt jw hi bd jx ku kv kw kb kx ky kz kf iq la lb kj iu lc ld kn iy le lf kr lg bi translated">构建前端应用程序</h2><p id="2206" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq mt is it iu mu iw ix iy mv ja jb jc hb bi translated">运行以下命令来构建苗条的前端应用程序，因为仿真工具将使用这些静态资产来服务前端应用程序</p><pre class="je jf jg jh fd mg mh mi mj aw mk bi"><span id="2cff" class="kt jw hi mh b fi ml mm l mn mo">npm run build</span></pre><h2 id="8dcc" class="kt jw hi bd jx ku kv kw kb kx ky kz kf iq la lb kj iu lc ld kn iy le lf kr lg bi translated">启动CLI</h2><ol class=""><li id="41a3" class="lh li hi ih b ii lj im lk iq ll iu lm iy ln jc lx lp lq lr bi translated">运行静态Web Apps CLI，并提供包含前端应用程序和API后端的文件夹:</li></ol><pre class="je jf jg jh fd mg mh mi mj aw mk bi"><span id="95df" class="kt jw hi mh b fi ml mm l mn mo">swa start ./public --api-location ./api</span></pre><p id="f099" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的命令是从/ <em class="ly"> public </em>文件夹服务前端app。或者，静态Web Apps CLI提供了从前端开发服务器提供服务的选项:</p><pre class="je jf jg jh fd mg mh mi mj aw mk bi"><span id="c7d0" class="kt jw hi mh b fi ml mm l mn mo">swa start http://localhost:3000 --api-location ./api</span></pre><p id="a35c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.当CLI进程启动时，在<code class="du mp mq mr mh b">http://localhost:4280/</code>访问应用程序。开发人员工具可用于验证前端应用程序是否对API进行了实际调用。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mw"><img src="../Images/81756f95b763640731ac34b3024969d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5rvek1mb0dMLmcfwsLMiDA.png"/></div></div></figure><h1 id="7b1d" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">将API位置添加到工作流</h1><p id="e062" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq mt is it iu mu iw ix iy mv ja jb jc hb bi translated">作为将应用程序部署到Azure静态Web应用程序之前的最后一步，GitHub操作工作流需要用API文件夹的正确位置进行更新。</p><ol class=""><li id="9c04" class="lh li hi ih b ii ij im in iq mb iu mc iy md jc lx lp lq lr bi translated">在<a class="ae jt" href="https://github.com/totsawin/abolish112-blog/commit/5a581a11036e0f1bf76c242cfa37bc6afb185bde#diff-98f188874d607f5575ea25d4aeccd886c08d9e69227a6432915be3e932c2a3bf" rel="noopener ugc nofollow" target="_blank"> <em class="ly">打开工作流文件。github/workflows/azure-static-web-apps-&lt;DEFAULT-HOSTNAME&gt;。yml </em> </a>。</li><li id="04ce" class="lh li hi ih b ii ls im lt iq lu iu lv iy lw jc lx lp lq lr bi translated">搜索属性<code class="du mp mq mr mh b">api_location</code>，并将值设置为<code class="du mp mq mr mh b">api</code>。</li><li id="4fe8" class="lh li hi ih b ii ls im lt iq lu iu lv iy lw jc lx lp lq lr bi translated">保存文件。</li></ol><h1 id="b5ec" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">部署更改</h1><p id="7ce0" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq mt is it iu mu iw ix iy mv ja jb jc hb bi translated">要发布对Azure Static Web Apps的更改，提交并推送代码到目标分支中的远程GitHub存储库。Github Actions将运行基于GitHub Actions工作流的作业——通常，它将构建和部署应用程序。</p><h1 id="d173" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">参考</h1><ol class=""><li id="83bf" class="lh li hi ih b ii lj im lk iq ll iu lm iy ln jc lx lp lq lr bi translated"><a class="ae jt" href="https://docs.microsoft.com/en-us/azure/static-web-apps/add-api?tabs=vanilla-javascript" rel="noopener ugc nofollow" target="_blank"> Azure静态Web应用文档</a></li></ol></div></div>    
</body>
</html>