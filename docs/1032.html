<html>
<head>
<title>Azure Service Bus — Publish/Subscribe Pattern</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure 服务总线—发布/订阅模式</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/azure-service-bus-publish-subscribe-pattern-178dd44baa36?source=collection_archive---------5-----------------------#2021-03-02">https://medium.com/nerd-for-tech/azure-service-bus-publish-subscribe-pattern-178dd44baa36?source=collection_archive---------5-----------------------#2021-03-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/13eb188200f89378b38bab8e4f0cae2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zmfecPXBubO5SW4SaCe7VQ.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">帕特里克·亨德利在<a class="ae iu" href="https://unsplash.com/collections/2469754/bus?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="df64" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这篇文章是我写的关于使用 Azure 服务总线队列在单个发送者和单个接收者之间发送和接收消息的前一篇<a class="ae iu" href="https://csmithblog.medium.com/azure-service-bus-queue-storage-5780feb17d7c" rel="noopener">博客</a>的继续。在这里，我将扩展 FIFO 队列功能，描述如何使用发布和订阅模式实现一对多关系，其中多个接收者可以订阅接收相同的消息。</p><p id="78f1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所有示例代码都是使用 C#编写的。NET 核心，可以在我的<a class="ae iu" href="https://github.com/chrissmKainos/azure-service-bus-demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中找到。</p><h1 id="0086" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">这是如何工作的？</h1><p id="b551" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">消息从发送者<code class="du kw kx ky kz b">Publisher</code>发送到 Azure 服务总线主题。主题与队列非常相似，主要区别在于单个主题可以包含一个或多个订阅，消息将传递到这些订阅。可以对每个订阅应用过滤器，以管理它们从主题接收的消息，并且通常会根据消息内容或属性进行过滤。最后，一个或多个接收者<code class="du kw kx ky kz b">consumers</code>可以<code class="du kw kx ky kz b">subscribe</code>订阅以接收消息。这实现了我们的一对多模式。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/ed129c6c81b277a3fbc8ac947aa7b080.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nK35uH5jko5eZxrUR1Fz4Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Azure 服务总线—发布/订阅</figcaption></figure><h1 id="b728" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Azure 门户安装程序</h1><p id="3b10" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">出于演示应用的目的，我使用 Azure 门户创建了一个主题<code class="du kw kx ky kz b">demotopic</code>，包含两个订阅者<code class="du kw kx ky kz b">allnumbersubscription &amp; evennumbersubscription</code>。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lf"><img src="../Images/41597272a666cebe47fe9f75b1047bf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f2h2vx086R1nbpZBtwxvAg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Azure 门户—主题</figcaption></figure><ul class=""><li id="81f3" class="lg lh hi ix b iy iz jc jd jg li jk lj jo lk js ll lm ln lo bi translated"><code class="du kw kx ky kz b">allnumbersubscription<br/></code>该订阅包含一个默认过滤器，它将查看从主题发送到订阅的所有消息。</li></ul><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/f7b2b9db32d254db8527b15dbd4befc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EZawXpos7ZNPz_Gze0pyWA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Azure 门户—使用默认过滤器的订阅</figcaption></figure><ul class=""><li id="8e21" class="lg lh hi ix b iy iz jc jd jg li jk lj jo lk js ll lm ln lo bi translated"><code class="du kw kx ky kz b">evennumbersubscription<br/></code>该订阅包含一个基于名为<code class="du kw kx ky kz b">MyMessageNumber</code>的消息属性的自定义过滤器，只允许从属性值为偶数的主题发送消息。</li></ul><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/abdb849af43e8813f555bf79d0baad07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MyL4Vf5F19GlJC_Ws5PqAw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Azure 门户—带有自定义过滤器的订阅</figcaption></figure><h1 id="6a9a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">演示应用程序</h1><p id="6ca4" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">正如已经提到的，我将使用 C#作为我的演示应用程序的语言选择。我已经扩展了我在 Azure Service Bus 上的第一篇博客中使用的应用程序，允许使用队列或发布/订阅模式。</p><h2 id="54e9" class="lr ju hi bd jv ls lt lu jz lv lw lx kd jg ly lz kh jk ma mb kl jo mc md kp me bi translated">AppSettings</h2><p id="2026" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">这是演示应用程序的配置文件。它包含一个布尔标志<code class="du kw kx ky kz b">UseTopic</code>，用于指示是否要使用主题来代替队列。我们将其设置为 true，以表明我们希望使用主题和发布/订阅方法。该文件中的其他设置是服务总线的连接字符串，以及已经用 Azure portal 创建的队列、主题和订阅的名称。</p><figure class="lb lc ld le fd ij"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">appsettings —配置文件</figcaption></figure><h2 id="847e" class="lr ju hi bd jv ls lt lu jz lv lw lx kd jg ly lz kh jk ma mb kl jo mc md kp me bi translated">程序类</h2><p id="071b" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我们项目的主文件，它负责从<code class="du kw kx ky kz b">appsettings.json</code>文件中读取配置值，并设置将被传递到<code class="du kw kx ky kz b">SendMessagesAsync </code>和<code class="du kw kx ky kz b">ReceiveMessagesAsync</code>中的所需参数。由于我们已经在配置文件中将<code class="du kw kx ky kz b">UseTopic</code>设置为真，参数将被设置为值<code class="du kw kx ky kz b">DemoTopicName</code>和<code class="du kw kx ky kz b">DemoSubscriptionName</code>。</p><figure class="lb lc ld le fd ij"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">Program —启动处理的主类</figcaption></figure><h2 id="8f80" class="lr ju hi bd jv ls lt lu jz lv lw lx kd jg ly lz kh jk ma mb kl jo mc md kp me bi translated">发送者类别</h2><p id="fe10" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">在<code class="du kw kx ky kz b">Sender.cs</code>类中，有三个主要任务正在执行，都在 SendMessagesAsync 方法中:</p><ol class=""><li id="2a25" class="lg lh hi ix b iy iz jc jd jg li jk lj jo lk js mh lm ln lo bi translated">创建一个<code class="du kw kx ky kz b">ServiceBusClient</code>，从 config 传入连接字符串。这个客户端在 Azure 中为我们提供了到服务总线的连接。</li><li id="face" class="lg lh hi ix b iy mi jc mj jg mk jk ml jo mm js mh lm ln lo bi translated">创建一个与客户端相关联的<code class="du kw kx ky kz b">ServiceBusSender</code>。我们从 config 中传递主题名称，以确保连接到正确的主题。</li><li id="30e6" class="lg lh hi ix b iy mi jc mj jg mk jk ml jo mm js mh lm ln lo bi translated">使用<code class="du kw kx ky kz b">SendMessageAsync</code>实际发送消息。进行此调用后，该消息将在链接到该主题的已过滤订阅中可用。</li></ol><p id="00db" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，在第 18 行，我向正在发送的消息添加了一个新的应用程序属性。该属性包含一个键-值对，键是在订阅过滤器<code class="du kw kx ky kz b">evennumberfilter</code>中使用的名称，值被设置为循环索引。此属性提供筛选器所需的数据，以确保订阅仅接收偶数。</p><p id="10dd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所有用于连接和发送的代码都是使用已安装的 NuGet 包<code class="du kw kx ky kz b">Azure.Messaging.ServiceBus</code>提供给我们的功能来执行的，这可以从第 3 行的 using 语句中看出。</p><figure class="lb lc ld le fd ij"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">Sender 负责发送消息的类</figcaption></figure><p id="4440" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该代码简单地迭代 SendMessageAsync 调用，向服务总线主题发送 20 条消息。一旦被主题接收，消息就被分发到主题订阅。我们可以看到过滤器已经将所有 20 条消息发送给了<code class="du kw kx ky kz b">allnumbersubscription</code>订阅，但是只有 10 条消息(那些偶数的)被发送给了<code class="du kw kx ky kz b">evennumbersubscription</code>订阅。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/e9e0ef9cb7ec3690b19b8f1e1d53b646.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OMTuymkO7lZGr6vT4E-0_A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Azure 门户—订阅概述，包含消费前的消息计数</figcaption></figure><h2 id="cb10" class="lr ju hi bd jv ls lt lu jz lv lw lx kd jg ly lz kh jk ma mb kl jo mc md kp me bi translated">接收器类别</h2><p id="9132" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">在<code class="du kw kx ky kz b">Receiver.cs</code>类中我们有三种方法:</p><ol class=""><li id="0953" class="lg lh hi ix b iy iz jc jd jg li jk lj jo lk js mh lm ln lo bi translated">MessageHandler <br/>该事件处理程序处理从订阅收到的每条消息，并调用<code class="du kw kx ky kz b">CompleteMessageAsync</code>将消息标记为完成，这将告诉服务总线删除该消息。</li><li id="6b97" class="lg lh hi ix b iy mi jc mj jg mk jk ml jo mm js mh lm ln lo bi translated">ErrorHandler <br/>这是 ServiceBusProcessor 所需的默认错误处理程序。</li><li id="f3a8" class="lg lh hi ix b iy mi jc mj jg mk jk ml jo mm js mh lm ln lo bi translated">ReceiveMessageAsync <br/>该方法具有以下职责:</li></ol><ul class=""><li id="04dc" class="lg lh hi ix b iy iz jc jd jg li jk lj jo lk js ll lm ln lo bi translated">创造一个<code class="du kw kx ky kz b">ServiceBusClient</code>。与发送方一样，config 中的连接字符串作为参数传入，以确保我们的客户端连接到 Azure 中正确的服务总线。</li><li id="23fc" class="lg lh hi ix b iy mi jc mj jg mk jk ml jo mm js ll lm ln lo bi translated">创建一个<code class="du kw kx ky kz b">ServiceBusProcessor</code>，给定主题名称、要订阅的订阅名称和默认处理器选项作为参数。处理器为我们提供了使用事件处理程序处理消息的能力。</li><li id="5281" class="lg lh hi ix b iy mi jc mj jg mk jk ml jo mm js ll lm ln lo bi translated">将两个事件处理程序分配给处理器事件。</li><li id="d3a1" class="lg lh hi ix b iy mi jc mj jg mk jk ml jo mm js ll lm ln lo bi translated">使用<code class="du kw kx ky kz b">StartProcessingAsync</code>调用开始处理消息。当从订阅收到消息时，将调用 MessageHandler 并处理消息。</li><li id="182e" class="lg lh hi ix b iy mi jc mj jg mk jk ml jo mm js ll lm ln lo bi translated">使用<code class="du kw kx ky kz b">StopProcessingAsync</code>调用停止消息处理。</li></ul><figure class="lb lc ld le fd ij"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">Receiver 负责接收和处理订阅的类</figcaption></figure><p id="b0cf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行完这段代码后，我们可以再次查看 Azure 门户来检查我们的订阅。如您所见，第一个订阅<code class="du kw kx ky kz b">allnumbersubscription</code>仍然包含 20 条消息，因为没有接收者订阅或处理其中的消息。第二个订阅<code class="du kw kx ky kz b">evennumbersubscription</code>，现在有 0 条消息，因为我们的 receiver 类订阅、处理了这些消息并将它们标记为完成。</p><figure class="lb lc ld le fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/a71123816b8c9bee4aa3c91a85b224e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZjFoH5g9cMOXJK2D4lgHaw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Azure 门户—订阅概述，包含使用后的消息计数</figcaption></figure><h1 id="f679" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">控制台窗口输出</h1><p id="9ba5" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">运行应用程序时，控制台窗口会提供一些调试消息。它显示了正在发送的 20 条消息，然后只有那些包含偶数的消息被已经订阅了<code class="du kw kx ky kz b">evennumbersubscription</code>的接收者处理:</p><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es mp"><img src="../Images/628f41bfb5c8761c0cefbcf92851fc44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*XITbx7ukE6FYTWcM05gRgQ.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">发送到主题的消息</figcaption></figure><figure class="lb lc ld le fd ij er es paragraph-image"><div class="er es mq"><img src="../Images/cf32c332cd5e5db68dbc8d823aa0795f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*i0nHBBS86kkhUl2wtAIuTw.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">从订阅收到的消息</figcaption></figure><h1 id="22d0" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">摘要</h1><p id="c8b2" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">在这篇博客中，我展示了如何使用 Azure 门户快速创建一个包含带有过滤器的多个订阅的服务总线主题，并使用门户查看订阅前后处理中的消息计数。我还提供了一些 C#代码示例，说明如何在一个非常轻量级的应用程序中连接到订阅并处理消息。</p><p id="b920" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">希望我在这里写的东西对你有所帮助，并推动你自己去看看 Azure Service Bus。</p><p id="254d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">感谢您的阅读，如果您能给这篇文章一个赞并分享，我将不胜感激。</p></div></div>    
</body>
</html>