<html>
<head>
<title>Data rollover in Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">弹性搜索中的数据翻转</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/data-rollover-in-elasticsearch-b809bb9f150a?source=collection_archive---------0-----------------------#2020-08-30">https://medium.com/nerd-for-tech/data-rollover-in-elasticsearch-b809bb9f150a?source=collection_archive---------0-----------------------#2020-08-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="30ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们生活在一个应用程序运行在海量数据上的时代。为了让我们的应用程序<strong class="ih hj">高效搜索</strong>和<strong class="ih hj">节省空间</strong>，我们需要从数据存储中截取过时的数据。删除旧数据有助于减少查询检索结果的搜索空间，并且需要更少的硬件来存储文档。从Elasticsearch索引中删除单个文档是一项非常昂贵的操作。Elasticsearch提供了一种更好的方法来实现这一点。我们可以创建并应用索引生命周期管理(ILM)策略，根据我们的性能、弹性和保留要求自动管理我们的索引。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/1b2312830acf1b5d766a89daa089be12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q5G0UKQ5JfG1vvtY299D6w.png"/></div></div></figure><p id="e8e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你不熟悉Elasticsearch的基础知识。我会推荐你参考这篇文章<a class="ae jp" rel="noopener" href="/@shivanshugoyal0111/elasticsearch-internals-4c4c9ec077fa?source=friends_link&amp;sk=252e1dcbfd3bed798a61e59a07e94e63"> Elasticsearch Internals </a>。每当需要从索引中自动删除文档时，索引应该是时序索引。时间序列索引需要附加ILM策略，以经历索引的四个可能阶段。</p><blockquote class="jq jr js"><p id="bfac" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">ILM保单的所有4个阶段并不是强制性的。例如，一个策略只能有热阶段和删除阶段。</p></blockquote><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jx"><img src="../Images/d81ad7f009133c98142ab350a67e8d36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tRqfWz9rfcjTJ_ijEFQE_A.png"/></div></div></figure><ol class=""><li id="b944" class="jy jz hi ih b ii ij im in iq ka iu kb iy kc jc kd ke kf kg bi translated"><strong class="ih hj">热阶段:</strong>这是我们主动写入和查询索引的阶段。为了更快地更新，当索引变得太大或太旧时，我们可以翻转索引。它有一个索引优先级标签。设置节点重启后恢复索引的优先级。优先级较高的索引在优先级较低的索引之前恢复。</li><li id="5e10" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated"><strong class="ih hj">暖阶段:</strong>我们还在查询我们的索引，但是是只读的。我们可以将碎片分配给性能较低的硬件。为了更快的搜索，我们可以减少碎片的数量，并强制合并片段。它还具有索引优先级和强制合并标签。强制合并通过合并较小的文件和清除已删除的文件，有助于减少碎片中的段数</li><li id="6e3b" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated"><strong class="ih hj">冷阶段:</strong>我们不太频繁地查询您的索引，因此我们可以在性能明显较低的硬件上分配碎片。因为我们的查询更慢，所以我们可以减少副本的数量。</li><li id="d886" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated"><strong class="ih hj">删除阶段:</strong>不再需要索引。</li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es km"><img src="../Images/889585f3ed1e5df7c58ca466963cce06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vHDRdOq6CR817Ft9K8606A.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">索引生命周期策略定义</figcaption></figure><h2 id="5f17" class="kr ks hi bd kt ku kv kw kx ky kz la lb iq lc ld le iu lf lg lh iy li lj lk ll bi translated">什么是最小年龄？</h2><p id="39a4" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">最小年龄是索引等待进入某个阶段的时间。<code class="du lr ls lt lu b">min_age</code>的默认值是0秒。在上面的例子中，索引一创建就进入热阶段。对于其他阶段，min_age是仅当索引被翻转时翻转完成时开始的年龄。例如，索引将在其总寿命<code class="du lr ls lt lu b">(2 days to be in hot phase + wait for 5 more days to elapse after the rollover is completed)</code>的7天后进入删除阶段。</p><blockquote class="jq jr js"><p id="669b" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><code class="du lr ls lt lu b">min_age</code>通常是指从索引创建时起经过的时间，除非配置了<code class="du lr ls lt lu b">index.lifecycle.origination_date</code>索引设置，在这种情况下，<code class="du lr ls lt lu b">min_age</code>将是从指定日期起经过的时间。如果索引翻转，那么<code class="du lr ls lt lu b">min_age</code>是从索引翻转的时间起经过的时间。这里的目的是执行与数据最后一次写入翻转索引的时间相关的以下阶段和操作。</p></blockquote><p id="e912" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们举一个指数没有滚动的例子。</p><pre class="je jf jg jh fd lv lu lw lx aw ly bi"><span id="b0b3" class="kr ks hi lu b fi lz ma l mb mc">{<br/>    "policy": {<br/>        "phases": {<br/>            "warm": {<br/>                "min_age": "7d",<br/>                "actions": {<br/>                    "readonly": {}<br/>                }<br/>            },<br/>            "delete": {<br/>                "min_age": "30d",<br/>                "actions": {<br/>                    "delete": {}<br/>                }<br/>            }<br/>        }<br/>    }<br/>}</span></pre><p id="0780" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的示例中，一个索引在创建7天后将有资格进入<a class="ae jp" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ilm-policy-definition.html" rel="noopener ugc nofollow" target="_blank">热</a>阶段，此时<a class="ae jp" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/_actions.html#ilm-readonly-action" rel="noopener ugc nofollow" target="_blank">只读</a>操作将把该索引设置为只读。在创建日期之后30天<em class="jt"> </em>之前，该指数不能进入删除阶段。一旦指数超过30天🎂将进入<a class="ae jp" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.5/ilm-policy-definition.html" rel="noopener ugc nofollow" target="_blank">删除阶段</a>被删除。</p><h2 id="f29a" class="kr ks hi bd kt ku kv kw kx ky kz la lb iq lc ld le iu lf lg lh iy li lj lk ll bi translated">翻转标签中的max_age和max_size是什么？</h2><p id="844e" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">索引将处于热状态，直到至少满足一个定义的条件。</p><pre class="je jf jg jh fd lv lu lw lx aw ly bi"><span id="e1d1" class="kr ks hi lu b fi lz ma l mb mc">//API to get index lifecycle policies<br/><strong class="lu hj">GET _ilm/policy/</strong></span><span id="aadf" class="kr ks hi lu b fi md ma l mb mc">//API to get a particular policy<br/><strong class="lu hj">GET _ilm/policy/my_index_policy</strong></span></pre><blockquote class="jq jr js"><p id="99b6" class="if ig jt ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">一个索引停留在一个阶段，直到它满足它的最小年龄并完成定义的动作。</p></blockquote><p id="9d7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">指数ILM策略告诉elasticsearch将指数移动到哪个阶段，以及在每个定义的阶段采取什么措施。在手动创建索引时，可以将策略应用于索引。但是对于时序索引，策略需要附加索引模板，这有助于在目标索引发生翻转时创建引用相同索引模板的新索引。</p><h2 id="30e6" class="kr ks hi bd kt ku kv kw kx ky kz la lb iq lc ld le iu lf lg lh iy li lj lk ll bi translated">我们来了解一下什么是指数模板？</h2><p id="3b44" class="pw-post-body-paragraph if ig hi ih b ii lm ik il im ln io ip iq lo is it iu lp iw ix iy lq ja jb jc hb bi translated">索引模板是一种告诉Elasticsearch如何配置索引的方式，当它被手动创建或通过在索引中索引文档来创建时。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es me"><img src="../Images/4db776f46c1c9e89637c4681672d7967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zk7q0SkL2Xyfa0HtPdqUMg.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">该索引模板将应用于所有以<strong class="bd kt"> my_index- </strong>开头的索引，所有索引将遵循相同的<strong class="bd kt"> my_index_policy </strong>生命周期策略。</figcaption></figure><p id="9750" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的模板定义中，<strong class="ih hj"> my_index </strong>是一个别名，可以用作一个<strong class="ih hj">常量</strong>名称，在索引中搜索/索引文档。例如，<strong class="ih hj"> my_index-000001 </strong>、<strong class="ih hj"> my_index-000002 </strong>是2个遵循上述指标模板的指标，以及<strong class="ih hj"><em class="jt">my _ index _ policy</em></strong>生命周期策略。</p><pre class="je jf jg jh fd lv lu lw lx aw ly bi"><span id="b356" class="kr ks hi lu b fi lz ma l mb mc">//API to get all the defined templates in a cluster<br/><strong class="lu hj">GET /_template </strong></span><span id="db19" class="kr ks hi lu b fi md ma l mb mc">//API to get a particular template<br/><strong class="lu hj">GET /_template/my_index_template</strong></span><span id="0681" class="kr ks hi lu b fi md ma l mb mc">//API to create a template<br/><strong class="lu hj">PUT /_template/my_index_template along with request body</strong></span></pre></div><div class="ab cl mf mg gp mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hb hc hd he hf"><h2 id="0c85" class="kr ks hi bd kt ku kv kw kx ky kz la lb iq lc ld le iu lf lg lh iy li lj lk ll bi translated">创建时间序列索引的步骤</h2><ol class=""><li id="c98c" class="jy jz hi ih b ii lm im ln iq mm iu mn iy mo jc kd ke kf kg bi translated">创建索引策略来决定索引的生命周期。创建策略的定义已经解释过了。</li><li id="43a3" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated">创建索引模板，以便在现有索引从热阶段转移到其他阶段时自动创建新索引。创建索引模板的定义已经添加。</li><li id="6c18" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc kd ke kf kg bi translated">首先，我们需要引导一个初始索引，并将其指定为索引模板中指定的翻转别名的写索引。此索引的名称必须与模板的索引模式匹配，并以数字结尾。在翻转时，该值会递增以生成新索引的名称。</li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mp"><img src="../Images/75b18954437fc24a17fa6852dd634ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*UNQEdpqyjzGZncreYn9Ewg.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">引导时序索引以遵循生命周期政策和索引模板</figcaption></figure><h2 id="5a71" class="kr ks hi bd kt ku kv kw kx ky kz la lb iq lc ld le iu lf lg lh iy li lj lk ll bi translated">让我们理解这个策略如何作用于创建的索引。</h2><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mq"><img src="../Images/9ba2c3803452bb8b650a668adbf96c71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6AkpFEAJwadSYhtX72fe9A.png"/></div></div><figcaption class="kn ko et er es kp kq bd b be z dx translated">使用my_index_policy的索引翻转</figcaption></figure><ul class=""><li id="9714" class="jy jz hi ih b ii ij im in iq ka iu kb iy kc jc mr ke kf kg bi translated">所有索引都可以通过相同的别名<code class="du lr ls lt lu b">my_index</code>进行搜索</li><li id="783c" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc mr ke kf kg bi translated"><code class="du lr ls lt lu b">my_index_000001</code>和<code class="du lr ls lt lu b">my_index_000002</code>分别在第8天和第10天被删除。</li><li id="f2c4" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc mr ke kf kg bi translated">处于热阶段的索引将只允许写入。</li><li id="d0c8" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc mr ke kf kg bi translated">删除索引会删除索引中的所有文档以及元数据。</li><li id="8dba" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc mr ke kf kg bi translated">在上面的示例中，由于删除阶段min_age为5天，索引在暖阶段停留5天，以等待进入删除阶段。</li><li id="a0e9" class="jy jz hi ih b ii kh im ki iq kj iu kk iy kl jc mr ke kf kg bi translated">当当前索引发生翻转时，它会创建一个新的索引，该索引的编号会增加(例如，从<code class="du lr ls lt lu b">my_index_000001</code>到<code class="du lr ls lt lu b">my_index_000002</code>)，当前索引将进入预热阶段，新索引将启用写操作。</li></ul></div><div class="ab cl mf mg gp mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="hb hc hd he hf"><p id="69c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我试图借助图表，用简单的语言解释时间序列指数的指数生命周期管理策略，以滚动来自弹性搜索指数的数据。<a class="ae jp" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/index-lifecycle-management.html" rel="noopener ugc nofollow" target="_blank"> Elasticsearch官方文档</a>有详细的段落来阅读更多相关内容。</p><p id="f372" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢阅读！</p></div></div>    
</body>
</html>