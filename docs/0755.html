<html>
<head>
<title>Your First Golang Websocket: FX Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你的第一个 Golang Websocket: FX 数据</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/your-first-golang-websocket-fx-data-fc1eb7db35f0?source=collection_archive---------5-----------------------#2021-02-11">https://medium.com/nerd-for-tech/your-first-golang-websocket-fx-data-fc1eb7db35f0?source=collection_archive---------5-----------------------#2021-02-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2906" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">听说了很多围棋(Golang)的事，决定试一试。由于我的专业领域在于处理实时外汇数据，所以我决定使用 Go 提取实时外汇数据。如果 Go 不合你的胃口，如果你感兴趣的话，可以使用 Websocket 的其他实现，如<a class="ae jd" href="https://rahul-khanna.medium.com/your-first-python-socketio-client-506b3c2e9187" rel="noopener"> Python </a>、<a class="ae jd" href="https://khanna-rahul.medium.com/your-first-c-websocket-client-5e7acc30681d" rel="noopener"> C# </a>和<a class="ae jd" rel="noopener" href="/nerd-for-tech/stream-real-time-forex-data-with-nodejs-websocket-9fb9b1c2e048"> NodeJS </a>。</p><p id="5a6e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我的发现。</p><ol class=""><li id="10c2" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">这可能是最容易设置的。</li><li id="24b5" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">并且很少或没有问题地工作。</li></ol><p id="be12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我相信很多围棋和其他语言的专家都不同意我的第二点。我自己喜欢 Python，尽管以上两点不是它的强项(我可能又做了一次)。</p><p id="3004" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们开始一些要求之前，你需要事先编程知识，互联网连接和电子邮件地址。</p><p id="c898" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于 JSON REST API，请阅读<a class="ae jd" rel="noopener" href="/nerd-for-tech/your-first-golang-rest-api-client-287c8dc0961">您的第一个 Golang REST API 客户端</a></p><p id="247a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们开始吧</p></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="4b98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">获取 Websocket API 密钥</strong></p><p id="d38d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们设置 Go 环境之前，让我们从<a class="ae jd" href="https://marketdata.tradermade.com/signup" rel="noopener ugc nofollow" target="_blank">https://marketdata.tradermade.com/signup</a>获取我们的外汇 WebSocket API 密钥。它是免费的。</p><p id="1e69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦你登录到你的账户，生成你的 API 密匙，并保持等待状态。</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es jz"><img src="../Images/39e4b6ba50fd56d7fc6e362d7bbdb264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*C1KavqBc5f5QAB4a.jpeg"/></div></div></figure></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="935a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">设置环境</strong></p><p id="25b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，从 https://golang.org/doc/install 下载并安装 Go</p><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kl"><img src="../Images/3e3a3ca3c6d450a79a2d5c510bc4b1e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r_oCD_obBAFQ_XwPZh5jLw.png"/></div></div></figure><p id="c0e2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是三个简单的步骤。</p><p id="c6d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装完成后，打开命令提示符，写下:</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="5872" class="kr ks hi kn b fi kt ku l kv kw">go version</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kx"><img src="../Images/2241183364104a4a5136ff57f1f67cfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Za-IynHxZEVcEyqBAEPJw.png"/></div></div></figure><p id="a8fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安装依赖项</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="e822" class="kr ks hi kn b fi kt ku l kv kw">go get github.com/gorilla/websocket</span></pre><p id="9c90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你现在必须跑了！</p></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="8881" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">去跑步</strong></p><p id="19ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们写一些代码，我们将从创建基本程序开始。main()函数将在程序运行时被调用，我们还将导入我们需要的库。对于本例，我们将使用以下内容:</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="1e3c" class="kr ks hi kn b fi kt ku l kv kw">// +build ignore</span><span id="bc63" class="kr ks hi kn b fi ky ku l kv kw">package main</span><span id="655f" class="kr ks hi kn b fi ky ku l kv kw">import (<br/>  "log"<br/>  "net/url"<br/>  "os"<br/>  "os/signal"<br/>  "time"<br/>  "github.com/gorilla/websocket"<br/>)<br/>func main() {<br/>//Add progrma content here <br/>}</span></pre><p id="aaaf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将向其中添加几个变量，一个用于存储输入消息，另一个用于在程序终止时处理中断事件。这些变量是消息传递的通道，类似于其他语言中的缓冲区。在 Go 中，通道可以是双向的，也可以是单向的。我们还将在我们的中断变量中添加一个信号通知程序，这样当程序终止时，我们可以很好地进行清理。</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="d4fe" class="kr ks hi kn b fi kt ku l kv kw">messageOut := make(chan string)<br/>interrupt := make(chan os.Signal, 1)<br/>signal.Notify(interrupt, os.Interrupt)</span></pre><p id="cc38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们将为 WebSocket 服务器的连接创建我们的 URL，我们将输出它以便我们可以检查 URL。</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="9640" class="kr ks hi kn b fi kt ku l kv kw">u := url.URL{Scheme: "wss", Host: "marketdata.tradermade.com", Path: "/feedadv",}<br/>log.Printf("connecting to %s", u.String())</span></pre><p id="2177" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将编写一些代码来建立与服务器的连接，并处理连接的不同结果。在创建时，我们会查找错误，如果发现错误，我们会向用户显示一条消息。本节的最后一行添加了“defer c.Close()”这是对程序说的，当这个函数完成时，在这个连接上调用 Close()。第一个 defer 将最后执行，将其视为堆栈中最后执行的内容。</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="27c9" class="kr ks hi kn b fi kt ku l kv kw">c, resp, err := websocket.DefaultDialer.Dial(u.String(), nil);</span><span id="aaad" class="kr ks hi kn b fi ky ku l kv kw">  if err != nil {<br/>    log.Printf("handshake failed with status %d", resp.StatusCode)<br/>    log.Fatal("dial:", err)<br/>  }<br/>  //When the program closes close the connection<br/>  defer c.Close()</span></pre><p id="4287" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们将编写处理连接的函数，这是一个 goroutine，所以异步运行，从提要中读取流程。在循环过程中，它使用 c 读取消息。ReadMessage()返回一条消息或一个错误。收到错误时，代码打印错误并退出，收到消息时，检查是否是连接消息，如果是，则返回一个字符串，其中包含 user_key 和所需的符号。一旦发送完毕，你将会收到一条回复给客户的价格信息。在本例中，我们只是将消息打印到屏幕上，但是您需要在这里处理消息数据。</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="9d9e" class="kr ks hi kn b fi kt ku l kv kw">done := make(chan struct{})<br/>  go func() {<br/>    defer close(done)<br/>    for {<br/>      _, message, err := c.ReadMessage()<br/>      if err != nil {<br/>        log.Println("read:", err)<br/>        return<br/>      }<br/>      log.Printf("recv: %s", message)<br/>      if string(message) == "Connected"{<br/>        log.Printf("Send Sub Details: %s", message)<br/>        messageOut &lt;- "{"userKey":"YOUR_API_KEY", "symbol":"EURUSD"}"<br/>      }<br/>    }<br/>  }()</span></pre><p id="1c91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个程序的最后一部分看起来很复杂，但实际上非常简单。这是一个常量循环，用于保持程序运行，因为 goroutine 是异步的，它不会锁定主线程，所以如果没有这个部分，程序就会返回，你的 feed 处理程序就会停止。</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="863d" class="kr ks hi kn b fi kt ku l kv kw">ticker := time.NewTicker(time.Second)</span><span id="d563" class="kr ks hi kn b fi ky ku l kv kw">  defer ticker.Stop()</span><span id="6a12" class="kr ks hi kn b fi ky ku l kv kw">  for {</span><span id="7b91" class="kr ks hi kn b fi ky ku l kv kw">    select {</span><span id="4007" class="kr ks hi kn b fi ky ku l kv kw">    case &lt;-done:</span><span id="1807" class="kr ks hi kn b fi ky ku l kv kw">      return</span><span id="99a9" class="kr ks hi kn b fi ky ku l kv kw">    case m := &lt;-messageOut:</span><span id="8de9" class="kr ks hi kn b fi ky ku l kv kw">      log.Printf("Send Message %s", m)</span><span id="8ba4" class="kr ks hi kn b fi ky ku l kv kw">      err := c.WriteMessage(websocket.TextMessage, []byte(m))</span><span id="165c" class="kr ks hi kn b fi ky ku l kv kw">      if err != nil {</span><span id="d683" class="kr ks hi kn b fi ky ku l kv kw">        log.Println("write:", err)</span><span id="2229" class="kr ks hi kn b fi ky ku l kv kw">        return</span><span id="d864" class="kr ks hi kn b fi ky ku l kv kw">      }</span><span id="b663" class="kr ks hi kn b fi ky ku l kv kw">    case t := &lt;-ticker.C:</span><span id="2515" class="kr ks hi kn b fi ky ku l kv kw">      err := c.WriteMessage(websocket.TextMessage, []byte(t.String()))</span><span id="03c6" class="kr ks hi kn b fi ky ku l kv kw">      if err != nil {</span><span id="6ac9" class="kr ks hi kn b fi ky ku l kv kw">        log.Println("write:", err)</span><span id="a430" class="kr ks hi kn b fi ky ku l kv kw">        return</span><span id="4ffc" class="kr ks hi kn b fi ky ku l kv kw">      }</span><span id="5ba5" class="kr ks hi kn b fi ky ku l kv kw">    case &lt;-interrupt:</span><span id="5382" class="kr ks hi kn b fi ky ku l kv kw">      log.Println("interrupt")</span><span id="6087" class="kr ks hi kn b fi ky ku l kv kw">      // Cleanly close the connection by sending a close message and then</span><span id="421e" class="kr ks hi kn b fi ky ku l kv kw">      // waiting (with timeout) for the server to close the connection.</span><span id="1436" class="kr ks hi kn b fi ky ku l kv kw">      err := c.WriteMessage(websocket.CloseMessage, websocket.FormatCloseMessage(websocket.CloseNormalClosure, ""))</span><span id="f724" class="kr ks hi kn b fi ky ku l kv kw">      if err != nil {</span><span id="f55b" class="kr ks hi kn b fi ky ku l kv kw">        log.Println("write close:", err)</span><span id="06f0" class="kr ks hi kn b fi ky ku l kv kw">        return</span><span id="ad95" class="kr ks hi kn b fi ky ku l kv kw">      }</span><span id="e235" class="kr ks hi kn b fi ky ku l kv kw">      select {</span><span id="30cb" class="kr ks hi kn b fi ky ku l kv kw">      case &lt;-done:</span><span id="d623" class="kr ks hi kn b fi ky ku l kv kw">      case &lt;-time.After(time.Second):</span><span id="ecb6" class="kr ks hi kn b fi ky ku l kv kw">      }</span><span id="99ae" class="kr ks hi kn b fi ky ku l kv kw">      return</span><span id="190b" class="kr ks hi kn b fi ky ku l kv kw">    }</span><span id="b425" class="kr ks hi kn b fi ky ku l kv kw">  }</span></pre><p id="5755" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们可以将所有代码放在一起，并设置您的 API _KEY，将文件保存为 websocketClient.go</p><p id="9b3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后从终端运行以下命令来运行您的代码:</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="e5eb" class="kr ks hi kn b fi kt ku l kv kw">go run websocketClient.go</span></pre><figure class="ka kb kc kd fd ke er es paragraph-image"><div role="button" tabindex="0" class="kf kg di kh bf ki"><div class="er es kz"><img src="../Images/be229094f988c8a838af227d9c68794b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TxRUdeSF0asJZN0C"/></div></div></figure><p id="55e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以看到实时价格。现在，您已经成功地运行了第一个 Websocket 客户端来提取 FX 数据。</p><p id="9ebf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完整的应用程序代码:</p><pre class="ka kb kc kd fd km kn ko kp aw kq bi"><span id="5b26" class="kr ks hi kn b fi kt ku l kv kw">// +build ignore</span><span id="2bcc" class="kr ks hi kn b fi ky ku l kv kw"> <br/>package main</span><span id="d849" class="kr ks hi kn b fi ky ku l kv kw">import (<br/>  "log"<br/>  "net/url"<br/>  "os"<br/>  "os/signal"<br/>  "time"<br/>  "github.com/gorilla/websocket"<br/>)<br/> </span><span id="012b" class="kr ks hi kn b fi ky ku l kv kw">func main() {<br/>//Create Message Out   <br/>  messageOut := make(chan string)<br/>  interrupt := make(chan os.Signal, 1)<br/>  signal.Notify(interrupt, os.Interrupt)<br/>  u := url.URL{Scheme: "wss", Host: "marketdata.tradermade.com", Path: "/feedadv",}<br/>  log.Printf("connecting to %s", u.String())<br/>  c, resp, err := websocket.DefaultDialer.Dial(u.String(), nil);<br/>  if err != nil {<br/>    log.Printf("handshake failed with status %d", resp.StatusCode)<br/>    log.Fatal("dial:", err)<br/>  }</span><span id="8898" class="kr ks hi kn b fi ky ku l kv kw">  //When the program closes close the connection<br/>  defer c.Close()<br/>  done := make(chan struct{})<br/>  go func() {<br/>    defer close(done)<br/>    for {<br/>      _, message, err := c.ReadMessage()<br/>      if err != nil {<br/>        log.Println("read:", err)<br/>        return<br/>      }<br/>      log.Printf("recv: %s", message)<br/>      if string(message) == "Connected"{<br/>        log.Printf("Send Sub Details: %s", message)<br/>        messageOut &lt;- "{"userKey":"YOUR_API_KEY", "symbol":"EURUSD"}"<br/>      }<br/>    }</span><span id="292b" class="kr ks hi kn b fi ky ku l kv kw">  }()</span><span id="a545" class="kr ks hi kn b fi ky ku l kv kw">  ticker := time.NewTicker(time.Second)<br/>  defer ticker.Stop()<br/>  for {<br/>    select {<br/>    case &lt;-done:<br/>      return<br/>    case m := &lt;-messageOut:<br/>      log.Printf("Send Message %s", m)<br/>      err := c.WriteMessage(websocket.TextMessage, []byte(m))<br/>      if err != nil {<br/>        log.Println("write:", err)<br/>        return<br/>      }<br/>    case t := &lt;-ticker.C:<br/>      err := c.WriteMessage(websocket.TextMessage, []byte(t.String()))<br/>      if err != nil {<br/>        log.Println("write:", err)<br/>        return<br/>      }<br/>    case &lt;-interrupt:<br/>      log.Println("interrupt")<br/>      // Cleanly close the connection by sending a close message and then<br/>      // waiting (with timeout) for the server to close the connection.<br/>      err := c.WriteMessage(websocket.CloseMessage, websocket.FormatCloseMessage(websocket.CloseNormalClosure, ""))<br/>      if err != nil {<br/>        log.Println("write close:", err)<br/>        return<br/>      }<br/>      select {<br/>      case &lt;-done:<br/>      case &lt;-time.After(time.Second):<br/>      }<br/>      return<br/>    }<br/>  }<br/>}</span></pre></div><div class="ab cl js jt gp ju" role="separator"><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx jy"/><span class="jv bw bk jw jx"/></div><div class="hb hc hd he hf"><p id="6fe6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我在 TraderMade 工作，该公司使用 AWS(亚马逊网络服务)作为我们的数据中心合作伙伴，提供实时数据服务。</p><p id="b67d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如果您喜欢 API 设置并需要更多信息:</strong></p><p id="0cd0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">联系 sales@tradermade.com 的<a class="ae jd" href="mailto:sales@tradermade.com" rel="noopener ugc nofollow" target="_blank">或在 https://tradermade.com/</a>与团队成员实时聊天。</p></div></div>    
</body>
</html>