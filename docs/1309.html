<html>
<head>
<title>A journey from callback hell to Kotlin coroutines, episode 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从回调地狱到科特林协程的旅程，第2集</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/a-journey-from-callback-hell-to-kotlin-coroutines-episode-2-c048f9898f?source=collection_archive---------13-----------------------#2021-03-13">https://medium.com/nerd-for-tech/a-journey-from-callback-hell-to-kotlin-coroutines-episode-2-c048f9898f?source=collection_archive---------13-----------------------#2021-03-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/370f1d1938b7aa25d7fb9fcffe30a152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*axtmjpMgycQisZUL"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">马克·赖歇尔在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="4d91" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在这里找到第一集<a class="ae iu" rel="noopener" href="/ahmednmahran/a-journey-from-callback-hell-to-kotlin-coroutines-episode-1-98b52821b323"/></p><p id="c9b7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好了，现在，在午睡后，艾哈迈德感觉很好。他以祈祷、吃早餐开始他的日常工作，然后他继续研究协程。</p><p id="2f1e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">他想知道那个<strong class="ix hj"> suspend </strong>关键字后面是什么，他继续他的进度阅读，</p><blockquote class="jt ju jv"><p id="2cee" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">协程的概念是一个函数可以在某个时候暂停执行，稍后再继续执行。</p></blockquote><p id="8a27" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Ahmed几乎被说服选择协程而不是其他解决方案。但是想写一些代码来看看它的运行情况。他在<a class="ae iu" href="https://kotlinlang.org/docs/coroutines-basics.html#your-first-coroutine" rel="noopener ugc nofollow" target="_blank"> kotlinlang </a>网站上找到了下面的代码片段来展示一个简单的协程</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ka"><img src="../Images/0da820faedf2831f486d6e4740b4d5f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8XWQgANweG-qBffjKMGSxw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">显示一个简单协程的代码片段，<a class="ae iu" href="https://kotlinlang.org/docs/coroutines-basics.html#your-first-coroutine" rel="noopener ugc nofollow" target="_blank"> kotlinlang </a></figcaption></figure><p id="0151" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">他发现了以下输出:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="4c23" class="kk kl hi kg b fi km kn l ko kp">Hello,<br/>World!</span></pre><p id="554a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有意思，但是什么是<em class="jw">范围</em>和<em class="jw">发射？艾哈迈德问道，然后他继续阅读以得到答案</em>:</p><h1 id="1d21" class="kq kl hi bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">协程上下文和调度程序</h1><blockquote class="jt ju jv"><p id="bf5b" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">协程总是在某些上下文中执行 …,协程上下文是各种元素的集合。主要元素是协程的<a class="ae iu" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-job/index.html" rel="noopener ugc nofollow" target="_blank">作业</a>和它的<strong class="ix hj">调度器</strong>。</p></blockquote><p id="ead4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">协程上下文包括一个<em class="jw">协程调度器</em>(见<a class="ae iu" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-dispatcher/index.html" rel="noopener ugc nofollow" target="_blank">协程调度器</a>)，它决定相应的协程使用哪个或哪些线程来执行。协程调度程序可以将协程的执行限制在一个特定的线程上，将它调度到一个线程池中，或者让它不受限制地运行。</p><p id="8a07" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以使用可选的<em class="jw">协程上下文、</em>来调用launch{}和async{}函数，以确定这个协程使用哪个线程来执行。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/ef32fe7a62a7597d16f8f10094d286a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sGkaEVrVSQCaMallw_940g.png"/></div></div></figure><p id="4fbf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行上面的代码片段，Ahmed看到了以下输出:</p><pre class="kb kc kd ke fd kf kg kh ki aw kj bi"><span id="eac0" class="kk kl hi kg b fi km kn l ko kp">Unconfined            : I'm working in thread main<br/>Default               : I'm working in thread DefaultDispatcher-worker-1<br/>newSingleThreadContext: I'm working in thread MyOwnThread<br/>main runBlocking      : I'm working in thread main</span></pre><p id="d9c1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，在继续阅读这里的<a class="ae iu" href="https://kotlinlang.org/docs/coroutine-context-and-dispatchers.html#dispatchers-and-threads" rel="noopener ugc nofollow" target="_blank">之后，他对如何运行一个协程有了一个很好的想法。</a></p><h1 id="01d5" class="kq kl hi bd kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">检查性能</h1><p id="bb93" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">为了确保协程是轻量级的，并且不像真正的线程那样昂贵，Ahmed决定运行一个<strong class="ix hj">百万线程，并对协程做同样的事情，:D </strong></p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/7793056ac8d0cb014dbfa75b2edec187.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BjSMzsREnnhfAJtG9nSV9Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">来自<a class="ae iu" href="https://kotlinlang.org/docs/coroutines-basic-jvm.html#let-s-run-a-lot-of-them" rel="noopener ugc nofollow" target="_blank"> kotlinlang </a>的snipper，运行1M线程</figcaption></figure><p id="d503" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它运行1，000，000个线程，每个线程添加一个公共计数器。这在他的机器上花了超过4分11秒。</p><p id="cf53" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看看他用协程做同样的事情花了多长时间</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/40d323d7e638524f59568bb482589cb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dmTQSv3w0gburRHdWffb-w.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">来自<a class="ae iu" href="https://kotlinlang.org/docs/coroutines-basic-jvm.html#let-s-run-a-lot-of-them" rel="noopener ugc nofollow" target="_blank"> kotlinlang </a>的snipper，运行1M的协程</figcaption></figure><p id="4235" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个例子在<strong class="ix hj">不到一秒的时间内完成</strong>😮，但是它打印一些任意的数字，因为一些协程在<code class="du lu lv lw kg b">main()</code>打印结果之前没有完成。让我们解决这个问题。</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/eb9c95fab462adf304a937956c3b86ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Vj2wzZQJkvIDJc5GgwNwA.png"/></div></div></figure><p id="2161" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这打印了正确的总数。</p><p id="9ccf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">他还想确保我们的协同程序实际上是并行运行的。他给每个<code class="du lu lv lw kg b">async</code>加了一个<strong class="ix hj"> 1秒</strong>T1】，结果程序不应该运行1000000秒(超过11.5天):</p><figure class="kb kc kd ke fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/c7810abac8a829d7ec922c9106acdaff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rnjGG_2qQ_PDhgZyYHxmyQ.png"/></div></div></figure><p id="2d11" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这花了大约10秒钟，<strong class="ix hj">所以是的</strong>，协程确实是并行运行的。</p><p id="0178" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这一点上，Ahmed完全被说服使用协程而不是其他解决方案来处理线程和异步。他的kotlin应用程序中的代码。</p><p id="93db" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">他有一个关于协程的好主意来开始使用它们，但是当然他需要更多地阅读并在一些真实的项目中实践。所以也许我们可以在下一集看到他的发现:)</p></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><h1 id="8ef7" class="kq kl hi bd kr ks me ku kv kw mf ky kz la mg lc ld le mh lg lh li mi lk ll lm bi translated">参考</h1><p id="ec6e" class="pw-post-body-paragraph iv iw hi ix b iy lo ja jb jc lp je jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated"><a class="ae iu" href="https://kotlinlang.org/docs/coroutines-basic-jvm.htm" rel="noopener ugc nofollow" target="_blank">协程基础知识</a></p><p id="2c26" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://www.youtube.com/watch?v=pbq8ema7YTA" rel="noopener ugc nofollow" target="_blank">我在#MENADD与Google(阿拉伯语)中谈论协程</a></p><p id="4361" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://www.youtube.com/watch?v=ZTDXo0-SKuU" rel="noopener ugc nofollow" target="_blank">Manuel Vivo的Coroutines 101</a></p></div></div>    
</body>
</html>