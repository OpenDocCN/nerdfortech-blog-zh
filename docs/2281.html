<html>
<head>
<title>Deploying Javascript functions on Google Big Query</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Big Query上部署Javascript函数</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/deploying-javascript-functions-on-google-big-query-2766432d207d?source=collection_archive---------15-----------------------#2021-04-29">https://medium.com/nerd-for-tech/deploying-javascript-functions-on-google-big-query-2766432d207d?source=collection_archive---------15-----------------------#2021-04-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3d9288d2341e3f38f9c9ff40fad360e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CJZA23E8hDX5G9AT"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@adityachinchure?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aditya Chinchure </a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="b5b0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Google BigQuery支持用Javascript和SQL编写的用户定义函数(UDF ),这开启了UDF可以提供的全新功能世界。</p><p id="c088" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们从在BigQuery的UDF中使用Javascript的一些基础知识开始。这里的示例使用标准SQL模式，因为这是首选语法。</p><p id="eaf9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在下面的例子中，创建了临时UDF，但这只是使测试和开发更容易。</p><h1 id="006c" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">返回类型</h1><p id="dca7" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">首先，一个简单的Javascript UDF返回一个布尔值:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="93cc" class="lf ju hi lb b fi lg lh l li lj">CREATE TEMP FUNCTION booleanExample()<br/>  RETURNS BOOLEAN<br/>  LANGUAGE js AS r"""<br/>    return true;<br/>  """<br/>;<br/>SELECT booleanExample() AS result;</span></pre><p id="f05f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来是返回字符串数组的UDF:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="faca" class="lf ju hi lb b fi lg lh l li lj">CREATE TEMP FUNCTION arrayOfStringsExample()<br/>  RETURNS ARRAY&lt;STRING&gt;<br/>  LANGUAGE js AS r"""<br/>    return ['one', 'two', 'three'];<br/>  """<br/>;<br/>SELECT arrayOfStringsExample() AS result;</span></pre><p id="59ad" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，UDF返回一个Javascript对象:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="0cf7" class="lf ju hi lb b fi lg lh l li lj">CREATE TEMP FUNCTION objectExample()<br/>  RETURNS STRUCT&lt;one INT64, two INT64, three INT64&gt;<br/>  LANGUAGE js AS r"""<br/>    return {one: 1, two: 2, three: 3};<br/>  """<br/>;<br/>SELECT objectExample() AS result;</span></pre><p id="fe21" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您要在<code class="du lk ll lm lb b">STRUCT</code>中指定Javascript对象中不存在的附加字段，它们将被简单地设置为<code class="du lk ll lm lb b">null</code>。反过来也是如此，所以您可以从结果<code class="du lk ll lm lb b">STRUCT</code>中省略字段，Javascript对象中的任何其他字段都不会被返回。</p><p id="4c9d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来，UDF返回一个对象数组:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="b7b9" class="lf ju hi lb b fi lg lh l li lj">CREATE TEMP FUNCTION arrayOfObjectsExample()<br/>  RETURNS ARRAY&lt;STRUCT&lt;one INT64, two INT64, three INT64&gt;&gt;<br/>  LANGUAGE js AS r"""<br/>    return [<br/>      {one: 1, two: 2, three: 3},<br/>      {one: 1, two: 2, three: 3}<br/>    ];<br/>  """<br/>;<br/>SELECT arrayOfObjectsExample() AS result;</span></pre><p id="762c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，UDF将一个字符串作为输入:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="be6a" class="lf ju hi lb b fi lg lh l li lj">CREATE TEMP FUNCTION echo(word STRING)<br/>  RETURNS STRING<br/>  LANGUAGE js AS r"""<br/>    return word;<br/>  """<br/>;<br/>SELECT echo('echo') AS result;</span></pre><p id="caa0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用上面的例子，你应该能够创建一个Javascript函数来返回你需要的数据类型。支持的数据类型的完整列表在<a class="ae iu" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions#supported-javascript-udf-data-types" rel="noopener ugc nofollow" target="_blank">标准SQL用户定义函数文档</a>中有详细说明。</p><h1 id="a1b7" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">捆绑资产</h1><p id="ee3d" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">对于小型或简单的UDF，使用内联Javascript很好，但是为了利用Javascript的各种开源模块，我们必须创建一个包含所有逻辑和代码的部署资产。</p><p id="92f6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个过程的一个常见选择是使用<a class="ae iu" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> webpack </a>，就像您使用web应用程序一样。</p><p id="bb30" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所需的<code class="du lk ll lm lb b">webpack.config.js</code>非常简单，我们只需定义一个入口点和一个结果输出文件名:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="00d3" class="lf ju hi lb b fi lg lh l li lj">module.exports = {<br/>  entry: './src/index.js',<br/>  mode: 'production',<br/>  output: {<br/>    filename: 'dist.js'<br/>  }<br/>}</span></pre><h1 id="fe2e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">入口点</h1><p id="6933" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我们将创建一个<code class="du lk ll lm lb b">index.js</code>文件，它将允许我们所有的功能在我们的BigQuery UDFs中出现并可用:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="3fab" class="lf ju hi lb b fi lg lh l li lj">const typeExamples = require('./typeExamples')</span><span id="00cb" class="lf ju hi lb b fi ln lh l li lj">const index = module.exports = {}</span><span id="700e" class="lf ju hi lb b fi ln lh l li lj">index.typeExamples = typeExamples<br/>index.helloWorld = () =&gt; 'Hello World!'</span><span id="49b4" class="lf ju hi lb b fi ln lh l li lj">// Put functionality you need in the global scope for BigQuery usage Object.assign(global, index)</span></pre><p id="f4ce" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上面的例子中，我们包含了另一个文件中的示例函数，并定义了一个简单的hello world函数。如果您有大量的功能，您可以使用npm模块，如<code class="du lk ll lm lb b">requireAll</code>。</p><p id="727f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您的javascript代码可以像任何其他node.js应用程序一样以通常的方式进行单元测试。</p><h1 id="f357" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">部署</h1><p id="42e0" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">要使用预构建的Javascript资产作为功能，我们需要首先将其部署到Google云存储(GCS)中。这里最简单的解决方案是手动将webpack创建的<code class="du lk ll lm lb b">dist.js</code>复制到GCS bucket。</p><p id="109d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于更加正式和协调的流程，我们可以创建一个Javascript脚本来将我们的资产部署到GCS。下面的代码是一个简单的例子。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="358b" class="lf ju hi lb b fi lg lh l li lj">const { Storage } = require('@google-cloud/storage')</span><span id="6118" class="lf ju hi lb b fi ln lh l li lj">const upload = async () =&gt; {<br/>  const storage = new Storage()<br/>  try {<br/>    await storage.createBucket('YOUR_BUCKET')<br/>  } catch (e) { // Don't worry if the bucket already exists<br/>    if (e.message !== 'Sorry, that name is not available. Please try a different one.')<br/>    throw e<br/>  }<br/>  return storage<br/>    .bucket('YOUR_BUCKET')<br/>    .upload('dist/dist.js', {<br/>      destination: 'bigquery-js-udf-example/dist/dist.js'<br/>    })<br/>}</span><span id="947f" class="lf ju hi lb b fi ln lh l li lj">upload()<br/>  .catch((e) =&gt; {<br/>    console.error(e.message)<br/>    process.exit(1)<br/>  })<br/>  .then(() =&gt; {<br/>    console.log('...Success')<br/>  })</span></pre><h2 id="2a58" class="lf ju hi bd jv lo lp lq jz lr ls lt kd jg lu lv kh jk lw lx kl jo ly lz kp ma bi translated">证明</h2><p id="6441" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">所有使用GCP功能的脚本都要求您的终端已经通过GCP认证。</p><p id="08ed" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">查阅<a class="ae iu" href="https://cloud.google.com/sdk/docs/quickstart" rel="noopener ugc nofollow" target="_blank"> Google的文档</a>安装SDK，然后可以使用以下命令来配置认证。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="a5a1" class="lf ju hi lb b fi lg lh l li lj">gcloud auth login<br/>gcloud auth application-default login</span></pre><p id="79f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">安装Google Cloud SDK后，可以使用以下命令轻松检查身份验证:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="9590" class="lf ju hi lb b fi lg lh l li lj">gcloud auth list</span></pre><p id="8e5c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请查阅CI提供商的文档，了解如何在部署时配置GCP身份验证，这通常是使用以前创建的服务帐户配置环境变量的情况。</p><h1 id="247c" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">测试</h1><p id="7273" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">现在我们准备用BigQuery测试我们的新资产。最简单的手动方法是在GCP BigQuery控制台中调用UDF，如下所示:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="11a3" class="lf ju hi lb b fi lg lh l li lj">CREATE TEMP FUNCTION booleanExample()<br/>  RETURNS BOOLEAN<br/>  LANGUAGE js OPTIONS (<br/>    library=["gs://YOUR_BUCKET/bigquery-js-udf-example/dist/dist.js"]<br/>  )<br/>  AS r"""<br/>    return typeExamples.boolean();<br/>  """<br/>;<br/>SELECT booleanExample() AS result;</span></pre><p id="bbac" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以使用编写单元测试的同一个框架来自动化测试。</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="1dfa" class="lf ju hi lb b fi lg lh l li lj">const { BigQuery } = require('@google-cloud/bigquery')</span><span id="1798" class="lf ju hi lb b fi ln lh l li lj">const runUdf = async (client, returnType, js) =&gt; {<br/>  const query = `<br/>    CREATE TEMP FUNCTION testFunction()<br/>      RETURNS ${returnType}<br/>      LANGUAGE js OPTIONS (<br/>        library=["gs://YOUR_BUCKET/bigquery-js-udf-example/dist/dist.js"]<br/>      )<br/>      AS r"""<br/>        ${js}<br/>      """<br/>    ;<br/>    SELECT testFunction() AS result;`<br/>  const [job] = await client.createQueryJob({<br/>    query<br/>  })<br/>  const [rows] = await job.getQueryResults()<br/>  return rows[0].result<br/>}<!-- --> </span><span id="e4e0" class="lf ju hi lb b fi ln lh l li lj">describe('BigQuery tests', () =&gt; {<br/>  let bigquery</span><span id="a8b4" class="lf ju hi lb b fi ln lh l li lj">  beforeAll(() =&gt; {<br/>    bigquery = new BigQuery({<br/>      projectId: process.env.GCP_PROJECT_ID<br/>    })<br/>  })</span><span id="53b0" class="lf ju hi lb b fi ln lh l li lj">  it('typeExamples.boolean()', async () =&gt; {<br/>    const result = await runUdf(bigquery, 'BOOLEAN', 'return typeExamples.boolean();')<br/>    expect(result).toBe(true)<br/>  })<br/>})</span></pre><h1 id="9910" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">NPM模块</h1><p id="7852" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">现在我们已经有了用webpack构建的JS资产和将代码部署到GCS的方法，我们可以根据需要包含其他模块。这可以以与任何其他客户端项目相同的方式包含在内。然而，你可以使用的东西有一些<a class="ae iu" href="https://cloud.google.com/bigquery/docs/reference/standard-sql/user-defined-functions#limitations" rel="noopener ugc nofollow" target="_blank">限制</a>。</p><p id="92fe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面的例子使用了<a class="ae iu" href="https://www.npmjs.com/package/sillyname" rel="noopener ugc nofollow" target="_blank"> sillyname </a> NPM模块，显示了包含第三方代码就像任何其他node.js应用程序一样:</p><pre class="kw kx ky kz fd la lb lc ld aw le bi"><span id="6557" class="lf ju hi lb b fi lg lh l li lj">const generateName = require('sillyname')<br/>const index = module.exports = {}<br/>index.sillyName = generateName<br/>Object.assign(global, index)</span></pre><p id="0996" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在可以在Javascript UDFs中访问<code class="du lk ll lm lb b">sillyName</code>函数，访问方式与前面的函数一样。</p><h1 id="06a5" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">包扎</h1><p id="ffea" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">Javascript UDF的允许你利用大量的开源模块进入你的UDF。使用流行的JS测试框架，如<a class="ae iu" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank"> Jest </a>或<a class="ae iu" href="https://mochajs.org/" rel="noopener ugc nofollow" target="_blank"> Mocha </a>，可以很容易地对这些功能进行单元和系统测试。</p><p id="64cd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">完整的工作示例、测试和部署脚本可以在随附的GitHub项目中找到，网址是:</p><p id="9e5f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><a class="ae iu" href="https://github.com/thedumbterminal/bigquery-js-udf-example" rel="noopener ugc nofollow" target="_blank">https://github.com/thedumbterminal/bigquery-js-udf-example</a></p></div><div class="ab cl mb mc gp md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="hb hc hd he hf"><p id="6279" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="mi">最初发表于</em><a class="ae iu" href="https://www.thedumbterminal.co.uk/posts/2021/03/deploying_javascript_functions_on_google_big_query.html" rel="noopener ugc nofollow" target="_blank"><em class="mi">【https://www.thedumbterminal.co.uk】</em></a><em class="mi">。</em></p></div></div>    
</body>
</html>