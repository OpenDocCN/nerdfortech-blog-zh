<html>
<head>
<title>The beauty of Firebase triggers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">火基触发器的美丽</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/the-beauty-of-firebase-triggers-1a9a554da707?source=collection_archive---------15-----------------------#2021-05-12">https://medium.com/nerd-for-tech/the-beauty-of-firebase-triggers-1a9a554da707?source=collection_archive---------15-----------------------#2021-05-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d8e654ca8a8402bf10f7f63052f1f4f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UwSnU7zr-aufVv-hiOBXzg.png"/></div></div></figure><p id="09bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">即使你没有使用Firebase，请耐心听我说。</p><p id="5425" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这仍然适用于任何微服务或使用NoSQL或其他类型的非规范化数据。</p><p id="0ea6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们开始之前，让我解释一下这些术语的含义:</p><ul class=""><li id="19b7" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">对于<a class="ae jx" rel="noopener" href="/@katedoesdev/normalized-vs-denormalized-databases-210e1d67927d">非规范化数据</a>，我指的是不符合第三范式的数据。跨存储条目复制的数据。例如，在文章和用户对象中保存作者姓名。</li><li id="fd10" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" href="https://martinfowler.com/articles/microservices.html" rel="noopener ugc nofollow" target="_blank">微服务</a>是一种将我们的应用拆分成可独立部署的独立可运行部分的方式。这有助于简化一些事情，例如更新、缩放和维护代码。然而，这也带来了复杂性的代价。</li><li id="5379" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" rel="noopener" href="/swlh/monolithic-vs-micro-services-and-all-in-between-7d496408ad02">monolith</a>是使用微服务的对立面。所有功能都在一个可部署的应用程序中运行。</li><li id="f03e" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated">与SQL数据库相比，NoSQL数据库需要<a class="ae jx" href="https://www.xplenty.com/blog/the-sql-vs-nosql-difference/#:~:text=multi-row%20transactions" rel="noopener ugc nofollow" target="_blank">不同的方法来进行多行更新</a>，在SQL数据库中，我们只需运行<code class="du kd ke kf kg b">update</code>来更新大量条目</li></ul><p id="b477" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">清楚了这一点，让我们来谈谈什么是触发因素。</p><h1 id="2414" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">传统触发器如何工作</h1><p id="1fe9" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">我今天要讲的<em class="lk">触发器类型</em>是<em class="lk">当某些事情发生变化时，它会导致一些代码运行。</em></p><p id="5aae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，让我们看看常见的<a class="ae jx" href="https://blog.bitsrc.io/what-is-an-orm-and-why-you-should-use-it-b2b6f75f5e2a" rel="noopener ugc nofollow" target="_blank"> ORM </a>框架是如何做到这一点的。例子可以是<a class="ae jx" href="https://docs.microsoft.com/en-us/ef/" rel="noopener ugc nofollow" target="_blank">微软的EntityFramework </a>、<a class="ae jx" href="https://www.baeldung.com/spring-boot-hibernate" rel="noopener ugc nofollow" target="_blank"> Hibernate </a>或者我在这里使用的例子<a class="ae jx" href="https://guides.rubyonrails.org/active_record_basics.html" rel="noopener ugc nofollow" target="_blank">Rails的活动记录</a>。尽管每个ORM的语法和特性不同，但它们通常具有相同的监听变化的核心能力。</p><p id="bc90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">特别是在活动记录中，我们使用<a class="ae jx" href="https://guides.rubyonrails.org/active_record_callbacks.html" rel="noopener ugc nofollow" target="_blank">回调</a>来对模型(也就是数据库表)中的变化做出反应。该模型继承了一个基类，该基类提供了我们可以用来注册回调的助手函数。在这些回调中，我们可以在模型改变时运行代码。</p><figure class="lm ln lo lp fd ij er es paragraph-image"><div class="er es ll"><img src="../Images/4230a5ca0c5eed3f1227c71dd6c70c75.png" data-original-src="https://miro.medium.com/v2/resize:fit:822/format:webp/1*Uv0NB0FxF8V4XxsxtVh31g.png"/></div><figcaption class="lq lr et er es ls lt bd b be z dx translated">Rails中常见活动记录事件模型的示意图</figcaption></figure><pre class="lm ln lo lp fd lu kg lv lw aw lx bi"><span id="133a" class="ly ki hi kg b fi lz ma l mb mc">class User &lt; ActiveRecord::Base</span><span id="3e56" class="ly ki hi kg b fi md ma l mb mc">  after_create    :subscribe_mailing_list, :send_welcome_mail</span></pre><p id="681b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">ActiveRecord触发器使得对数据更改做出反应变得非常简单。例如，当用户被保存时，它们需要很少的代码来触发电子邮件。</p><p id="0058" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">缺点是这个触发代码必须在模型内部。然后，该模型需要依赖于我们希望发生的任何功能。</p><p id="1d26" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这当然是可以避免的。例如，我们可以用<a class="ae jx" href="https://niallburkley.com/blog/ruby-publish-subscribe/" rel="noopener ugc nofollow" target="_blank"> Pub/Sub </a>将其解耦，但是开箱即用，这种模式和类似的模式通常会导致庞大臃肿的模型，变得越来越难以测试和维护。</p><h1 id="f05f" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">火基触发器如何工作</h1><p id="ca85" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">我不能保证Firebase触发器是如何工作的，但我认为它们建立在<a class="ae jx" href="https://cloud.google.com/pubsub/docs/overview" rel="noopener ugc nofollow" target="_blank"> Google Pub/ </a>子系统之上，这是一个异步消息系统，用于分离和扩展复杂系统。</p><p id="19fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它将消息系统包装在云功能SDK之后，因此您不必担心细节。它给你带来了两大好处:</p><ol class=""><li id="2344" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn me ju jv jw bi translated">所有默认服务都提供了您可以监听的事件，而无需在您这边添加任何额外的逻辑</li><li id="29ae" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn me ju jv jw bi translated">它是自然分布的和可扩展的，函数将根据需要扩展运行，排队等</li></ol><p id="dbc7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您实际上注册了云函数，以便在某些事件上调用，因此所有代码都有一个触发器作为它们的端点，例如:</p><pre class="lm ln lo lp fd lu kg lv lw aw lx bi"><span id="7e08" class="ly ki hi kg b fi lz ma l mb mc">exports = module.exports = functions.auth.user().onCreate(async (user) =&gt; {</span><span id="be9b" class="ly ki hi kg b fi md ma l mb mc">  await initUser(user.uid);</span><span id="78c8" class="ly ki hi kg b fi md ma l mb mc">});</span></pre><h1 id="df41" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">自然延伸</h1><p id="ef61" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">基于消息的架构的美妙之处在于它们自然解耦的方式，这使得它们非常具有可扩展性。</p><p id="a2fe" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每个服务(Firestore、Auth等)都公开了底层的关键事件，无论何时何地，只要您需要，您都可以挂钩到这些事件来执行一些代码，而不必修改源服务。</p><p id="a4ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们会在哪里使用这个？它实际上非常适合核心业务逻辑，例如:</p><ul class=""><li id="b923" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">当订单被取消时，进行退款</li><li id="4eb6" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated">当用户完成特定的转换事件时，向他们发送电子邮件</li><li id="3243" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated">当保存一个新项目时，保存非规范化的数据以便更好地阅读</li></ul><h1 id="1ec8" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">不仅仅是燃烧基地</h1><p id="c01b" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">当然，使用基于消息的系统和引发事件并不是什么新鲜事<a class="ae jx" href="https://martinfowler.com/tags/event%20architectures.html" rel="noopener ugc nofollow" target="_blank"/>。借助现代工具，您也可以轻松地在您的架构中使用它。还有<a class="ae jx" href="https://cloud.google.com/pubsub/docs" rel="noopener ugc nofollow" target="_blank"> Google Pub/Sub </a>或者<a class="ae jx" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-services.html" rel="noopener ugc nofollow" target="_blank"> AWS Lamba </a>。</p><p id="2e59" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，您需要做的是用一个框架来准备您的架构，该框架允许您简单地做两件事:</p><ol class=""><li id="92d8" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn me ju jv jw bi translated">为您的服务引发通用事件。这样，当您添加功能时，基本事件应该支持添加的新数据类型，而不必手动硬编码为这些类型引发事件。例如，不是在保存用户模型时引发事件，而是在保存任何模型时引发事件，将模型作为JSON对象传入。</li><li id="129d" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn me ju jv jw bi translated">创建一个通用框架来轻松订阅这些事件。这样，通过订阅来扩展功能的摩擦将会比试图在事件发生的地方添加功能的摩擦要小</li></ol><p id="9132" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有了这两样东西，你就实现了Firebase的开箱即用。</p><h1 id="1704" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">Firestore触发器和非规范化模型的示例</h1><p id="ddc6" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">下面是一个真实的例子，当作者更改姓名时，它会更新所有作者文章中的作者姓名。一个函数监听用户对象中的变化，如果名称发生了变化，则更新文章。</p><figure class="lm ln lo lp fd ij"><div class="bz dy l di"><div class="mf mg l"/></div></figure><h1 id="b617" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">看看这些文件</h1><p id="88a3" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">作为总结，展示所有的Firebase事件，链接到文档，并请人们给出他们的想法。</p><ul class=""><li id="909e" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated"><a class="ae jx" href="https://firebase.google.com/docs/functions/firestore-events" rel="noopener ugc nofollow" target="_blank">凡士多事件</a></li><li id="d6cf" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" href="https://firebase.google.com/docs/functions/database-events" rel="noopener ugc nofollow" target="_blank">实时数据库</a></li><li id="f70a" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" href="https://firebase.google.com/docs/functions/rc-events" rel="noopener ugc nofollow" target="_blank">远程配置</a></li><li id="69b7" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" href="https://firebase.google.com/docs/functions/auth-events" rel="noopener ugc nofollow" target="_blank">认证</a></li><li id="954e" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" href="https://firebase.google.com/docs/functions/analytics-events" rel="noopener ugc nofollow" target="_blank">分析</a>(仅转换事件)</li><li id="da6c" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" href="https://firebase.google.com/docs/functions/gcp-storage-events" rel="noopener ugc nofollow" target="_blank">云存储</a></li><li id="fce0" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" href="https://firebase.google.com/docs/functions/pubsub-events" rel="noopener ugc nofollow" target="_blank">发布/订阅</a></li><li id="8ae4" class="jo jp hi is b it jy ix jz jb ka jf kb jj kc jn jt ju jv jw bi translated"><a class="ae jx" href="https://firebase.google.com/docs/functions/test-lab-events" rel="noopener ugc nofollow" target="_blank">测试实验室</a></li></ul><p id="67ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完整列表和文档见<a class="ae jx" href="https://firebase.google.com/docs/functions" rel="noopener ugc nofollow" target="_blank"> Firebase云函数文档</a>。</p></div></div>    
</body>
</html>