<html>
<head>
<title>NestJs: Chat Server in NestJs backed by MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NestJs:由MongoDB支持的NestJs中的聊天服务器</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/nestjs-chat-server-in-nestjs-backed-by-mongodb-687da9aa30bb?source=collection_archive---------1-----------------------#2021-06-22">https://medium.com/nerd-for-tech/nestjs-chat-server-in-nestjs-backed-by-mongodb-687da9aa30bb?source=collection_archive---------1-----------------------#2021-06-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/6e8e959a851d1c9d485c96d46cf79ac0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PYGI6IBJEc0P8Dnj4OrvSw.png"/></div></div></figure><p id="c0f1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇文章将帮助你用NestJs + socket.io + MongoDB创建一个聊天服务器。我们将在NestJs中开发服务，使用socket.io公开WebSocket网关，并将消息存储在MongoDB中。<br/>遵循以下步骤:</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h1 id="fee8" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">步骤1:创建一个NestJs项目</h1><p id="8ee3" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">同样，我更喜欢使用Nest CLI。如果您没有Nest CLI，请使用以下命令通过NPM下载该软件包:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="78ca" class="lh jw hi ld b fi li lj l lk ll"><strong class="ld hj">$ npm install -g @nestjs/cli</strong></span></pre><p id="a450" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个NestJs应用程序(我将我的项目命名为'<em class="lm">聊天服务'</em>)；给出您选择的任何名称)，在您的首选文件夹中打开一个控制台，并运行命令:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="28ad" class="lh jw hi ld b fi li lj l lk ll"><strong class="ld hj">$ nest new chat-service</strong></span></pre><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/fb631991098c447f4b3691678a6ffbf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1nfCZCxVxtd5TWZZYq26Tw.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">创建新的NestJs项目</figcaption></figure><h1 id="8ada" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated">步骤2:创建一个聊天模块</h1><p id="4fc6" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">创建一个新的NestJs模块“ChatModule”。这将创建一个“聊天”文件夹和一个聊天模块(chat.module.ts)。在终端中运行这个命令来生成一个新模块。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="0fba" class="lh jw hi ld b fi li lj l lk ll"><strong class="ld hj">$ nest generate module chat</strong></span></pre><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/a98312150dab54c77e81a06613073f1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ReLYanFncClueGAEpYDCwQ.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">生成聊天模块</figcaption></figure><h1 id="54a7" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated">步骤3:添加Typegoose依赖项</h1><p id="29f2" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">我们将使用MongoDB存储聊天记录，使用Typegoose与MongoDB交互。安装下面提到的所需依赖项:</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="18a1" class="lh jw hi ld b fi li lj l lk ll"><strong class="ld hj">$ npm install @typegoose/typegoose nestjs-typegoose<br/>$ npm install mongoose@5.10.1<br/>$ npm install --save-dev @types/mongoose@5.10.1</strong></span></pre><p id="5281" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关于Typegoose与NestJs集成的更多信息，请访问npm包<a class="ae ly" href="https://www.npmjs.com/package/nestjs-typegoose" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h1 id="79ca" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated">步骤4:为MongoDB创建一个聊天实体</h1><p id="23a5" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">我们将为MongoDB中的“chat”集合创建一个新的Typegoose实体类。到目前为止，我们只保留了3列:消息、发送者和接收者。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/a56bd3b00c9aad12fbb8c507f128c3d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8_pbdG7NZZXVf3LxM8jR3Q.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">聊天实体</figcaption></figure><h1 id="c778" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated"><strong class="ak">步骤#5:导入TypegooseModule </strong></h1><p id="04ca" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">要初始化TypegooseModule，我们需要一个MongoDB服务器连接字符串(在下图中被屏蔽)。我正在使用由MongoDB Atlas提供的免费云托管MongoDB服务。按照这里的步骤<a class="ae ly" rel="noopener" href="/nerd-for-tech/mongodb-how-to-get-a-cloud-hosted-free-mongodb-cluster-as-a-service-214db2cc1c29">获得一个免费的云托管MongoDB服务。我们在这里导入根模块(AppModule - &gt; app.module.ts)中的TypegooseModule。</a></p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ma"><img src="../Images/ae945774b1b06163b3fbba00dfc3c2c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c56g6JdgL14LTDngK5jDsA.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">导入TypegooseModule</figcaption></figure><h1 id="d327" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated">步骤6:创建聊天服务</h1><p id="4b0d" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">接下来，我们将创建一个ChatService (chat.service.ts ),通过注入的Typegoose聊天模型对' chat '集合进行CRUD操作。该服务公开了两个函数:<strong class="is hj"><em class="lm">【get chats】</em></strong>(从集合中加载所有聊天)&amp;<strong class="is hj"><em class="lm">save chat</em></strong>(持久保存单个聊天文档)。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/97d32139be8991c2ef4d08329213d081.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Nt7tOyb4LNmPwZ9U3071-Q.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">与Typegoose互动的聊天服务</figcaption></figure><h1 id="a222" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated">步骤7:添加socket.io依赖项</h1><p id="dd61" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">在这一步，我们将把所需的socket.io依赖项添加到我们的应用程序中。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="85bc" class="lh jw hi ld b fi li lj l lk ll"><strong class="ld hj">$ npm install @nestjs/platform-socket.io @nestjs/websockets<br/>$ npm install --save-dev @types/socket.io</strong></span></pre><h1 id="8fa6" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated">步骤8:创建一个WebSocket网关</h1><p id="7aea" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">我们现在将创建一个WebSocket网关(chat.gateway.ts)来监听“聊天”事件。我实现了nestjs-socket.io提供的3个生命周期钩子:<strong class="is hj"><em class="lm">【after init】</em></strong>(服务初始化时)<strong class="is hj"> <em class="lm"> handleConnection </em> </strong>(新客户端连接到服务时)&amp;<strong class="is hj"><em class="lm">handle disconnect</em></strong>(客户端断开服务时)。<br/><strong class="is hj"><em class="lm">handleNewMessage</em></strong>函数订阅“聊天”事件，接收并在MongoDB中存储聊天内容&amp;将新聊天内容发送到“new chat”。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/7023c9e5b429fbc20addd8778b5bd4ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QOi9THLV9HpgORZX2gJzSQ.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">聊天网关</figcaption></figure><h1 id="2b95" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated">步骤9:更新聊天模块</h1><p id="f6a5" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">最后，我们需要提供ChatGateway &amp; ChatService，并在ChatModule中导入Typegoose聊天模型。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/db9b1596add0e85999cd4787bb006ae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nW7Kn9eN5Wmk_x22hWq6KA.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">更新聊天模块</figcaption></figure><h1 id="d472" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated">步骤#10:运行应用程序</h1><p id="6ab0" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">现在，让我们运行应用程序。应用程序将在@ 3000上运行，WebSocket也是如此。</p><pre class="ky kz la lb fd lc ld le lf aw lg bi"><span id="bcae" class="lh jw hi ld b fi li lj l lk ll"><strong class="ld hj">$ npm run build<br/>$ npm run start</strong></span></pre><h1 id="af6d" class="jv jw hi bd jx jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks bi translated">步骤11:验证</h1><p id="f327" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">我使用这个神奇的<a class="ae ly" href="https://amritb.github.io/socketio-client-tool/v1/#" rel="noopener ugc nofollow" target="_blank"> socket.io客户端</a>来测试我的socket.io服务。让我们连接到我们的WebSocket并发出一些聊天。这里我发出一个JSON对象来匹配我的聊天实体类。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/2e7ebe251b9b3cd9f80d1a01133f50ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Bf8tKgha_DsMOWFW1LBkQ.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">向“聊天”发送消息</figcaption></figure><p id="2889" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">验证您的聊天是否保存在MongoDB中。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/e096d4b412d3f29d97c518a233f83875.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jop3DR5wH4tQgAhNJvHdgQ.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">聊天被保存到MongoDB</figcaption></figure><blockquote class="mg mh mi"><p id="2539" class="iq ir lm is b it iu iv iw ix iy iz ja mj jc jd je mk jg jh ji ml jk jl jm jn hb bi translated"><em class="hi">代码库:<br/>【https://github.com/sharmavikashkr/chat-service-nestjs】<a class="ae ly" href="https://github.com/sharmavikashkr/chat-service-nestjs" rel="noopener ugc nofollow" target="_blank"/></em></p></blockquote></div></div>    
</body>
</html>