<html>
<head>
<title>Using the Raspberry Pi Zero as aWiFi range extender and an IOT device</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Raspberry Pi Zero 作为 aWiFi 范围扩展器和 IOT 设备</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/using-the-raspberry-pi-zero-as-a-wifi-range-extender-and-an-iot-device-108d8e47ce5?source=collection_archive---------2-----------------------#2021-05-07">https://medium.com/nerd-for-tech/using-the-raspberry-pi-zero-as-a-wifi-range-extender-and-an-iot-device-108d8e47ce5?source=collection_archive---------2-----------------------#2021-05-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/e640972d83a33769870fa1024d082549.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*R865LA1fQhuvrlVk_m_5nQ.jpeg"/></div></figure><p id="b1d1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Raspberry pi zero 是一款功能出众的神奇设备。通过内置的 wifi 和蓝牙，它可以很容易地变成一个 IOT 设备来控制各种外围设备。在这篇文章中，我将解释，我如何从零开始把我的 pi zero 变成一个 wifi 范围扩展器。</p><p id="b861" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">初始设置说明是针对 Mac OS 的，但是它们也可以很容易地用于任何版本的 linux。首先，我们需要在微型 sd 卡上刻录最新版本的 raspbian lite 操作系统。你可以从这里得到它<a class="ae jk" href="https://downloads.raspberrypi.org/raspbian_lite_latest" rel="noopener ugc nofollow" target="_blank">https://downloads.raspberrypi.org/raspbian_lite_latest</a>。下载并解压缩。img 文件。使用微型 sd 卡读卡器将微型 sd 卡插入其中一个 USB 驱动器。通过键入以下命令，打开终端窗口并列出所有磁盘</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="42f9" class="ju jv hi jq b fi jw jx l jy jz">diskutil list</span></pre><p id="17aa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您将获得所有连接驱动器的列表，并可以轻松识别新插入的卡。在我的例子中，设备被列为/dev/disk2。完成后，通过键入以下命令卸载该设备</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="492a" class="ju jv hi jq b fi jw jx l jy jz">diskutil unmountDisk /dev/disk2</span></pre><p id="d043" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来我们烧掉。我们下载到磁盘的 img 文件</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="19ce" class="ju jv hi jq b fi jw jx l jy jz">sudo dd bs=1m if=filename.img of=/dev/disk2</span></pre><p id="1548" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">几分钟后，图像文件将被写入 micro sd 卡。</p><p id="0b60" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后，我们将 sd 卡装回去(Mac OS 会自动为我们这样做)，并创建一个名为“ssh”的空白文件。这是为了让我们能够 ssh 到我们新造的圆周率零。在 Mac 上，sd 卡将显示为/Volumes/boot，我们需要在该文件夹中创建“ssh”文件。接下来，我们需要在我们的 Pi 上设置 internet 来下载所需的包。我们可以用两种方法做到这一点，</p><ol class=""><li id="2368" class="ka kb hi io b ip iq it iu ix kc jb kd jf ke jj kf kg kh ki bi translated">使用 wpa_supplicant 通过 Wifi</li><li id="f0f7" class="ka kb hi io b ip kj it kk ix kl jb km jf kn jj kf kg kh ki bi translated">通过 USB 使用 RNDIS</li></ol><p id="ff5e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">第一种方法相当简单，在空白的“ssh”文件所在的文件夹中创建一个名为 wpa_supplicant.conf 的文件，并输入以下详细信息，替换路由器的 SSID 和密码</p><blockquote class="ko kp kq"><p id="32fa" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">国家=美国</p><p id="cd82" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">ctrl _ interface = DIR =/var/run/wpa _ supplicant GROUP = netdev</p><p id="5a73" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">update_config=1</p><p id="2235" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">网络={</p><p id="8832" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">ssid="MyRouterSSID "</p><p id="372c" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">psk="MyRouterPasswd "</p><p id="3d77" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi">}</p></blockquote><p id="2402" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于第二种方式，您需要设置您的 pi +mac 来通过 USB 启用互联网共享。查看此<a class="ae jk" href="https://gist.github.com/superdodd/06b91ba03899e47beb43078b27dc601e" rel="noopener ugc nofollow" target="_blank">链接了解更多详情</a>。</p><p id="4a8c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下一步是把微型 SD 卡放在 Pi zero 上，等待几秒钟，让它启动。我们现在将 ssh 到 Pi 并安装 2 个包，</p><blockquote class="ko kp kq"><p id="65a7" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated"><a class="ae jk" href="https://wiki.gentoo.org/wiki/Hostapd" rel="noopener ugc nofollow" target="_blank"> Hostapd </a> : hostapd 是一个用户空间守护软件，支持网络接口卡作为接入点和认证服务器。</p><p id="964c" class="im in kr io b ip iq ir is it iu iv iw ks iy iz ja kt jc jd je ku jg jh ji jj hb bi translated">Dnsmasq  :dnsmasq 是提供域名系统缓存的免费软件，一个动态主机配置协议服务器…</p></blockquote><p id="5c22" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们在 ssh 终端上以下面的方式做到这一点</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="bc54" class="ju jv hi jq b fi jw jx l jy jz">sudo apt-get update<br/>sudo apt-get install hostapd dnsmasq</span></pre><p id="2350" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">安装后，我们禁用 hostapd 和 dnsmasq，这样它们就不会在启动时自动启动。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="793e" class="ju jv hi jq b fi jw jx l jy jz">sudo systemctl disable hostapd<br/>sudo systemctl disable dnsmasq</span></pre><p id="ff0f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下一步是编辑/etc/hostapd/hostapd.conf 文件。输入以下详细信息</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="8ade" class="ju jv hi jq b fi jw jx l jy jz">interface=uap0<br/>ssid=PiAP <br/>hw_mode=g<br/>channel=11<br/>macaddr_acl=0<br/>auth_algs=1<br/>ignore_broadcast_ssid=0<br/>wpa=2<br/>wpa_passphrase=password<br/>wpa_key_mgmt=WPA-PSK<br/>wpa_pairwise=TKIP<br/>rsn_pairwise=CCMP</span></pre><p id="92d2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以根据需要更改 ssid 和 wpa_passphrase。</p><p id="735d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来，为了使 hostapd 能够使用该文件，我们将编辑/etc/default/hostapd，并向其中添加以下行</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="8ce5" class="ju jv hi jq b fi jw jx l jy jz">DAEMON_CONF="/etc/hostapd/hostapd.conf"</span></pre><p id="1d45" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来编辑/etc/dnsmasq.conf，并在末尾添加以下几行</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="1352" class="ju jv hi jq b fi jw jx l jy jz">interface=uap0<br/>no-dhcp-interface=lo,wlan0<br/>bind-interfaces<br/>server=8.8.8.8<br/>domain-needed<br/>bogus-priv<br/>dhcp-range=192.168.2.2,192.168.2.50,12h</span></pre><p id="c21d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们的接入点将给出 192.168.2.2 到 192.168.2.50 范围内的 IP 地址，我们将使用谷歌的 DNS 服务器(8.8.8.8)进行域名解析。</p><p id="816a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来编辑/etc/network/interfaces 以添加我们的虚拟设备</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="9859" class="ju jv hi jq b fi jw jx l jy jz"><br/>iface uap0 inet static<br/>  address 192.168.2.1<br/>  netmask 255.255.255.0<br/>  network 192.168.2.0<br/>  broadcast 192.168.2.255<br/>  gateway 192.168.2.1</span></pre><p id="058e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">接下来添加一个将启动 hostapd 和 dnsmasq 服务的脚本，该脚本名为/usr/local/bin/piapstart，包含以下内容</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="4e62" class="ju jv hi jq b fi jw jx l jy jz">#!/bin/bash<br/># Create the virtual device<br/>/sbin/iw dev wlan0 interface add uap0 type __ap<br/>ifup uap0</span><span id="8bde" class="ju jv hi jq b fi kv jx l jy jz"># Route all the packets coming on this interface, this will enable #us to access internet through wlan0<br/>sysctl net.ipv4.ip_forward=1<br/>iptables -t nat -A POSTROUTING -s 192.168.2.0/24 ! -d 192.168.2.0/24 -j MASQUERADE<br/><br/>systemctl start dnsmasq<br/>systemctl start hostapd</span></pre><p id="657d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我希望我的 Pi zero 是完全可移植的，并且能够通过网页轻松编辑 SSID，我可以通过 Pi zero 访问点访问该网页。为此，我在 pi zero 上安装了 apache 和 php。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="0a7f" class="ju jv hi jq b fi jw jx l jy jz">sudo apt-get install apache php</span></pre><p id="1c0e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我编写了一个简单的 php 脚本，它将获得所需的详细信息，并将其写入 wpa_supplicant.conf 文件。你可以在这里找到脚本和其他文件<a class="ae jk" href="https://github.com/venkymani/PizeroAP" rel="noopener ugc nofollow" target="_blank">。我们可以很容易地从这样的网络浏览器中访问它</a></p><p id="3f10" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">http://raspberrypi.local/ssidconfig.php<a class="ae jk" href="http://raspberrypi.local/ssidconfig.php" rel="noopener ugc nofollow" target="_blank"/></p><p id="ae74" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，我们需要将所有这些内容放在启动脚本/etc/rc.local 中</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="adf4" class="ju jv hi jq b fi jw jx l jy jz">#Start the Access point daemon<br/>/bin/bash /usr/local/bin/piapstart</span><span id="d1f9" class="ju jv hi jq b fi kv jx l jy jz"># Enable wlan0 using wpa_supplicant and use the conf file created by #our php script <br/>wpa_supplicant -Dnl80211 -iwlan0<strong class="jq hj"> -c</strong>/var/www/html/wpa_supplicant.conf<strong class="jq hj"> -B -d</strong></span><span id="42ae" class="ju jv hi jq b fi kv jx l jy jz">#delay by 10 seconds so that the wlan0 connection comes up</span><span id="d23f" class="ju jv hi jq b fi kv jx l jy jz">sleep 10</span><span id="14f2" class="ju jv hi jq b fi kv jx l jy jz">#get an ip address from the wifi router</span><span id="4d72" class="ju jv hi jq b fi kv jx l jy jz">dhcpcd wlan0</span></pre><p id="64da" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用/etc/network/interfaces 自动启用 wlan0 不起作用，wlan0 链接总是关闭，所以通过启动脚本启动它是我能找到的唯一选项。Wpa_supplicant 帮助建立到路由器的连接，dhcpcd 从路由器获取 ip 地址。</p><p id="de3b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">每次我们使用 php 脚本更改 SSID 细节时，我们都需要重启 Pi zero 以使更改生效。在这种模式下使用 Pi 零点，我们可以将它用于许多生产级的实际情况，用户可以使用 Pi 零点控制他的所有设备。</p><p id="e2c9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">感谢以下输入链接</p><p id="e36d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://gist.github.com/superdodd/06b91ba03899e47beb43078b27dc601e" rel="noopener ugc nofollow" target="_blank"> Pi 零无头设置</a></p><p id="18e8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" href="https://blog.ithasu.org/2017/11/raspberry-pi-0w-as-both-wifi-client-and-access-point/" rel="noopener ugc nofollow" target="_blank"> Raspberry Pi Zero W 同时作为 wifi 客户端和接入点</a></p><p id="376e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">php 脚本和示例的源文件。conf 文件可以从<a class="ae jk" href="https://github.com/venkymani/PizeroAP" rel="noopener ugc nofollow" target="_blank">这里</a>下载</p></div></div>    
</body>
</html>