<html>
<head>
<title>How I deployed an Image Classification model using CNTK for deep learning as a REST API service on Azure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何在 Azure 上部署一个使用 CNTK 进行深度学习的图像分类模型作为 REST API 服务</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-i-deployed-an-image-classification-model-using-cntk-for-deep-learning-as-a-rest-api-service-on-e9ef0ec80e79?source=collection_archive---------0-----------------------#2018-02-18">https://medium.com/nerd-for-tech/how-i-deployed-an-image-classification-model-using-cntk-for-deep-learning-as-a-rest-api-service-on-e9ef0ec80e79?source=collection_archive---------0-----------------------#2018-02-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="31d8" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">警告:tldr</h1><p id="79b4" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">我最近写了一些关于 Azure 的文章，分享了我在新工作中获得的宝贵的开发知识，以及我在 1 月 18 日成功部署的第一个应用程序“捐赠范围预测”。本博客是我部署图像分类模型系列的第三部分。</p><p id="c7b4" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">AzureML Workbench CNTK 构建的模型可以回答诸如“图像中存在对象吗？”(其中对象可以是例如“狗”、“汽车”、“船”等。)以及更复杂的问题，如“该患者的视网膜扫描显示了哪种眼病？”— <a class="ae kg" href="https://github.com/Microsoft/CNTK" rel="noopener ugc nofollow" target="_blank">计数器</a></p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kh"><img src="../Images/540e8425ca6933cdbd048da407f2833d.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/format:webp/0*7mlciWgxYxeK_BHh.png"/></div></figure><p id="0ae1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><a class="ae kg" href="https://docs.microsoft.com/azure/machine-learning/preview/scenario-image-classification-using-cntk%5D(https://docs.microsoft.com/azure/machine-learning/preview/scenario-image-classification-using-cntk)" rel="noopener ugc nofollow" target="_blank">本页</a>解释了如何训练、测试和部署一个图像分类模型。然而，它没有解释一些事情，比如你需要一些 AzureML 依赖来运行这些脚本。默认情况下，某些 AzureML 功能在您的系统上不可用。</p><p id="9bf6" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">运行以下命令来安装它们:(记得在 Azure Workbench CLI 中运行)</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="cf85" class="ku ig hi kq b fi kv kw l kx ky">pip install -I --index-url <a class="ae kg" href="https://azuremldownloads.azureedge.net/python-repository/preview" rel="noopener ugc nofollow" target="_blank">https://azuremldownloads.azureedge.net/python-repository/preview</a> --extra-index-url <a class="ae kg" href="https://pypi.python.org/simple" rel="noopener ugc nofollow" target="_blank">https://pypi.python.org/simple</a> azureml-requirements</span></pre><p id="4e64" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">此外，你需要一个 GPU 来运行和完善模型使用 SVM 和 DNN 在第二步！深度学习尤其需要相当大的硬件才能高效运行。只是一个小小的免责声明；你的系统越小，你就需要越多的时间来得到一个训练有素的模型。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kz"><img src="../Images/c43cfc67bae691b306428fe90828785a.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/0*whHPB5foLsJqqaT8"/></div></figure><p id="26f3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">预训练的 DNN 保持固定(也就是说，它不是精炼的)。我用的是 Azure 深度学习 VM。深度学习虚拟机(DLVM)是<a class="ae kg" href="http://aka.ms/dsvm" rel="noopener ugc nofollow" target="_blank">数据科学虚拟机</a> (DSVM)的特殊配置变体，可以更容易地使用基于 GPU 的 VM 实例来训练深度学习模型。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es la"><img src="../Images/77a97ef2af8d5e8dea1e53b291c08b4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hiu_E-vuPUEiS5c7"/></div></div></figure><p id="64e4" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">在创建项目时，我还指定了一个 git 项目 URL，这样即使我切换机器和 ide，项目也很容易获得。</p><p id="c795" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">最后一步，可以将训练好的系统发布为 REST API。好吧，我们开始吧。打开 Deploy Jupyter 笔记本并启动笔记本服务器。把内核改成<projectname>本地。检查第一个笔记本中的工作目录和部署文件夹。应该是这样的:</projectname></p><p id="89a3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">参数:datasetName = fashionTexture <br/>文件复制到部署文件夹:。/deploy <br/>工作目录:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="ccd6" class="ku ig hi kq b fi kv kw l kx ky">C:\Users\&lt;AzureResource Name&gt;\AppData\Local\Temp\2\azureml_runs\ImageClassification_1517210766172</span></pre><p id="df4e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">要导航到此路径，请使用 cd 命令:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="f9e8" class="ku ig hi kq b fi kv kw l kx ky">cd &lt;Working directory&gt;<br/>cd deploy</span></pre><p id="f212" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">注册环境提供者:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="3e02" class="ku ig hi kq b fi kv kw l kx ky">az provider register -n Microsoft.MachineLearningCompute <br/>az provider register -n Microsoft.ContainerRegistry</span></pre><p id="b5e0" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">创建一个 ACS 集群(可能需要 10-20 分钟才能完成配置):</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="ee7f" class="ku ig hi kq b fi kv kw l kx ky">az ml env setup --cluster -l eastus2-n acsdeployment</span></pre><p id="fa59" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">指定用于“云”部署的目标上下文(这也将返回 Kubernetes 仪表板的 URL)。请注意，以下命令是在步骤 2 中运行“az ml env setup -cluster”命令后显示的:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="d631" class="ku ig hi kq b fi kv kw l kx ky">az ml env set -g acsdeploymentrg -n acsdeployment</span></pre><p id="c036" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从本地部署切换到集群部署:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="0dc5" class="ku ig hi kq b fi kv kw l kx ky">az ml env cluster</span><span id="c236" class="ku ig hi kq b fi lf kw l kx ky">az ml service create realtime -c ../aml_config/conda_dependencies.yml -f deploymain.py -s deployserviceschema.json -n imgclassapi1 -v -r python -d helpers.py -d helpers_cntk.py -d utilities_CVbasic_v2.py -d utilities_general_v2.py -d svm.np -d lutId2Label.pickle --model -file cntk_fixed.model</span></pre><p id="80bd" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">Rest API 名称应该类似于 imgclassapi1。<somename> - <someid> .eastus2. <br/>使用新的评分 URL 和通过运行以下命令获得的服务密钥更新脚本 6:</someid></somename></p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="6742" class="ku ig hi kq b fi kv kw l kx ky">az ml service keys realtime -i imgclassapi1.&lt;somename&gt;-&lt;someid&gt;.eastus2.</span></pre><p id="5045" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">通过运行以下命令获取有关 Rest API 的信息:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="a83e" class="ku ig hi kq b fi kv kw l kx ky">az ml service usage realtime -i imgclassapi1</span></pre><p id="b170" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">你会收到这样的东西</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="b5ab" class="ku ig hi kq b fi kv kw l kx ky">PrimaryKey: xxxxxxxxxxxxxxxxxxxxxxxxx<br/> SecondaryKey: xxxxxxxxxxxxxxxxxxxxxxxxx</span><span id="866b" class="ku ig hi kq b fi lf kw l kx ky">Scoring URL:<br/><a class="ae kg" href="http://&lt;ipaddress&gt;/api/v1/service/imgclassapi1/score" rel="noopener ugc nofollow" target="_blank">http://&lt;ipaddress&gt;/api/v1/service/imgclassapi1/score</a></span><span id="9b5b" class="ku ig hi kq b fi lf kw l kx ky">Headers:<br/> Content-Type: application/json<br/> Authorization: Bearer &lt;key&gt;<br/> (&lt;key&gt; can be found by running ‘az ml service keys realtime -i imgclassapi1.acsdeployment-&lt;id&gt;.eastus2’)</span></pre><p id="33c0" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">招摇网址:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="56de" class="ku ig hi kq b fi kv kw l kx ky">http://&lt;ipaddress&gt;/api/v1/service/imgclassapi1/swagger.json</span></pre><p id="3708" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">cmd 的用法:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="ecbe" class="ku ig hi kq b fi kv kw l kx ky">az ml service run realtime -i imgclassapi1.acsdeployment-&lt;id&gt;.eastus2 -d "{\"input_df\": [{\"image base64 string\": \"iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAIAAAACDbGyAAAAFElEQVR4nGP8//8/AxJgYkAFpPIB6vYDBxf2tWQAAAAASUVORK5CYII=\"}]}"</span></pre><p id="db22" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">PowerShell 的用法:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="7fc3" class="ku ig hi kq b fi kv kw l kx ky">az ml service run realtime -i imgclassapi1.acsdeployment-&lt;id&gt;.eastus2 --% -d "{\"input_df\": [{\"image base64 string\": \"iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAIAAAACDbGyAAAAFElEQVR4nGP8//8/AxJgYkAFpPIB6vYDBxf2tWQAAAAASUVORK5CYII=\"}]}"</span></pre><p id="d5c2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">通过调用以下命令获取调试日志:</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="7fcb" class="ku ig hi kq b fi kv kw l kx ky">az ml service logs realtime -i imgclassapi1.acsdeployment-&lt;id&gt;.eastus2</span></pre><p id="833a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">卷曲:</strong></p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lg"><img src="../Images/1d1caad212168b49a4724e756921d516.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*XKLsIw0aNlsY6bcO.png"/></div></div></figure><p id="aead" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">CURL 调用:(接口的 URL 只读属性返回当前服务工作客户端的 URL。)</p><p id="bd67" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">cURL 是一个使用 URL 语法获取或发送文件的命令行工具。</p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="e5a8" class="ku ig hi kq b fi kv kw l kx ky">curl -X POST -H "Content-Type:application/json" -H "Authorization:Bearer &lt;key&gt;" --data "{\"input_df\": [{\"image base64 string\": \"iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAIAAAACDbGyAAAAFElEQVR4nGP8//8/AxJgYkAFpPIB6vYDBxf2tWQAAAAASUVORK5CYII=\"}]}" http://&lt;ipaddress&gt;/api/v1/service/imgclassapi1/score</span></pre><p id="2480" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我喜欢 cURL 使用 PHP 的方式。PHP cURL 库绝对是异类。不像其他 PHP 库提供了大量的函数，PHP cURL 仅用四个函数就完成了其主要功能。</p><p id="e3cd" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">典型的 PHP cURL 用法遵循以下步骤。</p><ol class=""><li id="850d" class="lh li hi jf b jg kb jk kc jo lj js lk jw ll ka lm ln lo lp bi translated"><strong class="jf hj"> curl_init </strong> —初始化会话并返回一个 curl 句柄，该句柄可以传递给其他 cURL 函数。</li><li id="e920" class="lh li hi jf b jg lq jk lr jo ls js lt jw lu ka lm ln lo lp bi translated">curl_opt  —这是 curl 库的主要工具。这个函数被多次调用，并指定我们希望 cURL 库做什么。</li><li id="0eaa" class="lh li hi jf b jg lq jk lr jo ls js lt jw lu ka lm ln lo lp bi translated"><strong class="jf hj"> curl_exec </strong> —执行一个 curl 会话。</li><li id="d506" class="lh li hi jf b jg lq jk lr jo ls js lt jw lu ka lm ln lo lp bi translated"><strong class="jf hj"> curl_close </strong> —关闭当前 curl 会话。</li></ol><p id="e814" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">等价的 PHP 脚本是:</strong></p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="52da" class="ku ig hi kq b fi kv kw l kx ky">$ch = curl_init();<br/>curl_setopt($ch, CURLOPT_URL, "http://&lt;ip&gt;/api/v1/service/imgclassapi1/score");<br/>curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);<br/>curl_setopt($ch, CURLOPT_POSTFIELDS, "{\"input_df\": [{\"image base64 string\": \"iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAIAAAACDbGyAAAAFElEQVR4nGP8//8/AxJgYkAFpPIB6vYDBxf2tWQAAAAASUVORK5CYII=\"}]}");<br/>curl_setopt($ch, CURLOPT_POST, 1);<br/><br/>$headers = array();<br/>$headers[] = "Content-Type: application/json";<br/>$headers[] = "Authorization: Bearer &lt;key&gt;";<br/>curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);<br/><br/>$result = curl_exec($ch);<br/>if (curl_errno($ch)) {<br/>    echo 'Error:' . curl_error($ch);<br/>} <br/>curl_close ($ch);</span></pre><p id="8e01" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf hj">等价的 Python 脚本是:(如果你想用)</strong></p><pre class="ki kj kk kl fd kp kq kr ks aw kt bi"><span id="b056" class="ku ig hi kq b fi kv kw l kx ky">import requests<br/><br/>headers = {<br/> 'Content-Type': 'application/json',<br/> 'Authorization': 'Bearer &lt;key&gt;',<br/>}<br/><br/>data = [<br/> ('{"input_df": [{"image base64 string": "iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAIAAAACDbGyAAAAFElEQVR4nGP8//8/AxJgYkAFpPIB6vYDBxf2tWQAAAAASUVORK5CYII', '"}]}'),<br/>]<br/><br/>response = requests.post('http://&lt;ip&gt;/api/v1/service/imgclassapi1/score', headers=headers, data=data)</span></pre><p id="17f1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">总之，在 Azure 上部署服务时，创建 acsdeploymentrg 资源组时，创建了一个存储帐户、一个容器服务、一个负载平衡器、一个公共 IP 地址、一个可用性集、两个具有两个网络接口的代理虚拟机、一个具有一个网络接口的主虚拟机、一个网络安全组、一个路由表、一个虚拟网络、一个容器注册表和 25 个类似的东西。</p><p id="8f9d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">下一个系列—在云上部署服务时到底发生了什么。</p></div><div class="ab cl lv lw gp lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="hb hc hd he hf"><p id="4f0a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><em class="mc">原载于 2018 年 2 月 18 日</em><a class="ae kg" href="https://kuharanbhowmik.wordpress.com/2018/02/18/how-i-deployed-an-image-classification-model-using-cntk-for-deep-learning-as-rest-api-service-on-azure/" rel="noopener ugc nofollow" target="_blank"><em class="mc">http://kuharanbhowmik.wordpress.com</em></a><em class="mc">。</em></p></div></div>    
</body>
</html>