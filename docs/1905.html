<html>
<head>
<title>Postgres — Parallel jobs with Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Postgres —使用Python的并行作业</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/postgres-major-version-upgrade-parallel-analyze-with-python-af9931ffd087?source=collection_archive---------10-----------------------#2021-04-12">https://medium.com/nerd-for-tech/postgres-major-version-upgrade-parallel-analyze-with-python-af9931ffd087?source=collection_archive---------10-----------------------#2021-04-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/dba4fa38dcff7f6106f1aafe62666ea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B3JhmdPh2tVIubdI.png"/></div></div></figure><p id="d31e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最近，我们的团队收到了AWS针对我们的Aurora Postgres集群的多份通知，内容涉及Postgres版本9.6.x的弃用。我们必须将这些数据库升级到更高的主要版本(Aurora Postgres v10.x.x)。</p><p id="a604" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里有一点很重要，Postgres在主要版本升级中不复制统计数据。这意味着对于一个关键的查询可能会出现计划翻转，这将导致应用程序延迟变得更高，并影响整体数据库性能(CPU峰值等)。</p><p id="10ed" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">很明显，我想到了在升级后并行分析这些表(仅在停机时间内)。为了使这一步更顺利，我创建了一个小的Python脚本来并行运行这些命令。我们可以向该实用程序提供一个文件，其中包含我们希望以并行方式运行的所有查询。</p><p id="eb75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">用法:</strong></p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="b6bd" class="jx jy hi jt b fi jz ka l kb kc">python3 pg_parallel_sql.py -e pgdb-pg.db -d pgdb -po 5200 -u useradmin -pa 48 -f analyze.sql -eoe</span><span id="ca9b" class="jx jy hi jt b fi kd ka l kb kc">-h, --help    : show this help message and exit                      <br/>-e, --endpoint: endpoint identifier of Postgres Cluster [Mandatory ]   <br/>-d, --database: Postgres database name  [ Mandatory ]                      <br/>-po, --port   : Postgres port number [ Optional, Default: 8192 ]    <br/>-u, --user    : Username for authentication [ Mandatory ]                 <br/>-pa,--parallel: Parallel processes to run analyze commands<br/>                [Optional, [1-96]]      <br/>-f, --file     : filename containing all the queries [ Mandatory ]      <br/>                Queries should be termiated by ";"                     <br/>-eoe, --exitonerror: Exits on 1st sql query error otherwise continue     <br/>                     [Optional, Default: False ]</span></pre><p id="7e6f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">输出:</strong></p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="3fa9" class="jx jy hi jt b fi jz ka l kb kc">2021-04-12 16:56:25,969 INFO:Schemas by Table count<br/>+--------------------+------------+<br/>|     SchemaName     | TableCount |<br/>+--------------------+------------+<br/>|   aws_oracle_ext   |     7      |<br/>| information_schema |     7      |<br/>|       public       |     23     |<br/>|     pg_catalog     |     55     |<br/>|       appschema    |    151     |<br/>|       admin        |    259     |<br/>+--------------------+------------+<br/>2021-04-12 16:56:29,538 INFO:Processing Queries in file analyze.sql<br/>100%|█████████████████████████████| 145/145 [00:54&lt;00:00,  2.68it/s]<br/>2021-04-12 16:57:24,201 INFO: 0 error(s) in log file /tmp/pg_parallel_sql.log<br/>2021-04-12 16:57:24,202 INFO:Total execution time: 0:00:58.232558</span></pre><figure class="jo jp jq jr fd ij"><div class="bz dy l di"><div class="ke kf l"/></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">密码</figcaption></figure><p id="39d0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">更新:</strong></p><p id="e8fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面的python脚本可以方便地并行运行任务并显示进度，尽管还有其他方法来完成相同的任务。</p><ol class=""><li id="6be7" class="kk kl hi is b it iu ix iy jb km jf kn jj ko jn kp kq kr ks bi translated">这是一个很好的客户端实用程序，可以在集群范围内运行vacuum/analyze命令。它支持“—分阶段分析”和“—作业”参数，以增量和并行方式运行分析命令。</li><li id="2f1e" class="kk kl hi is b it ku ix kv jb kw jf kx jj ky jn kp kq kr ks bi translated">并行运行命令的另一个有趣且简单得多的方法是使用“xargs”命令。</li></ol><pre class="jo jp jq jr fd js jt kz bn la lb bi"><span id="5689" class="lc jy hi jt b be ld le l lf kc">xargs -d "\n" -n 1 -P 20 psql database_name username -c &lt; list_of_commands.txt</span></pre><p id="e655" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">ref:<a class="ae kt" href="https://markandruth.co.uk/2016/05/26/running-lots-of-postgres-commands-in-parallel" rel="noopener ugc nofollow" target="_blank">https://markandruth . co . uk/2016/05/26/running-lots-of-postgres-commands-in-parallel</a></p><p id="96bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">结束语:</strong>这是完成工作的一个基本而快速的脚本，但不是一个非常高效的脚本。它还可以进一步改进，比如对数据库连接使用连接池，分块读取文件以避免内存问题，然后可能是一个更好的日志记录程序。</p></div></div>    
</body>
</html>