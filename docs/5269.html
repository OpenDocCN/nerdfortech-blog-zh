<html>
<head>
<title>Kubernetes (K8S) Deployment Strategies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes (K8S)部署策略</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/kubernetes-k8s-deployment-strategies-1ef4c1dc1c6c?source=collection_archive---------1-----------------------#2021-09-13">https://medium.com/nerd-for-tech/kubernetes-k8s-deployment-strategies-1ef4c1dc1c6c?source=collection_archive---------1-----------------------#2021-09-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f134" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">微服务架构在最近很常见，我们可以利用频繁发布的优势，快速上市，接收市场反馈，并根据当前市场标准改进应用功能。</p><p id="3dbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有多种Kubernetes部署策略可用，根据我们的需求选择正确的策略非常重要。让我们列出部署策略。</p><blockquote class="jd je jf"><p id="8042" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><em class="hi"> 1。重新创建部署<br/> 2。滚动更新部署<br/> 3。蓝色/绿色(或)红色/黑色展开<br/> 4。金丝雀部署<br/> 5。A/B展开<br/> 6。影子(或)镜像部署</em></p></blockquote><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es jk"><img src="../Images/79fb0879bd055d1c0ab8f562cc993990.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JjHHMu9voqLLH7E5"/></div></div><figcaption class="jw jx et er es jy jz bd b be z dx translated"><a class="ae ka" href="https://unsplash.com/@linghua?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">华凌</a>在<a class="ae ka" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="e3de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">什么是Pod？</strong></p><p id="3270" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Pod是Kubernetes (K8S)中部署的基本原子单位。</p><p id="8a31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在K8S中，pod是一组包含一个或多个共享存储和网络的容器。让我们详细了解一下每个K8S部署策略</p><blockquote class="jd je jf"><p id="b8f2" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">重建部署</em> </strong> <em class="hi"> : </em></p></blockquote><p id="2262" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个部署策略中，所有的旧豆荚将被一次性杀死，并被新豆荚取代。</p><pre class="jl jm jn jo fd kb kc kd ke aw kf bi"><span id="3c31" class="kg kh hi kc b fi ki kj l kk kl">[...]<br/>kind: <strong class="kc hj">Deployment</strong><br/>spec:<br/>   replicas: <strong class="kc hj">3</strong><br/>   strategy:<br/>      type: <strong class="kc hj">Recreate</strong><br/>[...]</span></pre><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es km"><img src="../Images/bc31237867b7a10fa44185db1f19adbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EFuPXFgg_2NCwTxusW5AXw.png"/></div></div></figure><p id="1ec1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">重新创建策略的设置非常简单，但是由于应用程序停机时间，我们可以看到对用户体验的一些负面影响—考虑到关机/启动时间和回滚到以前版本的复杂性可能需要时间(如果对最新版本有任何影响)。</p><blockquote class="jd je jf"><p id="f1da" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">滚动更新</em> </strong> <em class="hi"> : </em></p></blockquote><p id="3ad9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该策略以滚动更新或增量方式(即一个接一个)重新创建pod，在这里，它将在不中断应用程序不可用的情况下终止并重新创建pod。</p><pre class="jl jm jn jo fd kb kc kd ke aw kf bi"><span id="6801" class="kg kh hi kc b fi ki kj l kk kl">[...]<br/>kind: <strong class="kc hj">Deployment</strong><br/>spec:<br/>   replicas: <strong class="kc hj">3</strong><br/>   strategy:<br/>      type: <strong class="kc hj">RollingUpdate</strong><br/>[...]</span></pre><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kn"><img src="../Images/c8d93bf566370dbcf10aad18698609eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S2v5pFN_9Ucfd3ceDIvyXg.png"/></div></div></figure></div><div class="ab cl ko kp gp kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hb hc hd he hf"><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kv"><img src="../Images/3fbc0233603b99560d42f73d3001d41c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2iQzBAZkDPzkURTTHVSE2w.png"/></div></div></figure><p id="e5f1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与重新创建策略相比，滚动更新策略的设置可能比较复杂，但我们解决了应用程序停机的问题，从而减少了对用户体验的影响。我们仍然担心回滚到以前的版本，我们无法控制这里的流量。</p><blockquote class="jd je jf"><p id="26e9" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">蓝/绿(或)红/黑调配</em> </strong> <em class="hi"> : </em></p></blockquote><p id="6c28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此策略中，旧(蓝色)和新(绿色)应用程序版本将一起部署。在这里，绿色部署通过不同的服务/端口提供，它将根据要求进行测试，并在以后用绿色部署替换蓝色部署。</p><p id="6d54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以通过单个服务或多个服务(使用入口)实现蓝/绿策略。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kw"><img src="../Images/a8ca1be2c4f50dd6d591394a8a115e11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*60cTei2hb3aoiY0Rsb3tGQ.png"/></div></div></figure></div><div class="ab cl ko kp gp kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hb hc hd he hf"><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kx"><img src="../Images/89bb1953681f109c1fb5c05cc067ebaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-P1QX_EZPA8FWhOC4CLUxw.png"/></div></div></figure><p id="58ae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Blue/Green在费用方面略高，因为它需要双倍的资源(因为它同时运行蓝色和绿色版本，直到它经过适当的测试并签署发布),并且新旧版本的设置都很复杂。它还需要对整个平台进行适当的测试，因为我们在生产中将应用程序的流量从旧版本完全更改为新版本。</p><blockquote class="jd je jf"><p id="1c60" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">金丝雀部署</em> </strong> <em class="hi"> : </em></p></blockquote><p id="9e91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Canary部署将非常有助于向用户子集发布和测试新功能，并有助于全面推广(当新版本无缝运行时)。</p><p id="815e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们需要用新功能转换5%的流量，其余95%的流量通过旧的稳定版本的应用程序。因此，如果我们发现新变化有任何问题，那么只有5%的用户会受到影响。一旦确定新的变更可以顺利进行，我们就可以向其他用户展示这些变更，并通过新的变更实现100%流量的金丝雀配置。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es ky"><img src="../Images/dbc2ac78ce8f37b794796ddeb09c6d0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jyl0SmMNflFod-zwKKT4ng.png"/></div></div></figure></div><div class="ab cl ko kp gp kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hb hc hd he hf"><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kz"><img src="../Images/51ae178920fdf46f0a933a43bbd03cc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sl097MzJ7Ca4IMoiPlk-GQ.png"/></div></div></figure><pre class="jl jm jn jo fd kb kc kd ke aw kf bi"><span id="6f63" class="kg kh hi kc b fi ki kj l kk kl"><strong class="kc hj">Example</strong>:</span><span id="f24d" class="kg kh hi kc b fi la kj l kk kl">...<br/>kind: <strong class="kc hj">Deployment</strong><br/>metadata:<br/>    name: shasr-app-v1<br/>spec:<br/>    replicas: 5<br/>    template:<br/>        labels:<br/>            app: shasr-app<br/>            version: v1.0.0<br/>...<br/><br/>...<br/>kind: <strong class="kc hj">Deployment</strong><br/>metadata:<br/>    name: shasr-app-v2<br/>spec:<br/>    replicas: 1<br/>    template:<br/>        labels:<br/>            app: shasr-app<br/>            version: v2.0.0<br/>...<br/><br/>...<br/>kind: <strong class="kc hj">Service</strong><br/>metadata:<br/>    name: shasr-app<br/>spec:<br/>    selector:<br/>        app: shasr-app<br/>...<br/><br/>...<br/>kind: <strong class="kc hj">RouteRule</strong><br/>metadata:<br/>    name: shasr-app<br/>    spec:<br/>        destination:<br/>            name: shasr-app<br/>        route:<br/>        - labels:<br/>            version: v1.0.0<br/>          weight: <strong class="kc hj">95</strong> # 95% traffic<br/>        - labels:<br/>            version: v2.0.0<br/>          weight: <strong class="kc hj">5 </strong># 5% traffic<br/>...</span></pre><p id="1b98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">金丝雀策略给我们带来了几个好处——零停机时间、流量监控、良好的客户体验、回滚非常快，因为我们可以将金丝雀(新版本)流量恢复到旧的稳定版本。缺点—与重新创建和滚动更新策略相比，设置canary配置有点复杂。</p><blockquote class="jd je jf"><p id="9303" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"><em class="hi"/></strong><em class="hi">:</em></p></blockquote><p id="365e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">A/B测试部署有点类似于Canary部署，在A/B部署中，我们在特定条件下将请求路由到用户子集，并且可以通过在顶级Canary部署上添加附加功能来实现。</p><p id="a84d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以用于A/B的可能条件</p><p id="65be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1.查询参数<br/> 2。技术支持:浏览器或版本、渠道、操作系统等。<br/> 3。自定义标题<br/> 4。语言5。地理定位—基于地理位置<br/> 6。饼干</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es lb"><img src="../Images/17a455eb335f9f62965aceba01e82162.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6OfhoOagu9oEoZd-oSfnZg.png"/></div></div></figure><pre class="jl jm jn jo fd kb kc kd ke aw kf bi"><span id="9a85" class="kg kh hi kc b fi ki kj l kk kl">Example:kind: <strong class="kc hj">RouteRule</strong><br/>metadata:<br/>    name: shasr-app-v1<br/>spec:<br/>    destination:<br/>        name: shasr-app<br/>    route:<br/>    - labels:<br/>        version: <strong class="kc hj">v1.0.0</strong><br/>    match:<br/>        request:<br/>            headers:<br/>                x-api-version:<br/>                    exact: "<strong class="kc hj">v1.0.0</strong>"</span><span id="1edc" class="kg kh hi kc b fi la kj l kk kl">kind: <strong class="kc hj">RouteRule</strong><br/>metadata:<br/>    name: shasr-app-v2<br/>spec:<br/>    destination:<br/>        name: shasr-app<br/>    route:<br/>    - labels:<br/>        version: <strong class="kc hj">v2.0.0</strong><br/>    match:<br/>        request:<br/>            headers:<br/>                x-api-version:<br/>                    exact: "<strong class="kc hj">v2.0.0</strong>"</span></pre><p id="37db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过A/B测试，我们可以实现零停机时间、流量控制和目标用户、快速回滚。与其他部署策略相比，它的配置有点复杂。</p><blockquote class="jd je jf"><p id="2228" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="hi">阴影(或)镜像部署</em> </strong> <em class="hi"> : </em></p></blockquote><p id="9474" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在影子部署中，在发布旧版本的同时发布新版本。传入流量将被镜像到新版本，不会影响应用流量。它有助于在新版本上测试生产流量，并且可以根据应用程序的性能/稳定性进行部署。</p><figure class="jl jm jn jo fd jp er es paragraph-image"><div class="er es lc"><img src="../Images/a65139b1a4ab04ff041ae9cdb6ea1616.png" data-original-src="https://miro.medium.com/v2/resize:fit:978/format:webp/1*pJaMpGEGR9UsD3vabfnq3A.png"/></div></figure><figure class="jl jm jn jo fd jp er es paragraph-image"><div role="button" tabindex="0" class="jq jr di js bf jt"><div class="er es kx"><img src="../Images/8d746b9b1c803ff0f9fd220dd7eb8026.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cqlT16ntm4OQLW78qxjPHg.png"/></div></div></figure><pre class="jl jm jn jo fd kb kc kd ke aw kf bi"><span id="70cf" class="kg kh hi kc b fi ki kj l kk kl"><strong class="kc hj">Example</strong>:</span><span id="4b99" class="kg kh hi kc b fi la kj l kk kl">kind: <strong class="kc hj">RouteRule</strong><br/>spec:<br/>    destination:<br/>        name: shasr-app-v1<br/>    route:<br/>    - labels:<br/>        version: v1.0.0<br/>        weight: 100<br/>    - labels:<br/>        version: v2.0.0<br/>        weight: 0<br/>    <strong class="kc hj">mirror</strong>:<br/>        name: shasr-app-v2<br/>        labels:<br/>            version: v2.0.0</span></pre><p id="82ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过影子/镜像测试，我们可以实现零停机时间、流量控制和快速回滚。与其他部署策略相比，它的配置有点复杂，因为它需要双倍的资源(因为它同时运行实际资源和影子资源)，所以它的费用也很高。在正式发布的镜像版本上进行适当的测试和签署之前，不得进行首次展示。</p></div></div>    
</body>
</html>