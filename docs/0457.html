<html>
<head>
<title>NodeJS proxy api for iTunes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iTunes的NodeJS代理api</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/nodejs-proxy-api-for-itunes-c15c2c09ed1c?source=collection_archive---------2-----------------------#2020-12-21">https://medium.com/nerd-for-tech/nodejs-proxy-api-for-itunes-c15c2c09ed1c?source=collection_archive---------2-----------------------#2020-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/64490c3e959cdef4ecd559f9ba7899e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MQGORl36Iirp4zhO.png"/></div></div></figure><div class=""/><p id="32af" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对公共API的NodeJS代理API感兴趣吗？在本文中，我们将使用<a class="ae jo" href="http://rss.itunes.apple.com/en-us" rel="noopener ugc nofollow" target="_blank"> iTunes </a> API来展示代理API的用例。</p><p id="0da6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">代理API是位于您的前端(客户端)和一个或多个后端服务(API)之间的中间应用程序进程。最佳做法始终是让客户端与代理api对话，代理API又调用公共API，而不是在以下情况下从客户端调用公共API:</p><h2 id="90a8" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">用例</h2><ul class=""><li id="b32f" class="kk kl ht is b it km ix kn jb ko jf kp jj kq jn kr ks kt ku bi translated">控制调用公共API的次数</li><li id="1f47" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">缓存最小阈值的API响应</li><li id="93eb" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">限制在给定时间内调用公共API的速率并降低其速度</li><li id="01a7" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">仅转发有权访问服务的请求</li><li id="9d0b" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">记录每个请求都将被发送到一个公共API服务</li></ul><h2 id="fff7" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">示例项目</h2><p id="7059" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">对于这个项目，我将使用NodeJS Express框架来创建代理API，在这里，我将使用iTunes API作为我的公共API来获取iTunes store中的新游戏。我将在本文中解释几个与缓存、速率限制和减速相关的用例。</p><p id="69cb" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想直接进入代码，可以看看下面这个关于Github的回购</p></div><div class="ab cl ld le gp lf" role="separator"><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li lj"/><span class="lg bw bk lh li"/></div><div class="hb hc hd he hf"><h2 id="b584" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">步骤1:创建项目文件夹</h2><p id="9f01" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated"><code class="du lk ll lm ln b">mkdir nodejs-proxy-api-itunes &amp;&amp; cd nodejs-proxy-api-itunes</code></p><h2 id="b285" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">步骤2:初始化节点项目</h2><p id="69c2" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">使用init命令初始化节点项目。在此之后，您将看到一系列问题，并选择默认选项。</p><p id="24ff" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lk ll lm ln b">npm init</code></p><h2 id="a364" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">步骤3:安装所需的npm软件包</h2><p id="cdbc" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated"><code class="du lk ll lm ln b">npm install express body-parser dotenv helmet morgan cors axios</code></p><p id="653b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请在此搜索<a class="ae jo" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank">以获得每个包的详细解释。</a></p><h2 id="4cf9" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">步骤4:创建项目文件夹结构</h2><p id="ebf4" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">此时，您可以创建下面提到的文件夹结构，以便更容易地参考本文。</p><figure class="lp lq lr ls fd hk er es paragraph-image"><div class="er es lo"><img src="../Images/fae3166e1dd70b90cba26ab1cd30fe6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/1*TgDXrPhthAJeGW7IoHoSNw.png"/></div></figure><h2 id="b67b" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">步骤5:了解应用程序流</h2><p id="1b28" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated"><strong class="is hu"> index.js </strong>是应用的入口点，与<strong class="is hu"> app.js </strong>一起负责创建express app，对app实例进行配置，使app监听特定端口上的请求，并使用<strong class="is hu">middleware . js</strong>为应用配置中间件</p><p id="93f9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> Index.js </strong></p><figure class="lp lq lr ls fd hk"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="8ef5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> App.js </strong></p><figure class="lp lq lr ls fd hk"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="d24b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">middle ware . js</strong></p><figure class="lp lq lr ls fd hk"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="346e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> <em class="lv"> src/api </em> </strong>:该文件夹将包含不同api的代码</p><p id="e4af" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"><em class="lv">src/api/index . js</em></strong>:这是API的入口点，请求会从这个文件路由到不同的处理程序。</p><figure class="lp lq lr ls fd hk"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="e875" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lk ll lm ln b">router.use('/itunes', itunesGames)</code></p><p id="2f92" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面的代码基本上告诉路由器，如果请求url包含'/itunes '，则将请求重定向到src/api/itunesgames.js内的api处理程序</p><p id="fad5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们来看一下<strong class="is hu"><em class="lv">src/api/iTunes games . js .</em></strong>在这种情况下，它负责进行公共API调用(iTunes API)以从iTunes store获取新游戏，并负责对重复请求进行缓存、速率限制和延迟API调用。</p><p id="f326" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是你如何设置一个快速代理，它将调用iTunes API来获取数据，并让我们进入代码:)</p><figure class="lp lq lr ls fd hk"><div class="bz dy l di"><div class="lt lu l"/></div></figure><p id="4621" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里，我添加了两个npm包，分别叫做<a class="ae jo" href="https://www.npmjs.com/package/express-rate-limit" rel="noopener ugc nofollow" target="_blank">快速限速</a>和<a class="ae jo" href="https://www.npmjs.com/package/express-slow-down" rel="noopener ugc nofollow" target="_blank">快速减速</a></p><p id="5831" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du lk ll lm ln b">npm install express-rate-limit express-slow-down</code></p><ul class=""><li id="e6bb" class="kk kl ht is b it iu ix iy jb lw jf lx jj ly jn kr ks kt ku bi translated"><a class="ae jo" href="https://www.npmjs.com/package/express-rate-limit" rel="noopener ugc nofollow" target="_blank"> express-rate-limit </a>是express的速率限制中间件，用于限制对公共API的重复请求。</li></ul><pre class="lp lq lr ls fd lz ln ma mb aw mc bi"><span id="1535" class="jp jq ht ln b fi md me l mf mg">const limiter <strong class="ln hu">=</strong> rateLimit({</span><span id="d917" class="jp jq ht ln b fi mh me l mf mg">windowMs<strong class="ln hu">:</strong> 15 <strong class="ln hu">*</strong> 60 <strong class="ln hu">*</strong> 1000, <em class="lv">// 15 minutes</em></span><span id="7671" class="jp jq ht ln b fi mh me l mf mg">max<strong class="ln hu">:</strong> 100 <em class="lv">// limit each IP to 100 requests per windowMs</em></span><span id="806f" class="jp jq ht ln b fi mh me l mf mg">});</span></pre><ul class=""><li id="70c7" class="kk kl ht is b it iu ix iy jb lw jf lx jj ly jn kr ks kt ku bi translated"><a class="ae jo" href="https://www.npmjs.com/package/express-slow-down" rel="noopener ugc nofollow" target="_blank"> express-slow-down </a>是express的一个基本限速中间件，它减慢响应速度，而不是完全阻止响应。用于限制对公共API的重复请求。</li></ul><pre class="lp lq lr ls fd lz ln ma mb aw mc bi"><span id="eb89" class="jp jq ht ln b fi md me l mf mg">const speedLimiter = slowDown({<br/>  windowMs: 15 * 60 * 1000, // 15 minutes<br/>  delayAfter: 100, // allow 100 requests per 15 minutes, then...<br/>  delayMs: 500 // begin adding 500ms of delay per request above 100:<br/>  // request # 101 is delayed by  500ms<br/>  // request # 102 is delayed by 1000ms<br/>  // request # 103 is delayed by 1500ms<br/>  // etc.<br/>});</span></pre><h2 id="2e3b" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">iTunes API</h2><p id="6c34" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">我们可以使用iTunes API来获取各种数据，如iTunes音乐、IOS应用程序和各种提要，如“顶级免费应用程序”、“顶级付费应用程序”等等..</p><p id="62ad" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我将使用iTunes RSS提要生成器来获得这个例子的端点，你可以参考这里的链接<a class="ae jo" href="http://rss.itunes.apple.com/en-us" rel="noopener ugc nofollow" target="_blank"/></p><p id="4b19" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，如果你有兴趣看看苹果音乐api，请参考下面的链接<a class="ae jo" href="https://developer.apple.com/app-store-connect/api/" rel="noopener ugc nofollow" target="_blank">这里</a></p><p id="9e1b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是从iTunes feed generator获取前25名IOS应用程序“我们喜爱的新游戏”的端点，我们将在示例中使用它</p><p id="312e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu"> API端点URL</strong>:<a class="ae jo" href="https://rss.itunes.apple.com/api/v1/us/ios-apps/new-games-we-love/all/25/explicit.json" rel="noopener ugc nofollow" target="_blank">https://RSS . itunes . apple . com/API/v1/us/IOs-apps/new-games-we-love/all/25/explicit . JSON</a></p><figure class="lp lq lr ls fd hk"><div class="bz dy l di"><div class="lt lu l"/></div></figure><ul class=""><li id="392a" class="kk kl ht is b it iu ix iy jb lw jf lx jj ly jn kr ks kt ku bi translated">在上面的例子中，我使用内存来缓存在60秒内被重复调用的数据。这是缓存数据的基本方法，但是对于大中型项目，我们可以使用更好的机制来缓存数据。我将在另一篇文章中公布这个过程:)</li><li id="3245" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">在这个过程中，我向我的响应数据对象添加了cacheTime属性。这也是拥有代理API的好处之一，我们需要在其中添加、修改任何数据属性，以使我们的应用程序正常工作。</li><li id="e172" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">下一步，它使用axios调用iTunes API，并在代理API上发回响应以及添加的数据属性，即缓存时间。</li></ul><h2 id="dc33" class="jp jq ht bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">要寻找的东西:</h2><p id="7cea" class="pw-post-body-paragraph iq ir ht is b it km iv iw ix kn iz ja jb la jd je jf lb jh ji jj lc jl jm jn hb bi translated">希望您喜欢这篇关于设置nodejs代理API、缓存数据、速率限制、降低重复请求的响应速度以及向响应对象添加新数据属性以支持应用程序需求的过程的文章。</p><p id="a6cc" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请关注我未来几周的更多文章:</p><ul class=""><li id="9f37" class="kk kl ht is b it iu ix iy jb lw jf lx jj ly jn kr ks kt ku bi translated">向API调用添加授权</li><li id="5ab2" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">使用无服务器将此NodeJS代理API部署到AWS lambda</li><li id="1f2f" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">验证代理API的自动化测试</li><li id="81f6" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">使用GITHUB操作的无服务器配置项</li><li id="f727" class="kk kl ht is b it kv ix kw jb kx jf ky jj kz jn kr ks kt ku bi translated">这个代理iTunes API的VueJs客户端。</li></ul></div></div>    
</body>
</html>