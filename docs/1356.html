<html>
<head>
<title>Create a multi node K3S cluster using an external database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用外部数据库创建多节点K3S集群</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/create-a-multi-node-k3s-cluster-using-an-external-database-499e75256a6a?source=collection_archive---------7-----------------------#2021-03-15">https://medium.com/nerd-for-tech/create-a-multi-node-k3s-cluster-using-an-external-database-499e75256a6a?source=collection_archive---------7-----------------------#2021-03-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1b3099f9d83ea7e940117c96e91e9995.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sSs0MDcHKYCPRROiDVEpgQ.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://www.pexels.com/@pixabay?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">皮查拜</a>从<a class="ae iu" href="https://www.pexels.com/photo/view-of-city-at-airport-326410/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">派克斯</a>拍摄</figcaption></figure><p id="9b3b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">kubernetes的优势之一是它的分布式能力。在kubernetes中运行多节点集群使其更具弹性和高可用性。其中一个节点可能出现故障，但应用程序仍应照常提供服务和工作，终端用户不应知道基础架构中发生的任何问题，除非一切都着火了。</p><p id="2127" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如我之前所写的，K3S是一个在几秒钟内创建kubernetes集群的伟大工具，我个人是这个项目的忠实粉丝，它也得到了CNCF的支持，所以它的质量是有保证的。它附带了一个嵌入式DB来管理所有的部署和一般状态，但有时您可能需要分离数据库并指示K3S使用外部资源。例如，如果您试图建立一个高度可用的Kubernetes集群。</p><p id="6e44" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在版本<code class="du jt ju jv jw b">v1.19.1</code>之前，K3S与Dqlite捆绑在一起，后来他们转而使用etcd来实现嵌入式数据库。</p><p id="318e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，在本文中，我将说明如何建立一个独立的etcd数据存储，并将K3S节点加入其中。</p><h2 id="16d4" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jg ki kj kk jk kl km kn jo ko kp kq kr bi translated">什么是etcd？</h2><p id="ca07" class="pw-post-body-paragraph iv iw hi ix b iy ks ja jb jc kt je jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">Etcd 是一个键值存储，根据他们的网站，它专注于简单和快速，这是一个开源项目，通常在分布式系统中用作关键数据的数据存储。在这种情况下，它将作为我们kubernetes集群的唯一真实来源和主数据库，这意味着K3S将跟踪其中的部署和应用程序。事实上，K3S也可以用于其他数据存储，如MySQL、PostgreSQL和MariaDB，你可以在这里选择不同的选项<a class="ae iu" href="https://rancher.com/docs/k3s/latest/en/installation/datastore/" rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="f026" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jg ki kj kk jk kl km kn jo ko kp kq kr bi translated">建筑</h2><p id="f3d9" class="pw-post-body-paragraph iv iw hi ix b iy ks ja jb jc kt je jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">这很简单，我将使用三台独立的ubuntu机器，一台用于etcd数据库，两台用于kubernetes节点。这将允许节点相互了解，同时还提供了一个高度可用的集群。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div class="er es kx"><img src="../Images/7e899924131444dc4d153360c52b8b4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*_D9nOKZwpT3DtGSHJZhP0Q.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">HA Kubernetes星团</figcaption></figure></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h1 id="3209" class="lj jy hi bd jz lk ll lm kd ln lo lp kh lq lr ls kk lt lu lv kn lw lx ly kq lz bi translated">那么，我该如何设置呢？</h1><h2 id="66da" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jg ki kj kk jk kl km kn jo ko kp kq kr bi translated">启动etcd</h2><p id="3704" class="pw-post-body-paragraph iv iw hi ix b iy ks ja jb jc kt je jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">首先，让我们设置数据存储。对于这个例子，我将使用docker容器来运行etcd。</p><p id="ae96" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果还没有，请确保在主机上下载并安装docker。我正在使用ubuntu，所以我将使用下面的链接，但是他们也有支持其他linux环境的说明。</p><div class="ma mb ez fb mc md"><a href="https://docs.docker.com/engine/install/ubuntu/" rel="noopener  ugc nofollow" target="_blank"><div class="me ab dw"><div class="mf ab mg cl cj mh"><h2 class="bd hj fi z dy mi ea eb mj ed ef hh bi translated">在Ubuntu上安装Docker引擎</h2><div class="mk l"><h3 class="bd b fi z dy mi ea eb mj ed ef dx translated">预计阅读时间:11分钟开始使用Ubuntu上的Docker引擎，确保满足先决条件…</h3></div><div class="ml l"><p class="bd b fp z dy mi ea eb mj ed ef dx translated">docs.docker.com</p></div></div><div class="mm l"><div class="mn l mo mp mq mm mr io md"/></div></div></a></div><p id="7f51" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">完成后，您可以通过运行以下命令来验证安装。</p><pre class="ky kz la lb fd ms jw mt mu aw mv bi"><span id="f400" class="jx jy hi jw b fi mw mx l my mz">root@ubuntu-db:~# docker --version<br/>Docker version 20.10.4, build d3cb89e</span></pre><p id="47a7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好了，现在让我们安装etcd客户端工具<code class="du jt ju jv jw b">etcdctl</code>，这将允许我们与我们的etcd docker容器进行交互。让我们安装使用:</p><pre class="ky kz la lb fd ms jw mt mu aw mv bi"><span id="6954" class="jx jy hi jw b fi mw mx l my mz">sudo apt-get install etcd-client</span></pre><p id="5fb1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这里，我将官方的etcd <a class="ae iu" href="https://etcd.io/docs/v3.4.0/op-guide/container/" rel="noopener ugc nofollow" target="_blank">文档</a>放入一个小脚本中，它将自动设置一切。它创建并安装必要的卷，并启动容器。</p><figure class="ky kz la lb fd ij"><div class="bz dy l di"><div class="na nb l"/></div></figure><p id="539b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在它完成执行后，您应该会看到类似这样的输出。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nc"><img src="../Images/1600333a98dfd25d7d89b15530a36c81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pJZSQ_uNTh4vW0Z9-VoYww.png"/></div></div></figure><p id="3eb9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">etcd现在准备好接受端口<code class="du jt ju jv jw b">2379</code>中的连接。然后让我们设置K3S节点。</p><h2 id="66e9" class="jx jy hi bd jz ka kb kc kd ke kf kg kh jg ki kj kk jk kl km kn jo ko kp kq kr bi translated">安装和配置K3S</h2><p id="cc2c" class="pw-post-body-paragraph iv iw hi ix b iy ks ja jb jc kt je jf jg ku ji jj jk kv jm jn jo kw jq jr js hb bi translated">在另外2台Ubuntu机器上，我将安装K3S，为此我将使用以下脚本</p><pre class="ky kz la lb fd ms jw mt mu aw mv bi"><span id="4b11" class="jx jy hi jw b fi mw mx l my mz">curl -sfL <a class="ae iu" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | INSTALL_K3S_VERSION=v1.18.16+k3s1 K3S_DATASTORE_ENDPOINT='http://etcd-public-ip:2379' sh -</span></pre><p id="6c21" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我在这里使用的是同一个脚本<a class="ae iu" rel="noopener" href="/@carlos_c/spin-up-a-kubernetes-cluster-easily-with-k3s-2f31e7893be7"/>，但是这次我添加了一个环境变量<code class="du jt ju jv jw b">K3S_DATASTORE_ENDPOINT</code>，它的值是我在上一步中设置的etcd容器的地址。这将告诉K3S它不会使用嵌入式数据库，而是使用该地址中提供的数据库。如果有多个etcd，您可以将它们添加到同一个环境变量中，并用逗号分隔它们。这还取决于您使用的数据存储，因此请确保查看官方文档<a class="ae iu" href="https://rancher.com/docs/k3s/latest/en/installation/datastore/" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nd"><img src="../Images/50ae6f74589f6d3930dc49b4eb96da2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VKf6D9i52cduVHxan8AVlw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">K3S集群创建</figcaption></figure><p id="c467" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，对节点2重复相同的过程。完成后，您应该能够在任何K3S节点中运行。</p><pre class="ky kz la lb fd ms jw mt mu aw mv bi"><span id="265c" class="jx jy hi jw b fi mw mx l my mz">kubectl get nodes</span></pre><p id="2317" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并且输出如下所示</p><figure class="ky kz la lb fd ij er es paragraph-image"><div class="er es ne"><img src="../Images/3b418d2622b502f8c7efe7b229162fef.png" data-original-src="https://miro.medium.com/v2/resize:fit:898/format:webp/1*Hp9jzhBrD-ZQtREGYX1T-g.png"/></div></figure><p id="5f5e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">K3S知道这两个节点，因为它连接到同一个etcd，并且数据库跟踪它们上发生的事情。</p><p id="aad0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，如果您获得群集的pod，您可以看到它们分布在两个节点上。</p><figure class="ky kz la lb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nf"><img src="../Images/7676d70314ecada3fedc0caa3231ae7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tlHwiWDx93iQfDEPXHfp-A.png"/></div></div></figure><p id="2ec5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您的kubernetes集群是分布式的，即使您的一个节点出现故障，另一个节点仍将为应用程序提供服务并处理连接，同时另一个节点恢复在线。</p></div></div>    
</body>
</html>