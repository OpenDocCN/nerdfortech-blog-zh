<html>
<head>
<title>You got peanut butter in my chocolate!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你在我巧克力里放了花生酱！</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/you-got-peanut-butter-in-my-chocolate-ca0219cecf97?source=collection_archive---------0-----------------------#2022-05-28">https://medium.com/nerd-for-tech/you-got-peanut-butter-in-my-chocolate-ca0219cecf97?source=collection_archive---------0-----------------------#2022-05-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="9bf3" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">亚马逊将剖析器和负载生成器结合起来的故事</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/42feb647d6f376dc52e0c99b6063adc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I6ejsokOUnQY4TeWgsKwjQ.png"/></div></div></figure><p id="f1bc" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在过去的五年里，我住在一个叫做埃德蒙兹的海边小镇。距离西雅图北部只有 20 分钟的路程，它仍然保留着传统小镇的魅力。在一个阳光明媚的日子里，脾气暴躁的老人、夫妇和欢笑的孩子在沙滩上漫步，享受着奥林匹克山在水面上的惊人景色，偶尔有一群虎鲸经过，躲避着帆船、渡船、游轮和货船。淘气的青少年经常在半夜往第五大街和主街的喷泉里加肥皂，所以整个角落在早上都是泡沫。开往加利福尼亚或加拿大的风景如画的火车鸣笛穿过城镇。春天，市中心的餐馆会慢慢地出现在人行道上，给人一种更欧洲的感觉。</p><p id="5aa2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">上个月，我和妻子以及数百名勇敢的人，在一个寒冷多雨的早晨奋力庆祝我们海滨中心的盛大开幕，这是所有社区的聚会场所。市长发表了讲话，印第安人表演了一些传统歌曲来祝福这片土地，我们当地的名人<a class="ae kf" href="https://en.wikipedia.org/wiki/Rick_Steves" rel="noopener ugc nofollow" target="_blank">里奇·史蒂夫斯</a>发表了一篇热情洋溢的长篇演讲，谈到要为我们的社区提供一个见面和相互了解的空间。建筑华丽，布景壮观。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kg"><img src="../Images/4b9353191e0e99d4a88de8cee3dccb65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XBXTSzv3svA8nKqV9pxwFw.png"/></div></div></figure><p id="cfac" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当我听着瑞克的时候，就像他在电视节目中谈论意大利广场一样，我想到了<strong class="jl hj"> <em class="kh">这座建筑是如何建造的</em> </strong> <em class="kh">。</em></p><p id="bed1" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当我年轻的时候，我有点认为政府有责任“建设共享的东西”，所以像这样的事情可能是由一些模糊的“中央权威”预见的，在那之后它们“就发生了”。</p><p id="e55d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">然而这座建筑完全是由社区为社区设想和建造的。政府中没有一个人说过，“埃德蒙兹应该有一个社区中心。”几十个普通公民在喝咖啡、葡萄酒或啤酒的时候讨论这个问题，讨论了好几年，直到它获得了动力。然后，他们自愿贡献自己的时间，将想法社会化，说服他人，慢慢提炼概念。普通市民受到了鼓舞，并捐出他们的钱来资助建设，普通市民捐出他们的技能来建设这一工程壮举。</p><p id="0c67" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="kh">这和我作为软件工程师的生活有什么关系？</em></p><p id="e715" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我认为，很多时候，初级工程师认为项目只是从某个“集中权威”那里传下来的，他们的工作是决定团队需要做什么。这忽略了一个事实，即他们也可以而且应该在谈判桌上拥有一席之地，并对他们的建设有发言权。他们应该不断地重写他们的工作描述(我在这里写了关于这个的博客<a class="ae kf" href="https://carloarg02.medium.com/how-i-rewrote-my-job-description-over-and-over-again-at-amazon-75774aec56a0" rel="noopener"/>)。像亚马逊、微软或谷歌这样的公司中存在的许多软件都是由普通工程师开发的，他们只是有一个想法，并有毅力说服其他人帮助实现它。</p><p id="d8b7" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我今天的主要故事是关于两个正在吃饭的家伙如何决定在亚马逊与一个<strong class="jl hj">的剖析师</strong>和一个<strong class="jl hj">的负载生成器</strong>结婚，在一张餐巾纸上勾画了这个想法，并在两年后实现了它。</p><h1 id="e387" class="ki kj hi bd kk kl km kn ko kp kq kr ks io kt ip ku ir kv is kw iu kx iv ky kz bi translated">写在餐巾纸上的想法…</h1><p id="fabf" class="pw-post-body-paragraph jj jk hi jl b jm la ij jo jp lb im jr js lc ju jv jw ld jy jz ka le kc kd ke hb bi translated">每年，亚马逊都会请它的首席工程师到一个坐落在群山中的度假胜地享受三天的放松和交流，这个地方离我们的西雅图总部大约有两个小时的车程。我们会暂停正在做的事情，开车越过山口，花三天时间通过咖啡、威士忌、美食和活动来相互了解。今天亚马逊有成千上万的负责人，所以他们不能再这样做了，但在 2017 年，我们大约有 500 人左右，所以我们都知道对方。</p><p id="f32d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">有一天晚上，我和我的好友蒂姆坐在餐桌旁，蒂姆是公司 Amazon.com 区的高级负责人。Tim 创造了一种非常酷的内部技术来进行剖析。它最终会被外部化，成为亚马逊代码大师，但那时它仍然是内部的。一个<em class="kh">分析器</em>从被测系统中收集运行时性能数据，并提供不同的数据可视化，以帮助您确定每行代码消耗了多少时间(找出开销最大的代码)。蒂姆的工作当然在我的关注范围之内，我的也在他的关注范围之内。<a class="ae kf" href="https://carloarg02.medium.com/how-i-grew-an-engineering-productivity-tool-to-impact-thousands-of-engineers-at-amazon-and-how-28a990091207" rel="noopener">我创建了负载和性能测试平台，亚马逊用它来确保数以千计的服务准备好处理高峰流量</a>(“TPS generator”)。我们都痴迷于找出效率低下的地方，并在浪费硬件方面为公司节省大量资金。</p><p id="b3d0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">Tim 接着解释了他的一个客户如何使用 Profiler 来识别一个吞吐量极高的服务中的瓶颈。在 Profiler 的<a class="ae kf" href="https://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html" rel="noopener ugc nofollow" target="_blank">火焰图</a>的帮助下，这位工程师意识到一个初始化成本非常高的对象在一个循环中被反复创建。这是浪费。该对象是线程安全的，因此工程师将初始化从循环中取出，并将其作为类的静态成员实例化一次。代码更改是如此的微不足道——实际上只有两行代码。但是该服务的硬件利用率仪表板在更改后显示出惊人的下降。蒂姆自豪地笑着说:“在接下来的 12 个月里，这 2 条生产线的改变节省了一百万美元。”</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lf"><img src="../Images/420a72ff035a274d898018edaf31ae13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_SHJ1yRiOJLUkyBdCKnoDQ.png"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">一个样品火焰图(<a class="ae kf" href="https://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html" rel="noopener ugc nofollow" target="_blank">信用</a></figcaption></figure><p id="7acc" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">话题转到了 TPSGenerator，于是轮到我了。我举了一个我自己的例子，一个客户使用 TPSGenerator 实现了他们可以将他们的服务所使用的硬件切换到一个更合适的硬件。这位工程师开发了许多测试环境，每个环境都有不同的硬件配置，并对每个环境运行完全相同的负载测试，以确定哪一个环境的性能最好。轮到我自豪地微笑了，“在接下来的 12 个月里，这一改变节省了 NN 百万美元”我提到。</p><p id="378a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们都静静地坐了一分钟，享受晚餐后的几瓶啤酒和我们共同的友谊。</p><p id="0778" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">“我的客户应该使用 Profiler！”我说。</p><p id="0a76" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">“我的客户应该在用 TPSGenerator！”他回应道。</p><p id="ce89" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">那段对话让我想起了 20 世纪 80 年代好时公司的一则广告，内容是关于<strong class="jl hj">李斯的花生酱杯子</strong>。有两个人在街上对面走着，一个在吃巧克力棒，一个在吃花生酱，根本不注意他们要去哪里。他们碰撞。“嘿，你在我的花生酱里放了巧克力，”一个人抱怨道。另一个人生气地回答:“嘿，你在我的巧克力里放了花生酱！”然后他们尝试组合。“嗯嗯……”他们微笑着。广告以“两种伟大的味道一起品尝伟大！”</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lk ll l"/></div></figure><p id="272f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这让我顿悟了。作为一个负载生成器，TPSGenerator 是一个强大的工具，用于将测试中的系统推向瓶颈状态，但是一旦你到达那里，它不能告诉你<strong class="jl hj">为什么</strong>它会出现瓶颈。剖析器是理解为什么系统会出现瓶颈的一种强有力的方法。</p><p id="c6e8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="kh">他们需要无缝集成。</em></p><p id="7253" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">“两个伟大的工具一起工作。”</p><p id="8452" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当然，我们不得不称这个特性为里斯！</p><p id="cb11" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我描述了 TPSGenerator 的架构，Tim 描述了 Profiler 的架构。我们互相追问技术问题。我们又拿了几瓶啤酒，开始在一张餐巾纸上勾画它们如何整合在一起的技术设计，因为这是我们仅有的一张纸。在接下来的一个小时里，那张餐巾纸变成了一件重要的艺术品。我们到处都有盒子和箭头，喝了几杯啤酒后，我感觉很好。我把餐巾叠得整整齐齐，放进口袋，收工了。</p><h1 id="93b1" class="ki kj hi bd kk kl km kn ko kp kq kr ks io kt ip ku ir kv is kw iu kx iv ky kz bi translated">漫长的等待…</h1><p id="5799" class="pw-post-body-paragraph jj jk hi jl b jm la ij jo jp lb im jr js lc ju jv jw ld jy jz ka le kc kd ke hb bi translated">第二天早上，我们都回到了西雅图。仅仅两天后，当我准备洗牛仔裤时，我在口袋里发现了那张餐巾纸，并想起了我们长时间的头脑风暴会议，所以我向负责 TPSGenerator 的团队提出了这件事(那时，我已经从产品的日常管理中退了一步，故意为下一代领导人创造空间，让他们能够站出来拥有产品)。他们对这个想法很兴奋，但它被搁置了。</p><p id="67d4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">但是在接下来的一两年里，集成 TPSGenerator 和 Profiler 仍然只是一厢情愿的想法。两个团队都难以维持当前的运营负载和 p0 功能，因此很难证明优先考虑一个可能节省数百万美元，但没有人真正要求的事情是合理的，因为我们有一个永无止境的高优先级请求列表，这些请求实际上阻碍了客户。</p><p id="6f76" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">偶尔，我会在校园里碰到蒂姆，谈话总是让我们感叹，我们不能认真证明我们的团队在这件事上花费他们的周期，我们都知道这可能会产生巨大的影响。</p><h1 id="9099" class="ki kj hi bd kk kl km kn ko kp kq kr ks io kt ip ku ir kv is kw iu kx iv ky kz bi translated">改变一切的一周…</h1><p id="93d9" class="pw-post-body-paragraph jj jk hi jl b jm la ij jo jp lb im jr js lc ju jv jw ld jy jz ka le kc kd ke hb bi translated">快进 18 个月……业务 Amazon.com 端的大多数关键路径服务倾向于进行负载和性能测试，以确保它们能够承受高峰流量，并且它们每年至少适当扩展两次，一次在亚马逊优惠日之前(6 月)，一次在黑色星期五和网络星期一之前(11 月)。为了建立组织范围内的讨论和兴奋，我们有一个特定的周(“性能测试周”)，我们要求所有的团队都这样做。这也造成了一定的同行压力:你周围所有的酷团队都在那周进行负载测试，所以你也应该这样！电子商务的 SVP 大卫·特德韦尔(David Treadwell)把复杂的猫群物流任务交给了普里扬卡(Priyanka ),于是我和她一起喝咖啡，集思广益。我当时在 AWS，这是一个与 Amazon.com 完全不同的业务部门，但我总是坚持负载和性能测试，所以我努力在公司的任何地方参与类似的活动。</p><p id="bc4f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我和普里扬卡经常聊天。这不是一个廉价的努力。我们得到了 SVP 的支持，要求数百个团队花费大量的工程时间和硬件资源——很容易就能获得数百万美元的投资。我们需要考虑为团队提供时间的最大价值。</p><p id="7b78" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我对我们的计划不满意。他们觉得有点无聊，有点雷同。我们已经连续两年做了完全相同的事情。我想做一些不同的，特别的，独特的事情。</p><p id="5bb2" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">嗯……我将得到成千上万工程师的全力关注和一位高级副总裁的直接支持……</p><p id="b323" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这正是我实现里斯梦想所需要的催化剂。</p><p id="807c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">逆向工作:黄金日在六月，所以性能测试周在二月，给团队时间解决他们可能发现的任何问题。现在是十二月。十二月是一个很好的月份去做你已经搁置了一整年的宠物项目，因为很多人会请假，所以你无论如何都不能安排很多商业关键的截止日期。</p><p id="8648" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="kh">有一个坚定的截止日期让我充满活力，给了我一种紧迫感</em>(我曾经在这里写过<a class="ae kf" href="https://link.medium.com/xcL39IwtNib" rel="noopener">截止日期是一个积极的催化剂】</a>。我有两个月的时间来说服和激励两个完全不同的团队(TPSGenerator 和 Profiler)一起工作，来交付我向 SVP 承诺的功能。</p><p id="4c12" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我找到了设计的旧餐巾，写了一个合适的技术设计文档，并得到了两个团队的架构签名。然后，我和 Tim 的技术主管 Fernando(T6)聊了一会儿，因为我需要甜言蜜语地说服他在他们的 RPC 服务中创建几个新的 API 供 TPSGenerator 调用。他也很兴奋，这将是性能测试周的主要明星，所以他很快就做出了改变。然后，我为 TPSGenerator 编写代码，告诉 Profiler 开始和停止对测试中的系统进行分析，并获取该时间段的 flamegraph，以便我可以将其嵌入负载测试报告本身。客户只需告诉 TPSGenerator 他们想要分析哪个环境，他们就会神奇地得到一个交互式火焰图来探索。</p><p id="5403" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在一天结束时，我们<em class="kh">确实</em>及时得到了工作的特性，并且它<em class="kh">是</em>性能测试周的焦点。我们的工程师通过对他们的系统进行负载测试来了解他们的系统，然后深入到相应的配置文件中来了解实际的瓶颈。对于那些喜欢冗长乏味的法律文件的人来说，蒂姆、普里扬卡、费尔南多和我<a class="ae kf" href="https://patents.justia.com/patent/10915437" rel="noopener ugc nofollow" target="_blank">申请了一项专利，其中包含了我们的一些想法</a>，对外公开。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lm"><img src="../Images/dd99c9af0a691ccd7b94ae400a741252.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yjQBiva1t_SQ2pms"/></div></div><figcaption class="lg lh et er es li lj bd b be z dx translated">我们<a class="ae kf" href="https://patents.justia.com/patent/10915437" rel="noopener ugc nofollow" target="_blank">用我们的一些想法</a>申请了专利！</figcaption></figure><h1 id="11e8" class="ki kj hi bd kk kl km kn ko kp kq kr ks io kt ip ku ir kv is kw iu kx iv ky kz bi translated">一些最后的想法</h1><ul class=""><li id="dee3" class="ln lo hi jl b jm la jp lb js lp jw lq ka lr ke ls lt lu lv bi translated">不要只是等待分配给你的工作:坚持你的产品应该做什么，成为所有者，在让这些事情发生的过程中占有一席之地。你的水平不重要。你的头衔不重要。你在公司待了多久并不重要。不管那些表面指标如何，你都可以成为一名领导者:成为一名领导者是关于<em class="kh">行为</em>。建造埃德蒙兹社区中心的每一个志愿者都是领导者。</li><li id="3e5c" class="ln lo hi jl b jm lw jp lx js ly jw lz ka ma ke ls lt lu lv bi translated">领导力包括坚持不懈地与你周围的人交谈，而不仅仅是躲在黑暗的角落里自己写代码。通常，您需要将多个团队联合起来支持一个计划，而不是孤立地工作。</li><li id="4c1e" class="ln lo hi jl b jm lw jp lx js ly jw lz ka ma ke ls lt lu lv bi translated">有时候你有一个很棒的想法，但是出于各种原因，现在还不是时候。我和蒂姆在晚餐时写在餐巾纸上的东西花了两年时间才变成现实。</li><li id="2192" class="ln lo hi jl b jm lw jp lx js ly jw lz ka ma ke ls lt lu lv bi translated">当合适的时机到来时，睁大你的眼睛去认识<em class="kh">，这样你就能抓住机会。</em></li></ul></div></div>    
</body>
</html>