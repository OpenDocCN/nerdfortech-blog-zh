<html>
<head>
<title>Deploying Azure Stream Analytics in Terraform using ARM templates to include SQL Reference Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ARM模板在Terraform中部署Azure流分析以包含SQL参考数据</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/deploying-azure-stream-analytics-in-terraform-using-arm-templates-to-include-sql-reference-data-afbcca362fff?source=collection_archive---------4-----------------------#2021-07-12">https://medium.com/nerd-for-tech/deploying-azure-stream-analytics-in-terraform-using-arm-templates-to-include-sql-reference-data-afbcca362fff?source=collection_archive---------4-----------------------#2021-07-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/8d0b2caca8602384f7e0eba330ce9cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h_3uyS9rStjIqKhhNl2S9g.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">我不想用你的标准“数据”或“计算机”图片。所以这是一种接近“流”的东西。已经感受到禅意了？—由<a class="ae iu" href="https://www.pexels.com/nl-nl/@raebaskinphotos?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">巴斯金创意工作室</a>通过<a class="ae iu" href="https://www.pexels.com/nl-nl/foto/time-lapse-fotografie-van-lake-1480807/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a>拍摄。</figcaption></figure><h1 id="e6aa" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">🧭简介</h1><p id="1b66" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在这个场景中，我们想要创建一个Azure流分析作业，它从Azure Event Hub获取输入数据，<strong class="jv hj">使用来自Azure SQL数据库</strong>的参考数据，然后在转换成服务总线主题后输出数据。我们希望使用<a class="ae iu" href="https://www.terraform.io/intro/index.html" rel="noopener ugc nofollow" target="_blank"> Terraform </a>来部署资源，原因很简单，因为它是一个令人敬畏的基础设施代码(IaC)工具，允许您构建、更改和版本化基础设施。</p><p id="4e2a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">部署它的挑战是什么？如<a class="ae iu" href="https://github.com/terraform-providers/terraform-provider-azurerm/issues/9231" rel="noopener ugc nofollow" target="_blank">本期</a>所述，<code class="du kw kx ky kz b">azurerm</code> Terraform provider目前不包括对SQL引用数据查找的支持——它目前只支持Azure blob存储引用数据查找。此外，也不支持本<a class="ae iu" href="https://github.com/terraform-providers/terraform-provider-azurerm/issues/6660" rel="noopener ugc nofollow" target="_blank">问题</a>中所述的<a class="ae iu" href="https://docs.microsoft.com/azure/stream-analytics/stream-analytics-compatibility-level#compatibility-level-12" rel="noopener ugc nofollow" target="_blank">兼容级别1.2 </a>。</p><p id="635a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">但是不用担心！还有另一种方式在Terraform中部署包含SQL参考数据的Azure Stream Analytics:使用<a class="ae iu" href="https://docs.microsoft.com/azure/stream-analytics/quick-create-azure-resource-manager" rel="noopener ugc nofollow" target="_blank"> ARM模板部署</a>。</p><p id="cb43" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">查看GitHub的<a class="ae iu" href="https://github.com/zoekdestep/deploy-asa-in-tf-using-arm" rel="noopener ugc nofollow" target="_blank">repo，获取本文的代码示例。</a></p><h1 id="05f1" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">🍿要求</h1><p id="ddcc" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在开始之前，请确保以下事项已准备就绪:</p><ul class=""><li id="afc0" class="la lb hi jv b jw kr ka ks ke lc ki ld km le kq lf lg lh li bi translated">您希望在其中部署资源的Azure订阅ID和租户ID。你可以使用<a class="ae iu" href="https://docs.microsoft.com/cli/azure/manage-azure-subscriptions-azure-cli" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>或<a class="ae iu" href="https://docs.microsoft.com/azure/media-services/latest/setup-azure-subscription-how-to?tabs=portal" rel="noopener ugc nofollow" target="_blank"> Azure Portal </a>找到这些信息。</li><li id="0d30" class="la lb hi jv b jw lj ka lk ke ll ki lm km ln kq lf lg lh li bi translated">与上述租户ID对应的Azure服务主体ID和机密。您可以使用<a class="ae iu" href="https://docs.microsoft.com/en-us/cli/azure/create-an-azure-service-principal-azure-cli" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a>来创建它。</li><li id="7be1" class="la lb hi jv b jw lj ka lk ke ll ki lm km ln kq lf lg lh li bi translated">将这四个秘密添加到<a class="ae iu" href="https://docs.github.com/en/actions/reference/encrypted-secrets" rel="noopener ugc nofollow" target="_blank"> GitHub秘密</a>中，这样它们就可以作为环境变量在<a class="ae iu" href="https://github.com/zoekdestep/deploy-asa-in-tf-using-arm/blob/main/.github/workflows/terraform-github.yml" rel="noopener ugc nofollow" target="_blank"> GitHub动作工作流</a>中进行认证。请确保按如下方式命名您的机密:</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/21f67335f9236e403d033283a884f584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iz9OCVEGMH2_Fhc6GHg9Rg.png"/></div></div></figure><ul class=""><li id="1272" class="la lb hi jv b jw kr ka ks ke lc ki ld km le kq lf lg lh li bi translated">Terraform需要一个地方来存储它的状态文件。因此，添加五个额外的GitHub秘密，它们描述了将要添加状态文件的所需资源组名称、存储名称和容器名称、状态文件的名称以及想要部署这些状态文件资源的区域。请注意:这些资源还不需要存在。</li></ul><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/39a7a738335d72135154266fbf781062.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FN6ft5MM3B6bgtziWwlhvg.png"/></div></div></figure><h1 id="50f9" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">🏭它是如何工作的</h1><p id="2820" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">一旦运行了<a class="ae iu" href="https://github.com/zoekdestep/deploy-asa-in-tf-using-arm/blob/main/.github/workflows/terraform-github.yml" rel="noopener ugc nofollow" target="_blank"> GitHub Actions工作流</a>，接下来的步骤就开始了。</p><ul class=""><li id="293a" class="la lb hi jv b jw kr ka ks ke lc ki ld km le kq lf lg lh li bi translated">使用<code class="du kw kx ky kz b">state-resources.sh</code>，存储Terraform状态文件的资源被创建(或者，如果它们已经存在，什么都不会发生)，使用您在GitHub Secrets中定义的参数。</li><li id="15d9" class="la lb hi jv b jw lj ka lk ke ll ki lm km ln kq lf lg lh li bi translated">Terraform设置、检查文件格式、初始化，然后生成执行计划。该执行计划(创建、更新或销毁资源)基于<code class="du kw kx ky kz b">main.tf</code>中定义的资源。在这种情况下，它创建一个单独的资源组，在其中部署资源；Azure事件中心，用于Azure流分析的潜在数据输入；Azure流分析使用的潜在参考数据的空Azure SQL数据库；潜在数据输出的服务总线主题；以及包括必要的blob存储的Azure流分析作业。</li><li id="57b7" class="la lb hi jv b jw lj ka lk ke ll ki lm km ln kq lf lg lh li bi translated">我们没有部署<a class="ae iu" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/stream_analytics_job" rel="noopener ugc nofollow" target="_blank"> Terraform Azure流分析作业</a>，而是在<a class="ae iu" href="https://github.com/zoekdestep/deploy-asa-in-tf-using-arm/blob/main/main.tf" rel="noopener ugc nofollow" target="_blank"> main.tf </a>中部署了<a class="ae iu" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group_template_deployment" rel="noopener ugc nofollow" target="_blank"> Terraform Azure资源组模板部署</a>。这个部署模板引用了一个<a class="ae iu" href="https://github.com/zoekdestep/deploy-asa-in-tf-using-arm/blob/main/stream-analytics/asa-template.json" rel="noopener ugc nofollow" target="_blank"> ARM模板</a>，它指定了要创建的Azure流分析实例。ARM模板引用部署模板中提供的参数——具体来说，对于我们的用例，它使用<code class="du kw kx ky kz b">referenceQuery</code>参数(引用SQL引用数据查找查询)并将其定义为Azure Stream Analytics作业的引用数据。<em class="lu">请删除</em> <a class="ae iu" href="https://github.com/zoekdestep/deploy-asa-in-tf-using-arm/blob/main/stream-analytics/asa-template.json" rel="noopener ugc nofollow" target="_blank"> <em class="lu"> ARM模板</em> </a> <em class="lu">中的注释，因为它们会导致编译错误，但出于解释目的，它们包含在此repo中。</em></li><li id="4b9a" class="la lb hi jv b jw lj ka lk ke ll ki lm km ln kq lf lg lh li bi translated">然后，当有推送到<code class="du kw kx ky kz b">main</code>分支时，计划被执行。</li><li id="6d9f" class="la lb hi jv b jw lj ka lk ke ll ki lm km ln kq lf lg lh li bi translated">回购还包括<a class="ae iu" href="https://github.com/zoekdestep/deploy-asa-in-tf-using-arm/blob/main/stream-analytics/test" rel="noopener ugc nofollow" target="_blank"> Azure Stream Analytics单元测试</a>和<a class="ae iu" href="https://github.com/zoekdestep/deploy-asa-in-tf-using-arm/blob/main/.github/workflows/asa-ci.yml" rel="noopener ugc nofollow" target="_blank">相应的管道</a>——因为测试是很好的实践:)你可以在这里找到更多关于测试Azure Stream Analytics <a class="ae iu" href="https://www.npmjs.com/package/azure-streamanalytics-cicd" rel="noopener ugc nofollow" target="_blank">的信息。</a></li></ul><p id="c00c" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">请注意，上述设置不包括任何流数据。因此，定义的Azure流分析和SQL查询是虚构的。</p><h1 id="9170" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">🚿清理</h1><p id="67aa" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">为了避免不必要的成本，不要忘记破坏创造的资源。</p><h1 id="f702" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">💛感谢您的阅读！</h1><p id="54e1" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">如果你觉得这有用，一些👏将非常感谢进一步传播这个词。此外，如果您有其他问题或想法，请在评论中告诉我，或者在<a class="ae iu" href="https://github.com/zoekdestep/deploy-asa-in-tf-using-arm" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中投稿。谢谢大家！</p></div></div>    
</body>
</html>