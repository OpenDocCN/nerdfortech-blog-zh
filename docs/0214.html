<html>
<head>
<title>Accessing S3 and Redshift via API Gateway (using AWS Lambda)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过API网关访问S3和红移(使用AWS Lambda)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/accessing-s3-and-redshift-via-api-gateway-using-aws-lambda-aad4d1915587?source=collection_archive---------0-----------------------#2020-07-18">https://medium.com/nerd-for-tech/accessing-s3-and-redshift-via-api-gateway-using-aws-lambda-aad4d1915587?source=collection_archive---------0-----------------------#2020-07-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="da79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">今天我要讲的是如何从你的网站获取数据，并使用AWS无服务器架构将其存储在redshift中。这可能是开始处理数据和快速构建后端的最简单、最快的方法。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/d3dadc736229cada0156ce92f8a928d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*GO6Om2O9UO2RLURZkRkdQg.png"/></div></figure><p id="37c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们从构建一个简单的GET restpoint开始。</p><ol class=""><li id="f11d" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">打开AWS控制台并转到API网关。</li><li id="20e1" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">选择HTTP API，然后选择BUILD。HTTP api支持lambda，并提供现成的CORS支持。</li><li id="8f2a" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">现在给你的api命名，我们就可以开始了。对于本教程，我将命名为“测试”。</li><li id="de30" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">它将为您提供一个自动部署路径的选项，自动部署您的所有更改。您可以给它起自己的名字，或者保留$default。</li><li id="0cfc" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">现在只需单击create，就会为您创建一个api。</li></ol><p id="bc6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们创建lambda函数，我们将把它与我们的api网关集成在一起。</p><ol class=""><li id="2c5d" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">从头开始创建函数。</li><li id="48c6" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">我选择了python作为语言，但是你可以选择任何你喜欢的语言。</li><li id="36fc" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">创建一个IAM角色，并授予对API Gateway、S3、Redshift和Cloudwatch的读写权限。</li><li id="eaa2" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">Lambda会自动为你创建一个日志组，并将所有日志上传到cloudwatch。</li></ol><p id="b6b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们在api中创建一条路线。</p><ol class=""><li id="4d6e" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">单击左侧窗格中的路线。</li><li id="497c" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">单击创建并选择“获取”api。</li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es jz"><img src="../Images/b2d2a2102e132e1f8c6c0907ba285eaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8ZLum8QFtba8b2nQhWOj-g.png"/></div></div></figure><p id="cbd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了一个端点，让我们将它与我们的后端(lambda)集成起来。</p><p id="f586" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.现在转到您的路线并点击“获取”。</p><p id="34e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.点击“附加集成”，选择lambda函数，并将您的Lambda函数的arn复制到此处。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es ke"><img src="../Images/cd4af2a3fa59fcee899ea887b40c390a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dpWaevusjlONK7VOLlqPNQ.png"/></div></div></figure><p id="0725" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.单击—授予API网关调用lambda的权限。</p><p id="406b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AAANNNDDD！！！..你可以走了。</p><p id="f22a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.默认情况下，lambda返回“你好！" .现在让我们把代码改为“测试测试1 2 3”并保存它。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kf"><img src="../Images/14ccb01b43966a8cce464bafac722588.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h58ZBSNGT8XQoPKbXZPV8g.png"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">你的lambda函数应该是这样的。</figcaption></figure><p id="ff7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您的api应该自动部署到默认阶段。</p><p id="deb7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">7.现在让我们配置CORS，这样我们就可以从任何web浏览器访问我们的API。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kk"><img src="../Images/7d9f1fa71f228ff9df504ef6901ce8c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rdwo1DkW-m_bIdPBVn5Rfg.png"/></div></div><figcaption class="kg kh et er es ki kj bd b be z dx translated">完成后，您的CORS配置应该如下所示。我们现在将允许所有的头命中我们的API。</figcaption></figure><p id="4373" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经配置好了一切，让我们试着点击API。</p><p id="e0ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将在左侧面板中找到您的阶段的url。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kl"><img src="../Images/f2be478cb99bf275574b596f3e2a93a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*srpP045ga7zvnyVATVV5fw.png"/></div></div></figure><p id="e9f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们转到这个网址，你会看到你的“测试”消息🥳🥳🥳🥳.</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es km"><img src="../Images/fb2e86d1856e2eb4cb8219a9d48f1fa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JqpoBEZuGLGKAbdxK_IkcA.png"/></div></div></figure><p id="3452" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们已经建立了lambda和apigateway之间的连接，让我们开始将数据保存在S3和红移中。</p><p id="9570" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个“POST”路由，类似于我们创建“GET”的方式，并将其与相同的lambda集成。</p><p id="34de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们也创建一个S3桶和红移表来存储我们的数据。</p><p id="978a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">S3·巴特—</p><ol class=""><li id="033f" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">只要给你的桶起一个独特的名字，你就可以开始了。你不需要更多的配置。我把我的桶命名为“测试-中等-安基塔”。</li><li id="b049" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">现在，在您的lambda中，添加这个S3桶作为触发器，这样每当有任何数据添加到桶中时，它都会流向红移。</li></ol><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es kn"><img src="../Images/f7d882ce41a9e299e3f94764be281b70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iaGEE0nANDluxAtAsv5APA.png"/></div></div></figure><p id="1cdb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">红移表</p><ol class=""><li id="0abc" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">让我们的模式。—字符串名称、字符串年龄、字符串收藏_卡通</li><li id="c319" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">现在从AWS控制台打开Redshift，让我们创建我们的表。(我假设你已经有红移设置。如果没有，你可以按照这个<a class="ae ko" href="https://docs.aws.amazon.com/redshift/latest/gsg/getting-started.html" rel="noopener ugc nofollow" target="_blank">教程</a>。</li><li id="c0ba" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">运行以下命令创建一个表。</li></ol><pre class="je jf jg jh fd kp kq kr ks aw kt bi"><span id="541f" class="ku kv hi kq b fi kw kx l ky kz">Create table public.medium (<br/>name VARCHAR(max),<br/>age VARCHAR(max),<br/>fav_cartoon VARCHAR(max)<br/>)</span></pre><p id="1024" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.当你这么做的时候—</p><pre class="je jf jg jh fd kp kq kr ks aw kt bi"><span id="5584" class="ku kv hi kq b fi kw kx l ky kz">select * from public.medium; </span></pre><p id="01f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你应该看看你的桌子。对于我的教程，每当数据被插入到S3桶——“test-medium-ankita”时，它应该会自动填充您的红移表。</p><p id="a200" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们准备好所有的配置，让我们开始创建我们的lambda函数。</p><p id="675b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将需要以下软件包:</p><ol class=""><li id="df66" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">心理战2</li><li id="5bef" class="jl jm hi ih b ii ju im jv iq jw iu jx iy jy jc jq jr js jt bi translated">boto3</li></ol><p id="399d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将需要在本地机器上配置AWS(为此创建一个拥有前面提到的所有必需权限的用户)。</p><ol class=""><li id="5546" class="jl jm hi ih b ii ij im in iq jn iu jo iy jp jc jq jr js jt bi translated">现在创建一个虚拟env。(我们将需要这个把我们的代码作为zip文件上传到lambda。也可以跟着这个<a class="ae ko" rel="noopener" href="/@manivannan_data/import-custom-python-packages-on-aws-lambda-function-5fbac36b40f8">教程</a>。</li></ol><p id="20e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码:</p><pre class="je jf jg jh fd kp kq kr ks aw kt bi"><span id="0460" class="ku kv hi kq b fi kw kx l ky kz">import json<br/>import psycopg2<br/>import boto3</span><span id="d881" class="ku kv hi kq b fi la kx l ky kz">def redshiftputdata(loc):<br/>    con = psycopg2.connect(dbname='***',<br/>                       host='***',<br/>                       port='***', user='***', password='***')<br/>    cur = conn.cursor()<br/>    # Begin your transaction<br/>    cur.execute("begin;")<br/>    cur.execute(<br/>        "COPY public.executed_user_rules FROM" + loc + "CREDENTIALS 'aws_iam_role=arn:aws:iam::***' json 'auto';")<br/>    # Commit your transaction<br/>    cur.execute("commit;")<br/>    print("executed user rules copy executed fine!")</span><span id="30fe" class="ku kv hi kq b fi la kx l ky kz">def put_data_into_s3(data, bucket):<br/>    putbucket = bucket<br/>    key = "medium"<br/>    client = boto3.client('s3')<br/>    client.put_object(Body=data, Bucket=putbucket, Key=key)<br/>    return data</span><span id="a981" class="ku kv hi kq b fi la kx l ky kz">def lambda_handler(event, context):<br/>    print(event)<br/>    # For api gateway post.<br/>    response = "default"<br/>    if ("rawPath" in event and event.get("rawPath") == "/postnames"):<br/>        body = event.get("body")<br/>        dict = json.loads(body)<br/>        dict = json.dumps(dict)<br/>        print(dict)<br/>        response = put_data_into_s3(dict, "test-medium-ankita")<br/>    <br/>    # handle data coming from s3.<br/>    if("Records" in event):<br/>        records = event["Records"]<br/>        for record in records:<br/>            s3_name = record["s3"]["bucket"]["name"]<br/>            key = record["s3"]["object"]["key"]<br/>            output = ""<br/>            if (s3_name == "test-medium-ankita" and key.find(".json") != -1):<br/>                loc = "'s3://test-medium-ankita/%s'" % (key)<br/>                output = redshiftputdata(loc)<br/>                print("output: ", output)<br/>    # TODO implement<br/>    return {<br/>        'statusCode': 200,<br/>        'body': json.dumps(response)<br/>    }</span></pre><p id="5f23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">函数“redshiftputdata”用于将从S3收到的json文件复制到我们的红移表中。函数“put_data_into_s3”用于将您的数据以json格式放入s3。</p><p id="3502" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们进行post调用，我们应该可以直接看到填充在红移表中的数据:</p><p id="8007" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">号召正文:</p><pre class="je jf jg jh fd kp kq kr ks aw kt bi"><span id="42b3" class="ku kv hi kq b fi kw kx l ky kz">{"name":"Ankita Sinha","age": "15","fav_cartoon": "tom and jerry"}</span></pre><p id="8e3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们看看表格中的数据—</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="ka kb di kc bf kd"><div class="er es lb"><img src="../Images/969790c559ded65e810857e1500fe5b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hBwNoG42RtbQo2sNhQ7gew.png"/></div></div></figure><p id="28f5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另外，你可以从这里获得lambda可执行文件psycopg 2—【https://github.com/jkehler/awslambda-psycopg2】T4。你只需要把这个文件放到你的代码中，然后压缩它。</p></div></div>    
</body>
</html>