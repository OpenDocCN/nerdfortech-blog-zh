<html>
<head>
<title>REST API with Deno and MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Deno 和 MongoDB 的 REST API</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/rest-api-with-deno-and-mongodb-11ffe57c5d51?source=collection_archive---------9-----------------------#2021-02-02">https://medium.com/nerd-for-tech/rest-api-with-deno-and-mongodb-11ffe57c5d51?source=collection_archive---------9-----------------------#2021-02-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7ab3bef3c4238c24c1ef723558f0f2cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UNE9G7HXUBH8r_qA_Tx5Ng.jpeg"/></div></div></figure><p id="9ffc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文将向您展示如何用<a class="ae jo" href="https://deno.land/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> Deno </strong> </a> <strong class="is hj"> </strong>和<a class="ae jo" href="https://www.mongodb.com/2" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> MongoDB </strong> </a> <strong class="is hj">构建一个简单的 REST API。</strong></p><p id="2f7e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> Deno - </strong> <em class="jp"> Deno 是一个基于 V8 JavaScript 引擎和</em><a class="ae jo" href="https://www.rust-lang.org/" rel="noopener ugc nofollow" target="_blank"><em class="jp">Rust</em></a><em class="jp">的 TypeScript 和 JavaScript 的安全运行时，由 Node.js 的最初创建者 Ryan Dahl 创建</em></p><p id="56a1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">先决条件-</strong><a class="ae jo" href="https://deno.land/" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="jp">Deno</em></strong></a><strong class="is hj"><em class="jp"/></strong><em class="jp">预装，</em> <a class="ae jo" href="https://www.postman.com/downloads/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> <em class="jp">邮差</em></strong></a><strong class="is hj"><em class="jp"/></strong><em class="jp">API 客户端，</em><a class="ae jo" href="https://account.mongodb.com/account/login" rel="noopener ugc nofollow" target="_blank"><strong class="is hj"><em class="jp">MongoDB</em></strong></a><strong class="is hj"><em class="jp"/></strong></p><h1 id="c215" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated"><strong class="ak">步骤:</strong></h1><h1 id="39d7" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated"><strong class="ak"> 1。创建 server.ts 并导入<em class="ko"> Oak </em>中间件。</strong></h1><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="46f3" class="ky jr hi ku b fi kz la l lb lc">import { Application } from ‘https://deno.land/x/oak/mod.ts'</span></pre><h1 id="f211" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">2.创建数据库。</h1><p id="ac68" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">登录<strong class="is hj"> MongoDB 云图谱</strong>并创建一个新的集群，如果你还没有的话。让一切保持原样，并为您的集群命名(在我的例子中是<strong class="is hj">‘deno products’</strong>)。下面是我们创建的集群。</p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/0a8234c9815697f55fae34bf6eacba2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WVwh3zzoRvtHewp9T7RnGg.jpeg"/></div></div></figure><p id="c5ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后进入<strong class="is hj">数据库访问&gt;添加新的数据库用户，</strong>提供用户名和密码，点击<strong class="is hj">添加用户。</strong></p><p id="f9db" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">之后，我们需要允许网络访问，因为默认情况下，我们将无法连接到这个数据库，除非我们将 IP 地址列入白名单。因此，进入<strong class="is hj">网络访问&gt;添加 IP 地址，</strong>您可以添加您当前的 IP 地址或允许从任何地方访问。</p><p id="f772" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后进入<strong class="is hj">你的集群&gt;连接&gt;连接到你的应用，</strong>复制你的连接字符串。</p><p id="a2f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在你的根目录下创建一个名为<strong class="is hj"> db </strong>的文件夹，并在里面创建<strong class="is hj"> mongodb.ts </strong>文件。复制并粘贴下面的代码。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="f67c" class="ky jr hi ku b fi kz la l lb lc">import { MongoClient } from “https://deno.land/x/mongo@v0.8.0/mod.ts";</span><span id="cffe" class="ky jr hi ku b fi lj la l lb lc">const client = new MongoClient();</span><span id="66b7" class="ky jr hi ku b fi lj la l lb lc">client.connectWithUri(“<strong class="ku hj">&lt;Paste your connection string here&gt;</strong>”);</span><span id="9415" class="ky jr hi ku b fi lj la l lb lc">const db = client.database(‘products’);</span><span id="0ff0" class="ky jr hi ku b fi lj la l lb lc">export default db</span></pre><h1 id="43a6" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">3.创建控制器。</h1><p id="ccac" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">在根目录下创建一个名为<strong class="is hj"> controller </strong>的文件夹，并在其中创建<strong class="is hj"> products.ts </strong>文件。在这个文件中，我们需要为我们的<strong class="is hj"> API </strong>执行<strong class="is hj"> CRUD </strong>功能。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="9c14" class="ky jr hi ku b fi kz la l lb lc">import { RouterContext } from ‘https://deno.land/x/oak/mod.ts'</span><span id="7979" class="ky jr hi ku b fi lj la l lb lc">import db from ‘../db/mongodb.ts’</span><span id="9e05" class="ky jr hi ku b fi lj la l lb lc">const productsCollection = db.collection(‘products’)</span><span id="8d7c" class="ky jr hi ku b fi lj la l lb lc">// @desc Get all the products</span><span id="4c92" class="ky jr hi ku b fi lj la l lb lc">// @route GET /broco/api/products</span><span id="ed4e" class="ky jr hi ku b fi lj la l lb lc">const getProducts = async (ctx: RouterContext) =&gt; {</span><span id="b373" class="ky jr hi ku b fi lj la l lb lc">const products = await productsCollection.find();</span><span id="3f01" class="ky jr hi ku b fi lj la l lb lc">ctx.response.body = products</span><span id="6577" class="ky jr hi ku b fi lj la l lb lc">}</span><span id="762d" class="ky jr hi ku b fi lj la l lb lc">// @route GET /broco/api/products/:id</span><span id="e523" class="ky jr hi ku b fi lj la l lb lc">const getProductsById = async (ctx: RouterContext) =&gt; {</span><span id="c82f" class="ky jr hi ku b fi lj la l lb lc">const id = ctx.params.id;</span><span id="6e02" class="ky jr hi ku b fi lj la l lb lc">const products = await productsCollection.findOne({_id: {$oid: id}})</span><span id="5d40" class="ky jr hi ku b fi lj la l lb lc">ctx.response.body = products</span><span id="8c86" class="ky jr hi ku b fi lj la l lb lc">}</span><span id="cb1a" class="ky jr hi ku b fi lj la l lb lc">//@route POST /broco/api/products</span><span id="e32e" class="ky jr hi ku b fi lj la l lb lc">const addProducts = async (ctx: RouterContext) =&gt; {</span><span id="44db" class="ky jr hi ku b fi lj la l lb lc">const {value: {name, uprice, description}} = await ctx.request.body()</span><span id="c080" class="ky jr hi ku b fi lj la l lb lc">const products: any = {</span><span id="4348" class="ky jr hi ku b fi lj la l lb lc">name,</span><span id="d019" class="ky jr hi ku b fi lj la l lb lc">uprice,</span><span id="631a" class="ky jr hi ku b fi lj la l lb lc">description,</span><span id="6d4b" class="ky jr hi ku b fi lj la l lb lc">date: new Date()</span><span id="d056" class="ky jr hi ku b fi lj la l lb lc">};</span><span id="74b6" class="ky jr hi ku b fi lj la l lb lc">const id = await productsCollection.insertOne(products)</span><span id="ca2e" class="ky jr hi ku b fi lj la l lb lc">console.log(id)</span><span id="cf58" class="ky jr hi ku b fi lj la l lb lc">products._id = id</span><span id="37bf" class="ky jr hi ku b fi lj la l lb lc">ctx.response.status = 201</span><span id="e773" class="ky jr hi ku b fi lj la l lb lc">ctx.response.body = products</span><span id="f05b" class="ky jr hi ku b fi lj la l lb lc">}</span><span id="fc0f" class="ky jr hi ku b fi lj la l lb lc">// @route PUT /broco/api/products/:id</span><span id="4ea4" class="ky jr hi ku b fi lj la l lb lc">const updateProducts = async (ctx: RouterContext) =&gt; {</span><span id="5d22" class="ky jr hi ku b fi lj la l lb lc">const id = ctx.params.id;</span><span id="2a2e" class="ky jr hi ku b fi lj la l lb lc">const {value: {name, uprice, description}} = await ctx.request.body()</span><span id="68f8" class="ky jr hi ku b fi lj la l lb lc">const { modifiedCount } = await productsCollection.updateOne({_id: {$oid: id}}, {</span><span id="3df9" class="ky jr hi ku b fi lj la l lb lc">$set: {</span><span id="7815" class="ky jr hi ku b fi lj la l lb lc">name,</span><span id="bf98" class="ky jr hi ku b fi lj la l lb lc">uprice,</span><span id="4309" class="ky jr hi ku b fi lj la l lb lc">description</span><span id="0096" class="ky jr hi ku b fi lj la l lb lc">}</span><span id="fc92" class="ky jr hi ku b fi lj la l lb lc">})</span><span id="3af9" class="ky jr hi ku b fi lj la l lb lc">if (!modifiedCount){</span><span id="6246" class="ky jr hi ku b fi lj la l lb lc">ctx.response.status = 404</span><span id="7647" class="ky jr hi ku b fi lj la l lb lc">ctx.response.body = {message: ‘Product does not exists’}</span><span id="bc4f" class="ky jr hi ku b fi lj la l lb lc">return</span><span id="2a88" class="ky jr hi ku b fi lj la l lb lc">}</span><span id="c394" class="ky jr hi ku b fi lj la l lb lc">ctx.response.body = await productsCollection.findOne({_id: {$oid: id}})</span><span id="e90d" class="ky jr hi ku b fi lj la l lb lc">}</span><span id="69ab" class="ky jr hi ku b fi lj la l lb lc">// @route DELETE /broco/api/products/:id</span><span id="9365" class="ky jr hi ku b fi lj la l lb lc">const deleteProducts = async (ctx: RouterContext) =&gt; {</span><span id="4a63" class="ky jr hi ku b fi lj la l lb lc">const id = ctx.params.id</span><span id="d64d" class="ky jr hi ku b fi lj la l lb lc">const product = await productsCollection.deleteOne({_id: {$oid: id}})</span><span id="08a9" class="ky jr hi ku b fi lj la l lb lc">if(!product) {</span><span id="44a4" class="ky jr hi ku b fi lj la l lb lc">ctx.response.status = 404</span><span id="b0d6" class="ky jr hi ku b fi lj la l lb lc">ctx.response.body = {message: ‘Product does not exists’}</span><span id="635a" class="ky jr hi ku b fi lj la l lb lc">return</span><span id="e6f4" class="ky jr hi ku b fi lj la l lb lc">}</span><span id="a071" class="ky jr hi ku b fi lj la l lb lc">ctx.response.status = 204</span><span id="dfbd" class="ky jr hi ku b fi lj la l lb lc">}</span><span id="3004" class="ky jr hi ku b fi lj la l lb lc">export { getProducts, addProducts, getProductsById, updateProducts, deleteProducts }</span></pre><h1 id="bf69" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">4.创建路线。</h1><p id="39af" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">在根目录下创建<strong class="is hj"> routes.ts </strong>文件，复制并粘贴下面的代码。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="9f19" class="ky jr hi ku b fi kz la l lb lc">import { Router } from ‘https://deno.land/x/oak/mod.ts'</span><span id="8808" class="ky jr hi ku b fi lj la l lb lc">import { getProducts, addProducts, getProductsById, updateProducts, deleteProducts } from ‘./controller/products.ts’</span><span id="0e95" class="ky jr hi ku b fi lj la l lb lc">const router = new Router()</span><span id="0fb1" class="ky jr hi ku b fi lj la l lb lc">router</span><span id="aaea" class="ky jr hi ku b fi lj la l lb lc">.get(‘/broco/v1/products’, getProducts)</span><span id="c8c0" class="ky jr hi ku b fi lj la l lb lc">.get(‘/broco/v1/products/:id’, getProductsById)</span><span id="2c3c" class="ky jr hi ku b fi lj la l lb lc">.post(‘/broco/v1/products’, addProducts)</span><span id="2391" class="ky jr hi ku b fi lj la l lb lc">.put(‘/broco/v1/products/:id’, updateProducts)</span><span id="0b49" class="ky jr hi ku b fi lj la l lb lc">.delete(‘/broco/v1/products/:id’, deleteProducts)</span><span id="7c78" class="ky jr hi ku b fi lj la l lb lc">export default router</span></pre><p id="c587" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">路由器- </strong> <em class="jp">一个注册中间件的接口，该接口将在请求某些 HTTP 方法和路径时运行，并且它还提供了参数化所请求路径的一部分的方法。</em></p><p id="080d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">GET()-</strong>-<em class="jp">当</em><strong class="is hj"><em class="jp">GET</em></strong><em class="jp">方法被请求时，为指定的路由注册中间件。</em></p><p id="0dfa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> post() - </strong> <em class="jp">请求</em><strong class="is hj"><em class="jp">POST</em></strong><em class="jp">方法时，为指定的路由注册中间件。</em></p><p id="12b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> put() - </strong> <em class="jp">当</em><strong class="is hj"><em class="jp">PUT</em></strong><em class="jp">方法被请求时，为指定的路由注册中间件。</em></p><p id="ed32" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> delete() - </strong> <em class="jp">请求</em> <strong class="is hj"> <em class="jp">删除</em> </strong> <em class="jp">方法时，为指定的路由注册中间件。</em></p><h1 id="ec5a" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">5.完成 server.ts 文件。</h1><p id="a782" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">使用注册中间件。<strong class="is hj">使用()</strong>方法和，然后使用<strong class="is hj">处理中间件的入站请求。</strong>倾听()(listen)法。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="8e01" class="ky jr hi ku b fi kz la l lb lc">import { Application } from ‘https://deno.land/x/oak/mod.ts'</span><span id="c13b" class="ky jr hi ku b fi lj la l lb lc">import router from ‘./routes.ts’</span><span id="d1c5" class="ky jr hi ku b fi lj la l lb lc">const port = 5000</span><span id="63b7" class="ky jr hi ku b fi lj la l lb lc">const app = new Application()</span><span id="00c5" class="ky jr hi ku b fi lj la l lb lc">app.use(router.routes())</span><span id="6ecb" class="ky jr hi ku b fi lj la l lb lc">app.use(router.allowedMethods())</span><span id="0aa9" class="ky jr hi ku b fi lj la l lb lc">console.log(`Server is running on port: ${port}`)</span><span id="a912" class="ky jr hi ku b fi lj la l lb lc">await app.listen({ port })</span></pre><h1 id="b59e" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">6.运行服务器。</h1><p id="246c" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">使用以下命令启动服务器。</p><pre class="kp kq kr ks fd kt ku kv kw aw kx bi"><span id="c936" class="ky jr hi ku b fi kz la l lb lc">deno run --allow-net --allow-write --allow-read --allow-plugin --unstable server.ts</span><span id="5f1e" class="ky jr hi ku b fi lj la l lb lc">NOTE: Because the MongoDB plug-in API of the Deno is still not stable, the --unstable flag needs to be used.</span></pre><h1 id="823e" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">7.用 Postman API 客户端测试 API。</h1><p id="bfdc" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">在<a class="ae jo" href="http://localhost:5000" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">http://localhost:5000</strong></a><strong class="is hj">上使用以下端点测试 API。</strong></p><figure class="kp kq kr ks fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/fdc886dc55bab9d9a609c79102d0a71a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6glQr_0-iXXhMD2h4GsOQQ.jpeg"/></div></div></figure><p id="e020" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">恭喜你……🥳，你已经用 Deno 和 MongoDB 创建了一个 REST API。</p><p id="4abb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">源代码:<a class="ae jo" href="https://github.com/giwi97/octo-broccoli" rel="noopener ugc nofollow" target="_blank">https://github.com/giwi97/octo-broccoli</a></p></div></div>    
</body>
</html>