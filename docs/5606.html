<html>
<head>
<title>Apache ShardingSphere x JD Baitiao: Story of an Implementation Journey</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache ShardingSphere x JD Baitiao:实现之旅的故事</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/apache-shardingsphere-x-jd-baitiao-story-of-an-implementation-journey-3006f2c0c90d?source=collection_archive---------5-----------------------#2021-10-22">https://medium.com/nerd-for-tech/apache-shardingsphere-x-jd-baitiao-story-of-an-implementation-journey-3006f2c0c90d?source=collection_archive---------5-----------------------#2021-10-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="19ad" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><em class="hi"> Apache ShardingSphere已经成为京东白条超大规模存储场景和纵向扩展的最佳解决方案。JD的购物节对我们的大数据存储产生了很大影响。我的意思是，像数以亿计的数据集。</em></p><p id="6bc7" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><em class="hi">2014年推出的互联网信贷产品提供商京东白条一直面临数据爆炸的挑战。每一次购物节对我们来说都像是一次技术测试，但每次技术人员都会在数据架构开发方面采取积极的战略举措，以确保一切顺利进行。</em></p><p id="6ea2" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated"><em class="hi"> —张东方，JD八条R &amp; D导演</em></p></blockquote><h1 id="8add" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">白条数据架构的演变</h1><p id="8d06" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">自2014年2月推出以来，由于数据量的快速增长和业务的快速增长，京东白条的数据架构已经进行了多次演进。</p><h2 id="c968" class="kn ji hi bd jj ko kp kq jn kr ks kt jr kh ku kv jv kj kw kx jz kl ky kz kd la bi translated">从2014年到2015年</h2><p id="9409" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">白条最早采用Solr + HBase方案，将核心业务系统和其他系统与关键数据库连接起来。Solr索引能够实现快速搜索响应，HBase用于存储大量数据。</p><ul class=""><li id="bb5b" class="lb lc hi il b im in iq ir kh ld kj le kl lf jg lg lh li lj bi translated">Solr集群可以帮助核心数据库减少读写压力。</li><li id="15ab" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg lg lh li lj bi translated">然而，Solr并不完美:它具有令人不满意的可扩展性和入侵性。</li></ul><h2 id="6055" class="kn ji hi bd jj ko kp kq jn kr ks kt jr kh ku kv jv kj kw kx jz kl ky kz kd la bi translated">从2015年到2016年</h2><p id="f2d0" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">公司选择NoSQL在Mongo DB集群中存储月度数据表，暂时满足支付结算场景下的海量数据导入/导出需求。</p><ul class=""><li id="70c9" class="lb lc hi il b im in iq ir kh ld kj le kl lf jg lg lh li lj bi translated">这一变化使得查询热门数据变得非常高效。此外，由于这种非结构化数据存储，员工可以轻松修改表结构。</li><li id="eb75" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg lg lh li lj bi translated">尽管如此，该计划仍然存在问题:糟糕的可扩展性、入侵和内存占用。</li></ul><h2 id="dcc6" class="kn ji hi bd jj ko kp kq jn kr ks kt jr kh ku kv jv kj kw kx jz kl ky kz kd la bi translated">从2016年到2017年</h2><p id="694a" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">不断增长的业务和数据。数百亿的数据量给MongoDB带来了更大的性能和数据量压力。JD Baitiao的大数据平台使用DBRep和MySQL Slave来捕获数据变化，并将信息数据存储在其消息中心，以便稍后写入es和HBase。</p><ul class=""><li id="9174" class="lb lc hi il b im in iq ir kh ld kj le kl lf jg lg lh li lj bi translated">这个计划实际上要好得多。它专注于实时数据和改进的可扩展性。</li><li id="89bc" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg lg lh li lj bi translated">然而，由于其架构中的数据分片问题，白条面临着维护其代码的高成本。</li></ul><p id="b04c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">京东白条的架构演变只是快速增长的互联网消费金融的一个例证。白条过去采取的所有方法都不全面，预示着每一种解决方案都将很快过时。</p><h1 id="f53b" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">是时候采用分离式架构了</h1><p id="2935" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">为了在数据量快速增长的情况下确保良好的系统性能，技术团队首先选择了分片架构模式，这种模式不仅能保证出色的性能，还能控制代码。</p><h2 id="6fb2" class="kn ji hi bd jj ko kp kq jn kr ks kt jr kh ku kv jv kj kw kx jz kl ky kz kd la bi translated">数据分条计划实际上基于应用程序架构:</h2><p id="1da4" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">产品不断发展，但早期的解决方案现在已经成为最大的问题之一。旧的数据分片计划使得代码更加复杂，增加了维护费用。每次应用程序升级时，开发人员都必须花费大量时间来调整分片，因此他们无法专注于自己的开发。事实上，紧耦合是问题的根源。</p><p id="7379" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">因此，该团队决定使用成熟的分片组件来简化系统升级和架构更改。为了比较白条的shard和ShardingSphere shard，它们的区别如下表所示。</p><figure class="lq lr ls lt fd lu er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es lp"><img src="../Images/1b868588c9dd80f49e3bd36587a9d4dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jV0NyvLrCr30gx1BCOi-lg.png"/></div></div></figure><p id="9a77" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">对于白条来说，脱钩是下一个任务。</p><p id="1937" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">显然，京东白条的数据架构将经历全新的解耦之旅。以下三个方向无疑推动了它的转变:</p><p id="0864" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">专注:</strong>它没有在其架构中内置数据库分片，而是应用了一个分片组件，将更多精力放在自己的产品开发上。</p><p id="b24d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">更简单的升级:</strong>它使用了一个去耦合的架构来简化系统升级的研发过程。</p><p id="49bb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">面向未来的计划:</strong>旨在提高系统可扩展性，使白条更有能力放心举办618购物节、双11购物节(也称11月11日光棍节)等大型网购节。</p><p id="2d89" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">京东白条是一个庞大的业务，所以它的业务场景是真正与金融、高并发、海量数据量相关的。白条的分片组件必须具有以下特性:</p><ol class=""><li id="da1f" class="lb lc hi il b im in iq ir kh ld kj le kl lf jg mb lh li lj bi translated">成为成熟的产品</li><li id="c922" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg mb lh li lj bi translated">表现优异</li><li id="04d3" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg mb lh li lj bi translated">能够处理大数据</li><li id="b8fe" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg mb lh li lj bi translated">具有可扩展的架构</li></ol><h1 id="6384" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">Apache ShardingSphere解决方案</h1><p id="1220" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">轻量级Java框架ShardingSphere-JDBC是Apache ShardingSpheres的第一个提供诸如Java数据库连接(JDBC) API等服务的产品。JDBC使用jar归档文件安装包，并允许客户端直接连接到数据库。因此，它不需要额外的部署依赖。它就像一个增强的JDBC驱动程序，完全兼容JDBC和ORM框架。</p><p id="f724" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">ShardingSphere — JDBC提供了以下特性，使其成为白条场景中的最佳解决方案。</p><p id="c22e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">成熟产品:</strong>sharding sphere——JDBC是一款经过多年开发的成熟产品，其开源社区非常活跃。</p><p id="eb20" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">性能优异:</strong>其微内核和轻量化设计几乎不妨碍性能。</p><p id="15ed" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">最小改动:</strong>支持原生MySQL协议，最小化R &amp; D工作量。</p><p id="3c80" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">扩展性:</strong>用户可以结合迁移同步组件轻松扩展数据。</p><figure class="lq lr ls lt fd lu er es paragraph-image"><div class="er es mc"><img src="../Images/428661834e739ea9d3669d72414ce6bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*Swy2yCPd5FfRwOfIbp6mxw.png"/></div></figure><p id="9b2e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">经过多次系统测试，Apache ShardingSphere成为JD白条首选的数据分片中间件。合作始于2018年底。</p><h1 id="1319" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">产品适应性</h1><p id="0740" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">为了给白条提供更好的服务和支持业务，Apache ShardingSphere在实现过程中对其产品功能和性能进行了许多改进。同时，用户案例反过来有助于优化产品。</p><p id="077f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">升级SQL引擎</strong></p><p id="cc11" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">白条的商业逻辑极其复杂；其多样化的场景需求需要最佳的SQL兼容性级别。因此，Apache ShardingSphere重构了SQL解析器模块，以支持更多的SQL。</p><ul class=""><li id="e438" class="lb lc hi il b im in iq ir kh ld kj le kl lf jg lg lh li lj bi translated">单数据节点路由:100% SQL兼容性</li><li id="f726" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg lg lh li lj bi translated">多数据节点路由:全面支持DML，DDL，DCL，TCL和部分DAL。支持分页、重复数据删除、排名、分组、聚合和相关查询等功能。</li></ul><p id="16f6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">分发密钥</strong></p><p id="a301" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">Apache ShardingSphere提供了内置的分布式密钥生成器，如UUID和雪花。它还提供了分布式密钥生成API，以便用户可以开发定制的密钥生成算法来满足他们的特殊需求。</p><p id="969d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">分片键值注入</strong></p><p id="0348" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">如果一个SQL没有分片条件，Apache ShardingSphere使用ThreadLoad来管理分片键值，用户可以编程并向HintManager添加一个分片条件，使该条件只在当前线程中有效。那就是所谓的SQL零入侵。</p><p id="fa17" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">此外，Apache ShardingSphere继续优化其其他特性，以满足白条对高性能的需求，例如:</p><ul class=""><li id="bfd4" class="lb lc hi il b im in iq ir kh ld kj le kl lf jg lg lh li lj bi translated">SQL解析结果缓存</li><li id="b036" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg lg lh li lj bi translated">JDBC元数据缓存</li><li id="059a" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg lg lh li lj bi translated">绑定表和广播表</li><li id="20c9" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg lg lh li lj bi translated">自动化执行引擎和流合并</li></ul><p id="9374" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">JD白条和ShardingSphere团队共同努力，产品的所有指标都达到了他们的预期。由此产生的最终性能几乎是相同的一个本土JDBC。</p><figure class="lq lr ls lt fd lu er es paragraph-image"><div role="button" tabindex="0" class="lv lw di lx bf ly"><div class="er es md"><img src="../Images/93311d81ba1dc0439fbbebb7eb94f776.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*djAPzN293WChTbRRvCoY0w.png"/></div></div></figure><h1 id="0f72" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">树木砍光了的</h1><p id="00c7" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">Apache ShardingSphere使用其定制的哈希策略对数据进行分片，有效地避免了热数据问题。数据节点总数几乎达到一万个。割接过程持续约4周。</p><ol class=""><li id="8a8d" class="lb lc hi il b im in iq ir kh ld kj le kl lf jg mb lh li lj bi translated">在DBRep读取数据之后，Apache ShardingSphere将数据同步到目标数据库集群。</li><li id="6c40" class="lb lc hi il b im lk iq ll kh lm kj ln kl lo jg mb lh li lj bi translated">两个集群一起运行。数据迁移后，白条使用自己的工具来验证业务和数据。</li></ol><p id="74ad" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">DBRep是ShardingSphere-Scaling产品设计的基础。扩展的自动化特性无疑有助于迁移和纵向扩展。</p><h1 id="0ae7" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">Apache ShardingSphere带来了许多好处</h1><p id="4fc1" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated"><strong class="il hj">简化升级路径</strong></p><p id="d652" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">分离的架构有效地简化了系统升级所需的技术堆栈，因此开发团队不再需要担心表分片。相反，他们可以专注于业务本身。简而言之，ShardingSphere极大地帮助了白条优化升级路径。</p><p id="8fcd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">节省R &amp; D成本</strong></p><p id="1178" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">白条直接使用成熟的产品Apache ShardingSphere，所以他们不需要重新发明轮子，节省了大量的时间和精力。</p><p id="a313" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated"><strong class="il hj">提高架构扩展性</strong></p><p id="e723" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">白条还使用同步迁移组件扩展，使系统扩展更加灵活。这是该公司网上购物节成功的秘诀。</p><h1 id="ec39" class="jh ji hi bd jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke bi translated">摘要</h1><p id="696f" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">京东白条业务的增长极大地刺激了其数据架构的升级。这一次，它选择了Apache ShardingSphere来分离其架构，并使未来的升级变得不那么复杂。由于这一点，从现在开始，开发人员只需专注于他们自己产品优化，因为它的数据架构具有足够的可扩展性。这个案例是消费金融场景中ShardingSphere应用的一个很好的例子。</p><p id="be4f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">现在，互联网信用支付模式越来越多。未来，Apache ShardingSphere将与京东科技合作，探索更多的业务场景，并贡献金融相关的技术创新，进一步完善互联网金融。</p><h2 id="716b" class="kn ji hi bd jj ko kp kq jn kr ks kt jr kh ku kv jv kj kw kx jz kl ky kz kd la bi translated">关于Apache ShardingSphere</h2><p id="a129" class="pw-post-body-paragraph ii ij hi il b im kf io ip iq kg is it kh ki iw ix kj kk ja jb kl km je jf jg hb bi translated">ShardingSphere是Apache Software Foundation顶级开源项目之一，被全球超过170家企业使用，涵盖金融、电子商务、云服务、旅游、物流、教育和娱乐等各个垂直领域。其GitHub社区迄今已累积超过14，000颗星星。</p><p id="5163" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">我们欢迎更多的技术专业人士写文章，分享他们的经验和想法。如果您有兴趣，请随时联系我们:</p><p id="d149" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it kh iv iw ix kj iz ja jb kl jd je jf jg hb bi translated">sharding sphere Github:<a class="ae me" href="https://github.com/apache/shardingsphere]()" rel="noopener ugc nofollow" target="_blank">https://github.com/apache/shardingsphere</a><br/>T3】sharding sphere Twitter:<a class="ae me" href="https://twitter.com/ShardingSphere]()" rel="noopener ugc nofollow" target="_blank">https://twitter.com/ShardingSphere</a><br/><br/>sharding sphere Slack Channel:<a class="ae me" href="http://apacheshardingsphere.slack.com/" rel="noopener ugc nofollow" target="_blank">apacheshardingsphere.slack.com</a></p></div></div>    
</body>
</html>