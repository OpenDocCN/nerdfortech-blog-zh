<html>
<head>
<title>Geospatial Analysis with Presto</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">快速地理空间分析</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/geospatial-analysis-with-presto-38c567443ee3?source=collection_archive---------18-----------------------#2021-04-13">https://medium.com/nerd-for-tech/geospatial-analysis-with-presto-38c567443ee3?source=collection_archive---------18-----------------------#2021-04-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="093b" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在本帖中，我们将探索Presto的地理空间功能，并利用Presto的地理空间功能来丰富数据和获得地理见解。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/01d19bf44ade338379ec691ef25523ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_KSv5M2xt8QYsKwT.png"/></div></div></figure><p id="03c8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="kf">本文是一个系列——</em><a class="ae kg" href="https://blog.bigdataboutique.com/series/intro%20to%20presto" rel="noopener ugc nofollow" target="_blank"><em class="kf">Presto</em></a><em class="kf">简介的一部分。如果你有兴趣，请订阅我们的</em> <a class="ae kg" href="http://bigdataboutique.hubspotpagebuilder.com/subscribe" rel="noopener ugc nofollow" target="_blank"> <em class="kf">简讯</em> </a> <em class="kf">保持联系。</em></p></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><p id="662f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在上一篇文章中，我们已经看到了如何<a class="ae kg" href="https://blog.bigdataboutique.com/2020/10/exploratory-analysis-and-etl-with-presto-and-aws-glue-iwtkxs" rel="noopener ugc nofollow" target="_blank">使用Presto来探索我们的数据并将其存储在S3上</a>。在这篇文章中，我们将探索Presto的另一个特性——地理空间功能。一些示例用例可能是找出感兴趣的地理点之间的距离，找出哪些点距离单个点最近，或者使用点之间的连接甚至形状来提供对数据的见解并丰富数据。我们将在这篇文章中探讨所有这些内容，然后简单讨论一下与Presto一起使用的地理数据格式。</p><h2 id="4ae6" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated">—内容</h2><ul class=""><li id="ac79" class="lj lk hi jl b jm ll jp lm js ln jw lo ka lp ke lq lr ls lt bi translated"><strong class="jl hj">理解所需的数据格式</strong></li><li id="0ca0" class="lj lk hi jl b jm lu jp lv js lw jw lx ka ly ke lq lr ls lt bi translated"><strong class="jl hj">寻找包含点<br/> </strong>的关系——将数据转换成WKT格式。<br/> -使用Presto查询数据。</li><li id="3f92" class="lj lk hi jl b jm lu jp lv js lw jw lx ka ly ke lq lr ls lt bi translated"><strong class="jl hj">找出哪些点最接近单个点<br/></strong>——获取店铺数据。<br/> -计算哪些商店离单点最近。</li></ul><h1 id="e804" class="lz kp hi bd kq ma mb mc ku md me mf ky io mg ip lb ir mh is le iu mi iv lh mj bi translated">了解所需的数据格式</h1><p id="31ec" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js mk ju jv jw ml jy jz ka mm kc kd ke hb bi translated">为了支持地理空间功能，Presto需要特定类型和格式的数据(或数据的转换)。我们将使用的基本格式是with众所周知的文本。在这种格式下，几何数据点如下所示:</p><p id="3c8b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">然而，数据点并不是唯一可用的几何图元类型。例如，多边形和多多边形允许我们将形状作为一种数据类型，从而将它们与一行数据相关联。那有什么用？好吧，考虑到数据条目可能不仅仅代表地图上的一个特定点——一座建筑、一座城市或一条道路。</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="ca71" class="ko kp hi mo b fi ms mt l mu mv">LINESTRING (0 0, 1 1, 1 2) POLYGON ((0 0, 4 0, 4 4, 0 4, 0 0), (1 1, 2 1, 2 2, 1 2, 1 1)) MULTIPOINT (0 0, 1 2) MULTILINESTRING ((0 0, 1 1, 1 2), (2 3, 3 2, 5 4)) MULTIPOLYGON (((0 0, 4 0, 4 4, 0 4, 0 0), (1 1, 2 1, 2 2, 1 2, 1 1)), ((-1 -1, -1 -2, -2 -2, -2 -1, -1 -1))) GEOMETRYCOLLECTION (POINT(2 3), LINESTRING (2 3, 3 4))</span></pre><p id="1b4f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">请注意，我使用了“几何”一词，而不是“地理”或“地理空间”来描述这些类型，因为它们实际上指的是地图上的形状，而不是描述这些点的真实语义。因此，在获取点之间的实际距离的上下文中，我们首先需要将它们转换成地理空间形式。我们稍后将讨论如何做到这一点，但首先，我们必须首先将我们的数据转换成WKT格式。</p><h1 id="9644" class="lz kp hi bd kq ma mb mc ku md me mf ky io mg ip lb ir mh is le iu mi iv lh mj bi translated">寻找包含一个点的关系</h1><p id="9f57" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js mk ju jv jw ml jy jz ka mm kc kd ke hb bi translated">在之前的帖子中，我们已经找到了以色列回收容器的位置。现在我们想找出每个集装箱在哪个城市。OpenStreetMap实际上并不包含这些信息:相反，它包含了描述自治市 边界的<a class="ae kg" href="https://www.openstreetmap.org/relation/1382494" rel="noopener ugc nofollow" target="_blank"> <strong class="jl hj">关系。因此，要了解一个数据点位于哪个城市，我们需要尝试并查明它位于适当类型的哪个关系中。现在您可能开始将点连接起来:地理空间功能允许您这样做，但是您首先必须获得WKT格式的点数据和自治市数据。</strong></a></p><h2 id="bb20" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">把数据转换成WKT格式。</strong></h2><p id="e6ef" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js mk ju jv jw ml jy jz ka mm kc kd ke hb bi translated">由于点数据是容易的部分，我们将从市政数据开始。我们已经可以通过前一篇文章中建立的Presto访问OpenStreetMap，因此尝试使用Presto从市政关系中收集WKT数据是很有诱惑力的，但这在这一点上有点超出范围。我们将把它作为一个练习，取而代之的是，使用一些现有的服务和一些代码来完成这项工作。</p><p id="74d8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我发现<a class="ae kg" href="https://overpass-turbo.eu/" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">transition-turbo</strong></a>是为这篇文章提取相关数据的一种充分的方法，尽管还有其他可能的方法来实现相同的结果。transition-turbo允许以多种格式从OpenStreetMap中导出选择。具体来说，可以提取包含所需信息的GeoJSON文件，然后可以很容易地将其转换为WKT。</p><p id="878e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们需要的信息是以色列的城市边界。根据<a class="ae kg" href="https://wiki.openstreetmap.org/wiki/Israel#Municipalities" rel="noopener ugc nofollow" target="_blank"><strong class="jl hj">OpenStreetMap WIKI</strong></a>，在以色列境内查询admin_level=8可以找到这个。为此，只需将站点中的地图集中在相关的地理位置上，然后粘贴查询:</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="b53b" class="ko kp hi mo b fi ms mt l mu mv">[out:json][timeout:25]; ( // query part for: "admin_level=8" relation["admin_level"="8"]["boundary"="administrative"]({{bbox}}); ); out body; &gt;; out skel qt;</span></pre><p id="fc47" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">然后可以点击“导出”导出数据，并选择GeoJSON格式。</p><p id="3c3d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们将使用python脚本将其转换为WKT。相关代码可以在 这里找到<a class="ae kg" href="https://github.com/BigDataBoutique/presto-training/tree/master/gj2wkt" rel="noopener ugc nofollow" target="_blank"> <strong class="jl hj">。关于这个脚本，我不会讲太多细节——一般来说，它的作用是:</strong></a></p><ol class=""><li id="ea61" class="lj lk hi jl b jm jn jp jq js mw jw mx ka my ke mz lr ls lt bi translated"><strong class="jl hj">过滤数据以仅返回我们有多边形数据的城市，而不是点数据。</strong></li><li id="0ecd" class="lj lk hi jl b jm lu jp lv js lw jw lx ka ly ke mz lr ls lt bi translated"><strong class="jl hj">用WKT格式的自治市的英文名称和几何形状创建记录</strong></li><li id="a97b" class="lj lk hi jl b jm lu jp lv js lw jw lx ka ly ke mz lr ls lt bi translated"><strong class="jl hj">将这些记录保存在S3的一个拼花文件中</strong></li></ol><p id="e106" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您会注意到这不是一个完整的以色列城市列表，所以我们肯定会有一些缺失的数据。</p><h2 id="aa55" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">使用Presto查询数据。</strong></h2><p id="22d0" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js mk ju jv jw ml jy jz ka mm kc kd ke hb bi translated">对于这一部分，您需要将对S3存储桶的引用更改为您自己的S3存储桶。</p><p id="7aaf" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在我们有了S3的数据，我们可以很快为它创建一个表。</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="5642" class="ko kp hi mo b fi ms mt l mu mv">CREATE TABLE glue."bdbq-osmplanet".boundaries ( name varchar, coordinates varchar ) WITH ( external_location = 's3://bdbq-israel-boundaries/parquet/', format = 'PARQUET' )</span></pre><p id="ec3a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">现在，我们可以将这个表和上一篇博客中创建的recycling containers表连接起来，使用地理空间函数ST_Contains将数据点与相关自治市进行匹配:</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="9802" class="ko kp hi mo b fi ms mt l mu mv">SELECT * FROM glue."bdbq-osmplanet".containers CROSS JOIN glue."bdbq-osmplanet".boundaries AS b WHERE ST_Contains(ST_GeometryFromText(b.coordinates),ST_POINT(lat,long))</span></pre><p id="fb43" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">而且……没有任何结果。哪里出了问题？</p><p id="b92d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">事实证明，地理空间函数使用的正确格式是(long，lat)而不是(lat，long)。虽然这对几何函数没有直接影响，但我们没有得到匹配，因为从市政当局提取的数据是一种格式，而创建的点是另一种格式。为了解决这个问题，正确的查询具有相反顺序的坐标:</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="7360" class="ko kp hi mo b fi ms mt l mu mv">SELECT * FROM glue."bdbq-osmplanet".containers CROSS JOIN glue."bdbq-osmplanet".boundaries AS b WHERE ST_Contains(ST_GeometryFromText(b.coordinates),ST_POINT(long,lat))</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es na"><img src="../Images/488cd7bb0a18eb26df3fec5da6b44cf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TFMglinb3Hjtgwrx.png"/></div></div></figure><p id="a5e8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">太棒了，我们现在有了每个集装箱的市政数据。有了这些数据，您可以做更多事情，比如找出每个自治市有多少个集装箱，但是我们这里关注的是地理空间功能，所以让我们探索另一个功能。</p><h1 id="b207" class="lz kp hi bd kq ma mb mc ku md me mf ky io mg ip lb ir mh is le iu mi iv lh mj bi translated">找出哪些点最接近单个点</h1><p id="1bfe" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js mk ju jv jw ml jy jz ka mm kc kd ke hb bi translated">在我们的下一个地理空间壮举中，我们将帮助一名来自以色列面包店的卡车司机确定他的确切位置。</p><p id="5109" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">地理空间查询的一个常见用例是“附近有什么”——您可能已经尝试过向手机中的应用程序询问这个问题，甚至可能已经问过一两次。卡车司机通常有预先确定的路线:至少他们知道在某个时间段内应该去哪些地方(比如便利店)。然而，一旦他们真的在商店里，知道他们在哪是一个优势:司机通过应用程序搜索当前商店的送货细节可能会意外地选择错误的商店。能够精确定位坐标并确定最近的商店将节省时间并提高效率。</p><h2 id="76b4" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">获取商店数据。</strong></h2><p id="a7ce" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js mk ju jv jw ml jy jz ka mm kc kd ke hb bi translated">我们首先要创建一个额外的表，包含司机可能去的所有商店。</p><p id="d16a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">由于OpenStreetMap中的元数据通常是与地区相关的，我们需要阅读<a class="ae kg" href="https://wiki.openstreetmap.org/wiki/Tag:shop%3Dsupermarket" rel="noopener ugc nofollow" target="_blank">上的相关标签</a>，并做一些探索性分析，以便找到正确的查询。由于我们在之前的帖子中已经做了类似的事情，这次我将跳过细节。最终的查询看起来像这样:</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="b88f" class="ko kp hi mo b fi ms mt l mu mv">CREATE TABLE glue."bdbq-osmplanet".supermarkets_il WITH ( external_location = 's3://bdbq-osmplanet/supermarkets_il', format = 'ORC') AS (SELECT * FROM glue.osm.osmplanet WHERE lat BETWEEN 29.5013261988 AND 34.2654333839 AND long BETWEEN 33.2774264593 AND 35.8363969256 AND element_at(tags, 'shop') IN ('supermarket','convenience'));</span></pre><p id="24fe" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">请注意，我们仍然使用lat和long来确定“以色列有什么”，尽管到目前为止，您应该知道使用地理空间函数可以更准确地完成这项工作。这种函数需要更长的时间来运行，毕竟，它不是直接处理坐标字段，而是对它们进行变换。但是，它会产生更准确的结果。因为细节已经讨论过了，所以这也是一个练习。</p><h2 id="dde4" class="ko kp hi bd kq kr ks kt ku kv kw kx ky js kz la lb jw lc ld le ka lf lg lh li bi translated"><strong class="ak">计算哪些商店离单点最近。</strong></h2><p id="ce00" class="pw-post-body-paragraph jj jk hi jl b jm ll ij jo jp lm im jr js mk ju jv jw ml jy jz ka mm kc kd ke hb bi translated">一旦我们创建了表，我们就可以查询它。假设司机在<a class="ae kg" href="https://geohack.toolforge.org/geohack.php?pagename=Rabin_Square&amp;params=32_4_51.18_N_34_46_50.06_E_type:landmark" rel="noopener ugc nofollow" target="_blank">拉宾广场</a>附近的一个坐标处。要使用地理空间距离函数，我们需要将几何点转换为球面地理:</p><pre class="iy iz ja jb fd mn mo mp mq aw mr bi"><span id="bc06" class="ko kp hi mo b fi ms mt l mu mv">SELECT *,distance FROM (SELECT element_at(tags,'name:en'),*,ST_DISTANCE( to_spherical_geography( ST_POINT(long,lat)),to_spherical_geography(ST_POINT(34.780572,32.080883))) as distance FROM glue."bdbq-osmplanet".supermarkets_il) AS b WHERE distance &lt; 200 ORDER BY b.distance ASC;</span></pre><p id="27f4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">该查询首先计算商店的距离，然后根据该距离对商店进行排序，以返回最近的商店。根据给定的坐标，我们可以说司机可能在返回的商店之一(当然假设OpenStreetMap用相关的商店更新)。</p><p id="5acd" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">显然，这里还有很多东西需要探索-距离的使用可以扩展到更复杂的分析用例，例如查找商店和最近的自动取款机之间的距离。Presto还支持Bing图块，这允许确定可缩放图块中点的存在。然而，与其深入研究地理空间功能，不如像您对我们的Presto系列感兴趣一样，我们希望听到您对我们在未来帖子中涉及的内容的意见。</p></div><div class="ab cl kh ki gp kj" role="separator"><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km kn"/><span class="kk bw bk kl km"/></div><div class="hb hc hd he hf"><p id="5e39" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="kf">原载于2021年4月13日https://blog.bigdataboutique.com</em><a class="ae kg" href="https://blog.bigdataboutique.com/2021/04/geospatial-analysis-with-presto-m2nqdw" rel="noopener ugc nofollow" target="_blank"><em class="kf"/></a><em class="kf">。</em></p></div></div>    
</body>
</html>