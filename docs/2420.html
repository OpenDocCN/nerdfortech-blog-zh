<html>
<head>
<title>How to Access and Query Your Amazon Redshift Data Using Python and R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Python和R访问和查询您的Amazon红移数据</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-access-and-query-your-amazon-redshift-data-using-python-and-r-3b10c21ecf04?source=collection_archive---------10-----------------------#2021-05-05">https://medium.com/nerd-for-tech/how-to-access-and-query-your-amazon-redshift-data-using-python-and-r-3b10c21ecf04?source=collection_archive---------10-----------------------#2021-05-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3fb4db31e0f71b674e75824e43546347.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*m77qJvKkUXPwXO98.png"/></div></div></figure><h1 id="0bc2" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">概观</h1><p id="cac6" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在本帖中，我们将看到如何使用Python访问和查询您的Amazon红移数据。在这个过程中，我们遵循两个步骤:</p><ul class=""><li id="8221" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">连接到红移仓库实例并使用Python加载数据</li><li id="707b" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">查询数据并存储结果以供分析</li></ul><p id="1138" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">由于Redshift与PostgreSQL等其他数据库兼容，我们使用Python <a class="ae lf" href="https://www.psycopg.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> psycopg </strong> </a>库来访问和查询Redshift中的数据。然后，我们将使用<a class="ae lf" href="https://www.sqlalchemy.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> SQLAlchemy </strong> </a>库将查询结果作为数据帧存储在pandas中。</p><p id="2755" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">本练习的目的是利用Python中可用的统计技术从红移数据中获得有用的见解。你可以获得的一些见解包括更好地理解你的客户的产品行为，预测流失率等。</p><blockquote class="lg lh li"><p id="57a2" class="jo jp lj jq b jr ko jt ju jv kp jx jy lk lc kb kc ll ld kf kg lm le kj kk kl hb bi translated"><em class="hi">我们也有一个专门的博客用于</em> <a class="ae lf" href="https://rudderstack.com/blog/how-to-access-and-query-your-bigquery-data-using-python-and-r/" rel="noopener ugc nofollow" target="_blank"> <em class="hi">使用Python和R </em> </a> <em class="hi">操作和查询你的Google BigQuery数据，如果你感兴趣的话。</em></p><p id="5f7e" class="jo jp lj jq b jr ko jt ju jv kp jx jy lk lc kb kc ll ld kf kg lm le kj kk kl hb bi translated">对于这篇文章，我们假设你已经在你的红移实例中加载了数据。如果您还没有，将数据加载到Redshift的最佳方式是利用客户数据基础设施工具，如RudderStack。它们允许您收集所有客户接触点的数据，并以最小的努力将它们安全地加载到Redshift或您选择的任何其他仓库中。</p></blockquote><h1 id="0dde" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">使用Python连接到您的红移数据</h1><p id="33b0" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">要使用Python访问您的红移数据，我们首先需要连接到我们的实例。如上所述，Redshift与PostgreSQL等其他数据库解决方案兼容。因此，您可以安全地使用工具来访问和查询PostgreSQL数据的红移。</p><p id="4e80" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">我们将使用<code class="du ln lo lp lq b">psycopg</code> Python驱动程序连接到我们的Redshift实例。也就是说，请随意尝试您选择的任何其他库来这样做。</p><pre class="lr ls lt lu fd lv lq lw lx aw ly bi"><span id="015c" class="lz ir hi lq b fi ma mb l mc md">import psycopg2<br/>con=psycopg2.connect(dbname= 'dbname', host='host', <br/>port= 'port', user= 'user', password= 'pwd')</span></pre><p id="b570" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">我们强烈建议您将上述代码用作管道的一部分，并将其封装在一个处理任何错误的函数中。您需要的参数是连接到任何数据库的典型参数:</p><ul class=""><li id="827b" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">数据库的名称</li><li id="7efe" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">主机名</li><li id="f47e" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">港口</li><li id="11a5" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">用户名</li><li id="f70d" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">密码</li></ul><h1 id="f905" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">使用Psycopg对红移数据执行查询</h1><p id="4297" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">一旦建立了数据库连接，我们就可以开始查询红移数据了。我们使用SQL查询来缩小我们分析所需的数据量。</p><p id="27f2" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">为了用<code class="du ln lo lp lq b">psycopg</code>做到这一点，我们执行以下步骤:</p><ul class=""><li id="e49f" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">我们从数据库连接中获得一个光标，如下所示:</li></ul><p id="288c" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">cur = con.cursor()</p><ul class=""><li id="0f27" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">我们从要从中提取数据的表中执行查询:</li></ul><p id="2152" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">cur . execute(" SELECT * FROM ` table '；")</p><ul class=""><li id="fa5f" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">一旦查询成功执行，我们就指示<code class="du ln lo lp lq b">psycopg</code>从数据库获取数据。对于进一步的数据分析，获取完整的数据集是有意义的。因此，我们运行以下命令:</li></ul><p id="239d" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">cur.fetchall()</p><ul class=""><li id="39d5" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">最后，我们关闭光标和连接，就像这样:</li></ul><p id="2c30" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">当前关闭()</p><p id="9b83" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">conn.close()</p><p id="12ef" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">这里最重要的部分是我们执行的从数据集中获取记录的SQL查询。您还可以使用SQL对大块数据进行预处理，并设置适当的数据集，使您的数据分析更加容易。</p><p id="5876" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">例如，您可以联接数据库中的多个表，或者使用支持红移的聚合函数根据需要创建新字段。</p><h1 id="cc9a" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">使用查询的数据进行数据分析</h1><p id="e380" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">既然我们已经成功地查询了红移数据，并将其提取出来用于我们的分析，那么是时候使用我们所拥有的数据分析工具来处理它了。</p><p id="7e84" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">说到Python，最流行的数据分析库是<code class="du ln lo lp lq b">NumPy</code>和<code class="du ln lo lp lq b">pandas</code>:</p><ul class=""><li id="417d" class="km kn hi jq b jr ko jv kp jz kq kd kr kh ks kl kt ku kv kw bi translated">NumPy是一个流行的Python库，主要用于数值计算。</li><li id="f186" class="km kn hi jq b jr kx jv ky jz kz kd la kh lb kl kt ku kv kw bi translated">pandas 是Python中一个广泛使用的数据分析库。它提供了一种称为DataFrame的高性能数据结构，用于处理类似表格的结构。</li></ul><p id="e132" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">无论您希望做什么样的分析，您都需要使用这两个库中的一个来表示您的初始数据。</p><h1 id="66e0" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">将数据加载到NumPy</h1><p id="53e1" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">将数据转换成一个<code class="du ln lo lp lq b">NumPy</code>数组非常简单。我们初始化一个新的<code class="du ln lo lp lq b">NumPy</code>数组，并将包含查询结果的光标作为参数传递。</p><p id="7b1c" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">在Python控制台中运行以下代码:</p><p id="697b" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">将numpy作为np导入</p><p id="7d69" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">data = np.array(cur.fetchall())</p><h1 id="04cc" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">给熊猫加载数据</h1><p id="ae66" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">你也可以用熊猫代替<code class="du ln lo lp lq b">NumPy</code>进行你的数据分析。然而，对于这一点，所涉及的步骤有点不同。</p><p id="15d3" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">请参考以下代码片段:</p><pre class="lr ls lt lu fd lv lq lw lx aw ly bi"><span id="ee1e" class="lz ir hi lq b fi ma mb l mc md">from sqlalchemy import create_engine<br/>import pandas as pd<br/>engine = create_engine('postgresql://scott:tiger@hredshift_host:&lt;port_no&gt;/mydatabase')<br/>data_frame = pd.read_sql('SELECT * FROM `table`;', engine</span></pre><p id="5264" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">如上面的代码所示，我们将使用<a class="ae lf" href="https://www.sqlalchemy.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> SQLAlchemy </strong> </a>通过连接凭证连接到我们的红移实例。然后，我们使用<a class="ae lf" href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.read_sql.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> read_sql方法</strong> </a>对数据库进行sql查询。最后，我们可以将结果直接加载到数据框架中，并用于我们的分析。</p><h1 id="d74d" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">如何使用R访问和查询红移数据？</h1><p id="c985" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在r中加载和查询红移数据同样简单。我们可以使用<code class="du ln lo lp lq b">RPostgreSQL</code>包连接到我们的红移实例，然后对数据运行查询。</p><p id="c370" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">以下是如何在RStudio中安装软件包:</p><p id="c50c" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">install.packages("RPostgreSQL ")</p><p id="d5a8" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">require("RPostgreSQL ")</p><p id="8fa6" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">下一步是连接到Redshift实例，如下所示:</p><pre class="lr ls lt lu fd lv lq lw lx aw ly bi"><span id="fb10" class="lz ir hi lq b fi ma mb l mc md">drv &lt;- dbDriver("PostgreSQL")<br/>con &lt;-dbConnect(drv,dbname="dbname",host="host",port=1234,<br/>                user="user",password="password")<br/>dbDisconnect(con)</span></pre><blockquote class="lg lh li"><p id="b967" class="jo jp lj jq b jr ko jt ju jv kp jx jy lk lc kb kc ll ld kf kg lm le kj kk kl hb bi translated"><em class="hi">注意:从数据库中取出数据后，关闭连接是很重要的。</em></p></blockquote><p id="cd05" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">查询数据并将其加载到R数据框中也很容易:</p><p id="f26d" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi translated">今日无云。</p><h1 id="affc" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">加入我们的<a class="ae lf" href="https://resources.rudderstack.com/join-rudderstack-slack" rel="noopener ugc nofollow" target="_blank"> Slack </a>与我们的团队聊天，查看我们在<a class="ae lf" href="https://github.com/rudderlabs" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上的开源报告，订阅<a class="ae lf" href="https://rudderstack.com/blog/" rel="noopener ugc nofollow" target="_blank">我们的博客</a>，在社交上关注我们:<a class="ae lf" href="https://twitter.com/RudderStack" rel="noopener ugc nofollow" target="_blank"> Twitter </a>、<a class="ae lf" href="https://www.linkedin.com/company/rudderlabs/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>、<a class="ae lf" href="https://dev.to/rudderstack" rel="noopener ugc nofollow" target="_blank"> dev.to </a>、<a class="ae lf" href="https://rudderstack.medium.com/" rel="noopener"> Medium </a>、<a class="ae lf" href="https://www.youtube.com/channel/UCgV-B77bV_-LOmKYHw8jvBw" rel="noopener ugc nofollow" target="_blank"> YouTube </a>。不要错过任何更新。<a class="ae lf" href="https://rudderstack.com/blog/" rel="noopener ugc nofollow" target="_blank">立即订阅</a>我们的博客！</h1><p id="decd" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated"><em class="lj">原载于https://rudderstack.com</em><a class="ae lf" href="https://rudderstack.com/blog/access-and-query-your-amazon-redshift-data-using-python-and-r" rel="noopener ugc nofollow" target="_blank"><em class="lj"/></a><em class="lj">。</em></p><p id="2875" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi">While we focused on Amazon Redshift in this blog, the process is also applicable to other databases like PostgreSQL. In this post, we used psycopg to connect to our Redshift instance — the same Python connector can be used to connect to a PostgreSQL instance as well.</p><p id="13c9" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi">One of the advantages of residing your data within a database as opposed to other formats such as CSV files is the ability to query it using SQL. You can run complex SQL queries to preprocess your data effectively and save a lot of your time and effort in building statistical models for an in-depth data analysis.</p><h1 id="d48d" class="iq ir hi bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi">Try RudderStack Today</h1><p id="7cfa" class="pw-post-body-paragraph jo jp hi jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi">Start building a smarter customer data pipeline. Use all your customer data. Answer more difficult questions. Send insights to your whole customer data stack. Sign up for <a class="ae lf" href="https://app.rudderlabs.com/signup?type=freetrial" rel="noopener ugc nofollow" target="_blank">RudderStack Cloud Free</a> today.</p><p id="9398" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi">Join our <a class="ae lf" href="https://resources.rudderstack.com/join-rudderstack-slack" rel="noopener ugc nofollow" target="_blank">Slack</a> to chat with our team, check out our open source repos on <a class="ae lf" href="https://github.com/rudderlabs" rel="noopener ugc nofollow" target="_blank">GitHub</a>, subscribe to <a class="ae lf" href="https://rudderstack.com/blog/" rel="noopener ugc nofollow" target="_blank">our blog</a>, and follow us on social: <a class="ae lf" href="https://twitter.com/RudderStack" rel="noopener ugc nofollow" target="_blank">Twitter</a>, <a class="ae lf" href="https://www.linkedin.com/company/rudderlabs/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>, <a class="ae lf" href="https://dev.to/rudderstack" rel="noopener ugc nofollow" target="_blank">dev.to</a>, <a class="ae lf" href="https://rudderstack.medium.com/" rel="noopener">Medium</a>, <a class="ae lf" href="https://www.youtube.com/channel/UCgV-B77bV_-LOmKYHw8jvBw" rel="noopener ugc nofollow" target="_blank">YouTube</a>. Don’t miss out on any updates. <a class="ae lf" href="https://rudderstack.com/blog/" rel="noopener ugc nofollow" target="_blank">Subscribe</a> to our blogs today!</p></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><p id="37f9" class="pw-post-body-paragraph jo jp hi jq b jr ko jt ju jv kp jx jy jz lc kb kc kd ld kf kg kh le kj kk kl hb bi"><em class="lj">Originally published at </em><a class="ae lf" href="https://rudderstack.com/blog/access-and-query-your-amazon-redshift-data-using-python-and-r" rel="noopener ugc nofollow" target="_blank"><em class="lj">https://rudderstack.com</em></a><em class="lj">.</em></p></div></div>    
</body>
</html>