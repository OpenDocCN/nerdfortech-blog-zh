<html>
<head>
<title>Fetch Forex API with Python and Pandas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 和 Pandas 获取外汇 API</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/fetch-forex-api-with-python-and-pandas-c9ed95207186?source=collection_archive---------0-----------------------#2021-03-23">https://medium.com/nerd-for-tech/fetch-forex-api-with-python-and-pandas-c9ed95207186?source=collection_archive---------0-----------------------#2021-03-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/aae010730ef213aa1b54787d4f633969.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-PDbLyileI56YXMMQh7Iqw.png"/></div></div></figure><p id="2c75" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在编写了实时外汇数据的更复杂的实现之后，我突然想到我错过了一个针对 python 用户的 REST API 的简单实现。因此，在这里，我们试图学习使用 python 和 pandas 来消费当前和历史外汇数据。如果您正在寻找快速实现，请参阅我们关于 Python SDK 的文章。</p><p id="7dad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们开始解释之前，你需要对 python 有一个基本的了解，我指的是像看“10 分钟之内学会 Python”视频中那样的基础。也就是说，本教程应该对有其他编程语言经验的人和想使用我们的 Forex REST API 的人有所帮助。</p><p id="63c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">那么让我们开始</strong></p><p id="27a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你需要注册我们的 API，只需点击<a class="ae jo" href="https://marketdata.tradermade.com/signup" rel="noopener ugc nofollow" target="_blank">免费加入 API</a>。一旦你有了钥匙，请妥善保管。这和 Python 环境是你学习本教程所需要的。为了简单起见，我会推荐没有设置 python 的用户使用<a class="ae jo" href="http://colab.research.google.com/" rel="noopener ugc nofollow" target="_blank"> Google Colab </a>并启动一个 Jupyter 笔记本。对于安装了 Python 的人来说，这些程序可以在本地运行。</p><p id="da00" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您将需要安装一些库，但对于 Colab，您不需要安装只需导入。如果你是 Python 的初学者或者想快速测试一小段代码，google 的 Collaboratory 非常好。</p><h2 id="be84" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">使用实时端点调用实时外汇汇率</h2><pre class="kk kl km kn fd ko kp kq kr aw ks bi"><span id="c8da" class="jp jq hi kp b fi kt ku l kv kw">import requests<br/>from pprint import PrettyPrinter<br/>pp = PrettyPrinter()</span></pre><p id="442c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以将上面的代码复制粘贴到 Google Colab Notebook 的一个单元格中，然后按 shift+enter 或者点击 play 按钮。</p><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kx"><img src="../Images/a45eeecd47983b82391777ebe9baa6d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c06sUaNt8Bj-ZzJSoeiFFg.png"/></div></div></figure><p id="33b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以看到这个单元已经运行了，我们有了一个新的单元来写下一段代码。在运行下面的代码之前，我们需要理解它的含义。url 是我们正在调用的端点，货币是逗号分隔的字符串，api_key 是您通过注册获得的密钥。要调用 forex REST API，我们需要我们在前面的单元格中导入的请求库，请求库有一个 get 函数，它接受一个 URL 和一个 JSON 参数，在本例中是“querystring”。响应是我们从 API 得到的，然后我们用 PrettyPrinter 打印响应，这样看起来很好。</p><pre class="kk kl km kn fd ko kp kq kr aw ks bi"><span id="e4a0" class="jp jq hi kp b fi kt ku l kv kw">url = "https://marketdata.tradermade.com/api/v1/live"</span><span id="521e" class="jp jq hi kp b fi ky ku l kv kw">currency = "USDJPY,GBPUSD,UK100"<br/>api_key = "api_key"<br/>querystring = {"currency":currency,"api_key":api_key}</span><span id="a24b" class="jp jq hi kp b fi ky ku l kv kw">response = requests.get(url, params=querystring)</span><span id="61fd" class="jp jq hi kp b fi ky ku l kv kw">pp.pprint(response.json())</span></pre><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/e45932a85c3147ea444e8c9b71611c96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cO-hhn_KpwR9SOgK8_J-WQ.png"/></div></div></figure><p id="28bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如您所见，我们在不超过 6 行的代码中获得了美元兑日元、GBPUSD 和富时 100 的实时汇率。然而，为了做一些数据分析或者以一种更直观的方式来查看比率，我们需要将它们放在一个表格中，或者如我们在 pandas 中所说的 DataFrame。</p><p id="99e0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以在这里我们将介绍 pandas，它是一个为数据分析而创建的扩展库。pandas 使得迭代、制表、修改和计算数据的工作变得相当容易，但是对于本教程，我将把范围限制在从 API 获取、保存和制表数据。所以让我们继续</p><pre class="kk kl km kn fd ko kp kq kr aw ks bi"><span id="d6ba" class="jp jq hi kp b fi kt ku l kv kw">import pandas as pd<br/>df = pd.DataFrame(response.json()["quotes"])<br/>df</span></pre><p id="5ad8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">熊猫也可以从 API 获取数据，但是为了更好地理解，我们使用了请求。如果您请求的数据不是一个精确的数据帧，那么最好使用请求。我们将在 response.json 中收到的引用传递给 pandas 函数，该函数将数据转换成数据帧，瞧！我们现在用一行代码将数据制成表格。</p><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/66e37a8783180917d4708cd9fb618519.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FQnPdciVgWa1CO9yc59gvQ.png"/></div></div></figure><p id="3d86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面熊猫的数据框更易读，但我们仍然没有。我们将做一些调整，使其更具可读性。我们可以看到仪器列中有 NaN，并询问，bid、mid 不符合顺序，并且我们没有时间戳，因此让我们快速解决这个问题。</p><pre class="kk kl km kn fd ko kp kq kr aw ks bi"><span id="3f4c" class="jp jq hi kp b fi kt ku l kv kw"># if all instruments are currencies just write a # in front of line 1 and take # off line 2 in the below code. If all instruments are CFDs just write # in line 1 and 2.</span><span id="8512" class="jp jq hi kp b fi ky ku l kv kw">Import numpy as np<br/>df["instrument"] = np.where(df["base_currency"].isnull(),df["instrument"],df["base_currency"]+df["quote_currency"])<br/>#df["instrument"] = df["base_currency"]+df["quote_currency"]<br/>df["timestamp"] = response.json()["timestamp"]<br/>df["timestamp"] = pd.to_datetime(df["timestamp"], unit="s")<br/>df = df[["instrument","bid","mid","ask","timestamp"]]<br/>df</span></pre><p id="d507" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将导入 numpy，这是另一个与 pandas 密切配合的库，然后将使用“np.where”函数更改 instrument 列，该函数接受(条件，如果为假，则为真)，然后将创建一个名为 timestamp 的新列，并写入我们从 API response.json 收到的时间戳，并将其转换为可读的时间戳。</p><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lb"><img src="../Images/e1565e3dfe834c005e76944a80c82002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RFoUOUsIcVwxzp8-.png"/></div></div></figure><p id="6431" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在您可以看到为什么 Pandas 如此受欢迎，Python 如此多产。所有这些代码都执行得非常快。您也可以这样做:</p><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/2b76f8a7117964f8454bde9bda047e21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*43aUGIbPyYQ2g79h.png"/></div></div></figure><p id="b54f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用如下所示的单一命令保存您的工作，并通过 CSV 文件共享您的工作。</p><pre class="kk kl km kn fd ko kp kq kr aw ks bi"><span id="9f17" class="jp jq hi kp b fi kt ku l kv kw">df.to_csv('live_rates.csv')</span></pre><p id="560b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要深入了解我们的端点，请查看我们的<a class="ae jo" href="https://marketdata.tradermade.com/docs/restful-api" rel="noopener ugc nofollow" target="_blank"> rest API 数据文档页面</a>。</p><h2 id="c870" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">使用历史端点调用历史外汇数据</h2><p id="9507" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated"><strong class="is hj">每日历史</strong></p><p id="e1c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每日历史数据端点与实时端点非常相似，唯一的区别是响应 JSON 有日期而不是时间戳，报价中有开盘价、最高价、最低价和收盘价。我们已经定义了 currency 和 api_key，所以我们需要提供的只是我们需要数据的日期。</p><pre class="kk kl km kn fd ko kp kq kr aw ks bi"><span id="c13d" class="jp jq hi kp b fi kt ku l kv kw">url = "https://marketdata.tradermade.com/api/v1/historical"<br/>date = "2021-03-15"<br/>querystring = {"currency":currency,"date":date, "api_key":api_key}<br/>response = requests.get(url, params=querystring)<br/>  <br/>df = pd.DataFrame.from_dict(response.json()["quotes"], orient='columns', dtype=None, columns=None)<br/>df["instrument"] = np.where(df["base_currency"].isnull(),df["instrument"],df["base_currency"]+df["quote_currency"])<br/>df["date"] = response.json()["date"]<br/>df["date"] = pd.to_datetime(df["date"])<br/>df = df[["instrument","bid","mid","ask","date"]]<br/>df</span></pre><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es li"><img src="../Images/4757357fad515dc118b8ce8392a164f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Q2bWfrd7MlpOb0pP.png"/></div></div></figure><p id="8994" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以看到用数据制作表格是很容易的，并且不难想象，用一点熊猫的魔力，你就可以随心所欲地分割数据。您还可以循环访问请求，请求不同日期的数据，这种可能性是无穷无尽的。对于另外两个数据历史端点:minute_historical 和 hour historical，您一次只能调用每种货币的一个汇率，因此需要遍历数据。</p><p id="8aaf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">分钟和小时历史</strong></p><p id="48be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">两个端点的调用几乎相同，因此将仅使用一个分钟历史示例，如下所示:</p><pre class="kk kl km kn fd ko kp kq kr aw ks bi"><span id="70cf" class="jp jq hi kp b fi kt ku l kv kw">fx = ["EURUSD", "USDJPY"]<br/>dates = ["2021-03-15-13:00"]<br/>array = []<br/>url = "https://marketdata.tradermade.com/api/v1/minute_historical"</span><span id="3db3" class="jp jq hi kp b fi ky ku l kv kw">for i in fx:<br/>    for date in dates: <br/>          querystring = {"currency":i,"date_time":date, "api_key":api_key}<br/>          response = requests.get(url, params=querystring)<br/>          array.append(response.json())<br/>df = pd.DataFrame(array)<br/>df</span></pre><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lj"><img src="../Images/46d4a7eec9269c6d2e8e205aa4b10fe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*a6m13ywcNzT-CX-k.png"/></div></div></figure><p id="3534" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">到目前为止，我们可以看到，要求不同的日期和不同的货币并不十分困难，只要做一点工作，就可以创建一个系统来检查利率，并根据我们预设的一些条件突出显示某些警报。然而，这超出了本文的范围，我们建议探索 pandas，它是一个非常方便的数据分析库。</p><h2 id="7c29" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">使用 timeseries 端点调用时序外汇数据</h2><p id="c7f9" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">如果您请求历史端点，请求通常是某个时间点的价格。我们现在来看看用于趋势分析和图表的时间序列，并获取数据。然而，我们不需要请求库，因为我们可以只用熊猫来做所有的事情。是时候加快我们获取数据的速度了。</p><pre class="kk kl km kn fd ko kp kq kr aw ks bi"><span id="ab42" class="jp jq hi kp b fi kt ku l kv kw">url = "https://marketdata.tradermade.com/api/v1/timeseries?"<br/>currency="USDJPY"<br/>start_date="2021-03-01"<br/>end_date="2021-03-22"<br/>format="split"<br/>interval="daily"</span><span id="f769" class="jp jq hi kp b fi ky ku l kv kw">df=pd.read_json('https://marketdata.tradermade.com/api/v1/timeseries?currency='+currency+'&amp;api_key='+api_key+'&amp;start_date='+start_date+'&amp;end_date='+end_date+'&amp;format='+format+'&amp;interval='+interval)<br/>df = pd.DataFrame(df.quotes['data'], columns=df.quotes['columns'])<br/>df.tail()</span></pre><p id="2b6e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">熊猫可以使用 read_json 或 read_csv 等函数从 API 请求数据。我们的 forex API timeseries 端点接受一个名为 format 的参数，当该格式设置为“split”时，很容易将其转换为 pandas 数据帧。然后，我们读取从 API 传入的列，然后使用命令 df.tail()打印我们收到的最后五行数据，如果您想查看前五个数据点，只需执行 df.head()。</p><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lk"><img src="../Images/1bc51a2a0e68c387e3152d142f1e64aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sz3sbnHwsR8xVayJ.png"/></div></div></figure><p id="58ac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据已经以一种易于播放的方式进行了格式化，我们也可以对每小时和粒度数据提出类似的请求，我们需要做的只是添加一些小的更改，如将 start date 和 end_date 更改为“YYYY-mm-dd-HH:MM ”,将 interval 更改为 hourly。你可以看到下面:</p><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ll"><img src="../Images/3874b287a528e036fcfcbffb70e02155.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YV6bNY6Y0XEQzWnG.png"/></div></div></figure><p id="d2bc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以用上面的数据框架做很多事情，比如为范围、变化百分比、滚动相关性和波动性做一个额外的列。然而，这超出了本文的范围。你可以看看我们的<a class="ae jo" href="https://tradermade.com/tutorials/data-visualisation-python/" rel="noopener ugc nofollow" target="_blank">数据可视化文章</a>，它展示了基本的熊猫相关性和波动性命令。</p><h2 id="b22e" class="jp jq hi bd jr js jt ju jv jw jx jy jz jb ka kb kc jf kd ke kf jj kg kh ki kj bi translated">使用分笔成交点样本端点调用分笔成交点历史汇率</h2><p id="9f65" class="pw-post-body-paragraph iq ir hi is b it ld iv iw ix le iz ja jb lf jd je jf lg jh ji jj lh jl jm jn hb bi translated">最后，我们将查看 tick 历史数据，如果您正在进行任何严肃的数据分析，包括交易算法和机器学习，这些数据将非常有用。然而，分笔成交点数据可用于许多目的。我们将能够从 rest API 的一行代码中获取 pandas 数据框中的数据。在我们运行我们的代码之前，提醒一下，tick 数据仅对过去四天的免费用户可用，不包括今天，您不能在免费计划上一次请求超过三十分钟，并且每次调用将花费 20 个 API 请求。所以我建议使用 df . to _ CSV(“example . CSV”)在本地保存文件，然后通过 df . read _ CSV(“example . CSV”)读入。此外，对 Google Colab 用户的一个提醒是，因为我们的分笔成交点数据端点的开始日期和结束日期格式中有一个缺口，我们需要用“%20”来填充这个缺口。这是我在谷歌协作笔记本中注意到的，你不需要在 Jupyter 笔记本或 Python 脚本中做。</p><pre class="kk kl km kn fd ko kp kq kr aw ks bi"><span id="f97a" class="jp jq hi kp b fi kt ku l kv kw"># start date is 2021-03-22 14:00 but %20 is added to the gap as url dont like empty spaces (this is added automatically but Google Colab doesnt seem to like this)</span><span id="f309" class="jp jq hi kp b fi ky ku l kv kw">currency="EURUSD"<br/>start_date="2021-03-22%2014:00"<br/>end_date="2021-03-22%2014:30"<br/>format="csv"</span><span id="2079" class="jp jq hi kp b fi ky ku l kv kw">url = "https://marketdata.tradermade.com/api/v1/tick_historical_sample/"+currency+"/"+start_date+"/"+end_date+"?api_key="+api_key+"&amp;format="+format</span><span id="6988" class="jp jq hi kp b fi ky ku l kv kw">df =pd.read_csv(url)</span><span id="8f30" class="jp jq hi kp b fi ky ku l kv kw">df.tail()</span></pre><figure class="kk kl km kn fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/38a8a04b36c2b39d36968a226347c570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ghtvMXcXsjZwXvLm.png"/></div></div></figure><p id="3d0a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如您所见，您刚刚获得了欧元兑美元近 2000 个基点的历史数据。你可以从我们的<a class="ae jo" href="https://github.com/tradermade/Forex-REST-API/blob/main/tradermade.ipynb" rel="noopener ugc nofollow" target="_blank"> Tradermade Github 页面</a>获得 Jupyter 笔记本文件。希望这篇文章能够帮助初学者和有经验的程序员使用 Python 和 pandas 从 Forex REST API 获取数据。请留下您的意见和建议。</p></div></div>    
</body>
</html>