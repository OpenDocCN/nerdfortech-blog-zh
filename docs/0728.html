<html>
<head>
<title>C++ Libraries — Part I: Design</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">C++库—第一部分:设计</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/c-libraries-part-i-design-9ed997dca8f3?source=collection_archive---------2-----------------------#2021-02-09">https://medium.com/nerd-for-tech/c-libraries-part-i-design-9ed997dca8f3?source=collection_archive---------2-----------------------#2021-02-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7bd9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这篇博客文章讲述了创建C++库的基础知识。</p><p id="9c70" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它最初是由于一些人的提问而创建的，所以我决定为希望扩展他们对库的一般知识，特别是C++库的知识的开发人员创建这个简短的介绍。</p><p id="025c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是两篇博文的第一部分，第二部分可以在这里找到。</p><p id="808c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你有兴趣让你的图书馆创作更上一层楼，这篇博文是为你准备的:)</p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><h1 id="1e1e" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">0.什么是图书馆？</h1><p id="b5a9" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated"><em class="ko">“图书馆是信息源和类似资源的精选集合”</em></p><p id="468b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每个软件工程师都熟悉“库”这个术语。</p><p id="25ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在C++中(尤其是在基于OOP设计的项目中)，几乎每个类都定义了一个API(应用编程接口)。但并不是每个API都是一个库。</p><p id="2401" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然上面的引用是指物理库，但这实际上也适用于软件库。</p><p id="c4d2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以想象一个包含不同主题出版物的实体图书馆。出版物一个接一个地出现在目录中，但是您也可以将几个组合成一个集合。一个软件库可以有一个单一的功能区域(文本解析器),也可以由多个功能区域组成——就像标准的C++库一样。</p><p id="b4ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个软件库意味着通过一个定义好的API来提供功能，但是还有更多——写一个库听起来很容易，但是它隐藏了<em class="ko">一个非常复杂的问题</em>。</p><p id="5523" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们开始之前，让我们定义这些基本术语:</p><ul class=""><li id="df6a" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc ku kv kw kx bi translated"><strong class="ih hj">库</strong>:库代码，为了使用，用户必须在她的代码中添加`#include "mylib.hpp " '。</li><li id="58d6" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc ku kv kw kx bi translated"><strong class="ih hj">用户代码:</strong>导入库并调用实用程序的程序部分。</li></ul><p id="e3fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下面的博客中，我们将使用下面的(过于简化，<em class="ko">不工作</em>)代码示例:</p><h2 id="1fc6" class="ld jm hi bd jn le lf lg jr lh li lj jv iq lk ll jz iu lm ln kd iy lo lp kh lq bi translated">库(“仅标题”版本)</h2><figure class="lr ls lt lu fd lv"><div class="bz dy l di"><div class="lw lx l"/></div></figure><h2 id="b030" class="ld jm hi bd jn le lf lg jr lh li lj jv iq lk ll jz iu lm ln kd iy lo lp kh lq bi translated">用户代码</h2><figure class="lr ls lt lu fd lv"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="e7f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意，该库可以写成“仅头文件”-仅`. hpp `文件，或者`. hpp &amp; .cpp `(通过从定义中分离声明，并将定义移动到`. cpp `文件中)。</p><p id="a8a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在头文件中编写代码会产生一些小的技术差异(这里不做解释)，但是当模板被用作编写库代码的技术时，通常会用到“仅头文件库”这个术语。</p><p id="1eab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在头文件中使用“开放”模板的主要区别在于模板能够“按需”创建实现<strong class="ih hj"/>，这只能在。hpp源代码是提供给用户的代码。</p><p id="efed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(模板库将在本博客的后面出现，但是关于模板技术的详细解释将在另一个博客中发表)。</p><h1 id="e9b7" class="jl jm hi bd jn jo ly jq jr js lz ju jv jw ma jy jz ka mb kc kd ke mc kg kh ki bi translated">一、如何设计图书馆？</h1><p id="4920" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">当你计划写一个库的时候，有一些事情需要考虑。</p><h2 id="c736" class="ld jm hi bd jn le lf lg jr lh li lj jv iq lk ll jz iu lm ln kd iy lo lp kh lq bi translated">库的API是什么？</h2><p id="3966" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">这是你需要做的最重要的决定。</p><p id="775c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当您定义API时，您定义了用户将如何使用库，更重要的是，您定义了在库的不同版本之间不应该改变什么。</p><p id="6eff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你改变API——你在你的库中创建了一个突破性的改变，所以在定义它之前要仔细考虑。</p><p id="4cb2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最佳实践(来自OOP设计)是封装所有的实现细节，只暴露用户需要调用的部分。</p><h2 id="8883" class="ld jm hi bd jn le lf lg jr lh li lj jv iq lk ll jz iu lm ln kd iy lo lp kh lq bi translated">对图书馆有什么要求？</h2><p id="0a58" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">这里你需要考虑一下用法。</p><p id="0a80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你的库是供系统开发人员使用，还是供其他库作者使用，或者介于两者之间？它是一个本地工具(由程序的特定部分使用，例如写入文件系统)，还是一个与整个程序相关的全局工具？(例如，日志或通用包装)</p><h2 id="63e9" class="ld jm hi bd jn le lf lg jr lh li lj jv iq lk ll jz iu lm ln kd iy lo lp kh lq bi translated">对指定用户来说什么是重要的？</h2><p id="d036" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">这可能是下面的一个或多个:小代码大小、快速运行时性能、可读性、简单性、向后兼容性等。<br/>请注意，其中一些与另一些相互矛盾。</p><h2 id="5380" class="ld jm hi bd jn le lf lg jr lh li lj jv iq lk ll jz iu lm ln kd iy lo lp kh lq bi translated">用户将如何使用它？</h2><p id="841d" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">这一部分被分成两个不同的部分。尽管它们可能是相关的，但重要的是要注意这两者并不相互关联:</p><ol class=""><li id="d5a3" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc md kv kw kx bi translated">设计构图。</li><li id="31b2" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc md kv kw kx bi translated">代码组合。</li></ol><p id="8be2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">设计构图</strong></p><p id="ed46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何在导入代码中使用库工具。两个主要的例子是:</p><ol class=""><li id="3c0d" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc md kv kw kx bi translated">用户代码继承自库中定义的类。</li></ol><figure class="lr ls lt lu fd lv"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="50f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.用户代码创建一个在库中定义的对象，并使用其方法来获得功能(它可以按原样创建，也可以由不同的对象持有。这里我展示第二个选项)。</p><figure class="lr ls lt lu fd lv"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="d806" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，在这两个选项之间进行选择取决于所需的设计。</p><p id="1f8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">(*)还有第三种选择，它不是面向OOP的。这个选项在C或标准库中更常见(仅在某些用例中)。你应该在使用它之前仔细考虑，因为它会影响你的名字空间。</p><p id="c68e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.用户代码导入包含自由函数/自由模板函数的库</p><figure class="lr ls lt lu fd lv"><div class="bz dy l di"><div class="lw lx l"/></div></figure><figure class="lr ls lt lu fd lv"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="7e23" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">代码组成</strong></p><p id="d85f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这定义了将库添加到代码中的技术方法。</p><p id="1630" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">添加库有多种方式，它们取决于您打包库的方式。</p><p id="55fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:在下面的部分中，我提到了基于Linux的操作系统的文件扩展名，基于Windows的操作系统有不同的文件扩展名。(其余的技术细节是相同的)</p><p id="993c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一般来说，存在两种主要方式:</p><ol class=""><li id="8b91" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc md kv kw kx bi translated">将库作为附加源添加到项目中(例如在“仅头文件”库中)</li><li id="cecc" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc md kv kw kx bi translated">将库作为工件添加，并与用户代码链接。(.o /。a /。所以)<br/>这个选项本身拆分成:<br/> 1。将库编译成静态库(。o，。a)，用它链接到<strong class="ih hj">在用户代码中嵌入</strong>库代码(<strong class="ih hj">会被添加到main.out二进制</strong>)。<br/> 2。将库编译成动态库(。所以)。</li></ol><p id="1ce1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">编译成动态库本身包含两个选项:</p><ol class=""><li id="7665" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc md kv kw kx bi translated">链接用户代码(。o)与。所以在<strong class="ih hj">动态联动</strong> : <br/>这个选项的意思是:<br/> -既有用户代码(main.out)又有库代码(。所以)需要复制到目标环境中。<br/> - main.out在没有。所以在环境上。</li><li id="1eb3" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc md kv kw kx bi translated">链接用户代码(。o)与。所以在<strong class="ih hj">动态插件联动上:</strong> <br/>这个选项的意思是:<br/> -既有用户代码(main.out)又有库代码(。所以)需要复制到目标环境中。<br/>-main . out文件可以运行，我们可以更改库(。so)版本<strong class="ih hj">而不重启main.out进程</strong>。(仅调用<strong class="ih hj"> `reload `功能</strong> ) <br/>该选项将要求` main.cpp `程序<strong class="ih hj">具有特殊代码(dlopen)以支持该选项</strong>。(通过添加一些特殊函数来加载库)</li></ol><p id="aa2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">选择使用这些选项中的哪一个取决于需求。第五部分(C++库-第二部分:实现)介绍了每种形式的优缺点。</p><h2 id="c521" class="ld jm hi bd jn le lf lg jr lh li lj jv iq lk ll jz iu lm ln kd iy lo lp kh lq bi translated">版本控制—库多久更新一次？</h2><p id="b240" class="pw-post-body-paragraph if ig hi ih b ii kj ik il im kk io ip iq kl is it iu km iw ix iy kn ja jb jc hb bi translated">这里你需要考虑你的用户，并相应地计划版本管理。</p><p id="344d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">他们在离线系统上工作吗？他们是保留多个版本还是只有一个版本？</p><p id="178b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要考虑的事情很少:</p><ol class=""><li id="2f8d" class="kp kq hi ih b ii ij im in iq kr iu ks iy kt jc md kv kw kx bi translated">用户群越大，就越有可能需要维护多个版本。</li><li id="b2ed" class="kp kq hi ih b ii ky im kz iq la iu lb iy lc jc md kv kw kx bi translated">根据您的用户组，您应该决定是否“允许”您的库在版本之间中断API。</li></ol><p id="dadf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如今描述图书馆版本的一种常见方式是:<a class="ae jd" href="https://semver.org/" rel="noopener ugc nofollow" target="_blank">https://semver.org/</a></p></div><div class="ab cl je jf gp jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hb hc hd he hf"><p id="44b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如您所看到的，设计一个新的库绝非易事。请记住，这只是一个预览。在实现您的库之前，建议您更深入地了解所提到的主题。在API部分，我还推荐阅读关于CPO(定制点)的内容。</p><p id="f8ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" href="https://inballevi.medium.com/c-libraries-part-ii-implementation-44dab21e50ae" rel="noopener"> C++库-第二部分:实现</a>中，我们将深入到创建、打包和链接库的技术部分。</p></div></div>    
</body>
</html>