<html>
<head>
<title>Saving Data in Room DB. From API call Retrofit Using MVVM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将数据保存在房间数据库中。使用 MVVM 从 API 调用更新</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/saving-data-in-room-db-from-api-call-retrofit-using-mvvm-e4f9806d8ffd?source=collection_archive---------1-----------------------#2021-05-29">https://medium.com/nerd-for-tech/saving-data-in-room-db-from-api-call-retrofit-using-mvvm-e4f9806d8ffd?source=collection_archive---------1-----------------------#2021-05-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/c20fc0b0489fa57e49a9c8376677b299.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/0*S3pHoTjrLMb87WVG.png"/></div></figure><p id="5b92" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">今天我将告诉你如何将数据从 API 保存到 room DB 中。这基本上称为“离线捕获”，我们从 API 获取数据，并在房间中保存和检索离线功能，我不会深入房间和所有内容，因为正如您所知</p><h1 id="9a6e" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">真理的唯一来源(SSOT)</h1><p id="e798" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">如果你想让你的应用程序离线，你应该首先遵循 SSOT 规则。那是什么？很高兴你问了。</p><p id="48e2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="kn"> SSOT 指的是这样一个概念，即某些数据只有一个官方来源供数据消费者(即人类和软件)使用，以获得该数据的真实当前版本。</em></p><p id="2362" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们应该相信一个消息来源。在这种情况下，它将是房间 DB。您的房间数据库是真实信息的唯一来源，应用程序的其他部分通过存储库访问它。</p><h1 id="83b6" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">目标</h1><blockquote class="ko kp kq"><p id="2e68" class="im in kn io b ip iq ir is it iu iv iw kr iy iz ja ks jc jd je kt jg jh ji jj hb bi translated">ViewModel 调用存储库方法，并不关心如何检索数据。</p><p id="c041" class="im in kn io b ip iq ir is it iu iv iw kr iy iz ja ks jc jd je kt jg jh ji jj hb bi translated">ViewModel 调用存储库方法，并不关心如何检索数据。</p><p id="64b9" class="im in kn io b ip iq ir is it iu iv iw kr iy iz ja ks jc jd je kt jg jh ji jj hb bi translated">存储库需要远程服务(翻新、firebase 等。)来获取新数据。</p></blockquote><figure class="kv kw kx ky fd ij er es paragraph-image"><div class="er es ku"><img src="../Images/58c4766b98ca4a425f29f0af45a84f68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/0*puabRqE-oWAhgZxe.png"/></div></figure><h1 id="a384" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">目标的待办事项</h1><ul class=""><li id="619b" class="kz la hi io b ip ki it kj ix lb jb lc jf ld jj le lf lg lh bi translated">我们将基本上做 API 的工作，并已经从使用翻新的 API 获取数据，但对于该场景，我们希望将一个屏幕数据存储到房间并检索它。</li><li id="791b" class="kz la hi io b ip li it lj ix lk jb ll jf lm jj le lf lg lh bi translated">存储库从远程获取并将其插入数据库。</li><li id="af8c" class="kz la hi io b ip li it lj ix lk jb ll jf lm jj le lf lg lh bi translated">存储库从数据库查询并将其发送到视图模型(带有成功状态)</li></ul><h1 id="8174" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">属国</h1><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="02cf" class="ls jl hi lo b fi lt lu l lv lw"><em class="kn">//Room Library<br/></em>implementation "androidx.room:room-runtime:2.2.6"<br/>implementation "androidx.room:room-ktx:2.2.6"<br/>kapt "androidx.room:room-compiler:2.2.6"<br/><em class="kn">//kotlin coroutines<br/></em>implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:1.4.1"<br/>implementation "org.jetbrains.kotlinx:kotlinx-coroutines-android:1.4.1"<br/><br/><em class="kn">//Hilt for dependency<br/></em>implementation 'com.google.dagger:hilt-android:2.31.2-alpha'<br/>implementation "androidx.hilt:hilt-lifecycle-viewmodel:1.0.0-alpha03"<br/>kapt 'com.google.dagger:hilt-compiler:2.31.2-alpha'<br/><br/><em class="kn">//Retrofit<br/></em>implementation 'com.squareup.retrofit2:retrofit:2.9.0'<br/>implementation 'com.squareup.retrofit2:converter-gson:2.9.0'<br/><br/><br/>implementation "androidx.lifecycle:lifecycle-viewmodel-ktx:2.3.1"<br/>implementation "androidx.lifecycle:lifecycle-livedata-ktx:2.3.1"<br/>implementation "androidx.lifecycle:lifecycle-common-java8:2.3.1"<br/>implementation 'androidx.lifecycle:lifecycle-extensions:2.2.0'</span></pre><h1 id="7df9" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">样品</h1><p id="2f26" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">目前，我正在做一个项目，该项目的场景是从 API 获取数据，并只将一个屏幕数据保存到房间数据库中，所以我决定为房间数据库的清晰简洁的工作编写这个。</p><p id="a873" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以基本的第一步是创建 DAO 类，你可以在网上的任何地方找到它如何创建 DAO，所以基本上，DAO 看起来像这样。\</p><p id="2195" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们将制作实体模型，它基本上被称为模型类，我们将使用我们已经制作的模型类作为房间实体，因为我们不需要制作另一个模型类</p><h1 id="f73c" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">实体(模型类)</h1><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="8a81" class="ls jl hi lo b fi lt lu l lv lw">@Entity<br/> data class GetUserRewardPointResponse (<br/>    @PrimaryKey(autoGenerate = true)<br/>    val Id:Int,<br/>     val ClientInformationId:String?,<br/>     val CardNumber:String?,<br/>     val IssueDate:String?,<br/>     val ExpiryDate:String?,<br/>     val MembershipType:String?,<br/>     val BalancePoint:String?,<br/>     val RewardPointsRate:String?,<br/>     val BalancePointamount:String?,<br/><br/>         )</span></pre><h1 id="322b" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">道与服务</h1><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="534d" class="ls jl hi lo b fi lt lu l lv lw">@Dao<br/>interface AppDao {<br/><br/>    @Insert(onConflict = OnConflictStrategy.<em class="kn">IGNORE</em>)<br/>    fun insertItems(getUserRewardPointResponse: GetUserRewardPointResponse)<br/><br/>    @Query("SELECT * FROM GetUserRewardPointResponse")<br/>    fun getAllDataSet(): LiveData&lt;List&lt;GetUserRewardPointResponse&gt;&gt;<br/><br/>}</span></pre><p id="a5aa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后第二步是创建一个类，称之为应用程序数据库，你也可以在网上任何地方找到它，因为它很常见，但为了简洁明了，我再次提到这些步骤</p><p id="3c26" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以，第二步</p><h1 id="ef1a" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">应用程序数据库</h1><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="2eaa" class="ls jl hi lo b fi lt lu l lv lw">@Database(entities = [GetUserRewardPointResponse::class], version = 1, exportSchema = false)<br/>abstract class AppDatabase : RoomDatabase(){<br/><br/>    abstract fun appDao(): AppDao<br/>}<br/><br/>private lateinit var <em class="kn">INSTANCE </em>: AppDatabase<br/><br/>fun getDatabase(context: Context): AppDatabase {<br/><br/>    <em class="kn">synchronized</em>(AppDatabase::class.<em class="kn">java</em>) <strong class="lo hj">{<br/>        </strong>if (!::<em class="kn">INSTANCE</em>.<em class="kn">isInitialized</em>) {<br/>            <em class="kn">INSTANCE </em>= Room.databaseBuilder(<br/>                context.<em class="kn">applicationContext</em>,<br/>                AppDatabase::class.<em class="kn">java</em>,<br/>                "database"<br/>            ).build()<br/>        }<br/>    <strong class="lo hj">}<br/><br/>    </strong>return <em class="kn">INSTANCE<br/></em>}</span></pre><p id="25d6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后在我们的视图模型中，因为我使用了 MVVM，所以在视图模型中，我会调用 API，看起来就像这样。</p><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="b5ae" class="ls jl hi lo b fi lt lu l lv lw">fun insertData(model: GetUserRewardPointResponse){<br/>    GlobalScope.<em class="kn">launch </em><strong class="lo hj">{<br/>        </strong><em class="kn">getDatabase</em>(MainApplication.context).appDao().insertItems(model)<br/>    <strong class="lo hj">}<br/></strong>}</span></pre><p id="68f3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后在我们的片段中，我们通过改进调用 API，这给了我们两个方法，成功时返回，失败时返回。</p><p id="d45d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们已经从 API 中获取并设置了数据，所以为了再次将它插入到 room DB 中，我们将这样做。</p><h1 id="8f0d" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">将数据插入 Room-DB</h1><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="8019" class="ls jl hi lo b fi lt lu l lv lw">when (<strong class="lo hj">it</strong>.status) {<br/>    Resource.Status.<em class="kn">LOADING </em>-&gt; {<br/>        loadingDialog.show()<br/>    }<br/>    Resource.Status.<em class="kn">SUCCESS </em>-&gt; {<br/>        <strong class="lo hj">it</strong>?.<em class="kn">let </em><strong class="lo hj">{ </strong>data <strong class="lo hj">-&gt;<br/>            </strong>loadingDialog.dismiss()<br/>            data.data?.<em class="kn">let </em><strong class="lo hj">{<br/>                </strong>if (<strong class="lo hj">it </strong>!= null) {<br/>                    mViewModel.insertData(<br/>                        GetUserRewardPointResponse(<br/>                            0,<br/>                            <strong class="lo hj">it</strong>[0].BalancePoint,<br/>                            <strong class="lo hj">it</strong>[0].CardNumber,<br/>                            <strong class="lo hj">it</strong>[0].IssueDate,<br/>                            <strong class="lo hj">it</strong>[0].ExpiryDate,<br/>                            <strong class="lo hj">it</strong>[0].MembershipType,<br/>                            <strong class="lo hj">it</strong>[0].BalancePoint,<br/>                            <strong class="lo hj">it</strong>[0].RewardPointsRate,<br/>                            <strong class="lo hj">it</strong>[0].BalancePointamount<br/>                        )<br/>                    )<br/>                    setData(<strong class="lo hj">it</strong>[0])<br/><br/>                }<br/>            <strong class="lo hj">}<br/><br/>        }<br/><br/>    </strong>}</span></pre><p id="1565" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最后，为了检索和提供数据，我们已经知道了，因为我不会深入讨论，所以我们知道我们必须触发 Room DB 的 observer，所以在这里，我必须将它调用到 on-CreatedView 中，因为它将在创建片段视图时运行！！</p><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="2016" class="ls jl hi lo b fi lt lu l lv lw"><em class="kn">//Room db Observer//<br/></em>mViewModel.allItems.observe(<em class="kn">viewLifecycleOwner</em>, <em class="kn">Observer </em><strong class="lo hj">{<br/>    it</strong>.<em class="kn">let </em><strong class="lo hj">{<br/>        </strong>if (<strong class="lo hj">it</strong>.<em class="kn">isNotEmpty</em>()) {<br/>            try {<br/>                setData(<strong class="lo hj">it</strong>[0])<br/>            } catch (e: Exception) {<br/><br/>            }<br/><br/>        }<br/>    <strong class="lo hj">}<br/>}</strong>)<br/></span></pre><h1 id="0787" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">从 Room-DB 中删除数据</h1><p id="fb04" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">我们还将了解如何从房间数据库中完全删除数据，因为当用户注销时，注销 Api 成功回调，我们将从表中完全删除用户的详细信息，因此当用户下次登录时，将再次生成用户表并将数据保存到其中。</p><p id="d439" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">“我们也将在 MVVM 这样做”</p><p id="eded" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">步骤 1 与我们将数据插入房间的方式相同</p><p id="ba47" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以在 DAO 类中，我们将这样做</p><p id="22d4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">第一步:</p><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="cf38" class="ls jl hi lo b fi lt lu l lv lw">@Query("DELETE FROM GetUserRewardPointResponse")<br/>fun deleteAll()</span></pre><p id="8b39" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">第二步:</p><p id="b42c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在我们的片段视图模型中，我们将做同样的事情，比如插入，如下所示。</p><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="acfa" class="ls jl hi lo b fi lt lu l lv lw">fun deleteData(model: GetUserRewardPointResponse){<br/>    GlobalScope.<em class="kn">launch </em><strong class="lo hj">{<br/>        </strong><em class="kn">getDatabase</em>(MainApplication.context).appDao().deleteAll()<br/>    <strong class="lo hj">}</strong></span></pre><p id="aaae" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">第三步:</p><p id="dfc7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们现在将在 api 的成功回调中调用我们的 ViewModel，因为它注销了用户，所以它也将在注销时删除用户表，</p><pre class="kv kw kx ky fd ln lo lp lq aw lr bi"><span id="e5b8" class="ls jl hi lo b fi lt lu l lv lw">Resource.Status.<em class="kn">SUCCESS </em>-&gt; {<br/>    loadingDialog.dismiss()<br/>    mViewModel.deleteData(getUserRewardPointResponse)<br/>    navigateToLoginScreen()<br/>}</span></pre><h1 id="2e0b" class="jk jl hi bd jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh bi translated">摘要</h1><p id="35cd" class="pw-post-body-paragraph im in hi io b ip ki ir is it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj hb bi translated">我不想完全解释这个房间。也许下一篇博文会是关于这个的。但在这篇博文中，我想向你展示如何组合你的房间，让你的应用离线。我对 RxJava 2 并不高深。我是说，如果你有什么建议的话，能收到你的来信真是太好了。</p><p id="bc62" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">请欣赏它，因为这是我的第一个媒体故事，所以我可以在未来写更多！也</p><p id="2478" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">快乐编码。</p></div></div>    
</body>
</html>