<html>
<head>
<title>Transaction in PostgreSQL | ROLLBACK | SAVEPOINT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">PostgreSQL 中的事务|回滚|保存点</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/transaction-in-postgresql-rollback-savepoint-23987dc6c533?source=collection_archive---------7-----------------------#2021-06-27">https://medium.com/nerd-for-tech/transaction-in-postgresql-rollback-savepoint-23987dc6c533?source=collection_archive---------7-----------------------#2021-06-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3fba80caacc4b4b073885a5da09066dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xpF9OjNrZfuXUTUWQ54ycA.jpeg"/></div></div></figure><p id="9f13" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">事务被定义为可以包含多个操作的单个任务单元。只有当事务的所有操作都正确执行时，它才标记为完成。当它的任何操作在任一点失败时，它会回滚。</p><p id="f20d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">事务必须具有原子性、一致性、持久性和隔离性，这些通常被称为 ACID 属性。</p><p id="a7c3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo">原子性:</em> </strong>事务是任务的单个单元。要么完全执行，要么不执行。无意味着它不能处于部分执行状态。</p><p id="9624" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo">一致性:</em> </strong>保证交易后的数据变化处于有效状态并遵循定义的规则。</p><p id="b9ec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo">持久性:</em> </strong>表示交易完成后的数据变化，即使系统出现故障，也是持久的。</p><p id="ea86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo">隔离:</em> </strong>一项交易应与其他交易隔离进行。其他正在执行的事务不应影响它。</p><p id="2b1e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">PostgreSQL 中的事务语法是</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="6c30" class="jy jz hi ju b fi ka kb l kc kd">[ BEGIN TRANSACTION | BEGIN ]<br/> defined operations <br/>[ COMMIT TRANSACTION | COMMIT ]</span></pre><p id="f9a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要启动一个事务，您可以使用<code class="du ke kf kg ju b">BEGIN TRANSACTION</code>或仅使用<code class="du ke kf kg ju b">BEGIN</code>，要提交事务，您可以使用<code class="du ke kf kg ju b">COMMIT TRANSACTION</code>或<code class="du ke kf kg ju b">COMMIT</code>。</p><p id="9f35" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们假设两个用户(<code class="du ke kf kg ju b">David and John</code>)正在玩手机游戏，并且<code class="du ke kf kg ju b">David</code>赢得了游戏。现在<code class="du ke kf kg ju b">John</code>宝石会转移到<code class="du ke kf kg ju b">David</code>。我们来看看宝石将如何通过交易进行转让。</p><p id="4720" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在数据库中创建一个用户表，</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="bef3" class="jy jz hi ju b fi ka kb l kc kd">DROP TABLE IF EXISTS users;</span><span id="5c67" class="jy jz hi ju b fi kh kb l kc kd">CREATE TABLE users(<br/> id INT GENERATED BY DEFAULT AS IDENTITY,<br/> name VARCHAR(50),<br/> gems DEC (10),<br/> PRIMARY KEY (id));</span></pre><p id="80cc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用默认数量的宝石填充用户表，</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="da86" class="jy jz hi ju b fi ka kb l kc kd">INSERT INTO users (name, gems) VALUES ('David', 1000);<!-- --> <br/>INSERT INTO users (name, gems) VALUES ('John', 1000);<!-- --> </span></pre><p id="e95b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转让 gems 交易将被写为</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="8440" class="jy jz hi ju b fi ka kb l kc kd">BEGIN;</span><span id="cfc5" class="jy jz hi ju b fi kh kb l kc kd">UPDATE users <br/>SET gems = gems — 100<br/>WHERE id=2;</span><span id="ae4a" class="jy jz hi ju b fi kh kb l kc kd">UPDATE users <br/>SET gems = gems+100<br/>WHERE id=1;</span><span id="489d" class="jy jz hi ju b fi kh kb l kc kd">COMMIT;</span></pre><p id="39b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，要获得更新的记录，只需编写 SELECT 语句，您将看到 David 拥有 1100 颗宝石，John 拥有 900 颗宝石。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="5e26" class="jy jz hi ju b fi ka kb l kc kd">SELECT * FROM users;</span></pre><p id="390d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">若要撤消事务所做的更改，请使用以下方法之一:</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="13aa" class="jy jz hi ju b fi ka kb l kc kd">[ ROLLBACK TRANSACTION | ROLLBACK ];</span></pre><p id="6559" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们在下面的查询中回滚一个事务，</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="5870" class="jy jz hi ju b fi ka kb l kc kd">BEGIN;</span><span id="4478" class="jy jz hi ju b fi kh kb l kc kd">UPDATE users <br/>SET gems = gems — 100<br/>WHERE id=2;</span><span id="fc38" class="jy jz hi ju b fi kh kb l kc kd">UPDATE users <br/>SET gems = gems+100<br/>WHERE id=1;</span><span id="2e6d" class="jy jz hi ju b fi kh kb l kc kd">ROLLBACK;</span></pre><p id="92de" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">运行上述查询后，您将不会在 users 表中看到 gems 从一个用户转移到另一个用户。回滚恢复事务所做的所有更改。</p><blockquote class="ki kj kk"><p id="2078" class="iq ir jo is b it iu iv iw ix iy iz ja kl jc jd je km jg jh ji kn jk jl jm jn hb bi translated">保存点是事务内部的特殊点，它保存以前执行的命令的状态，并为保存点之后执行的命令建立回滚。</p></blockquote><p id="1610" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">保存点是在事务内部用它的名字声明的，</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="df22" class="jy jz hi ju b fi ka kb l kc kd">SAVEPOINT savepoint_name;</span></pre><p id="c903" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要回滚到特定的保存点，请使用以下命令，</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="59fa" class="jy jz hi ju b fi ka kb l kc kd">ROLLBACK TO SAVEPOINT savepoint_name;</span></pre><p id="4d36" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们在 users 表中添加 Joe 的另一个用户，</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="ead4" class="jy jz hi ju b fi ka kb l kc kd">INSERT INTO users (name, gems) VALUES ('Joe', 1000);</span></pre><p id="c62c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在在事务中，在从 David 扣除 100 宝石之后，将标记一个保存点。实际上，大卫的宝石将转移到乔，但不小心转移到约翰。接下来，将建立到标记的保存点的回滚，之后 David 的 gems 将被转移到 Joe，最后，事务将被提交。</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="5f29" class="jy jz hi ju b fi ka kb l kc kd">BEGIN;<br/>UPDATE users <br/>SET gems = gems — 100<br/>WHERE id=1;</span><span id="c8a0" class="jy jz hi ju b fi kh kb l kc kd">SAVEPOINT point1;</span><span id="d887" class="jy jz hi ju b fi kh kb l kc kd">UPDATE users <br/>SET gems = gems+100<br/>WHERE id=2;<!-- --> </span><span id="5b4a" class="jy jz hi ju b fi kh kb l kc kd">ROLLBACK TO SAVEPOINT point1;</span><span id="cc2e" class="jy jz hi ju b fi kh kb l kc kd">UPDATE users <br/>SET gems = gems+100<br/>WHERE id=3;</span><span id="1d1d" class="jy jz hi ju b fi kh kb l kc kd">COMMIT;</span></pre><p id="376e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要在事务内部的任何阶段销毁保存点，请使用以下语句，</p><pre class="jp jq jr js fd jt ju jv jw aw jx bi"><span id="8043" class="jy jz hi ju b fi ka kb l kc kd">RELEASE SAVEPOINT savepoint_name;</span></pre><p id="d545" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Release savepoint 在当前事务的任何阶段销毁先前定义的特定保存点。当事务处于中止状态时，不可能释放保存点。如果多个保存点具有相同的名称，那么只有最近的保存点会被释放。</p></div></div>    
</body>
</html>