<html>
<head>
<title>X.509 certificate-based authorization for REST APIs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">REST APIs的X.509基于证书的授权</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/x-509-certificate-based-authorization-for-rest-apis-db05261d5a9e?source=collection_archive---------4-----------------------#2021-07-09">https://medium.com/nerd-for-tech/x-509-certificate-based-authorization-for-rest-apis-db05261d5a9e?source=collection_archive---------4-----------------------#2021-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="f18c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">利用传输层信任的简单而强大的API授权方案</em></p><p id="ac00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">X.509证书是基于相互TLS (MTLS)的身份验证的核心。从本质上讲，证书代表了客户/合作伙伴的身份，并用于认证可信方。本文将尝试描述一个API授权方案，该方案利用传输层信任，授权客户/合作伙伴访问部署在<a class="ae je" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> Amazon API Gateway上的API。</a>然而，该方案不考虑任何用户上下文。对于用户上下文相关的API授权，人们不得不求助于访问令牌之类的策略，这些策略通常携带一组作用域，基于这些作用域，可以在每个用户的基础上处理API授权。</p><p id="eb31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从较高的层面来看，该解决方案包括两个部分，第一部分包括在合作伙伴入职流程中要采取的几个步骤(最好是自动化的)。这些步骤在“<strong class="ih hj">与合作伙伴一起</strong>”一节中进行了解释。第二部分(在随后的小节中描述- ' <strong class="ih hj">配置&amp;创建运行时组件'</strong>)涉及配置和创建解决方案组件，以支持可信合作伙伴在运行时通过MTLS发出的API请求。</p></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="d9b0" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">加入合作伙伴</h1><p id="6f93" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">授权方案要求在合作伙伴入职期间执行一系列活动。一旦合作伙伴共享了公共证书，就需要提取一组特定的字段(最好使用自动化过程),并且需要为合作伙伴创建唯一的标识符。此外，API权限需要用这个唯一的标识符进行映射。</p><h2 id="0425" class="kp jn hi bd jo kq kr ks js kt ku kv jw iq kw kx ka iu ky kz ke iy la lb ki lc bi translated">证书的生成</h2><p id="12c3" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">合作伙伴可以选择生成他们自己的证书(由CA信任)或由API提供者提供的自定义证书出售门户，这可以帮助合作伙伴作为自助服务生成证书(以及私钥)。自签名证书也是一个选项，但不建议用于生产。最后，生成的证书与API网关共享。</p><h2 id="e467" class="kp jn hi bd jo kq kr ks js kt ku kv jw iq kw kx ka iu ky kz ke iy la lb ki lc bi translated">提取证书详细信息</h2><p id="ff76" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">作为合作伙伴加入过程的一部分，必须有某种方法从共享证书中提取特定的字段，以便为受信任的合作伙伴创建唯一的标识符。该策略可以简单到从证书中提取颁发者公用名(CN)、主题公用名(CN)和证书序列号。然后，可以将这些值连接起来，创建一个唯一的标识符:</p><p id="a9c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd"> &lt;签发人CN &gt; : &lt;主题CN &gt; : &lt;序号&gt; </em></p><p id="e1da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然证书字段的串联可以工作，但是最好通过使用强大的哈希算法(如SHA-256)来抽象这些值，以生成串联字符串的哈希值。这个不透明的散列值现在实际上可以唯一地标识系统内的伙伴。</p><blockquote class="ld le lf"><p id="9d74" class="if ig jd ih b ii ij ik il im in io ip lg ir is it lh iv iw ix li iz ja jb jc hb bi translated">通常，颁发者CN和证书序列号的组合是唯一的，因为证书颁发者必须确保没有两个具有相同证书颁发者CN的不同证书包含相同的序列号。然而，主题CN已经被扔进了混合，只是为了确定</p></blockquote><h2 id="f0ad" class="kp jn hi bd jo kq kr ks js kt ku kv jw iq kw kx ka iu ky kz ke iy la lb ki lc bi translated">授权合作伙伴</h2><p id="d9d0" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">为合作伙伴创建了不透明的惟一标识符后，下一步的决策是根据业务需求，合作伙伴可以访问哪些API和相应的资源/方法。这个决定然后被转换成一个映射，其中每个条目将一个合作伙伴的惟一哈希值映射到该合作伙伴可以访问的资源列表(参见图1)</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div role="button" tabindex="0" class="lp lq di lr bf ls"><div class="er es lj"><img src="../Images/b87f323cac17e47be5040f22a63c697c.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/format:webp/1*7MasEhVer2CLeKju9douiA.png"/></div></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">图1:带有API权限的特定于合作伙伴的哈希表</figcaption></figure><p id="5c80" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后，这个映射被存储在持久存储中(比如DynamoDB)。稍后，我们将看到Lambda授权器如何利用这个映射来授权合作伙伴访问API的请求。示例映射条目可能如下所示:</p><pre class="lk ll lm ln fd lz ma mb mc aw md bi"><span id="b184" class="kp jn hi ma b fi me mf l mg mh">"19637284c1506405a9ed6ba699a5dacc7bc2567cf355207397528189acea71d5":   <br/>  [{<br/>      arn: "arn:aws:execute-api:<strong class="ma hj">&lt;region-code&gt;</strong>:<strong class="ma hj">&lt;acct-id&gt;</strong>:<strong class="ma hj">&lt;api-id&gt;</strong>",<br/>      resource: "customer/*",<br/>      stage: "DEV",<br/>      method: "GET",<br/>      effect: "Allow"<br/>    },<br/>    {<br/>      arn: "arn:aws:execute-api:<strong class="ma hj">&lt;region-code&gt;</strong>:<strong class="ma hj">&lt;acct-id&gt;</strong>:<strong class="ma hj">&lt;api-id&gt;</strong>",<br/>      resource: "products*",<br/>      stage: "DEV",<br/>      method: "GET",<br/>      effect: "Allow"<br/>    }, <br/>    ...<br/>]</span></pre><blockquote class="ld le lf"><p id="7f00" class="if ig jd ih b ii ij ik il im in io ip lg ir is it lh iv iw ix li iz ja jb jc hb bi translated">上面的结构试图将生成的哈希值与携带API ARN、阶段、方法、资源和效果(允许或拒绝)的对象列表进行映射。本质上，这种结构支持授权方案的创建，其中某个合作伙伴可以访问一组特定的API资源和方法，而另一个合作伙伴可以访问另一组API资源和方法。合作伙伴之间也可能存在授权API资源的重叠</p></blockquote></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="c34d" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">运行时组件的配置和创建</h1><p id="4ba2" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">下面是该解决方案的各个组件如何协同工作以及所涉及的高级步骤的示意图:</p><figure class="lk ll lm ln fd lo er es paragraph-image"><div class="er es mi"><img src="../Images/8f954bb7ee976f1634ea5044cec1ea74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*r23nm64r3Eq_RKHlblznjA.png"/></div><figcaption class="lv lw et er es lx ly bd b be z dx translated">图2:使用Amazon API Gateway对API进行基于证书的授权</figcaption></figure><ol class=""><li id="9b42" class="mj mk hi ih b ii ij im in iq ml iu mm iy mn jc mo mp mq mr bi translated">尝试访问一组API的合作伙伴必须拥有可信客户端证书，并与AWS API网关建立MTLS连接。反过来，API网关必须配置有<em class="jd">自定义域名</em>和MTLS认证支持，并且合作伙伴证书必须事先放在<em class="jd">信任存储</em>中</li><li id="2235" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc mo mp mq mr bi translated">一旦API Gateway收到来自合作伙伴的API请求，它将通过查找基于亚马逊S3的信任存储来验证合作伙伴，并检查合作伙伴使用的证书是否可信。此时，如果证书不可信，API网关会阻止连接</li><li id="604a" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc mo mp mq mr bi translated">API网关触发与所请求的API资源/方法相关联的Lambda授权器，并传递请求对象。该对象携带客户端证书内容(以PEM格式)</li><li id="22bb" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc mo mp mq mr bi translated">Lambda authorizer从请求中的证书内容中提取细节(颁发者CN、主题CN和序列号),并使用这些从持久性存储(如DynamoDB)中查找相应的API权限。在合作伙伴加入过程中，这些权限实际上是根据提取的证书详细信息放在持久性存储中的。它们表示哪些APIs资源/方法可以被可信伙伴调用</li><li id="f60c" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc mo mp mq mr bi translated">Lambda authorizer基于检索到的API权限生成IAM策略，并响应API网关</li><li id="9c35" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc mo mp mq mr bi translated">API网关随后使用这个IAM策略来允许或拒绝可信伙伴对所请求的API资源/方法的访问。如果访问被拒绝，将发回一个HTTP 401(未授权)响应。</li><li id="f276" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc mo mp mq mr bi translated">如果允许访问，API请求将传递给后端服务，响应将传递回调用者</li></ol><blockquote class="ld le lf"><p id="f6d9" class="if ig jd ih b ii ij ik il im in io ip lg ir is it lh iv iw ix li iz ja jb jc hb bi translated">虽然本文没有讨论API密匙，但是当要求监控每个合作伙伴对API的使用时，这个问题仍然很重要。API密钥还有助于实现速率限制、节流、分配每月配额等。</p></blockquote><h2 id="9f02" class="kp jn hi bd jo kq kr ks js kt ku kv jw iq kw kx ka iu ky kz ke iy la lb ki lc bi translated">配置API网关自定义域名</h2><p id="46b9" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">创建并随后配置支持REST API MTLS认证的区域自定义域名是解决方案的重要组成部分，这一点已在以下帖子中讨论过:</p><div class="mx my ez fb mz na"><a href="https://adrin-mukherjee.medium.com/using-mutual-tls-authentication-with-aws-api-gateway-cf42f63f581" rel="noopener follow" target="_blank"><div class="nb ab dw"><div class="nc ab nd cl cj ne"><h2 class="bd hj fi z dy nf ea eb ng ed ef hh bi translated">通过Amazon API网关使用相互TLS认证</h2><div class="nh l"><h3 class="bd b fi z dy nf ea eb ng ed ef dx translated">Amazon API Gateway上的受信任客户和合作伙伴通过相互TLS获得更高的安全性</h3></div><div class="ni l"><p class="bd b fp z dy nf ea eb ng ed ef dx translated">adrin-mukherjee.medium.com</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no lt na"/></div></div></a></div><h2 id="30be" class="kp jn hi bd jo kq kr ks js kt ku kv jw iq kw kx ka iu ky kz ke iy la lb ki lc bi translated">Lambda授权器编码</h2><p id="8727" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">最后，必须创建一个“<em class="jd">请求</em>”类型的Lambda授权人。该授权人旨在执行以下任务:</p><ul class=""><li id="83ac" class="mj mk hi ih b ii ij im in iq ml iu mm iy mn jc np mp mq mr bi translated">检查请求是否有关联的客户端证书。证书的PEM内容可在'<em class="jd">event/request context/identity/client cert/clientCertPem '</em>下获得</li><li id="4a29" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc np mp mq mr bi translated">解析传入的X.509证书的内容，并提取以下字段:I<em class="jd">S用户公用名(颁发者CN) </em>，S <em class="jd">主体公用名(主体CN)</em>和C <em class="jd">证书序列号</em></li><li id="6657" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc np mp mq mr bi translated">使用“<strong class="ih hj">提取证书细节</strong>部分中的串联技术创建一个唯一的合作伙伴标识符:<em class="jd"> &lt;发布者CN &gt; : &lt;主题CN &gt; : &lt;证书序列号&gt; </em></li><li id="9e11" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc np mp mq mr bi translated">使用在“<strong class="ih hj">提取证书详细信息</strong>”部分(SHA-256)中使用的相同散列算法来生成合作伙伴标识符的散列值</li><li id="ce21" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc np mp mq mr bi translated">在持久性存储(在“<strong class="ih hj">授权合作伙伴”</strong>一节中描述)中查找这个散列值，该持久性存储包含为每个可信合作伙伴生成的这些散列值与相应的授权API和资源的映射</li><li id="c8a3" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc np mp mq mr bi translated">基于检索到的授权API列表和相应的资源/方法生成IAM策略，并将其返回给API Gateway。API网关读取这个IAM策略，并决定是否允许访问所请求的API资源</li></ul><p id="aefb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看下面的GitHub存储库，获取基于X.509证书的Lambda授权器的示例实现:</p><p id="4846" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae je" href="https://github.com/adrin-mukherjee/x509_lambda_authorizer" rel="noopener ugc nofollow" target="_blank">https://github.com/adrin-mukherjee/x509_lambda_authorizer</a></p><p id="391e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例授权器从亚马逊S3加载一个文件，该文件包含JSON格式的所有API权限映射，以保持简单。然而，在实践中，持久性存储将是存储这些动态映射的理想选择，作为合作伙伴加入流程的一部分。</p><blockquote class="ld le lf"><p id="cf40" class="if ig jd ih b ii ij ik il im in io ip lg ir is it lh iv iw ix li iz ja jb jc hb bi translated">Lambda函数必须部署适当的执行角色，以允许它访问像S3或DynamoDB这样的持久性存储</p></blockquote><p id="e892" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，这个Lambda授权器必须与需要保护的相关API的方法相关联<em class="jd">。</em></p><h1 id="4f86" class="jm jn hi bd jo jp nq jr js jt nr jv jw jx ns jz ka kb nt kd ke kf nu kh ki kj bi translated">关于证书轮换的一个注记</h1><p id="1035" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">当合作伙伴的证书被轮换时，需要做三件事:</p><ul class=""><li id="7589" class="mj mk hi ih b ii ij im in iq ml iu mm iy mn jc np mp mq mr bi translated">从新证书中提取详细信息并随后生成哈希值</li><li id="b936" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc np mp mq mr bi translated">使用新证书更新API网关信任存储</li><li id="d0f2" class="mj mk hi ih b ii ms im mt iq mu iu mv iy mw jc np mp mq mr bi translated">最后，根据合作伙伴的API权限更新持久性存储中的哈希值。</li></ul></div><div class="ab cl jf jg gp jh" role="separator"><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk jl"/><span class="ji bw bk jj jk"/></div><div class="hb hc hd he hf"><h1 id="64e6" class="jm jn hi bd jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj bi translated">结束语</h1><p id="17f9" class="pw-post-body-paragraph if ig hi ih b ii kk ik il im kl io ip iq km is it iu kn iw ix iy ko ja jb jc hb bi translated">本帖中描述的API授权方案值得在采用前仔细考虑。根据应用程序生态系统、安全要求、合规性和其他因素，这种策略可能会有很大的不同。该方案利用了应用层中的传输层属性，这在某些情况下可能不是最佳选择。此外，就授权的粒度而言，该策略没有考虑个体用户上下文。然而，它仍然提供了一个相对容易的选项来实现安全的API授权解决方案。</p><p id="4c0b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd"> NB </em> </strong> <em class="jd">:这篇文章部分是我和我的朋友</em><a class="nv nw ge" href="https://medium.com/u/6299fff095fd?source=post_page-----db05261d5a9e--------------------------------" rel="noopener" target="_blank"><em class="jd">ari JIT Mazumdar</em></a>进行了一些诚恳而健康的辩论的结果</p></div></div>    
</body>
</html>