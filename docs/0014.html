<html>
<head>
<title>Laravel Eloquent Approval</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">拉勒维尔雄辩的赞同</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/laravel-eloquent-approval-498a414cc305?source=collection_archive---------0-----------------------#2018-12-27">https://medium.com/nerd-for-tech/laravel-eloquent-approval-498a414cc305?source=collection_archive---------0-----------------------#2018-12-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1d46df3814325a5c7ef9abac7ae4af1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1VVrgH50xfG6U0GSpTUteg.png"/></div></div></figure><p id="ad65" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这就是我们如何构建 laravel 雄辩认证包的故事。让我介绍一下这个故事的背景，并解释一下这个 laravel 包是如何构建的。</p><p id="30e1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我是一名 Laravel/PHP 开发人员，在 Traknpay 工作。在我们的团队中，我们创建了一个商家门户，商家可以在其中阅读报告、跟踪日常交易和查看结算细节。在这个门户中，我们使用基于角色的登录，每个用户被赋予不同的角色，这将由组织的根商家提供。有点类似于 AWS IAM，但没有那么复杂。</p><p id="1f4d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">其中一个需求是创建 maker-checker，其中属于特定组织的角色为“执行”的用户将进行一些更改，而同一组织中角色为“经理”的另一个用户将批准或拒绝这些更改。如果更改被批准，那么只有数据应该被持久化到数据库中，否则不应该。</p><p id="3807" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们想到的一个解决方案是在每个数据库表中有一列，比如“is_approved ”,并从“is_approved”设置为“yes”的表中选取数据。但是这个解决方案会对我们现有的应用程序产生巨大的影响。我们不知道哪里和所有的代码可以打破系统，并作出这些改变是繁琐的。</p><p id="ac5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，我们想让我们有一个单一的表，并将保存模型以待批准。为了做到这一点，在谷歌搜索了一个小时并查看了不同的解决方案后，我们想到了创建自己的审批包。</p><p id="09a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这催生了<a class="ae jo" href="https://github.com/TraknPay/laravel-eloquent-approval" rel="noopener ugc nofollow" target="_blank">拉勒维尔振振有词的赞许</a>。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jp"><img src="../Images/9003a271dd03245850d15acf6fa8d6e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qUdwifPOyihuqABxZsXTew.png"/></div></div></figure><p id="697a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它是如何工作的，这个包有一个称为<strong class="is hj">批准特征</strong>的特征，它应该被用在你想要有创建者-检查者/批准功能的模型中。这个<strong class="is hj">批准特征</strong>有一个静态内置函数'<strong class="is hj"> isApprover() </strong>'，默认情况下返回 true。</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="f83f" class="jz ka hi jv b fi kb kc l kd ke">    /**  <br/>     * check whether user has permission to approve<br/>     * <br/>     * @return bool  <br/>     */<br/>    public static function isApprover(): bool<br/>    {<br/>          return true;<br/>    }</span></pre><p id="5640" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们可以在使用这个特征的模型中覆盖上面的方法，并在'<strong class="is hj"> isApprover() </strong>'方法中编写我们自己的定制逻辑。下面是覆盖'<strong class="is hj"> isApprover() </strong>'方法的示例代码。</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="387b" class="jz ka hi jv b fi kb kc l kd ke"><strong class="jv hj">namespace </strong>App;<br/><br/><strong class="jv hj">use </strong>Illuminate\Database\Eloquent\Model;<br/><strong class="jv hj">use </strong>Laratrust;<br/><strong class="jv hj">use </strong>TraknPay\EloquentApproval\ApprovalTrait;</span><span id="69ef" class="jz ka hi jv b fi kf kc l kd ke"><em class="kg">/**<br/> * Class Post<br/> */<br/></em><strong class="jv hj">class Post extends </strong>Model {</span><span id="a335" class="jz ka hi jv b fi kf kc l kd ke"><em class="kg">/**<br/> * check whether the user has permission to approve<br/> *<br/> * </em><strong class="jv hj"><em class="kg">@return </em></strong><em class="kg">bool<br/> */<br/></em><strong class="jv hj">public static function </strong>isApprover(): bool<br/>{<br/>   <strong class="jv hj">return </strong>Laratrust::<em class="kg">can</em>(<strong class="jv hj">'merchanttdr-approve'</strong>);<br/>}</span><span id="eeaf" class="jz ka hi jv b fi kf kc l kd ke">}</span></pre><p id="c742" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，该包附带有自己的'<strong class="is hj">批准</strong>'表。如果方法'<strong class="is hj"> isApprover() </strong>'返回 false，那么数据将存储在<strong class="is hj"> approvals </strong>表中，而不是在模型中提到的用于批准的表中。</p><p id="a746" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">创建/更新模型被序列化，并与批准所需的元数据一起存储在批准表中</strong>。</p><p id="f916" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在最大的问题是如何批准数据并将内容保存到实际的数据库表中。嗯，我们围绕 approvals 表构建了一个 UI，如下所示。您可以根据自己的目的使用<strong class="is hj"> approvals </strong>表构建自己的 UI。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kh"><img src="../Images/0c77fa0fdc1d3a9d3795f70c1083309e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jfrR4zyXQh_Q_0GBObPuqA.jpeg"/></div></div><figcaption class="ki kj et er es kk kl bd b be z dx translated">审批管理界面</figcaption></figure><p id="e04d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">批准表存储型号名称和序列化值。一旦用户批准了模型，我们就对数据进行解序列化，以创建相应的模型并保存它。</p><pre class="jq jr js jt fd ju jv jw jx aw jy bi"><span id="913e" class="jz ka hi jv b fi kb kc l kd ke">$model = unserialize($approval-&gt;values); <br/>$model-&gt;save();</span></pre><p id="691c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">找到了。！！。</p><p id="ebb4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个软件包帮助我们完成了我们的商家门户网站的制造商检查功能。在它变得有用之后，我们将这个包发布给<a class="ae jo" href="https://packagist.org/" rel="noopener ugc nofollow" target="_blank">的包装商</a>，这样其他人也能从中受益。</p><p id="2ddb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是这个包的链接(【https://github.com/TraknPay/laravel-eloquent-approval】T4)，如果你觉得这个包有帮助，请在评论区告诉我。</p><p id="7b67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kg">谢谢，编码快乐！。</em></p></div></div>    
</body>
</html>