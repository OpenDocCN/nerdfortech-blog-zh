<html>
<head>
<title>EKS Networking — CNI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EKS网络— CNI</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/eks-networking-cni-457ae298b9e6?source=collection_archive---------0-----------------------#2021-03-25">https://medium.com/nerd-for-tech/eks-networking-cni-457ae298b9e6?source=collection_archive---------0-----------------------#2021-03-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/f989e50736e0f4fd80e8d0e9f3b4ffeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TMmXOsONlobetDF4L-j5gA.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated"><a class="ae hv" href="https://unsplash.com/@dennyisrael?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">丹尼·布</a>在<a class="ae hv" href="https://unsplash.com/s/photos/network?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</figcaption></figure><div class=""/><p id="d5f8" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">AWS EKS提供托管Kubernetes服务。该服务加快了生产级K8群集所需的基础架构的部署、管理和扩展。</p><p id="61de" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上周，我们利用EKS自动气象站部署了一个天文学家集群。这是一个开发环境，因此我们从现有的开发VPC中选择子网。开始很好，但是当我们在天文学家上创建了4-5个部署后，我们开始得到错误。使用这些子网的其他开发人员也开始抱怨他们看到了错误。同时，我打开CloudTrail查看错误事件，发现如下:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="d1a9" class="kc kd hy jy b fi ke kf l kg kh">"eventSource": "ec2.amazonaws.com",<br/>"eventName": "CreateNetworkInterface",<br/>"userAgent": "aws-sdk-go/1.33.14 amazon-vpc-cni-k8s"<br/>"errorMessage": "insufficient free address to allocate 1 address"</span></pre><p id="6a5f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">看到这一点后，我查看了各个节点，发现每个节点都分配了许多辅助IP，这导致了子网中的IP耗尽。</p><figure class="jt ju jv jw fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ki"><img src="../Images/afe726cdd5525b9895054b2bda8b83f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fgSaiGJjm3xtdqiS1IdDNQ.png"/></div></div></figure><p id="5a7f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上图中，两个私有IP是创建的两个Eni的主IP。IP的总数是2+28 = 30。</p><p id="4758" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了快速释放空间，我们将EKS集群的自动扩展组中的子网更改为一个新的独立子网。并逐一终止了现有的节点，它们由ASG在新的子网中启动。问题已解决。但是为了对EKS的设置进行微调，我开始探索EKS的网络。下图描述了<a class="ae hv" href="https://github.com/aws/amazon-vpc-cni-k8s" rel="noopener ugc nofollow" target="_blank">集装箱网络接口</a>如何在VPC联网。</p><figure class="jt ju jv jw fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es kj"><img src="../Images/9ca0d756585f6bc4c4273fa5d25335ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IhHKlmxJ5umeapm7hqUIhA.png"/></div></div></figure><p id="2295" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上图中，我们看到每个EKS节点运行一个名为<code class="du kk kl km jy b">aws-node</code>的Deamonset。它负责创建ENI、分配IP以及将ENI连接到EC2。</p><blockquote class="kn"><p id="e92b" class="ko kp hy bd kq kr ks kt ku kv kw js dx translated">L-IPAM守护进程在每个节点上维护一个热IP地址池，以便在调度时分配给Kubernetes pods。</p></blockquote><p id="3280" class="pw-post-body-paragraph iv iw hy ix b iy kx ja jb jc ky je jf jg kz ji jj jk la jm jn jo lb jq jr js hb bi translated">在进一步阅读后，我发现同一个守护程序将提供一个辅助接口来满足更多的pod需求(上限为实例可以支持的最大IP和最大ENI)。例如，一个t 3.2x大型实例类型可以有4个ENI，每个ENI最多可以有15个私有IP地址。因此，在默认设置中，它将保留30个IP。15个用于主接口，15个用于辅助接口。如果我们部署16个pod，那么它将创建另一个ENI，并分配15个IP。因此，到那时，我们将保留3个ENI和45个IP。</p><p id="cad5" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">AWS CNI公开了三种配置来控制上述设置<code class="du kk kl km jy b">WARM_ENI_TARGET</code>、<code class="du kk kl km jy b">WARM_IP_TARGET</code>和<code class="du kk kl km jy b">MINIMUM_IP_TARGET</code>的行为。通过更改这些参数，我们可以调整保留IP的数量。但这将增加旋转吊舱的延迟，因为ENI的创建和连接可能需要几秒钟。此外，由于对EC2 API的调用会更频繁(用于ENI创建和附加到节点)，我们可能会看到节流。</p><p id="83f8" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是这个设置释放了IP地址，否则这个地址会被CNI插件保留。</p><h2 id="67da" class="kc kd hy bd lc ld le lf lg lh li lj lk jg ll lm ln jk lo lp lq jo lr ls lt lu bi translated">温暖_ ENI _目标</h2><blockquote class="lv lw lx"><p id="2477" class="iv iw ly ix b iy iz ja jb jc jd je jf lz jh ji jj ma jl jm jn mb jp jq jr js hb bi translated">指定守护程序应准备好的Eni数量<br/>默认值为1。</p></blockquote><p id="e53b" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过将值设置为0，意味着从一开始就没有第二ENI。因此，对于t3.2xlarge，我们在开始时将只保留15个IPs。如果我们部署第16个吊舱，那么我们将为第二个ENI预留另外15个。</p><h2 id="93eb" class="kc kd hy bd lc ld le lf lg lh li lj lk jg ll lm ln jk lo lp lq jo lr ls lt lu bi translated">WARM_IP_TARGET</h2><blockquote class="lv lw lx"><p id="5ad5" class="iv iw ly ix b iy iz ja jb jc jd je jf lz jh ji jj ma jl jm jn mb jp jq jr js hb bi translated">指定将为节点-ENI对保留的IP数量</p></blockquote><p id="644f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将此值设置为10并将WARM_ENI_TARGET设置为0将仅保留10个IPs。一旦我们达到了10个吊舱，它将从主ENI再消耗5个吊舱，并为辅助ENI提供10个预留的IPs。</p><h2 id="cd45" class="kc kd hy bd lc ld le lf lg lh li lj lk jg ll lm ln jk lo lp lq jo lr ls lt lu bi translated">最小_IP_TARGET</h2><blockquote class="lv lw lx"><p id="7db9" class="iv iw ly ix b iy iz ja jb jc jd je jf lz jh ji jj ma jl jm jn mb jp jq jr js hb bi translated">指定每个节点周围要保留的最小IPs数量。</p></blockquote><p id="a4a1" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最佳做法是对大型集群使用默认设置。将K8s集群保留在单独的VPC。对于较小且可预测的集群，我们可以将最小IP_TARGET =节点上的吊舱数+3/4，并将WARM_ENI_TARGET = 0和WARM_IP_TARGET设置为2或3。</p><p id="9a95" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于现有集群，我们可以通过首先创建一个YAML文件来更新，如下所示:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="0ca0" class="kc kd hy jy b fi ke kf l kg kh">spec:<br/>  template:<br/>    spec:<br/>      containers:<br/>        - name: aws-node<br/>          env:<br/>            - name: WARM_IP_TARGET<br/>              value: 2<br/>            - name: WARM_ENI_TARGET<br/>              value: 0<br/>            - name: MINIMUM_IP_TARGET<br/>              value: 10</span></pre><p id="93f5" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后运行以下命令:</p><pre class="jt ju jv jw fd jx jy jz ka aw kb bi"><span id="ac0e" class="kc kd hy jy b fi ke kf l kg kh">kubectl patch daemonset -n kube-system aws-node "$(cat patch.yaml)"</span></pre><p id="7605" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">谢谢，快乐学习！！</p></div></div>    
</body>
</html>