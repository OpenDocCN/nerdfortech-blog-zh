<html>
<head>
<title>Building a Vertx application with Kotlin Coroutines</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Kotlin协程构建Vertx应用程序</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/building-a-vertx-application-with-kotlin-coroutines-6c7dbb7ad893?source=collection_archive---------2-----------------------#2021-07-23">https://medium.com/nerd-for-tech/building-a-vertx-application-with-kotlin-coroutines-6c7dbb7ad893?source=collection_archive---------2-----------------------#2021-07-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cd2c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<a class="ae jd" href="https://github.com/hantsy/vertx-sandbox/blob/master/docs/kotlin.md" rel="noopener ugc nofollow" target="_blank">的最后一篇文章</a>中，我们用Kotlin语言重建了示例应用程序。除了基本的语言支持，Eclipse Vertx的Kotlin绑定还提供了Kotlin扩展来将Vertx的<code class="du je jf jg jh b">Future</code>转换为Kotlin协同例程。</p><figure class="jj jk jl jm fd jn er es paragraph-image"><div role="button" tabindex="0" class="jo jp di jq bf jr"><div class="er es ji"><img src="../Images/f956527f0ab7018d1bda236001b69711.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zi-wSXYA9KsoR2ALXGWNwg.jpeg"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated"><a class="ae jd" href="https://unsplash.com/@yuzkiwww?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Yuzki Wang </a>在<a class="ae jd" href="https://unsplash.com/s/photos/china-landscape?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="83db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">按照上一篇文章中的步骤创建一个基于Kotlin的Vertx项目，我们将使用Kotlin协程重新构建该项目。</p><p id="b101" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先让我们来看看<code class="du je jf jg jh b">PostRepository</code>。</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="2a8c" class="kc kd hi jh b fi ke kf l kg kh">class PostRepository(private val client: PgPool) {</span><span id="b4cb" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun findAll() = client.query("SELECT * FROM posts ORDER BY id ASC")<br/>        .execute()<br/>        .map { rs: RowSet&lt;Row?&gt; -&gt;<br/>            StreamSupport.stream(rs.spliterator(), false)<br/>                .map { mapFun(it!!) }<br/>                .toList()<br/>        }.await()<br/></span><span id="926a" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun findById(id: UUID): Post? = client.preparedQuery("SELECT * FROM posts WHERE id=$1")<br/>        .execute(Tuple.of(id))<br/>        .map { it.iterator() }<br/>        .map { if (it.hasNext()) mapFun(it.next()) else null }<br/>        .await()<br/></span><span id="283b" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun save(data: Post) =<br/>        client.preparedQuery("INSERT INTO posts(title, content) VALUES ($1, $2) RETURNING (id)")<br/>            .execute(Tuple.of(data.title, data.content))<br/>            .map { it.iterator().next().getUUID("id") }<br/>            .await()<br/></span><span id="e5f2" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun saveAll(data: List&lt;Post&gt;): Int? {<br/>        val tuples = data.map { Tuple.of(it.title, it.content) }</span><span id="126b" class="kc kd hi jh b fi ki kf l kg kh">        return client.preparedQuery("INSERT INTO posts (title, content) VALUES ($1, $2)")<br/>            .executeBatch(tuples)<br/>            .map { it.rowCount() }<br/>            .await()<br/>    }</span><span id="b8e2" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun update(data: Post) = client.preparedQuery("UPDATE posts SET title=$1, content=$2 WHERE id=$3")<br/>        .execute(Tuple.of(data.title, data.content, data.id))<br/>        .map { it.rowCount() }<br/>        .await()<br/></span><span id="e245" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun deleteAll() = client.query("DELETE FROM posts").execute()<br/>        .map { it.rowCount() }<br/>        .await()<br/></span><span id="aa58" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun deleteById(id: UUID) = client.preparedQuery("DELETE FROM posts WHERE id=$1").execute(Tuple.of(id))<br/>        .map { it.rowCount() }<br/>        .await()</span><span id="f414" class="kc kd hi jh b fi ki kf l kg kh">    companion object {<br/>        private val LOGGER = Logger.getLogger(PostRepository::class.java.name)<br/>        val mapFun: (Row) -&gt; Post = { row: Row -&gt;<br/>            Post(<br/>                row.getUUID("id"),<br/>                row.getString("title"),<br/>                row.getString("content"),<br/>                row.getLocalDateTime("created_at")<br/>            )<br/>        }</span><span id="8a8c" class="kc kd hi jh b fi ki kf l kg kh">    }<br/>}</span></pre><p id="6c65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如你看到的，它几乎和Kotlin版本一样，但是在每个函数的最后一行，它调用一个<code class="du je jf jg jh b">await</code>方法来返回一个<em class="kj">挂起的</em>结果。</p><p id="1a68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们转到<code class="du je jf jg jh b">PostHandlers</code>吧。</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="cf12" class="kc kd hi jh b fi ke kf l kg kh">class PostsHandler(val posts: PostRepository) {<br/>    suspend fun all(rc: RoutingContext) {<br/>//        var params = rc.queryParams();<br/>//        var q = params.get("q");<br/>//        var limit = params.get("limit") == null ? 10 : Integer.parseInt(params.get("q"));<br/>//        var offset = params.get("offset") == null ? 0 : Integer.parseInt(params.get("offset"));<br/>//        LOGGER.log(Level.INFO, " find by keyword: q={0}, limit={1}, offset={2}", new Object[]{q, limit, offset});<br/>        val data = posts.findAll()<br/>        rc.response().end(Json.encode(data)).await()<br/>    }</span><span id="823a" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun getById(rc: RoutingContext) {<br/>        val params = rc.pathParams()<br/>        val id = params["id"]<br/>        val uuid = UUID.fromString(id)<br/>        val data = posts.findById(uuid)<br/>        if (data != null) {<br/>            rc.response().end(Json.encode(data)).await()<br/>        } else {<br/>            rc.fail(404, PostNotFoundException(uuid))<br/>        }<br/>    }</span><span id="f820" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun save(rc: RoutingContext) {<br/>        //rc.getBodyAsJson().mapTo(PostForm.class)<br/>        val body = rc.bodyAsJson<br/>        LOGGER.log(Level.INFO, "request body: {0}", body)<br/>        val (title, content) = body.mapTo(CreatePostCommand::class.java)<br/>        val savedId = posts.save(Post(title = title, content = content))<br/>        rc.response()<br/>            .putHeader("Location", "/posts/$savedId")<br/>            .setStatusCode(201)<br/>            .end()<br/>            .await()</span><span id="8003" class="kc kd hi jh b fi ki kf l kg kh">    }</span><span id="1d49" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun update(rc: RoutingContext) {<br/>        val params = rc.pathParams()<br/>        val id = params["id"]<br/>        val uuid = UUID.fromString(id)<br/>        val body = rc.bodyAsJson<br/>        LOGGER.log(Level.INFO, "\npath param id: {0}\nrequest body: {1}", arrayOf(id, body))<br/>        var (title, content) = body.mapTo(CreatePostCommand::class.java)</span><span id="35c5" class="kc kd hi jh b fi ki kf l kg kh">        var existing: Post? = posts.findById(uuid)<br/>        if (existing != null) {<br/>            val data: Post = existing.apply {<br/>                title = title<br/>                content = content<br/>            }<br/>            posts.update(data)<br/>            rc.response().setStatusCode(204).end().await()<br/>        } else {<br/>            rc.fail(404, PostNotFoundException(uuid))<br/>        }<br/>    }</span><span id="fdf4" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun delete(rc: RoutingContext) {<br/>        val params = rc.pathParams()<br/>        val id = params["id"]<br/>        val uuid = UUID.fromString(id)<br/>        val existing = posts.findById(uuid)<br/>        if (existing != null) {<br/>            rc.response().setStatusCode(204).end().await()<br/>        } else {<br/>            rc.fail(404, PostNotFoundException(uuid))<br/>        }<br/>    }</span><span id="22c1" class="kc kd hi jh b fi ki kf l kg kh">    companion object {<br/>        private val LOGGER = Logger.getLogger(PostsHandler::class.java.simpleName)<br/>    }<br/>}</span></pre><p id="fb3b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的代码中，它使用顺序语句，而不是具有链式功能的<code class="du je jf jg jh b">Future</code></p><p id="e647" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Eclipse Vertx Kotlin绑定提供了一个<code class="du je jf jg jh b">CooutineVerticle</code>。</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="2ac8" class="kc kd hi jh b fi ke kf l kg kh">class MainVerticle : CoroutineVerticle() {<br/>    companion object {<br/>        private val LOGGER = Logger.getLogger(MainVerticle::class.java.name)</span><span id="8bee" class="kc kd hi jh b fi ki kf l kg kh">        /**<br/>         * Configure logging from logging.properties file.<br/>         * When using custom JUL logging properties, named it to vertx-default-jul-logging.properties<br/>         * or set java.util.logging.config.file system property to locate the properties file.<br/>         */<br/>        @Throws(IOException::class)<br/>        private fun setupLogging() {<br/>            MainVerticle::class.java.getResourceAsStream("/logging.properties")<br/>                .use { f -&gt; LogManager.getLogManager().readConfiguration(f) }<br/>        }</span><span id="d87f" class="kc kd hi jh b fi ki kf l kg kh">        init {<br/>            LOGGER.info("Customizing the built-in jackson ObjectMapper...")<br/>            val objectMapper = DatabindCodec.mapper()<br/>            objectMapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)<br/>            objectMapper.disable(SerializationFeature.WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS)<br/>            objectMapper.disable(DeserializationFeature.READ_DATE_TIMESTAMPS_AS_NANOSECONDS)<br/>            val module = JavaTimeModule()<br/>            objectMapper.registerModule(module)<br/>        }<br/>    }</span><span id="d291" class="kc kd hi jh b fi ki kf l kg kh">    override suspend fun start() {<br/>        LOGGER.log(Level.INFO, "Starting HTTP server...")<br/>        //setupLogging();</span><span id="e492" class="kc kd hi jh b fi ki kf l kg kh">        //Create a PgPool instance<br/>        val pgPool = pgPool()</span><span id="0460" class="kc kd hi jh b fi ki kf l kg kh">        //Creating PostRepository<br/>        val postRepository = PostRepository(pgPool)</span><span id="5af0" class="kc kd hi jh b fi ki kf l kg kh">        //Creating PostHandler<br/>        val postHandlers = PostsHandler(postRepository)</span><span id="aba8" class="kc kd hi jh b fi ki kf l kg kh">        // Initializing the sample data<br/>        val initializer = DataInitializer(pgPool)<br/>        initializer.run()</span><span id="b018" class="kc kd hi jh b fi ki kf l kg kh">        // Configure routes<br/>        val router = routes(postHandlers)</span><span id="d252" class="kc kd hi jh b fi ki kf l kg kh">        // Create the HTTP server<br/>        val options = httpServerOptionsOf(idleTimeout = 5, idleTimeoutUnit = TimeUnit.MINUTES, logActivity = true)<br/>        vertx.createHttpServer(options) // Handle every request using the router<br/>            .requestHandler(router) // Start listening<br/>            .listen(8888) // Print the port<br/>            .onComplete { println("HttpSever started at ${it.result().actualPort()}") }<br/>            .await()<br/>    }</span><span id="3365" class="kc kd hi jh b fi ki kf l kg kh">    override suspend fun stop() {<br/>        super.stop()<br/>    }</span><span id="a1df" class="kc kd hi jh b fi ki kf l kg kh">    //create routes<br/>    private fun routes(handlers: PostsHandler): Router {</span><span id="7817" class="kc kd hi jh b fi ki kf l kg kh">        // Create a Router<br/>        val router = Router.router(vertx)<br/>        // register BodyHandler globally.<br/>        //router.route().handler(BodyHandler.create());</span><span id="7ef0" class="kc kd hi jh b fi ki kf l kg kh">        router.get("/posts")<br/>            .produces("application/json")<br/>            .coroutineHandler {<br/>                handlers.all(it)<br/>            }</span><span id="5ff6" class="kc kd hi jh b fi ki kf l kg kh">        router.post("/posts")<br/>            .consumes("application/json")<br/>            .handler(BodyHandler.create())<br/>            .coroutineHandler {<br/>                handlers.save(it)<br/>            }</span><span id="a343" class="kc kd hi jh b fi ki kf l kg kh">        router.get("/posts/:id")<br/>            .produces("application/json")<br/>            .coroutineHandler {<br/>                handlers.getById(it)<br/>            }<br/></span><span id="81bf" class="kc kd hi jh b fi ki kf l kg kh">        router.put("/posts/:id")<br/>            .consumes("application/json")<br/>            .handler(BodyHandler.create())<br/>            .coroutineHandler {<br/>                handlers.update(it)<br/>            }</span><span id="f418" class="kc kd hi jh b fi ki kf l kg kh">        router.delete("/posts/:id")<br/>            .coroutineHandler {<br/>                handlers.delete(it)<br/>            }</span><span id="3b66" class="kc kd hi jh b fi ki kf l kg kh">        router.route().failureHandler {<br/>            if (it.failure() is PostNotFoundException) {<br/>                it.response()<br/>                    .setStatusCode(404)<br/>                    .end(<br/>                        json {// an example using JSON DSL<br/>                            obj(<br/>                                "message" to "${it.failure().message}",<br/>                                "code" to "not_found"<br/>                            )<br/>                        }.toString()<br/>                    )<br/>            }<br/>        }</span><span id="84cf" class="kc kd hi jh b fi ki kf l kg kh">        router.get("/hello").handler { it.response().end("Hello from my route") }</span><span id="3a94" class="kc kd hi jh b fi ki kf l kg kh">        return router<br/>    }</span><span id="5059" class="kc kd hi jh b fi ki kf l kg kh">    private fun pgPool(): PgPool {<br/>        val connectOptions = PgConnectOptions()<br/>            .setPort(5432)<br/>            .setHost("localhost")<br/>            .setDatabase("blogdb")<br/>            .setUser("user")<br/>            .setPassword("password")</span><span id="6ddb" class="kc kd hi jh b fi ki kf l kg kh">        // Pool Options<br/>        val poolOptions = PoolOptions().setMaxSize(5)</span><span id="db24" class="kc kd hi jh b fi ki kf l kg kh">        // Create the pool from the data object<br/>        return PgPool.pool(vertx, connectOptions, poolOptions)<br/>    }</span><span id="dfd8" class="kc kd hi jh b fi ki kf l kg kh">    private fun Route.coroutineHandler(fn: suspend (RoutingContext) -&gt; Unit) = handler {<br/>        launch(it.vertx().dispatcher()) {<br/>            try {<br/>                fn(it)<br/>            } catch (e: Exception) {<br/>                it.fail(e)<br/>            }<br/>        }<br/>    }</span><span id="6477" class="kc kd hi jh b fi ki kf l kg kh">}</span></pre><p id="816c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">目前，Kotlin bindings不提供处理程序方法来接受基于协程的<code class="du je jf jg jh b">RequestHandler</code>。我们创建了<code class="du je jf jg jh b">coroutineHandler</code>扩展方法来暂时克服这个问题，参见问题<a class="ae jd" href="https://github.com/vert-x3/vertx-lang-kotlin/issues/194" rel="noopener ugc nofollow" target="_blank">vert-x3/vertx-lang-kot Lin # 194</a>。</p><p id="4838" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们将<code class="du je jf jg jh b">DataIntializer</code>转换成使用Kotlin协程。</p><pre class="jj jk jl jm fd jy jh jz ka aw kb bi"><span id="110b" class="kc kd hi jh b fi ke kf l kg kh">class DataInitializer(private val client: PgPool) {</span><span id="b620" class="kc kd hi jh b fi ki kf l kg kh">    suspend fun run() {<br/>        LOGGER.info("Data initialization is starting...")<br/>        val first = Tuple.of("Hello Quarkus", "My first post of Quarkus")<br/>        val second = Tuple.of("Hello Again, Quarkus", "My second post of Quarkus")<br/></span><span id="7dec" class="kc kd hi jh b fi ki kf l kg kh">        val result = client<br/>            .withTransaction { conn: SqlConnection -&gt;<br/>                conn.query("DELETE FROM posts")<br/>                    .execute()<br/>                    .flatMap {<br/>                        conn.preparedQuery("INSERT INTO posts (title, content) VALUES ($1, $2)")<br/>                            .executeBatch(listOf(first, second))<br/>                    }<br/>                    .flatMap {<br/>                        conn.query("SELECT * FROM posts")<br/>                            .execute()<br/>                    }</span><span id="57f3" class="kc kd hi jh b fi ki kf l kg kh">            }.await()</span><span id="38bf" class="kc kd hi jh b fi ki kf l kg kh">        result.forEach { println(it.toJson()) }<br/>        LOGGER.info("Data initialization is done...")<br/>    }</span><span id="837f" class="kc kd hi jh b fi ki kf l kg kh">    companion object {<br/>        private val LOGGER = Logger.getLogger(DataInitializer::class.java.name)<br/>    }<br/>}</span></pre><p id="8669" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从我的Github获取示例代码。</p></div></div>    
</body>
</html>