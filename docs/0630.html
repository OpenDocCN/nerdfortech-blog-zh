<html>
<head>
<title>Building Spring Boot Microservices , Monitoring with prometheus and grafana and log aggregation using ELK stack: Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建Spring Boot微服务，使用prometheus和grafana进行监控，使用ELK stack进行日志聚合:第二部分</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/building-spring-boot-microservices-monitoring-with-prometheus-and-grafana-and-log-aggregation-5ed9ca7dda36?source=collection_archive---------0-----------------------#2021-01-30">https://medium.com/nerd-for-tech/building-spring-boot-microservices-monitoring-with-prometheus-and-grafana-and-log-aggregation-5ed9ca7dda36?source=collection_archive---------0-----------------------#2021-01-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/5a03a92d033b4d55aac4ea5621190870.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/1*dzODOIDqXTsWauf5eM8Trw.gif"/></div></figure><p id="1a9f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae jk" rel="noopener" href="/nerd-for-tech/creating-spring-boot-microservices-monitoring-with-prometheus-and-grafana-and-log-aggregation-ba4f20496942">在第一部分</a>中，我们学习了如何通过创建3个微服务(产品-微服务、订单-微服务、客户端-微服务)来构建spring boot微服务。</p><p id="9bc3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">到目前为止，一切看起来都很好，但是在使用如此复杂的架构时，我们需要密切关注我们的系统，以防任何潜在的故障。</p><p id="9aec" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为此，在这一部分中，我们将了解如何使用prometheus和grafana来监控、跟踪和观察我们的微服务的行为。</p><h2 id="57c6" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">普罗米修斯是什么？</h2><p id="d213" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">Prometheus是一个开源的时间序列数据库，最初由SoundCloud开发。它自带适当的查询语言PromQL，用于事件监控和警报。</p><h2 id="188a" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">为Spring Boot微服务添加微米普罗米修斯注册表</h2><p id="2f50" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">Spring boot使用<a class="ae jk" href="https://micrometer.io/" rel="noopener ugc nofollow" target="_blank">千分尺</a>一个应用度量门面来集成执行器度量和外部监控系统。</p><p id="d2ae" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">它支持多种监控系统，如SignalFx、Graphite、Wavefront、Prometheus …</p><p id="c07f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要将actuator与Prometheus集成，您需要为每个微服务添加以下依赖项:</p><pre class="kl km kn ko fd kp kq kr ks aw kt bi"><span id="e4c3" class="jl jm hi kq b fi ku kv l kw kx">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;<br/>    &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;<br/>&lt;/dependency&gt;</span></pre><p id="6f23" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">和以下属性:</p><pre class="kl km kn ko fd kp kq kr ks aw kt bi"><span id="5786" class="jl jm hi kq b fi ku kv l kw kx">management.endpoint.metrics.enabled=<strong class="kq hj">true<br/></strong>management.endpoints.web.exposure.include=*<br/>management.endpoint.prometheus.enabled=<strong class="kq hj">true<br/></strong>management.metrics.export.prometheus.enabled=<strong class="kq hj">true</strong></span></pre><p id="f11c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦您添加了上述依赖项，Spring Boot将自动配置一个<code class="du ky kz la kq b"><a class="ae jk" href="https://github.com/micrometer-metrics/micrometer/blob/master/implementations/micrometer-registry-prometheus/src/main/java/io/micrometer/prometheus/PrometheusMeterRegistry.java" rel="noopener ugc nofollow" target="_blank">PrometheusMeterRegistry</a></code>来收集和导出metrics数据，其格式可以被Prometheus服务器抓取。</p><p id="424a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要探索prometheus endpoint，请访问<a class="ae jk" href="http://localhost:9001/actuator" rel="noopener ugc nofollow" target="_blank"/></p><p id="0e10" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">例如，我们将致力于产品微服务。</p><figure class="kl km kn ko fd ij er es paragraph-image"><div class="er es lb"><img src="../Images/ceab806b8f749df533c12bd418cd9bd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*qr4TROccZI7vveAU_MtbIA.png"/></div><figcaption class="lc ld et er es le lf bd b be z dx translated">执行机构</figcaption></figure><p id="29f2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如我们所见，actuator公开了许多端点，我们只关注prometheus端点。</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lg"><img src="../Images/df674337079005a89a2af64304a74de0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*05g-cpHKtpYhsGOAu5VJ6A.png"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">普罗米修斯终点</figcaption></figure><h2 id="73ec" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">下载并安装普罗米修斯</h2><p id="f94e" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">普罗米修斯是一个docker图片，如果你没有docker，你可以从https://prometheus.io/download/这里下载。</p><p id="3999" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们不会与docker合作，因为不是每个人都熟悉它。</p><p id="84f6" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">安装prometheus(有或没有docker)后，我们必须创建prometheus.yml文件来配置prometheus从Spring Boot执行器的<code class="du ky kz la kq b">/prometheus</code>端点收集度量数据。</p><p id="61dd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">配置应该如下所示:</p><pre class="kl km kn ko fd kp kq kr ks aw kt bi"><span id="55a4" class="jl jm hi kq b fi ku kv l kw kx">scrape_configs:<br/>  - job_name: 'microservice-product'<br/>    scrape_interval: 2s<br/>    metrics_path: '/actuator/prometheus' ##prometheus endpoint<br/>    static_configs:<br/>      - targets: ['localhost:9001'] ## host and port for your mis<br/>  - job_name: 'microservice-order'<br/>    scrape_interval: 2s<br/>    metrics_path: '/actuator/prometheus'<br/>    static_configs:<br/>      - targets: ['localhost:9002']<br/>  - job_name: 'microservice-client'<br/>    scrape_interval: 2s<br/>    metrics_path: '/actuator/prometheus'<br/>    static_configs:<br/>      - targets: ['localhost:8080']</span></pre><h2 id="36cc" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">运行普罗米修斯</h2><p id="99e5" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">在prometheus文件夹中打开终端，运行以下命令:&gt;</p><pre class="kl km kn ko fd kp kq kr ks aw kt bi"><span id="e5a5" class="jl jm hi kq b fi ku kv l kw kx">prometheus.exe --config.file &lt;PATH TO YOUR PROMETHEUS.YML&gt;</span></pre><p id="681f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">导航到<a class="ae jk" href="http://localhost:9090" rel="noopener ugc nofollow" target="_blank"> http://localhost:9090 </a>并探索普罗米修斯。</p><p id="a256" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦我们所有的微服务都启动了，我们应该有这样的东西:</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ll"><img src="../Images/19ab0424c7cbc07c0cb330a40f9e5011.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ueKkRSkPR8FQyIIGjQskSQ.png"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">目标</figcaption></figure><p id="7b71" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们现在可以探索prometheus中的所有指标，并关注我们的微服务的行为，此示例显示了我们的微服务的系统CPU使用情况:</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lm"><img src="../Images/58079e69793dc9754eee8c6be58a6059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f5K3GLFXYTO7SVgQRVnM0A.png"/></div></div></figure><h1 id="fd52" class="ln jm hi bd jn lo lp lq jr lr ls lt jv lu lv lw jy lx ly lz kb ma mb mc ke md bi translated">格拉夫纳</h1><p id="c325" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">到目前为止，我们的微服务将actautor的端点暴露在prometheus服务器中，这非常有趣，但当我们拥有如此大量的信息时，我们需要另一个系统来帮助我们更好地可视化和分析我们的微服务。</p><p id="01e5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Grafana是开源可视化和分析软件。它允许您查询、可视化、提醒和探索您的指标，无论它们存储在哪里。用简单的英语来说，它为你提供了将你的时间序列数据库(例如普罗米修斯)数据转化为漂亮的图表和可视化的工具。</p><h2 id="d349" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">下载和安装grafana</h2><p id="56c8" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">你可以从https://grafana.com/grafana/download的<a class="ae jk" href="https://grafana.com/grafana/download" rel="noopener ugc nofollow" target="_blank">这里下载grafana，然后去grafana下面的bin，执行grafana-server.exe</a></p><p id="d548" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Grafana默认运行在端口3000上，导航到<a class="ae jk" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank"> http://localhost:3000 </a>，用默认用户名<code class="du ky kz la kq b">admin</code>和密码<code class="du ky kz la kq b">admin</code>登录Grafana。</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es me"><img src="../Images/ea635a003a4ccc33949dbd6202bbc0cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YiW1qAqU2BV4jHYCMHYHTw.png"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">格拉夫纳</figcaption></figure><h2 id="bc71" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">配置Grafana从Prometheus导入指标数据</h2><p id="5bce" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">就像我们之前说过的，grafana从时间序列数据库中导入度量数据以便可视化，为此我们需要配置grafana从prometheus服务器中导入这些度量数据。</p><p id="cba1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">下图显示了格拉夫纳和普罗米修斯是如何互动的:</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mf"><img src="../Images/8e482a5a3a948109b53c7092c71c06df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pfHETCjMOrNdGL0UPGC_Og.png"/></div></div><figcaption class="lc ld et er es le lf bd b be z dx translated">体系结构</figcaption></figure><p id="f7a5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">要将prometheus metrcis导入grafana，我们必须遵循以下步骤:</p><h2 id="4c94" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">1.在Grafana中添加Prometheus数据源</h2><p id="bd6f" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">转到配置/数据源并单击以添加新的数据源</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ll"><img src="../Images/88edca490c0ad858506a5b097fecc484.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*58aQTWztQyMGfaIt5r8T8A.png"/></div></div></figure><p id="659b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Grafana提供了很多数据库，我们只需要选择普罗米修斯</p><p id="388a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">选择TSDB后，添加以下配置以将garafana与prometheus服务器连接起来:</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mg"><img src="../Images/f310a748d81bb56b838fa8553e340fb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DMEqPAKL7JZ7wukRlsCHTw.png"/></div></div></figure><h2 id="063b" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">2.创建新仪表板</h2><p id="1048" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">从左侧菜单中选择(+)图标，然后单击仪表板:</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mh"><img src="../Images/eb3267b8c790e85cf0f6c572e5164ae9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rxjCAaV2H_Swn6nhlpQeVg.png"/></div></div></figure><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mi"><img src="../Images/c286eb8c27a3f4cd5c79c00047871872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JfZ2ix8BQr4l8jG3yZzcnw.png"/></div></div></figure><h2 id="6c4c" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">3.可视化您的仪表板</h2><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mj"><img src="../Images/2da413b6b29930384b1bdd935b042f86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IOw6nT8uTL_Hlafa0OnU6Q.png"/></div></div></figure><h2 id="b13e" class="jl jm hi bd jn jo jp jq jr js jt ju jv ix jw jx jy jb jz ka kb jf kc kd ke kf bi translated">导入预建仪表板</h2><p id="383e" class="pw-post-body-paragraph im in hi io b ip kg ir is it kh iv iw ix ki iz ja jb kj jd je jf kk jh ji jj hb bi translated">Grafana.com维护着一个共享仪表盘的集合，可以下载并与Grafana的独立实例一起使用。使用Grafana.com“过滤器”选项浏览仪表板，仅查看“Prometheus”数据源。</p><p id="813b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">例如，我们将搜索“spring boot statistics”仪表板:</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mk"><img src="../Images/743ab12c9740a43c1e2fd1b6c550a7fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wwYpgm8jrrdmJEBOeafC2g.png"/></div></div></figure><p id="bf26" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">复制id并转到仪表板/导入，然后单击加载</p><figure class="kl km kn ko fd ij er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ml"><img src="../Images/6ec05e0932ecb0c396c9517b368daffa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zf-cs1znXWKNnA-hwynK5w.png"/></div></div></figure><p id="2110" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您的仪表板已准备好进行浏览。现在轮到你和你的需求了，你可以做任何你想做的事情，你可以继续关注你的整个系统。<br/>在下一个也是最后一个部分，我们将了解如何使用弹性堆栈聚合微服务日志。</p><p id="131c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以在git存储库上找到更新源代码:</p><div class="mm mn ez fb mo mp"><a href="https://github.com/FirasMessaoudi/ecommerce" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab dw"><div class="mr ab ms cl cj mt"><h2 class="bd hj fi z dy mu ea eb mv ed ef hh bi translated">FirasMessaoudi/电子商务</h2><div class="mw l"><h3 class="bd b fi z dy mu ea eb mv ed ef dx translated">在GitHub上创建一个帐户，为FirasMessaoudi/电子商务发展做出贡献。</h3></div><div class="mx l"><p class="bd b fp z dy mu ea eb mv ed ef dx translated">github.com</p></div></div><div class="my l"><div class="mz l na nb nc my nd ik mp"/></div></div></a></div><p id="b063" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">当最终部分准备好了，我会在评论中通知你。</p></div></div>    
</body>
</html>