<html>
<head>
<title>Availability test with Node.js and Playwright for Application Insights</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js和剧作家进行可用性测试，以获得应用洞察</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/availability-test-with-node-js-and-playwright-for-application-insights-85a4c1d724e7?source=collection_archive---------1-----------------------#2021-11-12">https://medium.com/nerd-for-tech/availability-test-with-node-js-and-playwright-for-application-insights-85a4c1d724e7?source=collection_archive---------1-----------------------#2021-11-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/14081189d7f4cf6ff6b3e35f69893656.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GSp1cK738MhBCNWK.jpeg"/></div></div></figure><p id="3ad9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最近几天，我不得不工作的一个场景是创建个性化可用性测试，以验证一个网站仍然是活跃的，即使没有用户在周围转来转去。为了完成这项任务，我使用Node.js作为编程语言，并使用<a class="ae jo" href="https://playwright.dev/" rel="noopener ugc nofollow" target="_blank">剧作家库</a>来模拟必要的导航，以验证一切正常工作:</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jp"><img src="../Images/0e9236848c190859db271cb938a5a91c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pgQUnjrEDSU7BC0W.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated"><em class="jy">用于概念验证的架构</em></figcaption></figure><h2 id="017b" class="jz ka hi bd kb kc kd ke kf kg kh ki kj jb kk kl km jf kn ko kp jj kq kr ks kt bi translated">什么是剧作家？</h2><p id="35a4" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">剧作家是一个API，你可以用它自动化Chromium、Firefox和WebKit，从而从功能的角度测试你的应用程序。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/088ea31c089c076ace76da4fd77da244.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5mIdltWtoaNiw8hF.png"/></div></div></figure><p id="5a86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它有用于<strong class="is hj"> Node.js、Java、Python和。网</strong>。在本文中，我们将使用后者。</p><h2 id="607c" class="jz ka hi bd kb kc kd ke kf kg kh ki kj jb kk kl km jf kn ko kp jj kq kr ks kt bi translated">使用剧作家登录Azure活动目录</h2><p id="8dcf" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">首先需要做的是创建一个控制台应用程序:</p><pre class="jq jr js jt fd la lb lc ld aw le bi"><span id="b3c3" class="jz ka hi lb b fi lf lg l lh li"><em class="lj">dotnet new console -n web-with-az-ad-playwright-dotnet</em></span></pre><p id="9019" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，您必须添加剧作家库:</p><pre class="jq jr js jt fd la lb lc ld aw le bi"><span id="0af0" class="jz ka hi lb b fi lf lg l lh li">dotnet add package Microsoft.Playwright</span></pre><p id="a56d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是我用过的代码:</p><pre class="jq jr js jt fd la lb lc ld aw le bi"><span id="3219" class="jz ka hi lb b fi lf lg l lh li"><em class="lj">//// See </em><a class="ae jo" href="https://aka.ms/new-console-template" rel="noopener ugc nofollow" target="_blank"><em class="lj">https://aka.ms/new-console-template</em></a><em class="lj"> for more information</em></span><span id="6713" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">using Microsoft.Playwright;</em></span><span id="d82f" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">using var playwright = await Playwright.CreateAsync();<br/>await using var browser = await playwright.Chromium.LaunchAsync(new BrowserTypeLaunchOptions { Headless = false });</em></span><span id="7cf3" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">//3. Authenticate with Azure AD<br/>Console.WriteLine("Testing authenticated web page with Azure AD");</em></span><span id="a637" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">var page = await browser.NewPageAsync();<br/>await page.GotoAsync("&lt;WEB_URL&gt;");</em></span><span id="dde2" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">//Interact with the login form:</em></span><span id="03d9" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">//email<br/>await page.FillAsync("input[type='email']", "&lt;VALID_USER_EMAIL&gt;");<br/>await page.ClickAsync("input[type='submit']");</em></span><span id="c170" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">await page.WaitForNavigationAsync();</em></span><span id="70b4" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">//password<br/>await page.ClickAsync("[placeholder='Password']");<br/>await page.FillAsync("input[name='passwd']", "&lt;VALID_USER_PASSWORD&gt;");<br/>await page.ClickAsync("input[type='submit']");<br/></em></span><span id="ebcb" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">//Stay signed? Say no<br/>await page.ClickAsync("text=No");</em></span><span id="5de9" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">await page.WaitForNavigationAsync();</em></span><span id="0ffc" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">// await page.PauseAsync(); //Just for debugging</em></span><span id="51fe" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">var title = await page.TitleAsync();</em></span><span id="8ab1" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">Console.WriteLine($"Title of the page {title}");</em></span></pre><p id="5754" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>如果你对源代码感到惊讶，或者你认为它是缺失的东西😀，看看这个链接:<a class="ae jo" href="https://aka.ms/new-console-template" rel="noopener ugc nofollow" target="_blank">https://aka.ms/new-console-template</a></p><p id="520e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果用Headless运行它，您可以看到Chromium实例是如何生成的，并快速执行所有这些步骤。如果你正在做类似的事情，并且你不知道你的任何网页选择器，你可以使用<em class="lj">页面。PauseAsync () </em>这将停止进程，允许您浏览web字段，并将选择器返回给您。</p><p id="c83d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有了这些信息后，如果您登录到此web应用程序，您将默认看到此页面:</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/e397a17e2e0189a267766e385b02f71f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MnKTGz-_cNZsBi7a.png"/></div></div></figure><h2 id="3b62" class="jz ka hi bd kb kc kd ke kf kg kh ki kj jb kk kl km jf kn ko kp jj kq kr ks kt bi translated">Node.js和剧作家的测试</h2><p id="566c" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">你需要做的下一件事是测试。这甚至可以位于控制台应用程序中，为此，您可以使用带有计时器类型触发器的Azure函数:</p><pre class="jq jr js jt fd la lb lc ld aw le bi"><span id="149f" class="jz ka hi lb b fi lf lg l lh li"><em class="lj">const { chromium } = require('playwright-chromium');<br/>const appInsights = require("applicationinsights");<br/>const { v4 } = require('uuid');<br/>var telemetryClient = new appInsights.TelemetryClient(process.env.APP_INSIGHTS_WEB);<br/>const Stopwatch = require('statman-stopwatch');</em></span><span id="41a9" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">module.exports = async function(context, myTimer) {<br/>    var timeStamp = new Date().toISOString();</em></span><span id="4f80" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">    if (myTimer.isPastDue) {<br/>        context.log('JavaScript is running late!');<br/>    }<br/>    context.log('JavaScript timer trigger function ran!', timeStamp);</em></span><span id="0333" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">    //Create availability telemetry<br/>    var availabilityTelemetry = {<br/>        id: v4(),<br/>        name: process.env.AVAILABILITY_TEST_NAME,<br/>        runLocation: process.env.RUN_LOCATION,<br/>        success: false<br/>    };</em></span><span id="3626" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">    const stopwatch = new Stopwatch();<br/>    const browser = await chromium.launch({ headless: true });</em></span><span id="8338" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">    try {<br/>        //Create playwright flow        <br/>        const page = await browser.newPage();<br/>        stopwatch.start();</em></span><span id="8e5c" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">        context.log(`Navigating to: ${process.env.WEB_URL}`);<br/>        await page.goto(process.env.WEB_URL);<br/>        context.log(`Put the email ${process.env.TEST_USER_EMAIL}`);<br/>        await page.type("input[type='email']", process.env.TEST_USER_EMAIL);<br/>        await page.click("input[type='submit']");<br/>        await page.waitForNavigation();</em></span><span id="7a01" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">        context.log('Put the password');<br/>        await page.click("[placeholder='Password']");<br/>        await page.type("input[name='passwd']", process.env.TEST_USER_PWD);<br/>        await page.click("input[type='submit']");<br/>        await page.waitForNavigation();</em></span><span id="a55f" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">        context.log('Say no');<br/>        await page.click("text=No");<br/>        await page.waitForNavigation();</em></span><span id="0fd0" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">        var title = await page.title();<br/>        context.log('Title: ' + title);<br/>        availabilityTelemetry.success = true;</em></span><span id="9e61" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">    } catch (error) {<br/>        context.log.error('Error: ' + error);<br/>        availabilityTelemetry.success = false;</em></span><span id="9655" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">        //Create exception telemetry        <br/>        telemetryClient.trackException({ exception: error });</em></span><span id="14d0" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">    } finally {<br/>        stopwatch.stop();<br/>        var elapsed = stopwatch.read();<br/>        context.log('Stopwatch: ' + elapsed);<br/>        availabilityTelemetry.duration = elapsed;<br/>        telemetryClient.trackAvailability(availabilityTelemetry);<br/>        await browser.close();<br/>        context.done();<br/>    }<br/>}</em></span></pre><p id="4d36" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每隔1分钟，我们使用剧作家运行这个测试，我们尝试使用从环境变量中获得的用户名和密码登录(理想情况下，它将存储在Azure Key Vault中)，最后我们获得页面的标题，它应该与示例页面相同。</p><p id="9653" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您能够在没有超时的情况下完成所有步骤(例如，因为它找不到控件),这意味着一切都已顺利执行，因此测试是正常的。否则，它将在Application Insights本身中生成一个异常。</p><p id="749e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了部署这个示例，我使用了Visual Studio代码，但是我用Azure CLI创建并配置了Azure函数，还添加了相应的应用程序设置:</p><pre class="jq jr js jt fd la lb lc ld aw le bi"><span id="f3e2" class="jz ka hi lb b fi lf lg l lh li"><em class="lj">#Variables<br/>#for the Azure Function<br/>TEST_USER="&lt;AZURE_AD_USER_EMAIL&gt;"<br/>TEST_SECRET="&lt;AZURE_AD_USER_PASSWORD&gt;"<br/>WEB_TO_TEST="&lt;THE_WEB_YOU_WANT_TO_TEST&gt;"<br/>APP_INSIGHTS_TO_REPORT="&lt;APP_INSIGHTS_INSTRUMENTATION_KEY&gt;"<br/>AVAILABILITY_TEST_NAME="Test using Node.js"</em></span><span id="af32" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">#for Azure resources<br/>RESOURCE_GROUP="Custom-Tests"<br/>LOCATION="West Europe"<br/>AZURE_FUNCTION_NAME="app-insights-availability-west"<br/>AZURE_FUNCTION_PLAN="AzFuncNodejsPlan"<br/>STORAGE_ACCOUNT_NAME="playwrightnodejswest"</em></span><span id="d635" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">#1. Create Resource Group<br/>az group create --name $RESOURCE_GROUP --location $LOCATION</em></span><span id="3aec" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">#2. Create Storage account<br/>az storage account create --resource-group $RESOURCE_GROUP --name $STORAGE_ACCOUNT_NAME --location $LOCATION --sku Standard_LRS</em></span><span id="8c66" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">#Get Azure Storage connection string<br/>STORAGE_CONNECTION_STRING=$(az storage account show-connection-string --name $STORAGE_ACCOUNT_NAME --resource-group $RESOURCE_GROUP --output tsv)</em></span><span id="2d1d" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">#Create Azure Function Plan<br/>az functionapp plan create --resource-group $RESOURCE_GROUP --name $AZURE_FUNCTION_PLAN --location $LOCATION --number-of-workers 1 --sku EP1 --is-linux</em></span><span id="e9e5" class="jz ka hi lb b fi lk lg l lh li"><em class="lj"># Create Azure Function<br/>az functionapp create --name $AZURE_FUNCTION_NAME --functions-version 3 --storage-account $STORAGE_ACCOUNT_NAME --resource-group $RESOURCE_GROUP --plan $AZURE_FUNCTION_PLAN  --runtime node --runtime-version 12</em></span><span id="098c" class="jz ka hi lb b fi lk lg l lh li"><em class="lj">#Add app settings to the Azure Function<br/>az functionapp config appsettings set --name $AZURE_FUNCTION_NAME --resource-group $RESOURCE_GROUP \<br/>--settings WEB_URL=$WEB_TO_TEST \<br/>RUN_LOCATION=$LOCATION \<br/>TEST_USER_EMAIL=$TEST_USER \<br/>TEST_USER_PWD=$TEST_SECRET \<br/>APP_INSIGHTS_WEB=$APP_INSIGHTS_TO_REPORT \<br/>AVAILABILITY_TEST_NAME=$AVAILABILITY_TEST_NAME \<br/>PLAYWRIGHT_BROWSERS_PATH=0</em></span></pre><p id="a867" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意</strong> <em class="lj">:在这个例子中，我在Visual Studio代码中部署它。如果您已经创建了自己的Azure函数，请记住，要让剧作家在此服务中工作，您必须指明您希望在目的地完成依赖项的安装。这是通过修改</em> <strong class="is hj"> <em class="lj">来实现的。vs code/settings . JSON</em></strong><em class="lj">文件</em></p><pre class="jq jr js jt fd la lb lc ld aw le bi"><span id="7c71" class="jz ka hi lb b fi lf lg l lh li"><em class="lj">{<br/>    "azureFunctions.deploySubpath": ".",    <br/>    "azureFunctions.projectLanguage": "JavaScript",<br/>    "azureFunctions.projectRuntime": "~3",<br/>    "debug.internalConsoleOptions": "neverOpen",    <br/>    "azureFunctions.scmDoBuildDuringDeployment": true<br/>}</em></span></pre><h2 id="525e" class="jz ka hi bd kb kc kd ke kf kg kh ki kj jb kk kl km jf kn ko kp jj kq kr ks kt bi translated">结果呢</h2><p id="670c" class="pw-post-body-paragraph iq ir hi is b it ku iv iw ix kv iz ja jb kw jd je jf kx jh ji jj ky jl jm jn hb bi translated">如果您运行此测试一段时间，在Application Insights的<strong class="is hj">可用性</strong>部分，您会看到类似这样的内容:</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/50473665f877656e8247d11b83dc4484.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p16symGy-QWTu39U.png"/></div></div></figure><p id="11c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如你所见，绿点表示一切正常，而Xs表示我只是简单地停止了web应用程序😉意味着这个测试失败了。最重要的是，你可以设置警报，在系统停止工作时通知你。为此，在设置警报时，您会收到以下信号:</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/9d0c5f7148e10a3f176d68d47489a567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kt_eWyQ0d-8Q0QCN.png"/></div></div></figure></div></div>    
</body>
</html>