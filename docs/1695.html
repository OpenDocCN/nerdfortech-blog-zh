<html>
<head>
<title>Ingest data from GCS to BQ using Cloud Functions.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用云功能将数据从 GCS 接收到 BQ。</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/ingest-data-from-gcs-to-bq-using-cloud-functions-abaca92514bf?source=collection_archive---------1-----------------------#2021-04-02">https://medium.com/nerd-for-tech/ingest-data-from-gcs-to-bq-using-cloud-functions-abaca92514bf?source=collection_archive---------1-----------------------#2021-04-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/b83d5b99b10e9e0113f2ca2ccc75c54d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*V8ipqtlQIXz7SA1Qj3VQ-w.png"/></div></figure><p id="b095" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你已经熟悉<strong class="io hj"> FaaS </strong>(功能即服务)，那么<strong class="io hj">云功能</strong>就不需要介绍了。</p><blockquote class="jk jl jm"><p id="5640" class="im in jn io b ip iq ir is it iu iv iw jo iy iz ja jp jc jd je jq jg jh ji jj hb bi translated">Google Cloud Functions 是一个无服务器的执行环境，用于构建和连接云服务。使用云函数，您可以编写简单的、单一用途的函数，附加到从您的云基础架构和服务发出的事件上。当正在观看的事件被触发时，您的云功能被触发。您的代码在完全托管的环境中执行。不需要配置任何基础架构，也不需要担心管理任何服务器。</p></blockquote><p id="919b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">云函数可以用 Node.js，Python，Go，Java，.NET 和 Ruby 编程语言运行时。</p><p id="2f6e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">云函数要么是基于 HTTP 的函数，要么是事件驱动的函数。根据您使用的运行时，事件驱动可以是后台函数或云事件函数。</p><p id="aa8a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在本文中，我们将编写、部署和触发<strong class="io hj">事件驱动函数</strong>，特别是<strong class="io hj">后台函数</strong>(使用 Python 运行时)，每当 GCS 中有新文件可用时，这些函数会自动将数据从<strong class="io hj">云存储加载到 BigQuery </strong>。</p><ul class=""><li id="4975" class="jr js hi io b ip iq it iu ix jt jb ju jf jv jj jw jx jy jz bi translated">在我们开始之前，确保从<strong class="io hj">API 和服务</strong>控制台启用<strong class="io hj">云功能</strong>和<strong class="io hj">云存储 API</strong>。</li><li id="891b" class="jr js hi io b ip ka it kb ix kc jb kd jf ke jj jw jx jy jz bi translated">启用所需的 API 后，在导航菜单中，单击<strong class="io hj">云功能</strong>打开主页。您可以在主页点击<strong class="io hj">创建功能</strong>来创建一个新功能。</li></ul><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es kf"><img src="../Images/7d8a5dd281dc5b439f081f1816aeb452.png" data-original-src="https://miro.medium.com/v2/resize:fit:598/format:webp/1*wx13TYEBOyh6AA8TgtBilg.png"/></div></div></figure><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es ko"><img src="../Images/c93b9f2d83e043e52b3ae7b65c6493d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vZZRY-xheSaJhhJZVkr9_g.png"/></div></div></figure><p id="d5a8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">创建一个新功能包括两个步骤:<strong class="io hj">配置</strong> &amp; <strong class="io hj">代码</strong>。</p><p id="5ae1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">点击<strong class="io hj">创建功能</strong>，首先您会看到一个配置屏幕，在这里您需要选择基本细节，如<strong class="io hj">功能名称、区域、触发类型等。</strong>根据触发器类型，您还需要选择更多选项。例如，如果您的<strong class="io hj">触发器</strong>是<strong class="io hj">云发布/订阅</strong>，您需要从下拉菜单中选择一个云发布/订阅主题。</p><p id="3063" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在本例中，我将选择<strong class="io hj">云存储</strong>作为我的<strong class="io hj">触发器</strong>，并从下拉菜单中选择 bucket。我还需要选择<strong class="io hj">事件类型</strong>，在我们的例子中是<strong class="io hj">完成/创建</strong>。</p><p id="8bb3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">用户可以选择勾选<strong class="io hj">失败重试</strong>框。将出现一条警告，告知复选框对触发器的意义。</p><p id="dec8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您可以进一步选择设置运行时、构建和配置设置，对于本例来说，这些设置保持不变并保留默认值。</p><figure class="kg kh ki kj fd ij er es paragraph-image"><div class="er es kp"><img src="../Images/66f904bfd82ff53c8e3625786206904b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1270/format:webp/1*OOaz7bHbYu7CuH9Uy9J2fA.png"/></div></figure><p id="4f9d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦在配置屏幕中选择了所需的一切，单击<strong class="io hj">下一个</strong>导航到<strong class="io hj">代码</strong>屏幕，在这里您需要选择<strong class="io hj">运行时</strong>，在我们的例子中是 Python 3.7 和<strong class="io hj">入口点</strong>(入口点是您想要在云函数中执行的函数的名称)。</p><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es kq"><img src="../Images/0434299863037cd2a228e79ec77a2e6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QCq7wQJ8Aw0v5uro7Qwj8A.png"/></div></div></figure><p id="92c0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在这个阶段，我们应该知道 Python 的<strong class="io hj">代码结构</strong>需求。例如:</p><p id="b90b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">├──主页</p><p id="a5b0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">└──要求. txt</p><p id="2438" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du kr ks kt ku b">main.py</code>包含一个或多个我们打算执行的功能。</p><p id="c830" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du kr ks kt ku b">requirements.txt</code>文件指定了这些函数执行的依赖关系。这也包括要安装的软件包。</p><p id="b052" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦选择了所需的运行时，用户可以选择使用<strong class="io hj">内嵌</strong> <strong class="io hj">代码编辑器</strong>，或者从<strong class="io hj"> GCS </strong>等上传代码。创建一个函数。在我们的例子中，我选择使用内联代码编辑器。一旦根据需要定义了代码和需求，您就可以<strong class="io hj">部署</strong>该功能。</p><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es kv"><img src="../Images/aee76d4112ef2db85a1101b3073b48ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DS8ZwNCAle15Gi10nm5-9g.png"/></div></div></figure><p id="ca69" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">函数名旁边的绿色勾表示<strong class="io hj">部署</strong>成功。</p><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es kw"><img src="../Images/3d0a85236378080a4e87dee9eb78dfa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YMTTud45d2weB0TkdMEL9g.png"/></div></div></figure><p id="aab3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">每当触发一个新的 CSV 文件时，从 GCS 加载数据到 BQ 的云函数现在已经准备好了。</p><p id="309f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">一旦执行了该功能，您就可以通过选择正确的版本进入功能屏幕来监控性能、错误、指标和日志。</p><figure class="kg kh ki kj fd ij er es paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="er es kx"><img src="../Images/61cbf6132da0f3d8f2de2d60c83649e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-5MUwDzFIDvhjua_Q6gO5A.png"/></div></div></figure><p id="ca06" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你也可以使用<strong class="io hj">多个云函数</strong>来执行提取-转换-加载。</p><p id="7fac" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">代码信用</strong>:</p><p id="b890" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><a class="ae ky" href="https://gist.githubusercontent.com/mkahn5/5d2d569209f39f72d089a68d767de57b/raw/19f4440bf2e8ee2f22b3ca757591b007d7975672/main.py" rel="noopener ugc nofollow" target="_blank">https://gist . githubusercontent . com/mka hn5/5d2d 569209 f 39 f 72d 089 a68d 767 de 57 b/raw/19f 4440 BF 2 e 8 ee 22 B3 ca 757591 b 007d 7975672/main . py</a></p></div></div>    
</body>
</html>