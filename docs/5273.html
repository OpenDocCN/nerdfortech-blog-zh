<html>
<head>
<title>Tips: Extracting Frames From Camera Using AVCaptureSession</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">提示:使用AVCaptureSession从相机中提取帧</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/tips-extracting-frames-from-camera-using-avcapturesession-9d8a3a5c0a5c?source=collection_archive---------5-----------------------#2021-09-13">https://medium.com/nerd-for-tech/tips-extracting-frames-from-camera-using-avcapturesession-9d8a3a5c0a5c?source=collection_archive---------5-----------------------#2021-09-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="ad6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我将强调官方文档中过多描述的使用AVCaptureSession的一些要点。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/297f2e51d0a88d7a2357c1b2ccc61f82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ZnFC_QNCkxlaybgQIm8gg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">图像来自AVCam示例。(苹果)</figcaption></figure><p id="a930" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">老实说，很难给AVCaptureSession的描述添加任何东西。官方网站上有很多样品:<a class="ae jt" href="https://developer.apple.com/documentation/avfoundation/cameras_and_media_capture/avcam_building_a_camera_app" rel="noopener ugc nofollow" target="_blank"> AVCam </a>相当棒。在一个应用程序中，我必须在不同的屏幕上对帧进行不同的处理，还有一些中间步骤，因此我没有使用同一个会话。</p><p id="f546" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">综上所述，一切从权限到摄像头访问开始..</p><p id="c7da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">权限</strong>:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ju"><img src="../Images/1809e2a8903543e7d400a120d43c2b81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pglAzxo7NlHoPmayksryvA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">请求和检查权限</figcaption></figure><p id="7425" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从构造函数中直接调用CheckPermission 。配置成功后执行&amp;运行。会话主要在单独的队列中处理:(<strong class="ih hj"> sessionQueue) </strong></p><p id="2cfd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">配置</strong>:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jw"><img src="../Images/66da394e7ff199558a7b0599ac47a062.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QenN7nXU0S5TgTjPQgpK2w.png"/></div></div></figure><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jx"><img src="../Images/a6efe2244fac26ce6c33688117d043f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gzWyvQ55R8jfZ8ZMOc7pBg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">检查支持的预设</figcaption></figure><p id="e63e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">会话获取输入并将结果存储到输出，很容易对:)。</p><p id="8a43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<em class="jv">开始配置&amp;提交配置</em>中，我们定义了“预设”(未来帧的质量)。</p><p id="82a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">基于初始状态，在循环中检查一些值。可能使用其他东西…</p><p id="dddd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么应该选择设备</p><p id="c62b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">选择装置</strong>:</p><pre class="je jf jg jh fd jy jz ka kb aw kc bi"><span id="6f33" class="kd ke hi jz b fi kf kg l kh ki"><strong class="jz hj">if</strong> <strong class="jz hj">self</strong>.position == .back {<br/>  <strong class="jz hj">return</strong> AVCaptureDevice.default(for: .video)<br/>}</span><span id="1aa1" class="kd ke hi jz b fi kj kg l kh ki"><strong class="jz hj">let</strong> session: DiscoverySession = AVCaptureDevice.DiscoverySession(deviceTypes: deviceTypes,<br/>                                 mediaType: .video,<br/>                                 position: position)</span><span id="e5a7" class="kd ke hi jz b fi kj kg l kh ki"><strong class="jz hj">if</strong> <strong class="jz hj">let</strong> device = session.devices.first {<br/>  <strong class="jz hj">return</strong> device<br/>}</span></pre><blockquote class="kk kl km"><p id="d17e" class="if ig jv ih b ii ij ik il im in io ip kn ir is it ko iv iw ix kp iz ja jb jc hb bi translated"><em class="hi">AVCaptureMultiCamSession</em>，<em class="hi">来自iOS 13，允许同时从几个设备导入帧</em></p></blockquote><p id="6700" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后作为“输入”添加到会话设备。</p><p id="4835" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">输入:</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kq"><img src="../Images/e163dc5f1812187419c338a824fafb88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d2B4T5U-eyFWM0OApo_F3w.png"/></div></div></figure><blockquote class="kk kl km"><p id="2647" class="if ig jv ih b ii ij ik il im in io ip kn ir is it ko iv iw ix kp iz ja jb jc hb bi translated">如果设备有<strong class="ih hj">issuebjectachangemonitoringeenabled</strong>我们可以处理<strong class="ih hj">AVCaptureDeviceSubjectAreaDidChange</strong>，关注点。</p></blockquote><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kr"><img src="../Images/437b2e8317e3c3b9c1ad5732906ee766.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bym74dpgsH9q1wPaguDVpQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">试着专注于特定的点</figcaption></figure><p id="a3e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">输出</strong>:</p><p id="1927" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的例子中，我需要处理帧，因此我的输出是一个像素缓冲区:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ks"><img src="../Images/d67b6e31bef8ad5cf213245e796f2140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qVVQ99Zq6sikL2hE-vtCoA.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">添加视频数据输出</figcaption></figure><p id="090d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在官方样本中使用了420 ypcbcr 8 biplanarfullrange像素格式类型。</p><p id="6e3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">输入和输出对通过“连接”匹配。输入有几个获取数据的端口，输出接受来自数据源的数据。当您添加输入时，会话会形成适当的输出连接。</p><p id="83d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当相机旋转时，我们通常需要调整视频方向(这应该由<em class="jv">isvideoorientiationsupported支持，</em>镜像也是如此)。别忘了获取“锁”。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kt"><img src="../Images/4a78c8beccff4ee46d84c11cc33216f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K02tjXrcTfE57Y8aI3l3OQ.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">视频定向和镜像</figcaption></figure><p id="be63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">可视会话配置和启动可通过以下方案进行演示(具有授予的权限):</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ku"><img src="../Images/b0b326ea6a203d59f6c458c7a949ef5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A7UT4c_wqYO05ZeqBVC6jQ.jpeg"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">AVCaptureSession配置</figcaption></figure><p id="de52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">处理事件&amp;观察值</strong></p><p id="d936" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有趣的点大多与处理事件或观察对象中的键值有关。(例如处理系统压力&amp;由于改变<strong class="ih hj">系统压力状态</strong>而降低质量)</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kv"><img src="../Images/4f4de57807792d04d3c13c6f8e409108.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vq_rJcIfS4CK_PcnAaEEQg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">如果是关键会话，降低帧速率</figcaption></figure><p id="cd0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不要忘记关键通知:</p><pre class="je jf jg jh fd jy jz ka kb aw kc bi"><span id="d9c4" class="kd ke hi jz b fi kf kg l kh ki"><strong class="jz hj">AVCaptureSessionRuntimeError</strong><br/><strong class="jz hj">AVCaptureSessionWasInterrupted</strong></span><span id="08a5" class="kd ke hi jz b fi kj kg l kh ki">use <strong class="jz hj">AVCaptureSessionInterruptionReasonKey</strong> key in dictionary, and cast it to <strong class="jz hj">AVCaptureSession.InterruptionReason to find reason of interruption</strong></span><span id="47bb" class="kd ke hi jz b fi kj kg l kh ki">AVCaptureSessionDidStopRunning - could be used for notifications...<br/>AVCaptureSessionDidStartRunning</span></pre></div></div>    
</body>
</html>