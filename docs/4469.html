<html>
<head>
<title>AWS DynamoDB Auto Scaling is not a magic bullet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS DynamoDB自动缩放不是灵丹妙药</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/aws-dynamodb-auto-scaling-is-not-a-magic-bullet-25b2fdc50e5a?source=collection_archive---------6-----------------------#2021-07-22">https://medium.com/nerd-for-tech/aws-dynamodb-auto-scaling-is-not-a-magic-bullet-25b2fdc50e5a?source=collection_archive---------6-----------------------#2021-07-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c3d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">AWS为DynamoDB容量规划提供了两种模式。按需供应。随着时间的推移，将相同数量的记录输入或输出数据库，按需定价大约要贵7倍。为简单起见，我们只考虑写操作的定价。如果我们调配3000 WCU的容量，这意味着我们可以在一秒钟内推送3000次写入。在某些亚洲AWS地区，这种写入资源调配每月将花费我们大约1650美元。如果我们有一个稳定的流量(这是从来没有的情况)，我们每个月可以向这个数据库推送大约80亿条记录。为了推动按需定价的相同数量的记录，我们将花费超过11，250美元。</p><p id="72dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种计算的问题是，我们在现实生活中从来没有稳定的流量。为了避免峰值容量的供应，AWS提供了一个自动扩展的供应模型。这是配置屏幕的外观:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/9dd74340933a84a1e005188b2ccb79ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vL4V7nlmQZ-Pgp85ydXWpw.png"/></div></div></figure><p id="6e58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看起来我可以拥有一个非常低的5 WCU的调配容量(每月仅花费3美元),并且随着需求的增加，让它一直扩展到40k WCU/RCU的限制。<em class="jp">非常误导:)</em>我用这种配置在桌子上做了一个小小的加载实验。结果是，只要DynamoDB停止运行，它就会允许短时间的过载超过所提供的容量。像这样:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jq"><img src="../Images/56df7fddc8235a7eeea640fa6be7e0d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Yrh0NiF90b1PNR0imJO0w.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">发电机容量过小爆发DB</figcaption></figure><p id="bbf9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我现在尝试从一个系统中以最高的速度加载这个表。一个多线程程序在全速下抽取少量的写操作。DynamoDB通过“provisionedthroughputexceedexception”开始限制大多数请求。有趣的是，在这个异常失败之前，请求会等待将近50秒。任何成功的请求都有20到300毫秒的延迟。</p><h2 id="5545" class="jv jw hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated">自动缩放发生了什么变化？</h2><p id="6e0a" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">自动扩展确实有效，但它无法处理突发流量。从该图中可以明显看出，扩展需要一段时间:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kv"><img src="../Images/450245232bcdbdbc2d10a58e1962a8f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pQjH6WE49mJjFJjbdxzc0A.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">DynamoDB自动纵向扩展吞吐量图</figcaption></figure><p id="df66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，每一次扩大的数量都在增加。当面临持续过载时，使用某种指数放大算法。在我运行了大约45分钟的测试中，我一直得到provisionedthroughputexceedexception。<em class="jp">在45分钟的时间里，尽管每秒钟大约有1000个请求，但总共只有大约100个WCU！</em></p><h2 id="e190" class="jv jw hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated">这个怎么缩小？</h2><p id="8fc2" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">缩小规模没有扩大规模来得快，但一旦扩大规模，规模就会变得很大。我在图中的20:25左右停止了测试。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kw"><img src="../Images/6bc1a4b3e8414c132c7a47e1245d8653.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yj5mraThsDzw3VQC_Y6Cdg.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">DynamoDB自动缩放吞吐量图</figcaption></figure><h2 id="3ee0" class="jv jw hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated">按需扩展看起来如何，延迟如何？</h2><p id="d99e" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">我现在将该表切换为按需扩展。我花了大约8分钟在控制台上切换到按需容量。这很聪明—如果立即切换到按需分配容量，我们可以一直保持资源调配状态，一旦看到请求激增，就切换到按需分配:)</p><p id="428c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我切换到随需应变之后，我不再有例外。吞吐量如下图所示(针对多次测试尝试)。但是请注意:平均延迟仍然保持在100到150毫秒左右。我在一台机器上可以达到的最大吞吐量大约是1500</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kx"><img src="../Images/8a572a1481b9983965ca8bedbf26455f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fHlcW5PHV2zECIHLshm8lg.png"/></div></div><figcaption class="jr js et er es jt ju bd b be z dx translated">按需DynamoDB吞吐量</figcaption></figure><h2 id="8841" class="jv jw hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated">有出路吗？</h2><p id="0675" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">按需定价的问题在于它有点吓人。您需要为插入的记录付费。代码中的一个小错误或者一个粗心的新变化都会给你一个巨大的账单冲击。有没有其他不支付按需定价但仍能得到的想法？有一种方法可以考虑是否可以让您的应用程序逻辑绕过它:</p><ul class=""><li id="6d64" class="ky kz hi ih b ii ij im in iq la iu lb iy lc jc ld le lf lg bi translated">创建两个表。一个为您的稳态负载调配容量，另一个按需提供容量。始终使用预配的数据库，当检测到节流异常时，开始向按需表发送一些数据。查询必须处理这种两表设计。</li></ul><h2 id="ec14" class="jv jw hi bd jx jy jz ka kb kc kd ke kf iq kg kh ki iu kj kk kl iy km kn ko kp bi translated">在DynamoDB前面用SQS怎么样？</h2><p id="e9ae" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq ks is it iu kt iw ix iy ku ja jb jc hb bi translated">DynamoDB最常见的设计模式之一是在其前面使用SQS来缓冲写操作，并将DB保持在较低的配置容量。如果这种方法适用于您的应用程序，那太好了。然而，请记住，SQS成本也很高。对于我们开始时做的比较，通过点播抽取80亿条记录需要1.1万英镑。但是如果我们使用在3000 WCU配置的SQS + DynamoDB，它现在将花费大约5k(dynamo db 1.6k+SQS 3.2k)</p><p id="14bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望这个分析能帮助那些试图用DynamoDB设计大型系统的人。如果你们中的任何人看到了任何不同的东西，或者对突发流量的经济高效的扩展有其他想法，请在评论中分享。</p></div></div>    
</body>
</html>