<html>
<head>
<title>Apply Continuous Integration for Ruby project by using CircleCI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 CircleCI 为 Ruby 项目应用持续集成</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/apply-continuous-integration-for-ruby-project-by-using-circleci-c65e2ae706ac?source=collection_archive---------2-----------------------#2022-06-21">https://medium.com/nerd-for-tech/apply-continuous-integration-for-ruby-project-by-using-circleci-c65e2ae706ac?source=collection_archive---------2-----------------------#2022-06-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="b9d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大多数软件开发人员可能都经历过这种情况:参与软件项目的成员越多，当新代码集成到项目中时，出现错误的机会就越大。为了避免这种问题，持续集成的概念应运而生，并在当今软件项目中得到广泛应用。什么是持续集成(CI)？根据来自<a class="ae jd" href="https://www.atlassian.com/continuous-delivery/continuous-integration" rel="noopener ugc nofollow" target="_blank"> Atlassian 网站</a>的持续集成(CI)的定义，我们可以知道对于软件项目来说，在集成到项目中之前保持新代码的正确性是一个很好的实践。</p><blockquote class="je jf jg"><p id="63b1" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">持续集成(CI)是将来自多个参与者的代码变更自动集成到一个软件项目中的实践。这是一个主要的<a class="ae jd" href="https://www.atlassian.com/devops/what-is-devops/devops-best-practices" rel="noopener ugc nofollow" target="_blank"> DevOps 最佳实践</a>，允许开发人员频繁地将代码变更合并到一个中央存储库中，然后在那里运行构建和测试。自动化工具用于在集成前断言新代码的正确性。</p></blockquote><p id="b450" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在软件项目中有许多工具可以实现持续集成，例如 Jenkins、TeamCity、Bamboo、Buddy 和 CircleCI...每种工具都有其优点和缺点。本文选择 CircleCI 作为例子，展示如何将持续集成应用到 Ruby 项目中。下面是这篇文章的大纲。有 5 节课介绍 CircleCI 的用法。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="bd2e" class="ju jv hi jq b fi jw jx l jy jz"><a class="ae jd" href="#bd21" rel="noopener ugc nofollow"><strong class="jq hj">Outline</strong></a><strong class="jq hj"><br/>．</strong><a class="ae jd" href="#7676" rel="noopener ugc nofollow"><strong class="jq hj">Getting started with CircleCI on your Github repo</strong></a><strong class="jq hj"><br/>．</strong><a class="ae jd" href="#1fdc" rel="noopener ugc nofollow"><strong class="jq hj">Implement CircleCI in Ruby project</strong></a><strong class="jq hj"><br/>．</strong><a class="ae jd" href="#7084" rel="noopener ugc nofollow"><strong class="jq hj">Setup Database in CircleCI</strong></a><strong class="jq hj"><br/>．</strong><a class="ae jd" href="#4e9b" rel="noopener ugc nofollow"><strong class="jq hj">Apply reusable command with parameters in CircleCI config</strong></a><strong class="jq hj"><br/>．</strong><a class="ae jd" href="#c7f1" rel="noopener ugc nofollow"><strong class="jq hj">Debugging CircleCI error</strong></a><strong class="jq hj"><br/>．</strong><a class="ae jd" href="#971a" rel="noopener ugc nofollow"><strong class="jq hj">Reference</strong></a></span></pre></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h2 id="eea6" class="ju jv hi bd kh ki kj kk kl km kn ko kp iq kq kr ks iu kt ku kv iy kw kx ky kz bi translated">Github repo 上的 CircleCI 入门</h2><p id="97df" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">要开始使用 CircleCI，首先你要注册 GitHub 或者 BitBucket。在本文中，我们使用 Github 来注册。注册并登录后，你可以在项目页面上看到你所有的 GitHub 项目列表。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lf"><img src="../Images/c3fe69ff5d3664fbc24b046282ef5cc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-y4d-QjUML1wLAjUlgdBdA.png"/></div></div></figure><p id="cd85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在从你想要应用 CircleCI 的项目中点击设置项目按钮之前，你可以在你的项目的根目录下创建一个<code class="du ln lo lp jq b">.circleci</code>文件夹，并在<code class="du ln lo lp jq b">.circleci</code>文件夹中创建一个<code class="du ln lo lp jq b">config.yml</code>文件。有了这个<code class="du ln lo lp jq b">.circle/config.yml</code>，在用 CircleCI 设置项目后，每次有新的变更被推送到 Github repo 时，CircleCI 都会读取<code class="du ln lo lp jq b">config.yml</code>并执行<code class="du ln lo lp jq b">config.yml</code>中定义的作业</p><p id="1766" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du ln lo lp jq b">config.yml</code>的内容您可以先使用<a class="ae jd" href="https://circleci.com/docs/2.0/config-intro/" rel="noopener ugc nofollow" target="_blank"> CircleCI 配置介绍</a>测试中的示例配置共享。示例配置如下。我们可以看到在配置中有一个作业<code class="du ln lo lp jq b">build</code>，并且在作业环境中使用的 docker 映像也被定义，所以当使用 CicleCI 设置项目时，每次作业运行时都将为<code class="du ln lo lp jq b">build</code>作业准备好环境。在配置中，还定义了作业运行时执行的命令。它将执行两个命令:打印<code class="du ln lo lp jq b">Hello Wolrd!</code>然后打印<code class="du ln lo lp jq b">This is the delivery pipeline</code></p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="4a12" class="ju jv hi jq b fi jw jx l jy jz"># CircleCI config.yml example</span><span id="81ce" class="ju jv hi jq b fi lq jx l jy jz">version: 2.1<br/>jobs:<br/>  build:<br/>    docker:<br/>      - image: alpine:3.15<br/>    steps:<br/>      - run:<br/>          name: The First Step<br/>          command: |<br/>            echo 'Hello World!'<br/>            echo 'This is the delivery pipeline'</span></pre><p id="e1c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在提交了<code class="du ln lo lp jq b">config.yml</code>并将其推送到 Github 之后，你可以点击设置项目按钮，会出现一个弹出窗口让你选择使用配置文件的方式。我们可以选择最快的一个，然后点击设置项目。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div class="er es lr"><img src="../Images/f7a0d7d14d5e02f31ffddb0e8b429c53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*fh4qXeJJt0Jl98Lediu-Gw.png"/></div></figure><p id="5453" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置项目后，在您的仪表板中会显示一个管道。将显示在<code class="du ln lo lp jq b">config.yml</code>中定义的所有作业。如果作业旁边显示绿色勾号，这意味着作业中的所有命令都已成功执行。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ls"><img src="../Images/a24a42d612cb2450dd3a328a90879b3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7E35IrMrTrpIy6s1vFnGYA.png"/></div></div></figure><p id="ac9f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果有红色感叹号，则表示作业失败。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lt"><img src="../Images/f2608c5975e187f6e9de30c74062a633.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ip77glzi83JR0R0KLgAuEw.png"/></div></div></figure><p id="046a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以点击工作来查看更多信息。在我们的示例中，如果我们单击<code class="du ln lo lp jq b">build</code>，将显示该作业的所有详细结果。我们可以单击“步骤”,将会出现一个我们在<code class="du ln lo lp jq b">config.yml</code>中定义的步骤调用<code class="du ln lo lp jq b">The First Step</code></p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lu"><img src="../Images/e2ae3059f1357f5f5bc2478d88b4800a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jJuMONg8V_CXia5tGEZKZw.png"/></div></div></figure><p id="b841" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<code class="du ln lo lp jq b">The First Step</code>你可以看到这两个命令在这一步执行。<code class="du ln lo lp jq b">Hello World!</code>和<code class="du ln lo lp jq b">This is the delivery pipeline</code>打印在控制台上，所以如果我们要实现另一个命令，只需按照<code class="du ln lo lp jq b">config.yml</code>的步骤更新，提交并推送到 Github repo。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lv"><img src="../Images/41bf353b66fdbf4b6862584907e1a163.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KsgDAeLLfoaC9u7shDHwoQ.png"/></div></div></figure><p id="763b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们需要运行多个作业，并且一些作业应该在一些作业完成后运行，那么<code class="du ln lo lp jq b">workflows</code>可以在<code class="du ln lo lp jq b">config.yml</code>中实现。下面是<a class="ae jd" href="https://circleci.com/docs/2.0/config-intro#part-3-using-different-environments-and-creating-workflows" rel="noopener ugc nofollow" target="_blank"> CircleCI 文档</a>中的配置示例。在这个例子中，定义了三个作业:Hello-World、Fetch-Code 和 Using-Node。在<code class="du ln lo lp jq b">workflows</code>部分，<code class="du ln lo lp jq b">requires</code>可以让 CircleCI 知道只有当哪个作业完成时才需要执行该作业。我们可以看到 Fetch-Code 只能执行 Hello-World 完成的第一个任务，而 Using-Node 只能执行 Fetch-Code 完成的任务。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="2cb3" class="ju jv hi jq b fi jw jx l jy jz"># CircleCI config.yml example</span><span id="e0e5" class="ju jv hi jq b fi lq jx l jy jz">version: 2.1<br/>jobs:<br/>  # running commands on a basic image<br/>  Hello-World:<br/>    docker:<br/>      - image: cimg/base:2021.04<br/>    steps:<br/>      - run:<br/>          name: Saying Hello<br/>          command: |<br/>            echo 'Hello World!'<br/>            echo 'This is the delivery pipeline'<br/>  # fetching code from the repo<br/>  Fetch-Code:<br/>    docker:<br/>      - image: cimg/base:2021.04<br/>    steps:<br/>      - checkout<br/>      - run:<br/>          name: Getting the Code<br/>          command: |<br/>            ls -al<br/>            echo '^^^Your repo files^^^'<br/>  # running a node container<br/>  Using-Node:<br/>    docker:<br/>      - image: cimg/node:17.2<br/>    steps:<br/>      - run:<br/>          name: Running the Node Container<br/>          command: |<br/>            node -v<br/>workflows:<br/>  Example-Workflow:<br/>    jobs:<br/>      - Hello-World<br/>      - Fetch-Code:<br/>          requires:<br/>            - Hello-World<br/>      - Using-Node:<br/>          requires:<br/>            - Fetch-Code</span></pre><p id="8752" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在提交<code class="du ln lo lp jq b">config.yml</code>并将其推送到 Github 后，我们可以在 CircleCI 仪表板中看到有一个管道，其中有三个作业是我们在<code class="du ln lo lp jq b">config.yml</code>中定义的作业</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lw"><img src="../Images/bb2900ca859039c5142ef1486cc526b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GUzDw7IYOWVihQcurkzbZQ.png"/></div></div></figure><p id="6c6b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击成功按钮，出现该工作流的详细信息。它按照我们在<code class="du ln lo lp jq b">config.yml</code>中定义的顺序显示任务</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lx"><img src="../Images/bfac8f4b3a44ff39d8e97b28156ca077.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GqVxFQVGgGRwm_o22CJN8g.png"/></div></div></figure><p id="38d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在作业提取代码中，定义了两个步骤。第一个是<code class="du ln lo lp jq b">checkout</code>。它在执行时从你的 Github repo 中获取代码，所以这就是为什么第二步可以命令<code class="du ln lo lp jq b">ls -al</code>列出 Github repo 的所有内容。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="0192" class="ju jv hi jq b fi jw jx l jy jz"># fetching code from the repo<br/>  Fetch-Code:<br/>    docker:<br/>      - image: cimg/base:2021.04<br/>    steps:<br/>      - checkout<br/>      - run:<br/>          name: Getting the Code<br/>          command: |<br/>            ls -al<br/>            echo '^^^Your repo files^^^'</span></pre><p id="4725" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击获取代码查看详情，我们可以看到两个步骤:结帐代码和获取代码。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ly"><img src="../Images/5ed45790c99df0992c75be56df5f46bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B3jvOEvfVApcN3z2aa2x8A.png"/></div></div></figure><p id="ddbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 Checkout 代码部分，代码已经从你的 git repo 中取出，它在<code class="du ln lo lp jq b">origin/master</code>的分支上</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lz"><img src="../Images/ca29bc69778a35d4a2170f2703fc65d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jXpdhTHS73psUM1wY3NVyA.png"/></div></div></figure><p id="8093" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在获取代码部分，CircleCI 执行<code class="du ln lo lp jq b">ls -al</code>并列出 repo 第一层中的所有文件和文件夹。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div class="er es ma"><img src="../Images/10bf3d681052a61fd9dd1a8b4c579fb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*8zANsrZdx33mNPdvfJQhOQ.png"/></div></figure><p id="faac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每次我们在项目中进行代码更改并将其推送到 Github repo 时，CircleCI 都会自动运行作业并执行<code class="du ln lo lp jq b">config.yml</code>中定义的步骤中的所有命令。在<a class="ae jd" href="https://circleci.com/docs" rel="noopener ugc nofollow" target="_blank"> CircleCI 文档</a>中有关于如何编写<code class="du ln lo lp jq b">config.yml</code>在你的软件项目中实现持续集成的明确说明。有兴趣了解更多信息的人可以查看<a class="ae jd" href="https://circleci.com/docs/2.0/config-intro" rel="noopener ugc nofollow" target="_blank"> CircleCI 配置介绍</a>，并通过示例来熟悉 CircleCI 如何与 Github repo 一起工作。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="d0b6" class="ju jv hi jq b fi jw jx l jy jz">                        <a class="ae jd" href="#1fdc" rel="noopener ugc nofollow">Continue</a>｜<a class="ae jd" href="#bd2e" rel="noopener ugc nofollow">Back to Outline</a></span></pre></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h2 id="1fdc" class="ju jv hi bd kh ki kj kk kl km kn ko kp iq kq kr ks iu kt ku kv iy kw kx ky kz bi translated">在 Ruby 项目中实现 CircleCI</h2><p id="f336" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">要在 Ruby 中实现 CircleCI，我们的目的是在每次有代码变更并推送到 Github repo 时自动运行所有的 RSpec 测试，所以 CircleCI 需要执行 run RSpec。本文中使用的示例 Rails 项目可以在<a class="ae jd" href="https://github.com/iceland101113/photo_album" rel="noopener ugc nofollow" target="_blank">这里</a>找到。ruby 版本是 2.7.1，数据库使用的是 SQLite。在 CircleCI 中运行 RSpec 之前，应该准备好测试环境，所以在<code class="du ln lo lp jq b">.circle/config.yml</code>中将会定义两个作业。第一个用于构建环境，第二个用于运行测试。我们将使用<code class="du ln lo lp jq b">workflows</code>来定义作业的顺序和要求。示例配置如下。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="4830" class="ju jv hi jq b fi jw jx l jy jz">version: 2.1</span><span id="8c38" class="ju jv hi jq b fi lq jx l jy jz">orbs:<br/>  ruby: circleci/ruby@1.1.0</span><span id="8aee" class="ju jv hi jq b fi lq jx l jy jz">jobs:<br/>  build:<br/>    docker:<br/>      - image: cimg/ruby:2.7-node<br/>    steps:<br/>      - checkout<br/>      - ruby/install-deps<br/>  test:<br/>    docker:<br/>      - image: cimg/ruby:2.7-node<br/>    steps:<br/>      - checkout<br/>      - ruby/install-deps<br/>      # Run rspec<br/>      - ruby/rspec-test</span><span id="7dae" class="ju jv hi jq b fi lq jx l jy jz">workflows:<br/>  version: 2<br/>  build_and_test:<br/>    jobs:<br/>      - build<br/>      - test:<br/>          requires:<br/>            - build</span></pre><p id="ac6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们将在两个作业中安装 ruby，所以我们实现了<code class="du ln lo lp jq b">orbs</code>来重用已经在 CircleCI 中定义的 ruby 安装步骤，这样我们就可以使用<code class="du ln lo lp jq b">ruby/install-deps</code>调用每个作业中的所有命令来在 CircleCI 中安装 ruby。</p><p id="63e3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">关于<code class="du ln lo lp jq b">orbs</code>的更多信息可以在<a class="ae jd" href="https://circleci.com/docs2/2.0/orb-intro" rel="noopener ugc nofollow" target="_blank"> CircleCI 文档 Orbs 简介</a>中找到。下面是 CircleCI 页面中<code class="du ln lo lp jq b">orbs</code>的定义。</p><blockquote class="je jf jg"><p id="04c3" class="if ig jh ih b ii ij ik il im in io ip ji ir is it jj iv iw ix jk iz ja jb jc hb bi translated">orb 是可重用的代码片段，有助于自动化重复的过程，加速项目设置，并使其易于与第三方工具集成。</p></blockquote><p id="5763" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">除了准备<code class="du ln lo lp jq b">config.yml</code>之外，<code class="du ln lo lp jq b">Gemfile</code>也需要更新，因为 CircleCI 需要<code class="du ln lo lp jq b">gem 'rspec_junit_formatter'</code>执行<code class="du ln lo lp jq b">rspec</code>。<code class="du ln lo lp jq b">gem 'rspec_junit_formatter'</code>需要添加在<code class="du ln lo lp jq b">Gemfile</code>的<code class="du ln lo lp jq b">group :development, :test</code>中，如下图。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="2073" class="ju jv hi jq b fi jw jx l jy jz">group :development, :test do<br/>  ....<br/>  gem 'rspec_junit_formatter'<br/>  ....<br/>end</span></pre><p id="a15f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du ln lo lp jq b">config.yml</code>和<code class="du ln lo lp jq b">Gemfile</code>之后，我们可以在 CircleCI dashboard 中看到提交变更并将其推送到 Github repo 之后的管道中有两个作业。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es lt"><img src="../Images/2f82f13ac74f0309a62dac9c744b39fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*803mmp8yE2fzUHWvLjx8Dg.png"/></div></div></figure><p id="0c2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击<code class="du ln lo lp jq b">build</code>作业，我们可以看到在签出代码后有三个步骤:恢复缓存、捆绑包安装、保存缓存，点击<code class="du ln lo lp jq b">test</code>作业，也可以在签出代码后找到这三个作业。这三个步骤是执行<code class="du ln lo lp jq b">ruby/install-deps</code>时将运行的步骤</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mb"><img src="../Images/79f8ab5d94c1ca4c18bbb2cca05b1090.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qibH8O9F556k1vwADD8aDA.png"/></div></div></figure><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mc"><img src="../Images/beee94b32c11ebd9e8aac678a3a5ebed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H2CLNFhMVwRzdv8bd_lfQg.png"/></div></div></figure><p id="d609" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在<code class="du ln lo lp jq b">test</code>作业详情页面中，我们可以看到 RSpec 是在保存缓存后执行的。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es md"><img src="../Images/f90a9766b4ad277e816833ce81062535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rzWoc7fziVgdnCX3JHt_tg.png"/></div></div></figure><p id="616b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">点击这个步骤，我们可以看到所有的 RSpec 测试都已经执行了。因为在这个项目中只有两个测试用例，所以只显示了两个测试结果，但是结果就像在您的本地环境中执行<code class="du ln lo lp jq b">bundle exec rspec</code>一样。而且每次现在有代码变更并推送到 Github repo 的时候，都会触发<code class="du ln lo lp jq b">bundle exec rspec</code>来检查是否有测试用例失败。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es me"><img src="../Images/e71ae353ea32db1e9e0ecb78f8d4a0c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hjQkForV2C8_KuxkbPPBxQ.png"/></div></div></figure><p id="e55c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Ruby 项目的更多配置设置可以在<a class="ae jd" href="https://circleci.com/docs2/2.0/language-ruby" rel="noopener ugc nofollow" target="_blank"> CircleCI 文档语言指南:Ruby </a>中找到。还有更多例子来展示如何在 Ruby 项目中实现 CircleCI。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="6717" class="ju jv hi jq b fi jw jx l jy jz">                       <a class="ae jd" href="#7084" rel="noopener ugc nofollow">Continue</a>｜<a class="ae jd" href="#bd2e" rel="noopener ugc nofollow">Back to Outline</a></span></pre></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h2 id="7084" class="ju jv hi bd kh ki kj kk kl km kn ko kp iq kq kr ks iu kt ku kv iy kw kx ky kz bi translated">在 CircleCI 中设置数据库</h2><p id="4a77" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">如果项目中的数据库不是 SQLite，也可以在 CircleCI 中设置数据库环境。只需要在<code class="du ln lo lp jq b">config.yml</code>中定义数据库的 docker 镜像和环境参数。下面是使用 PostgreSQL 数据库的配置示例。在上述步骤中，运行<code class="du ln lo lp jq b">ruby/install-deps</code>后，将继续运行数据库设置命令。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="6770" class="ju jv hi jq b fi jw jx l jy jz">version: 2.1</span><span id="bc4b" class="ju jv hi jq b fi lq jx l jy jz">orbs:<br/>  ruby: circleci/ruby@1.1.0<br/><br/>jobs:<br/>  build:<br/>    docker:<br/>      - image: cimg/ruby:2.7-node<br/>    steps:<br/>      - checkout<br/>      - ruby/install-deps<br/>  test:<br/>    # parallelism: 3<br/>    docker:<br/>      - image: cimg/ruby:2.7-node<br/>      - image: circleci/postgres:9.5-alpine<br/>        environment:<br/>          POSTGRES_USER: circleci-demo-ruby<br/>          POSTGRES_DB: rails_blog_test<br/>          POSTGRES_PASSWORD: ""<br/>    environment:<br/>      BUNDLE_JOBS: "3"<br/>      BUNDLE_RETRY: "3"<br/>      PGHOST: 127.0.0.1<br/>      PGUSER: circleci-demo-ruby<br/>      PGPASSWORD: ""<br/>      RAILS_ENV: test<br/>    steps:<br/>      - checkout<br/>      - ruby/install-deps<br/>      - run:<br/>          name: Wait for DB<br/>          command: dockerize -wait tcp://localhost:5432 -timeout 1m<br/>      - run:<br/>          name: Database setup<br/>          command: bundle exec rails db:schema:load --trace<br/>      # Run rspec in parallel<br/>      - ruby/rspec-test</span><span id="5e4f" class="ju jv hi jq b fi lq jx l jy jz">workflows:<br/>  version: 2<br/>  build_and_test:<br/>    jobs:<br/>      - build<br/>      - test:<br/>          requires:<br/>            - build</span></pre><p id="ccfc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在示例配置的<code class="du ln lo lp jq b">test</code>作业运行结果中，我们可以看到 PostgreSQL 数据库正在使用的 docker 映像，以及设置数据库的两个步骤——等待数据库和数据库设置——已经执行。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div class="er es mf"><img src="../Images/17ab18fc5e90ece4b2fb022735c44897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/format:webp/1*ABQ4AcQ1dKAmm68pPWG7eA.png"/></div></figure><p id="1016" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">单击这两个步骤，我们可以看到 PostgreSQL 数据库中的表创建日志。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mg"><img src="../Images/894ac57d25b801772a1f6c25a43d846f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QCGZ_qJEc_0ygSxajjXtDA.png"/></div></div></figure><p id="db47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更多数据库配置示例可在<a class="ae jd" href="https://circleci.com/docs/2.0/postgres-config" rel="noopener ugc nofollow" target="_blank"> CircleCI 文档数据库配置示例</a>中找到。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="ed13" class="ju jv hi jq b fi jw jx l jy jz">                       <a class="ae jd" href="#4e9b" rel="noopener ugc nofollow">Continue</a>｜<a class="ae jd" href="#bd2e" rel="noopener ugc nofollow">Back to Outline</a></span></pre></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h2 id="4e9b" class="ju jv hi bd kh ki kj kk kl km kn ko kp iq kq kr ks iu kt ku kv iy kw kx ky kz bi translated">在 CircleCI 配置中应用带参数的可重用命令</h2><p id="fb70" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">如果需要在不同的作业或步骤中运行命令，但必须传递不同的参数，CircleCI 支持我们用参数定义自定义命令。我们可以在运行所有作业之前打印问候词，部分问候词取决于我们在不同作业中传递给参数的内容。示例配置如下。有一个用参数<code class="du ln lo lp jq b">to</code>定义的问候命令，参数<code class="du ln lo lp jq b">to</code>有默认值<code class="du ln lo lp jq b">world</code>，在<code class="du ln lo lp jq b">build</code>作业中，问候命令在<code class="du ln lo lp jq b">to</code>值为<code class="du ln lo lp jq b">build</code>的步骤中。问候命令也显示在<code class="du ln lo lp jq b">test</code>作业中，并且<code class="du ln lo lp jq b">to</code>值为<code class="du ln lo lp jq b">test</code>。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="365b" class="ju jv hi jq b fi jw jx l jy jz">version: 2.1</span><span id="9620" class="ju jv hi jq b fi lq jx l jy jz">orbs:<br/>  ruby: circleci/ruby@1.1.0</span><span id="a817" class="ju jv hi jq b fi lq jx l jy jz">commands: # a reusable command with parameters<br/>  greeting:<br/>    parameters:<br/>      to:<br/>        default: "world"<br/>        type: string<br/>    steps:<br/>      - run: echo "Hello &lt;&lt;parameters.to&gt;&gt;"<br/>jobs:<br/>  build:<br/>    docker:<br/>      - image: cimg/ruby:2.7-node<br/>    steps:<br/>      - greeting:<br/>          to: "build"<br/>      - checkout<br/>      - ruby/install-deps<br/>  test:<br/>    docker:<br/>      - image: cimg/ruby:2.7-node<br/>    steps:<br/>      - greeting: <br/>          to: "test"<br/>      - checkout<br/>      - ruby/install-deps<br/>      # Run rspec in parallel<br/>      - ruby/rspec-test</span><span id="c071" class="ju jv hi jq b fi lq jx l jy jz">workflows:<br/>  version: 2<br/>  build_and_test:<br/>    jobs:<br/>      - build<br/>      - test:<br/>          requires:<br/>            - build</span></pre><p id="390c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在示例配置的结果中，在<code class="du ln lo lp jq b">build</code>和<code class="du ln lo lp jq b">test</code>作业中，问候语命令都被执行，它们打印出问候语，以及我们传递给参数<code class="du ln lo lp jq b">to</code>的内容</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mh"><img src="../Images/71ced114fad46d66f95fb05d7082f33e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/1*mEWe6ZZhZwMcr0OmbTk0zg.png"/></div></div></figure><figure class="jl jm jn jo fd lg er es paragraph-image"><div class="er es mi"><img src="../Images/b93fbd06e7bedcf32e2ea23fc84af217.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*yl5V7_bzpEFzYL7_uC_dPA.png"/></div></figure><p id="6e7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CircleCI 文档中有更多关于可重用配置的细节和例子。该信息可在<a class="ae jd" href="https://circleci.com/docs/2.0/reusing-config" rel="noopener ugc nofollow" target="_blank"> CircleCI 可重用配置参考指南</a>中找到。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="c852" class="ju jv hi jq b fi jw jx l jy jz">                      <a class="ae jd" href="#c7f1" rel="noopener ugc nofollow">Continue</a>｜<a class="ae jd" href="#bd2e" rel="noopener ugc nofollow">Back to Outline</a></span></pre></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h2 id="c7f1" class="ju jv hi bd kh ki kj kk kl km kn ko kp iq kq kr ks iu kt ku kv iy kw kx ky kz bi translated">调试电路错误</h2><p id="0237" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">如果作业失败，我们可以单击作业并查看更多信息。大多数时候，这些信息对我们调试来说是足够清楚的。就像下面的捆绑包安装错误一样，它清楚地表明失败是由错误的 gem 版本引起的。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mj"><img src="../Images/03aa33e1d1d19ae3c5212913be5ea52a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mx4yqdVAXz5g8a62nL5Mvw.png"/></div></div></figure><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mk"><img src="../Images/26dd9f345abf26daebea425fc33ee224.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZmJzBNvUGZPeCMnYw3Pcmw.png"/></div></div></figure><p id="80fa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是有时错误信息可能不够清晰，我们无法知道失败的根本原因，另一种调试方法是使用<code class="du ln lo lp jq b">Rerun Job with SSH</code>。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es ml"><img src="../Images/2fc228f927df31cc8af38a20c5dcca20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MURU2Bll4fDexk4UjENucA.png"/></div></div></figure><p id="2b1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当点击<code class="du ln lo lp jq b">Rerun Job with SSH</code>时，CircleCI 将准备一个远程虚拟机，该虚拟机与您执行的失败作业的环境完全相同。我们可以看到，在“等待 SSH 会话”步骤中，为我们提供了一个访问机器的命令。</p><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="bf1b" class="ju jv hi jq b fi jw jx l jy jz">ssh -p 64535 3.95.238.182</span></pre><figure class="jl jm jn jo fd lg er es paragraph-image"><div class="er es mm"><img src="../Images/64c66cc7267bd8fac34a8bef5bea24df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*MkBG3_XP4kEBy83q4zkgHw.png"/></div></figure><p id="00d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过在本地控制台中键入命令，您可以成功登录到机器。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mn"><img src="../Images/32f44c985917134d62493bd66b103f10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ys7MY3V45-HHyExfo7B6pQ.png"/></div></div></figure><p id="76a3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到项目文件夹，我们可以看到内容与您的 Github 项目完全相同，然后我们可以在 CircleCI 的失败作业中运行该命令以查看更多信息。</p><figure class="jl jm jn jo fd lg er es paragraph-image"><div role="button" tabindex="0" class="lh li di lj bf lk"><div class="er es mo"><img src="../Images/51811f4f8c09d0258e7d2fb335543324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fmiIhJiI8xtotADPUzY8mw.png"/></div></div></figure><pre class="jl jm jn jo fd jp jq jr js aw jt bi"><span id="fd71" class="ju jv hi jq b fi jw jx l jy jz">                           <a class="ae jd" href="#bd21" rel="noopener ugc nofollow">Back to Outline</a></span></pre></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h2 id="971a" class="ju jv hi bd kh ki kj kk kl km kn ko kp iq kq kr ks iu kt ku kv iy kw kx ky kz bi translated">参考</h2><p id="3c25" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated"><a class="ae jd" href="https://circleci.com/docs" rel="noopener ugc nofollow" target="_blank"> CircleCI 文档</a></p><ul class=""><li id="bfed" class="mp mq hi ih b ii ij im in iq mr iu ms iy mt jc mu mv mw mx bi translated"><a class="ae jd" href="https://circleci.com/docs/2.0/config-intro" rel="noopener ugc nofollow" target="_blank">配置介绍</a></li><li id="933b" class="mp mq hi ih b ii my im mz iq na iu nb iy nc jc mu mv mw mx bi translated"><a class="ae jd" href="https://circleci.com/docs2/2.0/language-ruby" rel="noopener ugc nofollow" target="_blank">语言指南:Ruby </a></li><li id="209e" class="mp mq hi ih b ii my im mz iq na iu nb iy nc jc mu mv mw mx bi translated"><a class="ae jd" href="https://circleci.com/docs/2.0/reusing-config" rel="noopener ugc nofollow" target="_blank">可重用配置参考指南</a></li><li id="5dde" class="mp mq hi ih b ii my im mz iq na iu nb iy nc jc mu mv mw mx bi translated"><a class="ae jd" href="https://circleci.com/docs2/2.0/orb-intro" rel="noopener ugc nofollow" target="_blank">宝珠介绍</a></li><li id="c716" class="mp mq hi ih b ii my im mz iq na iu nb iy nc jc mu mv mw mx bi translated"><a class="ae jd" href="https://circleci.com/docs/2.0/postgres-config" rel="noopener ugc nofollow" target="_blank">数据库配置示例</a></li></ul><p id="380d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://www.atlassian.com/continuous-delivery/continuous-integration" rel="noopener ugc nofollow" target="_blank">什么是持续集成，为什么它很重要？</a></p><p id="661c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://circleci.com/blog/how-to-set-up-a-continuous-integration-pipeline-for-a-rails-dual-boot/" rel="noopener ugc nofollow" target="_blank">如何为 Rails 双引导设置持续集成管道</a></p><p id="60bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://pawelurbanek.com/rails-continuous-integration" rel="noopener ugc nofollow" target="_blank">使用 CircleCI 持续集成和部署 Rails】</a></p><p id="5d1a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://smartbear.com/blog/top-continuous-integration-tools-for-devops/" rel="noopener ugc nofollow" target="_blank">devo PS 的 7 大持续集成工具</a></p><figure class="jl jm jn jo fd lg"><div class="bz dy l di"><div class="nd ne l"/></div></figure></div></div>    
</body>
</html>