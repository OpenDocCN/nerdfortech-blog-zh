# 利用密钥制作者的知识掌握 SSH 密钥

> 原文：<https://medium.com/nerd-for-tech/ssh-likeapro-d476dcd9beaa?source=collection_archive---------13----------------------->

在部署应用程序一段时间后，您已经使用 SSH 接入了至少几台服务器的命令行。也许你用密码，也许你用钥匙。然后你开始想，我应该对每个服务器使用一个密钥文件还是每个服务器使用一个密钥？我如何安全地跟踪所有的密钥？钥匙本身安全吗？

![](img/69e2e45fb50f0d9d35f007899deb5164.png)

本文旨在回答所有这些问题以及更多问题。读完之后，你会对 SSH 有一个更完整的了解和一些最佳实践。

# 🔒锁

> 安全外壳(SSH)协议是通过不安全网络[ [src](https://datatracker.ietf.org/doc/html/rfc4251) ]进行安全远程登录
> 和其他安全网络服务的协议

SSH 运行在应用层(第 7 层)。这是 HTTP、HTTPS、FTP 和 DNS 运行的同一层。每个协议在特定的端口上运行，SSH 在端口 22 上运行。端口 22 用作非安全门。SSH 是锁定的门把手，只允许某些授权用户进入。如果你有兴趣了解更多关于 OSI 模型各层的知识，请观看[这段视频](https://invidious.tube/watch?v=7IS7gigunyI)。

SSH 是 Telnet(另一种应用层协议)的急需的、更安全的替代品。Telnet 允许使用网络控制程序(NCP)和后来的传输控制协议(TCP)在端口 23 上建立连接。1969 年创建时，它被用于连接大学、大公司和政府中同一局域网(LAN)上的计算机。

互联网的崛起一旦到来，Telnet 的安全漏洞就开始显现。最大的缺点是 Telnet 默认不加密任何数据。密码等秘密被公开传输，任何嗅探信息包的人都可以截获这些秘密。此外，没有验证客户端和服务器之间的通信的身份验证，这意味着任何发送的数据都不能保证到达预期的目的地。你可以把这比作 HTTP 对 HTTPS。(强烈建议不要在没有 HTTPS 的网站上输入凭据。)1995 年，SSH 应运而生，并迅速成为事实上的标准。

既然我们已经知道了 SSH 的起源以及它试图解决的问题，那么是时候动手了。

# 🔑创建密钥

首先，我们需要使用`ssh-keygen`创建密钥文件。这把钥匙是我们 SSH 锁的钥匙。使用密码访问服务器是不安全的，可以使用 Kali Linux 和 Hydra[[src](https://null-byte.wonderhowto.com/how-to/gain-ssh-access-servers-by-brute-forcing-credentials-0194263/)][[src](https://linuxconfig.org/ssh-password-testing-with-hydra-on-kali-linux)]进行暴力破解。延缓这种攻击的一种方法是改变 SSH 运行的端口。然而，这是靠默默无闻获得的安全感。它实际上并没有使服务器更加安全，它只是把信息抽象化了。这从来都不是一个好的习惯，所以我们将会更深入地研究这些键。

## Keygen

`ssh-keygen`可以创建供 SSH 协议版本 2 使用的密钥。默认情况下，密钥将在`~/.ssh`目录中生成。除非你有很强的理由，否则把你的钥匙放在这个文件夹里是一个好习惯。另一个默认值是文件名。默认名称为`id_`，后跟指定的加密算法名称。我们可以用`-f`标志改变默认文件名。将密钥文件的名称作为应用程序的名称是有意义的。

这将在`~/.ssh`目录中创建两个文件，一个私钥`test_key`和一个公钥`test_key.pub`。

这回答了一个密钥用于所有内容还是一个密钥用于每个服务器的问题。最好有责任分离。你(希望)不会在所有事情上使用相同的密码。不要什么都用同一个钥匙。也许有人拿到了钥匙。如果您对许多服务器使用一个密钥，另一个人现在也可以访问所有这些服务器。这是导致灾难的原因。

不要和任何人分享你的钥匙。为每个用户创建一个密钥文件并不需要太多资源。这样你就可以看到谁访问了服务器的日志。使用单独的密钥还使您能够撤销个人的密钥，而不必为其他所有人重新颁发新的密钥。

## 加密算法

我们知道如何通过拥有自己的密钥文件而不共享来保证密钥文件的安全，但是密钥本身的安全性如何呢？OpenSSH 支持六种算法。

*   🚨 **DSA(数字签名算法)**是数字签名的联邦信息处理标准。它的安全性依赖于一个离散对数问题。与 RSA 相比，DSA 的签名生成速度更快，但验证速度较慢。如果使用了错误的数字生成器，安全性可能会被破坏。从版本 7 开始，OpenSSH 不再支持它。
*   ⚠️**RSA(rivest–sha mir–ad leman)**是首批公钥密码系统之一，广泛用于安全数据传输。它的安全性依赖于整数分解，所以不需要安全的 RNG(随机数发生器)。与 DSA 相比，RSA 的签名验证速度更快，但生成速度较慢。建议密钥大小为 3072 或 4096。1024 位以下的都是不安全的。
*   🤔 **ECDSA(椭圆曲线数字签名算法)**是 DSA(数字签名算法)的椭圆曲线实现。椭圆曲线加密能够以较小的密钥提供与 RSA 相当的安全级别。它还具有 DSA 对坏 RNG 敏感的缺点。
*   ✅ **Ed25519** ，是 EdDSA 签名方案，但是使用 SHA-512/256 和 Curve25519。这是一条安全的椭圆曲线，比 DSA、ECDSA 和 EdDSA 提供了更好的安全性，并且具有更好的性能(人类无法察觉)。这是最值得推荐的公钥算法。
*   ECDSA 和 Ed25519 的-sk 版本用于 U2F/FIDO 器件。

[](https://askubuntu.com/questions/363207/what-is-the-difference-between-the-rsa-dsa-and-ecdsa-keys-that-ssh-uses) [## ssh 使用的 RSA、DSA 和 ECDSA 密钥有什么区别？

### 你需要所有的吗？不，您的 ssh 服务器只需要一个，客户端只需要支持这一种类型的密钥…

askubuntu.com](https://askubuntu.com/questions/363207/what-is-the-difference-between-the-rsa-dsa-and-ecdsa-keys-that-ssh-uses) 

除了加密算法，KDF(密钥派生函数)对于创建强密钥也很重要。KDF 是一种加密散列函数，它使用伪随机函数从诸如主密钥、口令或密码短语之类的秘密值中导出一个或多个秘密密钥。数字越大，验证速度越慢，但更能抵抗暴力攻击。

## 产生

*   `-a`:指定使用的 KDF(密钥推导函数)轮数。
*   `-b`:指定位数。ED25519 密钥长度固定，并且`-b`标志将被忽略。
*   `-C`:指定注释。一个好的做法是评论密钥创建者的电子邮件。如果没有指定注释，默认注释将是`username@hostname`。其中用户是 t
*   `-f`:指定密钥文件的文件名。
*   `-N`:提供新的密码。
*   `-o`:使用新的 OpenSSH 格式保存密钥，而不是 PEM。这种新格式增强了对暴力攻击的抵抗力。Ed25519 密钥始终使用新的私钥格式。
*   `-t`:指定要创建的密钥类型。

 [## ssh-keygen linux 命令手册页

### 部分:用户命令(1)索引返回主要内容 BSD mandoc ssh-keygen -认证密钥生成…

www.commandlinux.com](https://www.commandlinux.com/man-page/man1/ssh-keygen.1.html) 

我们将生成一个文件名为`application`的密钥。它将有一个类型`ed25519`，它将被散列 100 次。我们正在设置一个`password`的密码。最后，它会有一个注释`starlightromero@protonmail.com`。

新创建的密钥将在`.ssh`目录中。私钥`~/.ssh/application`和公钥`~/.ssh/application.pub`。确保将您的密码保存在安全、自由的离线密码管理器中，如 [KeePassXC](https://keepassxc.org/) 。

## 许可

运行命令`ls -la ~/.ssh`允许我们查看为`~/.ssh`目录中的所有文件设置的权限。默认情况下，权限如下:

*   🕵️私钥(`application` ): `-rw-------`
*   🚻公钥(`application.pub` ): `-rw-r--r--`

过去，当我在 Windows 上运行 Linux 子系统时，默认情况下权限设置并不总是正确的。如果您遇到这种情况，首先确保使用以下配置选项编辑您的 WSL 配置文件`/etc/wsl.conf`:

然后，您必须通过运行`wsl --shutdown`来重启 Linux 子系统。

现在回到权限。使用以下命令修改文件权限:

命令`chmod`“更改模式”，允许我们更改文件的权限或访问“模式”。三位数的每一位按以下顺序代表一个组:

*   👨用户
*   👨‍👩‍👧‍👦组
*   👨‍🦲👨‍🦰👨‍🦱👨‍🦳其他

。每个权限对应一个数字:

*   📖阅读:4
*   ✏️写道:2
*   👟执行:1

如果您不希望特定的组拥有该权限，请在该位置输入零。将这些数字相加后，就是特定权限组的数字。

我们希望私钥对用户具有读写权限:

公钥应该具有用户的读写权限，以及组和其他用户的读取权限:

现在运行`ls -la ~/.ssh`应该显示正确的权限。

# 🔓使用 SSH

已经安全地生成了密钥，并且已经设置了正确的权限。现在，我们可以使用以下命令 ssh 到服务器:

其中，`-i`标志代表身份文件(私有密钥文件)的路径，`starlight`代表用户，`127.0.0.1`代表您试图通过 ssh 访问的 IP 地址。这些值需要进行更改以满足您的需求。系统将提示您输入密码。输入密码后我们就进去了！在进入下一部分之前，继续执行`logout`。

# 🔐管理密钥

现在我们知道了如何生成密钥和使用 ssh。我们如何管理不同应用程序的所有密钥？通过在我们的`.ssh`目录中创建一个`config`文件，我们可以创建对服务器主机名以及其他规范的变量引用。一旦我们手头有了更多的 ssh 密钥文件，这将使事情变得更容易。

在编辑器中打开文件，`vim ~/.ssh/config`。

第 1 行允许我们指定所有主机的配置。我们希望确保为所有主机向 ssh-agent 添加密钥。`AddKeysToAgent`允许我们每次会话只输入一次密码，而不是每次使用密钥文件。`IdentitiesOnly`允许我们覆盖 ssh-agents 的默认设置，即如果我们没有指定密钥文件，就尝试我们所有的私有密钥。如果我们没有提供一个标识文件(keyfile ),而服务器有一个设置，那么如果命令失败会比我们所有的密钥都被尝试并潜在地收到一个`Too many authentications failures`错误要好。`Port`很简单。它允许我们为所有主机设置默认的 ssh 端口。我们将默认端口设置为`22`。

对于我们的服务器特定配置，我们移到第 6 行。我们从定义一个`Host`开始。然后我们定义一个`HostName`，它是服务器的 IP 地址。`User`是我们要用来 ssh 到指定 IP 地址的用户名。通常，在命令行中您会看到这两个是，`ssh user@hostname`。最后，我们想要指定一个到我们的`IdentityFile`的绝对路径。

好的，很好，但是所有这些配置实际上都做了什么？保存文件后，运行命令`ssh application`，其中`application`是您在`config`中指定的`Host`。我们输入密码，我们就进去了！而不是记住密钥文件的位置、用户名、主机名等。我们可以输入一个简单的名字，比如`application`，然后访问我们的服务器。

![](img/ba13b305f517f928e89ca98567f34c20.png)

从这里开始，用[钥匙制造者](https://matrix.fandom.com/wiki/The_Keymaker)的知识前进。为所有服务器创建密钥。使用安全的、加密的、受密码保护的、有组织的密钥 SSH 到您的所有服务器。

> 只有那个人能开门。只有在这段时间里，那扇门才能打开。