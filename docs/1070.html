<html>
<head>
<title>Online Schema Migration with MySQL on GCP (Cloud SQL)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在GCP上使用MySQL进行在线模式迁移(云SQL)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/online-schema-migration-with-mysql-on-gcp-cloud-sql-70c02195e2d2?source=collection_archive---------6-----------------------#2021-03-03">https://medium.com/nerd-for-tech/online-schema-migration-with-mysql-on-gcp-cloud-sql-70c02195e2d2?source=collection_archive---------6-----------------------#2021-03-03</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="89de" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一篇关于在Cloud SQL上使用MySQL尝试在线模式迁移的笔记。我尝试了这两种工具:</p><ul class=""><li id="bbcd" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">pt-在线-模式-更改</li><li id="06f8" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">gh-ost</li></ul><h1 id="194a" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">条款</h1><p id="b6eb" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我在以下条件下用MySQL测试了它们:</p><ul class=""><li id="cb0c" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">云SQL第二代</li><li id="bb1b" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">MySQL版本5.7(截至本文撰写时默认)</li><li id="b815" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae ku" href="https://cloud.google.com/sql/docs/mysql/backup-recovery/pitr" rel="noopener ugc nofollow" target="_blank">启用二进制日志记录</a></li><li id="0b10" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">通过<a class="ae ku" href="https://cloud.google.com/sql/docs/mysql/sql-proxy" rel="noopener ugc nofollow" target="_blank">云SQL代理</a>访问</li></ul><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/321fab4c91acf4a732f26d283f925a6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*llQPKTrD6OmjCIL4ubt-nQ.jpeg"/></div></div></figure><h1 id="232e" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><a class="ae ku" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html" rel="noopener ugc nofollow" target="_blank">在线DDL </a></h1><p id="9cc8" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">执行在线迁移时，首先想到的是<a class="ae ku" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html" rel="noopener ugc nofollow" target="_blank">在线DDL </a>。但是，有<a class="ae ku" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-limitations.html" rel="noopener ugc nofollow" target="_blank">限制</a>。</p><p id="d696" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在线DDL的主要优势是你不需要依赖任何额外的工具，因为MySQL为你提供了所有的工具。在某些情况下，您可以访问正在迁移的表(并发DML ),并执行不需要大量磁盘空间或I/O的就地迁移。</p><p id="a30f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，关于在线DDL有一个主要的问题:即使你用<code class="du lh li lj lk b">LOCK=None</code>运行一个查询，MySQL也只能在主服务器上在线执行，阻止副本应用DML，直到主服务器完成你的DDL。因此，在大型表上运行DDL会导致显著的复制延迟。</p><p id="8ffd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，无法限制或暂停迁移过程，因此无法控制主服务器上的负载。</p><p id="1e6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些问题不是Cloud SQL特有的，而是MySQL (InnoDB)普遍存在的。</p><p id="ee72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您不关心加载或复制延迟，在线DDL可能是一个不错的选择，但是如果您运行的服务提供更高的服务级别，这种情况就不常见了。因此，我最近试用了两个在线迁移工具，看看它们是否可以用于云SQL。</p><h1 id="a75c" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><a class="ae ku" href="https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html" rel="noopener ugc nofollow" target="_blank">pt-online-schema-change(pt-OSC)</a></h1><p id="5e9e" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">Percona的pt-osc是一个在线模式迁移工具，已经流行了很多年。</p><p id="e5c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它用所需的模式创建一个新表，然后开始从原始表中复制行。它还创建触发器来镜像在迁移到新表的过程中原始表中发生的更改。最后，pt-osc重命名该表，在原始表和新表之间切换。</p><h2 id="aaaf" class="ll js hi bd jt lm ln lo jx lp lq lr kb iq ls lt kf iu lu lv kj iy lw lx kn ly bi translated">使用云SQL运行pt-osc</h2><p id="854c" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">当我尝试使用Cloud SQL运行pt-osc时，我必须注意以下几点。</p><p id="058e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1) </strong> <code class="du lh li lj lk b"><strong class="ih hj">log_bin_trust_function_creators</strong></code> <strong class="ih hj">必须启用</strong></p><p id="a141" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当pt-osc创建触发器时，它需要一个拥有超级权限的用户，但是<a class="ae ku" href="https://cloud.google.com/sql/faq#grantall" rel="noopener ugc nofollow" target="_blank">这在Cloud SQL </a>中是不可能的。相反，您可以在实例中启用<code class="du lh li lj lk b"><a class="ae ku" href="https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#sysvar_log_bin_trust_function_creators" rel="noopener ugc nofollow" target="_blank">log_bin_trust_function_creators</a></code>来允许所有用户创建存储函数和触发器。你可以在这里找到如何更改云SQL <a class="ae ku" href="https://cloud.google.com/sql/docs/mysql/flags" rel="noopener ugc nofollow" target="_blank">上的数据库标志。</a></p><p id="94bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2)用</strong>明确指定副本<code class="du lh li lj lk b"><strong class="ih hj">--check-slave-lag</strong></code></p><p id="aa39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pt-osc监控复制延迟，如果检测到大于<code class="du lh li lj lk b">--max-lag</code>的延迟，则暂停并调节自身。默认情况下，pt-osc试图通过在主服务器上运行<code class="du lh li lj lk b">SHOW SLAVE HOSTS</code>和<code class="du lh li lj lk b">SHOW PROCESSLIST</code>来寻找副本。但是，只要您让pt-osc通过云SQL代理连接到MySQL服务器，pt-osc就应该无法访问从MySQL服务器检索到的主机信息。您会看到以下警告消息:</p><pre class="kw kx ky kz fd lz lk ma mb aw mc bi"><span id="9aed" class="ll js hi lk b fi md me l mf mg">No slaves found. See — recursion-method if host localhost has slaves.<br/>Not checking slave lag because no slaves were found and — check-slave-lag was not specified.</span></pre><p id="84d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">pt-osc提供了一种显式传递副本主机信息的方式。我可以通过添加一个类似于<code class="du lh li lj lk b">—-check-salve-lag D=foo,h=127.0.0.1,P=33001</code>的标志让它识别复制品。要查看这是否成功，您可以检查日志。</p><pre class="kw kx ky kz fd lz lk ma mb aw mc bi"><span id="7df0" class="ll js hi lk b fi md me l mf mg">Will check slave lag on:<br/>localhost -&gt; 127.0.0.1:33001</span></pre><p id="614e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">pt-OSC命令执行示例</strong></p><pre class="kw kx ky kz fd lz lk ma mb aw mc bi"><span id="de4e" class="ll js hi lk b fi md me l mf mg">$ pt-online-schema-change \<br/>  --alter=“DROP COLUNN bar ”D=test,t=foo,h=127.0.0.1,P=33000,u=root,p=pass \<br/>  --check-slave-lag="D=test,h=127.0.0.1,P=33001,u=root,p=pass" \<br/>  --print \<br/>  --execute</span></pre><h1 id="a96d" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated"><a class="ae ku" href="https://github.com/github/gh-ost" rel="noopener ugc nofollow" target="_blank"> gh-ost </a></h1><p id="872c" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">gh-ost被设计成无触发器的，以避免由触发器引起的问题。你可以在这里看到<a class="ae ku" href="https://github.com/github/gh-ost/blob/master/doc/why-triggerless.md" rel="noopener ugc nofollow" target="_blank"/>触发器会导致什么样的问题。</p><p id="6047" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">gh-ost的在线迁移是这样进行的:gh-ost创建一个具有所需模式的新表，并将原始表中的行复制到新表中。为了将原始表中发生的更改镜像到新表中，gh-ost连接到MySQL服务器并接收binlog事件，就像它是一个副本服务器一样。然后，它从binlog事件中提取更改，并将它们应用到主数据库中的新表。最后，它执行被称为切换的最后阶段，在那里它交换表。</p><p id="1c8c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于无触发设计，gh-ost为<a class="ae ku" href="https://github.com/github/gh-ost/blob/master/doc/throttle.md" rel="noopener ugc nofollow" target="_blank">提供了更灵活的节流</a>和<a class="ae ku" href="https://github.com/github/gh-ost/blob/master/doc/interactive-commands.md" rel="noopener ugc nofollow" target="_blank">一些交互式命令</a>，可以在不暂停迁移过程的情况下控制其行为。</p><h2 id="767b" class="ll js hi bd jt lm ln lo jx lp lq lr kb iq ls lt kf iu lu lv kj iy lw lx kn ly bi translated">使用云SQL运行gh-ost</h2><p id="7950" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">当我尝试使用Cloud SQL运行gh-ost时，我必须注意以下几点。</p><p id="72d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 1)用</strong> <code class="du lh li lj lk b"><strong class="ih hj">--allow-on-master</strong></code> <strong class="ih hj">标志</strong>运行</p><p id="c101" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于gh-ost，建议从副本服务器读取binlog事件，以减少主服务器的负载。它还提供了一种安全测试迁移过程的方法，通过让gh-ost连接到副本服务器(使用<code class="du lh li lj lk b">— migrate-on-replica</code>或<code class="du lh li lj lk b">--test-on-replica</code>选项)，您不必接触主服务器。</p><p id="8d4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，由于<a class="ae ku" href="https://cloud.google.com/sql/docs/mysql/replication#rr-info" rel="noopener ugc nofollow" target="_blank">云SQL不允许创建副本</a>的副本，因此无法让gh-ost使用云SQL从副本接收二进制日志。(<a class="ae ku" href="https://github.com/github/gh-ost/issues/770#issuecomment-517305392" rel="noopener ugc nofollow" target="_blank">就像这里提到的</a>，使用外部副本也是可能的)</p><p id="04d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要让gh-ost连接到主机，需要<code class="du lh li lj lk b">--allow-on-master</code>标志。更多详情请参见本文件。</p><p id="124b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2)带着</strong> <code class="du lh li lj lk b"><strong class="ih hj">--gcp</strong></code> <strong class="ih hj">旗跑</strong></p><p id="5148" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在没有<code class="du lh li lj lk b">--gcp</code>选项的情况下，通过云SQL代理运行时，我遇到了以下错误:</p><pre class="kw kx ky kz fd lz lk ma mb aw mc bi"><span id="98dc" class="ll js hi lk b fi md me l mf mg">FATAL Unexpected database port reported: 3306</span></pre><p id="5d6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae ku" href="https://github.com/github/gh-ost/blob/master/doc/command-line-flags.md#gcp" rel="noopener ugc nofollow" target="_blank">文档说它是用于第一代</a>，但是如果您通过隧道连接运行它<a class="ae ku" href="https://github.com/github/gh-ost/issues/631#issuecomment-431639248" rel="noopener ugc nofollow" target="_blank">(即，如果为连接指定的端口不同于实际服务的端口)</a>，它似乎是必需的。</p><p id="2cbb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">GH-ost命令执行示例</strong></p><pre class="kw kx ky kz fd lz lk ma mb aw mc bi"><span id="63a6" class="ll js hi lk b fi md me l mf mg">$ gh-ost \<br/>  --max-load=Threads_running=25 \<br/>  --critical-load=Threads_running=1000 \<br/>  --chunk-size=1000 \<br/>  --throttle-control-replicas=127.0.0.1:33001 \<br/>  --max-lag-millis=3000 \<br/>  --user=root \<br/>  --password=pass \<br/>  --host=127.0.0.1 \<br/>  --port=33000 \<br/>  --allow-on-master \<br/>  --database=test \<br/>  --table=foo \<br/>  --verbose \<br/>  --alter="DROP COLUMN bar" \<br/>  --default-retries=120 \<br/>  --panic-flag-file=/tmp/host.panic.flag \<br/>  --serve-socket-file=/tmp/ghost.test.foo.sock \<br/>  --gcp \<br/>  --execute</span></pre><h1 id="ebe1" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">编后记</h1><p id="7cca" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">我发现这两个工具都可以与云SQL一起工作。下一步是在我的生产环境中运行它。如果我在整个操作过程中发现任何特定于云SQL和模式迁移的问题，我将更新此注释。</p><p id="e231" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">引用作品:</p><ul class=""><li id="5d0d" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated"><a class="ae ku" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html" rel="noopener ugc nofollow" target="_blank"> MySQL 5.7在线DDL操作</a></li><li id="b907" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae ku" href="https://bugs.mysql.com/bug.php?id=73196" rel="noopener ugc nofollow" target="_blank">错误#73196允许在主服务器和从服务器上同时运行ALTER TABLE</a></li><li id="5b41" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae ku" href="https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html" rel="noopener ugc nofollow" target="_blank">pt-在线-模式-改变</a></li><li id="0228" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae ku" href="https://www.percona.com/blog/2016/07/01/pt-online-schema-change-amazon-rds/" rel="noopener ugc nofollow" target="_blank">亚马逊RDS和pt-online-schema-change </a></li><li id="99c4" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae ku" href="https://github.com/github/gh-ost/blob/master/doc/why-triggerless.md" rel="noopener ugc nofollow" target="_blank">为什么无触发？</a></li><li id="7cad" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae ku" href="https://github.com/github/gh-ost/issues/770" rel="noopener ugc nofollow" target="_blank">运行在谷歌云SQL上</a></li><li id="b7ba" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae ku" href="https://github.com/github/gh-ost/blob/master/doc/cheatsheet.md" rel="noopener ugc nofollow" target="_blank"> gh-ost备忘单</a></li><li id="cc9c" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated"><a class="ae ku" href="https://github.com/github/gh-ost/issues/631" rel="noopener ugc nofollow" target="_blank">在非标准mysql端口上通过ssh隧道使用gh-ost？【问题】#631 </a></li></ul></div></div>    
</body>
</html>