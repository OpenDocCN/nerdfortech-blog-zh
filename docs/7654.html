<html>
<head>
<title>How to Run Containers in the Same PID Namespace?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在同一个 PID 名称空间中运行容器？</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-run-containers-in-the-same-pid-namespace-cd67983516be?source=collection_archive---------2-----------------------#2022-12-25">https://medium.com/nerd-for-tech/how-to-run-containers-in-the-same-pid-namespace-cd67983516be?source=collection_archive---------2-----------------------#2022-12-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="06e9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">容器隔离和 PID 名称空间概述</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/f5285c20293a96bda0b96266ca0de825.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G7yx3xB6zA_6GXrSu3ZWVA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">来自:<a class="ae jn" href="https://www.docker.com/resources/what-container/" rel="noopener ugc nofollow" target="_blank"> Docker Docs </a></figcaption></figure><h2 id="0724" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">容器隔离概述</h2><p id="8bb4" class="pw-post-body-paragraph km kn hi ko b kp kq ij kr ks kt im ku jz kv kw kx kd ky kz la kh lb lc ld le hb bi translated">使用名称空间和 cgroups 将容器与主机内核隔离开来。</p><p id="63ad" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated"><strong class="ko hj">名称空间:</strong>限制每个进程可以看到的内容(例如—其他进程、用户、文件系统)<br/>T5】Cgroups:限制进程的资源使用(例如— RAM、磁盘、CPU)</p><h2 id="5c1f" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">Linux 内核名称空间:</h2><p id="3812" class="pw-post-body-paragraph km kn hi ko b kp kq ij kr ks kt im ku jz kv kw kx kd ky kz la kh lb lc ld le hb bi translated">名称空间是 Linux 内核的一个特性，它对内核资源进行分区，使得一组进程看到一组资源，而另一组进程看到一组不同的资源。</p><h2 id="084e" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">命名空间的类型:</h2><p id="22d4" class="pw-post-body-paragraph km kn hi ko b kp kq ij kr ks kt im ku jz kv kw kx kd ky kz la kh lb lc ld le hb bi translated"><strong class="ko hj"> PID 名称空间:</strong>这种类型的名称空间将进程相互隔离。一个进程看不到其他进程，而且同一个进程 ID 可以存在于多个名称空间中。比如— <strong class="ko hj">进程 ID 1 </strong>可以存在多次，但是在每个名称空间中只能存在一次。</p><p id="8c4a" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated"><strong class="ko hj">挂载名称空间:</strong>有一个独立的挂载点列表，由相应名称空间中的进程查看。这意味着我们可以在挂载名称空间中挂载和卸载文件系统，而不会影响主机文件系统。</p><p id="ee87" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated"><strong class="ko hj">网络名称空间:</strong>只允许访问某些网络设备。它有自己的防火墙、路由规则和套接字端口号。因此，它无法看到所有流量或联系所有端点</p><p id="8e20" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated"><strong class="ko hj">用户名称空间:</strong>使用一组不同的用户 id 和组 id。例如—一个命名空间中的用户(0)可能与另一个命名空间中的用户(0)不同。</p><p id="2ab3" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated">但是为了安全起见，建议不要在容器内部使用 root 用户(0)。</p><p id="eb21" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated">让我们运行两个 docker 容器，看看它们是如何相互隔离的:</p><p id="2762" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated"><strong class="ko hj"> ●集装箱 1: c1 </strong></p><pre class="iy iz ja jb fd lk ll lm bn ln lo bi"><span id="704d" class="lp jp hi ll b be lq lr l ls lt">&gt;&gt; docker run --name c1 -d ubuntu sh -c 'sleep 1d'<br/><br/>&gt;&gt; docker exec c1 ps aux<br/><br/>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br/>root           1  0.1  0.0   2880  1004 ?        Ss   03:57   0:00 sh -c sleep 1d<br/>root           6  0.0  0.0   2780  1056 ?        S    03:57   0:00 sleep 1d #**<br/>root          12  0.0  0.0   7052  1588 ?        Rs   03:57   0:00 ps aux</span></pre><p id="95e6" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated"><strong class="ko hj"> ●容器 2: c2 </strong></p><pre class="iy iz ja jb fd lk ll lm bn ln lo bi"><span id="6af9" class="lp jp hi ll b be lq lr l ls lt">&gt;&gt; docker run --name c2 -d ubuntu sh -c 'sleep 365d'<br/><br/>&gt;&gt; docker exec c2 ps aux<br/><br/>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br/>root           1  0.1  0.0   2880   964 ?        Ss   04:00   0:00 sh -c sleep 365d<br/>root           6  0.0  0.0   2780  1008 ?        S    04:00   0:00 sleep 365d<br/>root           7  0.0  0.0   7052  1576 ?        Rs   04:00   0:00 ps aux</span></pre><p id="7acc" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated">我们已经创建了两个名为<strong class="ko hj">【C1】</strong>和<strong class="ko hj">【C2】</strong>的容器。我们可以看到“c1”容器无法看到“c2”的过程，反之亦然。</p><p id="a929" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated">但是由于这两个容器运行在同一个 Linux 内核上。从主机可以看到容器内部运行的进程。但是进程 ID 会有所不同，因为它是使用 PID 名称空间隔离的。因此，我们可以说容器只不过是运行在 Linux 内核上的一组进程。</p><p id="fc46" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated">从 Linux 内核检查进程:</p><pre class="iy iz ja jb fd lk ll lm bn ln lo bi"><span id="4a3e" class="lp jp hi ll b be lq lr l ls lt">&gt;&gt; ps aux | grep -i sleep<br/><br/>root     46938  0.0  0.0   2880  1004 ?      Ss   03:57   0:00 sh -c sleep 1d<br/>root     46973  0.0  0.0   2780  1056 ?      S    03:57   0:00 sleep 1d #&lt;--<br/>root     48280  0.0  0.0   2880   964 ?      Ss   04:00   0:00 sh -c sleep 365d<br/>root     48366  0.0  0.0   2780  1008 ?      S    04:00   0:00 sleep 365d #&lt;--</span></pre><p id="aeb4" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated">在上图中，我们可以看到在“c1”和“c2”容器中运行的进程可以从 Linux 主机上进行检查。</p><h2 id="da75" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">在同一个 PID 名称空间中运行容器:</h2><p id="5e8a" class="pw-post-body-paragraph km kn hi ko b kp kq ij kr ks kt im ku jz kv kw kx kd ky kz la kh lb lc ld le hb bi translated">现在，我们将尝试在同一个 PID 名称空间中运行容器。如果我们能够做到这一点，那么在同一个 PID 名称空间中运行的容器将会看到彼此的进程。</p><p id="cdac" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated">让我们删除<strong class="ko hj">“C1”</strong>容器，然后我们将尝试在<strong class="ko hj">“C2”</strong>容器的 PID 名称空间中创建它:</p><pre class="iy iz ja jb fd lk ll lm bn ln lo bi"><span id="cc29" class="lp jp hi ll b be lq lr l ls lt">&gt;&gt; docker rm c1 --force</span></pre><p id="f61e" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated">让我们尝试在同一个 PID 名称空间中运行两个容器。</p><pre class="iy iz ja jb fd lk ll lm bn ln lo bi"><span id="c2cd" class="lp jp hi ll b be lq lr l ls lt"># run container "c1" within the same namespace of the "c2"<br/>&gt;&gt; docker run --name c1 --pid=container:c2 -d ubuntu sh -c 'sleep 1d'<br/><br/>&gt;&gt; docker exec c1 ps aux<br/>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br/>root           1  0.0  0.0   2880   948 ?        Ss   04:00   0:00 sh -c sleep 365d<br/>root           6  0.0  0.0   2780  1008 ?        S    04:00   0:00 sleep 365d<br/>root          12  0.0  0.0   2880   964 ?        Ss   04:11   0:00 sh -c sleep 1d<br/>root          17  0.0  0.0   2780  1056 ?        S    04:11   0:00 sleep 1d<br/>root          18  0.0  0.0   7052  1580 ?        Rs   04:11   0:00 ps aux<br/><br/><br/>&gt;&gt; docker exec c2 ps aux<br/>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND<br/>root           1  0.0  0.0   2880   948 ?        Ss   04:00   0:00 sh -c sleep 365d<br/>root           6  0.0  0.0   2780  1008 ?        S    04:00   0:00 sleep 365d<br/>root          12  0.0  0.0   2880   964 ?        Ss   04:11   0:00 sh -c sleep 1d<br/>root          17  0.0  0.0   2780  1056 ?        S    04:11   0:00 sleep 1d<br/>root          23  0.0  0.0   7052  1644 ?        Rs   04:12   0:00 ps aux</span></pre><p id="2fde" class="pw-post-body-paragraph km kn hi ko b kp lf ij kr ks lg im ku jz lh kw kx kd li kz la kh lj lc ld le hb bi translated">现在，我们可以看到两个容器运行在同一个 PID 名称空间上，并且能够看到彼此。</p></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><blockquote class="mb mc md"><p id="7836" class="km kn me ko b kp lf ij kr ks lg im ku mf lh kw kx mg li kz la mh lj lc ld le hb bi translated"><em class="hi">如果你觉得这篇文章很有帮助，请点击</em> <strong class="ko hj"> <em class="hi">跟随</em> </strong> <em class="hi">👉</em><strong class="ko hj"><em class="hi"/></strong><em class="hi"/><strong class="ko hj"><em class="hi">拍拍</em> </strong> <em class="hi">👏</em> <strong class="ko hj"> <em class="hi"> </em> </strong> <em class="hi">按钮帮助我写更多这样的文章。<br/>谢谢🖤 </em></p></blockquote></div><div class="ab cl lu lv gp lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="hb hc hd he hf"><h2 id="7f88" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><em class="mi">👉所有关于 Linux 的文章</em></h2><div class="mj mk ez fb ml"><div role="button" tabindex="0" class="ab bv ff cb dy mm mn bn mo jh mp"><div class="mq l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw mr ms du" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="dr bw l mr ms ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" rel="noopener follow" target="_top" href="/@shamimice03?source=post_page-----cd67983516be--------------------------------"> Md 沙米姆</a></p></div></div><div class="mv mw fg l"><h2 class="bd hj sj sk dy sl ea eb sm ed ef hh bi translated">所有关于 Linux 的文章</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi sn au so sp sq pm sr an fx fy ss st su gb gc gd de bk ge" rel="noopener follow" target="_top" href="/@shamimice03/list/all-articles-on-linux-1339e15e3304?source=post_page-----cd67983516be--------------------------------">View list</a></div><div class="sv l dw"><span class="bd b fp z dx">12 stories</span></div></div></div><div class="ni dh nj dy ab nk dw di"><div class="di na bv nb nc"><div class="dh l"><img alt="" class="dh" src="../Images/259cf1a3ab76526a3f714f7cbaffac3d.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*G7yx3xB6zA_6GXrSu3ZWVA.png"/></div></div><div class="di na bv nd ne nf"><div class="dh l"><img alt="" class="dh" src="../Images/985a8b8ce1f1090a033d94ee7ac5f4fd.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*SoRvlTzozcRF9cua"/></div></div><div class="di bv ng nh nf"><div class="dh l"><img alt="" class="dh" src="../Images/d917609dcb8b45812e60ccd8bf2ed277.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*AcbQlR9WFnBxlLpV"/></div></div></div></div></div><h2 id="9e84" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">👉关于 Kubernetes 的所有文章</h2><div class="mj mk ez fb ml"><div role="button" tabindex="0" class="ab bv ff cb dy mm mn bn mo jh mp"><div class="mq l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw mr ms du" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="dr bw l mr ms ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" rel="noopener follow" target="_top" href="/@shamimice03?source=post_page-----cd67983516be--------------------------------"> Md 沙米姆</a></p></div></div><div class="mv mw fg l"><h2 class="bd hj sj sk dy sl ea eb sm ed ef hh bi translated">关于 Kubernetes 的所有文章</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi sn au so sp sq pm sr an fx fy ss st su gb gc gd de bk ge" rel="noopener follow" target="_top" href="/@shamimice03/list/all-articles-on-kubernetes-7ae1a0f96f3b?source=post_page-----cd67983516be--------------------------------">View list</a></div><div class="sv l dw"><span class="bd b fp z dx">24 stories</span></div></div></div><div class="ni dh nj dy ab nk dw di"><div class="di na bv nb nc"><div class="dh l"><img alt="" class="dh" src="../Images/f1050aa27a3ef03122558b1ba1de1f58.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7DhVxBWLKw_5M_jP"/></div></div><div class="di na bv nd ne nf"><div class="dh l"><img alt="" class="dh" src="../Images/f1c4131e92176033bce05392de197205.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*AkrEbqlA_j76u2I5Tm8npg.png"/></div></div><div class="di bv ng nh nf"><div class="dh l"><img alt="" class="dh" src="../Images/27d4385154af67764cf37713dbbdc38e.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*98RmgcHgM1cyOobu"/></div></div></div></div></div></div></div>    
</body>
</html>