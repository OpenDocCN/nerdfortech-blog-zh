<html>
<head>
<title>Postgres Libraries to try with Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Postgres 图书馆尝试使用 Go</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/postgres-libraries-to-try-with-go-8f80191edbff?source=collection_archive---------15-----------------------#2021-03-12">https://medium.com/nerd-for-tech/postgres-libraries-to-try-with-go-8f80191edbff?source=collection_archive---------15-----------------------#2021-03-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/5fdec8b19d01a34f93f9ef7890e7cb3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eKKVkEETE3mcIEAn"/></div></div></figure><p id="ef60" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我为这篇文章选择的库是<a class="ae jo" href="https://github.com/jackc/pgx" rel="noopener ugc nofollow" target="_blank"> pgx </a>，这是一个很好的 PostgreSQL 专用库，可以替代<code class="du jp jq jr js b">database/sql</code>和<a class="ae jo" href="https://github.com/Masterminds/squirrel" rel="noopener ugc nofollow" target="_blank"> Squirrel </a>，因为我喜欢这个名字(它也有一些很酷的特性)。</p><h1 id="1d62" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">从数据库开始</h1><p id="2a6b" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">手边已经有一个 PostgreSQL 数据库是有意义的，最好是其中有一些数据。如果你还没有帐号，那么<a class="ae jo" href="https://console.aiven.io/signup" rel="noopener ugc nofollow" target="_blank">注册</a>并启动 PostgreSQL 服务。如果你已经有一些数据可以使用，那太好了！我正在使用开普勒太空任务的一些公开数据，你可以<a class="ae jo" href="https://aiven.io/blog/discover-exoplanets-with-postgresql" rel="noopener ugc nofollow" target="_blank">跟随最近的博客文章</a>来自己设置。</p><p id="c7c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在 Aiven 控制台中，复制 Postgres 的连接字符串——或者如果您使用不同的数据库，复制<code class="du jp jq jr js b">postgres://....</code>连接字符串。</p><h1 id="dd43" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">从 Go 连接到 PostgreSQL</h1><p id="dfc1" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">Go 在其<code class="du jp jq jr js b">database/sql</code>库中有内置的数据库支持，但它非常通用，因为它必须能够处理如此多不同的数据库平台。对于专门连接到 PostgreSQL 的应用程序，使用专门的库是有意义的。</p><p id="307e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于这个例子，我选择了<code class="du jp jq jr js b">jackc/pgx</code>，它是 PostgreSQL 特有的，除了提高性能之外，在理解 PostgreSQL 数据类型方面有一些很好的特性。整体模式与其他使用<code class="du jp jq jr js b">database/sql</code>的应用程序没有根本的不同，这让它感觉很熟悉。</p><p id="4ed2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将之前复制的连接字符串设置为<code class="du jp jq jr js b">DATABASE_URL</code>环境变量。然后用<code class="du jp jq jr js b">go mod init pgfun</code>初始化你的 go 应用；<code class="du jp jq jr js b">pgx</code>使用 go 模块。</p><p id="174c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您设置好一切后，尝试下面的代码示例连接到一个数据库并运行一个查询(我的数据库中有系外行星数据):</p><pre class="kw kx ky kz fd la js lb lc aw ld bi"><span id="104e" class="le ju hi js b fi lf lg l lh li">package main</span><span id="1c35" class="le ju hi js b fi lj lg l lh li">import (<br/> "context"<br/> "fmt"<br/> "os"</span><span id="44b0" class="le ju hi js b fi lj lg l lh li">"github.com/jackc/pgx/v4/pgxpool"<br/>)</span><span id="17c7" class="le ju hi js b fi lj lg l lh li">func main() {<br/> dbpool, dberr := pgxpool.Connect(context.Background(), os.Getenv("DATABASE_URL"))<br/> if dberr != nil {<br/>  panic("Unable to connect to database")<br/> }<br/> defer dbpool.Close()</span><span id="f45d" class="le ju hi js b fi lj lg l lh li">sql := "SELECT kepler_name, koi_score " +<br/>        "FROM cumulative " +<br/>        "WHERE kepler_name IS NOT NULL AND koi_pdisposition = 'CANDIDATE' " +<br/>        "ORDER BY koi_score LIMIT 5"<br/> rows, sqlerr := dbpool.Query(context.Background(), sql)<br/> if sqlerr != nil {<br/>  panic(fmt.Sprintf("QueryRow failed: %v", sqlerr))<br/> }</span><span id="7eb7" class="le ju hi js b fi lj lg l lh li">for rows.Next() {<br/>  var planet_name string<br/>  var score float64<br/>  rows.Scan(&amp;planet_name, &amp;score)<br/>  fmt.Printf("%s\t%.2f\n", planet_name, score)<br/> }<br/>}</span></pre><p id="a60a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<code class="du jp jq jr js b">main()</code>函数中，首先代码使用<code class="du jp jq jr js b">pgx</code>的<a class="ae jo" href="https://help.aiven.io/en/articles/964730-postgresql-connection-pooling" rel="noopener ugc nofollow" target="_blank">连接池</a>特性连接到数据库。作为一般规则，我认为 PostgreSQL 的连接池是明智之举，这就是为什么在这里使用它。</p><p id="33e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后是一个简单的 SQL 语句，显示开普勒任务指定为“候选”状态的系外行星，以及他们对它是一颗真实行星的信心。该语句有一个行限制(数据集有大约 2k 行，没有该限制)，因此在最后一节中，您只能看到五个最低置信度得分的行星，该节遍历行并将数据作为变量读入。</p><p id="703a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我喜欢这里的名字——如果你感兴趣，你甚至可以在<a class="ae jo" href="https://exoplanets.nasa.gov/discovery/exoplanet-catalog/" rel="noopener ugc nofollow" target="_blank">系外行星目录</a>中查找这些行星。我花了太多时间浏览，科学是王牌！</p><p id="ab96" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">概括一下，我们有一个 PostgreSQL 连接字符串、一个 Go 数据库和一个硬编码的 SQL 查询。下一步是什么？</p><h1 id="16c5" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">松鼠的流体界面</h1><p id="a551" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">虽然<code class="du jp jq jr js b">pgx</code>库是特定于 PostgreSQL 的对<code class="du jp jq jr js b">database/sql</code>的替代，但它也有一个兼容的接口。如果你想切换现有的应用程序，这是很理想的，但这也意味着其他设计用来很好地处理<code class="du jp jq jr js b">database/sql</code>的工具也可以和<code class="du jp jq jr js b">pgx</code>一起工作。这对我是个好消息，因为我想找到比我的硬编码 SQL 字符串更优雅的东西。</p><p id="e9dc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">松鼠！</p><p id="1657" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不，我没有分心，这是一个 SQL 库。虽然，这是一个有点闪亮的玩具。它是一个用于构建 SQL 查询的流畅接口，SQL 非常适合以这种方式考虑。</p><p id="52bc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个接口中重新构建我们现有的 SQL 查询会产生如下结果:</p><pre class="kw kx ky kz fd la js lb lc aw ld bi"><span id="0646" class="le ju hi js b fi lf lg l lh li">planets := psql.Select("kepler_name", "koi_score").<br/>  From("cumulative").<br/>  Where(sq.NotEq{"kepler_name": nil}).<br/>  Where(sq.Eq{"koi_pdisposition": "CANDIDATE"}).<br/>  OrderBy("koi_score").<br/>  Limit(5)</span></pre><p id="4837" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它更易于管理，我可以想象在一个真实的应用程序中构建它要比将 SQL 字符串连接在一起容易得多。仍然可以通过调用<code class="du jp jq jr js b">planets.ToSql()</code>来检查它作为字符串构建的 SQL，这是一个不错的方法。</p><p id="780a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将<code class="du jp jq jr js b">pgx</code>切换到“假装<code class="du jp jq jr js b">database/sql</code>”模式需要一点重构。我还需要一勺秘方酱来让 Squirrel 很好地使用 PostgreSQL，所以下面是完整的 runnable 示例。与前面的例子一样，它期望数据库连接字符串在<code class="du jp jq jr js b">DATABASE_URL</code>中:</p><pre class="kw kx ky kz fd la js lb lc aw ld bi"><span id="6ff0" class="le ju hi js b fi lf lg l lh li">package main</span><span id="6ddb" class="le ju hi js b fi lj lg l lh li">import (<br/> "database/sql"<br/> "fmt"<br/> "os"</span><span id="3afe" class="le ju hi js b fi lj lg l lh li">sq "github.com/Masterminds/squirrel"<br/> _ "github.com/jackc/pgx/v4/stdlib"<br/>)</span><span id="4a9d" class="le ju hi js b fi lj lg l lh li">func main() {<br/> db, err := sql.Open("pgx", os.Getenv("DATABASE_URL"))<br/> if err != nil {<br/>  panic("Unable to connect to database")<br/> }<br/> defer db.Close()</span><span id="7e58" class="le ju hi js b fi lj lg l lh li">// a little magic to tell squirrel it's postgres<br/> psql := sq.StatementBuilder.PlaceholderFormat(sq.Dollar)</span><span id="b7c6" class="le ju hi js b fi lj lg l lh li">planets := psql.Select("kepler_name", "koi_score").<br/>  From("cumulative").<br/>  Where(sq.NotEq{"kepler_name": nil}).<br/>  Where(sq.Eq{"koi_pdisposition": "CANDIDATE"}).<br/>  OrderBy("koi_score").<br/>  Limit(5)</span><span id="fb02" class="le ju hi js b fi lj lg l lh li">rows, sqlerr := planets.RunWith(db).Query()<br/> if sqlerr != nil {<br/>  panic(fmt.Sprintf("QueryRow failed: %v", sqlerr))<br/> }</span><span id="be23" class="le ju hi js b fi lj lg l lh li">for rows.Next() {<br/>  var planet_name string<br/>  var score float64<br/>  rows.Scan(&amp;planet_name, &amp;score)<br/>  fmt.Printf("%s\t%.2f\n", planet_name, score)<br/> }<br/>}</span></pre><p id="d8fb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意，这次的<code class="du jp jq jr js b">pgx</code>导入是不同的，以获得 Squirrel 在其<code class="du jp jq jr js b">RunWith()</code>方法中期望的<code class="du jp jq jr js b">database/sql</code>兼容库。连接步骤也有一些变化，所以不要试图修改前面的例子；这个不一样。</p><p id="895d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jp jq jr js b">psql</code>变量保存一个重新配置的松鼠，这是必需的，因为 PostgreSQL 处理占位符的方式略有不同。跳过这一步会导致代码告诉您在<code class="du jp jq jr js b">LIMIT</code>子句附近有一个语法错误。希望现在我已经把它写下来了，我亲爱的读者可以避免这个问题，下次我可能还会记得！</p><h1 id="a3cb" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Go 和 PostgreSQL 的乐趣</h1><p id="a553" class="pw-post-body-paragraph iq ir hi is b it kr iv iw ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn hb bi translated">这是一个轻量级的介绍，向您展示了几个我最喜欢的用于 Go 和 PostgreSQL 应用程序的库——当然，有了开放的数据集，乐趣会成倍增加:)</p><p id="1c84" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里有一些相关的链接和进一步的阅读，如果你有问题，请在<a class="ae jo" href="https://twitter.com/aiven_io" rel="noopener ugc nofollow" target="_blank">推特</a>上联系我们。我们喜欢聊天！</p><ul class=""><li id="ed70" class="lk ll hi is b it iu ix iy jb lm jf ln jj lo jn lp lq lr ls bi translated">【Aiven PostgreSQL 入门</li><li id="045d" class="lk ll hi is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated"><a class="ae jo" href="https://aiven.io/blog/discover-exoplanets-with-postgresql" rel="noopener ugc nofollow" target="_blank">用 PostgreSQL 发现系外行星</a></li><li id="260f" class="lk ll hi is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated"><a class="ae jo" href="https://github.com/aiven/aiven-examples" rel="noopener ugc nofollow" target="_blank">事件连接的代码示例</a></li><li id="c14d" class="lk ll hi is b it lt ix lu jb lv jf lw jj lx jn lp lq lr ls bi translated"><a class="ae jo" href="https://aiven.io/blog/aiven-for-postgresql-13-is-now-available" rel="noopener ugc nofollow" target="_blank">针对 Postgres13 的 Aiven 现已推出</a></li></ul></div><div class="ab cl ly lz gp ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="hb hc hd he hf"><p id="0b8a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mf">最初发布于</em><a class="ae jo" href="https://aiven.io/blog/aiven-for-postgresql-for-your-go-application" rel="noopener ugc nofollow" target="_blank"><em class="mf">https://aiven . io</em></a><em class="mf">。</em></p></div></div>    
</body>
</html>