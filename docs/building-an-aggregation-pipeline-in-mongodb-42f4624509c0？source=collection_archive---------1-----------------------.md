# 在 MongoDB 中构建聚合管道

> 原文：<https://medium.com/nerd-for-tech/building-an-aggregation-pipeline-in-mongodb-42f4624509c0?source=collection_archive---------1----------------------->

![](img/9030e2eb008073f9f20b2ad7cb345d1c.png)

昆腾·德格拉夫在 [Unsplash](https://unsplash.com/photos/L4gN0aeaPY4?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上的照片

MongoDB 是一个常用的 **NoSQL 数据库**，用于存储和管理海量数据。MongoDB 的核心特性之一是它的**聚合管道**，它允许您分阶段处理和更改来自集合的数据。在这篇文章中，我们将看看如何在 MongoDB 中创建一个聚合管道。

## 什么是聚合管道？

聚合管道是一组处理数据并返回计算结果的操作。它可用于执行复杂的数据分析和报告活动，并允许您对数据执行众多操作，如**过滤**、**分组**和**排序**。

要创建聚合管道，请对集合使用 **aggregate()** 方法。aggregate()方法接受一组管道阶段作为参数，每个阶段都以不同的方式处理数据。任何聚合阶段，如 **$match** 、 **$group** 、 **$sort** 、 **$project** 等，都可以作为流水线阶段。

例如，您可以使用以下代码创建一个简单的管道，该管道根据特定条件过滤文档，然后按特定字段组织结果:

```
db.collection.aggregate([
  { $match: { field: "value" } },
  { $group: { _id: "$groupField", count: { $sum: 1 } } }
])
```

该管道首先通过匹配字段等于“值”的文档来过滤集合，然后按照组名对剩余的文档进行分组。每个组字段中的文档数在字段中计数。

您可以根据需要向管道添加更多阶段，以进一步处理和分析数据。您可以使用 **$sort** 阶段按照 count 字段对结果进行排序，或者使用 **$project** 阶段对输出页面进行重组。

## 聚集阶段类型:

在 MongoDB 中，有几个[聚合阶段](https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/)，每个阶段都有自己的功能和语法。以下是一些最常用的阶段:

**$match** :过滤文档，只返回符合所提供条件的文档。
**$group** :使用提供的标识符表达式对输入文档进行分组，并对每个组应用累加器表达式(如果指定了的话)。
**$sort** :对输入的文档进行排序。
**$project** :调整输入流中每个文档的大小，例如，通过添加新字段或删除旧字段。
**$limit** :设置可以传送到管道下一阶段的最大文档数。
**$skip** :跳过管道中的一些文档，将剩余的文档移到下一阶段。

有许多不同的阶段，每个阶段都有其独特的应用。MongoDB 手册有可用阶段的完整列表。

## 构建聚合管道:

若要创建聚合管道，请对集合调用 aggregate()函数，并传递管道阶段数组。每个阶段都应该是一个对象，它有一个表示阶段操作符的键和一个表示阶段参数的值。

例如，您可以使用以下代码创建一个管道，该管道根据特定条件筛选文档，按特定字段对结果进行分组，然后对结果进行排序:

```
db.collection.aggregate([
  { $match: { field: "value" } },
  { $group: { _id: "$groupField", count: { $sum: 1 } } },
  { $sort: { count: -1 } }
])
```

该管道首先通过匹配`field`等于“值”的文档来过滤集合中的文档。然后，它通过`groupField`字段对剩余的文档进行分组，计算每组中的文档数量。最后，它按照`count`字段降序排列结果。

您可以根据需要向管道添加更多阶段，以进一步处理和分析数据。例如，您可以使用 **$limit** 阶段来限制返回的文档数量，或者使用 **$project** 阶段来调整输出文档的形状。

注意到流水线步骤的**顺序**非常重要。因为每个阶段的输入都是前一阶段的输出，所以这些步骤按提供的顺序执行。

## 结论:

在 MongoDB 中，创建聚合管道允许您对集合进行复杂的数据分析和报告活动。通过使用各种聚合过程，您可以根据需要对数据进行筛选、分组、排序和更改，以满足您的个人需求。借助聚合管道的功能，您可以更深入地了解数据，做出更明智的决策。

我希望这篇文章对你有所帮助。 ***感谢阅读。***