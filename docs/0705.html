<html>
<head>
<title>Solving CORS Errors Associated with Deploying a Node.js + PostgreSQL API to Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解决与将 Node.js + PostgreSQL API 部署到 Heroku 相关的 CORS 错误</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/solving-cors-errors-associated-with-deploying-a-node-js-postgresql-api-to-heroku-1afd94964676?source=collection_archive---------0-----------------------#2021-02-07">https://medium.com/nerd-for-tech/solving-cors-errors-associated-with-deploying-a-node-js-postgresql-api-to-heroku-1afd94964676?source=collection_archive---------0-----------------------#2021-02-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6e8b" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated"><strong class="ak">第 1 部分:部署 REST API </strong></h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/8d0b1e831eaac2e30eec1091f06eb359.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IxhhKIi0-Bn-hN54RK1IcQ.png"/></div></div></figure><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es jj"><img src="../Images/c29762fe936803280cc6c5796f8035b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*REjz-bvrKhnj8kfCBBY8UA.png"/></div></div><figcaption class="jk jl et er es jm jn bd b be z dx translated">来源:谷歌图片</figcaption></figure><p id="6bf9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">你是否曾经构建了一个 API，在所有的艰苦工作之后，你将它部署到 Heroku，尝试从前端使用它，然后得到一个 CORS 错误？而且排查了几天甚至几周，还是没有进展？你来对地方了，谢谢你的来访。</p><p id="2817" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><a class="ae kk" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="noopener ugc nofollow" target="_blank">跨来源资源共享</a> ( <a class="ae kk" href="https://developer.mozilla.org/en-US/docs/Glossary/CORS" rel="noopener ugc nofollow" target="_blank"> CORS </a>)错误可以说是开发人员在工作中必须处理的许多恼人的故障排除难题之一，尤其是在部署时。有时，此问题不是由于没有在服务器上配置 CORS 造成的。其他问题，如未正确设置标题或不正确的数据库配置也可能是原因。</p><p id="e9b8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在将 REST 和 GraphQL APIs 部署到 Heroku 时，我遇到过几次这个问题，在第一部分中，我将详细介绍将 REST API 无压力地部署到 Heroku 需要做的事情！第二部分，我将在下一个系列中讨论，将集中在部署 GraphQL API 上。</p><p id="ca03" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">所以我假设你知道 git、Node.js、Express、Postgres、Heroku，并且也知道什么是 REST API，因为我在这里不会教这些。我也将使用更多的 ES6，我希望你也能接受。</p><p id="e82f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在本指南中，我们将介绍以下步骤:</p><ul class=""><li id="f1ee" class="kl km hi jq b jr js ju jv jx kn kb ko kf kp kj kq kr ks kt bi translated">正确设置我们的 API</li><li id="b655" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">设置 Postgres 数据库配置</li><li id="72c0" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">在我们的服务器上配置 CORS</li><li id="499a" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">设置. env 文件</li><li id="427f" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">在 Heroku 上创建和部署我们的应用</li><li id="3516" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">在 Heroku 上设置我们的环境变量</li><li id="6490" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">预配 Postgres 数据库和创建表</li></ul><p id="7de6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们将使用的依赖项:</p><ul class=""><li id="9f48" class="kl km hi jq b jr js ju jv jx kn kb ko kf kp kj kq kr ks kt bi translated">表达</li><li id="d799" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">heroku-cli 全球安装</li><li id="f741" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">dotenv 或 dotenv-safe</li><li id="30d8" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">节点 pg</li><li id="5e7a" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">克-奥二氏分级量表</li></ul><p id="552a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">正确设置我们的 API </strong></p><p id="a17f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当编写 REST API 时，一定要确保返回您的响应。这是为了确保您的路由器在出错时正确退出。这是一个微妙的方法，因为它将防止您的应用程序出现诸如[ERR_HTTP_HEADERS_SET]之类的节点错误，这些错误可能会在您的服务器中引入一个 bug，从而导致您的应用程序在 Heroku 上崩溃。例如，这样写的节点响应:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="942b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">可以转换成这样:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="314d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">相信我；这样会给你省很多压力！</p><p id="b626" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">设置 Postgres 数据库配置</strong></p><p id="cdd8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">由于我们使用节点 pg，我们的 Postgres 数据库配置需要如下所示:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="b416" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了让我们的应用程序在 Heroku 上正常运行，我们需要在 Postgres 数据库上配置 SSL。这是因为 Heroku 非常重视安全性，并努力确保我们数据的安全。但不幸的是，他们的文档中从未提及这一点。如果你的应用有 SSL 证书，将其设置为 true，否则将 SSL 设置为 rejectUnauthorized: false。如果不在您的数据库或 Heroku 环境中配置 SSL，将会导致 Heroku 上出现“致命:没有 pg_hba.conf 条目”错误。注意，如果您使用 dotenv-safe，请确保您设置了一个. env.example 文件，其中包含关于如何设置。环境文件。你可以在这里阅读更多关于 dotenv-safe <a class="ae kk" href="https://www.npmjs.com/package/dotenv-safe" rel="noopener ugc nofollow" target="_blank">的内容。</a></p><p id="9439" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">在我们的服务器上配置 CORS</strong></p><p id="135c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">CORS 可以通过几种不同的方式进行配置。在这个系列中，我将向我们展示两种不同的方法。第一种方法是写一堆代码:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="ca6c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这告诉我们的应用程序，让访问每个网址和请求方法试图访问它。我们可以将*符号更改为我们希望授予访问权限的特定 URL。另一种方法是使用一个叫做 cors 的方便的节点包。我们只需要这样做:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="c8f3" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">就是这样！这将执行与上述代码相同的功能。我们也可以这样指定 URL:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="18fb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">设置一个. env 文件</strong></p><p id="ea6c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">答。env 文件是一个简单的配置文本文件，用于定义一些不想公开的变量。这个文件需要一个解析器才能工作。解析器逐个读取变量定义，并将它们解析到环境中。我们的。env 文件设置如下所示:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="f984" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">注意我们的。需要将 env 文件添加到. gitignore 中。这将使它远离公众。</p><p id="6a1e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">创建我们的应用并将其部署到 Heroku </strong></p><p id="8cee" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">首先，我们需要在 package.json 文件中指定节点引擎和节点包管理器:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="a69c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将在部署期间添加我们的 buildpack，即 heroku/nodejs。</p><p id="4fd4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">向我们的根目录添加一个 Procfile，并将值设置为“web: src/server.js”。在本例中，我们的服务器文件是 server.js，它位于 src 文件夹中。</p><p id="9444" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们需要通过命令行界面登录 Heroku:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="6206" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">按照说明登录。</p><p id="ad03" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">接下来，我们需要创建和部署我们的应用程序。这可以通过以下命令实现:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="d874" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">第 5 行用于当我们从另一个分支而不是主分支推送时。第 6 行将启动我们的服务器，如果它以前没有运行的话。</p><p id="79ae" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">在 Heroku 上设置我们的环境变量</strong></p><p id="80e1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在 Heroku 上，我们需要设置环境变量来匹配。本地目录中的 env 文件。我们可以通过两种方式设置 Heroku 环境变量——通过 Heroku GUI 或其 CLI。</p><p id="02a2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">从 GUI 中:</p><ul class=""><li id="55fe" class="kl km hi jq b jr js ju jv jx kn kb ko kf kp kj kq kr ks kt bi translated">转到 Heroku 仪表盘，点击我们刚刚创建的应用程序</li><li id="1069" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">点击导航选项中的“设置”</li><li id="9587" class="kl km hi jq b jr ku ju kv jx kw kb kx kf ky kj kq kr ks kt bi translated">找到配置变量并点击“显示配置变量”。</li></ul><p id="9471" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">输入包含在。env 文件，DATABASE_URL 除外。在我们提供数据库后，将为我们添加 DATABASE_URL。我们还需要通过添加 PGSSLMODE 为 SSL 设置一个环境变量，并将值设置为 require。</p><p id="2b50" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">从 CLI 中:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="2121" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">中的整个环境变量分别执行此操作。env 文件，DATABASE_URL 除外。</p><p id="89dd" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">提供 Postgres 数据库并创建表格</strong></p><p id="200e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">提供数据库意味着在 Heroku 上建立我们的数据库。Heroku 有不同的 Postgres 数据库计划，但在本指南中，我们将使用免费的 Heroku Postgres 数据库。</p><p id="1700" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">要设置数据库，我们将使用:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="52eb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这告诉 Heroku 添加一个 Postgres 数据库到你的应用程序，并使用免费的爱好开发计划。</p><p id="0bdf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">最后，我们需要创建我们的表。为此，我们必须导航到包含定义表的文件的文件夹，并运行以下命令:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="0853" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将为我们创建所有的表。</p><p id="d7e0" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">维奥拉。我们完了。</p><p id="7969" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在，键入命令</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="kz la l"/></div></figure><p id="2dfa" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在浏览器上打开你的应用。复制 URL，粘贴到 Postman 上，并尝试向不同的路线发送请求。</p><p id="5d54" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">感谢您阅读我的帖子，我将感谢您的反馈。</p><p id="ed00" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我将发布关于如何部署 GraphQL API 的第 2 部分。敬请关注。</p></div></div>    
</body>
</html>