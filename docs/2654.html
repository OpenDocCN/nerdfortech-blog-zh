<html>
<head>
<title>Safe Retrofit calls extension with kotlin Coroutines for Android in 2021 — Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">2021 年 Android 安全改造调用 kotlin 协程扩展—第二部分</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-ii-fd55842951cf?source=collection_archive---------4-----------------------#2021-05-15">https://medium.com/nerd-for-tech/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-ii-fd55842951cf?source=collection_archive---------4-----------------------#2021-05-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e5bbe947275199afdfd849498540cf21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OXju1fJY1LAZYizK"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@ffstop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">拍摄于<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的</a></figcaption></figure><p id="9918" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">又见面了👋，这是该系列的第二部分。如果你还没有读第一部分，我鼓励你去读一读，以便理解我们现在要做的所有事情。</p><div class="jt ju ez fb jv jw"><a href="https://christopher-elias.medium.com/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-i-d47e9e2962ad" rel="noopener follow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">2021 年 Android 安全改造调用 kotlin 协同程序扩展—第一部分</h2><div class="kd l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">christopher-elias.medium.com</p></div></div><div class="ke l"><div class="kf l kg kh ki ke kj io jw"/></div></div></a></div><p id="b411" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们知道了如何用协程处理异常，让我们来编码。</p><h1 id="d242" class="kk kl hi bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">1.建立或项目⚒️</h1><p id="594d" class="pw-post-body-paragraph iv iw hi ix b iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js hb bi translated">我们将为此使用改型和协同程序，因此我们将把以下依赖项添加到我们的应用程序(或 android/kotlin 库)模块 gradle 文件中</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="db18" class="lw kl hi ls b fi lx ly l lz ma">dependencies {  </span><span id="8aea" class="lw kl hi ls b fi mb ly l lz ma">// Current versions at the time<br/>  def retrofit_version = "2.9.0" <br/>  def coroutines_version = "1.5.0"<br/> <br/>  implementation "com.squareup.retrofit2:retrofit:$retrofit_version"</span><span id="4f25" class="lw kl hi ls b fi mb ly l lz ma">  implementation "com.squareup.retrofit2:converter-moshi:$retrofit_version"<br/> <br/>  implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:$coroutines_version"</span><span id="a742" class="lw kl hi ls b fi mb ly l lz ma">}</span></pre><h1 id="8213" class="kk kl hi bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">2.解析例外♻️</h1><p id="b09c" class="pw-post-body-paragraph iv iw hi ix b iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js hb bi translated">执行网络调用时可能会出现一些常见的异常，如<code class="du mc md me ls b">SocketTimeoutException</code>、<code class="du mc md me ls b">SSLHandshakeException</code>、<code class="du mc md me ls b">HttpException</code>等。但是我们不会直接发送这些异常，相反，我们会将这些异常转换成可读的失败！我们开始吧！</p><p id="0952" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们将从<a class="ae iu" href="https://github.com/ChristopherME/movies-android/blob/master/functional-programming/src/main/java/com/christopher_elias/functional_programming/Failure.kt" rel="noopener ugc nofollow" target="_blank"> Failure </a>类扩展它们来创建或定制失败。</p><figure class="ln lo lp lq fd ij"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">自定义故障的创建</figcaption></figure><p id="3c8d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">既然我们已经得到了自定义的失败，是时候将异常映射到其中了。</p><figure class="ln lo lp lq fd ij"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">将异常转换成自定义故障。<code class="du mc md me ls b"><strong class="ak">ResponseError</strong></code>类只是一个表示已处理后端故障的结构，类似 4XX 错误。</figcaption></figure><h1 id="d403" class="kk kl hi bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">3.改造调用执行线程安全⛑️</h1><p id="b54c" class="pw-post-body-paragraph iv iw hi ix b iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js hb bi translated">现在我们有了异常解析器扩展函数，我们可以用它来捕获和解析在执行网络调用时可能发生的任何异常。</p><figure class="ln lo lp lq fd ij"><div class="bz dy l di"><div class="mf mg l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">安全翻新调用包装器</figcaption></figure><p id="0886" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以上面的 suspend 函数有一些关键的特性，我将向你解释。</p><ul class=""><li id="d856" class="mh mi hi ix b iy iz jc jd jg mj jk mk jo ml js mm mn mo mp bi translated"><strong class="ix hj"> ioDispatcher </strong> —协程调度程序，它应该是应用程序的 IO 调度程序，也是单元测试中的 TestCoroutineDispatcher。</li><li id="99d7" class="mh mi hi ix b iy mq jc mr jg ms jk mt jo mu js mm mn mo mp bi translated"><strong class="ix hj">适配器</strong> —它接受一个 JSON adapter&lt;ResponseError&gt;适配器，用于将 JSON 对象解析为所需的 response error 数据类</li><li id="dc52" class="mh mi hi ix b iy mq jc mr jg ms jk mt jo mu js mm mn mo mp bi translated"><strong class="ix hj">retro fit call</strong>——一个跨线挂起函数，它将在<code class="du mc md me ls b">withContext</code>块中接受您的服务并安全执行它。如果你没有内联函数的经验，可以看下面的视频，弗洛里纳·芒特内斯库解释了它</li><li id="5740" class="mh mi hi ix b iy mq jc mr jg ms jk mt jo mu js mm mn mo mp bi translated"><strong class="ix hj">to success()&amp;to error</strong>()—这些只是将任何对象包装到一个。成功与否。错误实例。</li></ul><figure class="ln lo lp lq fd ij"><div class="bz dy l di"><div class="mx mg l"/></div></figure><h1 id="eb7e" class="kk kl hi bd km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh bi translated">4.整合所有🧩</h1><p id="91b5" class="pw-post-body-paragraph iv iw hi ix b iy li ja jb jc lj je jf jg lk ji jj jk ll jm jn jo lm jq jr js hb bi translated">好了，就这样。你有一个安全的改造调用包装扩展功能！你可以像这样使用它</p><figure class="ln lo lp lq fd ij"><div class="bz dy l di"><div class="mf mg l"/></div></figure><p id="f6b8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我使用<code class="du mc md me ls b">.let {…}</code>的最后一部分只是因为<code class="du mc md me ls b">actorsService.getActors()</code>返回了一个<code class="du mc md me ls b">ResponseItems&lt;ActorResponse&gt;</code>对象。我只是使用了<code class="du mc md me ls b"><a class="ae iu" href="https://github.com/ChristopherME/movies-android/blob/4140aeaa004d2dfb594e8b9da404037760ab8c93/functional-programming/src/main/java/com/christopher_elias/functional_programming/Either.kt#L66" rel="noopener ugc nofollow" target="_blank">Either.mapSuccess</a></code>助手方法来提取结果，并按预期返回一个 ActorsResponse 列表。</p></div><div class="ab cl my mz gp na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hb hc hd he hf"><p id="4363" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以那是什么…是吗？嗯……算是吧。我们可以通过添加一个中间件层来增加一点定制！中间件能为我们做什么？它可能会检查手机是否连接到互联网，或者你可以验证一些数据，等等。</p><p id="8193" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们实现一个有趣的中间件。👉前往<a class="ae iu" href="https://christopher-elias.medium.com/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-iii-583249b0e86b" rel="noopener">第 3 部分</a>了解如何操作！</p><p id="ffc0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">示例项目👇</p><div class="jt ju ez fb jv jw"><a href="https://github.com/ChristopherME/movies-android" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">Christopher me/电影-android</h2><div class="nf l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">Movies 是一个简单的项目，可以学习和使用一些 android 组件、架构和 Android 工具…</h3></div><div class="kd l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">github.com</p></div></div><div class="ke l"><div class="ng l kg kh ki ke kj io jw"/></div></div></a></div><p id="f236" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">再见👋</p></div></div>    
</body>
</html>