<html>
<head>
<title>Using Terraform to enable automatic tuning mode in an individual Azure SQL Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Terraform 在单个 Azure SQL 数据库中启用自动调优模式</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/using-terraform-to-enable-automatic-tuning-mode-in-an-individual-azure-sql-database-1e2cf3e6a21f?source=collection_archive---------8-----------------------#2021-07-14">https://medium.com/nerd-for-tech/using-terraform-to-enable-automatic-tuning-mode-in-an-individual-azure-sql-database-1e2cf3e6a21f?source=collection_archive---------8-----------------------#2021-07-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c866b75481e4453f8db19e8a31a9c913.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q6KAyvZ8CqVZCy8X1HrzLw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">调一下！—由<a class="ae iu" href="https://www.pexels.com/nl-nl/@cottonbro?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"> cottonbro </a>通过<a class="ae iu" href="https://www.pexels.com/nl-nl/foto/hand-gezichtsloos-muziek-musicus-4708867/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a>进行 Pic</figcaption></figure><h1 id="f562" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">💡介绍</h1><p id="b846" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">Azure SQL Database 自动管理数据服务，这些服务持续监控您的查询，并确定您可以执行的操作，以提高工作负载的性能。您可以检查建议并手动应用它们，或者让 Azure SQL 数据库自动应用纠正措施—这就是所谓的自动调优模式。</p><p id="7f10" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">可以通过以下方式在服务器或数据库级别启用自动调优:</p><ul class=""><li id="ecaf" class="kw kx hi jv b jw kr ka ks ke ky ki kz km la kq lb lc ld le bi translated">蓝色门户 1️⃣</li><li id="6e42" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">2️⃣ REST API 调用</li><li id="d8cd" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">3️⃣ T-SQL 命令</li></ul><h1 id="8670" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">🔍挑战</h1><p id="0b90" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">正如你从上面的 1️⃣、2️⃣和 3️⃣看到的，目前不可能通过 Azure CLI 或 ARM (Azure Resource Manager)模板启用自动调整。但是不用担心——这个存储库中的示例提供了一个替代的部署选项。它扩展了 T-SQL 命令选项(3️⃣),使用 Terraform 在单个 Azure SQL 数据库中实现自动调优！</p><p id="b843" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">到目前为止，还不能使用 Terraform <code class="du lk ll lm ln b">azurerm_mssql_database</code>资源来启用此功能。因此，这个解决方案使用了<code class="du lk ll lm ln b">null_resource</code>地形资源和<code class="du lk ll lm ln b">sqlcmd</code>工具。</p><h1 id="55f1" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">🔧它是如何工作的？</h1><p id="ba51" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">如<a class="ae iu" href="https://registry.terraform.io/providers/hashicorp/null/latest/docs/resources/resource" rel="noopener ugc nofollow" target="_blank">地形文件</a>所述:</p><blockquote class="lo lp lq"><p id="68ac" class="jt ju lr jv b jw kr jy jz ka ks kc kd ls kt kg kh lt ku kk kl lu kv ko kp kq hb bi translated"><code class="du lk ll lm ln b">null_resource</code>资源实现了标准的资源生命周期，但是没有采取进一步的行动。</p><p id="f313" class="jt ju lr jv b jw kr jy jz ka ks kc kd ls kt kg kh lt ku kk kl lu kv ko kp kq hb bi translated"><code class="du lk ll lm ln b">triggers</code>参数允许指定任意一组值，当这些值被更改时，将导致资源被替换。</p></blockquote><p id="6a46" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">关键属性是<code class="du lk ll lm ln b">depends_on = [azurerm_mssql_database.test]</code>和<code class="du lk ll lm ln b">triggers = { always_run = timestamp() }</code>。</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="6f75" class="md iw hi ln b fi me mf l mg mh">resource "null_resource" "db_setup" {<br/>  depends_on = [azurerm_mssql_database.test]</span><span id="f7ac" class="md iw hi ln b fi mi mf l mg mh">  triggers = {<br/>    always_run = timestamp()<br/>  }</span><span id="981d" class="md iw hi ln b fi mi mf l mg mh">  provisioner "local-exec" {<br/>    command = "sqlcmd -S ${azurerm_mssql_server.example.name}.database.windows.net -d ${azurerm_mssql_database.test.name} -U ${var.administrator_login} -P ${var.administrator_login_password} -i ./auto-tuning.sql"<br/>  }<br/>}</span></pre><p id="72e4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这确保了<code class="du lk ll lm ln b">sqlcmd</code>实用程序总是在<code class="du lk ll lm ln b">terraform apply</code>中执行<code class="du lk ll lm ln b">auto-tuning.sql</code>命令。</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="154d" class="md iw hi ln b fi me mf l mg mh">-- Enable automatic tuning on an individual database<br/>ALTER DATABASE current SET AUTOMATIC_TUNING (CREATE_INDEX = ON);</span></pre><p id="29ee" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">❗重要提示:请注意，在这个示例中,(生成的)MS SQL Server 管理员凭证用于执行<code class="du lk ll lm ln b">auto-tuning.sql</code>命令。</p><blockquote class="lo lp lq"><p id="b8a9" class="jt ju lr jv b jw kr jy jz ka ks kc kd ls kt kg kh lt ku kk kl lu kv ko kp kq hb bi translated">要使用自动调优，授予用户的最低要求权限是 Azure 的内置 SQL 数据库贡献者角色。您还可以考虑使用更高权限的角色，如 SQL Server 参与者、SQL 托管实例参与者、参与者和所有者。(<a class="ae iu" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/automatic-tuning-enable#permissions" rel="noopener ugc nofollow" target="_blank">自动调谐权限—微软文档</a>)</p></blockquote><h1 id="6087" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">📝要求</h1><ul class=""><li id="d610" class="kw kx hi jv b jw jx ka kb ke mj ki mk km ml kq lb lc ld le bi translated">✅ Azure 订阅</li><li id="aa90" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">✅ <a class="ae iu" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" rel="noopener ugc nofollow" target="_blank"> Azure CLI </a></li><li id="0b56" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">✅ <a class="ae iu" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">地形</a></li><li id="6759" class="kw kx hi jv b jw lf ka lg ke lh ki li km lj kq lb lc ld le bi translated">✅ <a class="ae iu" href="https://docs.microsoft.com/en-us/sql/tools/sqlcmd-utility?view=azuresqldb-current" rel="noopener ugc nofollow" target="_blank"> sqlcmd 实用程序</a></li></ul><h1 id="ca5c" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">🔧使用</h1><p id="30ea" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在克隆了这个存储库并安装了基本需求之后，在<code class="du lk ll lm ln b">./src/terraform</code>目录中运行以下命令:</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="0130" class="md iw hi ln b fi me mf l mg mh"># Login to an Azure subscription<br/>az login</span><span id="2d36" class="md iw hi ln b fi mi mf l mg mh"># Initializes Terraform<br/>terraform init</span><span id="ea0b" class="md iw hi ln b fi mi mf l mg mh"># Plans and applies this sample's Azure infrastructure using Terraform<br/># It will prompt you for your current IP Address<br/>terraform plan<br/>terraform apply</span></pre><p id="5232" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">🕐几分钟后，<code class="du lk ll lm ln b">terraform apply</code>的预期输出应该是:</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="5d6e" class="md iw hi ln b fi me mf l mg mh">null_resource.db_setup: Destroying... [id=630773934331976362]<br/>null_resource.db_setup: Destruction complete after 0s<br/>null_resource.db_setup: Creating...<br/>null_resource.db_setup: Provisioning with 'local-exec'...<br/>null_resource.db_setup (local-exec): (output suppressed due to sensitive value in config)<br/>null_resource.db_setup: Creation complete after 0s [id=7937627834098869972]</span></pre><p id="8ad5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">✔️您可以使用<a class="ae iu" href="https://portal.azure.com/" rel="noopener ugc nofollow" target="_blank"> Azure Portal </a>确认自动调优已启用，并打开 SQL 数据库自动调优设置:</p><figure class="lv lw lx ly fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/3b46b23299663a2a61b19b2e9bdeeeec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IUvUJILNHtt7zmmA.png"/></div></div></figure><h1 id="6cb2" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">🚿清理</h1><p id="7445" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">您可以使用以下方式销毁此示例的 Azure 基础架构:</p><pre class="lv lw lx ly fd lz ln ma mb aw mc bi"><span id="602f" class="md iw hi ln b fi me mf l mg mh"># Destroy this sample's Azure infrastructure using Terraform<br/>terraform destroy</span></pre><h1 id="4957" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">💙感谢您的阅读！</h1><p id="3b5d" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">如果你觉得这有用，一些👏将非常感谢进一步传播这个词。此外，如果您有其他问题或想法，请在评论中告诉我，或者在<a class="ae iu" href="https://github.com/CarlosSardo/terraform-azure-sql-automatic-tuning" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中投稿。谢谢大家！</p><h1 id="26d6" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">📗来源</h1><p id="2b78" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated"><a class="ae iu" href="https://docs.microsoft.com/en-us/azure/azure-sql/database/automatic-tuning-enable#enable-automatic-tuning-on-an-individual-database" rel="noopener ugc nofollow" target="_blank">在单个数据库上启用自动调优— Microsoft docs </a></p></div></div>    
</body>
</html>