<html>
<head>
<title>Reporting on Gov.Notify with Azure Cosmos, Analytics Services and Synapse Link</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure Cosmos、分析服务和Synapse Link报告Gov.Notify</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/reporting-on-gov-notify-with-azure-cosmos-analytics-services-and-synapse-link-26603f5d1bf7?source=collection_archive---------18-----------------------#2021-05-20">https://medium.com/nerd-for-tech/reporting-on-gov-notify-with-azure-cosmos-analytics-services-and-synapse-link-26603f5d1bf7?source=collection_archive---------18-----------------------#2021-05-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/da1647dd83b8b7d6c586a8e6c84f803d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WVC09_Shhb_N3YFh.png"/></div></div></figure><p id="3d2e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文试图讲述我们如何在Covid疫苗的国家预订服务中进行Gov.Notify报告，以及我们现在如何扩展该方法。</p><p id="0ed8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对服务使用情况的报告，如国家预订服务，实际上引领了我们向MI提供服务执行情况的方式。PowerBI在NHS Digital中大量使用，我们的分析师Michelle在引入分散数据源(如Splunk、Adobe Analytics和nightly extracts)方面做了出色的工作，提供了许多显示该服务所有KPI和统计数据的仪表板。不幸的是，由于一些摘录的性质，它们不是自动的，所以当米歇尔周末不在时，数据也不在。关于Notify的报告就是一个很好的例子。这些信息可以在Gov.Notify仪表板中找到，但不能在我们的报告中找到。此外，预订服务中发送通知信息的部分不是由NHS Digital的开发团队开发的，所以我没有完全的控制权。此外，如果消息由于类型错误而无法发送，我们对此也无能为力。幸运是，Notify提供了一个回调API！我开始建议我可以提供一个实时仪表板，我有一个计划！</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h2 id="9628" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated">最初的解决方案</h2><p id="b582" class="pw-post-body-paragraph iq ir hi is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn hb bi translated">通知回调API提供了一个很好的选项，可以将报告数据返回到服务中，而不需要知道已经发送了什么。你可以在REST文档中找到关于API的更多细节<a class="ae kv" href="https://docs.notifications.service.gov.uk/rest-api.html#callbacks" rel="noopener ugc nofollow" target="_blank">https://docs . notifications . service . gov . uk/REST-API . html # callbacks</a></p><p id="c18d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这使我能够收集关于已发送内容的所有详细信息，并在我们自己的解决方案中重新创建控制面板。最初，虽然有一个缺陷，因为我没有发送数据，所有我能告诉的是短信或电子邮件是否发送成功，我不能告诉消息是什么。我联系了Notify的团队，询问是否可以将模板ID添加到回调API中，他们同意将其添加到他们的backlog中。大约一个月后，有人联系我，告诉我它现在和模板版本一起在API中。我现在有了一些有意义的报道所需的一切。</p><p id="6e55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据收集的解决方案非常简单，一个Azure函数将数据写入cosmos db——就是这样！我需要一种能够快速接收数据的方法。我真的很喜欢你开发Azure功能的速度和无服务器的扩展方式。我们已经在预订服务的其他地方使用了Cosmos，这似乎是一个更好的机会。此外还有毫秒级响应时间、低延迟以及与功能的轻松集成。SQL的一个痛苦教训是确保我们的连接得到正确的管理。有了函数和宇宙，这是为你做的。通过在函数中定义方法，可以向Cosmos添加一个输出绑定，就这样。另一个非常好的事情是对于GET请求，您可以在绑定中指定查询，所以当函数运行时，数据已经在那里等着您使用了！关于Azure函数绑定的更多信息在文档中:<a class="ae kv" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-add-output-binding-cosmos-db-vs-code?pivots=programming-language-csharp#add-an-output-binding" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/Azure/Azure-functions/functions-add-output-binding-cosmos-d b-vs-code？pivots = programming-language-cs harp # add-an-output-binding</a></p><figure class="kw kx ky kz fd ij"><div class="bz dy l di"><div class="la lb l"/></div></figure><p id="a01e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我有了数据，我很快就收集起来了。1000万张唱片来得相当快——我们现在有4300万张。在NHS网站上获得这么多的原始数据有点不寻常，所以这是一个非常有趣的问题。在收集数据的早期，我以为我的新玩具Cosmos会让我做各种各样的查询，并且总能在几毫秒内返回答案。我们在早期对测量解决方案另一部分的RU进行了一些研究，得到了大约2 RU。我们当前拥有的行的查询统计如下:</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div class="er es lc"><img src="../Images/05c708baba7b0c5009f9b6eaa50cb174.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/1*_0FSQCu_xPNMLFqt9fdymg.png"/></div><figcaption class="ld le et er es lf lg bd b be z dx translated">从Cosmos查询4100万行的统计数据</figcaption></figure><p id="afca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我有大约1m行数据时，我编写了一个带有group by子句的典型SQL查询。Cosmos基于请求单位来衡量查询，当我达到41k时，我开始有点担心。如果我将PowerBI连接到这上面并运行这样的查询，那么我不仅会杀死Cosmos，还会杀死PowerBI。</p><h2 id="312c" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated">解决方案第2部分:Azure Analysis Services</h2><p id="d614" class="pw-post-body-paragraph iq ir hi is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn hb bi translated">我的理想是对我们的通知使用提供实时报告，但这并不像我希望的那样。我开始稍微改变我的描述，提供简单的实时数据查询，但是如果你想要完整的分析，那就太冒险了，而且不是实时的。数据传入的速度很快，运行包括写入Cosmos在内的功能需要10毫秒，这太棒了，现在把数据传出去成了问题。在这一点上，放弃这个想法回到SQL是很诱人的，但是我决定使用Cosmos！</p><p id="a217" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">搜索微软文档看起来好像我找到了解决方案——“使用Azure Cosmos DB和Power BI创建一个实时仪表板”。太好了，这正是我想做的。</p><div class="lh li ez fb lj lk"><a href="https://docs.microsoft.com/en-us/azure/cosmos-db/create-real-time-weather-dashboard-powerbi" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab dw"><div class="lm ab ln cl cj lo"><h2 class="bd hj fi z dy lp ea eb lq ed ef hh bi translated">使用Azure Cosmos DB、Azure Analysis Services和Power BI创建实时仪表板</h2><div class="lr l"><h3 class="bd b fi z dy lp ea eb lq ed ef dx translated">适用于:SQL API本文描述了在Power BI中使用…</h3></div><div class="ls l"><p class="bd b fp z dy lp ea eb lq ed ef dx translated">docs.microsoft.com</p></div></div><div class="lt l"><div class="lu l lv lw lx lt ly io lk"/></div></div></a></div><p id="344b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当涉及到ETL时，我想尽可能地避免开发。将数据放入Cosmos后，我不需要另一个数据库来进行分析。分析服务开始发挥作用。我轻松地定义了模型并部署了它。然后我连接了PowerBI。一切都进行得很顺利，直到我发布了仪表板，没有人可以访问这些数据。你可能会说许可，我也是，但这并没有解决问题。</p><p id="2c82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">NHS Digital在每个人都登录的特定AD租户中运行PowerBI。国家预订服务是在不同的租户中运行的。事实证明，您不能在PowerBI的不同租户中运行Analysis Services。然而，Analysis services并不关心Cosmos在哪里，所以在租户中快速请求一个新的订阅，并移动我再次运行的Analysis Services。分析服务也承担了所有的数据重担，PowerBI将会腾飞！</p><p id="e798" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Analysis services允许您定义分区，并且只更新特定的分区。所以在创建了历史分区之后，我现在有了一个每月分区。然而，这意味着有人需要记住创建分区，并在分区更改时更新每天早上运行的逻辑应用程序。也许我们可以自动化这一点，但时间并不总是仁慈的。将摘录运行到分析服务中的一个后果是它给Cosmos带来了沉重的负担。它每天早上运行。下图用红色显示了这一负载。我第一次看到这个的时候，我不知道它会红多久。我开始看到一些429的人爬进来。我做了什么？增加供应吞吐量缓解了这一问题，并阻止了429，但这不是我们的想法。该解决方案旨在节约成本，提高性能。一天不止一次运行这个更新感觉像是一个风险。我的实时仪表板仍然不是实时的！</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/08b035d7b51e48c45005befc0ea76815.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xHH1Egv4-vcSEno_rQcFKQ.png"/></div></div><figcaption class="ld le et er es lf lg bd b be z dx translated">宇宙RU消费</figcaption></figure><h2 id="9e0b" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated">解决方案第3部分:Azure Synapse</h2><p id="4d9c" class="pw-post-body-paragraph iq ir hi is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn hb bi translated">在我选择Analysis Services之前，我也研究过Azure Synapse。这是微软的一个新的解决方案，我以前并没有太关注它。</p><blockquote class="ma mb mc"><p id="ebde" class="iq ir md is b it iu iv iw ix iy iz ja me jc jd je mf jg jh ji mg jk jl jm jn hb bi translated"><strong class="is hj"> Azure Synapse </strong> Analytics是一项无限的分析服务，它将数据集成、企业数据仓库和大数据分析结合在一起。… <strong class="is hj"> Azure Synapse </strong>将这些世界与统一的体验结合在一起，以摄取、探索、准备、管理和提供数据，满足即时的BI和机器学习需求。</p></blockquote><p id="fd8c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我看过一个视频，看起来我不得不创建一个ETL来将Cosmos中的数据加载到Synapse中，这不是我想要做的。我不想进入Apache Spark，这意味着简单。快速入门都谈到了加载数据。所以分析服务是正确的选择。</p><p id="0c1d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但过了一会儿，我又回到了Synapse，特别是Synapse Link。有很多关于这方面的文档，只是找到正确的部分！当您在Cosmos中创建一个容器时，有一个选项可以同时创建分析存储。在创建容器后，无法完成此操作。这将创建一个与操作存储区隔离的数据列存储区。数据在它们之间自动同步，通常延迟2分钟，但最长可达5分钟。我终于得到了我承诺过的接近实时的仪表板。</p><figure class="kw kx ky kz fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mh"><img src="../Images/ecacd139689c04b8779c389dca4a4691.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DF8OnsIqE-03wDNr.png"/></div></div><figcaption class="ld le et er es lf lg bd b be z dx translated">宇宙突触链接</figcaption></figure><p id="219c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我创建了Synapse实例，并找到了一个与我想做的事情相匹配的教程。无服务器SQL就在那里，完全受管理，让我坚持我的无服务器目标。我在Synapse中创建了与宇宙的链接，然后爆炸了。我可以查询我的宇宙数据并链接到PowerBI。</p><div class="lh li ez fb lj lk"><a href="https://docs.microsoft.com/en-us/azure/cosmos-db/synapse-link-power-bi" rel="noopener  ugc nofollow" target="_blank"><div class="ll ab dw"><div class="lm ab ln cl cj lo"><h2 class="bd hj fi z dy lp ea eb lq ed ef hh bi translated">Power BI和无服务器SQL池，通过Synapse Link分析Azure Cosmos DB数据</h2><div class="lr l"><h3 class="bd b fi z dy lp ea eb lq ed ef dx translated">适用于:SQL API Azure Cosmos DB API for MongoDB在这篇文章中，您将学习如何构建一个无服务器的SQL池…</h3></div><div class="ls l"><p class="bd b fp z dy lp ea eb lq ed ef dx translated">docs.microsoft.com</p></div></div><div class="lt l"><div class="mi l lv lw lx lt ly io lk"/></div></div></a></div><p id="9223" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一切看起来都很好，或者是。我的数据集中只有30k行，一个返回前100行的简单查询需要大约5s。在NHS Digital，我们很幸运能够接触到微软的解决方案架构师，所以我打电话给我的老联系人，他帮我联系了数据专家之一Steve。我向他详细介绍了我所做的每一件事，而且都非常准确。史蒂夫解释了列存储的工作方式，它可能会慢一点，但随着数据的增长会保持一致。唷！</p><h2 id="707f" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated">不过还有最后一个问题</h2><p id="8fd1" class="pw-post-body-paragraph iq ir hi is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn hb bi translated">当将数据放入PowerBI并运行直接查询时，一切都很好，除非您转换数据。一般来说是可以的，但是某些转换不能作为直接查询来完成。在这些情况下，唯一的选择是将数据复制到PowerBI中。这个的最小刷新时间是每30分钟一次！</p><p id="bad5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编辑5月23日——自从写作以来，我意识到转换可以在Synapse的视图中完成，所以现在我有了我的实时仪表板！</p><h2 id="9335" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jb kg kh ki jf kj kk kl jj km kn ko kp bi translated">结论</h2><p id="c37e" class="pw-post-body-paragraph iq ir hi is b it kq iv iw ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn hb bi translated">现在，我已经在我们在过去几个sprints中创建的所有容器上启用了Synapse，因为我知道我需要对它们进行报告。PowerBI已连接上，Michelle正在尽可能地创建“近”实时仪表盘！</p><p id="b3cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Synapse Link提供了一种在Cosmos中获取数据的好方法，但是你需要在设计的早期就考虑到这一点。将41m的行从一个容器迁移到另一个容器需要一点时间！</p></div></div>    
</body>
</html>