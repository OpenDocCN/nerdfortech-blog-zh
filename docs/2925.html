<html>
<head>
<title>How to Send Email Using Python FastAPI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用 Python FastAPI 发送电子邮件</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-send-email-using-python-fastapi-947921059f0c?source=collection_archive---------1-----------------------#2021-05-24">https://medium.com/nerd-for-tech/how-to-send-email-using-python-fastapi-947921059f0c?source=collection_archive---------1-----------------------#2021-05-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ea0a389d558406778f32594cf1c0b3d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dpAJ06kBQq5dePX3"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com/@tma?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">天翼马</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><p id="ed2e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在进入主题之前，我们先介绍一下 FastAPI。什么是 FastAPI？</p><p id="0cb9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">直接取自官方文件:</p><blockquote class="jt ju jv"><p id="55db" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">FastAPI 是一个现代、快速(高性能)的 web 框架，用于基于标准 Python 类型提示用 Python 3.6+构建 API。</p></blockquote><p id="393d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">FastAPI 由于其速度快和易于设置，最近很受欢迎。FastAPI，Flask(除了新的 Flask 2.0)，Django 之间到底哪个更好，大概还是有争议的。但在我看来，这要追溯到我们的用例。详情可以在这里阅读<a class="ae iu" href="https://www.section.io/engineering-education/choosing-between-django-flask-and-fastapi/" rel="noopener ugc nofollow" target="_blank">https://www . section . io/engineering-education/choosing-between-django-flask-and-fastapi/</a>。</p><p id="94c4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">跳转到主话题，我们来创建一个简单的 app，通过两种方式使用 FastAPI 发送邮件，有后台任务和没有后台任务。</p></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h1 id="c045" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">在那之前</h1><p id="033e" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">在这篇文章中，我们将使用 Gmail 帐户发送电子邮件，并确保一切正常工作，你需要一个 Gmail 帐户这样做。确保您在 google 帐户设置中将<code class="du lk ll lm ln b">Allow less secure apps</code>设置为<code class="du lk ll lm ln b">On</code>。你可以这样做:</p><ol class=""><li id="8997" class="lo lp hi ix b iy iz jc jd jg lq jk lr jo ls js lt lu lv lw bi translated">点击账户图标上的<code class="du lk ll lm ln b">manage your Google account</code>(右上角)。</li></ol><p id="6793" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.转到安全选项卡。</p><figure class="ly lz ma mb fd ij er es paragraph-image"><div class="er es lx"><img src="../Images/d9ba5ab98437f2e2a221ceb8b6886e71.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/format:webp/1*bbgvcqOADTBPYUH0g5cj1w.png"/></div></figure><p id="8575" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.你会在本页找到一个部分，允许不太安全的应用程序。(在这里，我已经设置好了)</p><figure class="ly lz ma mb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/5851e0559745a7d3725de9a886235b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*odpfcmF9kL8AnDAjYNtLXw.png"/></div></div></figure><p id="c963" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.打开此设置。</p><p id="377a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您的帐户启用了双因素身份验证，这将不起作用。选择是你可以创建一个单独的帐户或创建<a class="ae iu" href="https://support.google.com/accounts/answer/185833" rel="noopener ugc nofollow" target="_blank">应用程序特定的密码</a>。</p><p id="4653" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果仍然出现验证错误，您可以尝试以下方法:</p><ol class=""><li id="c66c" class="lo lp hi ix b iy iz jc jd jg lq jk lr jo ls js lt lu lv lw bi translated">显示解锁验证码。(<a class="ae iu" href="https://accounts.google.com/b/2/DisplayUnlockCaptcha" rel="noopener ugc nofollow" target="_blank">https://accounts.google.com/DisplayUnlockCaptcha</a>)</li><li id="73c8" class="lo lp hi ix b iy md jc me jg mf jk mg jo mh js lt lu lv lw bi translated">启用 IMAP 访问。(<a class="ae iu" href="https://mail.google.com/mail/#settings/fwdandpop" rel="noopener ugc nofollow" target="_blank">https://mail.google.com/mail/#settings/fwdandpop</a>)</li></ol></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h1 id="a4cd" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">创建应用程序</h1><h2 id="024e" class="mi ki hi bd kj mj mk ml kn mm mn mo kr jg mp mq kv jk mr ms kz jo mt mu ld mv bi translated">配置虚拟环境</h2><p id="4ece" class="pw-post-body-paragraph iv iw hi ix b iy lf ja jb jc lg je jf jg lh ji jj jk li jm jn jo lj jq jr js hb bi translated">为了隔离该应用程序的环境，我们必须使用虚拟环境，在这种情况下，我将使用<code class="du lk ll lm ln b">pipenv</code>来管理虚拟环境。</p><pre class="ly lz ma mb fd mw ln mx my aw mz bi"><span id="bf2a" class="mi ki hi ln b fi na nb l nc nd">pipenv shell</span></pre><p id="485f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该命令将在虚拟环境中生成一个 shell 并生成<code class="du lk ll lm ln b">Pipfile</code>。然后，我们可以安装我们需要的依赖项。</p><pre class="ly lz ma mb fd mw ln mx my aw mz bi"><span id="04ee" class="mi ki hi ln b fi na nb l nc nd">pipenv install fastapi fastapi-mail uvicorn python-dotenv</span></pre><p id="bcd5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个<code class="du lk ll lm ln b">main.py</code>文件并将一些模板代码放入其中。</p><pre class="ly lz ma mb fd mw ln mx my aw mz bi"><span id="8a0b" class="mi ki hi ln b fi na nb l nc nd"><em class="jw">import</em> uvicorn<br/><em class="jw">from</em> fastapi <em class="jw">import</em> FastAPI, BackgroundTasks<br/><em class="jw">from</em> send_email <em class="jw">import</em> send_email_background, send_email_async</span><span id="9028" class="mi ki hi ln b fi ne nb l nc nd">app = FastAPI(title='How to Send Email')</span><span id="7e5f" class="mi ki hi ln b fi ne nb l nc nd">@app.get('/')<br/>def index():<br/>    <em class="jw">return</em> 'Hello World'</span><span id="8826" class="mi ki hi ln b fi ne nb l nc nd"><em class="jw">if</em> __name__ == '__main__':<br/>    uvicorn.run('main:app', reload=True)</span></pre><p id="416a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要运行这个应用程序，你可以输入命令<code class="du lk ll lm ln b">python main.py</code>。这个命令将启动服务器，然后您可以通过转到<a class="ae iu" href="http://localhost:8000/docs#/" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/docs</a>来查看由 FastAPI 生成的文档。</p><p id="4421" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不错…</p><p id="31c9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，创建<code class="du lk ll lm ln b">.env</code>文件来存储敏感数据。</p><pre class="ly lz ma mb fd mw ln mx my aw mz bi"><span id="ab55" class="mi ki hi ln b fi na nb l nc nd">MAIL_USERNAME=&lt;GMAIL_USERNAME&gt;<br/>MAIL_PASSWORD=&lt;GMAIL_PASSWORD&gt;<br/>MAIL_FROM=&lt;SENDER_ADDRESS&gt;<br/>MAIL_PORT=587<br/>MAIL_SERVER=smtp.gmail.com<br/>MAIL_FROM_NAME=&lt;TITLE_FOR_MAIL&gt;</span></pre><p id="c93a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建一个名为<code class="du lk ll lm ln b">send_email.py</code>的文件，然后加载<code class="du lk ll lm ln b">.env</code>。</p><pre class="ly lz ma mb fd mw ln mx my aw mz bi"><span id="3116" class="mi ki hi ln b fi na nb l nc nd"><em class="jw">import</em> os<br/><em class="jw">from</em> fastapi <em class="jw">import</em> BackgroundTasks<br/><em class="jw">from</em> fastapi_mail <em class="jw">import</em> FastMail, MessageSchema, ConnectionConfig</span><span id="429b" class="mi ki hi ln b fi ne nb l nc nd"><em class="jw">from</em> dotenv <em class="jw">import</em> load_dotenv<br/>load_dotenv('.env')</span><span id="0560" class="mi ki hi ln b fi ne nb l nc nd"><em class="jw">class</em> Envs:<br/>    MAIL_USERNAME = os.getenv('MAIL_USERNAME')<br/>    MAIL_PASSWORD = os.getenv('MAIL_PASSWORD')<br/>    MAIL_FROM = os.getenv('MAIL_FROM')<br/>    MAIL_PORT = int(os.getenv('MAIL_PORT'))<br/>    MAIL_SERVER = os.getenv('MAIL_SERVER')<br/>    MAIL_FROM_NAME = os.getenv('MAIN_FROM_NAME')</span></pre><p id="e1fe" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们有我们需要的导入和设置(我们需要 FastAPI 邮件连接配置)。然后编写连接配置和发送电子邮件的代码。</p><pre class="ly lz ma mb fd mw ln mx my aw mz bi"><span id="0c25" class="mi ki hi ln b fi na nb l nc nd">conf = ConnectionConfig(<br/>    MAIL_USERNAME=Envs.MAIL_USERNAME,<br/>    MAIL_PASSWORD=Envs.MAIL_PASSWORD,<br/>    MAIL_FROM=Envs.MAIL_FROM,<br/>    MAIL_PORT=Envs.MAIL_PORT,<br/>    MAIL_SERVER=Envs.MAIL_SERVER,<br/>    MAIL_FROM_NAME=Envs.MAIL_FROM_NAME,<br/>    MAIL_TLS=True,<br/>    MAIL_SSL=False,<br/>    USE_CREDENTIALS=True,<br/>    TEMPLATE_FOLDER='./templates/email'<br/>)</span><span id="6f74" class="mi ki hi ln b fi ne nb l nc nd"><br/>async def send_email_async(subject: str, email_to: str, body: dict):<br/>    message = MessageSchema(<br/>        subject=subject,<br/>        recipients=[email_to],<br/>        body=body,<br/>        subtype='html',<br/>    )<br/>    <br/>    fm = FastMail(conf)<br/>    <em class="jw">await</em> fm.send_message(message, template_name='email.html')</span><span id="cd34" class="mi ki hi ln b fi ne nb l nc nd"><br/>def send_email_background(background_tasks: BackgroundTasks, subject: str, email_to: str, body: dict):<br/>    message = MessageSchema(<br/>        subject=subject,<br/>        recipients=[email_to],<br/>        body=body,<br/>        subtype='html',<br/>    )</span><span id="c449" class="mi ki hi ln b fi ne nb l nc nd">    fm = FastMail(conf)<br/>    background_tasks.add_task(<br/>       fm.send_message, message, template_name='email.html')</span></pre><p id="65af" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在这个例子中，有两个函数，一个异步发送电子邮件(或者像普通函数一样)，另一个在后台发送电子邮件。在我们尝试使用这些函数后，您会注意到不同之处。</p><p id="d775" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意，我们使用 Jinja2 模板引擎生成 HTML 电子邮件。所以让我们创建一个 HTML 文件。首先，创建一个<code class="du lk ll lm ln b">templates</code>文件夹，并创建一个名为<code class="du lk ll lm ln b">email.html</code>的 HTML 文件。该文件用于连接配置(<code class="du lk ll lm ln b">TEMPLATE_FOLDER</code>)。</p><figure class="ly lz ma mb fd ij"><div class="bz dy l di"><div class="nf ng l"/></div></figure><p id="0934" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">像任何使用 Jinja2 引擎的 HTML 文件一样，我们可以在那里提供动态数据，Jinja2 将负责处理它的呈现方式。我们可以使用<code class="du lk ll lm ln b">body.property</code>模式访问它。</p><p id="863a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意，这里我们使用了内联 CSS，就像 FastAPI-MAIL 的官方文档所建议的那样。</p><blockquote class="jt ju jv"><p id="e6dd" class="iv iw jw ix b iy iz ja jb jc jd je jf jx jh ji jj jy jl jm jn jz jp jq jr js hb bi translated">在发送 HTML 电子邮件时，邮件服务器——outlook、google 等——所期望的 CSS 必须是内联 CSS。</p></blockquote><p id="1fb1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">创建发送电子邮件的路径操作。</p><pre class="ly lz ma mb fd mw ln mx my aw mz bi"><span id="b211" class="mi ki hi ln b fi na nb l nc nd">@app.get('/send-email/asynchronous')<br/>async def send_email_asynchronous():<br/>    <em class="jw">await</em> send_email_async('Hello World','someemail@gmail.com',<br/>    {'title': 'Hello World', 'name': 'John Doe'})<br/>    <em class="jw">return</em> 'Success'</span><span id="37dd" class="mi ki hi ln b fi ne nb l nc nd">@app.get('/send-email/backgroundtasks')<br/>def send_email_backgroundtasks(background_tasks: BackgroundTasks):<br/>    send_email_background(background_tasks, 'Hello World',   <br/>    'someemail@gmail.com', {'title': 'Hello World', 'name':       'John Doe'})<br/>    <em class="jw">return</em> 'Success'</span></pre><p id="24ad" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">保存所有文件，服务器将重新加载。现在，刷新文档页面。</p><p id="0f56" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您将看到两个新的端点，即<code class="du lk ll lm ln b">/send-email/asynchronous</code>和<code class="du lk ll lm ln b">/send-email/backgroundtasks</code>。尝试两个端点以查看差异。</p><p id="3582" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当您使用异步调用服务器时，您会在文档中看到一个加载指示器，因为应用程序需要时间来发送电子邮件。但是如果使用后台任务，客户端不需要等待操作完成。当我们向用户发送电子邮件或通知时，这个功能会很有用。这里更多关于后台任务<a class="ae iu" href="https://fastapi.tiangolo.com/tutorial/background-tasks/" rel="noopener ugc nofollow" target="_blank">https://fastapi.tiangolo.com/tutorial/background-tasks/</a>。</p><p id="d971" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是电子邮件发送后的外观:</p><figure class="ly lz ma mb fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nh"><img src="../Images/c79697777deab14dd045bbdd65ea8fc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VQExV-Xh7gqMXioKfu3AKg.png"/></div></div></figure><p id="491c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你可以在这里找到这篇文章的代码，<a class="ae iu" href="https://github.com/agusrichard/fastapi-workbook/tree/master/send-email" rel="noopener ugc nofollow" target="_blank">https://github . com/agusrichard/fastapi-workbook/tree/master/send-email</a>。</p><p id="ef3a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望这篇文章对你来说是一个很好的资源，谢谢你的阅读。</p></div><div class="ab cl ka kb gp kc" role="separator"><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf kg"/><span class="kd bw bk ke kf"/></div><div class="hb hc hd he hf"><h1 id="4679" class="kh ki hi bd kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le bi translated">参考资料:</h1><ul class=""><li id="62cd" class="lo lp hi ix b iy lf jc lg jg ni jk nj jo nk js nl lu lv lw bi translated">https://fastapi.tiangolo.com/<a class="ae iu" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"/></li><li id="7887" class="lo lp hi ix b iy md jc me jg mf jk mg jo mh js nl lu lv lw bi translated">【https://sabuhish.github.io/fastapi-mail/ T4】</li><li id="39d4" class="lo lp hi ix b iy md jc me jg mf jk mg jo mh js nl lu lv lw bi translated"><a class="ae iu" href="https://www.geeksforgeeks.org/sending-email-using-fastapi-framework-in-python/" rel="noopener ugc nofollow" target="_blank">https://www . geeks forgeeks . org/sending-email-using-fastapi-framework-in-python/</a></li><li id="188e" class="lo lp hi ix b iy md jc me jg mf jk mg jo mh js nl lu lv lw bi translated"><a class="ae iu" href="https://www.twilio.com/blog/2018/03/send-email-programmatically-with-gmail-python-and-flask.html" rel="noopener ugc nofollow" target="_blank">https://www . twilio . com/blog/2018/03/send-email-programmably-with-Gmail-python-and-flask . html</a></li><li id="672a" class="lo lp hi ix b iy md jc me jg mf jk mg jo mh js nl lu lv lw bi translated"><a class="ae iu" href="https://mailtrap.io/blog/flask-email-sending/" rel="noopener ugc nofollow" target="_blank">https://mailtrap.io/blog/flask-email-sending/</a></li></ul></div></div>    
</body>
</html>