<html>
<head>
<title>Running a Scale-Out Database on ARM as a MySQL Alternative</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">作为 MySQL 的替代方案，在 ARM 上运行横向扩展数据库</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/running-a-scale-out-database-on-arm-as-a-mysql-alternative-a3f626e32fb3?source=collection_archive---------0-----------------------#2020-11-02">https://medium.com/nerd-for-tech/running-a-scale-out-database-on-arm-as-a-mysql-alternative-a3f626e32fb3?source=collection_archive---------0-----------------------#2020-11-02</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/0f49ccbb21cfe20f5326bd47f252d98d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G_jR9dGE_IUWPHaD.jpg"/></div></div></figure><p id="cfac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">行业:媒体和娱乐</p><p id="9af4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">作者:黄碧荣(U-Next 高级工程师)</p><p id="8624" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">U-Next 是一个基于订阅的视频流媒体平台，在日本拥有最大的市场份额。在过去几年中，我们的业务增长迅速，而我们的旧 IT 基础架构已经跟不上发展的步伐。我们需要升级我们的系统。</p><p id="c998" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们以前的 MySQL 集群很难扩展，而且，当服务器经历高并发时，集群具有高延迟。为了解决这些问题，我们将数据迁移到了<a class="ae jo" href="https://docs.pingcap.com/tidb/dev" rel="noopener ugc nofollow" target="_blank"> TiDB </a>，这是一个开源的分布式 SQL 数据库，提供了水平可伸缩性和高性能。它使用 MySQL 协议，在我们的<a class="ae jo" href="https://en.wikipedia.org/wiki/ARM_architecture" rel="noopener ugc nofollow" target="_blank"> ARM 架构</a>上完美运行。感谢 TiDB，我们能够为我们的用户提供更优质的服务。</p><p id="9795" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我将与您分享为什么我们选择将数据放在 TiDB 中并在 ARM 上运行。此外，我将提供详细的 TiDB 在 ARM 上的基准测试。我希望我们的故事可以帮助您找到适合您的应用程序的数据库解决方案。</p><h1 id="8f00" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">为什么我们选择 TiDB 来取代 MySQL</h1><p id="2cab" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">在我们迁移到 TiDB 之前，我们使用 MySQL。为了提高数据库性能，我们选择了<a class="ae jo" href="https://github.com/Qihoo360/Atlas" rel="noopener ugc nofollow" target="_blank"> Atlas </a>，它是<a class="ae jo" href="https://github.com/mysql/mysql-proxy" rel="noopener ugc nofollow" target="_blank"> MySQL 代理</a>的一个分支，来拆分 MySQL 集群的读写请求。系统架构如下所示:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/39b783da8dd673015c226e955cc11f04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uhXifWDgmZrqr41x.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">我们以前的系统架构</figcaption></figure><p id="f707" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，这种实现有几个问题:</p><ul class=""><li id="5afb" class="lb lc hi is b it iu ix iy jb ld jf le jj lf jn lg lh li lj bi translated">Atlas 项目很少得到维持。如果出现了 bug，我们的工程团队没有资源自己解决它。</li><li id="229b" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated">横向扩展后端 MySQL 集群是一件痛苦的事情。</li><li id="ee10" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated">随着服务器并发性的增加，延迟也急剧增加。</li></ul><p id="cebd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们回顾了我们面临的困难和我们业务的新要求，并决定迁移到一个新的数据库，该数据库:</p><ul class=""><li id="c09e" class="lb lc hi is b it iu ix iy jb ld jf le jj lf jn lg lh li lj bi translated"><strong class="is hj">没有明显的瓶颈。</strong>我们想要一个水平可扩展的数据库。例如，我们有一个每月增长 1 亿行的表。每个用户登录都需要访问该表。如果数据库不能横向扩展，可能会严重影响我们的服务质量。</li><li id="7387" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><strong class="is hj">高可用。</strong>我们希望能够在线升级和扩展新数据库。</li><li id="2edb" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><strong class="is hj">拥有活跃的社区和可用的技术支持。使用开源项目的一个潜在问题是作者可能会停止维护它。因此，我们能够获得长期、可持续的技术支持非常重要。</strong></li><li id="e065" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><strong class="is hj">迁移成本低。</strong>迁移到一个新的数据库既麻烦又昂贵，不仅因为我们需要购买新的硬件和软件，还因为我们必须修改应用程序代码。所以我们希望尽可能少地修改代码。</li></ul><p id="6048" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">考虑到这些因素，我们认为 TiDB 是 U-Next 的最佳选择。TiDB 是一个分布式数据库，提供水平可伸缩性和高可用性。此外，TiDB 在 GitHub 上有超过 25，000 颗星，这是其活跃社区的证明。最后但同样重要的是，它是 MySQL 兼容的。我们只需要修改一小部分代码就可以将应用程序集成到 TiDB 中。</p><h1 id="9dc2" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">为什么我们在 ARM 上运行任务关键型 TiDB 数据库</h1><p id="e088" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">正如我提到的，我们在 ARM 架构上运行 TiDB。因为大多数公司使用 x86 作为他们的服务器，所以我们在 ARM 上运行数据库似乎不太寻常。我们选择 ARM 有三个主要原因:成本、兼容性和维护。</p><ul class=""><li id="307d" class="lb lc hi is b it iu ix iy jb ld jf le jj lf jn lg lh li lj bi translated"><strong class="is hj"> ARM 处理器更便宜</strong>，所以更适合中小型公司。</li><li id="775b" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><strong class="is hj"> TiDB 已经在 ARM </strong>上正式测试验证。<a class="ae jo" href="https://pingcap.com/" rel="noopener ugc nofollow" target="_blank">TiDB 背后的团队 PingCAP </a>发布了一份针对 ARM64 和 x86–64 的<a class="ae jo" href="https://pingcap.com/blog/porting-tidb-to-arm64-for-greater-flexibility/" rel="noopener ugc nofollow" target="_blank">官方基准测试报告</a>，确认 TiDB 与 ARM 不存在兼容性问题。</li><li id="725a" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><strong class="is hj">手臂可靠。</strong> U-Next 多年来一直使用 ARM 作为其分布式存储平台，并且进展顺利。我们的工程团队在维护 ARM 方面经验丰富。</li></ul><p id="1242" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，我们决定在 ARM 上运行任务关键型 TiDB，就像我们的其他应用程序一样。</p><h1 id="73c7" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">ARM 和 x86A 上的基准测试 TiDB</h1><p id="7fef" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">为了确保 TiDB 在我们的应用中与 ARM 兼容，我们在采用 ARM 和 x86 架构的服务器之间进行了基准测试。我们将测试环境设置如下:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/ba51854b46238c0e1d2a73b5b80977f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4BAzWbijGVG1wYtQ1So6kw.png"/></div></div></figure><p id="e085" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基于我们自己的应用模型，我们使用<a class="ae jo" href="https://github.com/locustio/locust" rel="noopener ugc nofollow" target="_blank">轨迹</a>来模拟在线请求负载。每个客户端每秒发送一个请求。我们测试了一个有 3 亿行样本数据的表。每个操作包括一个<code class="du lq lr ls lt b">Get</code>、一个<code class="du lq lr ls lt b">Post</code>和一个<code class="du lq lr ls lt b">Put</code>方法。我们总共发送了 200，000 个 API 请求。</p><p id="a340" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下图显示了每秒请求数(RPS)结果。x 轴代表客户端数量，y 轴代表已处理的 RPS 数量:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/fff89f77c381ad3786a68dc603899727.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Bjk1NYt87nkPHSKO.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">ARM 和 x86 的 RPS 结果</figcaption></figure><p id="5452" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当有 50、100、150 和 200 个客户端时，ARM 的执行速度比 x86 稍慢，这是可以接受的。</p><p id="d459" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们还测试了<code class="du lq lr ls lt b">GET</code>、<code class="du lq lr ls lt b">POST</code>和<code class="du lq lr ls lt b">PUT</code>方法的响应延迟:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/18ce85337361e34276b6c6cdc1e845fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pllICD2g-EDyhgNZ.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">GET、POST 和 PUT 的响应延迟</figcaption></figure><p id="0217" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们将两组结果结合起来，很明显，当有大约 150 个客户机时，单个 API 服务器的瓶颈就出现了。当客户端数量超过 150 时，即使我们添加更多的客户端，RPS 也不会变高，但延迟可能会继续增加。</p><p id="584c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从这个测试中，我们知道 TiDB 的性能在 ARM 和 x86 之间没有显著差异。对于我们的应用程序，这种微小的差异是可以接受的。</p><p id="1f26" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2019 年底，我们把数据迁移到 TiDB。在迁移之前，我们在高峰时段经常有多达 6，000 个缓慢的请求(响应&gt; = 500 毫秒)。但是，在迁移之后，同一时间段的慢速请求数量下降到 600 个以下。换句话说，TiDB 将我们应用程序中的慢速请求数量减少了 10 倍。</p><p id="6c0e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们还将 TiDB 迁移到了另一个数据中心。API 服务器和 TiDB 位于不同的数据中心，并通过专用连接进行连接。即使网络延迟增加了 1-2 毫秒，TiDB 仍然改善了整体服务。这太令人兴奋了。</p><h1 id="6456" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">面向 ARM 的性能调优</h1><p id="9176" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们还专门针对 ARM 架构调整了 TiDB 集群的性能。此次调优主要集中在<a class="ae jo" href="https://www.percona.com/blog/2019/03/06/settling-the-myth-of-transparent-hugepages-for-databases/" rel="noopener ugc nofollow" target="_blank">透明大页</a> (THP)和 NUMA 装订。</p><p id="f56d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">多亏了 PingCAP，我们发现 THP 在 ARM 性能上有所作为。当测试数据量大约为 100 GB 时，THP 可能会导致 TiKV 内存不足的情况。所以我们强烈建议在 ARM 上禁用 THP。</p><p id="4f72" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们的平台上，ARM 有四个<a class="ae jo" href="https://en.wikipedia.org/wiki/Non-uniform_memory_access" rel="noopener ugc nofollow" target="_blank"> NUMA </a>节点。在 ARM 上，CPU 参与内存处理。如果默认情况下 CPU 内核没有映射到 NUMA 节点，那么 NUMA 节点越多，延迟就越高。因此，为了减少延迟，我们将进程和网络接口卡绑定到相应的 NUMA 节点。</p><p id="79aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">TiDB 的性能非常好，除了数据极其庞大的场景，它不需要进行性能调优。在我们调整了 NUMA 配置之后，ARM 和 x86 之间的基准测试结果几乎相同:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/76541404a9c59a17964c373ce7e0d37a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sZIZkFNQAzK-2gYs.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">配置 NUMA 后 ARM 和 x86 的 RPS 结果</figcaption></figure><h1 id="0ef1" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">结论</h1><p id="af3b" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">TiDB 帮助 U-Next 建立了一个更稳定、更快速的视频流平台，使我们能够为客户提供优质服务。它通过横向可扩展性和惊人的性能解决了传统 MySQL 架构的痛点。我希望这篇文章能帮助你了解更多关于 TiDB 的知识，以及如何在 ARM 上运行 TiDB。</p></div></div>    
</body>
</html>