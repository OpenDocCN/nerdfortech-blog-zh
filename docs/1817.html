<html>
<head>
<title>How to use GraphQL with Redux</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 Redux 中使用 GraphQL</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-use-graphql-with-redux-50ad20ec051f?source=collection_archive---------0-----------------------#2021-04-09">https://medium.com/nerd-for-tech/how-to-use-graphql-with-redux-50ad20ec051f?source=collection_archive---------0-----------------------#2021-04-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1961" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每隔一段时间，当一项新技术出现时，我们认为它应该取代旧技术，对此我并不完全同意。</p><p id="11fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，我们有 Apollo GraphQL 处理您的异步调用、状态缓存…所以看起来它就是您所需要的全部。那么，如果你是一个有点老的学校，你想让你的异步远离你的组件，你的状态由你控制，让我们看看如何用阿波罗和 redux 做到这一点。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/27be4bad20cc46c73072dbb1ce62c584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u9LK7ayW2XCmK3JB5BOl4g.jpeg"/></div></div></figure><p id="7b61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我希望 GraphQL 客户端只负责我的 API 调用，所以我将它作为 redux 上下文的一部分，这样我就可以在我的异步层中使用它。(<em class="jp">对于这个例子，我将使用</em> <strong class="ih hj"> <em class="jp"> redux-thunk </em> </strong>)</p></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><p id="8d52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一个 GraphQL 客户端。<br/> <em class="jp"> gql-client.ts </em></p><pre class="je jf jg jh fd jx jy jz ka aw kb bi"><span id="a46a" class="kc kd hi jy b fi ke kf l kg kh"><em class="jp">import </em>{ ApolloClient, InMemoryCache } <em class="jp">from </em>'@apollo/client';<br/><em class="jp">import </em>{ <em class="jp">createUploadLink </em>} <em class="jp">from </em>'apollo-upload-client';</span><span id="c4a8" class="kc kd hi jy b fi ki kf l kg kh"><em class="jp">export type GraphQLClient </em>= void</span><span id="f59e" class="kc kd hi jy b fi ki kf l kg kh"><em class="jp">export const createGQLClient </em>= (): <em class="jp">GraphQLClient </em>=&gt; {<br/>  <em class="jp">const </em>cache = <em class="jp">new </em>InMemoryCache({<br/>    addTypename: <em class="jp">false</em>,<br/>    resultCaching: <em class="jp">false</em>,<br/>  });<br/><br/>  <em class="jp">const </em>client = <em class="jp">new </em>ApolloClient({<br/>    <em class="jp">// Provide required constructor fields<br/>    </em>cache: cache,<br/>    link: <em class="jp">createUploadLink</em>({<br/>      uri: API_URL_FROM_ENV,<br/>      includeUnusedVariables: <em class="jp">false</em>,<br/>      credentials: 'include',<br/>    }),<br/>    defaultOptions: {<br/>      watchQuery: {<br/>        fetchPolicy: 'no-cache',<br/>      },<br/>      mutate: {<br/>        fetchPolicy: 'no-cache',<br/>      },<br/>    },<br/>  });<br/>}</span></pre><p id="1d9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，这看起来不错，我们已经创建了一个客户端，但我们希望能够查询和改变数据，对不对？让我们添加查询和变异方法</p><pre class="je jf jg jh fd jx jy jz ka aw kb bi"><span id="9fce" class="kc kd hi jy b fi ke kf l kg kh"><em class="jp">type Query </em>= &lt;QV, RT&gt;(<em class="jp">name</em>: <em class="jp">string</em>, <em class="jp">query</em>: <em class="jp">DocumentNode</em>, <em class="jp">variables</em>?: QV) =&gt; <em class="jp">Promise</em>&lt;RT&gt;;</span><span id="21f2" class="kc kd hi jy b fi ki kf l kg kh"><em class="jp">type Mutate </em>= &lt;MV, RT&gt;(<em class="jp">name</em>: <em class="jp">string</em>, <em class="jp">mutation</em>: <em class="jp">DocumentNode</em>, <em class="jp">variables</em>?: MV) =&gt; <em class="jp">Promise</em>&lt;RT&gt;;</span></pre><p id="bec4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们扩展我们的<strong class="ih hj"> <em class="jp"> GraphQLClient </em> </strong></p><pre class="je jf jg jh fd jx jy jz ka aw kb bi"><span id="3d6f" class="kc kd hi jy b fi ke kf l kg kh"><em class="jp">export type GraphQLClient </em>= {<br/>  query: <em class="jp">Query</em>;<br/>  mutate: <em class="jp">Mutate</em>;<br/>}</span></pre><p id="69b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们添加方法</p><pre class="je jf jg jh fd jx jy jz ka aw kb bi"><span id="12c4" class="kc kd hi jy b fi ke kf l kg kh"><em class="jp">const </em>query: <em class="jp">Query </em>= (<em class="jp">name</em>, <em class="jp">query</em>, <em class="jp">variables</em>) =&gt; {<br/>  <em class="jp">return </em>client<br/>    .query({<br/>      <em class="jp">query</em>,<br/>      <em class="jp">variables</em>,<br/>      fetchPolicy: 'no-cache',<br/>    })<br/>    .then(({ <em class="jp">data </em>}) =&gt; <em class="jp">data</em>[<em class="jp">name</em>]);<br/>};<br/><br/><em class="jp">const </em>mutate: <em class="jp">Mutate </em>= (<em class="jp">name</em>, <em class="jp">mutation</em>, <em class="jp">variables</em>) =&gt; {<br/>  <em class="jp">return </em>client<br/>    .mutate({<br/>      <em class="jp">mutation</em>,<br/>      <em class="jp">variables</em>,<br/>    })<br/>    .then(({ <em class="jp">data </em>}) =&gt; <em class="jp">data</em>[<em class="jp">name</em>]);<br/>};</span></pre><p id="37bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以我们的客户现在看起来像这样</p><pre class="je jf jg jh fd jx jy jz ka aw kb bi"><span id="95e3" class="kc kd hi jy b fi ke kf l kg kh"><em class="jp">import </em>{ ApolloClient, <em class="jp">DocumentNode</em>, InMemoryCache } <em class="jp">from </em>'@apollo/client';<br/><em class="jp">import </em>{ <em class="jp">createUploadLink </em>} <em class="jp">from </em>'apollo-upload-client';<br/><br/><em class="jp">type Query </em>= &lt;QV, RT&gt;(<em class="jp">name</em>: <em class="jp">string</em>, <em class="jp">query</em>: <em class="jp">DocumentNode</em>, <em class="jp">variables</em>?: QV) =&gt; <em class="jp">Promise</em>&lt;RT&gt;;<br/><em class="jp">type Mutate </em>= &lt;MV, RT&gt;(<em class="jp">name</em>: <em class="jp">string</em>, <em class="jp">mutation</em>: <em class="jp">DocumentNode</em>, <em class="jp">variables</em>?: MV) =&gt; <em class="jp">Promise</em>&lt;RT&gt;;<br/><br/><em class="jp">export type GraphQLClient </em>= {<br/>  query: <em class="jp">Query</em>;<br/>  mutate: <em class="jp">Mutate</em>;<br/>};<br/><br/><em class="jp">export const createGQLClient </em>= (): <em class="jp">GraphQLClient </em>=&gt; {<br/>  <em class="jp">const </em>cache = <em class="jp">new </em>InMemoryCache({<br/>    addTypename: <em class="jp">false</em>,<br/>    resultCaching: <em class="jp">false</em>,<br/>  });<br/><br/>  <em class="jp">const </em>client = <em class="jp">new </em>ApolloClient({<br/>    <em class="jp">// Provide required constructor fields<br/>    </em>cache: cache,<br/>    link: <em class="jp">createUploadLink</em>({<br/>      uri: API_URL_FROM_ENV,<br/>      includeUnusedVariables: <em class="jp">false</em>,<br/>      credentials: 'include',<br/>    }),<br/>    defaultOptions: {<br/>      watchQuery: {<br/>        fetchPolicy: 'no-cache',<br/>      },<br/>      mutate: {<br/>        fetchPolicy: 'no-cache',<br/>      },<br/>    },<br/>  });<br/><br/>  <em class="jp">const </em>query: <em class="jp">Query </em>= (<em class="jp">name</em>, <em class="jp">query</em>, <em class="jp">variables</em>) =&gt; {<br/>    <em class="jp">return </em>client<br/>      .query({<br/>        <em class="jp">query</em>,<br/>        <em class="jp">variables</em>,<br/>        fetchPolicy: 'no-cache',<br/>      })<br/>      .then(({ <em class="jp">data </em>}) =&gt; <em class="jp">data</em>[<em class="jp">name</em>]);<br/>  };<br/><br/>  <em class="jp">const </em>mutate: <em class="jp">Mutate </em>= (<em class="jp">name</em>, <em class="jp">mutation</em>, <em class="jp">variables</em>) =&gt; {<br/>    <em class="jp">return </em>client<br/>      .mutate({<br/>        <em class="jp">mutation</em>,<br/>        <em class="jp">variables</em>,<br/>      })<br/>      .then(({ <em class="jp">data </em>}) =&gt; <em class="jp">data</em>[<em class="jp">name</em>]);<br/>  };<br/><br/>  <em class="jp">return </em>{ query, mutate };<br/>};</span></pre><p id="6f79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，让我们创建一个<strong class="ih hj"> Redux </strong>商店，并将我们的客户添加到其中</p><pre class="je jf jg jh fd jx jy jz ka aw kb bi"><span id="7c46" class="kc kd hi jy b fi ke kf l kg kh"><em class="jp">import </em>{ createStore, <em class="jp">applyMiddleware</em>, <em class="jp">combineReducers </em>} <em class="jp">from </em>'redux';<br/><em class="jp">import </em>thunk <em class="jp">from </em>'redux-thunk';</span><span id="92e7" class="kc kd hi jy b fi ki kf l kg kh"><em class="jp">...</em></span><span id="6f47" class="kc kd hi jy b fi ki kf l kg kh"><em class="jp">import </em>{ <em class="jp">createGQLClient </em>} <em class="jp">from </em>'..../gql-client';<br/><br/><em class="jp">const </em>rootReducer = <em class="jp">combineReducers</em>({<em class="jp"><br/>  ... // Your Reducers</em><br/>});<br/><br/><em class="jp">export type StoreState </em>= {<br/>  ... // Store Type Parts<br/>};<br/><br/><em class="jp">export const </em>store = createStore(<br/>  rootReducer,<br/>  <em class="jp">applyMiddleware</em>(<br/>    thunk.<em class="jp">withExtraArgument</em>({ client: <em class="jp">createGQLClient</em>() })<br/>  )<br/>);</span></pre><p id="fb0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经为 ActionCreators 提供了我们的客户端，让我们创建一个示例变异任务</p><p id="6a39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jp">createorganizationtask . ts</em></p><pre class="je jf jg jh fd jx jy jz ka aw kb bi"><span id="2c97" class="kc kd hi jy b fi ke kf l kg kh"><em class="jp">import </em>{ gql } <em class="jp">from </em>'@apollo/client/core';<br/><em class="jp">import </em>{<br/>  <em class="jp">Organization,<br/>  SetOrganizationAction</em>,<br/>  <em class="jp">SetOrganizationErrorAction</em>,<br/>  <em class="jp">SetOrganizationRequestInProgressAction</em>,<br/>} <em class="jp">from </em>'../types';</span><span id="3b5e" class="kc kd hi jy b fi ki kf l kg kh"><em class="jp">import </em>{<br/>  setOrganizationAction,<br/>  setOrganizationErrorAction,<br/>  setOrganizationRequestInProgress<br/>} <em class="jp">from </em>'../actions';<br/><br/><em class="jp">export type CreateOrganizationPayload </em>= <em class="jp">Pick</em>&lt;<em class="jp">Organization</em>, 'name'&gt;;<br/><br/><em class="jp">const </em>CREATE_ORGANIZATION = <em class="jp">gql</em>`<br/>  mutation createOrganization($name: String!) {<br/>    createOrganization(name: $name) {<br/>      identity<br/>      name<br/>      createdAt<br/>    }<br/>  }<br/>`;<br/><br/><em class="jp">export const createOrganizationTask</em> = (<br/>  <em class="jp">data: CreateOrganizationPayload<br/>) </em>=&gt; (<em class="jp">dispatch</em>, <em class="jp">_</em>, { <em class="jp">client </em>}) =&gt; {<br/>  <em class="jp">dispatch</em>(setOrganizationRequestInProgress(true));<br/>  <em class="jp">return client<br/>    </em>.mutate&lt;<em class="jp">CreateOrganizationPayload</em>, <em class="jp">Organization</em>&gt;('createOrganization', CREATE_ORGANIZATION, <em class="jp">data</em>)<br/>    .then(<em class="jp">data </em>=&gt; <em class="jp">dispatch</em>(<em class="jp">SetOrganizationAction</em>(data))))<br/>    .catch((e) =&gt; <em class="jp">dispatch</em>(setOrganizationErrorAction(e.message)))<br/>    .finaly(() =&gt; <em class="jp">dispatch</em>(setOrganizationRequestInProgress(false)))<br/>};</span></pre><p id="df47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这同样适用于数据查询</p><p id="183e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jp"> getOrganizationTask.ts </em></p><pre class="je jf jg jh fd jx jy jz ka aw kb bi"><span id="0819" class="kc kd hi jy b fi ke kf l kg kh"><em class="jp">import </em>{ gql } <em class="jp">from </em>'@apollo/client/core';<br/><br/><em class="jp">import </em>{<br/>  <em class="jp">Organization</em>,<br/>  <em class="jp">SetOrganizationAction</em>,<br/>  <em class="jp">SetOrganizationErrorAction</em>,<br/>  <em class="jp">SetOrganizationRequestInProgressAction</em>,<br/>} <em class="jp">from </em>'../types';<br/><em class="jp">import </em>{<br/>  setOrganizationAction,<br/>  setOrganizationErrorAction,<br/>  setOrganizationRequestInProgress<br/>} <em class="jp">from </em>'../actions';<br/><br/><em class="jp">const </em>GET_ORGANIZATION = <em class="jp">gql</em>`<br/>  query getOrganization($identity: String!) {<br/>    getOrganization(identity: $identity) {<br/>      identity<br/>      name<br/>      createdAt<br/>      clearanceLevel<br/>      owner {<br/>        username<br/>        firstName<br/>        lastName<br/>      }<br/>    }<br/>  }<br/>`;<br/><br/><em class="jp">export const getOrganizationTask </em>= <em class="jp">identity </em>=&gt; (<em class="jp">dispatch</em>, <em class="jp">_</em>, { <em class="jp">client </em>}) =&gt; {<br/>  <em class="jp">dispatch</em>(setOrganizationRequestInProgress());<br/>  <em class="jp">return client<br/>    </em>.query&lt;<em class="jp">unknown</em>, <em class="jp">Organization </em>| <em class="jp">null</em>&gt;(<br/>      'getOrganization', <br/>      GET_ORGANIZATION,<br/>      { <em class="jp">identity </em>}<br/>    )<br/>    .then(<em class="jp">data </em>=&gt; <em class="jp">dispatch</em>(setOrganizationAction(<em class="jp">data</em>)))<br/>    .catch((e) =&gt; <em class="jp">dispatch</em>(setOrganizationErrorAction(e.message)))<br/>    .finaly(() =&gt; <em class="jp">dispatch</em>(setOrganizationRequestInProgress(false)))<br/>};</span></pre><p id="e410" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样…我们的应用程序现在使用 GraphQL 进行 API 通信，所以我们可以获得它真正强大的特性，但是我们的状态是干净的，由 redux 管理，所以我们的应用程序甚至不知道 GQL。</p></div><div class="ab cl jq jr gp js" role="separator"><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv jw"/><span class="jt bw bk ju jv"/></div><div class="hb hc hd he hf"><p id="f39e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">想象一下，如果将来由于技术上的需要，你不得不从 GraphQL 转换过来，那么在任何地方改变每一个组件都可能是难以处理的。但是…通过这种方式，你只需修改你的异步层，因为你的应用程序逻辑与它完全解耦，所以不管你使用的是 RestApi、GraphQL 还是其他什么。</p><p id="b596" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jp">编码快乐！</em></p></div></div>    
</body>
</html>