<html>
<head>
<title>Design a payment system using Django Rest Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Django Rest 框架设计一个支付系统</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/design-a-payment-system-using-django-rest-framework-bf8e36c3955?source=collection_archive---------0-----------------------#2021-06-08">https://medium.com/nerd-for-tech/design-a-payment-system-using-django-rest-framework-bf8e36c3955?source=collection_archive---------0-----------------------#2021-06-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4ea5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我们将使用 Django Rest 框架设计一个支付系统 API。在继续之前，我想让您了解一下 DBMS 中的 MVCC 沃尔。你也可以通过<a class="ae jd" rel="noopener" href="/swlh/django-and-isolation-40d28f469aa">链接</a>。到现在为止，我猜你对沃尔或 MVCC 已经有了相当的了解了吧？</p><h1 id="ec4a" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">让我们来谈谈我们的建筑</h1><p id="8e8d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">这就是我们的建筑看起来的样子，它不是一个理想的建筑，但却是我们容易理解的基础建筑。在此图中，我们没有添加其他功能，如异步任务队列或缓存层等。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es kh"><img src="../Images/a2f08901619e7dffd8902daeffb57f15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x28AOvTIQb-8CBxCiSTKAw.png"/></div></div></figure><p id="331a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们假设，在我们的系统中有三个用户<strong class="ih hj">用户一、用户二和用户三。</strong>用户一正试图向用户二支付 X 金额。</p><p id="a91e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用户一发起支付请求，它将通过负载均衡器到达我们的服务器。在数据库级别，我们将以事务组的形式执行命令。如果该组的任何命令失败，它将回滚到其先前的状态，或者特定的事务不会发生，并且用户将收到其事务的最终状态的通知。</p><h1 id="f30f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">让我们看看单个事务是什么样子的</h1><p id="768a" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">当把钱从一个账户转移到另一个账户时，这些操作将被执行。</p><ol class=""><li id="ce2f" class="kt ku hi ih b ii ij im in iq kv iu kw iy kx jc ky kz la lb bi translated">检查用户 1 的账户中是否有足够的余额。如果是，那么我们将继续交易或将提出一个错误说<strong class="ih hj">余额不足。</strong></li><li id="f1e1" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">下一步是从用户一个帐户中减去 X 金额。</li><li id="d12d" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">减去我们的支付处理费示例:0.75</li><li id="cac8" class="kt ku hi ih b ii lc im ld iq le iu lf iy lg jc ky kz la lb bi translated">将相同的 X 金额添加到用户二的帐户。</li></ol><p id="e9bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，如果我们没有遇到任何错误，那么该事务将提交到数据库，否则没有任何内容进入数据库。</p><h1 id="dcb9" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">让我们进入实现部分</h1><p id="b515" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">在跳转到实际的代码实现之前，让我们快速总结一下我们将要开发的所有端点或者需要什么数据库等等。在这篇文章中，我们将使用 MySQL 作为数据库。</p><p id="8a98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">后端 API 端点</p><pre class="ki kj kk kl fd lh li lj lk aw ll bi"><span id="03d9" class="lm jf hi li b fi ln lo l lp lq">POST /register<br/>POST /login<br/>GET /balance<br/>POST /balance<br/>POST /transfer</span></pre><p id="f8ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Auth API 是公共端点，任何人都可以访问它们，而 balance 和 transfer 端点是受保护的端点，只有经过身份验证的用户才能使用它们。</p><h2 id="2c9c" class="lm jf hi bd jg lr ls lt jk lu lv lw jo iq lx ly js iu lz ma jw iy mb mc ka md bi translated">Django 用户模型</h2><p id="c36d" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">让我们保持我们的模型简单明了。我们将在用户模型本身中存储 account_balance。这是我们的用户模型的样子。我意识到我忘了在用户模型中添加 created_at &amp; updated_at。让我们暂时忽略它，继续前进。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es me"><img src="../Images/db83fc8b568cc494dc6db12ec3d8db09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FcoABZvKn31L8814Bez5-Q.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">用户模型</figcaption></figure><h2 id="3a7e" class="lm jf hi bd jg lr ls lt jk lu lv lw jo iq lx ly js iu lz ma jw iy mb mc ka md bi translated">授权 API</h2><p id="ccad" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">对于认证，我们使用一个名为<a class="ae jd" href="https://jpadilla.github.io/django-rest-framework-jwt/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">rest _ framework _ jwt</strong></a><strong class="ih hj">的包。</strong>使用这个包，我们实际上不需要实现登录 API，因为它开箱即用。我们只需要导入登录视图并使用它。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mj"><img src="../Images/935b97d307e9b20f52e7904ba4054916.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-CLdYy87HajvRbslEa0CoA.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">登录 API</figcaption></figure><p id="d702" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于注册 API，我们需要编写一个 API 视图</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mk"><img src="../Images/4a7e58bffe15ffa05bc262d079315341.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OSGm3DO8-F61GBfJzN4RVw.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">注册 API 视图</figcaption></figure><p id="9c52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在 auth API 之后是我们系统中最重要的部分。</p><h2 id="2085" class="lm jf hi bd jg lr ls lt jk lu lv lw jo iq lx ly js iu lz ma jw iy mb mc ka md bi translated">平衡 API</h2><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es ml"><img src="../Images/4b9c46419a6a55d706fdeacd424f59ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vr2qAKG-LsrgcA_EekjAng.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">平衡 API 视图集</figcaption></figure><p id="a9b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在第 42 行，我们调用<code class="du mm mn mo li b">transaction.atomic</code>作为上下文管理器。你可能会想，在给我们的账户增加余额时，我们为什么要使用交易？为了防止多个并发请求到达服务器时出现不一致，我们将它实现为一个事务。这个 API 将服务于两个目的，获取我们的帐户余额或添加钱到我们的帐户。</p><h2 id="0e41" class="lm jf hi bd jg lr ls lt jk lu lv lw jo iq lx ly js iu lz ma jw iy mb mc ka md bi translated">交易 API</h2><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kn ko di kp bf kq"><div class="er es mp"><img src="../Images/479ebdd0315c1ea699eb7e19444e4a07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9EmiADpzfS6UqH7QB1XDBw.png"/></div></div></figure><p id="c4d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个视图集中，我们首先检查用户帐户余额是否足够，然后启动事务并在数据库中更新它，否则返回错误作为响应。我们将 3 个操作作为单个原子事务命令来执行。它将确保原子性和耐久性。</p><h1 id="d909" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">包扎</h1><p id="6163" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">我希望你是这篇文章给你一个公平的想法，实现一个服务器级的支付系统。显然，这可以进一步即兴创作。如果帖子有问题。请让我知道。如果想了解 WAL 在 python 中的基本实现。你可以在这里浏览代码提及<a class="ae jd" href="http://web.mit.edu/6.033/2018/wwwdocs/assignments/wal-sys.py" rel="noopener ugc nofollow" target="_blank">http://web . MIT . edu/6.033/2018/www docs/assignments/wal-sys . py</a></p><p id="61dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你已经做到了这一步，请考虑留下你的想法或建议，我可以做些什么不同的评论。</p><p id="3f8a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以后还会有这类帖子的连载，敬请关注！</p></div></div>    
</body>
</html>