<html>
<head>
<title>Deploy an application in Azure Container Instances (ACI) through GitHub Actions.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过 GitHub 操作在 Azure 容器实例(ACI)中部署应用程序。</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/deploy-an-application-in-azure-container-instances-aci-through-github-actions-df7144fcd67f?source=collection_archive---------2-----------------------#2021-12-21">https://medium.com/nerd-for-tech/deploy-an-application-in-azure-container-instances-aci-through-github-actions-df7144fcd67f?source=collection_archive---------2-----------------------#2021-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/eec999030c1af7ec17f4ac4bed3bcd08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*SLe2OC6OVlfdHvHb3qQdQg.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">旗帜</figcaption></figure><p id="d6e7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">GitHub Actions 进入市场才一两年，就已经赢得了可观的人气。在社区中容纳了超过 80%的源代码，随着对 CI/CD 需求的增加，GH actions 在竞赛中起步较晚，但发展迅速。许多团队正在将他们的工作流迁移到 GH actions。<br/>谈到迁移，容器已经成为打包&amp;部署云应用的首选方式。Azure 的容器实例(ACI)为他们的 Kubernetes 服务(AKS)带来了一个最小的编排替代方案，这对于小型中型应用程序来说可能是理想的。<br/>今天，我将指导您通过 GitHub Actions 在 ACI 中部署应用程序。</p><p id="7d53" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这篇文章分为三个部分。<br/> <strong class="iw hj"> <em class="js">第一节</em> </strong>讲 dockering an(NodeJs)应用；<br/> <strong class="iw hj"> <em class="js"> Section#2 </em> </strong>将帮助您在 GitHub secrets 中设置 Azure 凭证；<br/> <strong class="iw hj">第 3 节</strong>将帮助您创建一个 GitHub 工作流，将您的 docker 映像部署到 Azure 容器实例。</p><h1 id="245c" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">第一部分:对申请进行备案</strong></h1><p id="f0d2" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在这一节中，我将对一个现有的 NodeJs 应用程序进行 docker 化，创建它的 docker 映像，并验证它在本地可以完美地工作。如果你的申请已经被归档，跳过这一部分。</p><h2 id="d6c6" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated"><strong class="ak"> <em class="lk">步骤#1 </em>:将 Dockerfile 添加到您的应用程序中</strong></h2><p id="7086" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">我有一个正在整理的 NestJs 应用程序。默认情况下，该应用程序在端口 80 启动。添加 Dockerfile 文件以构建映像。</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><h2 id="85ef" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤 2:在本地验证</h2><p id="ff4e" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在本地构建并运行 docker 映像，并验证它工作正常。</p><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="7ff7" class="kw ju hi ls b fi lw lx l ly lz">$ <strong class="ls hj">docker build -t hello-world:1.0.0 .<br/></strong>$ <strong class="ls hj">docker run -p 80:80 hello-world:1.0.0</strong></span></pre><figure class="ll lm ln lo fd ij er es paragraph-image"><div class="er es ma"><img src="../Images/b3cc220f5f2d39910f94cce2c7630302.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*aX3FxHHN6J1kBiuZSClIKg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">在本地工作</figcaption></figure><h1 id="9a86" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">第 2 部分:在 GitHub secrets 中设置 Azure 凭证</strong></h1><p id="9ea6" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">本节将指导您创建一个资源组范围的服务主体，并将其凭证保存到 GitHub secrets。这些秘密将在 GitHub 操作中使用，以在工作流中向 Azure 进行身份验证。如果您已经完成了这些步骤，请随意跳过这一部分。</p><h2 id="57cb" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated"><strong class="ak">步骤#1:在本地安装 Azure CLI</strong></h2><p id="9589" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">我们将使用 Azure CLI 创建所有资源，并且在继续下一步之前，这些资源必须安装在您的本地计算机上。使用此链接下载 Azure CLI。</p><h2 id="c6e2" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated"><strong class="ak">第二步:交互式登录 Azure CLI</strong></h2><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="063f" class="kw ju hi ls b fi lw lx l ly lz">$<strong class="ls hj"> az login --tenant &lt;tenant_id&gt;</strong></span></pre><p id="cd82" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果你只和一个房客交往，那么房客的争论就可以避免。否则，用您的 Azure 租户 ID 替换命令中的<tenant_id>，并在终端中运行。Azure CLI 将使用您的默认浏览器让您登录。</tenant_id></p><h2 id="b7ec" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated"><strong class="ak">步骤#3:创建资源组</strong></h2><p id="e58e" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">资源组是 Azure 中资源的逻辑集合。</p><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="0ac5" class="kw ju hi ls b fi lw lx l ly lz">$<strong class="ls hj"> az group create -l centralindia -n TestGroup</strong></span></pre><p id="c41d" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用您选择的名称和位置创建资源组。我正在“<em class="js">中心区</em>”中创建“<em class="js">测试组</em>”。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/e50cc92b6b9883854292360a41730458.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1O8p6rfAkGoRFUNhYB4eWQ.png"/></div></div></figure><h2 id="5422" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated"><strong class="ak">步骤#4:创建一个服务主体</strong></h2><p id="99b4" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">Azure 服务主体是为应用程序、托管服务和自动化工具访问 Azure 资源而创建的身份。它承担一些角色，在这些角色中它可以采取行动。<br/>要创建服务主体，请确保您有足够的权限(应用程序管理员)或您的租户所有者允许任何用户注册应用程序。</p><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="e396" class="kw ju hi ls b fi lw lx l ly lz">$<strong class="ls hj"> groupId=$(az group show --name TestGroup --query id --output tsv)</strong></span><span id="b103" class="kw ju hi ls b fi md lx l ly lz">$<strong class="ls hj"> MSYS_NO_PATHCONV=1 az ad sp create-for-rbac --name TestApp --role contributor --scope $groupId --sdk-auth</strong></span></pre><p id="f683" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在第一个命令中，使用您在上一步中创建的资源组的名称。<br/>将服务主体的名称放入您选择的第二个命令中。我把它命名为'<em class="js"> TestApp </em>'。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/de54cea6bbf7b89795977823fbf3e253.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B1NjqrNwVG1JVHgJ9sIqow.png"/></div></div></figure><p id="6a65" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">保存 Azure 生成的服务主体的 JSON。</p><h2 id="3ec3" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated"><strong class="ak">步骤#5:创建 GitHub 秘密</strong></h2><p id="f798" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在您的浏览器中，进入您的<strong class="iw hj">GitHub repo</strong>-&gt;-<strong class="iw hj">设置</strong>-&gt;-<strong class="iw hj">秘密</strong>，创建以下秘密。GitHub actions 将使用这些秘密向 Azure 进行身份验证。</p><p id="38e5" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hj">AZURE _ CREDENTIALS</strong>=&gt;<em class="js">&lt;上面生成的 JSON&gt;</em><br/><strong class="iw hj">AZURE _ USERNAME</strong>=&gt;<em class="js">&lt;服务主体的 clientId&gt;</em><br/><strong class="iw hj">AZURE _ PASSWORD</strong>=&gt;<em class="js">&lt;服务主体的 client secret&gt;</em></p><h1 id="5dc4" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">第 3 节:创建 GitHub 工作流以创建容器实例</strong></h1><p id="fbc5" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">本节创建一个 GitHub 工作流，该工作流构建应用程序的映像，推送到 Azure Container Registry，并使用它来部署 Azure Container 实例。</p><h2 id="f154" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤#1:配置<em class="lk"> workflow.yml </em></h2><p id="87cc" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在您的本地，转到您的<em class="js">存储库/。github/workflows </em>并创建<em class="js"> workflow.yml </em>。将其配置为每次将更改推送到主分支时运行一次构建。</p><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="07e8" class="kw ju hi ls b fi lw lx l ly lz">on:<br/> push:<br/>  branches:<br/>   — master<br/>name: Build &amp; Deploy to ACI<br/>jobs:<br/> build-and-deploy:<br/>  runs-on: ubuntu-latest<br/>  steps:</span></pre><p id="24fd" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">现在，在<em class="js"> workflow.yml </em>中，添加以下步骤。</p><h2 id="7a31" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤 2:签出最新的代码</h2><p id="5678" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">添加第一步，从主分支签出最新代码。</p><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="b75c" class="kw ju hi ls b fi lw lx l ly lz">- name: ‘Checkout GitHub Action’<br/>  uses: actions/checkout@master</span></pre><h2 id="be04" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">第 3 步:登录 Azure CLI</h2><p id="2361" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">添加下一步，使用保存的 Azure 凭据登录 Azure。</p><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="8dd5" class="kw ju hi ls b fi lw lx l ly lz">- name: ‘Login to Azure’<br/>  uses: azure/login@v1<br/>  with:<br/>  creds: ${{ secrets.AZURE_CREDENTIALS }}</span></pre><h2 id="7d50" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤 4:创建 Azure 容器注册中心</h2><p id="7d8c" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在下一步中，创建一个容器注册表。只有当注册表不存在时，才会创建注册表。</p><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="29fb" class="kw ju hi ls b fi lw lx l ly lz">- name: ‘Create Azure Registery’<br/>  run: az acr create — resource-group TestGroup — name testgroupregistry — sku Basic</span></pre><h2 id="f793" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated"><strong class="ak">第 5 步:构建和推送</strong></h2><p id="8ec9" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在这一步，构建 docker 映像并推送到 azure 容器注册中心。相应地选择 docker 图像的名称。<br/> <em class="js">注意</em>:之前生成的服务主体的 clientId 和 clientSecret 可以用来登录注册表。</p><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="3bea" class="kw ju hi ls b fi lw lx l ly lz">- name: 'Build &amp; Push'<br/>  uses: azure/docker-login@v1<br/>  with:<br/>   login-server: testgroupregistry.azurecr.io<br/>   username: ${{ secrets.AZURE_USERNAME }}<br/>   password: ${{ secrets.AZURE_PASSWORD }}<br/>   - run: |<br/>      docker build . -t hello-world:${{ github.sha }}<br/>      docker tag hello-world:${{ github.sha }} testgroupregistry.azurecr.io/samples/hello-world:${{ github.sha }}<br/>      docker push testgroupregistry.azurecr.io/samples/hello- world:${{ github.sha }}</span></pre><h2 id="6e55" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤 6:部署到 Azure 容器实例</h2><p id="f5c2" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">使用映像创建 Azure 容器实例。相应地为您的实例选择变量，并正确地指定图像 URL。此步骤仅在 ACI 已创建的情况下部署新映像。</p><pre class="ll lm ln lo fd lr ls lt lu aw lv bi"><span id="3983" class="kw ju hi ls b fi lw lx l ly lz">- name: 'Deploy to Azure Container Instances'<br/>  uses: 'azure/aci-deploy@v1'<br/>  with:<br/>   resource-group: TestGroup<br/>   dns-name-label: helloworlddevtest<br/>   image: testgroupregistry.azurecr.io/samples/hello-world:${{ github.sha }}<br/>   cpu: 1<br/>   memory: 1<br/>   registry-username: ${{ secrets.AZURE_USERNAME }}<br/>   registry-password: ${{ secrets.AZURE_PASSWORD }}<br/>   name: helloworlddev<br/>   location: 'central india'</span></pre><h2 id="b0ff" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">第七步:推动改变</h2><p id="35cf" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">这将自动触发工作流。导航到<em class="js">&lt;your _ repo _ URL&gt;/actions</em>以查看您的工作流作业&amp;构建。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/b39d4d49a557e0b67333717ffdf9c862.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g4QfFBBZFsXeMex_zhEInQ.png"/></div></div></figure><h2 id="c99c" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤 8:验证</h2><p id="5bb7" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">登录 Azure Portal，导航到创建的容器实例，找到 FQDN 并浏览。<br/>或者，工作流中的“<em class="js">部署到 Azure 容器实例</em>”步骤也打印实例的 URL。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/96e8729edabe18f9ed03725f11adcb5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lI5dbJwWqWtS5Npnqa-_Ww.png"/></div></div></figure><blockquote class="mh mi mj"><p id="0520" class="iu iv js iw b ix iy iz ja jb jc jd je mk jg jh ji ml jk jl jm mm jo jp jq jr hb bi translated"><em class="hi">代码库:<br/></em><a class="ae mb" href="https://github.com/sharmavikashkr/azure-test" rel="noopener ugc nofollow" target="_blank">https://github.com/sharmavikashkr/azure-test</a></p></blockquote></div></div>    
</body>
</html>