<html>
<head>
<title>Creating Reproducible Development Environments</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建可重复的开发环境</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/creating-reproducible-development-environments-fac8d6471f35?source=collection_archive---------6-----------------------#2021-04-12">https://medium.com/nerd-for-tech/creating-reproducible-development-environments-fac8d6471f35?source=collection_archive---------6-----------------------#2021-04-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="910a" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用流浪者，VirtualBox和Docker</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/2a21fe02b7227e4e70df5fa4f529dcbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nhSNtw-3-m8C5PYw"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">卡斯帕·卡米尔·鲁宾在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="4a07" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">开发团队面临一个古老的问题:如何确保团队中所有开发人员的开发环境是相同的？一个不太常见但同样重要的问题是，一个新的开发人员加入一个项目需要多长时间？几个小时？几天？如果我告诉你你可以在几分钟内完成这件事，那会怎么样？</p><h2 id="b5b8" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">在我的机器\_(ツ)_/上工作</h2><p id="4298" class="pw-post-body-paragraph jo jp hi jq b jr lf ij jt ju lg im jw jx lh jz ka kb li kd ke kf lj kh ki kj hb bi translated">开发环境通常是脆弱的。如果您只是将所有的软件直接安装在您的计算机上，那么您将面临一个项目的升级导致另一个项目停止工作的风险。更糟糕的是，您有时会从团队中的某个人那里得到可怕的“在我的机器上工作”的借口，但它在您的机器上不工作，或者它在您的机器上工作，但在生产中不工作。如果您可以使用虚拟机在您的笔记本电脑或台式机上毫不费力地自动创建一致的本地开发环境，会怎么样？</p><h2 id="84c7" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">自动化一切:甚至是开发人员</h2><p id="d4e4" class="pw-post-body-paragraph jo jp hi jq b jr lf ij jt ju lg im jw jx lh jz ka kb li kd ke kf lj kh ki kj hb bi translated">小心翼翼、煞费苦心地创建文档，一步一步地指导如何通过剪切-粘贴来重新创建开发环境，这并不是非常敏捷的做法。记住，比起全面的文档，我们更看重工作软件。DevOps的宗旨之一是以代码为的<em class="lk">基础设施的形式实现自动化。这种做法不是手工制作服务器和网络等基础设施，而是使用Terraform等配置工具和/或Ansible、Chef或Puppet等配置管理解决方案，使用代码而不是文档来自动部署和配置软件运行所需的基础设施。但是开发者呢？他们的环境不也应该自动化吗？</em></p><p id="554a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我在纽约大学教授一门关于DevOps和敏捷方法学的研究生课程，这在学生使用Windows PCs、MAC甚至Linux笔记本电脑的课堂环境中有着特殊的含义，这门课程的要求可能与学生正在学习的另一门课程不同。他们应该能够同时参与两门课程的项目。这与开发人员同时参与多个项目没有什么不同。这个问题有各种特定于语言的解决方案，但是以一种语言不可知的方式来解决这个问题不是很好吗？</p><h2 id="d279" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">可口可乐大战:我再也受不了了</h2><p id="f8cc" class="pw-post-body-paragraph jo jp hi jq b jr lf ij jt ju lg im jw jx lh jz ka kb li kd ke kf lj kh ki kj hb bi translated">百事可乐——可口可乐，纸——塑料，Windows——Mac，选择太多，生产力却很低。为了在课堂上解决这个问题，我和我的团队一起工作，我使用了三部曲:vagger、VirtualBox和Docker，让我所有的开发人员和学生在Linux上开发。如果基础设施作为代码有利于生产，那么为什么不使用它来自动配置开发人员笔记本电脑上的环境呢？此外，让开发人员养成在无头服务器环境中工作的习惯也很好，因为当云中的生产工作负载行为不当时，他们在调试时会遇到这种情况。</p><p id="6399" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">T2是一个开发者工具，用于通过命令行界面自动创建轻量级、可复制和可移植的虚拟环境。<strong class="jq hj"> VirtualBox </strong>是一款运行在macOS、Windows和Linux上的免费虚拟机管理程序，可以在你的笔记本电脑或台式电脑上托管虚拟机。过去，我为我的开发团队创建了虚拟机，将它们导出为OVA文件，并且必须上传巨大的数千兆字节的OVA映像，他们必须下载这些映像才能使用。这要花我几个小时。当软件需要更新时，我必须创建一个新的映像并上传，而开发人员需要再次下载它，这需要花费更多的时间。有了vagger，我只需要在我们的每个git存储库中放一个名为<code class="du ll lm ln lo b">Vagrantfile</code>的小文件，其他的事情就交给开发人员了。更新就像更新通过版本控制跟踪的文本文件一样简单。</p><h2 id="5cbd" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">从哪里开始？</h2><p id="4752" class="pw-post-body-paragraph jo jp hi jq b jr lf ij jt ju lg im jw jx lh jz ka kb li kd ke kf lj kh ki kj hb bi translated">首先，我让我的开发团队和学生安装两个软件:vagger和VirtualBox。就是这样！当然，他们需要像Visual Studio Code这样的程序员编辑器，但对于开发环境，他们只需要vagger和VirtualBox。这意味着，新开发人员或学生的入职时间与安装Vagrant和VirtualBox的时间一样长，并且可以使用Mac上的Homebrew或Windows上的Chocolatey这两个简单的命令来自动完成:</p><p id="f145" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在使用自制软件的macOS上:</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="3872" class="kk kl hi lo b fi lt lu l lv lw">$ brew install --cask vagrant<br/>$ brew install --cask virtualbox</span></pre><p id="0fe8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在使用Chocolatey的Windows上:</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="3b32" class="kk kl hi lo b fi lt lu l lv lw">C:\&gt; choco install vagrant<br/>C:\&gt; choco install virtualbox</span></pre><p id="c64f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当然，你需要安装Mac版的Homebrew或者Windows版的Chocolatey，但是如果你没有的话，你会喜欢它们的，因为它们可以自动更新你的软件。依我看，每个开发人员都应该使用这些命令行工具或类似的工具来管理软件安装并提高他们的工作效率。如果你不想使用这些工具，你可以随时从各自的网站下载<a class="ae jn" href="https://www.vagrantup.com/downloads" rel="noopener ugc nofollow" target="_blank">流浪者</a>和<a class="ae jn" href="https://www.virtualbox.org/wiki/Downloads" rel="noopener ugc nofollow" target="_blank"> VirtualBox </a>并手动安装。</p><h2 id="71a1" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">流浪汉是傀儡师</h2><p id="8a85" class="pw-post-body-paragraph jo jp hi jq b jr lf ij jt ju lg im jw jx lh jz ka kb li kd ke kf lj kh ki kj hb bi translated"><strong class="jq hj">流浪者</strong>提供了拉动控制一切的绳子的自动化。它用于快速一致地配置复杂的配置，并具有可重复性。<strong class="jq hj"> VirtualBox </strong>为开发者提供虚拟机(VM ),而<strong class="jq hj"> Docker </strong>处理所有的中间件，无需任何安装。我已经用这个三连胜很长一段时间了，取得了巨大的成功。不管你的笔记本电脑运行的是Windows、macOS还是Linux。每个人都在使用一致的Linux环境，他们不会出错，因为这都是自动化的。没有混乱，没有大惊小怪，没有任何错误的版本。每个人都在完全相同的环境中工作。</p><p id="0b96" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">一旦安装了vagger和VirtualBox，为项目或实验室创建一个完整的开发环境就像以下命令一样简单:</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="8d57" class="kk kl hi lo b fi lt lu l lv lw">$ git clone <a class="ae jn" href="https://github.com/rofrano/lab-vagrant.git" rel="noopener ugc nofollow" target="_blank">https://github.com/rofrano/lab-vagrant.git</a><br/>$ cd lab-vagrant<br/>$ vagrant up<br/>$ vagrant ssh</span></pre><p id="ec5e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">就是这样！一个项目需要安装什么软件并不重要，它对开发人员是隐藏的。不同的项目有不同的、有时是冲突的需求，这没有关系，这都是由虚拟机隔离的。开发人员需要的一切都已经被一致地、可重复地安装和配置了。您可以亲自尝试上面的命令。这是我在几个会议上运行的教程的存储库，比如这次在波士顿举行的Lisa16会议，主题是<a class="ae jn" href="https://www.usenix.org/conference/lisa16/conference-program/presentation/rofrano" rel="noopener ugc nofollow" target="_blank">让开发人员更高效地使用vagger、VirtualBox和Docker </a></p><p id="66da" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">要从头开始您自己的空开发环境，请为您的工作创建一个文件夹并使用:</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="9355" class="kk kl hi lo b fi lt lu l lv lw">$ vagrant init ubuntu/bionic64<br/>$ vagrant up<br/>$ vagrant ssh</span></pre><p id="1eca" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将使用框<code class="du ll lm ln lo b">ubuntu/bionic64</code>初始化一个新的<code class="du ll lm ln lo b">Vagrantfile</code>，并使用Ubuntu 20.10 Bionic64映像调出一个虚拟机。<code class="du ll lm ln lo b">Vagrantfile</code>是一个ruby文件，它包含了如何供应和配置虚拟机的指令。最初，它只包含用于示例代码的框，您可以取消注释或添加附加命令。你可以从流浪者<a class="ae jn" href="https://www.vagrantup.com/docs/vagrantfile" rel="noopener ugc nofollow" target="_blank">文档</a>中了解更多关于这些命令的信息。该框是开始时的虚拟机映像。流浪者有很多图片可以选择，你可以在<a class="ae jn" href="https://app.vagrantup.com/boxes/search" rel="noopener ugc nofollow" target="_blank">流浪者云</a>浏览</p><h2 id="d755" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">一个文件来统治他们所有人</h2><p id="9fbb" class="pw-post-body-paragraph jo jp hi jq b jr lf ij jt ju lg im jw jx lh jz ka kb li kd ke kf lj kh ki kj hb bi translated">真正的魔力来自于编辑<code class="du ll lm ln lo b">Vagrantfile</code>并添加命令来安装、配置和变出你自己的环境。您可以使用<code class="du ll lm ln lo b">shell</code>命令，但vagger也可以使用来自Ansible、Chef和Puppet等流行配置管理系统的文件。想一想。供应生产服务器的相同文件也可以配置开发人员的环境。这就是如何获得12因素应用程序<a class="ae jn" href="https://12factor.net/dev-prod-parity" rel="noopener ugc nofollow" target="_blank">开发/生产奇偶校验</a>。</p><p id="510d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下面是一个简单的<code class="du ll lm ln lo b">Vagrantfile</code>，它将使用<code class="du ll lm ln lo b">git</code>和一个使用Docker的PostgreSQL数据库创建一个Python 3开发环境。</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="ebdb" class="kk kl hi lo b fi lt lu l lv lw">Vagrant.configure(2) do |config|<br/>  config.vm.box = “ubuntu/bionic64”</span><span id="73b5" class="kk kl hi lo b fi lx lu l lv lw">  config.vm.network “forwarded_port”, guest: 8080, host: 8080<br/>  config.vm.network “private_network”, ip: “192.168.33.10”</span><span id="7e2d" class="kk kl hi lo b fi lx lu l lv lw">  config.vm.provider “virtualbox” do |vb|<br/>    vb.memory = “1024”<br/>    vb.cpus = 2<br/>  end</span><span id="0eb6" class="kk kl hi lo b fi lx lu l lv lw">  if File.exists?(File.expand_path("~/.gitconfig"))<br/>    config.vm.provision "file", source: "~/.gitconfig", destination: "~/.gitconfig"<br/>  end</span><span id="fcb7" class="kk kl hi lo b fi lx lu l lv lw">  config.vm.provision “shell”, inline: &lt;&lt;-SHELL<br/>    sudo apt-get update<br/>    sudo apt-get install -y git python3-dev python3-pip<br/>  SHELL</span><span id="ecd0" class="kk kl hi lo b fi lx lu l lv lw">  config.vm.provision :docker do |d|<br/>    d.pull_images “postgres:alpine”<br/>    d.run “postgres:alpine”,<br/>      args: “-d — name postgres -p 5432:5432 -v  postgresql:/var/lib/postgresql/data -e POSTGRES_PASSWORD=postgres”<br/>  end</span><span id="32a9" class="kk kl hi lo b fi lx lu l lv lw">end</span></pre><p id="1b2b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这个<code class="du ll lm ln lo b">Vagrantfile</code>提供了一个Ubuntu 20.10虚拟机，将虚拟机上的端口<code class="du ll lm ln lo b">8080</code>转发到您主机上的<code class="du ll lm ln lo b">8080</code>，这样您就可以使用<code class="du ll lm ln lo b">localhost:8080</code>来访问您的应用程序。替换应用程序监听的任何端口。它还为虚拟机分配了一个IP地址，并分配了1GB的内存和2个CPU。然后，它将您的<code class="du ll lm ln lo b">.gitconfig</code>文件复制到VM中，以便git知道您是谁，然后安装git和一个Python 3开发环境。最后，它使用Docker在Docker容器中提供PostgreSQL数据库。Docker的支持是原生的，这就是为什么我们不需要在我们的笔记本电脑上下载和安装Docker。我们从虚拟机内部使用Docker，因此我们的每个Docker环境也相互隔离。</p><p id="2252" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">如果您需要更多软件，只需将命令添加到您的<code class="du ll lm ln lo b">Vagrantfile</code>中，然后使用:</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="f25c" class="kk kl hi lo b fi lt lu l lv lw">$ vagrant reload --provision</span></pre><p id="e3f1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将再次运行配置块并重新安装软件。应该注意的是，一旦您配置了一个虚拟机，那么在您下次使用<code class="du ll lm ln lo b">vagrant up</code>时，vagger将忽略配置块，因此现有的虚拟机会很快启动，因为所有的东西都已经安装好了。</p><p id="a956" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">每次git repo发生变化时，将<code class="du ll lm ln lo b">Vagrantfile</code>提交给git repo可以确保团队中的每个开发人员每次都能带来相同的一致环境。</p><p id="eab1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当您想要降低环境时，只需使用:</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="5115" class="kk kl hi lo b fi lt lu l lv lw">$ vagrant halt</span></pre><p id="5764" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这将停止虚拟机。然后<code class="du ll lm ln lo b">vagrant up</code>会在你需要的时候再次启动。您也可以使用<code class="du ll lm ln lo b">vagrant suspend</code>和<code class="du ll lm ln lo b">vagrant resume</code>来保存当前运行状态，而不是重新启动。</p><p id="13d1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">当不再需要开发环境时，或者如果一切都出了问题，您可以使用以下命令删除虚拟机:</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="c6cb" class="kk kl hi lo b fi lt lu l lv lw">$ vagrant destroy</span></pre><p id="d9b8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这就是基础设施作为代码的美妙之处。当某件事情出错了，并且“昨天有效，今天无效”时，你不必浪费时间去解决它。只需删除虚拟机，然后配置一个包含以下内容的新虚拟机:</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="5922" class="kk kl hi lo b fi lt lu l lv lw">$ vagrant destroy<br/>$ vagrant up</span></pre><p id="91d2" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这会给你一个新的开发环境，就像你刚开始的那一天一样清新。</p><h2 id="e73c" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">我的文件怎么办？</h2><p id="0fc5" class="pw-post-body-paragraph jo jp hi jq b jr lf ij jt ju lg im jw jx lh jz ka kb li kd ke kf lj kh ki kj hb bi translated">这才是流浪者真正闪光的地方。现在你可能会想，“难道我不需要把我的文件复制到虚拟机上吗？”或者“如果我删除虚拟机，我不会丢失所有工作吗？”这两个问题的答案都是“不”。原因如下:</p><p id="02b9" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在挂载点<code class="du ll lm ln lo b">/vagrant</code>上的虚拟机中，vagger共享你当前的工作目录。您的项目文件永远不会复制到虚拟机中。它们与虚拟机共享，因此您在虚拟机外部或虚拟机内部所做的任何更改都可以在两个地方看到，因为文件实际上只驻留在一个地方，即您的笔记本电脑或台式机上。</p><p id="f02c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">一旦你进入虚拟机，你可以在<code class="du ll lm ln lo b">/vagrant</code>文件夹下找到你的项目文件。在本例中，您可以从虚拟机中看到您在计算机上创建的<code class="du ll lm ln lo b">Vagrantfile</code>。</p><pre class="iy iz ja jb fd lp lo lq lr aw ls bi"><span id="54f9" class="kk kl hi lo b fi lt lu l lv lw">$ vagrant ssh<br/>$ cd /vagrant<br/>$ ls -l<br/>-rw-r—r-- 1 vagrant vagrant  4715 Apr  7 12:52 Vagrantfile</span></pre><p id="9d35" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">因为这些文件是在虚拟机内部共享的，所以当从虚拟机内部执行程序时，您可以在计算机上使用您喜欢的开发编辑器(如Visual Studio代码)来编辑这些文件。这为您提供了两全其美的环境，一个运行代码的可移植开发环境，它类似于生产环境，使用您最喜欢的GUI编辑器既熟悉又方便。</p><h2 id="2045" class="kk kl hi bd km kn ko kp kq kr ks kt ku jx kv kw kx kb ky kz la kf lb lc ld le bi translated">结论</h2><p id="007a" class="pw-post-body-paragraph jo jp hi jq b jr lf ij jt ju lg im jw jx lh jz ka kb li kd ke kf lj kh ki kj hb bi translated">希望我已经为您的开发团队建立了使用基础设施作为代码解决方案的案例，例如vagger，以便不仅自动化，而且拥有可重复的开发环境，消除“在我的机器上工作”综合症。当您考虑到每个开发人员花费在管理他们的开发环境上的时间时，生产率的提高是累积显著的。这也减少了新员工入职时或人们更换团队时的摩擦。</p><p id="0ab8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">除了使用VirtualBox作为提供者，vagger还支持VMware、SoftLayer、Amazon AWS和Digital Ocean。这意味着您的开发人员也可以立即为自己构建基于云的开发环境。如果你使用Visual Studio代码<a class="ae jn" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack" rel="noopener ugc nofollow" target="_blank">远程开发</a>扩展，你实际上可以在云虚拟机内部开发。我将把它留给另一篇博文。</p></div></div>    
</body>
</html>