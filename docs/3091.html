<html>
<head>
<title>AWS Knowledge Series — Working with Neptune Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS 知识系列—使用 Neptune 数据库</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/aws-knowledge-series-working-with-neptune-database-802415735a8?source=collection_archive---------11-----------------------#2021-05-29">https://medium.com/nerd-for-tech/aws-knowledge-series-working-with-neptune-database-802415735a8?source=collection_archive---------11-----------------------#2021-05-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b671ae9ef7d16329946f2771fe7e6348.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZzTSYeY4d8KaiL2LQ8Epyw.jpeg"/></div></div></figure><p id="aa45" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">AWS 提供了许多专门构建的数据库来满足不同的业务需求。Neptune DB 是他们的<a class="ae jo" href="https://en.wikipedia.org/wiki/Graph_database" rel="noopener ugc nofollow" target="_blank">图数据库</a>解决方案。构建图形数据库是为了高效地存储和查询高度关联的数据。数据以顶点和连接这些顶点的边的形式存储。每个顶点代表一个实体，如用户、产品、地点，每个边代表两个顶点之间的关系，例如，人“Sanjay Dandekar”是地点“Bangalore”的居民。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jp"><img src="../Images/c3aa4221e0d15863b6975c39cf1b2650.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ekQtX7RADeDv6J1N9gjzrA.jpeg"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">图形数据库中的数据</figcaption></figure><p id="8141" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本文中，我们将探讨以下主题:</p><ul class=""><li id="53bc" class="jy jz hi is b it iu ix iy jb ka jf kb jj kc jn kd ke kf kg bi translated">如何设置 Neptune DB 的实例</li><li id="f065" class="jy jz hi is b it kh ix ki jb kj jf kk jj kl jn kd ke kf kg bi translated">使用 Jupyter 笔记本填充数据。</li><li id="264a" class="jy jz hi is b it kh ix ki jb kj jf kk jj kl jn kd ke kf kg bi translated">写一个简单的 Lambda 函数查询海王星图 DB。</li></ul><h1 id="96f1" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated"><strong class="ak">创建一个新的 Neptune DB 的无服务器实例</strong></h1><p id="4762" class="pw-post-body-paragraph iq ir hi is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hb bi translated">要创建 Neptune DB 的实例，请登录 AWS 控制台并导航到 Neptune 服务。单击主页上的 Launch Neptune 实例，启动一个向导来创建 Neptune 实例。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es lp"><img src="../Images/cb82e5b405c694aeaef688adc67011b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*EOSJNjlHzmheJScIlB37ig.png"/></div></figure><p id="f96e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择要使用的数据库引擎版本。建议使用最新版本。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/96ff80dce8c395f26c11c209631b21b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tfqPlyBdyoEin6wggUQsag.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">选择数据库引擎版本</figcaption></figure><p id="e30b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">指定数据库的名称。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/73a3c4c9a65c1632e35f12874cc50a75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6xWGyJqJl0XTvs8Ut7ItTA.png"/></div></div><figcaption class="ju jv et er es jw jx bd b be z dx translated">命名您的数据库</figcaption></figure><p id="18ec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">指定是出于生产还是开发目的启动实例。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/2c629b9f61f76d4bb6282a1174f9589a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yyBXDbuipT9ceUh-DJ1wmA.png"/></div></div></figure><p id="effd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">指定服务器的计算规模参数(CPU、RAM、网络)。配置越高，你的成本就越高。具有所选配置的服务器将一直运行，因此运行 Neptune DB 实例有一个固定成本。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/b1c9ba4fcad4904323834ec1e45f1e09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sgtl1t0m_PU27H8jt6TpeQ.png"/></div></div></figure><p id="b34e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果需要高可用性数据库实例，请选择多可用性区域选项。这将允许您创建跨越多个可用性区域的读取器和写入器实例，从而提供更好的故障恢复能力。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/26d9e877d12d9b1063caa81e50afc96c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZED0yAmtFT5twlM1y9ckXQ.png"/></div></div></figure><p id="09eb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为 Neptune DB 服务器的部署选择网络配置。创建一个专用的 VPC 会将 Neptune DB 实例与 Internet 隔离开来。为了从 EC2 或 Lambda 访问这样的 Neptune DB 实例，您必须使用适当的 VPC 子网配置来配置 EC2 / Lambda 实例。Lambda 函数还需要特定的权限来创建网络接口，以便它可以连接到 Neptune DB。Neptune DB 可以连接的缺省 post 号是 8182——如果愿意，您可以指定不同的端口。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lu"><img src="../Images/68b8e4661b061a1b79df352c169881bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I5q87iZFVWLYhFq8Xnrlvg.png"/></div></div></figure><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/f361147fdd80badeeaaf37e3fd330afb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f_G19ixL7DCgK489oWR9eQ.png"/></div></div></figure><p id="ac09" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">还可以创建一个 Jupyter notebook 的实例，该实例连接到 Neptune 实例。这允许您针对 Neptune DB 连接和执行专门的 gremlin 查询。请记住，运行 Jupyter 笔记本实例也有固定成本。强烈建议在开发阶段创建一个笔记本。由于我们将使用 Jupyter notebook 创建数据，请选中“创建笔记本”复选框。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lv"><img src="../Images/f5d0edbe37de5cbf3d154a67d74adcbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9CEsLU5RRY4T74H7th5uew.png"/></div></div></figure><p id="e490" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">canoe 通过提供定制的 DB 参数组来启用/禁用各种配置标志和特性。有关各种标志/功能的更多详细信息可在以下链接中找到。</p><p id="4bec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://docs.amazonaws.cn/en_us/neptune/latest/userguide/parameters.html" rel="noopener ugc nofollow" target="_blank">https://docs . Amazon AWS . cn/en _ us/Neptune/latest/user guide/parameters . html</a></p><p id="ea0e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您想要定制 DB 参数组，那么您首先需要创建新的或修改现有的参数组，并根据您的要求启用/禁用各种标志/特性，然后将该参数组用于这个 Neptune DB 实例。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/a957c8a6509f0a4f29c4d116ce4cfa62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1kFUn0qOqWukAOeVZgtvjg.png"/></div></div></figure><p id="72ee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">参数组中最重要的标志之一是<em class="lw"> neptune_enable_audit_log </em>标志。默认情况下，审计日志是禁用的。这意味着您不会看到 Neptune DB 的任何 cloudwatch 日志。我强烈建议您启用这个标志——至少在开发阶段——因为它支持通过 CloudWatch 快速访问 Neptune DB 日志。一旦数据库集群启动并运行，就不能切换审计日志标记。要关闭或打开审计日志，需要重新启动数据库。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/fce57aaa27545ff69641a3c0a8b2cb58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BTkHghvw7bNAjhTQ_AiPYg.png"/></div></div></figure><p id="a4e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为您的数据库实例指定备份和静态加密配置。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/bfeef2905440e674cd9d7bfe9de720f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z1gIaHpPhT8CuXPLzxvEhg.png"/></div></div></figure><p id="008b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果希望在维护窗口期间自动应用数据库引擎的次要修补程序版本，请选中“启用自动次要版本升级”框。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/b232b4cfe9b1d170ee4fd8ec593ebf3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wpQYdNhqeeNJ2cmKkcmOuw.png"/></div></div></figure><p id="1ae7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以指定一个维护窗口，或者让 AWS 根据实例的使用情况选择相同的窗口。最后，不要忘记选中删除保护框。这将防止任何意外删除您的数据库。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ly"><img src="../Images/b6c7dc4fa1cb083aedeac5fde4c5fef4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nap80yRDiFBCqqid8-WsnA.png"/></div></div></figure><p id="3508" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">单击“Create Database”按钮开始创建 Neptune DB 集群。该集群将有一个具有“写入者和读取者”角色的数据库节点。如果您想要向集群添加额外的“reader”实例，您可以通过选择集群实例并从 Actions 下拉列表中选择“Add reader”操作来实现。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es lz"><img src="../Images/a062c6b05f32fa513d74b918127ab8b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*3ZUby6QlcNi_hBffid7YZA.png"/></div></figure><h1 id="e021" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated"><strong class="ak">使用 Jupyter 笔记本填充海王星图数据库</strong></h1><p id="75a4" class="pw-post-body-paragraph iq ir hi is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hb bi translated">连接到 Neptune DB 集群的 Jupyter notebook 是针对图形数据库执行 gremlin 查询的一种非常方便的机制。要访问 Jupyter 笔记本，请导航到 AWS 控制台中的 Neptune 仪表盘。选择“笔记本”选项，列出当前的笔记本。如果您在创建 Neptune DB 实例时选择了创建一个 Jupyter 笔记本，它将会被列出。如果您尚未创建笔记本，则可以通过单击“创建笔记本”按钮快速创建一个。在向导中选择要访问的 Neptune DB 集群。</p><p id="835e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请记住，运行 Jupyter 笔记本有固定的相关成本，因此在创建笔记本时请记住这一点。</p><p id="f1c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">单击笔记本链接，然后单击“打开笔记本”按钮打开笔记本文件夹结构。单击带有“.”的文件。ipynb”扩展来启动基于 web 的界面。</p><p id="42f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在工作簿单元格中复制以下 gremlin 命令，然后单击“运行”执行它。</p><pre class="jq jr js jt fd ma mb mc md aw me bi"><span id="cbac" class="mf kn hi mb b fi mg mh l mi mj">%%gremlin<br/>g.addV("Person")<br/>.property(id, '10a2a0c0-4642-446e-9862-2e60f1bf20ff')<br/>.property('firstName', 'Sanjay')<br/>.property('lastName', 'Dandekar')<br/>.property('designation', 'Developer')<br/>.addV("Person")<br/>.property(id, 'f7f37040-ae72-4c04-b754-3fac331d26b9')<br/>.property('firstName', 'Sanjay')<br/>.property('lastName', ‘Kulkarni’)<br/>.property(‘favouriteColor’,’Blue’)<br/>.addV("Person")<br/>.property(id, '9b802a76-552d-43c1-856a-a0787932e535')<br/>.property('firstName', 'Ajay')<br/>.property('lastName', ‘Gupta’)<br/>.property('hobby', ‘Ice Skating’)<br/>.next();</span></pre><p id="a9d3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面的命令将创建三个“Person”类型的顶点。每个人顶点都有一个唯一的标识符，即 GUID。每个顶点有两个公共属性，即名和姓。</p><p id="4c54" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下一个单元格中，复制下面的命令并单击“Run”来执行它。</p><pre class="jq jr js jt fd ma mb mc md aw me bi"><span id="4749" class="mf kn hi mb b fi mg mh l mi mj">%%gremlin<br/>g.V().hasLabel(‘Person').valueMap()<br/>.with(WithOptions.tokens).toList();</span></pre><p id="e612" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将列出我们刚刚创建的所有三个顶点。</p><p id="ced6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们创建“地点”顶点。在工作簿单元格中复制以下 gremlin 命令，然后单击“运行”执行它。</p><pre class="jq jr js jt fd ma mb mc md aw me bi"><span id="87ca" class="mf kn hi mb b fi mg mh l mi mj">%%gremlin<br/>g.addV("Place")<br/>.property(id, '898c62f5-e0cb-4aee-b347-69a0f6dcb639')<br/>.property('name', ‘Bangalore')<br/>.property(‘state’, ‘Karnataka’)<br/>.addV("Place")<br/>.property(id, 'cceee371-e26b-4802-9b0d-02003c5a7455')<br/>.property('name', ‘Mumbai')<br/>.property('alternateName', ‘Bollywood')<br/>.next();</span></pre><p id="c3cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上面的命令创建了两个类型为“Place”的顶点。每个地点顶点都有一个唯一的标识符，即 GUID。每个顶点都有一个属性—名称。</p><p id="e5f8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">像前面一样，执行下面的命令来检查是否已经创建了两个地点顶点。</p><pre class="jq jr js jt fd ma mb mc md aw me bi"><span id="db1e" class="mf kn hi mb b fi mg mh l mi mj">%%gremlin<br/>g.V().hasLabel('Place').valueMap()<br/>.with(WithOptions.tokens).toList();</span></pre><p id="93be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以现在我们有两种类型的顶点——人和地点。如您所见，顶点没有“模式”。在我们的示例中，Person 和 Place 类型的所有顶点都有一些公共属性(firatName、lastName for Person 和 name for Place ),还有一些是顶点特有的。每个顶点都有两个强制属性——label(在我们的例子中是 Person 和 Place)和 ID——每个顶点的唯一标识符(为此我们使用了 GUID)。</p><p id="6e59" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们用“边”来连接顶点。让我们在人和地点顶点之间创建一个标签为“resident_of”的边。我们需要以下连接:</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/91ae7166d0335cd36732aa4657e95774.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zeJeE9ld5IdbqwqMbavL5Q.png"/></div></div></figure><p id="9e2e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在工作簿单元格中复制以下 gremlin 命令，然后单击“运行”执行它。</p><pre class="jq jr js jt fd ma mb mc md aw me bi"><span id="0ad2" class="mf kn hi mb b fi mg mh l mi mj">%%gremlin<br/>g.V(‘f7f37040-ae72-4c04-b754-3fac331d26b9')<br/>.hasLabel('Person').as('person1')<br/>.V(‘cceee371-e26b-4802-9b0d-02003c5a7455')<br/>.hasLabel('Place').as('place1')<br/>.addE("resident_of")<br/>.property(id, 'f7f37040-ae72-4c04-b754-3fac331d26b9_cceee371-e26b-4802-9b0d-02003c5a7455')<br/>.from('person1')<br/>.to('place1')<br/>.V(‘10a2a0c0-4642-446e-9862-2e60f1bf20ff')<br/>.hasLabel('Person').as('person2')<br/>.V(‘898c62f5-e0cb-4aee-b347-69a0f6dcb639')<br/>.hasLabel('Place').as('place2')<br/>.addE("resident_of")<br/>.property(id, '10a2a0c0-4642-446e-9862-2e60f1bf20ff_898c62f5-e0cb-4aee-b347-69a0f6dcb639')<br/>.from('person2')<br/>.to('place2')<br/>.V('9b802a76-552d-43c1-856a-a0787932e535').hasLabel('Person').as('person3')<br/>.V(‘cceee371-e26b-4802-9b0d-02003c5a7455')<br/>.hasLabel('Place').as('place3')<br/>.addE("resident_of")<br/>.property(id, '9b802a76-552d-43c1-856a-a0787932e535_cceee371-e26b-4802-9b0d-02003c5a7455')<br/>.from('person3')<br/>.to('place3')<br/>.next();</span></pre><p id="ed95" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用顶点的标识符和标签，我们正确地识别顶点，然后添加连接两个顶点的边。执行以下命令，查看是否创建了边。</p><pre class="jq jr js jt fd ma mb mc md aw me bi"><span id="c0e1" class="mf kn hi mb b fi mg mh l mi mj">%%gremlin<br/>g.E().hasLabel('resident_of').valueMap()<br/>.with(WithOptions.tokens).toList();</span></pre><p id="2282" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是一个如何使用 Jupyter notebook 在 Neptune DB 中快速创建顶点和边的快速示例。也可以通过将数据格式化为 CSV 格式来批量插入数据，上传到 S3，然后要求 Neptune DB 启动导入作业以到达 CSV，从而在数据库中创建顶点和边。</p><h1 id="5759" class="km kn hi bd ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj bi translated"><strong class="ak">从 Lambda 函数中查询 Neptune】</strong></h1><p id="bdd7" class="pw-post-body-paragraph iq ir hi is b it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj lo jl jm jn hb bi translated">我们现在将看到如何从 Lambda 函数中查询我们上面创建的数据。有两种方法可以访问数据——1)针对 Neptune DB 的 gremlin 端点执行 HTTPS POST 请求，其中有效载荷是 gremlin 命令；2)使用与任何 Lambda 运行时(例如 nodejs 或 Python)兼容的 gremlin 库，并通过 web 套接字连接执行 gremlin 查询。我将在本文中演示第二种方法，作为非常简单的第一种方法。</p><p id="dfb7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">创建 Gremlin 节点λ层</strong></p><p id="7779" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将使用 NodeJS 环境作为 Lambda 的运行时，所以我们要做的第一件事是下载 Gremlin NodeJS 包。打开一个命令 shell，创建一个名为“neptune_gremlin_layer”的文件夹。在其下创建名为“nodejs”的文件夹，并执行以下命令来下载 gremlin nodejs 包。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ml"><img src="../Images/79cd58a65363e7d3a6ff8bc55fd9e0ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BNMiRcggguhGH95za-PK0Q.png"/></div></div></figure><p id="6ec9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用以下命令压缩 nodejs 文件夹:</p><pre class="jq jr js jt fd ma mb mc md aw me bi"><span id="e967" class="mf kn hi mb b fi mg mh l mi mj">zip -r9 ./gremlin_layer.zip ./nodejs</span></pre><p id="9c8c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">导航到 Lambda AWS 控制台，并从左侧菜单列表中选择层。单击创建图层按钮并指定图层属性。上传我们上面创建的 zip 文件。单击创建按钮创建图层。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/03cc220308cf7813a3ab7db79a762cce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MCvYivLSbVn-oJSn2pcQfQ.png"/></div></div></figure><p id="ee67" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">创建λ函数</strong></p><p id="d719" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">导航回 Lambda 仪表板，单击“创建函数”按钮创建一个新函数。输入如下所示的数据:</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mn"><img src="../Images/d99fd1e82c23ffa395c74ee0edbc135d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*br_InR06ULM1vIL0KLkdOQ.png"/></div></div></figure><p id="5e62" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您在专用 VPC 中创建了 Neptune 实例，那么您必须选择适当的 VPC、子网和安全组，以便 Lambda 函数能够访问 Neptune DB 集群。</p><p id="3902" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">单击“创建函数”按钮创建函数。我们现在必须将上面创建的 gremlin 层与这个 Lambda 函数关联起来。导航到 Lambda 函数的图层配置面板，点击“添加图层”按钮。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/fde5b93da0cce83e521c16bb3b88382a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rsq8gx20yjbHW2oIThiHeQ.png"/></div></div></figure><p id="93b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在出现的表单中，选择自定义层，然后选择我们刚刚创建的 gremlin 层。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mm"><img src="../Images/033bd7a424a53d40955b16e7cd18c982.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9gkO1ZqZ0bkYVky7ov0X3g.png"/></div></div></figure><p id="f23e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">单击添加将图层添加到函数中。编辑函数代码，并将以下代码粘贴到函数定义中。</p><pre class="jq jr js jt fd ma mb mc md aw me bi"><span id="0796" class="mf kn hi mb b fi mg mh l mi mj">const gremlin = require('gremlin');</span><span id="a268" class="mf kn hi mb b fi mp mh l mi mj">// functions / definitions from gremlin js library<br/>const DriverRemoteConnection = gremlin.driver.DriverRemoteConnection;<br/>const Graph = gremlin.structure.Graph;<br/>const withOptions = gremlin.process.withOptions</span><span id="e811" class="mf kn hi mb b fi mp mh l mi mj">function getNeptuneWSURL(neptuneHost, neptunePort) {<br/>  var url = "wss://" + neptuneHost + ":" + neptunePort + "/gremlin";<br/>  return url;<br/>}</span><span id="aca0" class="mf kn hi mb b fi mp mh l mi mj">exports.handler = async (event) =&gt; {</span><span id="5033" class="mf kn hi mb b fi mp mh l mi mj">  // Create connection to Neptune<br/>  var dc = new DriverRemoteConnection(getNeptuneWSURL('&lt;&lt;Replace with your Neptune Cluster Name&gt;&gt;','8182'), {});</span><span id="f8d1" class="mf kn hi mb b fi mp mh l mi mj">  var graph = new Graph();</span><span id="13ae" class="mf kn hi mb b fi mp mh l mi mj">  var g = graph.traversal().withRemote(dc);</span><span id="f13c" class="mf kn hi mb b fi mp mh l mi mj">  // How many person vertexes are there in the Neptune graphdb?<br/>  var graphResult = await g.V().hasLabel('Person').count().next();<br/>  console.log("Number of person vertexes: ", graphResult);</span><span id="a44e" class="mf kn hi mb b fi mp mh l mi mj">  // How many place vertexes are there in the Neptune graphdb?<br/>  graphResult = await g.V().hasLabel('Place').count().next();<br/>  console.log("Number of place vertexes: ", graphResult);</span><span id="36ff" class="mf kn hi mb b fi mp mh l mi mj">  // How many person vertex having "Sanjay" as first name?<br/>  graphResult = await g.V().hasLabel('Person').has('firstName', 'Sanjay').count().next();<br/>  console.log("Number of person fn = Sanjay: ", graphResult);</span><span id="4346" class="mf kn hi mb b fi mp mh l mi mj">  // Details of person vertex having "Sanjay" as first name?<br/>  graphResult = await g.V().hasLabel('Person').has('firstName', 'Sanjay').valueMap()<br/>  .with_(withOptions.tokens).toList();<br/>  console.log("Details of person fn = Sanjay: ", graphResult);</span><span id="dae9" class="mf kn hi mb b fi mp mh l mi mj">  // Places of person vertex having "Sanjay" as first name?<br/>  graphResult = await g.V().hasLabel('Person').has('firstName', 'Sanjay').outE('resident_of').inV().valueMap().with_(withOptions.tokens).toList();<br/>  console.log("Places of person fn = Sanjay: ", graphResult);</span><span id="5852" class="mf kn hi mb b fi mp mh l mi mj">  // Number of people who are resident of Bangalore<br/>  graphResult = await g.V().hasLabel('Place').has('name', 'Mumbai').inE('resident_of').count().next();<br/>  console.log("Number of residents of Mumbai: ", graphResult);</span><span id="ea73" class="mf kn hi mb b fi mp mh l mi mj">  // Details of persons staying in Mumbai?<br/>  graphResult = await g.V().hasLabel('Place').has('name', 'Mumbai').inE('resident_of').outV().valueMap().with_(withOptions.tokens).toList();<br/>  console.log("Details of residents of Mumbai: ", graphResult);</span><span id="7a9d" class="mf kn hi mb b fi mp mh l mi mj">  // Close the websocket connection<br/>  await dc.close();</span><span id="045c" class="mf kn hi mb b fi mp mh l mi mj">  // Response from lambda<br/>  const response = {<br/>    statusCode: 200,<br/>    body: JSON.stringify('Hello from Lambda!'),<br/>  };</span><span id="cd66" class="mf kn hi mb b fi mp mh l mi mj"> return response;</span><span id="59bc" class="mf kn hi mb b fi mp mh l mi mj">};</span></pre><p id="b453" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是 Lambda 执行的日志。</p><pre class="jq jr js jt fd ma mb mc md aw me bi"><span id="5510" class="mf kn hi mb b fi mg mh l mi mj">Number of person vertexes:  { value: 3, done: false }</span><span id="1b40" class="mf kn hi mb b fi mp mh l mi mj">Number of place vertexes:  { value: 2, done: false }</span><span id="5637" class="mf kn hi mb b fi mp mh l mi mj">Number of person fn = Sanjay:  { value: 2, done: false }</span><span id="504a" class="mf kn hi mb b fi mp mh l mi mj">Details of person fn = Sanjay:  [</span><span id="d975" class="mf kn hi mb b fi mp mh l mi mj">Map {</span><span id="3bbd" class="mf kn hi mb b fi mp mh l mi mj">'firstName' =&gt; [ 'Sanjay' ],<br/>'lastName' =&gt; [ 'Kulkarni' ],<br/>'favouriteColor' =&gt; [ 'Blue' ],<br/>EnumValue { typeName: 'T', elementName: 'label' } =&gt; 'Person',<br/>EnumValue { typeName: 'T', elementName: 'id' } =&gt; 'f7f37040-ae72-4c04-b754-3fac331d26b9'</span><span id="b308" class="mf kn hi mb b fi mp mh l mi mj">},</span><span id="51ed" class="mf kn hi mb b fi mp mh l mi mj">Map {</span><span id="0f24" class="mf kn hi mb b fi mp mh l mi mj">'firstName' =&gt; [ 'Sanjay' ],<br/>'lastName' =&gt; [ 'Dandekar' ],<br/>'designation' =&gt; [ 'Developer' ]<br/>EnumValue { typeName: 'T', elementName: 'label' } =&gt; 'Person',<br/>EnumValue { typeName: 'T', elementName: 'id' } =&gt; '10a2a0c0-4642-446e-9862-2e60f1bf20ff'</span><span id="7e43" class="mf kn hi mb b fi mp mh l mi mj">}</span><span id="3a4b" class="mf kn hi mb b fi mp mh l mi mj">]</span><span id="e23c" class="mf kn hi mb b fi mp mh l mi mj">Places of person fn = Sanjay:  [</span><span id="9335" class="mf kn hi mb b fi mp mh l mi mj">Map {</span><span id="539e" class="mf kn hi mb b fi mp mh l mi mj">'name' =&gt; [ 'Mumbai' ],<br/>'alternateName' =&gt; [ 'Bollywood' ],<br/>EnumValue { typeName: 'T', elementName: 'label' } =&gt; 'Place',<br/>EnumValue { typeName: 'T', elementName: 'id' } =&gt; 'cceee371-e26b-4802-9b0d-02003c5a7455'</span><span id="18c9" class="mf kn hi mb b fi mp mh l mi mj">},</span><span id="3b95" class="mf kn hi mb b fi mp mh l mi mj">Map {</span><span id="157d" class="mf kn hi mb b fi mp mh l mi mj">'name' =&gt; [ 'Bangalore' ],<br/>'state' =&gt; [ 'Karnataka' ],<br/>EnumValue { typeName: 'T', elementName: 'label' } =&gt; 'Place',<br/>EnumValue { typeName: 'T', elementName: 'id' } =&gt; '898c62f5-e0cb-4aee-b347-69a0f6dcb639'</span><span id="15b5" class="mf kn hi mb b fi mp mh l mi mj">}</span><span id="bccf" class="mf kn hi mb b fi mp mh l mi mj">]</span><span id="d2ba" class="mf kn hi mb b fi mp mh l mi mj">Number of residents of Mumbai:  { value: 2, done: false }</span><span id="b89b" class="mf kn hi mb b fi mp mh l mi mj">Details of residents of Mumbai:  [</span><span id="e60f" class="mf kn hi mb b fi mp mh l mi mj">Map {</span><span id="318b" class="mf kn hi mb b fi mp mh l mi mj">'firstName' =&gt; [ 'Sanjay' ],<br/>'lastName' =&gt; [ 'Kulkarni' ],<br/>'favouriteColor' =&gt; [ 'Blue' ],<br/>EnumValue { typeName: 'T', elementName: 'label' } =&gt; 'Person',<br/>EnumValue { typeName: 'T', elementName: 'id' } =&gt; 'f7f37040-ae72-4c04-b754-3fac331d26b9'</span><span id="9823" class="mf kn hi mb b fi mp mh l mi mj">},</span><span id="cb2c" class="mf kn hi mb b fi mp mh l mi mj">Map {</span><span id="32ab" class="mf kn hi mb b fi mp mh l mi mj">'firstName' =&gt; [ 'Ajay' ],<br/>'lastName' =&gt; [ 'Gupta' ],<br/>'hobby' =&gt; [ 'Ice Skating' ]<br/>EnumValue { typeName: 'T', elementName: 'label' } =&gt; 'Person',<br/>EnumValue { typeName: 'T', elementName: 'id' } =&gt; '9b802a76-552d-43c1-856a-a0787932e535'</span><span id="777b" class="mf kn hi mb b fi mp mh l mi mj">}</span><span id="f328" class="mf kn hi mb b fi mp mh l mi mj">]</span></pre><p id="b3bd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如您所见，gremlin node js 库提供了直接在 Neptune DB 上执行原生 gremlin 查询的能力。</p><p id="1f24" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关于 Lambda 函数代码需要注意的最重要的一点是，一旦我们完成了对 Neptune DB 的查询，就调用关闭 websocket 连接。如果你不这样做，网络插座将保持开放几个小时。Neptune DB 的每个节点都有数量有限的 websocket 连接，因此在工作完成后立即关闭 web socket 非常重要。打开和关闭 websocket 连接的开销是你必须忍受的，直到 AWS 为 Lambda 环境提供了一个很好的“连接池”解决方案。如果不能正确地做到这一点，可能会在生产环境中产生灾难性的后果！</p></div></div>    
</body>
</html>