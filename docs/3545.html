<html>
<head>
<title>Play Bach: Let a neural network play for you. Part 3.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">演奏巴赫:让一个神经网络为你演奏。第三部分。</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/play-bach-let-a-neural-network-play-for-you-part-3-9f59c9a5d57f?source=collection_archive---------13-----------------------#2021-06-13">https://medium.com/nerd-for-tech/play-bach-let-a-neural-network-play-for-you-part-3-9f59c9a5d57f?source=collection_archive---------13-----------------------#2021-06-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cb6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不知道如何演奏音乐。但是我仍然可以玩音乐。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jd"><img src="../Images/37accd177f5c3eab29767ffb933c3705.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*l5X6HaD5-g8rc5htsapMkg.jpeg"/></div></figure><p id="a3be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jl">这是一系列文章的一部分，这些文章探讨了该项目的许多方面，包括静态 MIDI 文件生成、实时流、Tensorflow/Keras 顺序和功能模型、LSTM、过拟合和欠拟合、注意、嵌入层、多头模型、概率分布、向 TensorflowLite 的转换、TPU/硬件加速器的使用、在 Raspberry PI 上运行推理等。</em></p><p id="d8be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">参见<a class="ae jm" rel="noopener" href="/nerd-for-tech/play-bach-let-a-neural-network-play-for-you-part-1-596e54b1c912">第一部分</a>。<a class="ae jm" rel="noopener" href="/nerd-for-tech/play-bach-let-a-neural-network-play-for-you-part-2-3ee01b729057">第二部</a>。<a class="ae jm" href="https://pboudalier.medium.com/play-bach-let-a-neural-network-play-for-you-part-4-aec253deb385" rel="noopener">第四部分</a>。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="jn jo l"/></div></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="5320" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">培训过程中可能会出现什么问题？</h1><p id="e41f" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">在第<a class="ae jm" rel="noopener" href="/nerd-for-tech/play-bach-let-a-neural-network-play-for-you-part-2-3ee01b729057">部分</a> 2 中，我们研究了验证损失如何随着网络的训练而演变。</p><p id="9ef7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是你的第一次神经网络训练很可能看起来像下面这样。为什么？</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es kz"><img src="../Images/35bbb2d4c39122bc759772688ec37d6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:914/format:webp/1*KmBJu2-2CgTHug0zPhmLnw.jpeg"/></div><figcaption class="la lb et er es lc ld bd b be z dx translated">过度拟合</figcaption></figure><p id="3810" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在网络容量和训练样本的数量之间需要找到一个平衡点。不平衡会产生如上所示的曲线类型。</p><p id="fdfb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">容量</strong>定义为模型中变量的数量(在我们的例子中为 120 万个),由我们选择的超参数产生。变量越多，网络的“自由度”就越大。如果与训练样本的数量相比，容量太高，网络可能会“记住”训练集，并擅长根据训练集进行预测，但当它被给予训练集之外的输入时就会失败。无法一概而论。它没有学习，而是简单地记住了训练集。</p><p id="f3c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这被称为<strong class="ih hj">过拟合</strong>并在上图中描述为<strong class="ih hj"> </strong>。验证集上的错误的演变不跟随训练集上的错误的进展。</p><p id="b415" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在训练模型时，防止过度拟合是一个典型的问题。这可以通过以下方式实现:</p><ul class=""><li id="75ee" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated">通过调整超参数，确保网络与可用的训练数据相比没有太大的容量。</li><li id="ef2f" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">使用一些技术，比如 Dropout(记住，它是我们模型中的一个层— <a class="ae jm" rel="noopener" href="/nerd-for-tech/play-bach-let-a-neural-network-play-for-you-part-2-3ee01b729057">参见本系列的第 2 部分</a>)。Dropout 随机“中和”模型的一些变量，以确保网络不会变得“懒惰”，并最终“记住”训练集<em class="jl">(这里有很多拟人化的说法)。</em></li><li id="6dfe" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated">获取更多训练数据。</li></ul><p id="8f9c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">另一方面，如果容量太低，网络就没有办法学到任何有用的东西。这被称为<strong class="ih hj">欠拟合</strong>。在这种情况下，准确性可能不会比随机猜测好多少。</p><p id="6fb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">试错法、经验、直觉和一个好的 GPU 是你在欠适应和过适应之间导航的朋友</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="1b4a" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">运行实际训练</h1><p id="795d" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">这个应用程序是用 python 写的，在 github 上有<a class="ae jm" href="https://github.com/pabou38/play_bach" rel="noopener ugc nofollow" target="_blank">。它使用两个密钥库:</a></p><ul class=""><li id="b2de" class="le lf hi ih b ii ij im in iq lg iu lh iy li jc lj lk ll lm bi translated"><a class="ae jm" href="https://www.tensorflow.org/" rel="noopener ugc nofollow" target="_blank">深度学习的 Tensorflow </a></li><li id="0c4d" class="le lf hi ih b ii ln im lo iq lp iu lq iy lr jc lj lk ll lm bi translated"><a class="ae jm" href="https://web.mit.edu/music21/" rel="noopener ugc nofollow" target="_blank"> Music21 </a>用于音乐分析</li></ul><p id="853e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是应用程序的关键文件和目录:</p><pre class="je jf jg jh fd ls lt lu lv aw lw bi"><span id="2830" class="lx jx hi lt b fi ly lz l ma mb"><strong class="lt hj"><em class="jl">In DEEP/music21/:</em></strong></span><span id="6562" class="lx jx hi lt b fi mc lz l ma mb"><strong class="lt hj">models</strong><em class="jl">: directory for trained model and generated MIDI files<br/></em><strong class="lt hj">training</strong><em class="jl">: directory containing midi files<br/></em><strong class="lt hj"><br/>play_bach.py</strong><em class="jl"> : main python script. Performs both training and inference<br/></em><strong class="lt hj">my_model.py</strong><em class="jl"> : TensorFlow model definition<br/></em><strong class="lt hj">my_midi.py</strong><em class="jl"> : MIDI file creation<br/></em><strong class="lt hj">config_bach.py</strong><em class="jl"> : configuration parameters<br/></em><strong class="lt hj">log_play_bach.log</strong><em class="jl"> : created at each run</em></span></pre><p id="9b99" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在运行培训之前，让我们回顾一下 config_bach.py 中的一些配置参数:</p><pre class="je jf jg jh fd ls lt lu lv aw lw bi"><span id="6a4d" class="lx jx hi lt b fi ly lz l ma mb"><em class="jl">seqlen=40 # length of input sequence<br/>epochs=70 # training will stop earlier if accuracy not improving<br/>batch=64 # power of 2<br/>concatenate = False<br/>normal = False<br/>model_type=1</em></span><span id="d78f" class="lx jx hi lt b fi mc lz l ma mb"><em class="jl">app='cello'</em></span></pre><p id="38d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jl"> model_type =1 </em>就是使用我们在第 2 部分看到的<a class="ae jm" rel="noopener" href="/nerd-for-tech/play-bach-let-a-neural-network-play-for-you-part-2-3ee01b729057">的模型架构。在以后的文章中，我们将着眼于更复杂的架构。</a></p><p id="a2fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jl"> normal = False </em>表示和弦用八度音程信息编码。当等于<em class="jl"> True </em>时，一个和弦中的所有音符都被假定为同一个八度音阶(#4)。正常模式以丢失八度音程信息为代价，减小了输出层的大小。当模型变得非常大时，可以使用这个。比如:当正常=假和弦 A4。G5 被认为不同于和弦 A5。G5 和当 normal=True 时，它们是相同的，即 A.G</p><p id="af62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jl"> concatenate = False </em>表示我们只预测音符的音高。如果为 True，还会预测音符的持续时间。我们将在以后的文章中讨论持续时间的预测。</p><p id="9752" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jl"> app </em>是你为你的语料库选择的一个名字。例如如果 app='cello '，cello midi 文件应该存在于<strong class="ih hj"><em class="jl">training</em></strong><em class="jl"/>目录中，由此产生的训练模型将存储在<strong class="ih hj"> <em class="jl"> models </em> </strong>目录中，命名为<strong class="ih hj"><em class="jl">cello 1 _ NC _ mo</em></strong>(cello，模型类型 1，无串接，多个八度)。同样，生成的 midi 文件将被命名为<strong class="ih hj"><em class="jl">cello 1 _ NC _ mo . mid .</em></strong></p><p id="2d04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">序列长度、批量大小、时期数是我们已经在第 2 部分中描述过的超参数。</p><p id="b1a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要开始训练，从 music21 目录执行“python -m play_bach.py -l 0 -f -pm”。</p><h1 id="6be9" class="jw jx hi bd jy jz md kb kc kd me kf kg kh mf kj kk kl mg kn ko kp mh kr ks kt bi translated"><em class="mi">python-m play _ Bach . py-l 0-f-pm</em></h1><pre class="je jf jg jh fd ls lt lu lv aw lw bi"><span id="e359" class="lx jx hi lt b fi ly lz l ma mb"><strong class="lt hj">l 0</strong> is to create a new model (we could also load an already partially trained model and resume training).</span><span id="4a65" class="lx jx hi lt b fi mc lz l ma mb"><strong class="lt hj">f </strong>is to <strong class="lt hj">Fit</strong> the model, i.e. to train it.</span><span id="f142" class="lx jx hi lt b fi mc lz l ma mb"><strong class="lt hj">pm</strong> is to run predictions on the trained model and create a MIDI file.</span></pre><p id="7c19" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您将看到一些张量流轨迹，显示模型精度如何逐代发展:</p><pre class="je jf jg jh fd ls lt lu lv aw lw bi"><span id="4035" class="lx jx hi lt b fi ly lz l ma mb"><em class="jl">Epoch 00030: val_accuracy </em><strong class="lt hj"><em class="jl">improved</em></strong><em class="jl"> </em><strong class="lt hj"><em class="jl">from 0.61535 to 0.61721</em></strong><em class="jl">, saving model to /content/drive/My Drive/DEEP/music21/checkpoint/cp-030.ckpt<br/>Epoch 00031: val_accuracy </em><strong class="lt hj"><em class="jl">improved</em></strong><em class="jl"> </em><strong class="lt hj"><em class="jl">from 0.61721 to 0.64238</em></strong><em class="jl">, saving model to /content/drive/My Drive/DEEP/music21/checkpoint/cp-031.ckpt<br/>Epoch 00032: val_accuracy </em><strong class="lt hj"><em class="jl">did not improve from 0.64238</em></strong><em class="jl"><br/>Epoch 00033: val_accuracy </em><strong class="lt hj"><em class="jl">improved</em></strong><em class="jl"> </em><strong class="lt hj"><em class="jl">from 0.64238 to 0.65458</em></strong><em class="jl">, saving model to /content/drive/My Drive/DEEP/music21/checkpoint/cp-033.ckpt</em></span></pre><p id="85df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">过了一段时间，准确度不再提高。训练会在这个高原停止。瞧吧..</p><pre class="je jf jg jh fd ls lt lu lv aw lw bi"><span id="5abb" class="lx jx hi lt b fi ly lz l ma mb"><em class="jl">Epoch 00057: val_accuracy </em><strong class="lt hj"><em class="jl">improved from 0.73717 to 0.74128</em></strong><em class="jl">, saving model to /content/drive/My Drive/DEEP/music21/checkpoint/cp-057.ckpt<br/>Epoch 00058: val_accuracy </em><strong class="lt hj"><em class="jl">did not improve from 0.74128</em></strong><em class="jl">.<br/>Epoch 00059: val_accuracy </em><strong class="lt hj"><em class="jl">did not improve from 0.74128</em></strong><em class="jl"><br/>Epoch 00059: early stopping fit ended.<br/>model fitted in 709 sec for 70 configured epochs , and 59 actual epochs</em></span></pre><p id="b58e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如前所述，我们监控验证集的准确性，而不是训练集。在上面的例子中，我们指定了最大 70 个时期，但是验证精度在 59 个时期后停止提高，我们得到了 74%的精度。</p><h1 id="ecf9" class="jw jx hi bd jy jz md kb kc kd me kf kg kh mf kj kk kl mg kn ko kp mh kr ks kt bi translated">播放生成的 MIDI 文件</h1><p id="3364" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">一个快速的互联网搜索将返回多个应用程序来播放 MIDI 文件(如 VLC)。你需要一个<a class="ae jm" href="https://member.keymusician.com/Member/FluidR3_GM/index.html" rel="noopener ugc nofollow" target="_blank">声音字体</a>。</p><p id="954d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">MIDI 文件只包含音符的代码。它不会告诉你音符是来自钢琴还是小叮当。<strong class="ih hj"> SoundFont </strong>用于渲染许多乐器的 MIDI 代码:我的可以做掌声、直升机、枪声，但更有趣的是，许多乐器我都没听说过。</p><p id="eedb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">MIDI 文件生成的乐器选择是一个配置参数，位于 config_bach.py 中</p><pre class="je jf jg jh fd ls lt lu lv aw lw bi"><span id="1f06" class="lx jx hi lt b fi ly lz l ma mb">my_instrument = instrument.Clavichord()</span></pre><p id="1850" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，为了好玩，你可以尝试不同于原始音乐中使用的乐器。</p><p id="b07c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在下一篇文章中，我们将不得不决定从这里向何处去:</p><p id="5e5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以改进用户界面，或者探索不同的模型架构，或者查看当前的性能和改进它的方法，或者在各种平台上运行应用程序，或者使用专用的机器学习硬件，或者将应用程序放在 web 上，或者构建 docker 容器…</p><p id="098a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望我们最终能做到这一切</p><p id="72e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与此同时，敬请关注！！！</p><p id="aef3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jl">——————如果你对细节不感兴趣，就不要越过这条线——————</em></p><p id="39c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jm" rel="noopener" href="/nerd-for-tech/play-bach-let-a-neural-network-play-for-you-part-2-3ee01b729057">在第 2 部分</a>中，我提到输出层会预测一个 1 到 129 之间的数字，因为我们的大提琴语料库中有 129 个唯一的音符/和弦。</p><p id="e61f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这有点过于简单化了。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es mj"><img src="../Images/776fa492341e7316e89bc1718609489c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*6rRSO3NtWucgB_YlZJXfoQ.png"/></div></figure><p id="35dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更确切地说，输出层是 max 的 S <em class="jl">，它是一个由 129 个数字<strong class="ih hj">组成的数组，其和构造为 1。</strong>它<strong class="ih hj"> </strong>以概率(或置信水平)的形式表达模型的预测。</em></p><p id="1ccb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">例如，在下面的例子中，所有这些数字都很小，只有一个例外(其值为 0，98)。这就是模型所说的“我非常确定下面的音符是音符编号 102 (102 是 softmax 数组中值 0，98 的索引)</p><pre class="je jf jg jh fd ls lt lu lv aw lw bi"><span id="4dc1" class="lx jx hi lt b fi ly lz l ma mb"><em class="jl">softmax_array([6.08105147e-05, 3.24967942e-07, 2.74516833e-06, 2.47346634e-05, 7.15374142e-08, 1.58419255e-06, 1.47027833e-06, 2.51121264e-07, 3.34257456e-05, 1.54934426e-07, 7.13374334e-07,<br/>....<br/>7.70791473e-07, 2.17805621e-07, 3.28565389e-03, 1.46220991e-08, 2.45054448e-08, 1.74178112e-08, 2.71401427e-06, </em><strong class="lt hj"><em class="jl">9.83197570e-01,</em></strong><em class="jl"> 4.78140656e-08, 1.69292580e-08, 2.30138676e-06, 2.89644220e-07,<br/>....<br/>2.28157023e-06, 6.47835404e-05], dtype=float32)</em></span><span id="91aa" class="lx jx hi lt b fi mc lz l ma mb"><em class="jl">softmax_array[102] = 0.98319757</em></span></pre><p id="3660" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有唯一音符/和弦列表中的索引 102 是‘G # 2’。这就是模型预测！！！</p><pre class="je jf jg jh fd ls lt lu lv aw lw bi"><span id="5d78" class="lx jx hi lt b fi ly lz l ma mb"><em class="jl">list_of_all_unique_note-chord: [‘A2’, ‘A2.F#3’, ‘A2.F3’, ‘A3’, ‘A3.B3’, ‘A3.F#3’, ‘A4’, ‘A4.G#4’, ‘B-2’, ‘B-2.E3’, ‘B-2.G#3’, ‘B-2.G3’, ‘B-3’, ‘B-3.D3’, …]</em></span><span id="6811" class="lx jx hi lt b fi mc lz l ma mb"><em class="jl">list_of_all_unique_note-chord[102]: ‘G#2’</em></span></pre><p id="4e51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果 softmax 数组中的最高值没有明显高于所有其他值，这意味着模型没有真正的线索(因此您也没有任何线索)</p><p id="b99e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">那么，越界值得吗？</p></div></div>    
</body>
</html>