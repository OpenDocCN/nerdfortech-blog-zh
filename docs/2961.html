<html>
<head>
<title>Symfony / Doctrine — database encryption</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Symfony / Doctrine —数据库加密</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/symfony-doctrine-database-encryption-50d7e01d8f69?source=collection_archive---------5-----------------------#2021-05-25">https://medium.com/nerd-for-tech/symfony-doctrine-database-encryption-50d7e01d8f69?source=collection_archive---------5-----------------------#2021-05-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c17f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jd">用</em> <strong class="ih hj"> <em class="jd">主义</em> </strong> <em class="jd">和</em> <strong class="ih hj"> <em class="jd"> Symfony </em> </strong>加密数据库</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es je"><img src="../Images/6c0a55723a97275b079d4e5368ac2a7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1318/format:webp/0*GY1vkml8VtV5UFVC.png"/></div></figure><p id="ebfe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然个人资料应该保密，但在极少数情况下，由于某种原因，我们必须在公共服务中访问这些资料。我有自己的私人项目来管理个人数据(源代码可以在这里<a class="ae jm" href="https://github.com/Volmarg/personal-management-system" rel="noopener ugc nofollow" target="_blank">访问</a>)，但是由于我即将到来的移动性，我不得不<strong class="ih hj">在其他地方</strong>访问我的个人信息。</p><p id="45e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于这样的问题，自然没有什么解决方法，我立刻想到了2:</p><ul class=""><li id="d96e" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">移动笔记本电脑上的文件/信息，</li><li id="c358" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">通过互联网访问数据，</li></ul><p id="1503" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于少数情况，我选择了第二个选项:</p><ul class=""><li id="b367" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">我不必记得更新存储上的数据(crons会这么做)，</li><li id="798b" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">我不会总是使用笔记本电脑等(我可以通过手机访问数据)，</li><li id="076c" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">我想更好/更熟悉<strong class="ih hj"> Vue.js </strong>(那么这是一个机会)，</li></ul></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><blockquote class="ki"><p id="7af8" class="kj kk hi bd kl km kn ko kp kq kr jc dx translated"><em class="ks">“然而，所选择的解决方案有一个很大的缺点需要解决，那就是数据泄露的可能性”</em></p></blockquote></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="c70e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi kt translated"><span class="l ku kv kw bm kx ky kz la lb di">P</span>T22】保护个人资料</p><p id="d3df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">老实说，我已经变得有点痴迷于保护我的数据免受潜在的泄露(<em class="jd">风险总是存在，但你可以降低它，使其接近零</em>)。</p><p id="85dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">带着我所有实现的想法，我开始问自己“如果数据库会泄露怎么办？”。</p><p id="23a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个问题的解决方案几乎立刻就出现了，因为我已经在我的私人项目中部分依赖于它:“<strong class="ih hj">数据库加密</strong>”。</p><p id="baad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然我已经看到了一些带有<strong class="ih hj">教义</strong>的<strong class="ih hj"> Symfony </strong>的加密包，但我将只关注我一直使用的那个(实际上有一个小问题，但很容易解决):</p><ul class=""><li id="68cc" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">encrypt bundle(<a class="ae jm" href="https://github.com/mogilvie/EncryptBundle" rel="noopener ugc nofollow" target="_blank">mogilvie</a>—<strong class="ih hj">我依赖的那个</strong>)，</li><li id="5c13" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">DoctrineEncryptBundle(<a class="ae jm" href="https://github.com/GiveMeAllYourCats/DoctrineEncryptBundle" rel="noopener ugc nofollow" target="_blank">givemealyourats</a>—带有一些修复的fork)，</li></ul><p id="197e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">两个软件包共享相同的基本功能，即使用特殊密钥加密/解密数据库单元，然而<strong class="ih hj"> DoctrineEncryptBundle </strong>附带CLI命令，允许一次性处理整个数据库——这是一个非常好的特性。</p><p id="a71c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我继续使用我已经使用的<strong class="ih hj">加密包</strong>，并且我已经为它生成了加密密钥，因此我将能够在内部/外部项目之间共享一个密钥。</p></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="cdb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi kt translated"><span class="l ku kv kw bm kx ky kz la lb di">H</span>T7】ow事功</p><p id="7e34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<strong class="ih hj"> EncryptBundle </strong>非常简单直观。首先，自然地，必须通过composer将包添加到项目中，然后我们需要生成我们的加密密钥(就像最初的Readme " <a class="ae jm" href="https://github.com/mogilvie/EncryptBundle#step-2-configure-the-bundle" rel="noopener ugc nofollow" target="_blank">这里的</a>"中描述的那样)。</p><p id="cdb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的服务Yaml现在将包含这个新部分:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="6094" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，我们需要向实体列添加特殊的注释，如下所示:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lc ld l"/></div></figure><p id="3a6a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个包支持教义事件，所以这就是全部了——不需要更多。</p></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><blockquote class="ki"><p id="0d27" class="kj kk hi bd kl km kn ko kp kq kr jc dx translated">"没有注释可以处理加密吗？"</p></blockquote></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="85cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的。我不知道这个包处理教条事件，因此我在这个包的基础上做了自己的手动处理数据加密的方法。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lc ld l"/></div></figure><blockquote class="ki"><p id="d00a" class="kj kk hi bd kl km le lf lg lh li jc dx translated"><em class="ks">如果提供了不正确的密钥，加密数据会是什么样子？</em></p></blockquote><p id="8fe8" class="pw-post-body-paragraph if ig hi ih b ii lj ik il im lk io ip iq ll is it iu lm iw ix iy ln ja jb jc hb bi translated">这只是一个实际上很酷的空字符串，因为在我的例子中，我不在乎是否抛出异常或显示错误的数据——目标已经实现——数据是安全的。</p><p id="64c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我必须调试这个包，所以我可以说它依赖于名为<strong class="ih hj"> OpenSSL </strong>的PHP:</p><ul class=""><li id="42ad" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated"><a class="ae jm" href="https://www.php.net/manual/en/book.openssl.php" rel="noopener ugc nofollow" target="_blank">https://www.php.net/manual/en/book.openssl.php</a></li></ul></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="83e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi kt translated"><span class="l ku kv kw bm kx ky kz la lb di"> E </span> <strong class="ih hj"> ven更安全</strong></p><p id="70d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我希望我的数据可以通过互联网访问，所以我必须找到一种方法<em class="jd">“不要将密钥存储在服务器上”</em>基本上是这样的:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lo"><img src="../Images/8f1e060e5bb22b53666b6210bb18ae90.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/0*mPP__FDeiFzGo2yX"/></div></figure><p id="75c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，这就是我在开始时描述的问题——我使用的包不允许添加加密密钥<code class="du lp lq lr ls b">on-fly</code>,因为yaml参数丢失导致异常——因此，目前我已经硬编码了它，但似乎解决方案正在路上(由作者自己准备)—即使没有，也可以手动实现。非引导内核也有小问题(但我刚刚错过了引导检查)。</p><p id="6538" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我没有将密钥放在mat下面，而是扩展了我的登录表单:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es lt"><img src="../Images/57e0b8a9297473283bbdf87a5ef87345.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*6Cy1NXeY2zPgIsPvYmEveA.png"/></div><figcaption class="lu lv et er es lw lx bd b be z dx translated">加密密钥的密钥字段</figcaption></figure><p id="78c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我的总体解决方案是:</p><ul class=""><li id="ee5d" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">正在创建<strong class="ih hj"> OnBeforeSetKey，</strong></li><li id="4a7a" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">正在创建<strong class="ih hj">加密密钥</strong>文件，</li><li id="677e" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">读取每个请求的文件并设置键<code class="du lp lq lr ls b">on-fly</code>(替换占位符<code class="du lp lq lr ls b">000000000...</code>)，</li><li id="f619" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">有一个cronjobs，它检查最后一次用户活动，如果用户不在，就从服务器中删除密钥(通过将密钥存储在会话中而不是文件中，这可能更安全，但是我也在用户注销时删除文件，所以我将坚持我的方法，因为所有IP过滤等都很好)。</li></ul><p id="a6aa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">工作起来很有魅力——没有被优化(说文件每次都被打开),但是我不需要它用于我的小个子项目。</p><p id="d2e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在数据库中的单元格看起来像这样:</p><pre class="jf jg jh ji fd ly ls lz ma aw mb bi"><span id="1031" class="mc md hi ls b fi me mf l mg mh">3DDOXwqZAEEDPJDK8/LI4wDsftqaNCN2kkyt8+QWr8E=&lt;ENC&gt;</span></pre></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="ce0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">个人笔记</strong></p><p id="e326" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的例子中，我没有注意到任何性能法令，在获取/处理大量数据的情况下，它肯定会影响性能——它肯定会影响性能——不知道它会影响多少，但由于我们现在需要处理加密，每次它都可能会产生明显的影响。</p><p id="521f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管我对加密不太熟悉，但从逻辑上说，这很可能取决于所用的算法。</p></div></div>    
</body>
</html>