<html>
<head>
<title>Deploy an application in Azure Container Instances (ACI) using Azure Resource Manager (ARM) templates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Azure资源管理器(ARM)模板在Azure容器实例(ACI)中部署应用程序</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/deploy-an-application-in-azure-container-instances-aci-using-azure-resource-manager-arm-f678ee3de06e?source=collection_archive---------3-----------------------#2021-12-21">https://medium.com/nerd-for-tech/deploy-an-application-in-azure-container-instances-aci-using-azure-resource-manager-arm-f678ee3de06e?source=collection_archive---------3-----------------------#2021-12-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/a2de94dd79545760fba8291252046e85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*Dr39KmfEMfNXU_M7KR_vSw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">旗帜</figcaption></figure><p id="eadc" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">容器已经成为打包和部署云应用程序的首选方式。Azure的容器实例(ACI)为他们的Kubernetes服务(AKS)带来了一个最小的编排替代方案，这对于中小型应用程序来说可能是理想的。<br/>同样，云资源的自动化和无缺陷供应导致对基础设施即代码(IaC)的需求不断增长。ARM (IaC)模板为管理Azure云资源带来了强大的功能。<br/>今天，我将指导您使用ARM在ACI中部署应用。</p><p id="c723" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">这篇文章分为三个部分。<br/> <strong class="iw hj"> <em class="js">第一节</em> </strong>讲dockering an(NodeJs)应用；<br/> <strong class="iw hj"> <em class="js"> Section#2 </em> </strong>将帮助您创建Azure服务主体；<br/> <strong class="iw hj">第3节</strong>将带您完成将docker映像部署到Azure容器实例的步骤。</p><h1 id="5a45" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">第一部分:将申请归档</h1><p id="db28" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在这一节中，我将对一个现有的NodeJs应用程序进行docker化，创建它的docker映像，并验证它在本地可以完美地工作。如果你的申请已经被归档，跳过这一部分。</p><h2 id="2a89" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤1:将Dockerfile添加到您的应用程序中</h2><p id="38d5" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">我有一个正在整理的NestJs应用程序。默认情况下，该应用程序在端口80启动。添加Dockerfile文件以构建映像。</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><h2 id="b7ea" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤2:在本地验证</h2><p id="ad60" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在本地构建并运行docker映像，并验证它工作正常。</p><pre class="lk ll lm ln fd lq lr ls lt aw lu bi"><span id="f191" class="kw ju hi lr b fi lv lw l lx ly">$ <strong class="lr hj">docker build -t hello-world:1.0.0 .<br/></strong>$ <strong class="lr hj">docker run -p 80:80 hello-world:1.0.0</strong></span></pre><figure class="lk ll lm ln fd ij er es paragraph-image"><div class="er es lz"><img src="../Images/5b61a58deb09e8a8c552d5a159870623.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/0*E7rBjmnSvgerJBZd.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">在本地工作</figcaption></figure><h1 id="bc59" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">第2部分:创建Azure服务主体</h1><p id="28e4" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">本节将指导您创建一个资源组范围的服务主体。这些机密随后将用于向Azure CLI进行身份验证。如果您已经完成了这些步骤，请随意跳过这一部分。</p><h2 id="6418" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤1:在本地安装Azure CLI</h2><p id="5467" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">我们将使用Azure CLI创建所有资源，并且在继续下一步之前，这些资源必须安装在您的本地计算机上。<br/>使用<a class="ae ma" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-windows?tabs=azure-cli" rel="noopener ugc nofollow" target="_blank">此链接</a>下载Azure CLI。</p><h2 id="b1bc" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤2:交互式登录Azure CLI</h2><pre class="lk ll lm ln fd lq lr ls lt aw lu bi"><span id="3b21" class="kw ju hi lr b fi lv lw l lx ly">$ <strong class="lr hj">az login --tenant &lt;tenant_id&gt;</strong></span></pre><p id="e659" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">如果你只和一个房客交往，那么房客的争论就可以避免。否则，用您的Azure租户ID替换命令中的<tenant_id>,并在终端中运行。Azure CLI将使用您的默认浏览器让您登录。</tenant_id></p><h2 id="f9a9" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤#3:创建资源组</h2><p id="3c32" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">资源组是Azure中资源的逻辑集合。</p><pre class="lk ll lm ln fd lq lr ls lt aw lu bi"><span id="e289" class="kw ju hi lr b fi lv lw l lx ly">$ <strong class="lr hj">az group create -l centralindia -n TestGroup</strong></span></pre><p id="5ae2" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">使用您选择的名称和位置创建资源组。我正在“<em class="js">中心区</em>”中创建“<em class="js">测试组</em>”。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/f71057af8295ec3fe88df9316bb74259.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RUXDRg0KEyTphXGp.png"/></div></div></figure><h2 id="4812" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤4:创建服务主体</h2><p id="da83" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">Azure服务主体是为应用程序、托管服务和自动化工具访问Azure资源而创建的身份。它承担一些角色，在这些角色中它可以采取行动。要创建服务主体，请确保您有足够的权限(应用程序管理员)或您的租户所有者允许任何用户注册应用程序。</p><pre class="lk ll lm ln fd lq lr ls lt aw lu bi"><span id="798c" class="kw ju hi lr b fi lv lw l lx ly">$ <strong class="lr hj">groupId=$(az group show --name TestGroup --query id --output tsv)<br/></strong>$ <strong class="lr hj">MSYS_NO_PATHCONV=1 az ad sp create-for-rbac --name TestApp --role contributor --scope $groupId --sdk-auth</strong></span></pre><p id="9bae" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在第一个命令中，使用您在上一步中创建的资源组的名称。<br/>将服务主体的名称放在您选择的第二个命令中。我把它命名为“<em class="js"> TestApp </em>”。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/f62f00a18559ee6cd676f4b07e5e7de6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LurlElaatzWEhQEY.png"/></div></div></figure><p id="bca7" class="pw-post-body-paragraph iu iv hi iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">保存Azure生成的服务主体的JSON。</p><h1 id="ab62" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">第3部分:将您的映像部署到ACI</h1><p id="a244" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">本节使用Azure CLI、ARM模板将本地构建的映像部署到ACI。</p><h2 id="27da" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤1:通过服务主体登录</h2><p id="6131" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">通过服务主体登录Azure。将<client_id>、<client_secret>替换为上面为服务主体生成的clientId、clientSecret。</client_secret></client_id></p><pre class="lk ll lm ln fd lq lr ls lt aw lu bi"><span id="0518" class="kw ju hi lr b fi lv lw l lx ly">$ <strong class="lr hj">az login — service-principal -u &lt;client_id&gt; -p &lt;client_secret&gt; --tenant &lt;tenant_id&gt;</strong></span></pre><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/9f1a5d3d1b55ef5879eab4d8da4e2534.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HnMTBOvIEK4gZuNvu8QwLg.png"/></div></div></figure><h2 id="7303" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤2:创建容器注册中心(ACR)</h2><p id="dd4e" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">使用下面的命令提供您选择的名称来创建新的ACR。</p><pre class="lk ll lm ln fd lq lr ls lt aw lu bi"><span id="06e9" class="kw ju hi lr b fi lv lw l lx ly">$ <strong class="lr hj">az acr create --resource-group TestGroup --name testgroupregistry --sku Basic</strong></span></pre><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/86a83e44731ec5ac65683ba9eeb3800e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*thVZRO5JqmrMXNUI.png"/></div></div></figure><h2 id="ee26" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤#3:构建并推送创建的注册表</h2><p id="514c" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在这一步中，我们将在本地构建一个docker映像，标记它并将其推送到创建的ACR。在推送到ACR之前，我们必须登录它。</p><pre class="lk ll lm ln fd lq lr ls lt aw lu bi"><span id="06de" class="kw ju hi lr b fi lv lw l lx ly">$ <strong class="lr hj">docker build . -t hello-world:1.0.0<br/></strong>$ <strong class="lr hj">docker tag hello-world:1.0.0 testgroupregistry.azurecr.io/samples/hello-world:1.0.0<br/></strong>$ <strong class="lr hj">az acr login --name testgroupregistry</strong><br/>$ <strong class="lr hj">docker push testgroupregistry.azurecr.io/samples/hello-world:1.0.0</strong></span></pre><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/688320d648320f8627661d2620269a38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eeZTvUnptokaC7WnozNvfg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">构建和推送docker映像</figcaption></figure><h2 id="2136" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤#4:为ACI创建ARM模板</h2><p id="d4ea" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">创建一个bicep格式的ARM模板，用于在'<em class="js">&lt;git _ repo&gt;/infra/ACI . bicep '</em>创建一个ACI，内容如下<em class="js">。</em></p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><h2 id="2f9e" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤#5:创建一个ACI</h2><p id="d949" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">在存储库的根目录下运行下面的命令，创建一个ACI并部署生成的docker映像。<br/> <em class="js">注意</em>:ACI只能通过服务主体凭证访问ACR镜像。因此，用为上述服务主体生成的clientId，clientSecret替换&lt; client_id &gt;，&lt; client_secret &gt;。</p><pre class="lk ll lm ln fd lq lr ls lt aw lu bi"><span id="cb09" class="kw ju hi lr b fi lv lw l lx ly">$ <strong class="lr hj">az deployment group create --resource-group TestGroup --template-file infra/aci.bicep --parameters name=helloworlddev image=testgroupregistry.azurecr.io/samples/hello-world:1.0.0 registryServer=testgroupregistry.azurecr.io clientId=&lt;client_id&gt; clientSecret=&lt;client_secret&gt; dnsNameLabel=helloworlddevtest port=80</strong></span></pre><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/75ba59b0db53bbb490698547f9ab74d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5SM3gg1IhOXWZIGRgO7P_Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">部署</figcaption></figure><h2 id="38b3" class="kw ju hi bd jv kx ky kz jz la lb lc kd jf ld le kh jj lf lg kl jn lh li kp lj bi translated">步骤8:验证</h2><p id="8cf8" class="pw-post-body-paragraph iu iv hi iw b ix kr iz ja jb ks jd je jf kt jh ji jj ku jl jm jn kv jp jq jr hb bi translated">登录Azure Portal，导航到创建的容器实例，找到FQDN并浏览。</p><figure class="lk ll lm ln fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/14b41535cf98f9e4f2a4968b11e1aa0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9d5L-eWn52V_Eqwg.png"/></div></div></figure><blockquote class="mh mi mj"><p id="8cf6" class="iu iv js iw b ix iy iz ja jb jc jd je mk jg jh ji ml jk jl jm mm jo jp jq jr hb bi translated"><em class="hi">代码库:<br/></em><a class="ae ma" href="https://github.com/sharmavikashkr/azure-test" rel="noopener ugc nofollow" target="_blank"><em class="hi">https://github.com/sharmavikashkr/azure-test</em></a></p></blockquote></div></div>    
</body>
</html>