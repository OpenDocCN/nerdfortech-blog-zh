<html>
<head>
<title>Creating AWS IAM Users and Applying Policies using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 Terraform 创建 AWS IAM 用户和应用策略</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/creating-aws-iam-users-and-applying-policies-using-terraform-3138b23fddf0?source=collection_archive---------0-----------------------#2020-12-24">https://medium.com/nerd-for-tech/creating-aws-iam-users-and-applying-policies-using-terraform-3138b23fddf0?source=collection_archive---------0-----------------------#2020-12-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="115e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以使用 AWS 身份和访问管理(IAM)创建用户和组，并通过权限管理他们对 AWS 服务和资源的访问。</p><h1 id="7091" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak"> IAM 用户</strong></h1><p id="5860" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated"><strong class="ih hj">创建 IAM 用户:</strong></p><p id="1791" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要在 Terraform 中创建单个 IAM 用户，请创建一个 aws_iam_user 资源块并为其命名。如果我们只需要创建一个用户，这是一个相对简单的步骤。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="e3f8" class="kp je hi kl b fi kq kr l ks kt">resource "aws_iam_user" "demouser" {</span><span id="6169" class="kp je hi kl b fi ku kr l ks kt">    name = "tuckerdemo"</span><span id="f92c" class="kp je hi kl b fi ku kr l ks kt">}</span></pre><p id="b94f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">创建多个 IAM 用户:</strong></p><p id="ace2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建多个 IAM 用户有不同的方法。</p><p id="0182" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以从我们的第一个用户复制并粘贴资源块，并为后续的块赋予新的名称。然而，这会导致代码的重复，并且对于创建许多用户来说效率非常低，因为我们需要手动调整每个用户的名称。</p><p id="7104" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">count 元参数可用于复制和创建资源，次数不限。在这种情况下，3。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="9be3" class="kp je hi kl b fi kq kr l ks kt">resource "aws_iam_user" "demo" {</span><span id="7782" class="kp je hi kl b fi ku kr l ks kt">  count = 3</span><span id="541c" class="kp je hi kl b fi ku kr l ks kt">  name = "tuckerdemo"</span><span id="67c3" class="kp je hi kl b fi ku kr l ks kt">}</span></pre><p id="edbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以这种方式使用<strong class="ih hj"> count </strong>的问题是所有 3 个用户都有相同的名字“tuckerdemo”。</p><p id="afc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在名称后使用<strong class="ih hj"> count.index </strong>将给出对应于资源块每次迭代的不同索引号。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="e5b2" class="kp je hi kl b fi kq kr l ks kt">resource "aws_iam_user" "demo" {</span><span id="ca56" class="kp je hi kl b fi ku kr l ks kt">  count = 3</span><span id="0ff6" class="kp je hi kl b fi ku kr l ks kt">  name = "tuckerdemo.${count.index}"</span><span id="1015" class="kp je hi kl b fi ku kr l ks kt">}</span></pre><p id="ad00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，如果我们的用户需要不以数字开头和结尾的唯一名称，那么如果没有进一步的定制，这种方法就不合适。</p><p id="c608" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们将<strong class="ih hj"> count.index </strong>与插值函数相结合，我们可以进一步定制计数的每次迭代。插值函数<strong class="ih hj">长度</strong>和<strong class="ih hj">元素</strong>可用于此。</p><p id="5bcb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> element </strong> (list，index) —返回列表中给定索引处的单个元素。如果索引大于元素的数量，这个函数将使用标准的 mod 算法换行。该函数仅适用于平面列表。</p><p id="db48" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> length </strong> (list) —返回给定列表或映射中的成员数，或给定字符串中的字符数。</p><p id="082d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">唯一用户名的列表可以添加到一个单独文件的变量中，然后在我们的资源块中引用。让我们创建一个用户名变量。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="e718" class="kp je hi kl b fi kq kr l ks kt">variable "username" {</span><span id="f769" class="kp je hi kl b fi ku kr l ks kt">  type = list(string)</span><span id="46a4" class="kp je hi kl b fi ku kr l ks kt">  default = ["tucker","annie","josh"]</span><span id="722c" class="kp je hi kl b fi ku kr l ks kt">}</span></pre><p id="5acc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于下面的代码，对于用户名列表中的 3 个用户，<strong class="ih hj">长度</strong>函数将返回值 3。<strong class="ih hj">元素</strong>函数将返回用户名列表中与<strong class="ih hj">计数</strong>参数的不同索引号相关联的单个名称([0]="tucker "，[1]="annie "，[2]="josh ")。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="fafc" class="kp je hi kl b fi kq kr l ks kt">resource "aws_iam_user" "demo" {</span><span id="7d61" class="kp je hi kl b fi ku kr l ks kt">  count = "${length(var.username)}"</span><span id="3005" class="kp je hi kl b fi ku kr l ks kt">  name = "${element(var.username,count.index )}"</span><span id="e2be" class="kp je hi kl b fi ku kr l ks kt">}</span></pre><p id="2089" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们想输出我们创建的所有用户的 arn，我们可以用输出文件来实现。为“user_arn”创建一个输出块。值行中的“*”表示输出所有 aws_iam_user 的 arn。如果您只想输出特定用户的 arn，请将“*”更改为列表中该用户的索引号(0、1、2 等。).</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="7061" class="kp je hi kl b fi kq kr l ks kt">output "user_arn" {</span><span id="7f37" class="kp je hi kl b fi ku kr l ks kt">  value = aws_iam_user.demo.*.arn</span><span id="28db" class="kp je hi kl b fi ku kr l ks kt">}</span></pre><p id="faee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用长度和元素的替代方法是使用<strong class="ih hj"> for_each </strong>。</p><p id="82e5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果一个资源或模块块包含一个<strong class="ih hj"> for_each </strong>参数，其值是一个映射或一组字符串，Terraform 将为该映射或集合的每个成员创建一个实例。在本例中，我们将它用于一组由用户名组成的字符串。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="7e05" class="kp je hi kl b fi kq kr l ks kt">resource "aws_iam_user" "example" {</span><span id="3707" class="kp je hi kl b fi ku kr l ks kt">  for_each = toset(["tucker", "annie", "josh"])</span><span id="d3e6" class="kp je hi kl b fi ku kr l ks kt">  name     = each.value</span><span id="904f" class="kp je hi kl b fi ku kr l ks kt">}</span></pre><p id="5427" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">需要注意的是，当在资源上使用时，<strong class="ih hj"> for_each </strong>仅支持集合和映射。我们需要使用<strong class="ih hj"> toset </strong>将用户名列表转换成一个集合。当在资源块上使用<strong class="ih hj"> for_each </strong>时，它变成了一个资源映射，而不是像 count 那样的资源列表。</p><h1 id="379d" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated"><strong class="ak"> IAM 策略</strong></h1><p id="e1cc" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">IAM 策略授予 IAM 用户对 AWS 资源的访问权限。AWS 利用跨许多服务的标准 JSON 身份和访问管理(IAM)策略文档格式来控制对资源和 API 操作的授权。</p><p id="5ffd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">IAM 策略由一个或多个语句组成，这些语句包括一个效果(允许或拒绝)、一个或多个操作(例如 ec2:Describe*)以及一个或多个资源(“*”是指所有资源，但要指向特定资源，我们可以输入 arn)。</p><p id="d915" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个演示中，我们将使用下面显示的简单策略。当我们运行 plan 命令时，您将看到为 var.tf 文件中指定的每个用户创建了一个“newemp_policy”。</p><pre class="kg kh ki kj fd kk kl km kn aw ko bi"><span id="9d93" class="kp je hi kl b fi kq kr l ks kt">resource "aws_iam_user_policy" "newemp_policy" {</span><span id="f2bf" class="kp je hi kl b fi ku kr l ks kt">  count = length(var.username)</span><span id="7490" class="kp je hi kl b fi ku kr l ks kt">  name = "new"</span><span id="8779" class="kp je hi kl b fi ku kr l ks kt">  user = element(var.username,count.index)</span><span id="df4a" class="kp je hi kl b fi ku kr l ks kt">policy = &lt;&lt;EOF</span><span id="3f50" class="kp je hi kl b fi ku kr l ks kt">{</span><span id="86fe" class="kp je hi kl b fi ku kr l ks kt">  "Version": "2012-10-17",</span><span id="872c" class="kp je hi kl b fi ku kr l ks kt">  "Statement": [</span><span id="da86" class="kp je hi kl b fi ku kr l ks kt">    {</span><span id="7f83" class="kp je hi kl b fi ku kr l ks kt">      "Effect": "Allow",</span><span id="2b55" class="kp je hi kl b fi ku kr l ks kt">      "Action": [</span><span id="6fe3" class="kp je hi kl b fi ku kr l ks kt">        "ec2:Describe*"</span><span id="f36f" class="kp je hi kl b fi ku kr l ks kt">      ],</span><span id="0e2a" class="kp je hi kl b fi ku kr l ks kt">      "Resource": "*"</span><span id="6811" class="kp je hi kl b fi ku kr l ks kt">    }</span><span id="2b67" class="kp je hi kl b fi ku kr l ks kt">  ]</span><span id="b309" class="kp je hi kl b fi ku kr l ks kt">}</span><span id="d700" class="kp je hi kl b fi ku kr l ks kt">EOF</span><span id="4882" class="kp je hi kl b fi ku kr l ks kt">}</span></pre><p id="d3d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个关于使用 Terraform 创建 IAM 用户和策略的简短演示到此结束。有多种方法可以创建多个用户，因此请使用最能满足您需求的方法。<a class="ae kv" href="https://awspolicygen.s3.amazonaws.com/policygen.html" rel="noopener ugc nofollow" target="_blank"> AWS 策略生成器</a>是一个可以帮助您创建 JSON 策略文档的工具。</p></div></div>    
</body>
</html>