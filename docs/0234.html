<html>
<head>
<title>Ingress Gateway in Istio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Istio中的入口网关</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/ingress-gateway-in-istio-bb9ab466a1a0?source=collection_archive---------1-----------------------#2020-07-31">https://medium.com/nerd-for-tech/ingress-gateway-in-istio-bb9ab466a1a0?source=collection_archive---------1-----------------------#2020-07-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="384e" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">什么是Istio网关？</h2></div><p id="d129" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Istio网关描述了在服务网格的任一侧运行的负载平衡器。Istio网关有两种类型。</p><p id="63e5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Istio入口网关:控制进入网格的流量。</p><p id="1fde" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Istio出口网关:控制网格外部的流量。</p><p id="78f4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们用一个例子来理解这个东西。</p><p id="7162" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我有两个版本的应用程序在我的集群中运行:版本v1和版本v2。第一版可从http:// <ingress-ip> /v1获得，第二版可从http:// <ingress-ip> /v2获得。使用Kubernetes Ingress也可以实现相同的场景，但是当我们使用Istio网关时，我们可以利用丰富的Istio流量管理和安全功能，如请求路由、流量镜像、电路断开等。</ingress-ip></ingress-ip></p><p id="8e3f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在部署包含服务版本:v1内容的网页的Pod</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="e159" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在部署一个具有新版本v2的新pod。该pod将由web-service服务选择器选取。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="c38a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通过ClusterIP服务公开您的pod，因为我们将使用Istio入口网关向外界公开我们的服务。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="84ab" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，如果您将web服务卷曲，您可以看到robins对版本v1和v2的请求</p><blockquote class="ka kb kc"><p id="34c4" class="ix iy kd iz b ja jb ij jc jd je im jf ke jh ji jj kf jl jm jn kg jp jq jr js hb bi translated"><em class="hi">【root @ master istio-medium】#</em><strong class="iz hj"><em class="hi">kubectl run curl-test—image = odise/busybox-curl—RM-it—/bin/sh-c " while true；做curl网络服务；睡眠1；搞定"</em></strong><em class="hi"><br/>&lt;html&gt;&lt;正文&gt; &lt; h1 &gt;这是V1版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是V2版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是V1版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是V2版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是V1版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是V2版！&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;<br/>&lt;html&gt;&lt;body&gt;&lt;h1&gt;这是V1版！&lt;/h1&gt;T103】/body&gt;T105】/html&gt;T16】</em></p></blockquote><p id="dc2c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">但是我们希望我们的版本:v1应用程序在“http:// <ingress-ip> /v1”上提供服务，我们的版本:v2应用程序在“http:// <ingress-ip> /v2”上提供服务。这可以通过使用Istio的CRD虚拟服务来实现。但是首先，让我们为我们的应用程序定义一个网关(负载平衡器)。这是通过使用Istio中的网关资源来完成的。</ingress-ip></ingress-ip></p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="62e8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">网关:</strong></p><p id="79b2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> a)名称:指定网关的名称</strong></p><p id="c7ca" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">b)选择器:这些是应该应用配置的网关的标签。</p><p id="ef55" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">c)服务器:这指定了服务器规格的列表。</p><p id="778f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">d)端口号:网关应该监听的端口号。</p><p id="d64a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">e) port.name:应为端口指定的名称。</p><p id="c646" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">f) port.protocol:端口上暴露的协议。</p><p id="6fe8" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">g)主机:该网关暴露的主机。</p><p id="750d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">与Kubernetes入口资源不同，网关配置不包括流量路由配置。相反，流量配置是在Istio CRD的like VirtualService和DestinationRules中进行的。让我们看看如何在VirtualService和DestinationRules中配置上述场景。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="5f32" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">虚拟服务:</strong></p><p id="2a13" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">a)名称:指定虚拟服务的名称</p><p id="f522" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">b)主机:将流量发送到的目的主机。</p><p id="3a92" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">c) http:它是http流量的路由规则列表</p><p id="8588" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">d) <strong class="iz hj"> gateway.name </strong>:应该应用此配置的网关的名称。这应该与网关资源中给定的名称相匹配。</p><p id="ccba" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">e) http.match.uri.prefix:基于前缀的匹配要匹配的uri。</p><p id="95af" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">f) rewrite.uri:流量必须被重定向到的目标uri。这类似于nginx-ingress控制器中的注释【nginx.ingress.kubernetes.io/rewrite-target<strong class="iz hj">。</strong></p><p id="06ae" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">f)子集:在相应的目的地规则中定义的业务应该被定向到的子集的名称</p><p id="49d0" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">目的地规则:</strong></p><p id="cf9b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">a)名称:目标规则的名称</p><p id="4a60" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">b)主机:流量发送到的主机。这里的主机是我们的Kubernetes服务的DNS名称</p><p id="fbe2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">c)子集:代表服务的各个版本的命名集</p><p id="4023" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">d)子集名称:子集的名称</p><p id="9c38" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">e)标签:用于选择窗格的标签图</p><p id="2b35" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在让我们应用网关以及相应的VirtualService和DestinationRules。</p><p id="da3f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在curl第一版http:// <ingress_ip> <ingress_node_port> /v1，第二版http:// <ingress_ip> <ingress_node_port> /v2</ingress_node_port></ingress_ip></ingress_node_port></ingress_ip></p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="er es kh"><img src="../Images/14be5e562be979bd08a46b225a93ea41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UlmfStJpuO0q4I5c-kG3qw.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx translated">Istio中的入口网关</figcaption></figure><p id="6c9a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们使用kiali仪表板来实现同样的效果。我们将尝试使用前缀“/v1”只访问版本:v1。这应该只将请求路由到版本:v1。</p><blockquote class="ka kb kc"><p id="a54b" class="ix iy kd iz b ja jb ij jc jd je im jf ke jh ji jj kf jl jm jn kg jp jq jr js hb bi translated"><strong class="iz hj"> istioctl仪表板kiali </strong></p></blockquote><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="er es ks"><img src="../Images/9aa5b8f4d05682e0e7339e38772aa7b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dNBv2eNoqQsgJ56CZEnZ3Q.png"/></div></div><figcaption class="ko kp et er es kq kr bd b be z dx translated">基于用户请求，流量仅被路由到版本:v1</figcaption></figure><p id="7553" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">万岁！！我们成功地在Istio中实现了入口网关，并且使用Istio入口网关实现了基于路径的路由。</p></div><div class="ab cl kt ku gp kv" role="separator"><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky kz"/><span class="kw bw bk kx ky"/></div><div class="hb hc hd he hf"><h1 id="3bad" class="la lb hi bd lc ld le lf lg lh li lj lk io ll ip lm ir ln is lo iu lp iv lq lr bi translated">先决条件</h1><div class="ls lt ez fb lu lv"><a rel="noopener follow" target="_blank" href="/@pavan1999.kumar/introduction-to-istio-service-mesh-2bc68d2ffdac"><div class="lw ab dw"><div class="lx ab ly cl cj lz"><h2 class="bd hj fi z dy ma ea eb mb ed ef hh bi translated">Istio服务网格简介</h2><div class="mc l"><h3 class="bd b fi z dy ma ea eb mb ed ef dx translated">什么是Istio服务网格？</h3></div><div class="md l"><p class="bd b fp z dy ma ea eb mb ed ef dx translated">medium.com</p></div></div><div class="me l"><div class="mf l mg mh mi me mj km lv"/></div></div></a></div><div class="ls lt ez fb lu lv"><a rel="noopener follow" target="_blank" href="/@pavan1999.kumar/how-to-install-istio-using-istioctl-1557db1cd62d"><div class="lw ab dw"><div class="lx ab ly cl cj lz"><h2 class="bd hj fi z dy ma ea eb mb ed ef hh bi translated">如何使用istioctl安装Istio</h2><div class="mc l"><h3 class="bd b fi z dy ma ea eb mb ed ef dx translated">正如我在之前的文章中所讨论的，我们将致力于一些实时场景，在这些场景中，我们将能够…</h3></div><div class="md l"><p class="bd b fp z dy ma ea eb mb ed ef dx translated">medium.com</p></div></div><div class="me l"><div class="mk l mg mh mi me mj km lv"/></div></div></a></div><h1 id="d742" class="la lb hi bd lc ld ml lf lg lh mm lj lk io mn ip lm ir mo is lo iu mp iv lq lr bi translated">被推荐的</h1><div class="ls lt ez fb lu lv"><a rel="noopener follow" target="_blank" href="/@pavan1999.kumar/mirroring-of-live-traffic-in-kubernetes-using-istio-traffic-mirroring-36f8c4d32fe8"><div class="lw ab dw"><div class="lx ab ly cl cj lz"><h2 class="bd hj fi z dy ma ea eb mb ed ef hh bi translated">使用Istio流量镜像对Kubernetes中的实时流量进行镜像</h2><div class="mc l"><h3 class="bd b fi z dy ma ea eb mb ed ef dx translated">为什么需要流量镜像？</h3></div><div class="md l"><p class="bd b fp z dy ma ea eb mb ed ef dx translated">medium.com</p></div></div><div class="me l"><div class="mq l mg mh mi me mj km lv"/></div></div></a></div><div class="ls lt ez fb lu lv"><a rel="noopener follow" target="_blank" href="/@pavan1999.kumar/mtls-in-istio-970f0666b867"><div class="lw ab dw"><div class="lx ab ly cl cj lz"><h2 class="bd hj fi z dy ma ea eb mb ed ef hh bi translated">伊斯蒂奥的MTLS</h2><div class="mc l"><h3 class="bd b fi z dy ma ea eb mb ed ef dx translated">通过插入现有CA证书在Istio服务网格中设置相互TLS</h3></div><div class="md l"><p class="bd b fp z dy ma ea eb mb ed ef dx translated">medium.com</p></div></div><div class="me l"><div class="mr l mg mh mi me mj km lv"/></div></div></a></div><div class="ls lt ez fb lu lv"><a rel="noopener follow" target="_blank" href="/@pavan1999.kumar/weighted-routing-in-kubernetes-using-istio-5d9bdb495032"><div class="lw ab dw"><div class="lx ab ly cl cj lz"><h2 class="bd hj fi z dy ma ea eb mb ed ef hh bi translated">Kubernetes中使用Istio的加权路由</h2><div class="mc l"><h3 class="bd b fi z dy ma ea eb mb ed ef dx translated">让我们假设您的客户正在使用您的应用程序的版本:v1。应用程序的新版本:v2是…</h3></div><div class="md l"><p class="bd b fp z dy ma ea eb mb ed ef dx translated">medium.com</p></div></div><div class="me l"><div class="ms l mg mh mi me mj km lv"/></div></div></a></div></div></div>    
</body>
</html>