<html>
<head>
<title>OneDev with Kubernetes and LetsEncrypt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">OneDev 与 Kubernetes 和 LetsEncrypt</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/onedev-with-kubernetes-and-letsencrypt-c63d16a3a31?source=collection_archive---------5-----------------------#2021-11-24">https://medium.com/nerd-for-tech/onedev-with-kubernetes-and-letsencrypt-c63d16a3a31?source=collection_archive---------5-----------------------#2021-11-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ba5a924eb0e2e07158c42d05dbe782dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GS1ngC0zINPK4SkoZ7FnDA.png"/></div></div></figure><p id="a0aa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">OneDev 是一个开源的 git 服务器，具有内置的发布板和 CI/CD 功能。</p><p id="c3be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程解释了如何将 OneDev 部署到 Kubernetes 集群中以获得一个成熟的 CI/CD 场，并使用 LetsEncrypt 对其进行保护。</p><p id="a598" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将使用 Google Kubernetes 引擎进行演示，根据我的经验，这个引擎的设置和维护最为方便。</p><ol class=""><li id="7f60" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">使用所有默认选项创建标准 GKE 集群</li></ol><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jy"><img src="../Images/30fdcfa87bd3e5a0ec4635af85ee7064.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*13VKWQvk9Ba3oKcMBBMSlA.png"/></div></div></figure><p id="134d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2.创建集群后，配置 kubectl 以连接到集群</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jy"><img src="../Images/78e8cb1d746a7b987d0b74e8d7a83ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WG1AHIaW3W8cM9bMuRR4bQ.png"/></div></div></figure><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jy"><img src="../Images/e91f39db588c0c0795238629ce5ef61f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zt522SvQ78uCiOKCyMeSXw.png"/></div></div></figure><p id="3c10" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.确保安装了<a class="ae jo" href="https://helm.sh/docs/intro/install/" rel="noopener ugc nofollow" target="_blank">头盔</a>，运行以下命令安装入口 Nginx 控制器和证书管理器:</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="01ab" class="ki kj hi ke b fi kk kl l km kn">$ helm install ingress-nginx ingress-nginx --repo https://kubernetes.github.io/ingress-nginx --namespace ingress-nginx --create-namespace<br/>$ kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.6.0/cert-manager.yaml</span></pre><p id="65be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4.运行以下命令获取 nginx 控制器的外部 ip 地址:</p><p id="b9ee" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du ko kp kq ke b">$ kubectl get service ingress-nginx-controller -n ingress-nginx</code></p><p id="ba18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.配置您的 dns 提供商以添加一个<code class="du ko kp kq ke b">A</code>记录，从而将 OneDev DNS 名称与上述外部 ip 地址相关联。等待一段时间，让 DNS 条目展开(您可以 ping DNS 名称，看看它是否返回正确的 ip 地址，以确保)</p><p id="a120" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.现在，使用以下命令将 OneDev 部署到集群中(将<onedev dns="" name="">替换为上述 DNS 名称，将<an email="" address="">替换为用于接收 LetsEncrypt 证书通知的电子邮件地址):</an></onedev></p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="e612" class="ki kj hi ke b fi kk kl l km kn">$ h<!-- -->elm install onedev onedev --repo https://dl.cloudsmith.io/public/onedev/onedev/helm/charts --namespace onedev --create-namespace --set ingress.host=&lt;OneDev DNS name&gt; --set ingress.tls=true --set letsencrypt.email=&lt;an email address&gt;</span></pre><p id="2c37" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有关 OneDev 图表可配置值的完整列表，请查看<a class="ae jo" href="https://code.onedev.io/onedev/server/~files/main/server-product/helm/values.yaml" rel="noopener ugc nofollow" target="_blank"> values.yaml </a>文件</p><p id="5654" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7.请等待 OneDev 部署完成。如果一切正常，您应该可以访问位于<code class="du ko kp kq ke b">https://&lt;OneDev DNS name&gt;</code>的 OneDev。如果它不工作，请遵循本指南解决名称空间<code class="du ko kp kq ke b">onedev</code>中证书<code class="du ko kp kq ke b">onedev-tls</code>的问题</p><p id="c977" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">8.如果您还希望启用对 OneDev 存储库的 SSH 访问，请运行以下命令来配置 Nginx 控制器的 tcp 端口</p><pre class="jz ka kb kc fd kd ke kf kg aw kh bi"><span id="ef96" class="ki kj hi ke b fi kk kl l km kn">helm upgrade ingress-nginx ingress-nginx --repo https://kubernetes.github.io/ingress-nginx --namespace ingress-nginx --create-namespace --set tcp.22=onedev/onedev:22 --reuse-values</span></pre><p id="3063" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后将 OneDev 端的<code class="du ko kp kq ke b">SSH server url</code>(通过菜单<em class="kr">管理/安全设置/ SSH 设置</em>)更新为<code class="du ko kp kq ke b">ssh://&lt;OneDev DNS name&gt;</code></p><p id="2319" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢阅读！</p></div></div>    
</body>
</html>