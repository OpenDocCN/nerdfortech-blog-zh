<html>
<head>
<title>MapReduce — Let’s average numbers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MapReduce —让我们平均一下数字</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/mapreduce-lets-average-numbers-f3648cc7b006?source=collection_archive---------3-----------------------#2021-04-16">https://medium.com/nerd-for-tech/mapreduce-lets-average-numbers-f3648cc7b006?source=collection_archive---------3-----------------------#2021-04-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a56f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在大数据环境中，MapReduce扮演着重要的角色。它是大多数大数据框架的底层技术——如apache hadoop、spark +许多其他平台。在本文中，我们不打算学习MapReduce，而是解决一个大数据问题。</p><p id="9700" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最近，我想在庞大的数据集中平均数字。举个例子，假设我有这样的数字，</p><p id="139f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi">1,2,3,4,…,18889008983748983484,…,170329034734838232803</p><p id="094d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，这可能是一个包含数TB数据的大数据集，我们无法在单台机器上处理它。那么我们如何尽可能简单地解决这个大数据问题呢？</p><h2 id="ac37" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">最笨的解决方案(但是有效！)</h2><p id="7776" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">最简单的方法是将每个数字映射到一个键，比如<code class="du ke kf kg kh b">(1,x)</code>，这里x代表数据集中的数字。因此，所有的数字将被加载到一个键和减速器将减少他们所有。这种方法并没有真正利用MapReduce框架的优势。这更像是简单循环平均算法的开销。所以我们必须找到一个技巧来将数据集分布到多个键上。</p><h2 id="438c" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">更好的解决方案</h2><p id="2d64" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">在这里，我们将跨多个键分布映射数据集，并使用多个归约器进行归约。</p><p id="c57e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是流程图。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ki"><img src="../Images/5ac14fbb631ee9a0d79df67979d47355.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V8pcGHtZbRbiiU9w.png"/></div></div></figure><p id="d005" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种方式将通过链接使用两个MapReducers。</p><p id="499b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们去实施吧。<a class="ae jd" href="https://github.com/isurunuwanthilaka/map-reduce-average-java" rel="noopener ugc nofollow" target="_blank">点击此处查看完整代码</a></p><h2 id="95aa" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">阶段1映射器</h2><pre class="kj kk kl km fd ku kh kv kw aw kx bi"><span id="9014" class="je jf hi kh b fi ky kz l la lb">public static class PrimaryMap extends MapReduceBase implements Mapper&lt;LongWritable, Text, IntWritable, IntWritable&gt; {<br/>        public void map(LongWritable key, Text value, OutputCollector&lt;IntWritable, IntWritable&gt; output, Reporter reporter) throws IOException {<br/>            int max = 4;<br/>            int min = 1;<br/>            Random r = new Random();<br/>            int t = r.nextInt(max) + min;<br/>            IntWritable bucketNo = new IntWritable(t);<br/>            IntWritable number = new IntWritable(Integer.valueOf(value.toString()));<br/>            output.collect(bucketNo, number);<br/>        }<br/>}</span></pre><p id="52b7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，我们得到<code class="du ke kf kg kh b">(line no, number)</code>作为<code class="du ke kf kg kh b">(K,V)</code>，但是数字对我们来说是唯一重要的东西。为了分配这些数字，我们将这些数字随机分配到桶中(这里我们有4个桶)。换句话说，bucket no表示该数据点的键。在这个例子中，我们有4个键。因此，<code class="du ke kf kg kh b">(K1,list(numbers)),...,(K4,list(numbers))</code>将在减速器阶段接收。</p><h2 id="4aa1" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">一期减速器</h2><pre class="kj kk kl km fd ku kh kv kw aw kx bi"><span id="3a9a" class="je jf hi kh b fi ky kz l la lb">public static class PrimaryReduce extends MapReduceBase implements Reducer&lt;IntWritable, IntWritable, IntWritable, IntWritable&gt; {<br/>        public void reduce(IntWritable key, Iterator&lt;IntWritable&gt; values, OutputCollector&lt;IntWritable, IntWritable&gt; output, Reporter reporter) throws IOException {<br/>            int sum = 0;<br/>            int count = 0;<br/>            while (values.hasNext()) {<br/>                sum += values.next().get();<br/>                count = count + 1;<br/>            }<br/>            output.collect(new IntWritable(count), new IntWritable(sum));<br/>        }<br/>    }</span></pre><p id="786a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这里，我们累加这些数字，然后求总和并计数。所以<code class="du ke kf kg kh b">PrimaryReduce</code>会将<code class="du ke kf kg kh b">(count,sum)</code>返回为(K，V)。这些结果将被临时保存到文件系统中，这是多作业链的一个缺点。</p><h2 id="d126" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">第二阶段映射器</h2><pre class="kj kk kl km fd ku kh kv kw aw kx bi"><span id="1655" class="je jf hi kh b fi ky kz l la lb">public static class SecondaryMap extends MapReduceBase implements Mapper&lt;LongWritable, Text, Text, Text&gt; {<br/>        private Text one = new Text("One");<br/>        public void map(LongWritable key, Text value, OutputCollector&lt;Text, Text&gt; output, Reporter reporter) throws IOException {<br/>            output.collect(one, value);<br/>        }<br/>    }</span></pre><p id="145f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们需要将所有数据放在一个键上，这样我们就可以轻松地计算平均值。简单。看看代码就知道了。</p><h2 id="1a79" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">二期减速器</h2><pre class="kj kk kl km fd ku kh kv kw aw kx bi"><span id="f38b" class="je jf hi kh b fi ky kz l la lb">public static class SecondaryReduce extends MapReduceBase implements Reducer&lt;Text, Text, Text, Text&gt; {<br/>        public void reduce(Text key, Iterator&lt;Text&gt; values, OutputCollector&lt;Text, Text&gt; output, Reporter reporter) throws IOException {<br/>            Integer sum = 0;<br/>            Integer count = 0;<br/>            while (values.hasNext()) {<br/>                String value = values.next().toString();<br/>                String[] temp = value.split("\\s+");<br/>                if (temp.length == 2) {<br/>                    sum += Integer.valueOf(temp[1]);<br/>                    count += Integer.valueOf(temp[0]);<br/>                }<br/>            }<br/><br/>            String avg = String.valueOf(sum.doubleValue() / count);<br/>            output.collect(new Text("output"), new Text(avg));<br/>        }<br/>    }</span></pre><p id="dbcd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在<code class="du ke kf kg kh b">key="one"</code>将获得所有的<code class="du ke kf kg kh b">sum,count</code>，因此我们运行平均函数，将总数和计数相加，以获得最终总数和最终计数。平均值就是简单的<code class="du ke kf kg kh b">sum/count</code>，我们输出为<code class="du ke kf kg kh b">("output",average)</code>，所以这个结果将再次保存在HDFS中。</p><p id="da83" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在链接所有的函数，如在<a class="ae jd" href="https://github.com/isurunuwanthilaka/map-reduce-average-java/blob/master/java-code/src/main/java/com/isuru/Average.java" rel="noopener ugc nofollow" target="_blank">Average.java</a></p><h2 id="d729" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">让我们在AWS EMR集群上进行测试。</h2><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lc"><img src="../Images/ae1e6c6673bbc7ab3fd5e934844fd080.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N0FbhG9fF7D-JbLD.JPG"/></div></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es ld"><img src="../Images/4883104f4c7a9bd3c81d5d408492cde1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fnJTg56FU5i_HWxI.JPG"/></div></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es le"><img src="../Images/c0eb08e90b8a23d1b356fd0a36fb3e56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_q1nZkO-mW78Hcwx.JPG"/></div></div></figure><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="er es lf"><img src="../Images/a1cf01501cdde733592056bc92475698.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vgDl6FGyNLsWkoyy.JPG"/></div></div></figure><p id="8784" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">该步骤成功完成后，检查S3中的<code class="du ke kf kg kh b">/output</code>文件夹以获得结果。</p><p id="681f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">编码快乐！</p><p id="d1ec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lg">原载于2021年4月16日</em><a class="ae jd" href="https://isurunuwanthilaka.github.io/software-engineering/2021/04/16/avg-mapreduce" rel="noopener ugc nofollow" target="_blank"><em class="lg">https://isurunuwanthilaka . github . io</em></a><em class="lg">。</em></p></div></div>    
</body>
</html>