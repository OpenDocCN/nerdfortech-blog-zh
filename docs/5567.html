<html>
<head>
<title>The “Nullbuster ” workaround for the unique index in SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SQL 中唯一索引的“Nullbuster”变通方法</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/the-nullbuster-workaround-for-the-unique-index-in-sql-9423c315cd2e?source=collection_archive---------2-----------------------#2021-10-17">https://medium.com/nerd-for-tech/the-nullbuster-workaround-for-the-unique-index-in-sql-9423c315cd2e?source=collection_archive---------2-----------------------#2021-10-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/0df6fd36dce35074a70cf0405c4e397f.png" data-original-src="https://miro.medium.com/v2/format:webp/1*vj9fJABgUbD89fMfJ21-LA.png"/></div></figure><p id="6ad8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于作为唯一索引键一部分的列来说,<code class="du jl jm jn jo b">“null”</code>意味着什么，SQL 社区在这个问题上存在相当大的分歧。<code class="du jl jm jn jo b">MySQL</code>允许它，而有些人如<code class="du jl jm jn jo b">SQL Server</code>则断然拒绝它。毫无疑问，没有 SQL 标准来决定空值是否具有可比性。</p><p id="17f4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然而，这种错位并不排除空唯一索引实际上有用的情况。我们将通过一个真实的用例来演示为什么需要找到一个解决方法。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="ec2d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi jw translated">假设你是一名电子商务公司的广告技术开发人员，正在为用户建立一个可以上线的广告条幅系统。一旦上线，横幅就可以点击，并指向一个“内容”，点击它的人会被重定向到这个内容。</p><p id="fa14" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您系统的主要用户是<em class="kf">内部团队，他们</em>日复一日地为内容创建多个横幅。根据经验，可能会创建多个针对相同内容的横幅。</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es kg"><img src="../Images/da3be7a2a7162b18d47ec55995955b28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bKG6iv0C48XVfqCxqJAUIA.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">实体图(左)显示了模式。可以添加 B3，因为 B1 尚未上线。</figcaption></figure><p id="03bd" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">业务询问</strong></p><blockquote class="kt ku kv"><p id="9645" class="im in kf io b ip iq ir is it iu iv iw kw iy iz ja kx jc jd je ky jg jh ji jj hb bi translated">在任何给定时刻，给定内容只能有一个<strong class="io hj">实时</strong>横幅。实时横幅的“横幅”和“接收”状态都设置为“实时”。<br/>这一限制是为了避免同一内容出现多个横幅广告，以免引发机会损失。但是，草稿横幅或其他状态上没有。</p></blockquote><p id="ae00" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，在上图中，可以添加<code class="du jl jm jn jo b">B4</code>，但不能添加<code class="du jl jm jn jo b">B5</code>，以免同一内容<code class="du jl jm jn jo b">C1</code>出现两个横幅(<code class="du jl jm jn jo b">B1</code>和<code class="du jl jm jn jo b">B5</code>)，这是一个问题。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h2 id="490a" class="kz la hi bd lb lc ld le lf lg lh li lj ix lk ll lm jb ln lo lp jf lq lr ls lt bi translated">你会怎么解决这个问题？</h2><p id="df3a" class="pw-post-body-paragraph im in hi io b ip lu ir is it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj hb bi translated">和往常一样，这里有多种方法需要权衡。您可以:</p><ul class=""><li id="6c99" class="lz ma hi io b ip iq it iu ix mb jb mc jf md jj me mf mg mh bi translated"><code class="du jl jm jn jo b">Option I</code>在您的 API 中执行<strong class="io hj">“设置前检查”</strong>，即在编写新标题之前，检查是否存在相同内容的活动标题。如果有，丢弃它，否则允许它。</li></ul><p id="5573" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jl jm jn jo b">Pros:</code> <strong class="io hj"> </strong>容易实现，偏向乐观锁定。没有模式更改或新的依赖关系。</p><p id="d9be" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jl jm jn jo b">Cons:</code>功能上<em class="kf">不正确</em>。存在竞争情况，在这种情况下，可能会在同一时刻同时写入两个横幅。对于少数系统来说，这可能是可以忍受的，但是对于我们来说，这是不行的。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><ul class=""><li id="7f88" class="lz ma hi io b ip iq it iu ix mb jb mc jf md jj me mf mg mh bi translated"><code class="du jl jm jn jo b">Option II</code> <strong class="io hj">向中央协调服务</strong>查询针对内容上的横幅的锁。如果一个新的横幅没有找到任何“锁定”的横幅内容，我们将锁定新的横幅，否则我们拒绝它。</li></ul><p id="7374" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jl jm jn jo b">Pros:</code> <strong class="io hj"> </strong>只要协调器启动，功能正常。协调器可以独立伸缩，也可以服务于其他锁请求。</p><p id="5411" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jl jm jn jo b">Cons:</code>国家泄漏真相的核心来源之外；服务变更需与协调员沟通；协调器设置的新依赖性和基础维护(如果从头开始)。对我们的问题来说，这感觉像是矫枉过正。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="600b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">似乎最无创和直观的解决方案是以某种方式<strong class="io hj">依赖数据库唯一索引</strong>。我们可以在“banner”上为这三列创建一个普通的唯一索引，这意味着如果所有三列在另一个记录中有重复值，则不能插入重复记录。</p><pre class="kh ki kj kk fd mi jo mj mk aw ml bi"><span id="e085" class="kz la hi jo b fi mm mn l mo mp">alter table banner add constraint <strong class="jo hj">unique_live_banner_idx</strong> UNIQUE      <br/>          (content_id, banner_status, ingestion_status);</span></pre><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es mq"><img src="../Images/8d1d4aa638840f3fc8187c636bbaa058.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8hU5vEMHxwUes35ccZxVUA.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">涵盖三个主要栏目的现有索引</figcaption></figure><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es mr"><img src="../Images/5bc7ab2753574467ef4e353d70e48194.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mA9yGwLVclqareqDM2NZ4g.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">假设像 Gorm (Go)或 Hibernate (Java)这样的 ORM，我们可以如上定义索引映射</figcaption></figure><p id="4bd8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">然而，这是不正确的。</strong>回忆，业务需求。除了<code class="du jl jm jn jo b">LIVE</code>之外，所有其他的横幅组合都是允许的。</p><p id="8936" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">让我们编写一个简单的<a class="ae jk" href="https://gist.github.com/isopropylcyanide/039d9ab4a746672d6fef0424448c7768" rel="noopener ugc nofollow" target="_blank"> Go 程序</a>(实际上可以是任何东西)使用<a class="ae jk" href="https://github.com/go-gorm/gorm" rel="noopener ugc nofollow" target="_blank"> Gorm </a>(也可以是任何东西)与 MySQL 对话来演示这种行为。</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ms"><img src="../Images/2867a334f68bb9b7ea69d7e2740f9abe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2nFj3yTUz-44XuU85SaMjg.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">示例测试场景 I-V。注意，场景 IV 应该成功，因为它是草稿，但是 V 应该失败。</figcaption></figure><p id="7532" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果对我们系统的查询按上述顺序发出，我们当前的索引将会失败<code class="du jl jm jn jo b">query V</code>(如预期的那样)，还会失败<code class="du jl jm jn jo b">query IV</code>，这是<strong class="io hj">不正确的</strong>。同一内容可能存在两个草稿横幅。</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es mt"><img src="../Images/6e5f9402c25dc9fe4ab256db5abe8ee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L8wYVbWBxYdQDYsjg_9laA.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">场景四也失败了，因为约束<code class="du jl jm jn jo b">C2-</code> DRAFT-DRAFT 似乎被违反了。不太好。</figcaption></figure><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es mu"><img src="../Images/3e4a0417ca85742e77bc73c64d68e1bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h7DstPhzCZ9Dy6zXdHz90A.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">系统的状态。插入了 3/4 条记录。场景 IV 的记录应该在这里，但是没有。</figcaption></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="85c8" class="mv la hi bd lb mw mx my lf mz na nb lj nc nd ne lm nf ng nh lp ni nj nk ls nl bi translated">那么，有什么诀窍呢？</h1><p id="c8fc" class="pw-post-body-paragraph im in hi io b ip lu ir is it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj hb bi translated">看起来我们已经接近并朝着正确的方向前进<em class="kf">(数据库唯一的完整性是我们所追求的)</em>。但是，当值为<code class="du jl jm jn jo b">LIVE</code>时，我们需要一种过滤唯一索引的方法。</p><p id="9e74" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">做这件事没有标准的方法。因此，我们在实体模式中引入了一个新的<strong class="io hj">可空的</strong>位域/ bool，并将其默认值<strong class="io hj">设置为 null </strong>。</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es nm"><img src="../Images/9ef3d8352589b124a3b80b7a0cd3b5e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fuGwqcjEe9wlI8Bg1KWB6A.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">注意<a class="ae jk" href="https://gist.github.com/isopropylcyanide/bf56c4bd583412b599d63c9e2bb4043a" rel="noopener ugc nofollow" target="_blank">补丁</a>。我们添加了一个新字段(并添加到现有的索引中),并将其默认值设置为 null</figcaption></figure><p id="2156" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然后，我们将它添加到现有的索引中，这样它就覆盖了新的列。</p><pre class="kh ki kj kk fd mi jo mj mk aw ml bi"><span id="f496" class="kz la hi jo b fi mm mn l mo mp">alter table banner add constraint unique_live_banner_idx UNIQUE      <br/>    (content_id, banner_status, ingestion_status, <strong class="jo hj">protected_status</strong>);</span></pre><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es nn"><img src="../Images/7e8efe73a76f9c44e4f79b90715e2334.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qkLQwIADMjj7VS2S9Qc1_A.png"/></div></div></figure><p id="1c9b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">就其本身而言，<code class="du jl jm jn jo b">MySQL</code>将 null 解释为<em class="kf">不可比的</em>，这意味着下面的值组合现在是<strong class="io hj">“非唯一的”</strong>，并且可以被插入。</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es no"><img src="../Images/7a184ccf50b4ba907a671770fcae39e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IG-71NeiwFacphjJT6tnMQ.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">情景四现在可以过去了。请注意，即使一切都相同，空值也是不可比的，因此是唯一的</figcaption></figure><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es np"><img src="../Images/61c82e387d605cfbc89d9c5ddb02c7d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8udD6UjzROjtVkEYxI7_Mw.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">数据库在运行情景一至五时的新状态</figcaption></figure><p id="8684" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然而，有一个问题。场景五现在也免费通过了，虽然它不应该通过。我们从来没有告诉系统专门处理一个<code class="du jl jm jn jo b">LIVE</code>横幅。</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es nq"><img src="../Images/856ddc1861d12029c04ff3aa7400163e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FP-ne8hjzX7s4lT2uysMUg.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">像键“<code class="du jl jm jn jo b">C2_DRAFT_DRAFT_NULL”</code>”<code class="du jl jm jn jo b">(scenario IV)</code>，键“<code class="du jl jm jn jo b">C1_LIVE_LIVE_NULL”</code>”T5】</figcaption></figure><p id="93c1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这就是使用<code class="du jl jm jn jo b">protected_status</code>的好处所在。无论何时，我们的业务逻辑保证我们是唯一的，我们可以简单地将其值设置为<strong class="io hj"> 1(或任何非空值)。</strong></p><p id="3ebe" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这样做可以保证不会插入两个重复的横幅，因为它们现在是<strong class="io hj">【非唯一】</strong>的，并且没有通过约束</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es nr"><img src="../Images/7f3e8364974c358326dc293a5d9afb99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5kN3GZsWyzkBVmhqoHywQ.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">由于活动横幅现在具有相同的非空保护状态，因此只能插入其中一个。</figcaption></figure><h2 id="bce7" class="kz la hi bd lb lc ld le lf lg lh li lj ix lk ll lm jb ln lo lp jf lq lr ls lt bi translated">在创建/更新之前，如何以及在哪里设置非空值？</h2><p id="4f00" class="pw-post-body-paragraph im in hi io b ip lu ir is it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj hb bi translated">这取决于用来与数据库通信的方法。像<code class="du jl jm jn jo b">Gorm for Go</code>、<code class="du jl jm jn jo b">Hibernate for Java</code>这样的 ORM 框架使得创建<a class="ae jk" href="https://gorm.io/docs/hooks.html" rel="noopener ugc nofollow" target="_blank">钩子</a> / <a class="ae jk" href="https://docs.jboss.org/hibernate/orm/3.5/api/org/hibernate/Interceptor.html" rel="noopener ugc nofollow" target="_blank">拦截器</a>变得极其容易，这些拦截器可以在<a class="ae jk" href="https://www.yourdictionary.com/upsert" rel="noopener ugc nofollow" target="_blank"> <em class="kf">上插入</em> </a>之前修改实体。</p><figure class="kh ki kj kk fd ii er es paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="er es ns"><img src="../Images/37a740678313a83a975318ba04c8e970.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8I-qyO-7EwH02PTEZMEfDQ.png"/></div></div><figcaption class="kp kq et er es kr ks bd b be z dx translated">两行“BeforeCreate”挂钩修复了我们的用例。当我们检测到活动横幅时，我们会将其标记为受保护</figcaption></figure><p id="dec0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果你没有使用 ORM ( <a class="ae jk" href="https://martinfowler.com/bliki/OrmHate.html" rel="noopener ugc nofollow" target="_blank"> <em class="kf">，我不怪你</em> </a> <em class="kf"> ) </em>，那么你可以手工插入逻辑。唯一需要注意的是，如果有多条路径可能会写入“横幅”实体，那么它们都应该通过钩子。<strong class="io hj">即使是不符合逻辑的单个路径也会违反需要单独协调的不变量</strong>。</p><p id="dc85" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">因此，推荐的方法是创建一个专用的、记录良好的钩子。使用这个，让我们修改我们的<a class="ae jk" href="https://gist.github.com/isopropylcyanide/421d0e89aec91e16647646d1c7e59532" rel="noopener ugc nofollow" target="_blank">程序</a>来使用上面的钩子。</p><p id="0416" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">“修复”唯一约束的最后一个补丁现在看起来如下。</p><figure class="kh ki kj kk fd ii"><div class="bz dy l di"><div class="nt nu l"/></div></figure><h2 id="1868" class="kz la hi bd lb lc ld le lf lg lh li lj ix lk ll lm jb ln lo lp jf lq lr ls lt bi translated">但是，我用的不是 MySQL。空值在我的数据库中不是唯一的</h2><p id="d118" class="pw-post-body-paragraph im in hi io b ip lu ir is it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj hb bi translated">公平点。这包括大多数数据库。修复非常简单。除了<code class="du jl jm jn jo b">null</code>，您能为您的记录找到任何其他“现在唯一的”标识符吗？</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><p id="808d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">是的，没错。<strong class="io hj"> <em class="kf">使用主键</em> </strong>。在默认块中，设置<code class="du jl jm jn jo b">protected_status: primary_key</code>并且只在钩子中修改。</p></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="d40d" class="mv la hi bd lb mw mx my lf mz na nb lj nc nd ne lm nf ng nh lp ni nj nk ls nl bi translated">那是一个包裹。</h1><p id="6cfe" class="pw-post-body-paragraph im in hi io b ip lu ir is it lv iv iw ix lw iz ja jb lx jd je jf ly jh ji jj hb bi translated">这就是诀窍。让我们总结一下我们所做的。</p><ul class=""><li id="4070" class="lz ma hi io b ip iq it iu ix mb jb mc jf md jj me mf mg mh bi translated">我们发现一个独特的约束是这里的首选方法，但必须稍微调整。</li><li id="e4ac" class="lz ma hi io b ip nv it nw ix nx jb ny jf nz jj me mf mg mh bi translated">我们在模式中引入了一个可以为空的新字段<code class="du jl jm jn jo b">protected_status</code>。为了避免浪费，我们选择了一个可空的小比特/布尔字段。</li><li id="26d5" class="lz ma hi io b ip nv it nw ix nx jb ny jf nz jj me mf mg mh bi translated">然后，我们修改了我们的索引以包含新的列。理论上，如果原始索引存在，这种“更新”应该成本不高。</li><li id="beb4" class="lz ma hi io b ip nv it nw ix nx jb ny jf nz jj me mf mg mh bi translated">然后，我们为<code class="du jl jm jn jo b">protected_status</code>设置正确的默认值，并创建一个钩子来撤销“空惟一性”,如果我们的逻辑需要的话。</li></ul><p id="336b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在让我们考虑一下这种方法的利弊。这个巧妙的技巧有它的作用，但不能被称为万灵药。</p><p id="2fed" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jl jm jn jo b">Pros:</code></p><ul class=""><li id="a043" class="lz ma hi io b ip iq it iu ix mb jb mc jf md jj me mf mg mh bi translated">即使更新了业务逻辑，字段<code class="du jl jm jn jo b">protected_status</code>也可以扩展到多个索引和列。真相的一个来源，在钩子里。</li><li id="1f53" class="lz ma hi io b ip nv it nw ix nx jb ny jf nz jj me mf mg mh bi translated"><strong class="io hj">零竞争条件</strong>并且不需要任何协调器就能工作。如果不能容忍重复，这可能是一个很好的选择。</li><li id="3d10" class="lz ma hi io b ip nv it nw ix nx jb ny jf nz jj me mf mg mh bi translated">如果使用 ORM，实现是微不足道的。</li></ul><p id="4285" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><code class="du jl jm jn jo b">Cons:</code></p><ul class=""><li id="2f59" class="lz ma hi io b ip iq it iu ix mb jb mc jf md jj me mf mg mh bi translated">实体模式编辑并不总是可行的。</li><li id="7262" class="lz ma hi io b ip nv it nw ix nx jb ny jf nz jj me mf mg mh bi translated">如果不使用 ORM，就有可能绕过钩子。</li><li id="93de" class="lz ma hi io b ip nv it nw ix nx jb ny jf nz jj me mf mg mh bi translated">新的索引不是免费的，虽然微不足道，但也占用了一些空间。</li></ul><p id="331b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">感谢您的阅读。感谢任何反馈。</p></div></div>    
</body>
</html>