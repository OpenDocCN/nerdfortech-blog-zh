<html>
<head>
<title>Safe Retrofit calls extension with kotlin Coroutines for Android in 2021 — Part III</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">2021年Android安全改造调用kotlin协同程序扩展—第三部分</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-iii-583249b0e86b?source=collection_archive---------3-----------------------#2021-05-17">https://medium.com/nerd-for-tech/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-iii-583249b0e86b?source=collection_archive---------3-----------------------#2021-05-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ae7cee4861952fceedb224c4061c31cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LqcZky6_qAUF4AOq"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae iu" href="https://unsplash.com/@ffstop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">的照片</a></figcaption></figure><p id="0592" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是了。这个小编的结尾。如果你还没有看过前两部分，这里有它的链接。</p><div class="jt ju ez fb jv jw"><a href="https://christopher-elias.medium.com/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-i-d47e9e2962ad" rel="noopener follow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">2021年Android安全改造调用kotlin协同程序扩展—第一部分</h2><div class="kd l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">christopher-elias.medium.com</p></div></div><div class="ke l"><div class="kf l kg kh ki ke kj io jw"/></div></div></a></div><div class="jt ju ez fb jv jw"><a href="https://christopher-elias.medium.com/safe-retrofit-calls-extension-with-kotlin-coroutines-for-android-in-2021-part-ii-fd55842951cf" rel="noopener follow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">2021年Android安全改造调用kotlin协程扩展—第二部分</h2><div class="kd l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">christopher-elias.medium.com</p></div></div><div class="ke l"><div class="kk l kg kh ki ke kj io jw"/></div></div></a></div><h1 id="690c" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">快速回顾一下！</h1><p id="efcc" class="pw-post-body-paragraph iv iw hi ix b iy lj ja jb jc lk je jf jg ll ji jj jk lm jm jn jo ln jq jr js hb bi translated">首先，祝贺你取得了这么大的进步👏。</p><ul class=""><li id="0088" class="lo lp hi ix b iy iz jc jd jg lq jk lr jo ls js lt lu lv lw bi translated">我们需要一个分机来拨打✔️.安全改造电话</li><li id="8255" class="lo lp hi ix b iy lx jc ly jg lz jk ma jo mb js lt lu lv lw bi translated">我们需要一种方法来解析异常并将它们返回给人类可读的objects✔️.</li><li id="c5d9" class="lo lp hi ix b iy lx jc ly jg lz jk ma jo mb js lt lu lv lw bi translated">我们需要把成功或失败作为result✔️.的回报</li></ul><p id="ddc6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们将添加我们的中间件。这个功能将允许我们<strong class="ix hj">阻止</strong>执行改造调用，如果它的任何条件没有被提供的话。大约</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="38dd" class="ml km hi mh b fi mm mn l mo mp">if(middlewareConditionsAreSupplied) executeRetrofitCall else NOT!</span></pre></div><div class="ab cl mq mr gp ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hb hc hd he hf"><h1 id="6e89" class="kl km hi bd kn ko mx kq kr ks my ku kv kw mz ky kz la na lc ld le nb lg lh li bi translated">中间件需求</h1><ul class=""><li id="aa9c" class="lo lp hi ix b iy lj jc lk jg nc jk nd jo ne js lt lu lv lw bi translated"><strong class="ix hj">可扩展的</strong> —我们的应用可以有多个中间件。我们可以有一个验证网络连接的中间件，另一个验证一些特定的特性参数，等等。任何你能想象到的东西来阻止改造电话的执行。</li><li id="e9c6" class="lo lp hi ix b iy lx jc ly jg lz jk ma jo mb js lt lu lv lw bi translated"><strong class="ix hj">易于注入</strong> —我们需要创建一个对象，它可以易于注入到我们的安全改进调用包装器扩展中。</li><li id="5882" class="lo lp hi ix b iy lx jc ly jg lz jk ma jo mb js lt lu lv lw bi translated"><strong class="ix hj">易于模仿</strong> —我们需要以某种方式使这个中间件易于模仿，以防止我们的单元测试变得难以测试。</li><li id="638a" class="lo lp hi ix b iy lx jc ly jg lz jk ma jo mb js lt lu lv lw bi translated"><strong class="ix hj">检索所有的</strong> —我们需要一种方法来检索我们所有的中间件，并验证它们中的每一个。</li></ul><h1 id="8c23" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">代码时间🔥</h1><p id="3569" class="pw-post-body-paragraph iv iw hi ix b iy lj ja jb jc lk je jf jg ll ji jj jk lm jm jn jo ln jq jr js hb bi translated">既然我们已经设置了中间件的需求，我们就可以编码了。让我们从第一部分开始。我们计划将该功能集成到我们的调用包装器扩展中，因此，这意味着中间件的失败将返回一个<strong class="ix hj">失败</strong>对象。这是我们的起点。</p><pre class="mc md me mf fd mg mh mi mj aw mk bi"><span id="6948" class="ml km hi mh b fi mm mn l mo mp">class NetworkMiddlewareFailure(<br/>    val middleWareExceptionMessage: String,<br/>) : Failure.CustomFailure()</span></pre><p id="77c5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">简单的蛋糕。让我们进入下一个陡坡。我们的应用程序可以有多个中间件对象，其中任何一个都需要以某种方式进行验证，让我们使用继承原则来完成这一步。</p><figure class="mc md me mf fd ij"><div class="bz dy l di"><div class="nf ng l"/></div></figure><p id="bb25" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个类将完成这项工作。我们想要创建的每一个中间件都将<strong class="ix hj">扩展</strong>这个类，<strong class="ix hj">覆盖</strong>这个<code class="du nh ni nj mh b">isValid()</code>方法(<em class="nk">这里是放置我们的逻辑</em>和<code class="du nh ni nj mh b">failure</code>变量的地方，这些变量都是从上面的自定义失败中扩展而来的。</p><p id="1371" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">那么让我们创建一个简单的中间件吧！</p><figure class="mc md me mf fd ij"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">验证手机是否连接到互联网的中间件。</figcaption></figure><p id="0380" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">上面的类负责在<code class="du nh ni nj mh b">connectivityUtils</code>接口的帮助下告诉我们是否连接到互联网(实现类隐藏在某处)。</p><p id="cdbb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果<code class="du nh ni nj mh b">isValid()</code>方法返回false，那么在<code class="du nh ni nj mh b">resourceProvider </code>接口的帮助下，我们将使用<code class="du nh ni nj mh b">NetworkMiddlewareFailure</code>和来自res/strings文件夹的自定义消息。如您所见，我们的实现非常灵活，允许我们使用任何想要的东西来创建中间件。</p><p id="be18" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">好了，我们可以创建许多中间件，现在呢……？我们需要某种方法来提供我们所有的中间件，并在每个中间件上运行<code class="du nh ni nj mh b">isValid()</code>方法🤯！</p><p id="d561" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">嘿嘿嘿👊💥！不要惊慌。我们可以用<strong class="ix hj">依赖倒置原则</strong>非常容易地解决这个问题。对我们来说，依赖抽象比依赖实现更好。让我们创建一个能做我们想做的事情的界面。</p><figure class="mc md me mf fd ij"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">接口的一个方法来检索所有的BaseNetworkMiddleware实例。</figcaption></figure><p id="860a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在是实施的时候了。我们将创建一个类来实现我们的<code class="du nh ni nj mh b">MiddlewareProvider</code>接口并覆盖那个<code class="du nh ni nj mh b">getAll()</code>方法，以便返回我们所有的中间件对象。我们可以在这里用一个构建器模式来做一点花哨的东西。</p><figure class="mc md me mf fd ij"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">在私有列表中存储所有中间件实例的MiddlewareProvider。</figcaption></figure><p id="dccb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如你所看到的，上面的类将添加所有你想要的中间件。你只需要在你的依赖注入图中提供这个类，它可以来自dagger或者koin或者其他什么。</p><figure class="mc md me mf fd ij"><div class="bz dy l di"><div class="nf ng l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">关于如何向您的DI图提供您的MiddlewareProvider的示例。</figcaption></figure><p id="82c4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们有了一个中间件提供者的单一实例。让我们修改调用包装器扩展！</p><figure class="mc md me mf fd ij"><div class="bz dy l di"><div class="nf ng l"/></div></figure><p id="6f3c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">干得好，我的朋友👏！您已经为我们的扩展实现了一个中间件，并使它更加安全！现在，您可以按照我在本系列的第一部分中向您展示的那样使用它了。</p><figure class="mc md me mf fd ij"><div class="bz dy l di"><div class="nf ng l"/></div></figure><p id="c3e3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望你喜欢它。如有任何建议、改进、投诉、笑话等。添加评论，文件和问题，生成公关，等等！注意安全！</p><p id="b6a5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">看看这个实现是如何在这个项目中使用的</p><div class="jt ju ez fb jv jw"><a href="https://github.com/ChristopherME/movies-android" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">Christopher me/电影-android</h2><div class="nl l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">Movies是一个简单的项目，可以学习和使用一些android组件、架构和Android工具…</h3></div><div class="kd l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">github.com</p></div></div><div class="ke l"><div class="nm l kg kh ki ke kj io jw"/></div></div></a></div><p id="8917" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">回头见！👋</p></div></div>    
</body>
</html>