<html>
<head>
<title>Kubernetes Cluster Autoscaler in Action</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes 集群自动缩放器正在运行</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/kubernetes-cluster-autoscaler-in-action-6172a023f542?source=collection_archive---------1-----------------------#2021-10-10">https://medium.com/nerd-for-tech/kubernetes-cluster-autoscaler-in-action-6172a023f542?source=collection_archive---------1-----------------------#2021-10-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e74e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用 Kubernetes 集群自动缩放器有效节约成本</p><p id="3b5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您是否在生产环境中运行 Kubernetes 集群？太好了，您有多少节点在运行您的集群？就我个人而言，我一直在运行一个 Kubernetes 集群来托管一个简单的自助服务应用程序，最初有大约 40 个工作节点。</p><p id="80f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们认为这是必要的，因为我们在高峰时段会有较高的负载，但我们注意到大多数工作节点在晚上和周末等负载较低的时段处于空闲状态，因此浪费了我们的预算。</p><p id="dad9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入<a class="ae jd" href="https://github.com/kubernetes/autoscaler" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">Kubernetes Cluster Autoscaler</strong></a>，多亏了 auto scaler，我们成功地将资源使用量减少了约 50%，同时保持了应用程序的高性能和高响应性。</p><p id="3eff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">kubernetes Cluster auto scaler<strong class="ih hj"/>根据您的工作负载需求，自动调整给定集群中工作节点的数量。您不需要手动添加或删除节点，也不需要过度配置集群。相反，您可以为集群指定最小和最大大小，扩展是自动的，由集群自动缩放器自行完成。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/a0b3a850c110511cd5b0a1d0ce889b4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t0vjT7c95rOu63OiuNO7Eg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">运行中的集群自动缩放器</figcaption></figure><h1 id="ff60" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">整个故事是关于什么的？(TLDR)</h1><ol class=""><li id="b568" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">了解集群自动缩放。</li><li id="34e1" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">在 GCE 上的 Kubernetes 集群上实现集群自动缩放。</li></ol><h1 id="ee44" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">先决条件</h1><ol class=""><li id="075c" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">一个 GCP 账户(你可以获得一个有 300 美元免费信用的免费级账户)。</li><li id="be13" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">安装在你机器上的 Helm 二进制文件。</li></ol><h1 id="87d4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">故事资源</h1><ol class=""><li id="8f1f" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">GitHub 链接:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests</a></li><li id="4cfc" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">GitHub 分支:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/tree/cluster-autoscaler-gce" rel="noopener ugc nofollow" target="_blank"> cluster-autoscaler-gce </a></li></ol><h2 id="98e2" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">集群自动缩放器</h2><p id="89e9" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated"><strong class="ih hj"> 1)放大</strong></p><p id="a164" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们首先了解一下集群自动缩放在纵向扩展节点时是如何工作的。CA ( Cluster Autoscaler)每 10 秒检查一次任何不可计划的 pod。如果不可安排的 pod 列表中有任何项目，Cluster Autoscaler 会尝试找到一个新的位置来运行它们。CA 假设底层节点是自动缩放组的一部分，并尝试基于此来缩放它们。创建的节点出现在 Kubernetes 中可能需要一些时间。它几乎完全取决于云提供商和节点供应的速度。</p><p id="ddfd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> 2)缩小比例</strong></p><p id="238f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">集群自动缩放通过执行以下计算来检查哪些节点是不需要的:</p><p id="827a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> a) </strong>该节点上运行的所有 pod 的 CPU 和内存请求之和小于该节点可分配容量的 50%。</p><p id="0e68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> b) </strong>如果在节点上调度的 Pod 具有以下条件</p><ul class=""><li id="7109" class="ks kt hi ih b ii ij im in iq lz iu ma iy mb jc mc la lb lc bi translated">不能驱逐带有注释<code class="du md me mf mg b">"cluster-autoscaler.kubernetes.io/safe-to-evict": "false"</code>的 pod。</li><li id="16c0" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc mc la lb lc bi translated">带本地存储的 pod。</li><li id="4c32" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc mc la lb lc bi translated">不受控制器对象支持的窗格。</li><li id="b3b7" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc mc la lb lc bi translated">kube-没有 PDB 氏综合症的系统舱。</li><li id="be17" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc mc la lb lc bi translated">豆荚有限制性 PDB 氏症(如 100% PDB)。</li></ul><p id="936f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> c) </strong> Kubernetes Worker 节点用以下注释进行了注释</p><pre class="jf jg jh ji fd mh mg mi mj aw mk bi"><span id="fc24" class="li jv hi mg b fi ml mm l mn mo">"cluster-autoscaler.kubernetes.io/scale-down-disabled": "true"</span></pre><p id="d348" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">CA 检查所有上述条件，然后如果超过 10 分钟不再需要，就终止节点。</p><h2 id="b8aa" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">使增大者</h2><p id="8c93" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">好吧，我希望缩放逻辑非常明显。但是现在，如果您想在缩放实例之前执行一些数学运算，该怎么办呢？例如，当附加了多个实例组时，您可能希望缩放选定自动缩放组中的节点。您可能希望选择成本最低的节点组，同时选择其计算机与集群大小相匹配的节点组。扩张者出现了。扩展器提供不同的策略来选择要添加新节点的节点组。到目前为止，CA 有 5 种不同类型的扩展器。扩展器是:</p><ol class=""><li id="d482" class="ks kt hi ih b ii ij im in iq lz iu ma iy mb jc kz la lb lc bi translated"><strong class="ih hj">随机</strong>:这是默认的扩展器。从组中随机选择实例，并随机缩放。</li><li id="6f3e" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><strong class="ih hj">most-pods</strong>:CA 选择节点组，该节点组将在向上扩展时调度大多数挂起的 pods。</li><li id="9030" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><strong class="ih hj">最少浪费</strong>:CA 选择在纵向扩展后具有最少空闲 CPU 的节点组。</li><li id="1fe3" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><strong class="ih hj">价格</strong>:CA 选择成本最低的节点组，同时，其机器将匹配集群大小(目前为 GKE GCE 工作)。</li><li id="fb7b" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><strong class="ih hj">优先级</strong>:CA 根据用户给定的自定义优先级选举节点组。您可以在这里 了解如何配置自定义优先级<a class="ae jd" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/expander/priority/readme.md" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">。</strong></a></li></ol><h2 id="1d9e" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">自定义参数</h2><p id="b84b" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">除了使用默认值创建集群自动分类器之外，还可以显式覆盖这些值。例如，您可以配置一个节点在多长时间内不需要，然后才可以按比例缩小，按比例放大后多长时间恢复按比例缩小评估，等等。所有这些 CA 的参数都可以在<a class="ae jd" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-are-the-parameters-to-ca" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">这里</strong> </a> <strong class="ih hj">找到。</strong></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mp"><img src="../Images/aa97c644fb4d9f2351e5f90c1d8a4e8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TTrZaERNaanUNh3yhKDJRQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">集群自动缩放器的参数</figcaption></figure><p id="b6f7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，谈够了。让我们现在开始行动吧。作为本文的一部分，我已经在 GCE 上使用<a class="ae jd" href="https://kops.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> kOps </a>创建了集群。到目前为止，CA 支持以下 Kubernetes 集群安装方法</p><ol class=""><li id="a7ad" class="ks kt hi ih b ii ij im in iq lz iu ma iy mb jc kz la lb lc bi translated">GCE(在 GCE 节点上安装 Kubernetes 集群)</li></ol><p id="6d13" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.自动警报系统</p><p id="2968" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.天蓝色 AKS</p><p id="8805" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.OpenStack Magnum。</p><p id="7bb5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">集群自动缩放器可以使用舵图表<a class="ae jd" href="https://github.com/kubernetes/autoscaler/tree/master/charts/cluster-autoscaler" rel="noopener ugc nofollow" target="_blank">T3 这里</a>安装。</p><p id="fed8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在安装 autoscaler 之前，让我们首先使用 kOps 创建一个 Kubernetes 集群。创建 Kubernetes 集群还有许多其他方法，但是在本文的范围内，我使用 kOps。让我们也用 grafana 安装 Prometheus-Operator，这样我们就可以在一个漂亮的仪表盘<a class="ae jd" href="https://grafana.com/grafana/dashboards/3831" rel="noopener ugc nofollow" target="_blank">上看到缩放比例。一旦安装了 Prometheus stack，您还应该将该仪表板导入 Grafana，您应该会发现该仪表板已经显示了数据。</a></p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mq mr l"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">使用 Kops 创建集群</figcaption></figure><p id="2b3f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦集群准备就绪，让我们首先用实例组前缀配置 CA helm 图表。我们现在将转到 GCP UI，然后获取实例组的前缀。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ms"><img src="../Images/6d46fd52ac6974ebaa706edc27950d59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XmadWu-nsbGje8zh1IuopA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">GCP 云控制台</figcaption></figure><p id="f9dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的例子中，worker 节点实例组的名称是 a-nodes-us-central 1-a-medium-k8s-local。这是我的 values.yaml 文件。让我们探讨一下目前的选择。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="mq mr l"/></div></figure><ol class=""><li id="d05a" class="ks kt hi ih b ii ij im in iq lz iu ma iy mb jc kz la lb lc bi translated"><strong class="ih hj">auto discovery . cluster name</strong>:您的 Kubernetes 集群的名称。</li><li id="2c5f" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><strong class="ih hj">云提供商</strong>:云提供商的名称。该值应该是 gce、aws、azure 或 magnum。</li><li id="cc33" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><strong class="ih hj">autoscalinggroupsname Prefix . name</strong>:工作者节点实例组的前缀。<br/><strong class="ih hj">min size</strong>:K8s 集群的最小节点数。<br/> <strong class="ih hj"> maxSize </strong>:集群可以扩展到的最大节点数。</li><li id="ee5b" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><strong class="ih hj"> extraArgs </strong>:附加容器参数<br/><strong class="ih hj">skip-nodes-with-local-storage = false</strong>:这仅用于开发目的，不适用于生产环境。这将替换在一个节点上计划缩减到另一个节点的 pod，即使它有本地存储。默认值为 true。<br/><strong class="ih hj">scale-down-delay-after-add = 2m:</strong>将工作节点添加到集群后，CA 应等待的分钟数，以开始评估工作节点的缩减。这也是出于开发目的，以帮助我们更快地扩展。对于生产，请考虑将该值设置为更高的值。<br/><strong class="ih hj">scale-down-needless-time = 2m:</strong>节点被标记为不需要后缩小的分钟数。这也是出于开发目的，以帮助我们更快地扩展。对于生产，请考虑将该值设置为更高的值。</li><li id="9599" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><strong class="ih hj">service monitor</strong>:service monitor 有一个标签选择器来选择服务及其底层端点对象。它描述了普罗米修斯要监控的一组目标。</li><li id="bf4b" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated"><strong class="ih hj">普罗米修斯规则</strong>:要创建的库伯内特普罗米修斯规则。</li></ol><p id="57f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，现在让我们安装集群自动缩放器<a class="ae jd" href="https://github.com/kubernetes/autoscaler/tree/master/charts/cluster-autoscaler" rel="noopener ugc nofollow" target="_blank">舵图</a>。</p><pre class="jf jg jh ji fd mh mg mi mj aw mk bi"><span id="3d40" class="li jv hi mg b fi ml mm l mn mo">$ git clone <a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b <a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/tree/cluster-autoscaler-gce" rel="noopener ugc nofollow" target="_blank">cluster-autoscaler-gce</a></span><span id="9ac9" class="li jv hi mg b fi mt mm l mn mo">$ helm repo add autoscaler <a class="ae jd" href="https://kubernetes.github.io/autoscaler" rel="noopener ugc nofollow" target="_blank">https://kubernetes.github.io/autoscaler</a></span><span id="0be1" class="li jv hi mg b fi mt mm l mn mo">$ helm upgrade -i medium-ca-gce autoscaler/cluster-autoscaler -f as.yaml</span></pre><p id="ff68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从日志中，您应该看到托管实例组应该被自动发现。</p><blockquote class="mu mv mw"><p id="9a27" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">ku bectl logs medium-ca-GCE-cluster-auto scaler-568 f 44 fc 67–675 dx</strong></p></blockquote><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nb"><img src="../Images/99cb3e792a484c352430797cfc026b04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-Lg0PLYDpiuiFCcIcGZpA.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">突出显示了自动发现日志</figcaption></figure><blockquote class="mu mv mw"><p id="15b5" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">kube CTL get no | awk“{ print $ 1 }”</strong></p><p id="3ea4" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">名字</strong></p><p id="f13f" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">主美国中央 1-a-l918 </strong></p><p id="3be4" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">节点-美国-中央 1-a-q9ns </strong></p></blockquote><p id="9a3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们的集群拓扑，现在有一个主节点和一个工作节点。让我们创建一个简单的 nginx 部署，并将其扩展到 100 个副本。</p><blockquote class="mu mv mw"><p id="53f5" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj"> kubectl 创建部署 nginx — image=nginx </strong></p><p id="ad67" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">kubectl scale deploy nginx—replicas = 40</strong></p></blockquote><p id="72c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当我的 pod 进入挂起状态时，CA 会计算所需的节点数量，并触发新节点的扩展。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nc"><img src="../Images/23ddd917f024e37eed32b73ef421ffe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F73i2__AqCVJb84NcCX5Yg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">豆荚被放大</figcaption></figure><p id="753a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">大约一分钟后，您应该会发现添加到集群中的新节点。我所有的豆荚现在都处于运行状态。</p><blockquote class="mu mv mw"><p id="da33" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">库贝克获取号</strong></p></blockquote><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nd"><img src="../Images/39392d43cb487d8f9bb26aa6cdb0c13d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SqVyM9jMx3yilxFaupoLnQ.png"/></div></div></figure><p id="500e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们检查一下 grafana 的仪表板。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nc"><img src="../Images/d4615bec423389971f88c45fa4f8aa06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6xjozfwAYcL2RmK0KMfMjg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">集群自动缩放仪表板</figcaption></figure><p id="e688" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们将 nginx 部署扩展到 1。</p><blockquote class="mu mv mw"><p id="1e98" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">kubectl scale deploy nginx—replicas = 1</strong></p></blockquote><p id="b62a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">几分钟后，CA 会评估不需要的节点，并将不需要的节点上的 pod 重新安排到另一个节点，然后优雅地终止该节点。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ne"><img src="../Images/eb873eededbb4852b97d543c18ffc32f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yGPtlqf5r6qOyVhv1h3uWw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">单元被重新安排到另一个节点</figcaption></figure><p id="ed1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦 CA 认为该节点是不需要的，CA 就在不需要的节点上添加污点，这样就不会在该节点上安排新的 pod。</p><blockquote class="mu mv mw"><p id="dbf2" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">ToBeDeletedByClusterAutoscaler = 1620921499:无计划</strong></p><p id="5fdc" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj">DeletionCandidateOfClusterAutoscaler = 1620921376:preferno schedule</strong></p></blockquote><p id="e95f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果节点上有任何 PDB，只有在满足 PDB 约束后才会发生驱逐。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nf"><img src="../Images/47c43d9826eb1aa1514fccfc3e3ec6b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SuUdeGK1SMtM8PUsHJmn7A.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">正在缩小的节点</figcaption></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ng"><img src="../Images/dc921fcb01e65999c2c4cc8bee8a60e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JlEoJUvGQOR9R8-H7SDkCQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">显示缩放活动的 Grafana 仪表板</figcaption></figure><p id="facd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，一旦 CA 完成了所有活动，我们就应该知道集群中主节点和数据节点的实际数量了。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es nh"><img src="../Images/d67a470fc1ac929104ff99f37c5e5914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*24nUV4z1rXeoE2aNhBodiQ.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">kubectl 获取号</figcaption></figure><h2 id="5630" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">打扫</h2><p id="ef3a" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">好了，现在让我们删除整个集群。</p><blockquote class="mu mv mw"><p id="71e5" class="if ig mx ih b ii ij ik il im in io ip my ir is it mz iv iw ix na iz ja jb jc hb bi translated"><strong class="ih hj"> kops 删除集群 medium.k8s.local —是</strong></p></blockquote><h1 id="76b7" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论</h1><p id="a0f2" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">至此，我们已经了解了 Cluster Autoscaler 的工作原理，并通过终止不需要的资源来帮助我们降低成本。在我即将发表的文章中，我将写一篇关于如何利用集群自动缩放器和 Spot 实例(Preemptale 节点)的文章。如有任何新想法或问题，请随时联系我。另外，欢迎在评论区发表你的想法。</p><p id="9a42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">直到下次……..</p><h1 id="bdcf" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">被推荐的</h1><div class="ni nj ez fb nk nl"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/deep-dive-into-thanos-part-i-f72ecba39f76"><div class="nm ab dw"><div class="nn ab no cl cj np"><h2 class="bd hj fi z dy nq ea eb nr ed ef hh bi translated">深入灭霸——第一部分</h2><div class="ns l"><h3 class="bd b fi z dy nq ea eb nr ed ef dx translated">使用灭霸和普罗米修斯操作员监控 Kubernetes 的工作负载</h3></div><div class="nt l"><p class="bd b fp z dy nq ea eb nr ed ef dx translated">medium.com</p></div></div><div class="nu l"><div class="nv l nw nx ny nu nz jo nl"/></div></div></a></div><div class="ni nj ez fb nk nl"><a href="https://www.techmanyu.com/creating-self-hosted-github-runners-in-a-kubernetes-cluster-fd05560de34a" rel="noopener  ugc nofollow" target="_blank"><div class="nm ab dw"><div class="nn ab no cl cj np"><h2 class="bd hj fi z dy nq ea eb nr ed ef hh bi translated">在 Kubernetes 集群中创建自托管 GitHub 运行程序</h2><div class="ns l"><h3 class="bd b fi z dy nq ea eb nr ed ef dx translated">在您自己的 Kubernetes 集群上运行 GitHub 操作</h3></div><div class="nt l"><p class="bd b fp z dy nq ea eb nr ed ef dx translated">www.techmanyu.com</p></div></div><div class="nu l"><div class="oa l nw nx ny nu nz jo nl"/></div></div></a></div><div class="ni nj ez fb nk nl"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/logging-at-scale-in-kubernetes-using-grafana-loki-3bb2eb0c0872"><div class="nm ab dw"><div class="nn ab no cl cj np"><h2 class="bd hj fi z dy nq ea eb nr ed ef hh bi translated">使用 Grafana Loki 在 Kubernetes 进行大规模伐木</h2><div class="ns l"><h3 class="bd b fi z dy nq ea eb nr ed ef dx translated">使用 Grafana Loki 在 Kubernetes 中进行日志聚合</h3></div><div class="nt l"><p class="bd b fp z dy nq ea eb nr ed ef dx translated">medium.com</p></div></div><div class="nu l"><div class="ob l nw nx ny nu nz jo nl"/></div></div></a></div><div class="ni nj ez fb nk nl"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/running-apache-spark-on-eks-with-aws-spot-instances-f8ce91d319b9"><div class="nm ab dw"><div class="nn ab no cl cj np"><h2 class="bd hj fi z dy nq ea eb nr ed ef hh bi translated">使用 AWS Spot 实例在 EKS 上运行 Apache Spark</h2><div class="ns l"><h3 class="bd b fi z dy nq ea eb nr ed ef dx translated">通过 AWS Spot 实例为 EKS 上的 Apache Spark 工作负载有效节约成本</h3></div><div class="nt l"><p class="bd b fp z dy nq ea eb nr ed ef dx translated">medium.com</p></div></div><div class="nu l"><div class="oc l nw nx ny nu nz jo nl"/></div></div></a></div></div></div>    
</body>
</html>