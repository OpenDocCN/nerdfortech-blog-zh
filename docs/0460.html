<html>
<head>
<title>Event-Driven Architecture With Redis Streams Using Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Spring Boot的Redis流的事件驱动架构</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/event-driven-architecture-with-redis-streams-using-spring-boot-a81a1c9a4cde?source=collection_archive---------0-----------------------#2020-12-22">https://medium.com/nerd-for-tech/event-driven-architecture-with-redis-streams-using-spring-boot-a81a1c9a4cde?source=collection_archive---------0-----------------------#2020-12-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="41db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这个故事中，我将讨论如何在spring boot中使用Redis流处理实时数据流。这将用生产者和消费者模型来解释。</p><p id="ed2b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">早些时候，我尝试了Redis发布/子模型。但它有一个问题，当一个生产者发布一个主题时，它的所有消费者都会处理数据，这与卡夫卡使用消费者群体不同。Pubsub不是这样工作的——消息会发送到所有连接的订阅客户端</p><p id="dd0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">流处理</em> </strong></p><p id="f6bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以前，实时处理是以不同的方式完成的。例如:付款后，我们会将它们保存在数据库中，然后在晚上或分多批处理数据，并在系统中离线反映新数据。</p><p id="4f34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是现在我们需要处理实时数据，我们会得到连续的数据流。例如:推荐引擎的大部分。像网飞、prime这样的现代应用。基于我们的观看/搜索历史，推荐引擎预测下一个观看列表。这发生在当下。这将提供更好的用户体验和商业价值。另一个例子是我们即时进行的信用卡交易/UPI交易。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/69c0048fd193ec1e1c0bceda6383b4fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IKUcokJtg4VNDJbj36iNJA.png"/></div></div></figure><p id="e692" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">流处理是实时连续的数据处理。让我们看看如何通过Spring Boot使用Redis流实现简单的实时流处理。</p><p id="c714" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看一个电影数据库的用例。订阅用户或匿名用户观看电影，并且可以喜欢、不喜欢和评价电影。我们的任务是记录一些观点，喜欢，不喜欢，以及评级。我将通过随机化喜欢、不喜欢和评级部分来创建一个生产者/发布者服务。它们将被发布到Redis流，订阅了这些流的用户将在DB或任何其他子系统中更新它们(为了简单起见，这里我使用了Redis排序集)。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es jq"><img src="../Images/107f2a0dc08e81ee8d4a72fd06e5305a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SI6wYLoVZ_FjG37QL08J-Q.jpeg"/></div></div></figure><p id="d9bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">技术栈</strong></p><blockquote class="jr js jt"><p id="7497" class="if ig jd ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">Java 8</p><p id="f642" class="if ig jd ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">Spring Boot 2.3.7 .版本</p><p id="a694" class="if ig jd ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">Maven For Build</p><p id="d00c" class="if ig jd ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated">Docker为了简单起见(Redis在docker中，应用程序也在docker中)</p></blockquote><p id="45ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看代码库</p><p id="f072" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">发布者配置</em> </strong></p><p id="fee5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了简单起见，我使用了一个调度器，它每2秒钟将数据发布到流，订阅的消费者将发布到Redis排序集，其中包含详细信息(电影名称、喜欢数、不喜欢数和总评分)。</p><p id="d260" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，让我们看看已发布和消费的DTO类。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es jx"><img src="../Images/8b9c587120ae01ee9eeb15f30c7c5a84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1364/format:webp/1*OV75J1Rcsxcwn2mvFjPO4g.png"/></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es jy"><img src="../Images/c66da7d85e06740ff0aa223da1ca3290.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lCw2K3y6Xrhiuh18wZvsaQ.png"/></div></div></figure><p id="2691" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我生成了一些随机的电影库，每2秒发布一次。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="jz ka l"/></div></figure><p id="2c33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">每2秒运行一次并发布到Redis流的电影发布事件类</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="jz ka l"/></div></figure><p id="5a98" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd"> Redis消费者</em> </strong></p><p id="d015" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">RedisConfig类</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="jz ka l"/></div></figure><p id="35bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">电影事件消费者</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="jz ka l"/></div></figure><p id="d493" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将申请归档</strong></p><p id="d276" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用docker在一个简单的docker-compose文件中简单地设置Redis和其他引导应用程序，以避免任何进一步的安装。消费者应用程序将有3个副本，以确保负载是分布式的。为此使用了docker。</p><p id="ac92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Docker-compose.yaml</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="jz ka l"/></div></figure><blockquote class="jr js jt"><p id="d687" class="if ig jd ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj"> redis </strong>图像用于redis实例。</p><p id="7b43" class="if ig jd ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj"> redis-commander </strong>是redis的GUI，绑定到端口8081。</p><p id="f1b9" class="if ig jd ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj">带环境变量的再发行商</strong>提供了2000年的发行率。</p><p id="ecdb" class="if ig jd ih b ii ij ik il im in io ip ju ir is it jv iv iw ix jw iz ja jb jc hb bi translated"><strong class="ih hj"> redis-consumer </strong>也已配置。</p></blockquote><p id="cb68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">再版出版商的Docker文件</strong></p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="114c" class="kg kh hi kc b fi ki kj l kk kl">FROM openjdk:8-jdk-alpine<br/>ADD target/*.jar redis-stream.jar<br/>ENTRYPOINT java -jar redis-stream.jar</span></pre><p id="4367" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">经销商的Docker文件</strong></p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="5305" class="kg kh hi kc b fi ki kj l kk kl">FROM openjdk:8-jdk-alpine<br/>ADD target/*.jar redis-stream.jar<br/>ENTRYPOINT java -jar redis-stream.jar</span></pre><p id="424e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还没有在docker文件中触发构建，我们必须在启动并运行docker容器之前进行构建。</p><p id="f9b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">如何启动应用程序</strong></p><p id="584a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们同时构建发布者和消费者。导航到消费者和发布者目录，运行下面的maven命令来创建一个jar文件。</p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="9227" class="kg kh hi kc b fi ki kj l kk kl">mvn clean package -DskipTests</span></pre><p id="70f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">用Redis命令调出Redis</em></strong></p><p id="b0f3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">转到根目录并运行下面的命令</p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="2911" class="kg kh hi kc b fi ki kj l kk kl">docker-compose up redis redis-commander</span><span id="1cef" class="kg kh hi kc b fi km kj l kk kl">ereshgorantla@Ereshs-MacBook-Pro redis-stream % docker-compose up redis redis-commander<br/>WARNING: The Docker Engine you're using is running in swarm mode.</span><span id="b1f6" class="kg kh hi kc b fi km kj l kk kl">Compose does not use swarm mode to deploy services to multiple nodes in a swarm. All containers will be scheduled on the current node.</span><span id="c149" class="kg kh hi kc b fi km kj l kk kl">To deploy your application across the swarm, use `docker stack deploy`.</span><span id="52e7" class="kg kh hi kc b fi km kj l kk kl">Starting redis-stream_redis_1 ... done<br/>Starting redis-stream_redis-commander_1 ... done<br/>Attaching to redis-stream_redis_1, redis-stream_redis-commander_1<br/>redis-commander_1  | Creating custom redis-commander config '/redis-commander/config/local-production.json'.<br/>redis_1            | 1:C 22 Dec 2020 05:23:35.977 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo<br/>redis_1            | 1:C 22 Dec 2020 05:23:35.977 # Redis version=6.0.9, bits=64, commit=00000000, modified=0, pid=1, just started<br/>redis_1            | 1:C 22 Dec 2020 05:23:35.977 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf<br/>redis-commander_1  | Parsing 1 REDIS_HOSTS into custom redis-commander config '/redis-commander/config/local-production.json'.<br/>redis_1            | 1:M 22 Dec 2020 05:23:35.978 * Running mode=standalone, port=6379.<br/>redis_1            | 1:M 22 Dec 2020 05:23:35.978 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.<br/>redis_1            | 1:M 22 Dec 2020 05:23:35.978 # Server initialized<br/>redis_1            | 1:M 22 Dec 2020 05:23:35.978 * Loading RDB produced by version 6.0.9<br/>redis_1            | 1:M 22 Dec 2020 05:23:35.978 * RDB age 2642 seconds<br/>redis_1            | 1:M 22 Dec 2020 05:23:35.978 * RDB memory usage when created 0.79 Mb<br/>redis_1            | 1:M 22 Dec 2020 05:23:35.978 * DB loaded from disk: 0.000 seconds<br/>redis_1            | 1:M 22 Dec 2020 05:23:35.979 * Ready to accept connections<br/>redis-commander_1  | node ./bin/redis-commander <br/>redis-commander_1  | Using scan instead of keys<br/>redis-commander_1  | No Save: false<br/>redis-commander_1  | listening on 0.0.0.0:8081<br/>redis-commander_1  | access with browser at <a class="ae kn" href="http://127.0.0.1:8081" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8081</a><br/>redis-commander_1  | Redis Connection redis:6379 using Redis DB #0</span></pre><p id="db68" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">进入浏览器并打开<a class="ae kn" href="http://127.0.0.1:8081" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:8081 </a></p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ko"><img src="../Images/dd74b60ff87ebb30c9325ca72b8a9281.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iSbWRkINNiIPLMwIibP8xw.png"/></div></div></figure><p id="5eee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过名称“电影事件”创建Redis流，我们在应用程序中使用了相同的名称。</p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="b420" class="kg kh hi kc b fi ki kj l kk kl">XADD movie-events * any-key any-value</span></pre><p id="27b0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个消费者组，在消费者之间分担负载</p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="2668" class="kg kh hi kc b fi ki kj l kk kl">XGROUP CREATE movie-events movie-events $</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kp"><img src="../Images/9c7d7bfa7f985fd0db862288bd174264.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*htV1iPCISSkktCemLmmq0g.png"/></div></div></figure><p id="716e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">调出</em> </strong></p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="5c2e" class="kg kh hi kc b fi ki kj l kk kl">docker-compose up producer</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kq"><img src="../Images/debfbe177c6b62d90361df4c2be9753f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MZ-osa8REy5PSTHVuM82Gg.png"/></div></div></figure><p id="4d9a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> <em class="jd">让我们调出有3个复制品的消费者</em> </strong></p><pre class="jf jg jh ji fd kb kc kd ke aw kf bi"><span id="2491" class="kg kh hi kc b fi ki kj l kk kl">docker-compose up --scale consumer=3</span></pre><p id="bac0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查看控制台:您可以观察到3个消费者已经出现并开始消费流事件。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kr"><img src="../Images/b90c427fa0e66bfc81378271f5a5f5b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vzQF0iwCemIC7YU5ztyQpA.png"/></div></div></figure><p id="b833" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看docker实例</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ks"><img src="../Images/085a89d326446a93d45cd8b676f12305.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m5NascIj-kwf1xU-0X42Uw.png"/></div></div></figure><p id="a684" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看Redis commander，数据是否以带有电影名称的排序集发布。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es kt"><img src="../Images/20e2def720184f581bb6d7b7fd68c2ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BgbnZt_UhOwQqh2QP_E36Q.png"/></div></div></figure><p id="f0ca" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">仅此而已！快乐学习</p><p id="3061" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请在这里找到<a class="ae kn" href="https://github.com/ereshzealous/redis-stream" rel="noopener ugc nofollow" target="_blank">的完整源代码。</a></p><h1 id="ab60" class="ku kh hi bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">参考资料:</h1></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><div class="jf jg jh ji fd ly"><a href="https://redis.io/topics/streams-intro" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab dw"><div class="ma ab mb cl cj mc"><h2 class="bd hj fi z dy md ea eb me ed ef hh bi translated">Redis流介绍- Redis</h2><div class="mf l"><h3 class="bd b fi z dy md ea eb me ed ef dx translated">流是Redis 5.0中引入的一种新的数据类型，它以一种更抽象的方式对日志数据结构建模…</h3></div><div class="mg l"><p class="bd b fp z dy md ea eb me ed ef dx translated">redis.io</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm jo ly"/></div></div></a></div><div class="mn mo ez fb mp ly"><a href="https://redislabs.com/blog/getting-started-with-redis-streams-and-java/" rel="noopener  ugc nofollow" target="_blank"><div class="lz ab dw"><div class="ma ab mb cl cj mc"><h2 class="bd hj fi z dy md ea eb me ed ef hh bi translated">Redis流和Java | Redis实验室入门</h2><div class="mf l"><h3 class="bd b fi z dy md ea eb me ed ef dx translated">作为一名新的企业技术客户经理，我的首要任务之一是了解更多关于Redis的信息。所以我开始…</h3></div><div class="mg l"><p class="bd b fp z dy md ea eb me ed ef dx translated">redislabs.com</p></div></div><div class="mh l"><div class="mq l mj mk ml mh mm jo ly"/></div></div></a></div></div></div>    
</body>
</html>