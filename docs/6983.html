<html>
<head>
<title>Rebuilding a 3rd-Party Docker Image for Apple Silicon</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为 Apple Silicon 重建第三方 Docker 映像</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/rebuilding-a-3rd-party-docker-image-for-apple-silicon-8299fca9654?source=collection_archive---------0-----------------------#2022-06-27">https://medium.com/nerd-for-tech/rebuilding-a-3rd-party-docker-image-for-apple-silicon-8299fca9654?source=collection_archive---------0-----------------------#2022-06-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="c60f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我解释了如何将微软发布的 AMD64 Docker 映像转换为多架构映像，以便在 Apple Silicon 上本地运行。</p><h1 id="da5d" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">问题概述</h1><p id="0cea" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">问题中的码头工人形象是<a class="ae kg" href="https://github.com/Azure/Azurite" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">石青</strong></a>；微软为模拟其 Azure 存储云服务而创建的产品。开发人员使用 Azure 来构建和测试他们基于 Azure 存储的应用程序，而不会产生任何实际的云成本。</p><p id="0b41" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽管纯粹是为了本地开发，Azurite 实际上是一个非常强大的工具，它模拟:</p><ul class=""><li id="2e48" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc km kn ko kp bi translated">Azure Blob 存储(类似于 AWS S3)</li><li id="ad18" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">Azure 队列存储(类似于 AWS SQS)</li><li id="8abc" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc km kn ko kp bi translated">Azure 表存储(类似于 AWS DynamoDB)</li></ul><p id="fee6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了让开发者使用起来超级简单，微软发布了一张 Azurite 的<a class="ae kg" href="https://hub.docker.com/_/microsoft-azure-storage-azurite" rel="noopener ugc nofollow" target="_blank"> Docker 图片……不幸的是，那张图片只为 AMD64 制作。</a></p><p id="55d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这意味着当我在基于苹果芯片的 MacBook Air 上运行该图像时，我会在 Docker 桌面上收到一个大警告。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/7b3dc80f738aaf77791b78cbb1352fa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8u7jGC7DvRJqSKCgZVUVQA.png"/></div></div></figure><p id="d046" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">苹果芯片的 Docker 文档明确指出:</p><blockquote class="lh li lj"><p id="3819" class="if ig lk ih b ii ij ik il im in io ip ll ir is it lm iv iw ix ln iz ja jb jc hb bi translated">总之，在基于 Arm 的机器上运行基于 Intel 的容器应该被认为是“尽了最大努力”。我们建议尽可能在 Apple silicon 机器上运行 arm64 容器，并鼓励容器作者生产他们的容器的 arm64 或多 arch 版本。</p></blockquote><p id="e04f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Docker Desktop for Mac 能够使用 Rosetta 2 很好地模拟 AMD64 架构，这并不是一个完全的阻塞。然而，我开发的网站(<a class="ae kg" href="https://www.styleguise.net/" rel="noopener ugc nofollow" target="_blank"> StyleGuise </a>)使用了大量的图像数据，所以当我知道我在本地开发时从 Azurite 获得的性能低于标准时，我总是很苦恼。</p><p id="39c9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">好在石青是开源的！</strong></p><h1 id="e022" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">发现</h1><p id="dc6c" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我决定看看是否有其他人在 GitHub 上报告了这个问题。请看，<a class="ae kg" href="https://github.com/Azure/Azurite/issues/1556" rel="noopener ugc nofollow" target="_blank">有人在</a>前 5 天创建了一个问题。因为我不知道微软解决这个问题的优先级有多高，所以我查看了一下引擎盖，发现 Azurite 是用 node.js 构建的，<a class="ae kg" href="https://github.com/Azure/Azurite/blob/main/Dockerfile#L23" rel="noopener ugc nofollow" target="_blank">它的 Docker 映像基于 Alpine linux </a>。🧐我在回购文件的最上面找到了:</p><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="7fc7" class="lt je hi lp b fi lu lv l lw lx">FROM node:lts-alpine3.10</span></pre><p id="dcf1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我认为这个基本图像必须支持苹果硅。为了证实这一点，我使用了 docker 命令行工具:</p><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="3f70" class="lt je hi lp b fi lu lv l lw lx">docker manifest inspect node:lts-alpine3.10</span></pre><p id="8657" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这产生了一长串受支持的架构，其中最显著的是 AMD64 和 ARM64😃</p><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="1b98" class="lt je hi lp b fi lu lv l lw lx">{<br/>  "schemaVersion": 2,<br/>  "manifests": [<br/>    {<br/>      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",<br/>      "size": 1158,<br/>      "digest": "sha256:1c628f614c7f7622c2331c2a179b6df4cf86e53920107b2385739c0294130678",<br/>      "platform": {<br/>        "architecture": "amd64",<br/>        "os": "linux"<br/>      }<br/>    },<br/>    {<br/>      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",<br/>      "size": 1158,<br/>      "digest": "sha256:7725cb78551a3eec8874aa0c3fe2afadfd548224fd405d04a8a56235dfdef9e6",<br/>      "platform": {<br/>        "architecture": "arm64",<br/>        "os": "linux",<br/>        "variant": "v8"<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="6727" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">提示:查看 Docker 镜像支持的架构的另一种方式是通过<a class="ae kg" href="https://hub.docker.com/layers/node/library/node/lts-alpine3.10/images/sha256-f9cba6817f3dee4a9b8545e4abf77b91b7f25ec381f4231741be2c06b5e25920?context=explore" rel="noopener ugc nofollow" target="_blank"> Docker Hub UI </a></p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es ly"><img src="../Images/82f5f27bee5aaa50b53f7811a25c3da5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EE3gDuNuXbhuSOrKBqJsnQ.png"/></div></div></figure><h1 id="bbff" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">构建多元建筑形象</h1><p id="29ed" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">经过一些研究，我了解到了<code class="du lz ma mb lp b">buildx</code>、<a class="ae kg" href="https://docs.docker.com/buildx/working-with-buildx/" rel="noopener ugc nofollow" target="_blank">Docker 工具链中的一个命令，它简化了多架构映像的构建</a>。</p><p id="ca67" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lz ma mb lp b">buildx</code>是一个 Docker 插件，由<a class="ae kg" href="https://github.com/moby/buildkit" rel="noopener ugc nofollow" target="_blank">莫比</a>构建，并提供开箱即用的 Mac Docker 桌面。</p><p id="db28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">构建多架构 Docker 清单的过程如下:</p><ol class=""><li id="171e" class="kh ki hi ih b ii ij im in iq kj iu kk iy kl jc mc kn ko kp bi translated">创建一个 docker <em class="lk"> builder </em>，它实际上是一个运行莫比构建工具包工具链的容器，该工具链可以针对各种架构</li><li id="a861" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc mc kn ko kp bi translated">配置 docker 在创建图像时使用那个特殊的<em class="lk"> builder </em>实例。</li><li id="d323" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc mc kn ko kp bi translated">为目标体系结构生成 docker 映像。在我的例子中，我想把这些变化反馈给微软，所以我的目标是构建一个支持 AMD64 和 ARM64 的映像。</li><li id="15ca" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc mc kn ko kp bi translated">将图像发布到图像注册中心(理论上可以是<a class="ae kg" href="https://hub.docker.com" rel="noopener ugc nofollow" target="_blank"> DockerHub </a>、<a class="ae kg" href="https://aws.amazon.com/ecs/?trk=7dd0b498-f689-4b34-988c-60ef7607e90a&amp;sc_channel=ps&amp;sc_campaign=acquisition&amp;sc_medium=GC-PMM%7CPS-GO%7CBrand%7CAll%7CPA%7CDatabase%7CECS%7CSolution%7CUS%7CEN%7CText%7Cxx%7CSEM%7CPMO22-13405&amp;s_kwcid=AL!4422!3!547620651310!p!!g!!aws%20container%20service&amp;ef_id=CjwKCAjwh-CVBhB8EiwAjFEPGV0sseZ5-2Puv5dSBZ-e9VoQu7iTmko-wdLYGjqQ_77J5-ZhuWUvThoCQ2EQAvD_BwE:G:s&amp;s_kwcid=AL!4422!3!547620651310!p!!g!!aws%20container%20service" rel="noopener ugc nofollow" target="_blank"> AWS 弹性容器服务</a>或<a class="ae kg" href="https://azure.microsoft.com/en-us/services/container-registry/" rel="noopener ugc nofollow" target="_blank"> Azure 容器注册中心</a>)。</li><li id="720d" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc mc kn ko kp bi translated">生成捆绑了各种映像的多架构清单。</li><li id="9737" class="kh ki hi ih b ii kq im kr iq ks iu kt iy ku jc mc kn ko kp bi translated">将多体系结构清单发布到映像注册表。</li></ol><p id="bfe4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">清单是“多拱图像”,用户可以将其作为其他 Docker 图像的基础。我把它放在引号中是因为，对于所有的意图和目的，它看起来和感觉上像任何旧的 Docker 映像，然而，它实际上是一个清单列表，将架构映像变量捆绑到一个单一的实体中。</p><p id="bec7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Azurite 的<code class="du lz ma mb lp b">package.json</code>透露了<a class="ae kg" href="https://github.com/Azure/Azurite/blob/main/package.json#L256" rel="noopener ugc nofollow" target="_blank">微软用来构建他们的 AMD64 Docker 映像的命令</a>，所以我分叉克隆了这个回购，并从那里开始。接下来是我用来构建多架构映像的命令序列。</p><pre class="kw kx ky kz fd lo lp lq lr aw ls bi"><span id="838b" class="lt je hi lp b fi lu lv l lw lx"># create the multi-arch builder<br/>docker buildx create --name multi-platform-builder</span><span id="39e6" class="lt je hi lp b fi md lv l lw lx"># set multi-arch builder as image builder<br/>docker buildx use multi-platform-builder</span><span id="b3aa" class="lt je hi lp b fi md lv l lw lx"># generate arm64 image and output to local docker image list<br/>docker buildx build \<br/>  --platform linux/arm64 \<br/>  --load \<br/>  --no-cache \<br/>  --file Dockerfile \<br/>  --tag mcr.microsoft.com/azure-storage/azurite:3.18.0-arm64 \<br/>  .</span><span id="4be8" class="lt je hi lp b fi md lv l lw lx"># generate amd64 image and output to local docker image list<br/># you may notice this takes a lot longer than the arm64 build<br/>docker buildx build \<br/>  --platform linux/amd64 \<br/>  --load \<br/>  --no-cache \<br/>  --file Dockerfile \<br/>  --tag mcr.microsoft.com/azure-storage/azurite:3.18.0-amd64 \<br/>  .</span><span id="d626" class="lt je hi lp b fi md lv l lw lx"># push images to registry (assumes your docker is logged in)<br/>docker push mcr.microsoft.com/azure-storage/azurite:3.18.0-arm64<br/>docker push mcr.microsoft.com/azure-storage/azurite:3.18.0-amd64</span><span id="9e0b" class="lt je hi lp b fi md lv l lw lx"># create manifest with tag 3.18.0<br/>docker manifest create \<br/>  mcr.microsoft.com/azure-storage/azurite:3.18.0 \<br/>  mcr.microsoft.com/azure-storage/azurite:3.18.0-arm64 \<br/>  mcr.microsoft.com/azure-storage/azurite:3.18.0-amd64</span><span id="729f" class="lt je hi lp b fi md lv l lw lx"># create manifest with tag latest<br/>docker manifest create \<br/>  mcr.microsoft.com/azure-storage/azurite:latest \<br/>  mcr.microsoft.com/azure-storage/azurite:3.18.0-arm64 \<br/>  mcr.microsoft.com/azure-storage/azurite:3.18.0-amd64</span><span id="af64" class="lt je hi lp b fi md lv l lw lx"># push manifests to registry<br/>docker push mcr.microsoft.com/azure-storage/azurite:3.18.0<br/>docker push mcr.microsoft.com/azure-storage/azurite:latest</span></pre><p id="498e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下面您会看到两个 Docker 图像和指向这些图像的两个清单。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es me"><img src="../Images/29231edceb1ded5a4f0b9b5cdac08806.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zDCwYXGYkpfHlCLtgkd1mg.png"/></div></div></figure><p id="9d30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">瞧，ARM64 映像原生运行在苹果芯片上！</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mf"><img src="../Images/47a33f65f6d8660bbb92793840527c82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QHgZalZ1yMr_e90lw-LFtw.png"/></div></div></figure><h1 id="153b" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="f011" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">使用 Docker + <code class="du lz ma mb lp b">buildx</code>构建和发布多架构映像非常简单。由于大多数基本 linux 映像已经支持多种体系结构，因此将基于这些映像之一的项目升级到多体系结构清单中是相对简单的。</p><p id="98a8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我<a class="ae kg" href="https://github.com/Azure/Azurite/pull/1569" rel="noopener ugc nofollow" target="_blank">向微软</a>提交了一份 PR，所以希望其他人很快就能获得最新的 Azurite 图像，并在苹果芯片上运行，而无需额外的工作！</p><p id="8b6f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新(2022 年 9 月 11 日):微软接受了我的 PR，发布了支持 ARM 的新 docker 图片！从 3.19.0 开始提供<a class="ae kg" href="https://github.com/Azure/Azurite/releases/tag/v3.19.0" rel="noopener ugc nofollow" target="_blank"/></p><figure class="kw kx ky kz fd la er es paragraph-image"><div class="er es mg"><img src="../Images/6a3ef1450d8809fd0f27b07afd7c4636.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*OSfCAAOTiZDFQkHonhNfPA.png"/></div></figure></div></div>    
</body>
</html>