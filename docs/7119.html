<html>
<head>
<title>The Difference Between Validating and Mutating Webhooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">验证和变异 Webhooks 的区别</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/the-difference-between-validating-and-mutating-webhooks-167757f8db5f?source=collection_archive---------0-----------------------#2022-08-01">https://medium.com/nerd-for-tech/the-difference-between-validating-and-mutating-webhooks-167757f8db5f?source=collection_archive---------0-----------------------#2022-08-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/5d9348961d7c2b9c3984f9ea5caae9ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5vWw0jfWeRdGLLXn"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://miro.medium.com/max/1400/1*D0JykQxrL0IpYCZ6LH0CiA.png" rel="noopener">图像来源</a></figcaption></figure><p id="f69e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kubernetes 是 Google 开发的一个流行的容器编排工具。软件工程师使用它在 DevOps 管道中部署和扩展基于容器的应用程序。由于 Kubernetes 的流行，许多组织现在都采用它在云中部署应用程序。</p><p id="fae4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kubernetes <a class="ae iu" href="https://kuberty.io/blog/what-is-kubernetes-api-server/" rel="noopener ugc nofollow" target="_blank"> API 服务器</a>执行收到的请求以创建 Kubernetes 组件，如 pod、服务、部署、存储和持久卷，并将组件的状态存储在 etcd 中。您可以使用命令行将请求传递给 Kubernetes 服务器。然而，开发人员更喜欢 YAML 文件格式的数据，因为它易于使用，没有陡峭的学习曲线。</p><h1 id="321f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Kubernetes 服务器</h1><p id="7666" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">您可以轻松定制 Kubernetes 服务器的工作方式。Kubernetes 提供定制资源(CRD)和定制控制器来扩展/定制 Kubernetes 服务器的内置功能。如今，Kubernetes 提供了另一个有用的特性:webhook，用于<strong class="ix hj">修改(变异)</strong>传入的请求<strong class="ix hj">对象(数据)</strong>和<strong class="ix hj">批准或拒绝(验证)</strong>请求。为了验证和变更请求对象，您需要一个<a class="ae iu" href="https://www.armosec.io/blog/kubernetes-admission-controller/" rel="noopener ugc nofollow" target="_blank"> Kubernetes 准入控制器</a>。</p><p id="f00a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你不理解突变和确认，这将是非常困难的。所以，首先，你需要理解什么是验证。让我们看一个简单的用例。</p><p id="1ff3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，假设您正在创建一个名为“app-oracle”的 pod。您的组织可能有一些关于 pod 名称的规则。他们可能不想在<strong class="ix hj"> pod </strong>名称中使用数据库和通用语言名称。因此，如果 pod 创建请求的名称违反了您组织的策略，您必须拒绝该请求。这可以使用验证控制器来完成。</p><p id="b033" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">每当您请求创建包含不适当名称的 pod 时，如果您使用验证 webhook，则 pod 创建将会失败。这只是验证的一个例子。验证就像验证手机号码、电子邮件、信用卡号等。因此，您可以使用 validation webhook 创建定制的验证规则。</p><p id="a8e0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">变异意味着您可以根据自己的需要修改请求。比方说，您正在向 Kubernetes 服务器传递一个创建 pod 的请求，但是它缺少一些标签。这意味着你没有给一些标签一个值。就语法而言，这些标签不是强制性的。然而，假设您需要那些<a class="ae iu" href="https://www.educba.com/kubernetes-labels/" rel="noopener ugc nofollow" target="_blank">标签</a>。通过使用变异 webhook，您可以在验证之前在请求中添加缺失的标签。因此，验证不会拒绝请求。即使开发人员未能创建标签，变异 webhook 也会添加带有一些默认值的标签。</p><p id="9e3d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这种变异是这个过程中的第一个网络钩子。它将根据条件修改请求数据。然后，验证 webhook 将验证该请求，无论该请求是否包含有效数据。如果验证通过，那么验证 webhook 将允许执行代码，并将 Kubernetes 组件的状态存储在 etcd 中，并给出一个成功的响应。如果验证失败，它将发送一个错误响应。</p><h1 id="498f" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">准入控制器</h1><p id="e83c" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">在将对象存储在 etcd 中之前，但是在传入的请求被认证和授权之后，准入控制器拦截对 Kubernetes API 服务器的传入请求。变异和验证可以使用准入控制器来完成。Kubernetes API 服务器有两个准入控制器。他们分别是<strong class="ix hj">变异 adminmissionweb hook</strong>和<strong class="ix hj">验证 adminmissionweb hook</strong>。</p><p id="c9c0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下图解释了请求是如何传递给 Kubernetes API 服务器的。首先，对 API 请求进行身份验证和授权。然后，变异 webhook 根据条件修改请求数据。此后，验证 webhook 验证请求数据以批准或拒绝请求。如果验证成功，就会创建 Kubernetes 组件并存储在 etcd 中。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/09fa1e23dd7af9407455c74c4e5cb863.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7fiWZ9K46rPQEDyT"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://d33wubrfki0l68.cloudfront.net/af21ecd38ec67b3d81c1b762221b4ac777fcf02d/7c60e/images/blog/2019-03-21-a-guide-to-kubernetes-admission-controllers/admission-controller-phases.png" rel="noopener ugc nofollow" target="_blank">图像来源</a></figcaption></figure><p id="564c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Kubernetes 默认启用许多准入控制插件。使用以下命令查看启用的准入控制插件列表。</p><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="84d7" class="lg ju hi lc b fi lh li l lj lk">kube-apiserver -h | grep enable-admission-plugins</span></pre><p id="226b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">下面给出了上述命令的输出示例。</p><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="c1b2" class="lg ju hi lc b fi lh li l lj lk">CertificateApproval, CertificateSigning, CertificateSubjectRestriction, DefaultIngressClass, DefaultStorageClass, DefaultTolerationSeconds, LimitRanger, MutatingAdmissionWebhook, NamespaceLifecycle, PersistentVolumeClaimResize, PodSecurity, Priority, ResourceQuota, RuntimeClass, ServiceAccount, StorageObjectInUseProtection, TaintNodesByCondition, ValidatingAdmissionWebhook</span></pre><p id="34bf" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用<strong class="ix hj"> enable-admission-plugins </strong>命令启用所需的准入插件。</p><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="c52a" class="lg ju hi lc b fi lh li l lj lk">kube-apiserver — enable-admission-plugins=NamespaceLifecycle, LimitRanger …</span></pre><p id="48b0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要禁用许可插件，使用<strong class="ix hj">禁用许可插件</strong>命令。</p><pre class="kx ky kz la fd lb lc ld le aw lf bi"><span id="4fe7" class="lg ju hi lc b fi lh li l lj lk">kube-apiserver — disable-admission-plugins=PodNodeSelector, AlwaysDeny …</span></pre><h1 id="8765" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">验证和变异 Webhook</h1><p id="02a3" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">GitHub 包含一个简单的<a class="ae iu" href="https://github.com/slackhq/simple-kubernetes-webhook" rel="noopener ugc nofollow" target="_blank">验证和变异 webhook </a>。代码是用 GO 语言写的。</p><p id="ceb2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个项目还没有准备好投入生产。它演示了如何在 Kubernetes 中创建一个简单的轻量级 webhook。这个演示包含了验证和变异 webhooks。验证 webhook 将检查 pod 名称，看它是否包含不适当的名称。如果 pod 不满足此验证，pod 创建将失败，变异 webhook 将注入一些需要的标签，如 KUBE:真实和最短 pod 寿命。</p><h1 id="1297" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">摘要</h1><p id="2d55" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">软件行业开发了许多工具来减轻开发人员和运营团队的工作。Kubernetes 就是这样一个工具。有了它，可以轻松创建可伸缩的基于容器的应用程序。这对于部署团队和 DevOps 工程师来说是一大福音，提供了各种方法来覆盖其内置功能。Webhook 是一种修改 Kubernetes 内置功能的有用方法。</p><p id="bbc0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">可以使用准入控制器创建 Webhooks。准入控制器具有变异和验证 webhooks。变异 webhook 在验证 webhook 之前执行。变异 webhook 将根据条件修改请求数据。验证 webhook 将批准或拒绝该请求。如果您需要请求中不存在的数据，变异会添加数据以避免被验证 webhook 拒绝。</p></div></div>    
</body>
</html>