<html>
<head>
<title>How to prepare a Python date object to be stored in MongoDB and run queries by dates and range of dates.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何准备存储在 MongoDB 中的 Python 日期对象，并按日期和日期范围运行查询。</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-prepare-a-python-date-object-to-be-inserted-into-mongodb-and-run-queries-by-dates-and-range-bc0da03ea0b2?source=collection_archive---------1-----------------------#2021-03-06">https://medium.com/nerd-for-tech/how-to-prepare-a-python-date-object-to-be-inserted-into-mongodb-and-run-queries-by-dates-and-range-bc0da03ea0b2?source=collection_archive---------1-----------------------#2021-03-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="61f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我如何设法在 MongoDB 中插入日期并在日期之间运行查询。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/4b01202cb872114450671692b4926435.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hWMkaW6At_LZ_2nm3Z3yXA.jpeg"/></div></div></figure></div><div class="ab cl jp jq gp jr" role="separator"><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju jv"/><span class="js bw bk jt ju"/></div><div class="hb hc hd he hf"><h1 id="d216" class="jw jx hi bd jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt bi translated">介绍</h1><p id="531d" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">我认为计算机科学中最乏味的事情之一是处理日期和时区。如果计算机科学只是按天排序记录或在数据库中查询几天之间创建的记录，我会认为自己已经出局了。我了解到时间戳的存储方式很重要，它可以让你运行正确的查询，或者给你一天的时间。我的案子很简单，但我花了几个小时才理清。我们有一个 MongoDB 集合，时间戳存储为一个字符串。(第一大错误)。此外，每个记录的结构是嵌套的 JSON(第二个错误),这在查询文档时不是最好的。易于可视化，但不易于查询。<br/>所以，假设我们必须存储用户做出的动作，对于每个动作，我们希望存储一个时间戳。<br/>初始数据格式如下</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="9e14" class="le jx hi la b fi lf lg l lh li">{<br/>  "user_email": "<a class="ae lj" href="mailto:jakebrown@test.com" rel="noopener ugc nofollow" target="_blank">jakebrown@test.com</a>",<br/>  "delivery": {<br/>    "box1": {<br/>      "97cc5e852cf44fc38fdb55dc006d1d01": {<br/>        "owner_name": "Peter Parker",<br/>        "owner_email": "<a class="ae lj" href="mailto:peter.parker@spiderman.com" rel="noopener ugc nofollow" target="_blank">peter.parker@spiderman.com</a>",<br/>        "registration_date": "2021-03-01T18:12:07+00:00"<br/>      }<br/>    },<br/>    "box2": {<br/>      "a7bd1e34f809410590679cd2c1172cd3": {<br/>        "owner_name": "Dylan Dog",<br/>        "owner_email": "<a class="ae lj" href="mailto:dylan.dog@test.com" rel="noopener ugc nofollow" target="_blank">dylan.dog@test.com</a>",<br/>        "registration_date": "2021-03-02T12:12:01+00:00"<br/>      },<br/>      "box3": {<br/>        "b787fdeb892d406196fda2ca9a15074b": {<br/>          "owner_name": "Nathan Never",<br/>          "owner_email": "<a class="ae lj" href="mailto:nathan.never@alpha.com" rel="noopener ugc nofollow" target="_blank">nathan.never@alpha.com</a>",<br/>          "registration_date": "2020-12-02T18:12:07+00:00"<br/>        }<br/>      },<br/>      "box4": {<br/>        "1f8741da011640988359fec4d47225f3": {<br/>          "owner_name": "Jerry Drake",<br/>          "owner_email": "<a class="ae lj" href="mailto:jerry.drake@misterno.com" rel="noopener ugc nofollow" target="_blank">jerry.drake@misterno.com</a>",<br/>          "registration_date": "2021-02-02T14:07:07+00:00"<br/>        }<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="ccb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上述结构有两个问题。第一个是<em class="lk">注册日期</em>值被存储为字符串。它不允许我按日期范围查询结果。以字符串格式存储的日期很好显示，并且假设日期与标准格式匹配，相对容易转换回一个<em class="lk"> datetime </em>对象，但是我不能运行类似</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="3b9c" class="le jx hi la b fi lf lg l lh li">{“registration_date”: {“$gte”: ‘2021–03–03T18:12:07+00:00’, “$lte”: ‘2021–03–02T18:12:07+00:00’}}</span></pre><p id="f843" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">第二个问题是通过 ID(例如，1f 8741 da 011640988359 FEC 4d 47225 f 3)进行查询非常棘手，ID 是每个嵌套字典的键。在这方面，这篇<a class="ae lj" href="https://www.mongodb.com/blog/post/building-with-patterns-the-attribute-pattern" rel="noopener ugc nofollow" target="_blank">文章</a>非常详细，帮助我理解了我在最初的数据设计中所犯的错误。</p><h1 id="a50e" class="jw jx hi bd jy jz ll kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp lp kr ks kt bi translated">按照 MongoDB 的方式重构数据</h1><p id="f7c9" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">在浏览了 MongoDB 的文档之后，我意识到存储时间戳的正确方式是 JavaScript 日期类型。句号。</p><p id="3c2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正如官方<a class="ae lj" href="https://docs.mongodb.com/manual/reference/method/Date/#Date" rel="noopener ugc nofollow" target="_blank">文档</a>所报道的，</p><blockquote class="lq lr ls"><p id="5f6e" class="if ig lk ih b ii ij ik il im in io ip lt ir is it lu iv iw ix lv iz ja jb jc hb bi translated">MongoDB 没有特殊的 datetime 对象，它使用 JavaScript 日期类型，以<a class="ae lj" href="https://docs.mongodb.com/manual/reference/bson-types/#document-bson-type-date" rel="noopener ugc nofollow" target="_blank"> BSON </a>的形式存储。在内部，<a class="ae lj" href="https://docs.mongodb.com/manual/reference/bson-types/#document-bson-type-date" rel="noopener ugc nofollow" target="_blank"> Date </a>对象被存储为一个有符号的 64 位整数，表示自 Unix 纪元(1970 年 1 月 1 日)以来的毫秒数。<a class="ae lj" href="http://bsonspec.org/#/specification" rel="noopener ugc nofollow" target="_blank">官方 BSON 规范</a>将 BSON 日期类型称为<em class="hi"> UTC 日期时间</em>。BSON 日期类型是有符号的。负值表示 1970 年之前的日期。</p><p id="7e0d" class="if ig lk ih b ii ij ik il im in io ip lt ir is it lu iv iw ix lv iz ja jb jc hb bi translated">Date()在 mongo shell 中以字符串形式返回当前日期。</p><p id="6560" class="if ig lk ih b ii ij ik il im in io ip lt ir is it lu iv iw ix lv iz ja jb jc hb bi translated">new Date()将当前日期作为<a class="ae lj" href="https://docs.mongodb.com/manual/reference/bson-types/#document-bson-type-date" rel="noopener ugc nofollow" target="_blank">日期</a>对象返回。mongo shell 用 ISODate 助手包装了<a class="ae lj" href="https://docs.mongodb.com/manual/reference/bson-types/#document-bson-type-date" rel="noopener ugc nofollow" target="_blank"> Date </a>对象。ISODate 在<a class="ae lj" href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time?oldid=803266145" rel="noopener ugc nofollow" target="_blank"> UTC </a>中。</p></blockquote><p id="66eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">MongoDB 使用函数 ISODate()自动包装日期。ISODate()是一个内置函数，它包装了本机 JavaScript Date 对象，提供了一种以人类可读格式表示日期的便捷方式，保留了日期查询和索引的全部用途。</p><p id="1d2d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，MongoDB 为日期提供了默认的 ISO 表示。如果您需要不同于 ISO 的格式，您需要在客户端进行转换。</p><p id="0a5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完美。因此，我首先决定将<em class="lk"> registration_date </em>键的类型修改为 datetime，这只是为了意识到，对于我的原始数据结构，不可能只获得与我的查询标准相匹配的记录。这是一个嵌套结构，所以所有的结构都被返回。然后我决定修改结构，让它更简单。存储更多的记录，但更容易查询。</p><p id="9c4a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了将<em class="lk"> registration_date 作为</em>一个 Python datetime <em class="lk"> </em>插入，我使用了函数<em class="lk"> </em> <code class="du lw lx ly la b"><a class="ae lj" href="https://docs.python.org/3/library/datetime.html#datetime.datetime.today" rel="noopener ugc nofollow" target="_blank"><em class="lk">datetime.today()</em></a></code></p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="26fd" class="le jx hi la b fi lf lg l lh li">payload_to_insert = {  <br/>    "user_email": "<a class="ae lj" href="mailto:jakebrown@test.com" rel="noopener ugc nofollow" target="_blank">jakebrown@test.com</a>",<br/>    "owner_name": "Peter Parker"<br/>    "owner_email": "<a class="ae lj" href="mailto:peter.parker@spiderman.com" rel="noopener ugc nofollow" target="_blank">peter.parker@spiderman.com</a>",<br/>    "box_id" : "a7bd1e34f809410590679cd2c1172cd3",<br/>    "registration_date": datetime.today().replace(microsecond=0)<br/>         <br/>}</span></pre><p id="cb7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lk"> registration_date </em>现在是一个 datetime 对象，它被 MongoDB 存储为 JavaScript 日期类型，然后它与 MongoDB 运行日期查询所需的内容兼容。</p><p id="5de8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">此外，曾经是键的 ID 现在是一个属性值。我修改了数据结构，使其易于查询。</p><p id="184f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了进行双重检查，我们可以从 MongoDB shell 中运行一个查询来查看 registration_date 的格式是 date()。</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="eeb0" class="le jx hi la b fi lf lg l lh li">db.test.find()<br/>{ "_id" : ObjectId("..."), "registration_date" : new Date("2021-03-02T14:51:15+0000") }</span></pre><p id="6d3c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们用 Python 和<a class="ae lj" href="https://docs.python.org/3/library/datetime.html" rel="noopener ugc nofollow" target="_blank"> datetime </a>函数来运行一些查询。</p><h1 id="bc7b" class="jw jx hi bd jy jz ll kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp lp kr ks kt bi translated">按日期范围查询</h1><p id="f0b0" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">可能是有史以来最常见的查询之一，“<em class="lk">给我日历上两天内的所有结果</em>”。这就是像 https://material.angular.io/components/datepicker/examples<a class="ae lj" href="https://material.angular.io/components/datepicker/examples" rel="noopener ugc nofollow" target="_blank">这样的组件存在的原因。</a></p><p id="bd14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们已经吸取了教训，我们知道我们需要日期时间对象。因此，让我们先将字符串转换为日期时间，然后创建我们的查询。</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="664d" class="le jx hi la b fi lf lg l lh li">from datetime import datetime, timedelta</span><span id="c218" class="le jx hi la b fi lz lg l lh li">from_date = datetime.strptime(from_date, '%Y-%m-%d')<br/>to_date = datetime.strptime(to_date, '%Y-%m-%d')</span><span id="8da5" class="le jx hi la b fi lz lg l lh li">criteria = {"$and": [{"registration_date": {"$gte": from_date, "$lte": to_date}}, {"owner_email": "<a class="ae lj" href="mailto:peter.parker@spiderman.com" rel="noopener ugc nofollow" target="_blank">peter.parker@spiderman.com</a>"}]}</span></pre><p id="1f37" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们可以在 find()中使用<em class="lk">标准</em></p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="7a0f" class="le jx hi la b fi lf lg l lh li">import json<br/>from pymongo import MongoClient<br/>from bson.json_util import dumps<br/>from datetime import datetime, timezone<br/>from datetime import timedelta<br/><br/><br/>def query_by_range_of_dates(mongo_url, db_name, collection_name, owner_email, from_date,<br/>                            to_date):<br/>    client = MongoClient(mongo_url)<br/>    db_instance = client[db_name]<br/><br/>    from_date = datetime.strptime(from_date, '%Y-%m-%d')<br/>    to_date = datetime.strptime(to_date, '%Y-%m-%d')<br/><br/>    criteria = {"$and": [{"registration_date": {"$gte": from_date, "$lte": to_date}}, {"owner_email": owner_email}]}<br/><br/>    return json.loads(dumps(db_instance[collection_name].find(criteria)))</span></pre><h1 id="feeb" class="jw jx hi bd jy jz ll kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp lp kr ks kt bi translated">按特定日期查询</h1><p id="4172" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">如果我希望在某一天完成所有操作，该怎么办？对于给定日期的查询，我们需要使用当天 00:00 到 23:59:59 的范围。</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="25a2" class="le jx hi la b fi lf lg l lh li">from datetime import datetime, timedelta</span><span id="a51f" class="le jx hi la b fi lz lg l lh li">from_date_str = day_to_query + "T00:00:00+00:00"<br/>to_date_str = day_to_query + "T23:59:59+00:00"<br/>from_date = datetime.strptime(from_date_str, '%Y-%m-%dT%H:%M:%S%z')<br/>to_date = datetime.strptime(to_date_str, '%Y-%m-%dT%H:%M:%S%z')<br/>criteria = {"$and": [{"registration_date": {"$gte": from_date, "$lte": to_date}}, {"owner_email": "<a class="ae lj" href="mailto:peter.parker@spiderman.com" rel="noopener ugc nofollow" target="_blank">peter.parker@spiderman.com</a>"}]}</span></pre><p id="4b1c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注意:我需要指定 UTC 时区，因为默认情况下，MongoDB 将 Date()对象存储为 ISOFormat()。</p><h1 id="fd3b" class="jw jx hi bd jy jz ll kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp lp kr ks kt bi translated">使用时间增量进行查询</h1><p id="9c48" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">查询日期的另一个有用的方法是从给定的天数开始回溯。</p><pre class="je jf jg jh fd kz la lb lc aw ld bi"><span id="b479" class="le jx hi la b fi lf lg l lh li">from datetime import datetime, timedelta</span><span id="83c7" class="le jx hi la b fi lz lg l lh li">today = datetime.today()<br/>days_back = today - timedelta(days=30)<br/>criteria = {"$and": [{"registration_date": {"$gte": days_back}}, {"owner_email": <a class="ae lj" href="mailto:peter.parker@spiderman.com" rel="noopener ugc nofollow" target="_blank">peter.parker@spiderman.com</a>}]}</span></pre><h1 id="6929" class="jw jx hi bd jy jz ll kb kc kd lm kf kg kh ln kj kk kl lo kn ko kp lp kr ks kt bi translated">总结一下</h1><p id="9103" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq kw is it iu kx iw ix iy ky ja jb jc hb bi translated">在存储和查询日期时，MongoDB 日期可能会导致一些挫折。此外，当我们需要查询嵌套数据结构时，它并不是我们最好的朋友。我明白了简单并不总是容易的。将日期存储为字符串既简单又易于可视化。但是，查询起来并不容易。</p><p id="5ee7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是对我有帮助的资源列表</p><ul class=""><li id="edad" class="ma mb hi ih b ii ij im in iq mc iu md iy me jc mf mg mh mi bi translated"><a class="ae lj" href="https://docs.mongodb.com/manual/reference/operator/aggregation/dateFromString/" rel="noopener ugc nofollow" target="_blank">https://docs . MongoDB . com/manual/reference/operator/aggregation/dateFromString/</a></li><li id="e454" class="ma mb hi ih b ii mj im mk iq ml iu mm iy mn jc mf mg mh mi bi translated"><a class="ae lj" href="https://www.tutorialspoint.com/how-to-search-date-between-two-dates-in-mongodb" rel="noopener ugc nofollow" target="_blank">https://www . tutorialspoint . com/how-to-search-date-between-two-dates-in-MongoDB</a></li><li id="63d4" class="ma mb hi ih b ii mj im mk iq ml iu mm iy mn jc mf mg mh mi bi translated"><a class="ae lj" href="https://www.bogotobogo.com/python/MongoDB_PyMongo/python_MongoDB_pyMongo_tutorial_Range_Queries_Counting_Indexing.php" rel="noopener ugc nofollow" target="_blank">https://www . bogotobogo . com/python/MongoDB _ py mongo/python _ MongoDB _ py mongo _ tutorial _ Range _ Queries _ Counting _ indexing . PHP</a></li><li id="b3ad" class="ma mb hi ih b ii mj im mk iq ml iu mm iy mn jc mf mg mh mi bi translated"><a class="ae lj" href="https://www.mongodb.com/blog/post/building-with-patterns-the-attribute-pattern" rel="noopener ugc nofollow" target="_blank">https://www . MongoDB . com/blog/post/building-with-patterns-the-attribute-pattern</a></li><li id="f4bc" class="ma mb hi ih b ii mj im mk iq ml iu mm iy mn jc mf mg mh mi bi translated"><a class="ae lj" href="https://developer.mongodb.com/community/forums/t/query-nested-objects-in-a-document-with-unknown-key/14511" rel="noopener ugc nofollow" target="_blank">https://developer . MongoDB . com/community/forums/t/query-nested-objects-in-a-document-with-unknown-key/14511</a></li><li id="c174" class="ma mb hi ih b ii mj im mk iq ml iu mm iy mn jc mf mg mh mi bi translated"><a class="ae lj" href="https://julien.danjou.info/python-and-timezones/" rel="noopener ugc nofollow" target="_blank">https://julien.danjou.info/python-and-timezones/</a></li><li id="fdb1" class="ma mb hi ih b ii mj im mk iq ml iu mm iy mn jc mf mg mh mi bi translated"><a class="ae lj" href="https://stackoverflow.com/questions/47390554/pymongo-date-rangesame-date-with-different-time-query-returns-no-results" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/47390554/py mongo-date-range same-date-with-different-time-query-returns-no-results</a></li><li id="8b53" class="ma mb hi ih b ii mj im mk iq ml iu mm iy mn jc mf mg mh mi bi translated"><a class="ae lj" href="https://www.tutorialspoint.com/How-to-prepare-a-Python-date-object-to-be-inserted-into-MongoDB" rel="noopener ugc nofollow" target="_blank">https://www . tutorialspoint . com/How-to-prepare-a-Python-date-object-to-be-inserted-MongoDB</a></li></ul><h2 id="b152" class="le jx hi bd jy mo mp mq kc mr ms mt kg iq mu mv kk iu mw mx ko iy my mz ks na bi translated">系统快照</h2><ul class=""><li id="fccf" class="ma mb hi ih b ii ku im kv iq nb iu nc iy nd jc mf mg mh mi bi translated">Python 3.7</li><li id="7a67" class="ma mb hi ih b ii mj im mk iq ml iu mm iy mn jc mf mg mh mi bi translated">MongoDB 4.4.1</li><li id="2e78" class="ma mb hi ih b ii mj im mk iq ml iu mm iy mn jc mf mg mh mi bi translated">pymongo  3.11.3</li></ul></div></div>    
</body>
</html>