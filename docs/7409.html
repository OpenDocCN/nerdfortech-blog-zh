<html>
<head>
<title>AWS Lambda Typescript(Charity Web App) — Student service connected to DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lambda Typescript(慈善网站应用程序)—连接到 DynamoDB 的学生服务</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/aws-lambda-typescript-charity-web-app-student-service-connected-to-dynamodb-814405a95f3f?source=collection_archive---------3-----------------------#2022-10-22">https://medium.com/nerd-for-tech/aws-lambda-typescript-charity-web-app-student-service-connected-to-dynamodb-814405a95f3f?source=collection_archive---------3-----------------------#2022-10-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="86c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嘿伙计们！！！在上一个教程中，我们处理了学生服务的基本 CRUD 操作。我们写了一些返回硬编码值的伪方法。在本教程中，我们将更进一步，将我们的服务连接到一个 DynamoDB。链接到我们到目前为止所做的事情。</p><div class="jd je ez fb jf"><div role="button" tabindex="0" class="ab bv ff cb dy jg jh bn ji jj jk"><div class="jl l"><div class="ab q"><div class="l di"><img alt="Dimuthu Wickramanayake" class="l de bw jm jn du" src="../Images/099c92eba7c0ef5b0373ba4d36052ba2.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*LsIMaDB2-AJKz28n02h_IQ.jpeg"/><div class="dr bw l jm jn ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated">迪穆图·维克拉马那亚克</p></div></div><div class="jq jr fg l"><h2 class="bd hj qv qw dy qx ea eb lf ed ef hh bi translated">AWS Lambda(慈善网络应用)系列</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi qy au qz ra rb nm rc an fx fy rd re rf gb gc gd de bk ge" href="https://billa-code.medium.com/list/aws-lambda-charity-webapp-series-cd878238f932?source=post_page-----814405a95f3f--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="rg l dw"><span class="bd b fp z dx">5 stories</span></div></div></div><div class="kd dh ke dy ab kf dw di"><div class="di jv bv jw jx"><div class="dh l"><img alt="" class="dh" src="../Images/5e5d417a4f8e977dff5a6564ccf48d39.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*ZMefBLP2MRSPDwmix-Z0Mw.png"/></div></div><div class="di jv bv jy jz ka"><div class="dh l"><img alt="" class="dh" src="../Images/75f2267185bffd78647008c578e838b9.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*myAvjQPuBRWl1INX8ZjhAg.png"/></div></div><div class="di bv kb kc ka"><div class="dh l"><img alt="" class="dh" src="../Images/fa6bf2ff659d1783bd38eee735f02f2d.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*Mu1FtEnLQw7sXtrpNJmSHQ.png"/></div></div></div></div></div><p id="b10a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">DynamoDB 是一种 nosql 类型的数据库。因为我们的用例非常小，所以我要用这个。在进行任何逻辑更改之前，我们必须在 template.yaml 文件中包含我们的新基础结构。所以还是更新一下吧。</p><pre class="kk kl km kn fd ko kp kq kr aw kj bi"><span id="e2c5" class="ks kt hi kp b fi ku kv l kw kx">AWSTemplateFormatVersion: '2010-09-09'<br/>Transform: AWS::Serverless-2016-10-31<br/>Description: serendib-scholarship-ws<br/>Globals:<br/>  Function:<br/>    Timeout: 3<br/><br/>Resources:<br/>  StudentFunction:<br/>    Type: AWS::Serverless::Function<br/>    Properties:<br/>      CodeUri: student/<br/>      Handler: app.lambdaHandler<br/>      Runtime: nodejs16.x<br/>      Architectures:<br/>        - x86_64<br/>      <strong class="kp hj">Policies:<br/>        - DynamoDBCrudPolicy:<br/>            TableName: !Ref SampleTable<br/>      Environment:<br/>        Variables:<br/>          SAMPLE_TABLE: !Ref SampleTable</strong><br/>      Events:<br/>        Student:<br/>          Type: Api<br/>          Properties:<br/>            Path: /student<br/>            Method: get<br/>    Metadata:<br/>      BuildMethod: esbuild<br/>      BuildProperties:<br/>        Minify: true<br/>        Target: "es2020"<br/>        EntryPoints: <br/>        - app.ts<br/><br/>  <strong class="kp hj">SampleTable:<br/>    Type: AWS::Serverless::SimpleTable<br/>    Properties:<br/>      PrimaryKey:<br/>        Name: id<br/>        Type: String<br/>      ProvisionedThroughput:<br/>        ReadCapacityUnits: 2<br/>        WriteCapacityUnits: 2</strong><br/><br/><strong class="kp hj">Outputs:<br/>  WebEndpoint:<br/>    Description: "API Gateway endpoint URL for Prod stage"<br/>    Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"</strong></span></pre><p id="ab43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我已经删除了许多多余的代码。因此，如果你看到一个大的变化，从以前的文件，不要担心。现在，正如你所看到的，我已经创建了一个动态表，现在让我们在处理程序中实现更改。首先，您必须更新 package.json 文件以包含一些依赖项。</p><pre class="kk kl km kn fd ko kp kq kr aw kj bi"><span id="682d" class="ks kt hi kp b fi ku kv l kw kx">{<br/>  "name": "student",<br/>  "version": "1.0.0",<br/>  "description": "Student service for serendib scholarship ws",<br/>  "main": "app.js",<br/>  "repository": "https://github.com/deBilla/serendib-scholarship-ws/student",<br/>  "author": "SAM CLI",<br/>  "license": "MIT",<br/>  "dependencies": {<br/>    <strong class="kp hj">"@aws-sdk/client-dynamodb": "3.194.0",<br/>    "@aws-sdk/util-dynamodb": "3.194.0",<br/>    "@aws-sdk/lib-dynamodb": "3.194.0",</strong><br/>    "esbuild": "^0.14.14"<br/>  },<br/>  "scripts": {<br/>    "unit": "jest",<br/>    "lint": "eslint '*.ts' --quiet --fix",<br/>    "compile": "tsc",<br/>    "test": "npm run compile &amp;&amp; npm run unit"<br/>  },<br/>  "devDependencies": {<br/>    "@types/aws-lambda": "^8.10.92",<br/>    "@types/jest": "^27.4.0",<br/>    "@types/node": "^17.0.13",<br/>    "@typescript-eslint/eslint-plugin": "^5.10.2",<br/>    "@typescript-eslint/parser": "^5.10.2",<br/>    "esbuild-jest": "^0.5.0",<br/>    "eslint": "^8.8.0",<br/>    "eslint-config-prettier": "^8.3.0",<br/>    "eslint-plugin-prettier": "^4.0.0",<br/>    "jest": "^27.5.0",<br/>    "prettier": "^2.5.1",<br/>    "ts-node": "^10.4.0",<br/>    "typescript": "^4.5.5"<br/>  }<br/>}</span></pre><p id="0233" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记住把它们放在 dependencies 部分，而不是 devDependencies 部分(我得到了一个错误)。现在，在处理程序文件中，我们要做的第一件事是初始化 DynamoDB 的 DB 客户端。之后，对于每个 CRUD 操作，我们可以实现代码。</p><pre class="kk kl km kn fd ko kp kq kr aw kj bi"><span id="fede" class="ks kt hi kp b fi ku kv l kw kx">import { APIGatewayProxyEvent, APIGatewayProxyResult } from 'aws-lambda';<br/><strong class="kp hj">import { DynamoDBClient,  ScanCommand, PutItemCommand, GetItemCommand, DeleteItemCommand, UpdateItemCommand } from "@aws-sdk/client-dynamodb";<br/>import { marshall, unmarshall } from "@aws-sdk/util-dynamodb";</strong><br/><strong class="kp hj">import { v4 as uuidv4 } from 'uuid';</strong><br/><br/><strong class="kp hj">const tableName = process.env.SAMPLE_TABLE;<br/>const client = new DynamoDBClient({ region: "us-east-1" });</strong><br/><br/>export const lambdaHandler = async (event: APIGatewayProxyEvent): Promise&lt;APIGatewayProxyResult&gt; =&gt; {<br/>    let results: any;<br/>    let response: APIGatewayProxyResult;<br/><br/>    try {<br/>        switch (event.httpMethod) {<br/>            case 'GET':<br/>                if (event.pathParameters.id != <em class="ky">null</em>) {<br/>                    results = await getStudent(event.pathParameters.id);<br/>                } else {<br/>                    results = await getStudents();<br/>                }<br/>                <br/>                break;<br/>            case 'POST':<br/>                results = await createStudents(event);<br/>                break;<br/>            case 'PUT':<br/>                results = await updateStudents(event)<br/>                break;<br/>            case 'DELETE':<br/>                results = await deleteStudents(event.pathParameters.id)<br/>                break;<br/>            default:<br/>                throw new Error('Unidentified event!!!');<br/>        }<br/>        <br/>        response = {<br/>            statusCode: <em class="ky">200</em>,<br/>            body: JSON.stringify({<br/>                message: results,<br/>            }),<br/>        };<br/>    } catch (err: unknown) {<br/>        console.log(err);<br/>        response = {<br/>            statusCode: <em class="ky">500</em>,<br/>            body: JSON.stringify({<br/>                message: err instanceof Error ? err.message : 'some error happened',<br/>            }),<br/>        };<br/>    }<br/><br/>    return response;<br/>};<br/><br/>const getStudents = async () =&gt; {<br/>    <strong class="kp hj">try {<br/>        const params = {<br/>            TableName : tableName<br/>        };<br/>        const { Items } = await client.send(new ScanCommand(params));<br/><br/>        return Items;<br/>    } catch (e) {<br/>        throw e;<br/>    }</strong><br/>}<br/><br/>const getStudent = async (studentId: string) =&gt; {<br/>    <strong class="kp hj">try {<br/>        const params = {<br/>            TableName: tableName,<br/>            Key: marshall({ id: studentId })<br/>        };<br/><br/>        const { Item } = await client.send(new GetItemCommand(params));<br/><br/>        return (Item) ? unmarshall(Item) : {};<br/>    } catch(e) {<br/>        throw e;<br/>    }</strong><br/>}<br/><br/>const createStudents = async (event: APIGatewayProxyEvent) =&gt; {<br/>    <strong class="kp hj">try {<br/>        const student = JSON.parse(event.body);<br/>        const studentId = uuidv4();<br/>        student.id = studentId;<br/><br/>        const params = {<br/>            TableName: tableName,<br/>            Item: marshall(student || {})<br/>        };<br/><br/>        return await client.send(new PutItemCommand(params));<br/>    } catch(e) {<br/>        throw e;<br/>    }</strong><br/>}<br/><br/>const updateStudents = async (event: APIGatewayProxyEvent) =&gt; {<br/>    <strong class="kp hj">try {<br/>        const requestBody = JSON.parse(event.body);<br/>        const objKeys = Object.keys(requestBody);   <br/>    <br/>        const params = {<br/>          TableName: tableName,<br/>          Key: marshall({ id: event.pathParameters.id }),<br/>          UpdateExpression: `SET ${objKeys.map((_, index) =&gt; `#key${index} = :value${index}`).join(", ")}`,<br/>          ExpressionAttributeNames: objKeys.reduce((acc, key, index) =&gt; ({<br/>              ...acc,<br/>              [`#key${index}`]: key,<br/>          }), {}),<br/>          ExpressionAttributeValues: marshall(objKeys.reduce((acc, key, index) =&gt; ({<br/>              ...acc,<br/>              [`:value${index}`]: requestBody[key],<br/>          }), {})),<br/>        };<br/>    <br/>        return await client.send(new UpdateItemCommand(params));<br/>    } catch(e) {<br/>        console.error(e);<br/>        throw e;<br/>    }</strong><br/>}<br/><br/>const deleteStudents = async (studentId: string) =&gt; {<br/>    <strong class="kp hj">try {<br/>        const params = {<br/>          TableName: tableName,<br/>          Key: marshall({ id: studentId }),<br/>        };<br/>    <br/>        return await client.send(new DeleteItemCommand(params));<br/>    } catch(e) {<br/>        throw e;<br/>    }</strong><br/>}</span></pre><p id="d651" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您仔细查看 app.ts 文件，可以看到我们在环境变量中保留了表名。因此，当进行本地 Lambda 调用时，这需要被检索。为此我创建了另一个名为 env.json 的 json 文件。</p><pre class="kk kl km kn fd ko kp kq kr aw kj bi"><span id="5893" class="ks kt hi kp b fi ku kv l kw kx">{<br/>    "StudentFunction": {<br/>        "SAMPLE_TABLE": "serendib-student"<br/>    }<br/>}</span></pre><p id="c61e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这之后，如果我们还没有将 Lambda 函数部署到云上，我们可以做的只是进入 AWS 帐户，创建一个名为<strong class="ih hj"> serendib-student </strong>的 DynamoDB 表。</p><p id="ffdf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在继续之前，为了让您的本地终端访问 AWS 帐户，您应该提供相关的安全令牌。创建这些令牌的方法可以在我以前的一篇文章中找到。为了方便起见，我用粗体字标出了访问键描述的字母。</p><div class="jd je ez fb jf kz"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/aws-certified-solution-architect-iam-8930ce442515"><div class="la ab dw"><div class="lb ab lc cl cj ld"><h2 class="bd hj fi z dy le ea eb lf ed ef hh bi translated">AWS 认证解决方案架构师— IAM</h2><div class="lg l"><h3 class="bd b fi z dy le ea eb lf ed ef dx translated">IAM 的意思是身份和访问管理服务。当我们在之前的教程中创建 AWS 帐户时，我们…</h3></div><div class="lh l"><p class="bd b fp z dy le ea eb lf ed ef dx translated">medium.com</p></div></div><div class="li l"><div class="lj l lk ll lm li ln jj kz"/></div></div></a></div><p id="e4a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置访问密钥并下载文件后，使用以下命令将其导出到环境中。</p><pre class="kk kl km kn fd ko kp kq kr aw kj bi"><span id="dc44" class="ks kt hi kp b fi ku kv l kw kx">export AWS_ACCESS_KEY_ID=&lt;YOUR_KEY&gt;<br/>export AWS_SECRET_ACCESS_KEY=&lt;YOUR_SECRET&gt;<br/>export AWS_DEFAULT_REGION=us-east-1</span></pre><p id="11d6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">之后我们像这样调用 Lambda 函数。</p><pre class="kk kl km kn fd ko kp kq kr aw kj bi"><span id="7774" class="ks kt hi kp b fi ku kv l kw kx">sam local invoke StudentFunction --event events/student_post.json --env-vars env.json</span></pre><p id="3623" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以看到我在命令中包含了 env.json。对于每个 CRUD 操作，我都更新了事件。这些可以从这个链接中查看。</p><div class="jd je ez fb jf kz"><a href="https://github.com/deBilla/serendib-scholarship-ws/tree/main/events" rel="noopener  ugc nofollow" target="_blank"><div class="la ab dw"><div class="lb ab lc cl cj ld"><h2 class="bd hj fi z dy le ea eb lf ed ef hh bi translated">seren DIB-奖学金-ws/main deBilla/seren DIB 的活动-奖学金-ws</h2><div class="lg l"><h3 class="bd b fi z dy le ea eb lf ed ef dx translated">奖学金。在 GitHub 上创建一个帐户，为 deBilla/seren DIB-scholarship-ws 开发做贡献。</h3></div><div class="lh l"><p class="bd b fp z dy le ea eb lf ed ef dx translated">github.com</p></div></div><div class="li l"><div class="lo l lk ll lm li ln jj kz"/></div></div></a></div><p id="2071" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以尝试调用不同的事件，在事件文件中，请将 id 更新为您自己的数据库中创建的 id 之一。所以这几乎是所有与此相关的东西。现在剩下的是为我们的应用程序实现文件上传。我将在另一个教程中讨论它。<a class="ae lp" href="https://github.com/deBilla/serendib-scholarship-ws" rel="noopener ugc nofollow" target="_blank">该应用的 Github 链接可以在这里找到</a>。直到那时快乐编码！！！:p</p></div></div>    
</body>
</html>