<html>
<head>
<title>Android Architecture Components Tutorial</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android架构组件教程</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/android-architecture-components-tutorial-7e822cdf2f00?source=collection_archive---------8-----------------------#2021-04-12">https://medium.com/nerd-for-tech/android-architecture-components-tutorial-7e822cdf2f00?source=collection_archive---------8-----------------------#2021-04-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="f1c9" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">Android架构组件是一个库集合，可以帮助你设计健壮的、可测试的、可维护的应用。从管理UI组件生命周期和处理数据持久性的类开始。(<a class="ae jh" href="https://developer.android.com/topic/libraries/architecture" rel="noopener ugc nofollow" target="_blank">https://developer.android.com/topic/libraries/architecture</a>)</p></blockquote><p id="26ae" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">本教程将涵盖Android架构组件中的<code class="du jl jm jn jo b">LiveData</code>、<code class="du jl jm jn jo b">ViewModel</code>、<code class="du jl jm jn jo b">Room</code>、<code class="du jl jm jn jo b">DataBinding</code>等一些特性，并根据<a class="ae jh" href="https://developer.android.com/jetpack/guide" rel="noopener ugc nofollow" target="_blank">应用架构指南</a>中的最佳实践构建一个照片浏览器应用。</p><h1 id="aca4" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">先决条件</h1><p id="f689" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">这个应用程序将从<a class="ae jh" href="https://www.pexels.com/" rel="noopener ugc nofollow" target="_blank"> Pexels </a>获取照片，所以在开始构建应用程序之前，如果你没有Pexels帐户，我们需要创建一个。我们不会关注如何创建Pexels帐户，因为这超出了本教程的范围。但是根据Pexels上的说明创建新帐户是相当容易的。</p><p id="5aae" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要将<code class="du jl jm jn jo b">Authorization Token</code>保存在安全的地方，这是访问Pexels API的关键，将在应用程序中使用。</p><p id="3817" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，我们可以用Postman对Pexels API进行一些测试，以确保我们的<code class="du jl jm jn jo b">Authorization Token</code>是正确的，并且我们能够为Pexels获取照片。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ks"><img src="../Images/81305c3033dd8f9bf34340382fa250b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Ar3u5AqO3kfPZ2JZCN8nQ.png"/></div></div></figure><p id="d672" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">请注意，您需要用创建Pexels帐户时获得的实际值替换<code class="du jl jm jn jo b">Headers</code>中的<code class="du jl jm jn jo b">Authorization Token</code>。</p><p id="4837" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">如果幸运的话，我们会得到如下JSON格式的响应:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="3f1b" class="li jq hi jo b fi lj lk l ll lm">{<br/> "page": 1,<br/> "per_page": 2,<br/> "photos": [{<br/>   "id": 6546164,<br/>   "width": 3265,<br/>   "height": 5000,<br/>   "url": "<a class="ae jh" href="https://www.pexels.com/photo/person-taking-bowl-with-hawaiian-dish-6546164/" rel="noopener ugc nofollow" target="_blank">https://www.pexels.com/photo/person-taking-bowl-with-hawaiian-dish-6546164/</a>",<br/>   "photographer": "Larissa Deruzzi",<br/>   "photographer_url": "<a class="ae jh" href="https://www.pexels.com/@deruzzi" rel="noopener ugc nofollow" target="_blank">https://www.pexels.com/@deruzzi</a>",<br/>   "photographer_id": 20198481,<br/>   "avg_color": "#BE695C",<br/>   "src": {<br/>    "original": "<a class="ae jh" href="https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg</a>",<br/>    "large2x": "<a class="ae jh" href="https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=2&amp;h=650&amp;w=940" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=2&amp;h=650&amp;w=940</a>",<br/>    "large": "<a class="ae jh" href="https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=650&amp;w=940" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=650&amp;w=940</a>",<br/>    "medium": "<a class="ae jh" href="https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=350" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=350</a>",<br/>    "small": "<a class="ae jh" href="https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=130" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=130</a>",<br/>    "portrait": "<a class="ae jh" href="https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=1200&amp;w=800" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=1200&amp;w=800</a>",<br/>    "landscape": "<a class="ae jh" href="https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=627&amp;w=1200" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=627&amp;w=1200</a>",<br/>    "tiny": "<a class="ae jh" href="https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=1&amp;fit=crop&amp;h=200&amp;w=280" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=1&amp;fit=crop&amp;h=200&amp;w=280</a>"<br/>   },<br/>   "liked": false<br/>  },<br/>  {<br/>   "id": 6805855,<br/>   "width": 5126,<br/>   "height": 4101,<br/>   "url": "<a class="ae jh" href="https://www.pexels.com/photo/group-of-tourists-walking-on-snowy-hilly-terrain-6805855/" rel="noopener ugc nofollow" target="_blank">https://www.pexels.com/photo/group-of-tourists-walking-on-snowy-hilly-terrain-6805855/</a>",<br/>   "photographer": "Harry Cooke",<br/>   "photographer_url": "<a class="ae jh" href="https://www.pexels.com/@harry-cooke" rel="noopener ugc nofollow" target="_blank">https://www.pexels.com/@harry-cooke</a>",<br/>   "photographer_id": 3933683,<br/>   "avg_color": "#738080",<br/>   "src": {<br/>    "original": "<a class="ae jh" href="https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg</a>",<br/>    "large2x": "<a class="ae jh" href="https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=2&amp;h=650&amp;w=940" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=2&amp;h=650&amp;w=940</a>",<br/>    "large": "<a class="ae jh" href="https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=650&amp;w=940" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=650&amp;w=940</a>",<br/>    "medium": "<a class="ae jh" href="https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=350" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=350</a>",<br/>    "small": "<a class="ae jh" href="https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=130" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=130</a>",<br/>    "portrait": "<a class="ae jh" href="https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=1200&amp;w=800" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=1200&amp;w=800</a>",<br/>    "landscape": "<a class="ae jh" href="https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=627&amp;w=1200" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=627&amp;w=1200</a>",<br/>    "tiny": "<a class="ae jh" href="https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=1&amp;fit=crop&amp;h=200&amp;w=280" rel="noopener ugc nofollow" target="_blank">https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=1&amp;fit=crop&amp;h=200&amp;w=280</a>"<br/>   },<br/>   "liked": false<br/>  }<br/> ],<br/> "total_results": 8000,<br/> "next_page": "<a class="ae jh" href="https://api.pexels.com/v1/search/?page=2&amp;per_page=2&amp;query=people" rel="noopener ugc nofollow" target="_blank">https://api.pexels.com/v1/search/?page=2&amp;per_page=2&amp;query=people</a>"<br/>}</span></pre><p id="b268" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">如果我们分析JSON对象，我们会得到模式是</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="2a44" class="li jq hi jo b fi lj lk l ll lm">{<br/>  page: Int,<br/>  per_page: Int,<br/>  photos: List&lt;Photo&gt;,<br/>  total_result: Int,<br/>  next_page: String<br/>}</span></pre><p id="8cd6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">而<code class="du jl jm jn jo b">Photo</code>的模式是</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="7f40" class="li jq hi jo b fi lj lk l ll lm">{<br/>  id: Int,<br/>  width: Int,<br/>  height: Int,<br/>  url: String,<br/>  photographer: String,<br/>  photographer_url: String,<br/>  photographer_id: Int,<br/>  avg_color: String,<br/>  src: Src,<br/>  liked: Boolean,<br/>}</span></pre><p id="4519" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">而<code class="du jl jm jn jo b">Src</code>的模式是</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="2ce3" class="li jq hi jo b fi lj lk l ll lm">{<br/>  original: String,<br/>  large2x: String,<br/>  large: String,<br/>  medium: String,<br/>  small: String,<br/>  portrait: String,<br/>  landscape: String,<br/>  tiny: String<br/>}</span></pre><p id="7574" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">当我们创建数据模型时，我们需要这些模式</p><p id="4aac" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">一旦我们验证了Pexels API是可访问的，我们就可以开始构建应用程序了。</p><h1 id="055e" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">创建新项目</h1><p id="1380" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">让我们打开<code class="du jl jm jn jo b">Android Studio</code>并从菜单中选择<code class="du jl jm jn jo b">Create a new project</code>或启动向导并选择<code class="du jl jm jn jo b">Bottom Navigation Activity</code>模板</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ln"><img src="../Images/6015a6a3151eb74693c18a37ac1eed1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4D-BTtUYq7MwL3ur4WjfJQ.png"/></div></div></figure><p id="1a3c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">点击<code class="du jl jm jn jo b">next</code>，完成如下配置页面:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div role="button" tabindex="0" class="ky kz di la bf lb"><div class="er es ln"><img src="../Images/b9edaf86aee63e5d841890ae4302ac10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mZzCKZjigs1nnwK2Jqdg8Q.png"/></div></div></figure><p id="9fc5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后点击<code class="du jl jm jn jo b">finish</code>按钮。</p><p id="8d3a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后<code class="du jl jm jn jo b">Android Studio</code>将开始构建这个新项目并下载一些依赖项。这可能需要几分钟。</p><h2 id="0d63" class="li jq hi bd jr lo lp lq jv lr ls lt jz ji lu lv kd jj lw lx kh jk ly lz kl ma bi translated">运行空应用程序</h2><p id="8e0f" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">如果没有模拟器，我们需要创建一个新的模拟器，启动模拟器，然后运行应用程序。它会显示这样的用户界面:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es mb"><img src="../Images/54c3cee506646cc5e6c61b19c3545a15.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*cjWYEkV3_XEvY_tNUKghPw.png"/></div></figure><p id="acb4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这是一个来自<code class="du jl jm jn jo b">Bottom Navigation Activity</code>模板的空应用，包含3个页面，<code class="du jl jm jn jo b">Home</code>，<code class="du jl jm jn jo b">Dashboard</code>和<code class="du jl jm jn jo b">Notification</code>，应用启动时显示的是<code class="du jl jm jn jo b">Home</code>页面。</p><p id="c307" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们将在接下来的章节中一步一步实现这个应用</p><h1 id="de0a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">创建数据模型</h1><p id="9a51" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">我们将在MVVM架构上构建这个应用程序，所以让我们先实现<code class="du jl jm jn jo b">Model</code>。</p><p id="eed4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">首先，我们需要向<code class="du jl jm jn jo b">Build.gradle(Module: Pexels.app)</code>添加以下依赖项</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="c0b0" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">// Moshi<br/></em>implementation 'com.squareup.moshi:moshi-kotlin:1.9.3'</span></pre><p id="bca2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">按照<code class="du jl jm jn jo b">Android Studio</code>的指示</p><p id="ffe0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">其次，为了整个项目的整洁，让我们创建一个新的包，<code class="du jl jm jn jo b">data</code>。</p><p id="c752" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们需要根据在<code class="du jl jm jn jo b">Prerequisite</code>步骤中得到的JSON对象的模式创建几个数据类<code class="du jl jm jn jo b">Data</code>、<code class="du jl jm jn jo b">Data.Photo</code>和<code class="du jl jm jn jo b">Data.Photo.Src</code>。</p><p id="5dd4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">因此，让我们在<code class="du jl jm jn jo b">data</code>包中创建一个新文件<code class="du jl jm jn jo b">Data.kt</code>，并添加如下数据类:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="7f08" class="li jq hi jo b fi lj lk l ll lm">package com.ovlesser.pexels.data<br/><br/>data class Data(<br/>    val page: Int,<br/>    @Json(name = "per_page") val perPage: Int,<br/>    val photos: List&lt;Photo&gt;,<br/>    @Json(name = "total_results") val totalResults: Int,<br/>    @Json(name = "next_page") val nextPage: String<br/>) {<br/>    data class Photo(<br/>        val id: Int,<br/>        val width: Int,<br/>        val height: Int,<br/>        val url: String,<br/>        val photographer: String,<br/>        @Json(name = "photographer_url") val photographerUrl: String,<br/>        @Json(name = "photographer_id") val photographerId: Int,<br/>        @Json(name = "avg_color") val avgColor: String,<br/>        val src: Src,<br/>        val liked: Boolean,<br/>    ) {<br/>        data class Src(<br/>            val original: String,<br/>            val large2x: String,<br/>            val large: String,<br/>            val medium: String,<br/>            val small: String,<br/>            val portrait: String,<br/>            val landscape: String,<br/>            val tiny: String<br/>        )<br/>    }<br/>}</span></pre><p id="7ac1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">小心像<code class="du jl jm jn jo b">@Json(name = "photographer_url")</code>这样的注释，它将JSON对象中的名称映射到数据类中的名称</p><p id="e756" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们创建了数据模型，并完成了MVVM的<code class="du jl jm jn jo b">Model</code>。我们将在下一章实现<code class="du jl jm jn jo b">ViewModel</code></p><h1 id="8960" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">为<code class="du jl jm jn jo b">Home</code>页面创建视图模型</h1><p id="f66d" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">您可能会注意到在<code class="du jl jm jn jo b">./ui/home</code>包中有一个名为<code class="du jl jm jn jo b">HomeViewModel.kt</code>的文件，它是默认的ViewModel和模板一起生成的。我们需要将<code class="du jl jm jn jo b">HomeViewModel</code>类的代码替换为</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="dca3" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">// The internal MutableLiveData Data that stores the most recent data<br/></em>private val _data = MutableLiveData&lt;Data&gt;()<br/><br/><em class="ik">// The external immutable LiveData for the response Data<br/></em>val data: LiveData&lt;Data&gt;<br/>    get() = _data<br/><br/>init {<br/>    getDataFromSample()<br/>}<br/><br/>private fun getDataFromSample() {<br/>    _data.value = Data(0, 0, <em class="ik">emptyList</em>(), 0, "")<br/>}</span></pre><p id="f0ef" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">而<code class="du jl jm jn jo b">Android Studio</code>可能会要求你通过导入<code class="du jl jm jn jo b">com.ovlesser.pexels.data.Data</code>来解决<code class="du jl jm jn jo b">Data</code>，照做就是了。</p><p id="8dfe" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">下一步，我们将用更有意义的数据修改getDataFromSample方法。还记得我们用Postman测试Pexels API时的反应吗？我们可以利用这种反应。</p><p id="ede5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们在<code class="du jl jm jn jo b">data</code>包中创建一个新文件<code class="du jl jm jn jo b">SampleData.kt</code>，并在其中定义一个变量<code class="du jl jm jn jo b">sampleData</code>，将响应复制并粘贴为该字符串的值，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="32bb" class="li jq hi jo b fi lj lk l ll lm">package com.ovlesser.pexels</span><span id="aba7" class="li jq hi jo b fi mc lk l ll lm">val <em class="ik">sampleData </em>=<br/>    """<br/>{<br/>    "page": 1,<br/>    "per_page": 2,<br/>    "photos": [<br/>        {<br/>            "id": 6546164,<br/>            "width": 3265,<br/>            "height": 5000,<br/>            "url": "https://www.pexels.com/photo/person-taking-bowl-with-hawaiian-dish-6546164/",<br/>            "photographer": "Larissa Deruzzi",<br/>            "photographer_url": "https://www.pexels.com/@deruzzi",<br/>            "photographer_id": 20198481,<br/>            "avg_color": "#BE695C",<br/>            "src": {<br/>                "original": "https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg",<br/>                "large2x": "https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=2&amp;h=650&amp;w=940",<br/>                "large": "https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=650&amp;w=940",<br/>                "medium": "https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=350",<br/>                "small": "https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=130",<br/>                "portrait": "https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=1200&amp;w=800",<br/>                "landscape": "https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=627&amp;w=1200",<br/>                "tiny": "https://images.pexels.com/photos/6546164/pexels-photo-6546164.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=1&amp;fit=crop&amp;h=200&amp;w=280"<br/>            },<br/>            "liked": false<br/>        },<br/>        {<br/>            "id": 6805855,<br/>            "width": 5126,<br/>            "height": 4101,<br/>            "url": "https://www.pexels.com/photo/group-of-tourists-walking-on-snowy-hilly-terrain-6805855/",<br/>            "photographer": "Harry Cooke",<br/>            "photographer_url": "https://www.pexels.com/@harry-cooke",<br/>            "photographer_id": 3933683,<br/>            "avg_color": "#738080",<br/>            "src": {<br/>                "original": "https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg",<br/>                "large2x": "https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=2&amp;h=650&amp;w=940",<br/>                "large": "https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=650&amp;w=940",<br/>                "medium": "https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=350",<br/>                "small": "https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;h=130",<br/>                "portrait": "https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=1200&amp;w=800",<br/>                "landscape": "https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;fit=crop&amp;h=627&amp;w=1200",<br/>                "tiny": "https://images.pexels.com/photos/6805855/pexels-photo-6805855.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=1&amp;fit=crop&amp;h=200&amp;w=280"<br/>            },<br/>            "liked": false<br/>        }<br/>    ],<br/>    "total_results": 8000,<br/>    "next_page": "https://api.pexels.com/v1/search/?page=2&amp;per_page=2&amp;query=people"<br/>}<br/>    """.<em class="ik">trimIndent</em>()</span></pre><p id="e214" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们将在不实现网络模块的情况下用这个样本数据测试app。</p><p id="757a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">所以让我们修改一下<code class="du jl jm jn jo b">getDataFromSample</code>函数，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="9400" class="li jq hi jo b fi lj lk l ll lm">private fun getDataFromSample() {<br/>    val moshi = Moshi.Builder()<br/>        .add(KotlinJsonAdapterFactory())<br/>        .build()<br/>    val jsonAdapter = moshi.adapter(Data::class.<em class="ik">java</em>)<br/>    val sampleData = jsonAdapter.fromJson(<em class="ik">sampleData</em>)<br/>    _data.<em class="ik">value </em>= sampleData ?: Data(0, 0, <em class="ik">emptyList</em>(), 0, "")<br/>}</span></pre><p id="82cc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们用<code class="du jl jm jn jo b">Moshi</code>将样本数据从JSON字符串转换成一个<code class="du jl jm jn jo b">Data</code>对象。稍后，我们将使用相同的方法将数据从Pexels API转换为<code class="du jl jm jn jo b">Data</code>对象。</p><p id="120c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在，我们已经实现了<code class="du jl jm jn jo b">Home</code>页面的<code class="du jl jm jn jo b">ViewModel</code>的框架。我们将在下一章实现<code class="du jl jm jn jo b">View</code></p><h1 id="8e72" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">构建主页的视图</h1><p id="3bba" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">我们将使用<code class="du jl jm jn jo b">Home</code>片段作为主页，在主页中我们将显示带有网格布局的照片。</p><p id="4fb5" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">首先，我们需要添加一些UI相关的依赖项。让我们打开<code class="du jl jm jn jo b">Build.gradle(Module: Pexels.app)</code>文件，在<code class="du jl jm jn jo b">plugins</code>部分添加几个额外的行，如下所示:</p><p id="839b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">插件<strong class="il hj">{<br/></strong>id ' com . Android . application '<br/>id ' kotlin-Android '<br/><code class="du jl jm jn jo b"><strong class="il hj"> id 'kotlin-android-extensions'<br/> id 'kotlin-kapt'<br/></strong></code><strong class="il hj">}</strong></p><p id="95ed" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">新增了<strong class="il hj">粗体</strong>行。</p><p id="82d6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要通过在<code class="du jl jm jn jo b">buildTypes</code>部分下添加以下行来启用<code class="du jl jm jn jo b">DataBinding</code>，</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="4221" class="li jq hi jo b fi lj lk l ll lm">buildTypes <strong class="jo hj">{<br/>    </strong>release <strong class="jo hj">{<br/>        </strong>minifyEnabled false<br/>        proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'<br/>    <strong class="jo hj">}<br/>}<br/>buildFeatures {<br/>    dataBinding true<br/>}<br/></strong>compileOptions <strong class="jo hj">{<br/>    </strong>sourceCompatibility JavaVersion.<em class="ik">VERSION_1_8<br/>    </em>targetCompatibility JavaVersion.<em class="ik">VERSION_1_8<br/></em><strong class="jo hj">}<br/></strong>kotlinOptions <strong class="jo hj">{<br/>    </strong>jvmTarget = '1.8'<br/><strong class="jo hj">}</strong></span></pre><p id="6606" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并将以下依赖关系添加到<code class="du jl jm jn jo b">dependencies</code>部分。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="ef68" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">//RecyclerView<br/></em>implementation "androidx.recyclerview:recyclerview:1.1.0"<br/><em class="ik">// For control over item selection of both touch and mouse driven selection<br/></em>implementation "androidx.recyclerview:recyclerview-selection:1.1.0"</span></pre><p id="b852" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要点击<code class="du jl jm jn jo b">Sync now</code>。</p><p id="a694" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">其次，我们需要定义照片网格中列表项的布局。</p><p id="10d7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们在<code class="du jl jm jn jo b">layout</code>文件夹中创建一个名为<code class="du jl jm jn jo b">grid_view_item.xml</code>的新布局文件，并用以下代码替换其内容</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="43df" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">&lt;?</em>xml version="1.0" encoding="utf-8"<em class="ik">?&gt;<br/><br/></em>&lt;layout<br/>    xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:app="http://schemas.android.com/apk/res-auto"<br/>    xmlns:tools="http://schemas.android.com/tools"&gt;<br/><br/>    &lt;data&gt;<br/>        &lt;variable<br/>            name="photo"<br/>            type="com.ovlesser.pexels.data.Data.Photo" /&gt;<br/>    &lt;/data&gt;<br/><br/>    &lt;FrameLayout<br/>        android:layout_width="match_parent"<br/>        android:layout_height="wrap_content"<br/>        android:padding="4dp"<br/>        android:minHeight="100dp"&gt;<br/><br/>        &lt;ImageView<br/>            android:id="@+id/pexel_image"<br/>            android:layout_width="match_parent"<br/>            android:layout_height="wrap_content"<br/>            android:minHeight="100dp"<br/>            android:minWidth="100dp"<br/>            android:scaleType="fitXY"<br/>            android:adjustViewBounds="true"<br/>            app:imageUrl="@{photo.src.medium}"<br/>            android:background="@color/teal_700"<br/>            tools:src="@tools:sample/backgrounds/scenic"/&gt;<br/><br/>    &lt;/FrameLayout&gt;<br/>&lt;/layout&gt;</span></pre><p id="fa67" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您可能注意到我们声明了一个类型为<code class="du jl jm jn jo b">com.ovlesser.pexels.data.Data.Photo</code>的变量<code class="du jl jm jn jo b">photo</code>，它将把photo的值传递给这个布局文件。</p><p id="04a6" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">如果您构建应用程序，将会失败，因为我们还没有实现<code class="du jl jm jn jo b">imageUrl</code>的数据绑定。我们稍后会修理它。</p><p id="70e3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们需要修改页面本身的布局。让我们打开<code class="du jl jm jn jo b">fragment_home.xml</code>并将整个<code class="du jl jm jn jo b">TextView</code>部分替换为</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="0b21" class="li jq hi jo b fi lj lk l ll lm">&lt;androidx.recyclerview.widget.RecyclerView<br/>    android:id="@+id/photos_grid"<br/>    android:layout_width="0dp"<br/>    android:layout_height="0dp"<br/>    android:padding="6dp"<br/>    android:clipToPadding="false"<br/>   app:layoutManager="androidx.recyclerview.widget.StaggeredGridLayoutManager"<br/>    app:layout_constraintBottom_toBottomOf="parent"<br/>    app:layout_constraintLeft_toLeftOf="parent"<br/>    app:layout_constraintRight_toRightOf="parent"<br/>    app:layout_constraintTop_toTopOf="parent"<br/>    app:spanCount="2"<br/>    tools:itemCount="16"<br/>    tools:listitem="@layout/grid_view_item" /&gt;</span></pre><p id="7498" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这是一个带有<code class="du jl jm jn jo b">StaggeredGridLayoutManager</code>的<code class="du jl jm jn jo b">RecyclerView</code>，照片将在其中显示。</p><p id="5d59" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要将整个<code class="du jl jm jn jo b">ConstraintLayout</code>部分包装在一个<code class="du jl jm jn jo b">layout</code>标签中，并将<code class="du jl jm jn jo b">ConstraintLayout</code>的属性移动到<code class="du jl jm jn jo b">layout</code>标签中，如下所示，以便使用<code class="du jl jm jn jo b">DataBinding</code></p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="c136" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">&lt;?</em>xml version="1.0" encoding="utf-8"<em class="ik">?&gt;<br/></em><strong class="jo hj">&lt;layout<br/>    xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:app="http://schemas.android.com/apk/res-auto"<br/>    xmlns:tools="http://schemas.android.com/tools"&gt;<br/></strong><br/>    &lt;androidx.constraintlayout.widget.ConstraintLayout<br/>        android:layout_width="match_parent"<br/>        android:layout_height="match_parent"<br/>        tools:context=".ui.home.HomeFragment"&gt;</span><span id="c2b1" class="li jq hi jo b fi mc lk l ll lm">        ......</span><span id="4891" class="li jq hi jo b fi mc lk l ll lm">   &lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;<br/><strong class="jo hj">&lt;/layout&gt;</strong></span></pre><p id="23f9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">下一步是修改<code class="du jl jm jn jo b">HomeFragment.kt</code>，它是<code class="du jl jm jn jo b">Home</code>片段的UI部分。</p><p id="1dfa" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要将属性<code class="du jl jm jn jo b">homeViewModel</code>的定义从</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="bcd1" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">private lateinit var homeViewModel: HomeViewModel</em></span></pre><p id="2d3f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">到</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="7623" class="li jq hi jo b fi lj lk l ll lm">private val homeViewModel: HomeViewModel by <em class="ik">lazy </em><strong class="jo hj">{<br/>    </strong>ViewModelProvider(this).get(HomeViewModel::class.<em class="ik">java</em>)<br/><strong class="jo hj">}</strong></span></pre><p id="1ff4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要用以下内容替换<code class="du jl jm jn jo b">onCreateView</code>方法中的内容</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="a3af" class="li jq hi jo b fi lj lk l ll lm">val binding = FragmentHomeBinding.inflate(inflater)<br/><br/><em class="ik">// Allows Data Binding to Observe LiveData with the lifecycle of this Fragment<br/></em>binding.<em class="ik">lifecycleOwner </em>= this<br/><br/>return binding.<em class="ik">root</em></span></pre><p id="5cb3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这段代码意味着我们将使用<code class="du jl jm jn jo b">DataBinding</code>在源代码和布局之间传递数据。</p><p id="dd09" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们将在下一步为<code class="du jl jm jn jo b">RecyclerView</code>实现一个适配器，它将照片列表映射到列表项中。</p><p id="af63" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们创建一个新文件，<code class="du jl jm jn jo b">PhotoGridAdapter</code>，并按如下方式实现它:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="0ac9" class="li jq hi jo b fi lj lk l ll lm">class PhotoGridAdapter: ListAdapter&lt;Data.Photo, PhotoGridAdapter.PhotoGridViewHolder&gt;(DiffCallback) {<br/><br/>    class PhotoGridViewHolder(private var binding: GridViewItemBinding): RecyclerView.ViewHolder(binding.<em class="ik">root</em>) {<br/>        fun bind(photo: Data.Photo) {<br/>            binding.photo = photo<br/>            binding.executePendingBindings()<br/>        }<br/>    }<br/><br/>    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): PhotoGridViewHolder {<br/>        return PhotoGridViewHolder( GridViewItemBinding.inflate( LayoutInflater.from( parent.<em class="ik">context</em>)))<br/>    }<br/><br/>    override fun onBindViewHolder(holder: PhotoGridViewHolder, position: Int) {<br/>        val photo = getItem(position)<br/>        holder.bind(photo)<br/>    }<br/><br/>    companion object DiffCallback: DiffUtil.ItemCallback&lt;Data.Photo&gt;() {<br/>        override fun areItemsTheSame(oldItem: Data.Photo, newItem: Data.Photo): Boolean {<br/>            return oldItem.id === newItem.id<br/>        }<br/><br/>        override fun areContentsTheSame(oldItem: Data.Photo, newItem: Data.Photo): Boolean {<br/>            return oldItem == newItem<br/>        }<br/><br/>    }<br/>}</span></pre><p id="7011" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们需要创建另一个文件<code class="du jl jm jn jo b">BindingAdapters.kt</code>，并实现一个带有注释<code class="du jl jm jn jo b">BindingAdapter("liveData")</code>的函数，这将把适配器绑定到RecyclerView。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="53e4" class="li jq hi jo b fi lj lk l ll lm">@BindingAdapter("listData")<br/>fun bindRecyclerView(recyclerView: RecyclerView,<br/>                     photos: List&lt;Data.Photo&gt;?) {<br/>    val adapter = recyclerView.<em class="ik">adapter </em>as PhotoGridAdapter<br/>    adapter.submitList(photos)<br/>}</span></pre><p id="68bb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后让我们打开<code class="du jl jm jn jo b">fragment_home.xml</code>并在所有组件上方添加<code class="du jl jm jn jo b">data</code>部分，并在<code class="du jl jm jn jo b">RecyclerView</code>内添加<code class="du jl jm jn jo b">app:listData="@{viewModel.data.photos}"</code>以将视图模型绑定到视图，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="6c1d" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">&lt;?</em>xml version="1.0" encoding="utf-8"<em class="ik">?&gt;<br/></em>&lt;layout<br/>    xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:app="http://schemas.android.com/apk/res-auto"<br/>    xmlns:tools="http://schemas.android.com/tools"&gt;<br/><br/><strong class="jo hj">    &lt;data&gt;<br/>        &lt;variable<br/>            name="viewModel"<br/>            type="com.ovlesser.pexels.ui.home.HomeViewModel" /&gt;<br/>    &lt;/data&gt;<br/></strong><br/>    &lt;androidx.constraintlayout.widget.ConstraintLayout<br/>        android:layout_width="match_parent"<br/>        android:layout_height="match_parent"<br/>        tools:context=".ui.home.HomeFragment"&gt;<br/><br/>        &lt;androidx.recyclerview.widget.RecyclerView<br/>            ......<br/>            app:spanCount="2"<br/>            tools:itemCount="16"<br/><strong class="jo hj">            app:listData="@{viewModel.data.photos}"<br/></strong>            tools:listitem="@layout/grid_view_item" /&gt;<br/>    &lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;<br/>&lt;/layout&gt;</span></pre><p id="c29e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">RecyclerView中的名称和BindingAdapter的名称必须相同，在本例中为<code class="du jl jm jn jo b">listData</code></p><p id="fc74" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，我们需要打开<code class="du jl jm jn jo b">HomeFragment.kt</code>并将下面几行添加到<code class="du jl jm jn jo b">onCreateView</code>方法中，如下所示。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="9a81" class="li jq hi jo b fi lj lk l ll lm">val binding = FragmentHomeBinding.inflate(inflater)<br/><br/><em class="ik">// Allows Data Binding to Observe LiveData with the lifecycle of this Fragment<br/></em>binding.<em class="ik">lifecycleOwner </em>= this<br/><br/><strong class="jo hj"><em class="ik">// Giving the binding access to the OverviewViewModel<br/></em>binding.viewModel = homeViewModel<br/><br/>binding.photosGrid.<em class="ik">adapter </em>= PhotoGridAdapter()<br/></strong><br/>return binding.<em class="ik">root</em></span></pre><p id="4a54" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在，ViewModel绑定到了<code class="du jl jm jn jo b">Home</code>页面的视图，一个适配器绑定到了RecyclerView。</p><p id="d8ff" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">下一步，我们将通过将<code class="du jl jm jn jo b">grid_view_item</code>布局中的<code class="du jl jm jn jo b">imageUrl</code>与另一个BindingAdapter绑定，在RecyclerView中显示照片。</p><p id="0f4d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">首先，我们需要给<code class="du jl jm jn jo b">build.gradle(Module:Pexels.app)</code>添加以下依赖项</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="eb36" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">// Glide<br/></em>implementation 'com.github.bumptech.glide:glide:4.11.0'</span></pre><p id="84ec" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">其次，我们需要在<code class="du jl jm jn jo b">BindingAdapters.kt</code>中添加以下<code class="du jl jm jn jo b">BindingAdapter</code></p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="99d4" class="li jq hi jo b fi lj lk l ll lm">@BindingAdapter("imageUrl")<br/>fun bindImageView(imageView: ImageView, imageUrl: String?) {<br/>    imageUrl?.<em class="ik">let </em><strong class="jo hj">{<br/>        </strong>val imageUri = imageUrl.<em class="ik">toUri</em>().buildUpon().scheme("https").build()<br/>        Glide.with(imageView.<em class="ik">context</em>)<br/>            .load(imageUri)<br/>            .apply(<br/>                RequestOptions()<br/>                .placeholder(R.drawable.loading_animation)<br/>                .error(R.drawable.ic_broken_image))<br/>            .into(imageView)<br/>    <strong class="jo hj">}<br/></strong>}</span></pre><p id="9a31" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您可能会注意到图像<code class="du jl jm jn jo b">loading_animation</code>和<code class="du jl jm jn jo b">ic_broken_image</code>丢失了，所以让我们创建它们，或者您可以下载到其他地方。</p><p id="f1a9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们创建一个新的drawable，<code class="du jl jm jn jo b">loading_animation</code>,并用</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="b55d" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">&lt;?</em>xml version="1.0" encoding="utf-8"<em class="ik">?&gt;<br/><br/></em>&lt;animated-rotate xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:drawable="@drawable/loading_img"<br/>    android:pivotX="50%"<br/>    android:pivotY="50%" /&gt;</span></pre><p id="b9dd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并创建另一个drawable，<code class="du jl jm jn jo b">loading_img</code>并将其内容替换为</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="713d" class="li jq hi jo b fi lj lk l ll lm">&lt;vector android:height="24dp" android:viewportHeight="72"<br/>    android:viewportWidth="72" android:width="24dp" xmlns:android="http://schemas.android.com/apk/res/android"&gt;<br/>    &lt;path android:fillColor="#cccccf"<br/>        android:pathData="M36.06,28.92L36.06,32.18"<br/>        android:strokeColor="#e7e7e7" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#c8c8cc"<br/>        android:pathData="M39.45,29.88L37.82,32.71"<br/>        android:strokeColor="#cacaca" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#bbbbbe"<br/>        android:pathData="M42.12,32.32L39.3,33.95"<br/>        android:strokeColor="#cdcdcd" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#b2b2b7"<br/>        android:pathData="M39.8,35.98L43.06,35.98"<br/>        android:strokeColor="#cbcbcb" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#d0d0d4"<br/>        android:pathData="M32.77,29.99L34.4,32.81"<br/>        android:strokeColor="#ededed" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#949497"<br/>        android:pathData="M30.1,32.42L32.92,34.05"<br/>        android:strokeColor="#525252" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#97979b"<br/>        android:pathData="M32.42,35.98L29.16,35.98"<br/>        android:strokeColor="#6e6e6e" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#a8a8ac"<br/>        android:pathData="M36.06,43.08L36.06,39.82"<br/>        android:strokeColor="#a0a0a0" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#cacaca"<br/>        android:pathData="M39.7,41.99L38.07,39.16"<br/>        android:strokeColor="#cacaca" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#b6b6ba"<br/>        android:pathData="M42.19,39.4L39.37,37.77"<br/>        android:strokeColor="#ccc" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#a1a1a5"<br/>        android:pathData="M32.46,41.98L34.09,39.16"<br/>        android:strokeColor="#909090" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>    &lt;path android:fillColor="#9d9da0"<br/>        android:pathData="M29.85,39.4L32.67,37.77"<br/>        android:strokeColor="#7a7a7a" android:strokeLineCap="round" android:strokeWidth="1"/&gt;<br/>&lt;/vector&gt;</span></pre><p id="5a60" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">而第三个drawable，<code class="du jl jm jn jo b">ic_broken_image</code>，将其内容替换为</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="2d31" class="li jq hi jo b fi lj lk l ll lm">&lt;vector xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:width="24dp"<br/>    android:height="24dp"<br/>    android:tint="#A9A9AC"<br/>    android:viewportWidth="24.0"<br/>    android:viewportHeight="24.0"&gt;<br/>    &lt;path<br/>        android:fillColor="#FF000000"<br/>        android:pathData="M21,5v6.59l-3,-3.01 -4,4.01 -4,-4 -4,4 -3,-3.01L3,5c0,-1.1 0.9,-2 2,-2h14c1.1,0 2,0.9 2,2zM18,11.42l3,3.01L21,19c0,1.1 -0.9,2 -2,2L5,21c-1.1,0 -2,-0.9 -2,-2v-6.58l3,2.99 4,-4 4,4 4,-3.99z" /&gt;<br/>&lt;/vector&gt;</span></pre><p id="9019" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">好的。<code class="du jl jm jn jo b">bindImageView</code>功能中丢失符号的错误被修复。</p><p id="d98f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在我们修复了<code class="du jl jm jn jo b">grid_view_item.xml</code>中<code class="du jl jm jn jo b">imageUrl</code>丢失的绑定后，它应该可以构建了。</p><p id="caff" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在我们已经将所有的<code class="du jl jm jn jo b">HomeViewModel</code>和<code class="du jl jm jn jo b">Data</code>和<code class="du jl jm jn jo b">HomeFragment</code>及其适配器绑定在一起。所以你可能想运行它。但是它会因为一个错误<code class="du jl jm jn jo b">Permission denied (missing INTERNET permission?)</code>而失败。让我们在下一章解决它。</p><h1 id="73ee" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">更新用户权限</h1><p id="0b71" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">让我们打开<code class="du jl jm jn jo b">AndroidManifest.xml</code>并在<code class="du jl jm jn jo b">application</code>部分上方添加权限，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="a021" class="li jq hi jo b fi lj lk l ll lm">&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"<br/>    ......<br/><br/>    <strong class="jo hj">&lt;uses-permission android:name="android.permission.INTERNET" /&gt;</strong><br/>    &lt;application<br/>        ......</span></pre><p id="2916" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">再次运行它，它将显示如下:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es mb"><img src="../Images/54d0880cccc688eb58111543c88069ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*zrl3HryH9SiqnEssCipVCg.png"/></div></figure><p id="5aec" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">但是要小心，照片是我们的<code class="du jl jm jn jo b">sampleData</code>。我们将在下一章添加实际的网络操作。</p><h1 id="03ab" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">添加网络操作</h1><p id="1be4" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">虽然数据是假的，但我们已经在前一章用网格展示了MVVM建筑的数据绑定照片。所以让我们在运行时从Pexels API获取真实的照片。要实现它，我们需要集成<code class="du jl jm jn jo b">Retrofit</code>。</p><p id="74ab" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">首先，我们需要将以下依赖项添加到<code class="du jl jm jn jo b">build.gradle(Modules:Pexels.app)</code></p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="61c0" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">// Retrofit<br/></em>implementation 'com.squareup.retrofit2:retrofit:2.9.0'<br/>implementation 'com.squareup.retrofit2:converter-scalars:2.9.0'<br/>implementation 'com.squareup.retrofit2:converter-moshi:2.9.0'</span></pre><p id="0caf" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated"><code class="du jl jm jn jo b">Sync Now</code></p><p id="c549" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">其次，我们需要实现一个网络服务。让我们创建一个新的包，<code class="du jl jm jn jo b">network,</code>来保持代码的整洁，然后在这个包中创建一个新的接口，<code class="du jl jm jn jo b">PexelsApiService</code>，并用下面的代码替换它</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="9380" class="li jq hi jo b fi lj lk l ll lm">private val <em class="ik">BASE_URL </em>= "https://api.pexels.com/v1/"<br/><br/>private val <em class="ik">moshi </em>= Moshi.Builder()<br/>    .add(KotlinJsonAdapterFactory())<br/>    .build()<br/><br/>private val <em class="ik">retrofit </em>= Retrofit.Builder()<br/>    .addConverterFactory(MoshiConverterFactory.create(<em class="ik">moshi</em>))<br/>    .baseUrl(<em class="ik">BASE_URL</em>)<br/>    .build()<br/><br/>interface PexelsApiService {<br/>    @GET("search")<br/>    @Headers("Authorization:563492ad6f917000010000011a5094093e6e4ee3978287979ad139ac")<br/>    fun getData(@Query("query") keyword: String,<br/>                @Query("page") pageIndex: Int = 0,<br/>                @Query("per_page") perPage: Int = 20): Call&lt;Data&gt;<br/>}<br/><br/>object PexelApi {<br/>    val retrofitService: PexelsApiService by <em class="ik">lazy </em><strong class="jo hj">{<br/>        </strong><em class="ik">retrofit</em>.create(PexelsApiService::class.<em class="ik">java</em>)<br/>    <strong class="jo hj">}<br/></strong>}</span></pre><p id="05ca" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要在<code class="du jl jm jn jo b">HomeViewModel</code>类的init块中调用这个网络API</p><p id="952c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们添加一个新方法<code class="du jl jm jn jo b">getDataFromNetwork</code>到<code class="du jl jm jn jo b">HomeViewModel</code>类中，实现如下</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="786e" class="li jq hi jo b fi lj lk l ll lm">private fun getDataFromNetwork() {<br/>    PexelApi.retrofitService.getData(keyword = "panda").enqueue(<br/>        object: Callback&lt;Data&gt; {<br/>            override fun onResponse(call: Call&lt;Data&gt;, response: Response&lt;Data&gt;) {<br/>                _data.<em class="ik">value </em>= response.body()<br/>            }<br/><br/>            override fun onFailure(call: Call&lt;Data&gt;, t: Throwable) {<br/>                _data.<em class="ik">value </em>= Data(0, 0, <em class="ik">emptyList</em>(), 0, "")<br/>            }<br/>        }<br/>    )<br/>}</span></pre><p id="e859" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并将<code class="du jl jm jn jo b">init</code>块中的<code class="du jl jm jn jo b">getDataFromSample</code>更换为新的<code class="du jl jm jn jo b">getDataFromNetwork</code>功能</p><p id="e955" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">你会看到很多熊猫的照片，这是现在的硬编码关键词，显示在屏幕上，就像这样:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es mb"><img src="../Images/2df52e9c09cc0b9a1fb5b11e4981abe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*oR5AXNbcLuRlUmG8HlpOOQ.png"/></div></figure><p id="7fa1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">正如我们所见，我们已经实现了第一个版本的网络操作，并将其集成到我们的应用程序中。它与传统的改进回调一起工作，但是让我们在下一章实现同一个API的协程版本</p><h2 id="ed30" class="li jq hi bd jr lo lp lq jv lr ls lt jz ji lu lv kd jj lw lx kh jk ly lz kl ma bi translated">网络API的协同程序版本</h2><p id="47bb" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">我们都知道协程可以让Kotlin代码更具可读性，所以让我们来试试。</p><p id="ee61" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们将另一个方法<code class="du jl jm jn jo b">getDataCoroutine</code>添加到<code class="du jl jm jn jo b">PexelsApiService</code>中，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="825b" class="li jq hi jo b fi lj lk l ll lm">@GET("search")<br/>@Headers("Authorization:563492ad6f917000010000011a5094093e6e4ee3978287979ad139ac")<br/>suspend fun getDataCoroutine(@Query("query") keyword: String,<br/>                             @Query("page") pageIndex: Int = 0,<br/>                             @Query("per_page") perPage: Int = 20): Data</span></pre><p id="f303" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">它是一个挂起函数，返回<code class="du jl jm jn jo b">Data</code>对象而不是<code class="du jl jm jn jo b">Call&lt;Data&gt;</code>。</p><p id="3ee3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们创建另一个方法，<code class="du jl jm jn jo b">getDataFromNetworkCoroutine</code>，在<code class="du jl jm jn jo b">HomeViewModel</code>类中实现如下</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="7878" class="li jq hi jo b fi lj lk l ll lm">private fun getDataFromNetworkCoroutine() {<br/>    <em class="ik">viewModelScope</em>.<em class="ik">launch </em><strong class="jo hj">{<br/>        </strong>try {<br/>            _data.<em class="ik">value </em>= PexelApi.retrofitService.getDataCoroutine(keyword = "panda")<br/>        } catch (e: Exception) {<br/>            _data.<em class="ik">value </em>= Data(0, 0, <em class="ik">emptyList</em>(), 0, "")<br/>        }<br/>    <strong class="jo hj">}<br/></strong>}</span></pre><p id="e1c2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并在<code class="du jl jm jn jo b">init</code>块中调用它而不是<code class="du jl jm jn jo b">getDataFromNetwork</code>。</p><p id="b6f9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">如果我们再次运行该应用程序，我们会得到相同的结果。</p><p id="4ea1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在我们已经用<code class="du jl jm jn jo b">coroutine</code>实现了网络操作。没什么神奇的，很简单。</p><p id="c96d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在我们已经能够从Pexels API获取照片，但是如果网络不可用或后端宕机会发生什么？所以在下一章，我们将在<code class="du jl jm jn jo b">HomeViewModel</code>类中添加更多的属性来处理网络状态。</p><h1 id="1b9f" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">将状态添加到HomeViewModel</h1><p id="1681" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">让我们打开<code class="du jl jm jn jo b">HomeViewModel.kt</code>并添加一个枚举类<code class="du jl jm jn jo b">PexelsApiStatus</code>，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="8dc5" class="li jq hi jo b fi lj lk l ll lm"><strong class="jo hj">enum class PexelsApiStatus { <em class="ik">LOADING</em>, <em class="ik">ERROR</em>, <em class="ik">DONE</em>}</strong><br/><br/>class HomeViewModel : ViewModel() {<br/>    ......</span></pre><p id="4835" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并将两个新属性<code class="du jl jm jn jo b">response</code>和<code class="du jl jm jn jo b">status</code>添加到<code class="du jl jm jn jo b">HomeViewModel</code>类中，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="dbb1" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">// The internal MutableLiveData Data that stores the most recent data<br/></em>private val _data = MutableLiveData&lt;Data&gt;()<br/><strong class="jo hj">private val _response = MutableLiveData&lt;String&gt;()<br/>private val _status = MutableLiveData&lt;PexelsApiStatus&gt;()<br/></strong><br/><em class="ik">// The external immutable LiveData for the response Data<br/></em>val data: LiveData&lt;Data&gt;<br/>    get() = _data<br/><br/><strong class="jo hj">val response: LiveData&lt;String&gt;<br/>    get() = _response<br/><br/>val status: LiveData&lt;PexelsApiStatus&gt;<br/>    get() = _status</strong></span></pre><p id="8685" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并像这样用<code class="du jl jm jn jo b">getDataFromSample</code>方法更新这两个LiveData:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="a878" class="li jq hi jo b fi lj lk l ll lm">private fun getDataFromSample() {<br/>    val moshi = Moshi.Builder()<br/>        .add(KotlinJsonAdapterFactory())<br/>        .build()<br/>    val jsonAdapter = moshi.adapter(Data::class.<em class="ik">java</em>)<br/>    val sampleData = jsonAdapter.fromJson(<em class="ik">sampleData</em>)<br/>    _data.<em class="ik">value </em>= sampleData ?: Data(0, 0, <em class="ik">emptyList</em>(), 0, "")<br/><strong class="jo hj">    _response.<em class="ik">value </em>= "Success: init with sample data"<br/>    _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">DONE</em></strong><em class="ik"><br/></em>}</span></pre><p id="5833" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">同样更新<code class="du jl jm jn jo b">getDataFromNetwork</code></p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="e394" class="li jq hi jo b fi lj lk l ll lm">private fun getDataFromNetwork() {<br/>    val keyword = "panda"<br/>    _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">LOADING<br/>    </em>PexelApi.retrofitService.getData(keyword = keyword).enqueue(<br/>        object: Callback&lt;Data&gt; {<br/>            override fun onResponse(call: Call&lt;Data&gt;, response: Response&lt;Data&gt;) {<br/>                _data.<em class="ik">value </em>= response.body()<br/><strong class="jo hj">                _response.<em class="ik">value </em>= "Success: Pexel data about ${keyword} is fetched"<br/>                _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">DONE<br/> </em></strong><em class="ik">           </em>}<br/><br/>            override fun onFailure(call: Call&lt;Data&gt;, t: Throwable) {<br/>                _data.<em class="ik">value </em>= Data(0, 0, <em class="ik">emptyList</em>(), 0, "")<br/><strong class="jo hj">                _response.<em class="ik">value </em>= "Failure: ${t.message}"<br/>                _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">ERROR<br/></em></strong><em class="ik">            </em>}<br/>        }<br/>    )<br/>}</span></pre><p id="5e9b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">与<code class="du jl jm jn jo b">getDataFromNetworkCoroutine</code>的更新相同</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="35da" class="li jq hi jo b fi lj lk l ll lm">private fun getDataFromNetworkCoroutine() {<br/>    val keyword = "panda"<br/>    _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">LOADING<br/>    viewModelScope</em>.<em class="ik">launch </em><strong class="jo hj">{<br/>        </strong>try {<br/>            _data.<em class="ik">value </em>= PexelApi.retrofitService.getDataCoroutine(keyword = keyword)<br/><strong class="jo hj">            _response.<em class="ik">value </em>= "Success: Pexel data about ${keyword} is fetched"<br/>            _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">DONE<br/></em></strong><em class="ik">        </em>} catch (e: Exception) {<br/>            _data.<em class="ik">value </em>= Data(0, 0, <em class="ik">emptyList</em>(), 0, "")<br/><strong class="jo hj">            _response.<em class="ik">value </em>= "Failure: ${e.message}"<br/>            _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">ERROR<br/></em></strong><em class="ik">        </em>}<br/>    <strong class="jo hj">}<br/></strong>}</span></pre><p id="523a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">如果网络请求失败，我们使用<code class="du jl jm jn jo b">response</code>保存错误消息，使用<code class="du jl jm jn jo b">status</code>保存网络请求的状态。</p><p id="f137" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">因此，如果网络请求成功或失败，我们需要向用户显示一些差异。</p><p id="233a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要做的第一步是在<code class="du jl jm jn jo b">BindingAdapters.kt</code>中添加另一个绑定适配器<code class="du jl jm jn jo b">bindStatus</code>，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="5c36" class="li jq hi jo b fi lj lk l ll lm">@BindingAdapter("marsApiStatus")<br/>fun bindStatus(statusImageView: ImageView,<br/>               status: PexelsApiStatus) {<br/>    when (status) {<br/>        PexelsApiStatus.<em class="ik">LOADING </em>-&gt; {<br/>            statusImageView.<em class="ik">visibility </em>= View.<em class="ik">VISIBLE<br/>            </em>statusImageView.setImageResource(R.drawable.<em class="ik">loading_animation</em>)<br/>        }<br/>        PexelsApiStatus.<em class="ik">ERROR </em>-&gt; {<br/>            statusImageView.<em class="ik">visibility </em>= View.<em class="ik">VISIBLE<br/>            </em>statusImageView.setImageResource(R.drawable.ic_connection_error)<br/>        }<br/>        PexelsApiStatus.<em class="ik">DONE </em>-&gt; {<br/>            statusImageView.<em class="ik">visibility </em>= View.<em class="ik">GONE<br/>        </em>}<br/>    }<br/>}</span></pre><p id="8eb2" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要另一个drawable，<code class="du jl jm jn jo b">ic_connection_error</code>，你可以用</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="bd44" class="li jq hi jo b fi lj lk l ll lm">&lt;vector xmlns:android="http://schemas.android.com/apk/res/android"<br/>    android:width="100dp"<br/>    android:height="100dp"<br/>    android:tint="#A9A9AC"<br/>    android:viewportWidth="24.0"<br/>    android:viewportHeight="24.0"&gt;<br/>    &lt;path<br/>        android:fillColor="#A9A9AC"<br/>        android:pathData="M19.35,10.04C18.67,6.59 15.64,4 12,4c-1.48,0 -2.85,0.43 -4.01,1.17l1.46,1.46C10.21,6.23 11.08,6 12,6c3.04,0 5.5,2.46 5.5,5.5v0.5H19c1.66,0 3,1.34 3,3 0,1.13 -0.64,2.11 -1.56,2.62l1.45,1.45C23.16,18.16 24,16.68 24,15c0,-2.64 -2.05,-4.78 -4.65,-4.96zM3,5.27l2.75,2.74C2.56,8.15 0,10.77 0,14c0,3.31 2.69,6 6,6h11.73l2,2L21,20.73 4.27,4 3,5.27zM7.73,10l8,8H6c-2.21,0 -4,-1.79 -4,-4s1.79,-4 4,-4h1.73z" /&gt;<br/>&lt;/vector&gt;</span></pre><p id="c2d3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">或者去类似<a class="ae jh" href="https://material.io/develop/android" rel="noopener ugc nofollow" target="_blank">材质设计</a>的地方下载。</p><p id="1a03" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们在<code class="du jl jm jn jo b">HomeViewModel</code>中实现了状态的更新，并将其绑定到布局文件中的属性<code class="du jl jm jn jo b">pexelsApiStatus</code>，但是属性在哪里呢？还是加到<code class="du jl jm jn jo b">fragment_home.xml</code>吧</p><p id="0faf" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们在<code class="du jl jm jn jo b">RecyclerView</code>部分下添加以下<code class="du jl jm jn jo b">ImageView</code></p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="615f" class="li jq hi jo b fi lj lk l ll lm">&lt;androidx.constraintlayout.widget.ConstraintLayout<br/>    android:layout_width="match_parent"<br/>    android:layout_height="match_parent"<br/>    tools:context=".ui.home.HomeFragment"&gt;<br/><br/>    &lt;androidx.recyclerview.widget.RecyclerView<br/>    ......<br/>    tools:listitem="@layout/grid_view_item" /&gt;<br/>    <br/>    &lt;ImageView<br/>        android:id="@+id/status_image"<br/>        android:layout_width="200dp"<br/>        android:layout_height="200dp"<br/>        app:layout_constraintBottom_toBottomOf="parent"<br/>        app:layout_constraintLeft_toLeftOf="parent"<br/>        app:layout_constraintRight_toRightOf="parent"<br/>        app:layout_constraintTop_toTopOf="parent"<br/>        app:pexelsApiStatus="@{viewModel.status}" /&gt;<br/><br/>&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span></pre><p id="7bfb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们可以打开飞行模式并运行应用程序。</p><p id="f0ad" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">它会首先显示一个加载微调，和<code class="du jl jm jn jo b">connection_error</code>图标，而不是像这样的照片:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es mb"><img src="../Images/4f1f9eaa75e0ad8434e3738b573c2e69.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*oH5ZItnv8kPhU-eLjG9Vog.png"/></div></figure><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es mb"><img src="../Images/d3f481fb8d605e179994eab532711272.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*03Aw27cSqF2mGj7CgLnJfg.png"/></div></figure><p id="d437" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们已经实现了这个照片应用程序的所有强制功能。让我们考虑一下我们能做些什么改进？</p><p id="13f9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们可以做的一个改进是添加一个持久存储来缓存以前获取的数据，并在应用程序启动时显示这些缓存的数据。同时发送网络请求，当获取新数据时，应用程序会刷新列表以显示新照片。在网络不可用的情况下，应用程序仍然可以显示缓存的数据。这将是一个更好的用户体验。</p><h1 id="175e" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">添加持久存储</h1><p id="de66" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">我们将引入<code class="du jl jm jn jo b">Room</code>来保存数据。</p><blockquote class="if ig ih"><p id="58f7" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">Room persistence库在SQLite上提供了一个抽象层，允许流畅的数据库访问，同时充分利用SQLite的强大功能。特别是，Room提供了以下好处:</p><p id="7702" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">SQL查询的编译时验证。</p><p id="0139" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">最大限度减少重复和容易出错的样板代码的便利注释。</p><p id="136f" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">简化的数据库迁移路径。</p><p id="037d" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">出于这些考虑，我们强烈建议您使用Room，而不是直接使用SQLite API。</p></blockquote><p id="e134" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">(<a class="ae jh" href="https://developer.android.com/training/data-storage/room" rel="noopener ugc nofollow" target="_blank">https://developer.android.com/training/data-storage/room</a>)</p><p id="5329" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">首先，我们需要将以下依赖项添加到<code class="du jl jm jn jo b">build.gradle(Project:Pexels)</code></p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="037b" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">// Room<br/></em>implementation 'androidx.room:room-runtime:2.3.0-rc01'<br/>kapt 'androidx.room:room-compiler:2.3.0-rc01'</span></pre><p id="b4a7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">和<code class="du jl jm jn jo b">Sync Now</code></p><p id="3f1d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">其次，我们需要创建<code class="du jl jm jn jo b">entity</code>类。让我们创建一个新的包<code class="du jl jm jn jo b">database</code>，其中包含所有与数据库相关的文件。</p><p id="8856" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要创建一个数据库实体类，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="260d" class="li jq hi jo b fi lj lk l ll lm">class DatabasePexelsPhoto constructor(<br/>    @PrimaryKey<br/>    val id: String,<br/>    val width: Int = 0,<br/>    val height: Int = 0,<br/>    val url: String = "",<br/>    val photographer: String = "",<br/>    val photographerUrl: String = "",<br/>    val photographerId: Int = 0,<br/>    val avgColor: String = "",<br/>    val src: String = "",<br/>    val liked: Boolean = false)</span></pre><p id="e149" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">而且我们会只在数据库中保存照片，而不是整个<code class="du jl jm jn jo b">Data</code>对象，因为在数据库中保存其他类似<code class="du jl jm jn jo b">page</code>、<code class="du jl jm jn jo b">perPage</code>、<code class="du jl jm jn jo b">totalResults</code>和<code class="du jl jm jn jo b">nextPage</code>的属性是没有意义的。</p><p id="dc38" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要实现一个数据转换功能，因为<code class="du jl jm jn jo b">DatabasePexelsPhoto</code>中的字段类型与<code class="du jl jm jn jo b">Data.Photo</code>中的不同。我们需要将DB中的<code class="du jl jm jn jo b">String</code>转换成<code class="du jl jm jn jo b">Data.Photo.Src</code>对象。</p><p id="8dca" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们在第<code class="du jl jm jn jo b">src = jsonAdapter.fromJson(it.src),</code>行出错。别管它，我们以后会修理它。</p><p id="9461" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要在<code class="du jl jm jn jo b">Data.kt</code>中实现另一个转换函数，将照片数据从<code class="du jl jm jn jo b">Data.Photo</code>转换到<code class="du jl jm jn jo b">DatabasePexelsPhoto</code>，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="51af" class="li jq hi jo b fi lj lk l ll lm">fun List&lt;Data.Photo&gt;.asDatabaseModel(): List&lt;DatabasePexelsPhoto&gt; {<br/>    val moshi = Moshi.Builder()<br/>        .add(KotlinJsonAdapterFactory())<br/>        .build()<br/>    val jsonAdapter = moshi.adapter(Data.Photo.Src::class.<em class="ik">java</em>)<br/><br/>    return <em class="ik">map </em><strong class="jo hj">{<br/>        </strong>DatabasePexelsPhoto(<br/>            id = <strong class="jo hj">it</strong>.id.toString(),<br/>            width = <strong class="jo hj">it</strong>.width,<br/>            height = <strong class="jo hj">it</strong>.height,<br/>            url = <strong class="jo hj">it</strong>.url,<br/>            photographer = <strong class="jo hj">it</strong>.photographer,<br/>            photographerUrl = <strong class="jo hj">it</strong>.photographerUrl,<br/>            photographerId = <strong class="jo hj">it</strong>.photographerId,<br/>            avgColor = <strong class="jo hj">it</strong>.avgColor,<br/>            src =jsonAdapter.toJson(<strong class="jo hj">it</strong>.src),<br/>            liked = <strong class="jo hj">it</strong>.liked<br/>        )<br/>    <strong class="jo hj">}<br/></strong>}</span></pre><p id="6a78" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并将行<code class="du jl jm jn jo b">val src: Src,</code>更新为<code class="du jl jm jn jo b">val src: Src?,</code>以修复之前的错误。</p><p id="4d75" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后是时候造道了。让我们在<code class="du jl jm jn jo b">database</code>包中新建一个文件<code class="du jl jm jn jo b">Room.kt</code>并声明一个接口<code class="du jl jm jn jo b">PexelsPhotoDao</code>，有两个方法<code class="du jl jm jn jo b">getPhotos</code>和<code class="du jl jm jn jo b">insertAll</code>。当这些方法被调用时，<code class="du jl jm jn jo b">Room</code>将从/向数据库获取/插入数据。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="dd61" class="li jq hi jo b fi lj lk l ll lm">@Dao<br/>interface PexelsPhotoDao {<br/>    @Query("select * from databasepexelsphoto")<br/>    fun getPhotos(): LiveData&lt;List&lt;DatabasePexelsPhoto&gt;&gt;<br/><br/>    @Insert(onConflict = OnConflictStrategy.<em class="ik">REPLACE</em>)<br/>    fun insertAll(photos: List&lt;DatabasePexelsPhoto&gt;)<br/>}</span></pre><p id="b4de" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要创建一个Room实例，<code class="du jl jm jn jo b">INSTANCE</code>如下所示，它是整个应用程序中的单例对象。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="0f28" class="li jq hi jo b fi lj lk l ll lm">@Database(entities = [DatabasePexelsPhoto::class], version = 1)<br/>abstract class PexelsPhotoDatabase: RoomDatabase() {<br/>    abstract val pexelsPhotoDao: PexelsPhotoDao<br/>}<br/><br/>private lateinit var <em class="ik">INSTANCE</em>: PexelsPhotoDatabase<br/><br/>fun getDatabase(context: Context): PexelsPhotoDatabase {<br/>    <em class="ik">synchronized</em>(PexelsPhotoDatabase::class.<em class="ik">java</em>) <strong class="jo hj">{<br/>        </strong>if (!::<em class="ik">INSTANCE</em>.<em class="ik">isInitialized</em>) {<br/>            <em class="ik">INSTANCE </em>= Room.databaseBuilder(context.<em class="ik">applicationContext</em>,<br/>                PexelsPhotoDatabase::class.<em class="ik">java</em>,<br/>                "pexelsphoto").build()<br/>        }<br/>    <strong class="jo hj">}<br/>    </strong>return <em class="ik">INSTANCE<br/></em>}</span></pre><p id="cb2c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在我们已经实现了一个接口，用Room从/向数据库中获取/放入数据，但它与网络接口是隔离的。我们需要整合它们。</p><p id="04d3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">根据<a class="ae jh" href="https://developer.android.com/jetpack/guide" rel="noopener ugc nofollow" target="_blank">应用架构指南</a>，它建议单一来源的事实，所以我们将只从数据库获取数据。即使从网络接口获取的新数据将被保存到数据库中而不是直接显示。所以我们需要添加一个存储库模块。</p><p id="f341" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们创建一个新的包，<code class="du jl jm jn jo b">repository</code>，并在这个包中创建一个新的存储库类，<code class="du jl jm jn jo b">PexelsPhotoReposiroty</code>。我们还需要实现一个属性<code class="du jl jm jn jo b">data</code>，它从数据库中读取数据并封装在一个LiveData中，还需要实现一个方法，在该方法中进行一个<code class="du jl jm jn jo b">PexelApi</code>调用并将提取的数据保存到数据库中。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="5d48" class="li jq hi jo b fi lj lk l ll lm">class PexelsPhotoRepository(private val database: PexelsPhotoDatabase) {<br/><br/>    val data: LiveData&lt;Data&gt;<br/>        get() {<br/>            val photos = database.pexelsPhotoDao.getPhotos()<br/>            return Transformations.map(photos) <strong class="jo hj">{<br/>                </strong>Data(<br/>                    page = 0,<br/>                    perPage = 0,<br/>                    photos = <strong class="jo hj">it</strong>.<em class="ik">asDomainModel</em>(),<br/>                    totalResults = <strong class="jo hj">it</strong>.size,<br/>                    nextPage = ""<br/>                )<br/>            <strong class="jo hj">}<br/>        </strong>}<br/><br/>    suspend fun refreshPexelsPhoto(keyword: String) {<br/>        withContext(Dispatchers.IO) <strong class="jo hj">{<br/>            </strong>val data = PexelApi.retrofitService.getDataCoroutine(keyword)<br/>            database.pexelsPhotoDao.insertAll(data.photos.<em class="ik">asDatabaseModel</em>())<br/>        <strong class="jo hj">}<br/>    </strong>}<br/>}</span></pre><p id="4b74" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们用工厂函数<code class="du jl jm jn jo b">Transformations.map()</code>将<code class="du jl jm jn jo b">LiveData&lt;List&lt;DatabasePexelsPhoto&gt;&gt;</code>绑定到<code class="du jl jm jn jo b">LiveData&lt;Data&gt;</code>，工厂函数<code class="du jl jm jn jo b">Transformations.map()</code>观察输入LiveData的变化，并相应地更新输出LiveData。</p><p id="fed9" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们将修改<code class="du jl jm jn jo b">HomeViewModel</code>类，让它从存储库而不是网络API获取数据。</p><p id="70b3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要调用<code class="du jl jm jn jo b">HomeViewModel</code>中的<code class="du jl jm jn jo b">getDatabse</code>来获取<code class="du jl jm jn jo b">PexelsPhotoDatabse</code>的实例，并基于这个数据库对象实例化一个<code class="du jl jm jn jo b">PexelsPhotoRepository</code>的对象。让我们在<code class="du jl jm jn jo b">HomeViewModel</code>类的开头添加下面一行</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="3eea" class="li jq hi jo b fi lj lk l ll lm">private val pexelsPhotoRepository = PexelsPhotoRepository(<em class="ik">getDatabase</em>(application))</span></pre><p id="74ee" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您会注意到，到目前为止我们还没有应用程序实例，所以我们需要用</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="210f" class="li jq hi jo b fi lj lk l ll lm">class HomeViewModel : ViewModel()</span></pre><p id="aa84" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">到</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="83fb" class="li jq hi jo b fi lj lk l ll lm">class HomeViewModel(application: Application) : AndroidViewModel(application)</span></pre><p id="894b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">改变台词</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="2996" class="li jq hi jo b fi lj lk l ll lm">val data: LiveData&lt;Data&gt;<br/>    get() = _data</span></pre><p id="090d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">到</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="5b71" class="li jq hi jo b fi lj lk l ll lm">val data = pexelsPhotoRepository.data</span></pre><p id="b55a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">正如我之前提到的，我们从存储库中获取数据，而不是从数据的后台获取数据，后者将直接从网络API更新。</p><p id="6714" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">是时候抛弃我们从网络API获取数据的代码了。我们不再需要<code class="du jl jm jn jo b">getDataFromNetwork</code>和<em class="ik"> </em> <code class="du jl jm jn jo b">getDataFromNetworkCoroutine</code>了。</p><p id="579e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">但是我们需要实现另一个方法refreshRepository，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="269c" class="li jq hi jo b fi lj lk l ll lm">private fun refreshRepository() {<br/>    val keyword = "panda"<br/>    _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">LOADING<br/>    viewModelScope</em>.<em class="ik">launch </em><strong class="jo hj">{<br/>        </strong>try {<br/>            pexelsPhotoRepository.refreshPexelsPhoto(keyword)<br/>            _response.<em class="ik">value </em>= "Success: Pexel data about ${keyword} is fetched"<br/>            _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">DONE<br/>        </em>} catch (e: Exception) {<br/>            _data.<em class="ik">value </em>= Data(0, 0, <em class="ik">emptyList</em>(), 0, "")<br/>            _response.<em class="ik">value </em>= "Failure: ${e.message}"<br/>            _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">ERROR<br/>        </em>}<br/>    <strong class="jo hj">}<br/></strong>}</span></pre><p id="7b44" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并在<code class="du jl jm jn jo b">init</code>块中调用它，而不是调用<code class="du jl jm jn jo b">getDataFromNetwork</code>或<em class="ik"> </em> <code class="du jl jm jn jo b">getDataFromNetworkCoroutine</code></p><p id="eb47" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">有了这段代码，我们将在应用程序启动时发送网络请求来刷新数据库中的数据。</p><p id="39dd" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要在<code class="du jl jm jn jo b">HomeViewModel</code>类中添加一个内部类<code class="du jl jm jn jo b">Factory</code>，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="0cb2" class="li jq hi jo b fi lj lk l ll lm">class Factory(val app: Application): ViewModelProvider.Factory {<br/>    override fun &lt;T : ViewModel?&gt; create(modelClass: Class&lt;T&gt;): T {<br/>        if (modelClass.isAssignableFrom(HomeViewModel::class.<em class="ik">java</em>)) {<br/>            @Suppress("UNCHECKED_CAST")<br/>            return HomeViewModel(app) as T<br/>        }<br/>        throw IllegalArgumentException("Unable to construct viewmodel")<br/>    }<br/>}</span></pre><p id="9c00" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">当我们在<code class="du jl jm jn jo b">HomeFragment</code>类中实例化<code class="du jl jm jn jo b">HomeViewModel</code>对象时，将使用这个类</p><p id="74e3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要在<code class="du jl jm jn jo b">HomeFragment</code>类中进行最后的修改来替换</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="6a5f" class="li jq hi jo b fi lj lk l ll lm">private val homeViewModel: HomeViewModel by lazy {<br/>        ViewModelProvider(this)<br/>            .get(HomeViewModel::class.java)<br/>    }</span></pre><p id="0909" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">到</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="b1cc" class="li jq hi jo b fi lj lk l ll lm">private val homeViewModel: HomeViewModel by lazy {<br/>        val activity = requireNotNull( this.activity) {<br/>            "You can only access the viewModel after onActivityCreated()"<br/>        }<br/>        ViewModelProvider(this, HomeViewModel.Factory(activity.application))<br/>            .get(HomeViewModel::class.java)<br/>    }</span></pre><p id="7e76" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">当我们实例化<code class="du jl jm jn jo b">HomeViewModel</code>对象时。</p><p id="c523" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在我们会注意到，当应用程序启动时，属性<code class="du jl jm jn jo b">PexelsPhotoRepository.data.get()</code>将被调用来更新<code class="du jl jm jn jo b">HomeViewModel.data</code>，而方法<code class="du jl jm jn jo b">PexelsPhotoRepository.refreshPexelsPhoto()</code>将被调用来更新数据库。</p><p id="eba7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">先用网络连接运行app吧。它会像往常一样加载照片，如下所示:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es mb"><img src="../Images/b93bf83696630a682f4e7ee2ed9edfc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*8lIwAv8P3xjilzFS_HQupQ.png"/></div></figure><p id="67a7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们关掉应用程序，打开飞行模式，再次启动应用程序。你会发现从数据库中读取的数据将首先显示，所以应用程序会知道照片的url，然后一些缓存的照片由<code class="du jl jm jn jo b">Retrofit</code>可以显示如下2截图。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es mb"><img src="../Images/c78fd1438065dbf3264b80f6ac7ea80b.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*ww-cae00Ey2Q1mkFD7pcLA.png"/></div></figure><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es mb"><img src="../Images/b9a0d6763b5a4f59e55313f98e056ddd.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*iMd25az0yqJOWLAk3ayTUA.png"/></div></figure><p id="965c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">但是如果你向下滚动，你会发现一些照片一直在加载。这是因为尽管这些照片的网址是正确的，但它们没有被<code class="du jl jm jn jo b">Retrofit</code>缓存。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es mb"><img src="../Images/88a6b2ca49b6bd95f1ca52d16b9a8fa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*TyqpRVNOwwiKDn5y-KT7xA.png"/></div></figure><p id="e34b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在，我们已经完成了从网络获取数据，将照片保存在数据库中，并以单源真实方式在RecyclerView中显示这些照片的部分。</p><p id="0cf0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">但你可能会注意到，当应用程序启动时，我们只获取了20张照片的数据一次，所以它不会获取更多照片。我们还会注意到，<code class="du jl jm jn jo b">Pexels</code> API实际上支持带有查询参数<code class="du jl jm jn jo b">page</code>的分页，所以在下一章，我们将为我们的应用程序添加分页。</p><h1 id="92a6" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">添加分页</h1><p id="2aaf" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">我们计划做的是，当用户滚动到列表底部时，获取下一页的照片。</p><p id="1221" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们打开<code class="du jl jm jn jo b">PexelsPhotoRespository.kt</code>并添加属性<code class="du jl jm jn jo b">data</code>的backfield，因为我们需要保存http响应中的<code class="du jl jm jn jo b">nextPage</code> url，但我们不想保存在数据库中。因此，修改属性<code class="du jl jm jn jo b">data</code>如下:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="8dbb" class="li jq hi jo b fi lj lk l ll lm"><strong class="jo hj">val _data = MutableLiveData&lt;Data&gt;()<br/></strong>val data: LiveData&lt;Data&gt;<br/>    get() {<br/>        val photos = database.pexelsPhotoDao.getPhotos()<br/>        return Transformations.map(photos) <strong class="jo hj">{<br/>            </strong>Data(<br/><strong class="jo hj">                page = _data.<em class="ik">value</em>?.page ?: 0,<br/>                perPage = _data.<em class="ik">value</em>?.perPage ?: 0,<br/></strong>                photos = <strong class="jo hj">it</strong>.<em class="ik">asDomainModel</em>(),<br/>                totalResults = <strong class="jo hj">it</strong>.size,<br/><strong class="jo hj">                nextPage = _data.<em class="ik">value</em>?.nextPage ?: ""<br/></strong>            )<br/>        <strong class="jo hj">}<br/>    </strong>}</span></pre><p id="adb8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要修改方法<code class="du jl jm jn jo b">refreshPexelsPhoto</code>,如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="242a" class="li jq hi jo b fi lj lk l ll lm">suspend fun refreshPexelsPhoto(keyword: String, pageIndex: Int) {<br/>    lateinit var data: Data<br/>    withContext(Dispatchers.IO) <strong class="jo hj">{<br/>        </strong>data = PexelApi.retrofitService.getDataCoroutine(keyword, pageIndex = pageIndex)<br/>        database.pexelsPhotoDao.insertAll(data.photos.<em class="ik">asDatabaseModel</em>())<br/>    <strong class="jo hj">}<br/>    </strong>_data.<em class="ik">value </em>= data<br/>}</span></pre><p id="5f64" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们做了两个改变，一个是添加了一个新的参数，<code class="du jl jm jn jo b">pageIndex</code>用于让<code class="du jl jm jn jo b">PexelApi</code>知道获取哪个页面，另一个是保存响应<code class="du jl jm jn jo b">data</code>。</p><p id="08e8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们需要更新<code class="du jl jm jn jo b">HomeViewModel</code>类，如下所示</p><p id="6f11" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">首先，我们需要将方法<code class="du jl jm jn jo b">refreshRepository</code>改为public，这样就可以从片段中调用它。我们还需要如下更新此方法:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="b135" class="li jq hi jo b fi lj lk l ll lm"><strong class="jo hj">fun refreshRepository() {<br/></strong>    val keyword = "panda"<br/><strong class="jo hj">    val nextPageUri = data.<em class="ik">value</em>?.nextPage?.<em class="ik">toUri</em>()<br/>    val pageIndex = nextPageUri?.getQueryParameter("page")?.<em class="ik">toInt</em>() ?: 0<br/></strong>    _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">LOADING<br/>    viewModelScope</em>.<em class="ik">launch </em><strong class="jo hj">{<br/>        </strong>try {<br/><strong class="jo hj">            pexelsPhotoRepository.refreshPexelsPhoto(keyword, pageIndex = pageIndex)</strong></span><span id="de03" class="li jq hi jo b fi mc lk l ll lm">            ......<br/>    <strong class="jo hj">}<br/></strong>}</span></pre><p id="94a7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">其次，让我们更新<code class="du jl jm jn jo b">PhotoGridAdapter</code>类，当用户滚动到列表底部时做一些事情。</p><p id="0509" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要给<code class="du jl jm jn jo b">PhotoGridAdapter</code>的签名添加一个新参数<code class="du jl jm jn jo b">onScrollToBottom</code>，它是一个传入的函数，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="36ec" class="li jq hi jo b fi lj lk l ll lm">class PhotoGridAdapter<strong class="jo hj">(private val onScrollToBottom: () -&gt; Unit)</strong>: ListAdapter&lt;Data.Photo, PhotoGridAdapter.PhotoGridViewHolder&gt;(DiffCallback)</span></pre><p id="9959" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并调用此函数<code class="du jl jm jn jo b">onScrollToBottom</code>，当滚动到列表底部时用<code class="du jl jm jn jo b">onBindViewHolder</code>方法如下:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="f285" class="li jq hi jo b fi lj lk l ll lm">override fun onBindViewHolder(holder: PhotoGridViewHolder, position: Int) {<br/>    val photo = getItem(position)<br/><strong class="jo hj">    if (position == <em class="ik">itemCount </em>- 1) {<br/>        onScrollToBottom()<br/>    }<br/></strong>    holder.bind(photo)<br/>}</span></pre><p id="e5b3" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">最后，让我们将函数<code class="du jl jm jn jo b">homeViewModel.getDataFromRepository()</code>传递给在<code class="du jl jm jn jo b">HomeFragment</code>类中实例化的<code class="du jl jm jn jo b">PhotoGridAdapter</code>对象，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="d219" class="li jq hi jo b fi lj lk l ll lm">override fun onCreateView(<br/>        inflater: LayoutInflater,<br/>        container: ViewGroup?,<br/>        savedInstanceState: Bundle?<br/>): View? {<br/>    val binding = FragmentHomeBinding.inflate(inflater)<br/><br/>    <em class="ik">// Allows Data Binding to Observe LiveData with the lifecycle of this Fragment<br/>    </em>binding.<em class="ik">lifecycleOwner </em>= this<br/><br/>    <em class="ik">// Giving the binding access to the OverviewViewModel<br/>    </em>binding.<em class="ik">viewModel </em>= homeViewModel<br/><br/><strong class="jo hj">    binding.photosGrid.<em class="ik">adapter </em>= PhotoGridAdapter() {homeViewModel.refreshRepository()}<br/><br/>    </strong>return binding.<em class="ik">root<br/></em>}</span></pre><p id="8370" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们运行应用程序，向下滚动到列表的底部。我们会看到下一页的照片将被加载。如果你继续滚动，将会加载越来越多的照片。</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es md"><img src="../Images/5792bde7979f02359ce52813bd734e4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:544/1*zsyjeWM6Mjawh5-rKMrnrA.gif"/></div></figure><p id="0bdb" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在我们已经完成了分页。当滚动到当前列表的底部时，它将获取下一页数据。还因为所有提取的照片将被添加到数据库中，所以重复的照片将被替换。</p><p id="e89e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">到目前为止一切顺利。但是，您可能会注意到所有照片都是熊猫，因为查询关键字被硬编码为熊猫。所以在下一章，我们将添加一个搜索视图让用户输入关键字。</p><h1 id="3c69" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">添加搜索视图</h1><p id="9fc7" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">首先，我们需要向<code class="du jl jm jn jo b">PexelsPhotoDao</code>接口添加一个新的API，<code class="du jl jm jn jo b">clearAll</code>，它用于在关键字发生变化时清理数据库表。让我们打开<code class="du jl jm jn jo b">Room.kt</code>，将下面的方法添加到<code class="du jl jm jn jo b">PexelsPhotoDao</code>界面。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="6a6f" class="li jq hi jo b fi lj lk l ll lm">@Query("delete from databasepexelsphoto")<br/>fun clearAll()</span></pre><p id="0628" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要添加一个新方法<code class="du jl jm jn jo b">clearDatabase</code>，作为<code class="du jl jm jn jo b">PexelsPhotoRepository</code>类的后续方法。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="f4a5" class="li jq hi jo b fi lj lk l ll lm">suspend fun clearDatabase() {<br/>    withContext(Dispatchers.IO) <strong class="jo hj">{<br/>        </strong>database.pexelsPhotoDao.clearAll()<br/>    <strong class="jo hj">}<br/></strong>}</span></pre><p id="d34e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">它是一个在IO线程上运行的挂起函数，因为数据库操作也是一个长时间运行的任务。</p><p id="0859" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们需要更新<code class="du jl jm jn jo b">HomeViewModel</code>。让我们打开<code class="du jl jm jn jo b">HomeViewModel.kt</code>，在<code class="du jl jm jn jo b">refreshRepository</code>方法中添加一个新参数<code class="du jl jm jn jo b">keyword</code>，如下所示，并相应地修改实现:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="9acc" class="li jq hi jo b fi lj lk l ll lm">fun refreshRepository(<strong class="jo hj">keyword: String = ""</strong>) {<br/><strong class="jo hj">    if (keyword.<em class="ik">isEmpty</em>()) {<br/>        _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">DONE<br/>    </em>} else {<br/></strong>        val nextPageUri = data.<em class="ik">value</em>?.nextPage?.<em class="ik">toUri</em>()<br/>        .....<br/>        pexelsPhotoRepository.refreshPexelsPhoto(keyword, pageIndex = pageIndex)<br/>        ......<br/>       _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">ERROR<br/>    </em>}<br/><strong class="jo hj">}</strong></span></pre><p id="4d63" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这一变化表明，如果关键字为空，我们除了将<code class="du jl jm jn jo b">status</code>设置为<code class="du jl jm jn jo b">DONE</code>之外什么也不做，否则，我们将在调用<code class="du jl jm jn jo b">pexelsPhotoRepository.refreshPexelsPhoto</code>方法时使用该关键字获取数据。</p><p id="95f4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您可能想要修改方法<code class="du jl jm jn jo b">getDataFromNetworkCoroutine</code>和<code class="du jl jm jn jo b">getDataFromNetwork</code>，尽管它们已经不再使用。</p><p id="0a96" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们需要在<code class="du jl jm jn jo b">HomeViewModel</code>类中添加另一个私有方法<code class="du jl jm jn jo b">clearDataFromDatabase</code></p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="cefd" class="li jq hi jo b fi lj lk l ll lm">private fun clearDataFromDatabase() {<br/>    <em class="ik">viewModelScope</em>.<em class="ik">launch </em><strong class="jo hj">{<br/>        </strong>try {<br/>            pexelsPhotoRepository.clearDatabase()<br/>        } catch (e: Exception) {<br/>            _response.<em class="ik">value </em>= "Failure: ${e.message}"<br/>            _status.<em class="ik">value </em>= PexelsApiStatus.<em class="ik">DONE<br/>        </em>}<br/>    <strong class="jo hj">}<br/></strong>}</span></pre><p id="b06c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这个方法会调用<code class="du jl jm jn jo b">pexelsPhotoRepository.clearDatabase()</code>来清理数据库中的数据。</p><p id="c89c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，我们需要添加一个新的方法<code class="du jl jm jn jo b">updateKeyword</code>，如下所示，当关键字发生变化时，将从<code class="du jl jm jn jo b">HomeFragment</code>调用该方法。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="2b15" class="li jq hi jo b fi lj lk l ll lm">fun updateKeyword( keyword: String) {<br/>    clearDataFromDatabase()<br/>    refreshRepository(keyword)<br/>}</span></pre><p id="3786" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">这种方法非常简单，只需清理数据库，并用new关键字获取新数据。</p><p id="3d69" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在我们已经更新了<code class="du jl jm jn jo b">PexelsPhotoDao</code>、<code class="du jl jm jn jo b">PexelsPhotoRepository</code>、<code class="du jl jm jn jo b">HomeViewModel</code>，是时候更新视图了、<code class="du jl jm jn jo b">HomeFragment</code>。</p><p id="a371" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要做的第一件事是添加一个<code class="du jl jm jn jo b">SearchView</code>和相应的监听器到<code class="du jl jm jn jo b">HomeFragment</code>类，允许用户输入关键字。</p><p id="399a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们在<code class="du jl jm jn jo b">./res/menu</code>文件夹中创建一个新的xml文件<code class="du jl jm jn jo b">home.xml</code>，并在其中添加一项，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="991c" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">&lt;?</em>xml version="1.0" encoding="utf-8"<em class="ik">?&gt;<br/></em>&lt;menu xmlns:android="http://schemas.android.com/apk/res/android"<br/>    <strong class="jo hj">xmlns:app="http://schemas.android.com/apk/res-auto"</strong>&gt;<br/><strong class="jo hj">    &lt;item android:id="@+id/action_search"<br/>        android:title=""<br/>        android:icon="@android:drawable/ic_menu_search"<br/>        app:actionViewClass="androidx.appcompat.widget.SearchView"<br/>        app:showAsAction="always"/&gt;<br/></strong>&lt;/menu&gt;</span></pre><p id="c91a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们需要打开<code class="du jl jm jn jo b">HomeFragment.kt</code>，给<code class="du jl jm jn jo b">HomeFragment</code>类添加一个新的接口<code class="du jl jm jn jo b">androidx.appcompat.widget.SearchView.OnQueryTextListener</code>，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="36d6" class="li jq hi jo b fi lj lk l ll lm">class HomeFragment : Fragment()<strong class="jo hj">, androidx.appcompat.widget.SearchView.OnQueryTextListener</strong></span></pre><p id="139f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并添加一个私有属性<code class="du jl jm jn jo b">keyword</code>来保存用户输入的关键字，如下所示。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="5d5a" class="li jq hi jo b fi lj lk l ll lm">private var keyword = ""</span></pre><p id="2326" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">实例化<code class="du jl jm jn jo b">SearchView</code>并在<code class="du jl jm jn jo b">onCreateView</code>方法下实现监听器，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="31ca" class="li jq hi jo b fi lj lk l ll lm">private var searchView: androidx.appcompat.widget.SearchView? = null<br/>override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {<br/>    inflater.inflate(R.menu.<em class="ik">home</em>, menu)<br/>    searchView = menu.findItem(R.id.<em class="ik">action_search</em>)?.<em class="ik">let </em><strong class="jo hj">{<br/>        it</strong>.<em class="ik">actionView </em>as? androidx.appcompat.widget.SearchView<br/>    <strong class="jo hj">}</strong>?.<em class="ik">apply </em><strong class="jo hj">{<br/>        </strong>(<em class="ik">activity</em>?.getSystemService(Context.<em class="ik">SEARCH_SERVICE</em>) as? SearchManager)?.<em class="ik">also </em><strong class="jo hj">{<br/>            </strong>setSearchableInfo(<strong class="jo hj">it</strong>.getSearchableInfo(<em class="ik">activity</em>?.<em class="ik">componentName</em>))<br/>        <strong class="jo hj">}<br/>        </strong><em class="ik">maxWidth </em>= Int.MAX_VALUE<br/><br/>        setIconifiedByDefault(false)<br/>        <em class="ik">isIconified </em>= false<br/>        <em class="ik">isSubmitButtonEnabled </em>= false<br/>        setOnQueryTextListener(this@HomeFragment)<br/>        requestFocus()<br/>        <em class="ik">layoutParams </em>= ActionBar.LayoutParams(<br/>            ActionBar.LayoutParams.<em class="ik">MATCH_PARENT</em>,<br/>            ActionBar.LayoutParams.<em class="ik">MATCH_PARENT</em>)<br/>    <strong class="jo hj">}<br/></strong>}<br/><br/>override fun onQueryTextSubmit(query: String?): Boolean {<br/>    return query?.<em class="ik">let </em><strong class="jo hj">{<br/>        </strong>if (<strong class="jo hj">it</strong>.length &lt; 2) { return@let false }<br/>        keyword = <strong class="jo hj">it<br/>        </strong>homeViewModel.updateKeyword(keyword)<br/>        searchView?.clearFocus()<br/>        true<br/>    <strong class="jo hj">} </strong>?: false<br/>}<br/><br/>override fun onQueryTextChange(newText: String?): Boolean {<br/>    return true<br/>}</span></pre><p id="6681" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在这段代码中，我们将初始化一个<code class="du jl jm jn jo b">SearchView</code>并将它绑定到<code class="du jl jm jn jo b">home</code>菜单中的<code class="du jl jm jn jo b">action_search</code>，它实现了搜索行为。我们还实现了监听器<code class="du jl jm jn jo b">onQueryTextSubmit</code>，当用户点击键盘上的<code class="du jl jm jn jo b">search</code>图标时会被调用，并触发<code class="du jl jm jn jo b">homeViewModel.updateKeyword()</code>方法，以及<code class="du jl jm jn jo b">onQueryTextChange</code>指示输入文本被更改。</p><p id="5c8a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要在onCreateView方法的开头添加如下菜单:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="1545" class="li jq hi jo b fi lj lk l ll lm">override fun onCreateView(<br/>        inflater: LayoutInflater,<br/>        container: ViewGroup?,<br/>        savedInstanceState: Bundle?<br/>): View? {<br/><strong class="jo hj">    setHasOptionsMenu(true)<br/></strong>    val binding = FragmentHomeBinding.inflate(inflater)<br/>    ......</span><span id="753b" class="li jq hi jo b fi mc lk l ll lm">    binding.photosGrid.<em class="ik">adapter </em>= PhotoGridAdapter( PhotoGridAdapter.OnClickListener <strong class="jo hj">{<br/>        </strong>homeViewModel.displayPhotoDetails(it)<br/>    <strong class="jo hj">}</strong>) <strong class="jo hj">{</strong>homeViewModel.refreshRepository(<strong class="jo hj">keyword</strong>)<strong class="jo hj">}</strong></span><span id="8546" class="li jq hi jo b fi mc lk l ll lm">    ......<br/>}</span></pre><p id="5479" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">小心，我们在调用<code class="du jl jm jn jo b">homeViewModel.refreshRepository</code>的时候也加了一个参数<code class="du jl jm jn jo b">keyword</code>，否则什么都取不到。</p><p id="7e8f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在让我们运行应用程序，你会在<code class="du jl jm jn jo b">Home</code>页面的<code class="du jl jm jn jo b">ActionBar</code>处发现一个新的<code class="du jl jm jn jo b">SearchView</code>，如下图所示。然后你可以在<code class="du jl jm jn jo b">SearchView</code>中输入关键字，如<code class="du jl jm jn jo b">gorilla</code>，点击键盘上的<code class="du jl jm jn jo b">search</code>图标。</p><p id="7f16" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">它会获取带有新关键字gorilla的照片，并更新数据库，然后像这样刷新列表:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es md"><img src="../Images/824480c523d7c6be012247d23f7eef16.png" data-original-src="https://miro.medium.com/v2/resize:fit:544/1*rtKx2RJLdVZBW9vPN2IyWQ.gif"/></div></figure><p id="a3e0" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">到目前为止，这款应用相当不错，功能齐全。你还需要什么增强功能？也许另一个页面可以显示单张照片的详细信息。当你点击列表中的一张照片时，它会导航到新的<code class="du jl jm jn jo b">Detail</code>页面。让我们在下一章实现它。</p><h1 id="425a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">添加详细信息页面</h1><p id="444b" class="pw-post-body-paragraph ii ij hi il b im kn io ip iq ko is it ji kp iw ix jj kq ja jb jk kr je jf jg hb bi translated">我们将使用<a class="ae jh" href="https://developer.android.com/guide/navigation" rel="noopener ugc nofollow" target="_blank"> Android导航组件</a>实现从<code class="du jl jm jn jo b">Home</code>页面到<code class="du jl jm jn jo b">Detail</code>页面的导航，因此我们需要在<code class="du jl jm jn jo b">build.gradle(Module:Pexls.app)</code>的<code class="du jl jm jn jo b">dependencies</code>部分添加以下依赖项</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="5f7f" class="li jq hi jo b fi lj lk l ll lm"><em class="ik">// Navigation<br/></em>implementation 'androidx.navigation:navigation-fragment-ktx:2.3.4'<br/>implementation 'androidx.navigation:navigation-ui-ktx:2.3.4'</span></pre><p id="ce14" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们将使用一个新的功能，<code class="du jl jm jn jo b">navigation-safe-args</code>，所以我们需要添加更多的插件和依赖</p><p id="4676" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们打开<code class="du jl jm jn jo b">build.gradle(Project:Pexels)</code>，在<code class="du jl jm jn jo b">dependencies</code>块中添加如下几行:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="b867" class="li jq hi jo b fi lj lk l ll lm">dependencies <strong class="jo hj">{<br/>        </strong>classpath "com.android.tools.build:gradle:4.1.1"<br/>        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"<br/>        <strong class="jo hj">classpath "androidx.navigation:navigation-safe-args-gradle-plugin:2.3.4"</strong><br/><br/>        <em class="ik">// NOTE: Do not place your application dependencies here; they belong<br/>        // in the individual module build.gradle files<br/>    </em><strong class="jo hj">}<br/>}</strong></span></pre><p id="4880" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">再次打开build.gradle(Module:Pexels.app)将另一个插件添加到plugins部分，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="9306" class="li jq hi jo b fi lj lk l ll lm">plugins <strong class="jo hj">{<br/>    </strong>id 'com.android.application'<br/>    id 'kotlin-android'<br/>    id 'kotlin-android-extensions'<br/>    id 'kotlin-kapt'<br/>    <strong class="jo hj">id 'androidx.navigation.safeargs.kotlin'</strong><br/><strong class="jo hj">}</strong></span></pre><p id="47ec" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">立即同步</p><p id="5c59" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们将在下一步为<code class="du jl jm jn jo b">Detail</code>页面添加<code class="du jl jm jn jo b">ViewModel</code>。</p><p id="1c41" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">为了项目的干净，我们先在<code class="du jl jm jn jo b">ui</code>包中创建新包<code class="du jl jm jn jo b">detail</code>。</p><p id="2800" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要在这个包中创建一个新类<code class="du jl jm jn jo b">DetailViewModel</code>，并更新代码如下:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="829e" class="li jq hi jo b fi lj lk l ll lm">class DetailViewModel(photo: Data.Photo, app: Application): AndroidViewModel(app) {<br/>    private val _photo = MutableLiveData&lt;Data.Photo&gt;()<br/>    val photo: LiveData&lt;Data.Photo&gt;<br/>        get() = _photo<br/><br/>    init {<br/>        _photo.<em class="ik">value </em>= photo<br/>    }<br/>}</span></pre><p id="2f36" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">它非常类似于<code class="du jl jm jn jo b">HomeViewModel</code>类，因为我们刚刚在其中创建了一个LiveData属性<code class="du jl jm jn jo b">photo</code>，来表示要显示的照片。</p><p id="ed41" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要添加一个<code class="du jl jm jn jo b">ViewModelProvider.Factory</code>的子类，用于检查创建的视图模型的类型是否正确，因为我们需要向它传递一些参数。在<code class="du jl jm jn jo b">init</code>块下添加以下代码。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="b879" class="li jq hi jo b fi lj lk l ll lm">class Factory( private val photo: Data.Photo,<br/>               private val app: Application): ViewModelProvider.Factory {<br/>    @Suppress("UNCHECKED_CAST")<br/>    override fun &lt;T : ViewModel?&gt; create(modelClass: Class&lt;T&gt;): T {<br/>        if (modelClass.isAssignableFrom(DetailViewModel::class.<em class="ik">java</em>)) {<br/>            return DetailViewModel( photo, app) as T<br/>        }<br/>        throw IllegalArgumentException("Unknown View class")<br/>    }<br/><br/>}</span></pre><p id="dd85" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在，我们已经完成了<code class="du jl jm jn jo b">Detail</code>页面的<code class="du jl jm jn jo b">ViewModel</code>。是时候实现<code class="du jl jm jn jo b">View</code>部分了。</p><p id="68be" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们用<code class="du jl jm jn jo b">BlankFragment</code>模板创建一个新的片段<code class="du jl jm jn jo b">DetailFragment</code>。你会注意到会创建两个新文件，<code class="du jl jm jn jo b">DetailFragment.kt</code>和<code class="du jl jm jn jo b">fragment_detail.xml</code>。</p><p id="246a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">先更新一下<code class="du jl jm jn jo b">fragment_detail.xml</code>吧。</p><p id="1948" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">为了使用<code class="du jl jm jn jo b">DataBinding</code>，我们需要移除整个<code class="du jl jm jn jo b">FrameLayout</code>部分，并添加如下的<code class="du jl jm jn jo b">layout</code>部分。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="19ad" class="li jq hi jo b fi lj lk l ll lm">&lt;layout xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:app="http://schemas.android.com/apk/res-auto"<br/>    xmlns:tools="http://schemas.android.com/tools"&gt;<br/>&lt;/layout&gt;</span></pre><p id="259f" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要在<code class="du jl jm jn jo b">layout</code>块中添加一个带有<code class="du jl jm jn jo b">variable</code>块的<code class="du jl jm jn jo b">data</code>块，用于声明变量的名称和类型，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="f63e" class="li jq hi jo b fi lj lk l ll lm">&lt;data&gt;<br/>    &lt;variable<br/>        name="viewModel"<br/>        type="com.ovlesser.pexels.ui.detail.DetailViewModel" /&gt;<br/>&lt;/data&gt;</span></pre><p id="85ff" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要在<code class="du jl jm jn jo b">data</code>部分添加一些组件，如下:<code class="du jl jm jn jo b">image</code>、<code class="du jl jm jn jo b">id</code>、<code class="du jl jm jn jo b">size</code>(宽*高)、<code class="du jl jm jn jo b">url</code>和<code class="du jl jm jn jo b">photographer</code></p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="7a54" class="li jq hi jo b fi lj lk l ll lm">&lt;ScrollView<br/>    &lt;androidx.constraintlayout.widget.ConstraintLayout<br/>        android:layout_width="match_parent"<br/>        android:layout_height="wrap_content"<br/>        android:padding="16dp"&gt;<br/><br/>        &lt;ImageView<br/>            android:id="@+id/detail_photo"<br/>            android:layout_width="0dp"<br/>            android:layout_height="226dp"<br/>            app:layout_constraintEnd_toEndOf="parent"<br/>            app:layout_constraintStart_toStartOf="parent"<br/>            app:layout_constraintTop_toTopOf="parent"<br/>            app:imageUrl="@{viewModel.photo.src.medium}"<br/>            tools:src="@tools:sample/backgrounds/scenic" /&gt;<br/>        <br/>        &lt;TextView<br/>            android:id="@+id/detail_id"<br/>            android:layout_width="wrap_content"<br/>            android:layout_height="wrap_content"<br/>            android:layout_marginTop="16dp"<br/>            android:textColor="#de000000"<br/>            android:text="@{String.valueOf(viewModel.photo.id)}"<br/>            app:layout_constraintStart_toStartOf="parent"<br/>            app:layout_constraintTop_toBottomOf="@+id/detail_photo" /&gt;<br/><br/>        &lt;TextView<br/>            android:id="@+id/detail_size"<br/>            android:layout_width="wrap_content"<br/>            android:layout_height="wrap_content"<br/>            android:layout_marginTop="16dp"<br/>            android:textColor="#de000000"<br/>            android:text="@{viewModel.size}"<br/>            app:layout_constraintStart_toStartOf="parent"<br/>            app:layout_constraintTop_toBottomOf="@+id/detail_id" /&gt;<br/><br/>        &lt;TextView<br/>            android:id="@+id/detail_url"<br/>            android:layout_width="wrap_content"<br/>            android:layout_height="wrap_content"<br/>            android:layout_marginTop="16dp"<br/>            android:textColor="#de000000"<br/>            android:text="@{viewModel.photo.url}"<br/>            app:layout_constraintStart_toStartOf="parent"<br/>            app:layout_constraintTop_toBottomOf="@+id/detail_size" /&gt;<br/><br/>        &lt;TextView<br/>            android:id="@+id/detail_photographer"<br/>            android:layout_width="wrap_content"<br/>            android:layout_height="wrap_content"<br/>            android:layout_marginTop="16dp"<br/>            android:textColor="#de000000"<br/>            android:text="@{viewModel.photo.photographer}"<br/>            app:layout_constraintStart_toStartOf="parent"<br/>            app:layout_constraintTop_toBottomOf="@+id/detail_url" /&gt;<br/><br/>    &lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;<br/>&lt;/ScrollView&gt;</span></pre><p id="e4ee" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们将显示照片图像的<code class="du jl jm jn jo b">ImageView</code>和显示其他信息的其他<code class="du jl jm jn jo b">TextView</code>放在<code class="du jl jm jn jo b">ScrollView</code>中，以使整个布局可滚动，以防图像过大。</p><p id="cc81" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还设置了<code class="du jl jm jn jo b">app:imageUrl="@{viewModel.photo.src.medium}"</code>来设置<code class="du jl jm jn jo b">ImageView</code>的源</p><p id="19dc" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">您可能会注意到在<code class="du jl jm jn jo b">android:text=”@{viewModel.size}”</code>处突出显示了一个错误，这是因为在<code class="du jl jm jn jo b">DetailViewModel</code>类中没有名为<code class="du jl jm jn jo b">size</code>的属性或方法。要解决这个问题，我们需要将属性<code class="du jl jm jn jo b">size</code>添加到<code class="du jl jm jn jo b">DetailViewModel</code>中，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="75ab" class="li jq hi jo b fi lj lk l ll lm">val size = Transformations.map(this.photo) <strong class="jo hj">{<br/>    </strong>"${<strong class="jo hj">it</strong>.width} * ${<strong class="jo hj">it</strong>.height}"<br/><strong class="jo hj">}</strong></span></pre><p id="b42e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们会找到属性<code class="du jl jm jn jo b">DetailViewModel.size</code></p><p id="0606" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">下一步我们要做的是更新数据模型，因为我们需要将参数传递到<code class="du jl jm jn jo b">Detail</code>页面，以指示从<code class="du jl jm jn jo b">Home</code>页面的列表中选择了哪个项目。而且这个参数必须是可序列化或可打包的，所以我们需要更新<code class="du jl jm jn jo b">Data</code>、<code class="du jl jm jn jo b">Data.Photo</code>和<code class="du jl jm jn jo b">Data.Photo.Src</code>，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="2bcd" class="li jq hi jo b fi lj lk l ll lm"><strong class="jo hj">@Parcelize</strong><br/>data class Data(<br/>    val page: Int = 0,<br/>    @Json(name = "per_page") val perPage: Int = 0,<br/>    val photos: List&lt;Photo&gt;,<br/>    @Json(name = "total_results") val totalResults: Int = 0,<br/>    @Json(name = "next_page") val nextPage: String = ""<br/>)<strong class="jo hj">: Parcelable</strong> {<br/>    <strong class="jo hj">@Parcelize</strong><br/>    data class Photo(<br/>        val id: Int,<br/>        val width: Int = 0,<br/>        val height: Int = 0,<br/>        val url: String = "",<br/>        val photographer: String = "",<br/>        @Json(name = "photographer_url") val photographerUrl: String = "",<br/>        @Json(name = "photographer_id") val photographerId: Int = 0,<br/>        @Json(name = "avg_color") val avgColor: String = "",<br/>        val src: Src? = null,<br/>        val liked: Boolean = false,<br/>    )<strong class="jo hj">: Parcelable</strong> {<br/>        <strong class="jo hj">@Parcelize</strong><br/>        data class Src(<br/>            val original: String = "",<br/>            val large2x: String = "",<br/>            val large: String = "",<br/>            val medium: String = "",<br/>            val small: String = "",<br/>            val portrait: String = "",<br/>            val landscape: String = "",<br/>            val tiny: String = ""<br/>        )<strong class="jo hj">: Parcelable</strong><br/>    }<br/>}</span></pre><p id="703e" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还将默认值添加到一些属性中，以简化后面的<code class="du jl jm jn jo b">Data</code>对象的实例化。</p><p id="3512" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">有趣的是，我们将使用导航图来实现导航。</p><p id="903b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们打开<code class="du jl jm jn jo b">./res/layout/navigation/mobile-navagation.xml</code>文件，添加一个新的片段段，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="bfbf" class="li jq hi jo b fi lj lk l ll lm">&lt;navigation xmlns:android="http://schemas.android.com/apk/res/android"<br/>    ......<br/>    app:startDestination="@+id/navigation_home"&gt;<br/><br/>    &lt;fragment<br/>       ......<br/>       tools:layout="@layout/fragment_notifications" /&gt;<br/><br/><strong class="jo hj">    &lt;fragment<br/>        android:id="@+id/navigation_detail"<br/>        android:name="com.ovlesser.pexels.ui.detail.DetailFragment"<br/>        android:label="@string/title_detail"<br/>        tools:layout="@layout/fragment_detail" /&gt;<br/></strong>&lt;/navigation&gt;</span></pre><p id="330a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">作为新的导航目的地。我们还将字符串文字<code class="du jl jm jn jo b">title_detail</code>添加到<code class="du jl jm jn jo b">./res/values/string.xml</code>中，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="bcf3" class="li jq hi jo b fi lj lk l ll lm">&lt;string name="title_detail"&gt;Detail&lt;/string&gt;</span></pre><p id="8c44" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，让我们将动作添加到<code class="du jl jm jn jo b">Home</code>片段中，如下所示，使我们从<code class="du jl jm jn jo b">Home</code>片段到<code class="du jl jm jn jo b">Detail</code>片段</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="e5fe" class="li jq hi jo b fi lj lk l ll lm">&lt;fragment<br/>    android:id="@+id/navigation_home"<br/>    android:name="com.ovlesser.pexels.ui.home.HomeFragment"<br/>    android:label="@string/title_home"<br/>    tools:layout="@layout/fragment_home"<strong class="jo hj">&gt;<br/>    &lt;action<br/>        android:id="@+id/action_showDetail"<br/>        app:destination="@id/navigation_detail" /&gt;<br/>&lt;/fragment&gt;</strong></span></pre><p id="1503" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要将<code class="du jl jm jn jo b">argument</code>块添加到<code class="du jl jm jn jo b">Detail</code>片段中，如下所示，以定义将从<code class="du jl jm jn jo b">Home</code>片段传递到<code class="du jl jm jn jo b">Detail</code>片段的参数类型。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="6ef3" class="li jq hi jo b fi lj lk l ll lm">&lt;fragment<br/>    android:id="@+id/navigation_detail"<br/>    android:name="com.ovlesser.pexels.ui.detail.DetailFragment"<br/>    android:label="@string/title_detail"<br/>    tools:layout="@layout/fragment_detail"<strong class="jo hj">&gt;<br/>    &lt;argument<br/>        android:name="photo"<br/>        app:argType="com.ovlesser.pexels.data.Data$Photo" /&gt;<br/>&lt;/fragment&gt;</strong></span></pre><p id="87d1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">小心<code class="du jl jm jn jo b">Data</code>和<code class="du jl jm jn jo b">Photo</code>之间的<code class="du jl jm jn jo b">$</code>，因为<code class="du jl jm jn jo b">Photo</code>是<code class="du jl jm jn jo b">Data</code>的内部类，它实际上在这里使用了反射。</p><p id="cb8d" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">在这一步之后，您可能需要关闭项目/清理项目以确保类<code class="du jl jm jn jo b">DetailFragmentArgs</code>被生成(如果它不是自动生成的)。</p><p id="b240" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在，我们需要更新<code class="du jl jm jn jo b">DetailFragment</code>类。让我们打开<code class="du jl jm jn jo b">DetailFragment.kt</code>并删除所有模板代码，用下面的代码替换onCreateView方法</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="799d" class="li jq hi jo b fi lj lk l ll lm">override fun onCreateView(<br/>    inflater: LayoutInflater, container: ViewGroup?,<br/>    savedInstanceState: Bundle?<br/>): View? {<br/>    val application = <em class="ik">requireNotNull</em>(<em class="ik">activity</em>).<em class="ik">application<br/>    </em>val binding = FragmentDetailBinding.inflate(inflater)<br/>    binding.<em class="ik">lifecycleOwner </em>= this<br/><br/>    val photo = DetailFragmentArgs.fromBundle(requireArguments()).photo<br/>    val viewModelFactory = DetailViewModel.Factory( photo, application)<br/>    binding.<em class="ik">viewModel </em>= ViewModelProvider(<br/>        this, viewModelFactory).get(DetailViewModel::class.<em class="ik">java</em>)<br/>    return binding.<em class="ik">root<br/></em>}</span></pre><p id="06c8" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">当<code class="du jl jm jn jo b">DetailFragment</code>被初始化时，我们将从<code class="du jl jm jn jo b">requireArguments()</code>获得一个<code class="du jl jm jn jo b">Photo</code>对象。</p><p id="b811" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后我们需要更新<code class="du jl jm jn jo b">PhotoGridAdapter</code>类，使其响应列表项上的<code class="du jl jm jn jo b">click</code>事件。</p><p id="0d4a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们打开<code class="du jl jm jn jo b">PhotoGridAdapter.kt</code>并将一个新属性<code class="du jl jm jn jo b">onClickListener</code>添加到<code class="du jl jm jn jo b">PhotoGridAdapter</code>类，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="e2d7" class="li jq hi jo b fi lj lk l ll lm">class PhotoGridAdapter(<strong class="jo hj">private val onClickListener: OnClickListener,</strong><br/>                       private val onScrollToBottom: () -&gt; Unit): ListAdapter&lt;Data.Photo, PhotoGridAdapter.PhotoGridViewHolder&gt;(DiffCallback)</span></pre><p id="1056" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要实现一个内部类<code class="du jl jm jn jo b">OnClickListener</code>，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="ddb5" class="li jq hi jo b fi lj lk l ll lm">class OnClickListener(val clickListener: (photo: Data.Photo) -&gt; Unit) {<br/>    fun onClick( photo: Data.Photo) = clickListener( photo)<br/>}</span></pre><p id="9286" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">并将<code class="du jl jm jn jo b">click</code>事件的响应添加到<code class="du jl jm jn jo b">onBindViewHolder</code>方法中，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="04b9" class="li jq hi jo b fi lj lk l ll lm">override fun onBindViewHolder(holder: PhotoGridViewHolder, position: Int) {<br/>    val photo = getItem(position)<br/>    if (position == <em class="ik">itemCount </em>- 1) {<br/>        onScrollToBottom()<br/>    }<br/><strong class="jo hj">    holder.itemView.setOnClickListener {<br/>        onClickListener.onClick(photo)<br/>    }<br/>    </strong>holder.bind(photo)<br/>}</span></pre><p id="070c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在，当一个列表项被点击时，它会调用回调函数<code class="du jl jm jn jo b">onClickListener.onClick(photo)</code>。当<code class="du jl jm jn jo b">PhotoGridAdapter</code>对象被实例化时，这个回调函数从<code class="du jl jm jn jo b">HomeFragment</code>传递过来。</p><p id="2e36" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">下一步是更新<code class="du jl jm jn jo b">HomeViewModel</code>类，因为我们需要保存哪个列表项被点击。</p><p id="6c7a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们打开<code class="du jl jm jn jo b">HomeViewModel.kt</code>文件，添加另一个属性<code class="du jl jm jn jo b">selectedPhoto</code>及其backfield <code class="du jl jm jn jo b">_selectedPhoto</code>，如下图所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="099d" class="li jq hi jo b fi lj lk l ll lm">private val _status = MutableLiveData&lt;PexelsApiStatus&gt;()<br/><strong class="jo hj">private val _selectedPhoto = MutableLiveData&lt;Data.Photo?&gt;()<br/></strong>......<br/>val status: LiveData&lt;PexelsApiStatus&gt;<br/>    get() = _status<br/><br/><strong class="jo hj">val selectedPhoto: LiveData&lt;Data.Photo?&gt;<br/>    get() = _selectedPhoto</strong></span></pre><p id="4e75" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要添加两个方法<code class="du jl jm jn jo b">displayPhotoDetails(photo: Data.Photo)</code>和<code class="du jl jm jn jo b">displayPhotoDetailComplete()</code>，如下所示，其中属性<code class="du jl jm jn jo b">selectedPhoto</code>将被更新。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="d267" class="li jq hi jo b fi lj lk l ll lm">fun displayPhotoDetails( photo: Data.Photo) {<br/>    _selectedPhoto.<em class="ik">value </em>= photo<br/>}<br/><br/>fun displayPhotoDetailComplete() {<br/>    _selectedPhoto.<em class="ik">value </em>= null<br/>}</span></pre><p id="a075" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">现在，让我们更新<code class="du jl jm jn jo b">HomeFragment</code>类，将所有的更改绑定在一起。</p><p id="628c" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">让我们打开<code class="du jl jm jn jo b">HomeFragment.kt</code>并更新<code class="du jl jm jn jo b">viewModelAdapter</code>的实例化，如下所示:</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="9009" class="li jq hi jo b fi lj lk l ll lm">binding.photosGrid.<em class="ik">adapter </em>= PhotoGridAdapter(<strong class="jo hj"> PhotoGridAdapter.OnClickListener {<br/>    homeViewModel.displayPhotoDetails(it)<br/>}</strong>) <strong class="jo hj">{</strong>homeViewModel.refreshRepository()<strong class="jo hj">}</strong></span></pre><p id="89c1" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">通过这一更改，我们将把一个lambda函数<code class="du jl jm jn jo b">PhotoGridAdapter.OnClickListener {<br/> homeViewModel.displayPhotoDetails(it)<br/>}</code>传递给photoGridAdapter对象。onClick()将被设置为<code class="du jl jm jn jo b">homeViewModel.displayPhotoDetails(it)</code>。这意味着当用户点击列表项时会调用<code class="du jl jm jn jo b">homeViewModel.displayPhotoDetails(it)</code>。该参数将是所选列表项的照片对象。</p><p id="272a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们还需要添加一个观察者来观察LiveData属性<code class="du jl jm jn jo b">selectedPhoto</code>并导航到目的片段<code class="du jl jm jn jo b">DetailFragment</code>，如果<code class="du jl jm jn jo b">selectedPhoto</code>发生了变化。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="a702" class="li jq hi jo b fi lj lk l ll lm">homeViewModel.selectedPhoto.observe(<em class="ik">viewLifecycleOwner</em>, <em class="ik">Observer </em><strong class="jo hj">{<br/>    </strong>if (<strong class="jo hj">it </strong>!= null) {<br/>        this.<em class="ik">findNavController</em>().navigate(<br/>            HomeFragmentDirections.actionShowDetail(it))<br/>        homeViewModel.displayPhotoDetailComplete()<br/>    }<br/><strong class="jo hj">}</strong>)</span></pre><p id="2663" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">如果您发现找不到<code class="du jl jm jn jo b">findNavController</code>，您可能需要重启<code class="du jl jm jn jo b">Android Studio</code>。</p><p id="911b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们差不多完成了。让我们运行应用程序，从<code class="du jl jm jn jo b">Home</code>页面上的列表中单击一张照片，它将导航到<code class="du jl jm jn jo b">Detail</code>页面，显示这张照片和一些信息。这正是我们所期望的。但是您可能会注意到一个小问题，即您无法通过点击<code class="du jl jm jn jo b">Detail</code>页面上的<code class="du jl jm jn jo b">Back</code>按钮返回到<code class="du jl jm jn jo b">Home</code>页面。让我们修理它。</p><p id="b513" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们需要打开<code class="du jl jm jn jo b">MainActivity.kt</code>并添加以下覆盖方法来启用后退按钮。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="6d2f" class="li jq hi jo b fi lj lk l ll lm">override fun onOptionsItemSelected(item: MenuItem): Boolean {<br/>    when (item.<em class="ik">itemId</em>) {<br/>        android.R.id.<em class="ik">home </em>-&gt; {<br/>            onBackPressed()<br/>            return true<br/>        }<br/>    }<br/>    return super.onOptionsItemSelected(item)<br/>}</span></pre><p id="0fcf" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">那我们再运行一下app吧。它将显示<code class="du jl jm jn jo b">Home</code>页面。点击单张照片后会导航到<code class="du jl jm jn jo b">Detail</code>页面，点击<code class="du jl jm jn jo b">Detail</code>页面的<code class="du jl jm jn jo b">Back</code>按钮会返回到<code class="du jl jm jn jo b">Home</code>页面，如下图:</p><figure class="kt ku kv kw fd kx er es paragraph-image"><div class="er es md"><img src="../Images/c209c4d510c774f87e56ee21f5340298.png" data-original-src="https://miro.medium.com/v2/resize:fit:544/1*3Ov8eb9Jgd7ESlCRbbi1kA.gif"/></div></figure><p id="f3fe" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">然后，一旦用户在<code class="du jl jm jn jo b">ActionBar</code>点击<code class="du jl jm jn jo b">Back</code>按钮，应用程序将能够像按下<code class="du jl jm jn jo b">Back</code>按钮一样返回上一页。这不会影响在<code class="du jl jm jn jo b">home</code>、<code class="du jl jm jn jo b">dashboard</code>和<code class="du jl jm jn jo b">notification</code>页面之间的导航，因为这些页面已经在<code class="du jl jm jn jo b">onCreate</code>方法中用下面的模板代码设置为顶层页面。</p><pre class="kt ku kv kw fd le jo lf lg aw lh bi"><span id="738e" class="li jq hi jo b fi lj lk l ll lm">val appBarConfiguration = <em class="ik">AppBarConfiguration</em>(<em class="ik">setOf</em>(<br/>        R.id.<em class="ik">navigation_home</em>, R.id.<em class="ik">navigation_dashboard</em>, R.id.<em class="ik">navigation_notifications</em>))<br/><em class="ik">setupActionBarWithNavController</em>(navController, appBarConfiguration)</span></pre><p id="fa05" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">我们已经完成了这个照片应用程序的所有功能。在未来的教程中，我们可能会添加更多的功能来填充其他页面。</p><p id="0e78" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">感谢浏览我的教程，欢迎任何反馈。</p><p id="d558" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it ji iv iw ix jj iz ja jb jk jd je jf jg hb bi translated">如果你对如何编写android项目的单元测试感兴趣，可以在<a class="ae jh" href="https://kxie0124.medium.com/how-to-write-unit-test-of-app-based-on-android-architecture-components-and-coroutine-8e5473f6674c" rel="noopener">https://kxie 0124 . medium . com/how-to-write-unit-test-of-app-based-on-Android-architecture-components-and-coroutine-8e 5473 f 6674 c</a>中找到该项目的单元测试。</p></div></div>    
</body>
</html>