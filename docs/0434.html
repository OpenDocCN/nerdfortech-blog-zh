<html>
<head>
<title>Python Logging — Simplification</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python日志记录-简化</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/python-logging-simplification-e24824a748f9?source=collection_archive---------0-----------------------#2020-12-13">https://medium.com/nerd-for-tech/python-logging-simplification-e24824a748f9?source=collection_archive---------0-----------------------#2020-12-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/e0b0a71d1f452f7a4dccddbff7e52266.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5_4DMz4MV7VDgQ_w26koA.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">图片来源:谷歌</figcaption></figure><div class=""/><p id="9c29" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">日志记录是应用程序用来与受众交流的模式。任何交流(记录)的关键是考虑你的受众和他们的需求。这就是为什么我们为不同受众(开发人员、系统管理员等)提供不同的日志级别。</p><figure class="jt ju jv jw fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es js"><img src="../Images/d5730c37b62fd203332e8448f6cc5720.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v5pu3Xq2UvcZmakX9wXzAw.png"/></div></div></figure><p id="d206" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在Python的日志模块中，我们有以下<strong class="iw hy">日志级别:</strong></p><blockquote class="jx jy jz"><p id="1701" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">调试</em> </strong> <em class="hx"> —细粒度的应用流消息，如内部对象的转储</em></p><p id="44a1" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx"> INFO </em> </strong> <em class="hx"> —粗粒度的应用流程，如状态变化。</em></p><p id="4c7e" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">警告</em> </strong> <em class="hx"> —可能导致问题的事情。</em></p><p id="fede" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">错误</em> </strong> <em class="hx"> —对操作致命(可恢复)的东西，而不是应用/程序本身。</em></p><p id="6296" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">严重</em> </strong> <em class="hx"> —需要立即注意的程序或系统故障</em></p></blockquote><blockquote class="ke"><p id="324d" class="kf kg hx bd kh ki kj kk kl km kn jr dx translated">调试&lt; INFO &lt; WARNING &lt; ERROR &lt; CRITICAL</p></blockquote><figure class="kp kq kr ks kt hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ko"><img src="../Images/ee63a42b603ac509dddef8670959c9d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aHKt_H9yzoU_gcSlfQgDpQ.png"/></div></div></figure><p id="cf45" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Each message or log record should have time stamp, contextual information, actual message and log level. Let us see how to correctly setup logging in a python application to include those. The recommended way is to use config files to set the logging configuration. Below example just show how we can load a YAML based config file and then start logging in our app.</p><pre class="jt ju jv jw fd ku kv kw kx aw ky bi"><span id="ef19" class="kz la hx kv b fi lb lc l ld le">import logging<br/>import logging.config<br/>import os<br/>import yaml</span><span id="56ce" class="kz la hx kv b fi lf lc l ld le">DEFAULT_LEVEL = logging.INFO</span><span id="2678" class="kz la hx kv b fi lf lc l ld le">def log_setup(log_cfg_path='cfg.yaml'):<br/>    if os.path.exists(log_cfg_path):<br/>        with open(path, 'rt') as cfg_file:<br/>            try:<br/>                config = yaml.safe_load(cfg_file.read())<br/>                logging.config.dictConfig(config)<br/>            except Exception as e:<br/>                print('Error with file, using Default logging')<br/>                logging.basicConfig(level=default_level)<br/>    else:<br/>        logging.basicConfig(level=default_level)<br/>        print('Config file not found, using Default logging')</span><span id="07d8" class="kz la hx kv b fi lf lc l ld le">#set up logging configuration<br/>log_setup()</span><span id="7d4c" class="kz la hx kv b fi lf lc l ld le"># create logger<br/>logger = logging.getLogger('dev')</span><span id="44e3" class="kz la hx kv b fi lf lc l ld le">logger.debug('debug message')<br/>logger.info('info message')<br/>logger.warning('warn message')<br/>logging.error("error message")<br/>logger.critical('critical message')</span></pre><p id="168c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Check out the attributes supported by log record :<br/><a class="ae lg" href="https://docs.python.org/3/library/logging.html#logrecord-attributes" rel="noopener ugc nofollow" target="_blank">https://docs . python . org/3/library/logging . html # log record-attributes</a></p><p id="34ef" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">日志记录:</strong></p><blockquote class="jx jy jz"><p id="f47f" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">名称</em> </strong> —用于记录事件的记录器的名称</p><p id="8b3e" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">级别</em> </strong> —记录事件的数字级别，这被转换为<em class="hx">两个</em>属性<code class="du lh li lj kv b">levelno</code> (10，20，30)和<code class="du lh li lj kv b">levelname</code>(调试，信息)</p><p id="5f87" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">路径名</em> </strong> —进行日志记录调用的源文件的路径名。</p><p id="53fc" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">行号</em> </strong> —源文件中进行记录调用的行号。</p><p id="0923" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">消息</em> </strong> —实际消息，带占位符。</p><p id="3991" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx"> args </em> </strong> —将变量数据合并到<em class="hx"> msg </em>参数中，以获得事件描述。</p><p id="3927" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx"> exc_info </em> </strong> —异常信息</p><p id="40b9" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx"> func </em> </strong> —发出记录调用的函数的名称。</p><p id="c47e" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx"> sinfo </em> </strong> —从当前线程中堆栈的底部开始，直到日志调用的堆栈信息。</p></blockquote><p id="e2f0" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在记录消息或设置日志格式时，可以使用上述属性。</p><p id="99bc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">日志配置有几个组件，如记录器、处理程序、过滤器和格式化程序。</p><blockquote class="jx jy jz"><p id="f7fe" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">记录器</em> </strong> —应用代码使用的api。</p><p id="6306" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">处理程序</em> </strong>将日志记录重定向到适当的目的地。</p><p id="458d" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">按名称过滤</em> </strong>根据定义过滤出日志记录</p><p id="1ee0" class="iu iv ka iw b ix iy iz ja jb jc jd je kb jg jh ji kc jk jl jm kd jo jp jq jr hb bi translated"><strong class="iw hy"> <em class="hx">格式器</em> </strong>指定输出中日志记录的格式/布局。</p></blockquote><figure class="jt ju jv jw fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lk"><img src="../Images/ba48425bfc056633a25c8c1f376c6040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F1fbwiDZmiUlAneytSoxaQ.png"/></div></div></figure><p id="acd2" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">上图描述了日志记录的流程。我没有包括传播，如果存在的话，它是递归完成的。</p><p id="456c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">让我们看看cfg.yaml的内容，检查这些组件是如何使用的。</p><pre class="jt ju jv jw fd ku kv kw kx aw ky bi"><span id="8a92" class="kz la hx kv b fi lb lc l ld le">version: 1</span><span id="3849" class="kz la hx kv b fi lf lc l ld le">disable_existing_loggers: true</span><span id="a6a5" class="kz la hx kv b fi lf lc l ld le">formatters:<br/>  extended:<br/>    format: '%(asctime)-20s :: %(levelname)-8s :: [%(process)d]%(processName)s :: %(threadName)s[%(thread)d] :: %(pathname)s :: %(lineno)d :: %(message)s'<br/>  simple:<br/>    format: "%(asctime)s :: %(name)s :: %(message)s"</span><span id="e1d0" class="kz la hx kv b fi lf lc l ld le">handlers:<br/>  console:<br/>    class: logging.StreamHandler<br/>    level: DEBUG<br/>    formatter: simple<br/>    stream: ext://sys.stdout</span><span id="236d" class="kz la hx kv b fi lf lc l ld le">  file_handler:<br/>    class: logging.FileHandler<br/>    filename: my_app.log<br/>    formatter: extended<br/>    level: INFO<br/>    propagate: false<br/> <br/>loggers:<br/>  dev:<br/>    handlers: [console, file_handler]<br/>  prod:<br/>    handlers: [file_handler]<br/> <br/>root:<br/>  level: DEBUG<br/>  handlers: [console]</span></pre><p id="5b1b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在上面的YAML中，我们没有过滤器，但可以设置如下:</p><pre class="jt ju jv jw fd ku kv kw kx aw ky bi"><span id="2228" class="kz la hx kv b fi lb lc l ld le">filters:<br/>  infoFilter:<br/>    (): logging.filters.infoFilter</span></pre><p id="3132" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">然后在日志设置中添加以下代码:</p><pre class="jt ju jv jw fd ku kv kw kx aw ky bi"><span id="fce0" class="kz la hx kv b fi lb lc l ld le">class infoFilter(logging.Filter):<br/>    def filter(self, log_record):<br/>        return log_record.levelno == logging.INFO</span></pre><p id="8609" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">伐木快乐！！</p></div></div>    
</body>
</html>