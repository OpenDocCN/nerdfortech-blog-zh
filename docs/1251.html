<html>
<head>
<title>ESP32 OTA update from Google Cloud Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">来自 Google 云存储的 ESP32 OTA 更新</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/esp32-ota-update-from-google-cloud-storage-a41a4b69a8a2?source=collection_archive---------6-----------------------#2021-03-11">https://medium.com/nerd-for-tech/esp32-ota-update-from-google-cloud-storage-a41a4b69a8a2?source=collection_archive---------6-----------------------#2021-03-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cdec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">完全免责声明，我是嵌入式系统和 C++的新手，我希望听到任何和所有的反馈。</p><h2 id="1639" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">依赖关系:</h2><p id="bc60" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">对于这个项目，我使用的是 VS 代码的 pio 扩展。代码是用 c++写的，使用的是 arduino 框架。Platform.ini 文件:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="472c" class="jd je hi ki b fi km kn l ko kp">[env:esp32dev]</span><span id="cccb" class="jd je hi ki b fi kq kn l ko kp">platform = https://github.com/platformio/platform-espressif32.git</span><span id="9d94" class="jd je hi ki b fi kq kn l ko kp">board = esp32dev</span><span id="f85f" class="jd je hi ki b fi kq kn l ko kp">framework = arduino</span></pre><p id="2d58" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务器运行的是 express.js，部署到 Google App Engine。</p><h2 id="6f8d" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">服务器:</h2><p id="5ea6" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">服务器将处理下载。从 GC-storage 中取出 bin 文件，并将其提供给 esp 设备。我将使用 Node 将我的设置部署到 App Engine，因此我将使用 express.js。服务器将非常简单，因此它应该很容易在许多其他平台上实现。</p><figure class="kd ke kf kg fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="ad81" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果我们从 GET 函数的顶部开始，我们可以看到我将内容类型头设置为“应用程序/八位字节流”。这只是告诉任何浏览器这是代码，而不是应该向用户读出的东西。</p><p id="336c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的用例中，在 url 中编码一个版本，在大多数用例中，不应该由设备来决定运行哪个版本。</p><p id="3372" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我尝试从我的 app.yaml 文件中指定的 google 云存储桶中获取一个文件，并创建一个读取流。</p><p id="a868" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">服务器做的最后一件事是通过调用:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="92b6" class="jd je hi ki b fi km kn l ko kp">downloadedFile.pipe(res);</span></pre><p id="07ff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要在 App Engine 中指定环境变量，请将其添加到 app.yaml 文件中:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="37b8" class="jd je hi ki b fi km kn l ko kp">env_variables:</span><span id="99b1" class="jd je hi ki b fi kq kn l ko kp">  GCLOUD_STORAGE_BUCKET_OTA_UPDATE: name-of-bucket</span></pre><h2 id="5b1c" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated">电潜泵装置:</h2><p id="536d" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">每次在我的 ESP 设备上运行 OTA 更新都需要很长时间。嵌入式系统不是我的强项。最后，我找到了一个可以在我的硬件上工作的设置，所以如果有什么不适合你，看看我在底部链接的文章。</p><figure class="kd ke kf kg fd kr"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="b96d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于所有 Google App 引擎默认使用 https 而不是 http，所以我们必须使用 WiFiClientSecure。如果不需要 ssl，可以将其更改为普通的 wifi 客户端。</p><p id="1f73" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍后，我将制作一个教程，向客户端添加 CA 证书，但现在我将只使用 setInsecure()。这不应该在生产环境中进行，因为它和普通的 http 一样不安全。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="823a" class="jd je hi ki b fi km kn l ko kp">client.setInsecure(); // Insecure as DUCK - change to use a cert.</span></pre><p id="cd74" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因为我们使用了 ESP32 Http Updater 库，所以代码的其余部分是不言自明的。</p><h2 id="d914" class="jd je hi bd jf jg jh ji jj jk jl jm jn iq jo jp jq iu jr js jt iy ju jv jw jx bi translated"><strong class="ak">上传新版本</strong></h2><p id="afef" class="pw-post-body-paragraph if ig hi ih b ii jy ik il im jz io ip iq ka is it iu kb iw ix iy kc ja jb jc hb bi translated">一旦代码启动并运行，你将需要固件文件。如果您使用 Platform.io，很容易找到固件文件，它应该位于您的项目的基础下。pio/build/ <em class="ku">环境名</em>，应该叫<strong class="ih hj">固件. bin </strong>。</p><p id="4daf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">firmware.bin 应该总是以<strong class="ih hj"> 0xe9 </strong>开头，所以上传文件后最好从服务器下载并运行:</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="889e" class="jd je hi ki b fi km kn l ko kp">$ hexdump .pio/build/esp32dev/firmware.bin</span></pre><p id="ae00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这应该打印出一大堆数字，你要滚动到顶部，看第一行，确保它像这样</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="65af" class="jd je hi ki b fi km kn l ko kp">0000000 e9 06 02 20 64 25 08 40 ee 00 00 00 00 00 00 00</span></pre><p id="c76b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其中<strong class="ih hj"> e9 </strong>是重要部分。如果不在那里，esp 将崩溃，并显示一个错误代码，说明有一个神奇的字节。</p><p id="c120" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">更新失败的另一个原因是设备上没有足够的空间。试着看一下分区场景。ESP 需要保留两倍的固件大小，因此，如果您有一个 4 MB 空间的 ESP 设备，您需要保留 2 MB 以使更新工作。您可以在下面的链接中查看 Pio 如何处理分区表。</p><p id="4cb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">帮助链接:</p><p id="5722" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Github 源代码:</strong>【https://github.com/OscarHedeby/esp32-ota-server T2】</p><p id="d892" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用 VS 代码启动并运行 Pio:</strong><a class="ae kv" href="https://randomnerdtutorials.com/vs-code-platformio-ide-esp32-esp8266-arduino/" rel="noopener ugc nofollow" target="_blank">https://randomnerdtutorials . com/VS-code-platform io-ide-esp32-esp8266-arduino/</a></p><p id="7cb8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">分区表:</strong><a class="ae kv" href="https://docs.platformio.org/en/latest/platforms/espressif32.html#partition-tables" rel="noopener ugc nofollow" target="_blank">https://docs . platform io . org/en/latest/platforms/espressif 32 . html # Partition-tables</a></p></div></div>    
</body>
</html>