<html>
<head>
<title>Threat Modeling — EKS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">威胁建模— EKS</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/threat-modeling-eks-c1e06f6814f?source=collection_archive---------0-----------------------#2022-01-07">https://medium.com/nerd-for-tech/threat-modeling-eks-c1e06f6814f?source=collection_archive---------0-----------------------#2022-01-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/614c603a9d35e640348403a0ebead4f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SQmANkcyLjyYQD0vjrMZyg.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">照片由<a class="ae hv" href="https://unsplash.com/@flyd2069?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">飞:D </a>在<a class="ae hv" href="https://unsplash.com/s/photos/threat?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><div class=""/><p id="c2a4" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将安全性嵌入服务产品</p><p id="c075" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">威胁建模是识别系统和数据潜在威胁的过程。通过使用这个过程，我们可以制定一个计划来保护我们的系统免受这些威胁。</p><p id="c70c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我目前的组织中，我们使用 AWS 服务目录来提供由公司其他团队消费的产品——一种可消费模式。因为我们有单一的服务创建来源，所以我们在产品本身中构建了安全性。为此，我们对相关服务进行了威胁建模练习。在这篇博客中，我将分享我们遵循的瘦身方法。</p><h2 id="d021" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">识别服务/应用</h2><p id="8e5d" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们定义威胁建模的范围。</p><p id="954f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="kt">对于这个博客，我将使用 AWS EKS 集群。</em></p><h2 id="9686" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">创建责任和所有权矩阵</h2><p id="02aa" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们定义谁负责有问题的组件。AWS 与客户。在 EKS，控制平面、Fargate 和受管节点由 AWS 管理，数据平面由我们管理。定制节点组和定制控制器，以及 webhook 变异都是我们的责任。</p><figure class="kv kw kx ky fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ku"><img src="../Images/9bf42acf92750c03fd5269a3f306832f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XCv38m3FnfQ8oQEE9kn86g.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">图像源 AWS 文档。</figcaption></figure><h2 id="41ca" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">识别管理 API</h2><ul class=""><li id="7952" class="kz la hy ix b iy ko jc kp jg lb jk lc jo ld js le lf lg lh bi translated">CreateNodegroup</li><li id="62f7" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">删除节点组</li><li id="b96e" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">UpdateNodegroupConfig</li><li id="1de2" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">UpdateNodegroupVersion</li><li id="19db" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">CreateFargateProfile</li><li id="fab9" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">DeleteFargateProfile</li><li id="a907" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">创建集群</li><li id="c99d" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">删除集群</li><li id="a552" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">UpdateClusterConfig</li><li id="ea60" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">UpdateClusterVersion</li><li id="c19f" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">AssociateIdentityProviderConfig</li><li id="5d72" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">取消关联 IdentityProviderConfig</li></ul><h2 id="32fd" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">识别访问/入口点</strong></h2><p id="f2da" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们找到了正在讨论的服务的所有入口点。</p><ul class=""><li id="de39" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">API 端点</li><li id="1b08" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">SSH 到主机</li><li id="740e" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">kubelet 进入集装箱</li><li id="38dd" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">通过启动 rouge 容器访问集群</li></ul><h2 id="dc8e" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">确定渗漏点</h2><p id="5e42" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们找到了可以将数据移出的所有方法。</p><ul class=""><li id="b4c0" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">将工件上传到外部/非预期系统的访问权限(S3)</li><li id="9662" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">将图像从 ECR 下载和上传到其他 ECR 或工厂</li></ul><h2 id="a202" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">确定可以放置控件的位置</h2><p id="386b" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">基于以上两个步骤，我们知道所有需要放置控制机制的地方。</p><figure class="kv kw kx ky fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lq"><img src="../Images/d56927d46513fd81092ef4f578363c6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W_CMtF_rI9UmB7qGqaEpag.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">EKS 的数据流图(安全视图)</figcaption></figure><p id="a3a7" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有了数据流图，我们可以总结最后三个步骤。在上图中，我用红线标出了所有可以放置控件的地方。在这种情况下，这些控制可以是一个<strong class="ix hz"> SCP、安全组、aws-auth、角色、端点访问点、OS 挂载。</strong></p><h2 id="e749" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">确定演员</strong></h2><p id="a677" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们试图找出在服务中谁会引起安全问题。</p><ul class=""><li id="9f27" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">外部攻击者</li><li id="6ca7" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">恶意容器(被篡改的图像)</li><li id="da84" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">易受攻击的第三方软件包</li><li id="a111" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">恶意用户/被盗凭据</li><li id="a050" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">滥用合法特权</li></ul><h2 id="8acd" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">识别威胁(什么会出错？)</strong></h2><p id="e85b" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们找到了与参与者相关的威胁。这基本上是一个演员在服务中能做到的。</p><ul class=""><li id="7b4f" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">无权访问群集的人可以通过网络访问运行在群集上的应用程序和/或管理端口</li><li id="3531" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">攻击者可以访问单个容器，并希望扩展其访问权限以接管整个集群</li><li id="4dd5" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">攻击者拥有针对 Kubernetes API 执行命令的有效凭证，以及对端口的网络访问权限</li><li id="9974" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">如果用户有权访问管理 API，他们可以修改集群配置</li></ul><p id="e0d2" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，这些威胁被映射到一个漏洞框架。如<strong class="ix hz"> S </strong> poofing、<strong class="ix hz"> T </strong> ampering、<strong class="ix hz">R</strong>epudation、<strong class="ix hz">I</strong>information Disclosure、<strong class="ix hz"> D </strong> enial of Service、<strong class="ix hz">E</strong>remove of Privilege(<strong class="ix hz">STRIDE</strong>)。</p><h2 id="724d" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">识别威胁的影响</strong></h2><p id="f046" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们评估不同参与者执行的操作的影响。</p><ul class=""><li id="d3b0" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">数据销毁(删除配置、存储)</li><li id="6b08" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">资源劫持(运行数字货币挖掘)</li><li id="71e8" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">拒绝服务(使服务不可用)</li><li id="f543" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">服务中断</li></ul><h2 id="95e3" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">确定违约的持续性</strong></h2><p id="fafc" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们试图找出所述动作可以在系统中存在多长时间。</p><ul class=""><li id="4e08" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">后门集装箱</li><li id="a02c" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">可写主机路径(在主机上创建 cron 作业)</li><li id="3c8c" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">Kubernetes Cronjob(集群中的计划单元)</li><li id="1b4a" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">恶意准入控制器</li></ul><h2 id="343b" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">识别横向运动</strong></h2><p id="72f6" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们评估恶意参与者可以触及的所有接触点。这包括被评估服务范围之外的系统和服务。</p><ul class=""><li id="6d2f" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">访问云服务</li><li id="7701" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">容器中的应用程序凭据</li><li id="e22c" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">库伯内特的秘密</li><li id="d4ee" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">核心 DNS 中毒</li><li id="ef26" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">可写卷装载在主机节点中</li></ul><h2 id="af74" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">识别预防措施</strong></h2><p id="b712" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在这一步中，我们找到了减轻已识别威胁的预防性控制措施。</p><ul class=""><li id="1022" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">确保管理服务(API 服务器、kubelet)不会暴露给没有适当认证控制的不可信网络<br/> - API 服务器认证<br/> - API 服务器授权<br/> - Kubelet 认证</li><li id="e294" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">确保服务帐户没有装载在容器中，或者具有受限的权限(即不是集群管理员)</li><li id="d5c5" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">RBAC，IRSA，Pod 安全策略</li><li id="fe2c" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">控制面板和工作人员的独立安全组</li><li id="e77d" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">Calico 网络策略</li><li id="9b3b" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">私有注册表认证</li><li id="558a" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">确保管理 API 仅提供给管理员角色，并且仅限于由公司网络中的某些实体承担。</li></ul><p id="6d06" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">实施通用预防措施</strong></p><ul class=""><li id="ccb2" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">输入验证、身份验证、会话处理和上下文绑定处理</li></ul><h2 id="c42c" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">创建一个控制矩阵</strong></h2><p id="107d" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">一旦我们有了控制措施，我们就创建了一个控制矩阵，它映射了威胁和针对该威胁的所有控制措施。我们将它们分成不同的类别，如下所示。这需要由安全 SME 审查和批准。</p><ul class=""><li id="220a" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated"><strong class="ix hz">指令<br/></strong>-<strong class="ix hz">-</strong>把配置放在产品中对抗威胁。<br/> - Calico 网络策略</li><li id="5f64" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated"><strong class="ix hz">预防性<br/> </strong> - <strong class="ix hz"> </strong>当您需要远程访问主机时，请使用 SSM 会话管理器，而不是启用 SSH 访问。</li><li id="ab98" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated"><strong class="ix hz">Detective<br/></strong>-<strong class="ix hz"/>基于事件的错误配置检测(AWS 配置&amp;自定义安全工具)<strong class="ix hz"> <br/> </strong> - <strong class="ix hz"> </strong>定期运行 Kube-bench 以验证是否符合 CIS 亚马逊 EKS 基准测试<br/> -定期使用 Amazon Inspector 评估主机的暴露情况、漏洞以及与最佳实践的偏差<br/> -定期扫描您的容器图像</li><li id="fbc8" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated"><strong class="ix hz">补救</strong> <br/> -事故应对计划</li><li id="70e7" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated"><strong class="ix hz">矫正</strong> <br/> -迭代硬化</li></ul><figure class="kv kw kx ky fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lr"><img src="../Images/89d9ae71127dfbffe86074a29929c8f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dJQVD7_sjG8ejS4K7oWdBw.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">威胁控制矩阵</figcaption></figure><h2 id="0171" class="jt ju hy bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated"><strong class="ak">制定事故响应计划</strong></h2><p id="b6d1" class="pw-post-body-paragraph iv iw hy ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">万一发现威胁，如何应对。这是针对每种威胁的操作手册或 SOP。</p><ul class=""><li id="5bf2" class="kz la hy ix b iy iz jc jd jg ln jk lo jo lp js le lf lg lh bi translated">识别违规的 Pod 和工作节点(通过工作节点、通过部署、通过标签、使用服务帐户名称</li><li id="a56b" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">隔离单元/节点(网络策略)</li><li id="32f1" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">撤销分配给 pod/节点的临时安全凭据</li><li id="652a" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">封锁工人节点</li><li id="e9a7" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">在受影响的工作节点上启用终止保护</li><li id="178a" class="kz la hy ix b iy li jc lj jg lk jk ll jo lm js le lf lg lh bi translated">捕获 worker 节点上的易变工件(os 系统内存、netstat 树转储)</li></ul><p id="14e5" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果该措施没有实施或由于其他防止滥用的机制而需要豁免，获得 SME 的批准并在单独的豁免清单中提及。</p><p id="a178" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这种带有详细文档的实践有助于创建和分发安全的消耗品。</p><p id="8a96" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">快乐阅读！！</p><p id="6ae0" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="kt">注:所有观点均为个人观点。没有现任或前任组织的认可。</em></p></div></div>    
</body>
</html>