<html>
<head>
<title>Android Tutorial Part 2: Using Apollo library to fetch data from a GraphQL endpoint</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android教程第2部分:使用Apollo库从GraphQL端点获取数据</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/android-tutorial-part-2-using-apollo-library-to-fetch-data-from-a-graphql-endpoint-96dad8a58639?source=collection_archive---------1-----------------------#2021-03-21">https://medium.com/nerd-for-tech/android-tutorial-part-2-using-apollo-library-to-fetch-data-from-a-graphql-endpoint-96dad8a58639?source=collection_archive---------1-----------------------#2021-03-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/94f7ac890ed7a1ce6c25de7b15781730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kRfQ_qluaF58b8Ddd88dhw.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">美国宇航局在<a class="ae iu" rel="noopener ugc nofollow" target="_blank" href="/s/photos/astronaut?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText"> Unsplash </a>拍摄的照片</figcaption></figure><h1 id="33bb" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated">图表信息</h1><p id="95e5" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在<a class="ae iu" rel="noopener" href="/nerd-for-tech/android-tutorial-part-1-using-apollo-library-to-fetch-data-from-a-graphql-endpoint-61e8c58158de">第1部分</a>中，我们配置了项目结构并添加了一个空的<strong class="jv hj"> schema.sdl </strong>文件。</p><p id="a356" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">好吧，我想是时候解释一些事情了。当您使用GraphQL时，CRUD操作只有一个端点。因此，我们必须为所有操作在本地保存一个模式文件。获取数据需要一个<strong class="jv hj"> <em class="kw">查询{}, </em> </strong>创建/更新数据需要一个<strong class="jv hj"> <em class="kw">突变{} </em> </strong>获取特定数据变更的更新需要<strong class="jv hj"> <em class="kw">订阅{} </em> </strong>。对于本教程，我们将只使用<strong class="jv hj"><em class="kw">{查询} </em> </strong>。</p><h2 id="94e5" class="kx iw hi bd ix ky kz la jb lb lc ld jf ke le lf jj ki lg lh jn km li lj jr lk bi translated">获取模式</h2><p id="3b72" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">记住我们的<strong class="jv hj"> schema.sdl </strong>当前是空的，现在让我们获取模式。首先，打开GraphQL游乐场下面是链接:<a class="ae iu" href="https://www.graphqlbin.com/v2/new" rel="noopener ugc nofollow" target="_blank">https://www.graphqlbin.com/v2/new</a></p><p id="41d9" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在GraphQL操场上粘贴里克和莫蒂的API链接:<a class="ae iu" href="https://rickandmortyapi.com/graphql" rel="noopener ugc nofollow" target="_blank">https://rickandmortyapi.com/graphql</a></p><p id="16f5" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">当游乐场打开时，您将在右侧看到两个选项卡:<strong class="jv hj">文档</strong>和<strong class="jv hj">模式</strong>。点击<strong class="jv hj">模式</strong></p><figure class="lm ln lo lp fd ij er es paragraph-image"><div class="er es ll"><img src="../Images/542add3c47ec6b0358f2d5eb4e0b362c.png" data-original-src="https://miro.medium.com/v2/resize:fit:690/format:webp/1*q8T9GopUbIaRyfxrBH5gAw.png"/></div></figure><p id="89ee" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">在Android Studio的<strong class="jv hj"> schema.sdl </strong>文件中标记、复制并粘贴所有内容。您的<strong class="jv hj"> schema.sdl </strong>应该是这样的:</p><figure class="lm ln lo lp fd ij"><div class="bz dy l di"><div class="lq lr l"/></div></figure><h2 id="dfff" class="kx iw hi bd ix ky kz la jb lb lc ld jf ke le lf jj ki lg lh jn km li lj jr lk bi translated">仅供参考:)</h2><p id="5725" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">您也可以下载模式文件。<strong class="jv hj">模式</strong>标签的右侧有一个下载按钮，您可以在这里决定是使用JSON还是SDL。</p><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/a96d03bbda89bc0ffb1c7ef6ae48b72e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HiChrGBuo_YRu6FfjlrZaw.png"/></div></div></figure><p id="2a1b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">有时下载的文件有一些问题，这就是为什么我更喜欢复制/粘贴的方法。如果你应该使用比2.5.4更老的Apollo版本，比如2.2.0，那么你不能使用SDL，因为生成器不能识别文件类型。</p><h2 id="58da" class="kx iw hi bd ix ky kz la jb lb lc ld jf ke le lf jj ki lg lh jn km li lj jr lk bi translated">编写您的第一个查询</h2><p id="c607" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">是时候看看要查询什么了。点击<strong class="jv hj">选项卡中的</strong>单据。现在，您应该会看到所有的查询选项。您可以单击每个条目来查看您可以查询的内容。看看“字符”并点击可能的查询选项。</p><figure class="lm ln lo lp fd ij er es paragraph-image"><div class="er es lt"><img src="../Images/ce2f994f5102b26e92c7551f8a2865dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/1*oBicw1IcdJeF8cKMnHajlQ.png"/></div></figure><p id="b470" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这里我们看到<strong class="jv hj"> <em class="kw">人物</em> </strong>导致<strong class="jv hj"> <em class="kw">结果</em> </strong>并且这导致<strong class="jv hj">人物</strong>细节。所以这意味着查询具有层次结构，首先是<em class="kw">字符{ T11 }这导致<em class="kw">字符{结果} } </em>这最终导致字符{ T14 }结果{ id名称物种} } </em></p><p id="9181" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在跳到左侧面板，编写以下查询:</p><pre class="lm ln lo lp fd lu lv lw lx aw ly bi"><span id="2c6d" class="kx iw hi lv b fi lz ma l mb mc">query CharactersList {<br/>    characters {<br/>        results {<br/>            id<br/>            name<br/>            species<br/>        }<br/>    }<br/>}</span></pre><p id="4b1a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">Apollo生成Kotlin文件的查询名称是“CharactersList”。我们必须给查询一个名称。接下来的几行描述了我们想要查询的内容。这就产生了一个包含id、姓名和物种的字符列表。显然，我可以获取比id、名称和物种更多或更少的信息。但是我们将在接下来的步骤中获取更多。现在按播放按钮，看看你的查询是否正确。</p><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/f06ca6acf7bc003f5bdd669b7f7ac51b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RvcLfwvR_JYVNYCJMDJ1MA.png"/></div></div></figure><p id="d2f4" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">当您看到数据输出时，您知道您的查询是正确的。现在跳回到Android Studio。在与您的<strong class="jv hj"> schema.sdl </strong>相同的包中创建一个新文件。该文件具有您的查询的名称，因此创建<strong class="jv hj"> CharactersList.graphql </strong></p><p id="c001" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">从游戏场的左侧面板复制您的查询，并将其粘贴到您的<strong class="jv hj"> CharactersList.graphql </strong>文件中。</p><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es me"><img src="../Images/5b571460b0688318707c80320cbad76e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J0hb08jS9zIF9u0xXdUvFQ.png"/></div></div></figure><p id="5e95" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">现在点击<strong class="jv hj">构建</strong> - &gt; <strong class="jv hj">清理项目</strong>然后点击<strong class="jv hj">构建</strong> - &gt; <strong class="jv hj">重建项目</strong>。</p><p id="a499" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">是时候看看Apollo能否创建一个包含<strong class="jv hj"> CharactersList.graphql </strong>文件的Kotlin文件了。如果您使用的是MacOS，则双击shift并搜索“<strong class="jv hj"> <em class="kw">字符列表查询</em> </strong>”。</p><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/0c62e9bd4bf24802de513dd435b34cfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4AauCyC9FWlHB5cJa-3N0Q.png"/></div></div></figure><p id="3282" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">打开文件<strong class="jv hj"><em class="kw">characters list query</em></strong>。在那里，您将找到一个结果数据类，其中包含列表查询所需的字段。</p><pre class="lm ln lo lp fd lu lv lw lx aw ly bi"><span id="a81c" class="kx iw hi lv b fi lz ma l mb mc">public data class Result(<br/>  public val __typename: String = "Character",<br/>  public val id: String?,<br/>  public val name: String?,<br/>  public val species: String?<br/>)</span></pre><p id="8c0f" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这意味着我们可以开始开发应用程序，您可以再次关闭生成的文件<strong class="jv hj"><em class="kw">characters list query</em></strong>。</p><h1 id="c3a7" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">开始开发应用</strong></h1><p id="d0d7" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">在存放<strong class="jv hj"> <em class="kw"> MainActivity </em> </strong>的同一个包中，新建一个文件:<strong class="jv hj"><em class="kw">RickAndMortyApp</em></strong>。从<strong class="jv hj"><em class="kw">Application()</em></strong>继承，并用<strong class="jv hj"> HiltAndroidApp </strong>注释该类，这样Hilt就可以从那里为你的应用创建依赖树。</p><pre class="lm ln lo lp fd lu lv lw lx aw ly bi"><span id="ef5c" class="kx iw hi lv b fi lz ma l mb mc">@HiltAndroidApp<br/>class RickAndMortyApp : Application()</span></pre><p id="616d" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">移动到<strong class="jv hj"> AndroidManifest.xml </strong>首先添加互联网权限。之后给你的应用命名<strong class="jv hj"><em class="kw">RickAndMortyApp</em></strong>。</p><pre class="lm ln lo lp fd lu lv lw lx aw ly bi"><span id="e33c" class="kx iw hi lv b fi lz ma l mb mc">&lt;uses-permission android:name="android.permission.INTERNET" /&gt;<br/><br/>&lt;application<br/>    android:name=".RickAndMortyApp"<br/>    android:allowBackup="true"<br/>...</span></pre><h1 id="069d" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">用于获取数据的存储库</strong></h1><p id="e133" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">是时候创建一个repo来获取数据了。创建一个新包，并将其命名为<strong class="jv hj"> repository </strong>。创建接口<strong class="jv hj"><em class="kw">character repository</em></strong>并创建一个挂起函数，其返回类型为:Response&lt;characters list query。数据&gt;</p><figure class="lm ln lo lp fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/6e1fc8480ed3ba701048e0057617e411.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p7C7wYcnzC1EzY8tFF58jQ.png"/></div></div></figure><p id="06f3" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">将光标放在<strong class="jv hj"> <em class="kw">字符库</em> </strong>内，按<em class="kw"> ALT + Enter </em>移动到“执行界面”。那么你应该有一个类<strong class="jv hj"><em class="kw">CharacterRepositoryImpl</em></strong>。</p><h1 id="f1ef" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak"><em class="mh">graph QL客户端</em> </strong></h1><p id="def3" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我们需要的下一个类是ApolloClient的实例。在实现<strong class="jv hj"><em class="kw">CharacterRepositoryImpl</em></strong>之前，让我们为ApolloClient实现这个类。创建一个新的包，命名为<strong class="jv hj">网络</strong>。在那里创建一个类<strong class="jv hj"><em class="kw">RickAndMortyApi</em></strong>。</p><pre class="lm ln lo lp fd lu lv lw lx aw ly bi"><span id="5631" class="kx iw hi lv b fi lz ma l mb mc">class RickAndMortyApi {<br/><br/>    fun getApolloClient(): ApolloClient {<br/>        <em class="kw">check</em>(Looper.myLooper() == Looper.getMainLooper()) <strong class="lv hj">{<br/>            </strong>"Only the main thread can get the apolloClient instance"<br/>        <strong class="lv hj">}<br/><br/>        </strong>val okHttpClient = OkHttpClient.Builder().build()<br/>        return ApolloClient.builder()<br/>            .serverUrl("https://rickandmortyapi.com/graphql")<br/>            .okHttpClient(okHttpClient)<br/>            .build()<br/>    }<br/>    <br/>}</span></pre><p id="3f7b" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">正如您所看到的，这个类创建了一个ApolloClient，并对Rick和Morty API端点进行网络调用。</p><p id="ad91" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">好了，第二部分到此为止。如果你喜欢这篇文章<strong class="jv hj">，请鼓掌</strong>。这里是<a class="ae iu" href="https://fahri-c93.medium.com/android-tutorial-part-3-using-apollo-library-to-fetch-data-from-a-graphql-endpoint-616fda869560" rel="noopener">第三部</a>。</p><p id="324a" class="pw-post-body-paragraph jt ju hi jv b jw kr jy jz ka ks kc kd ke kt kg kh ki ku kk kl km kv ko kp kq hb bi translated">这里是已完成的项目，检查分支<strong class="jv hj"> part_two </strong></p><div class="mi mj ez fb mk ml"><a href="https://github.com/fahrican/ApolloGraphQlTutorial/tree/part_two" rel="noopener  ugc nofollow" target="_blank"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">fahrican/apollographql教程</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">在GitHub上创建一个帐户，为fahrican/apollographqlturtutorial开发做贡献。</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">github.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz io ml"/></div></div></a></div></div></div>    
</body>
</html>