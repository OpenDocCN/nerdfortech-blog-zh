<html>
<head>
<title>How to Test TypeScript with Jest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 Jest 测试 TypeScript</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/testing-typescript-with-jest-290eaee9479d?source=collection_archive---------0-----------------------#2021-03-31">https://medium.com/nerd-for-tech/testing-typescript-with-jest-290eaee9479d?source=collection_archive---------0-----------------------#2021-03-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="d805" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><a class="ae jd" href="https://www.typescriptlang.org/" rel="noopener ugc nofollow" target="_blank"> TypeScript </a>是一种非常流行的语言，表现为 JavaScript 的类型化超集。当您使用 TypeScript 编写新的 Node.js 项目或将现有的 JavaScript 代码升级到 TypeScript 时，您可能想知道如何测试代码。</p><p id="3299" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我有机会在 Node.js 项目中使用 TypeScript 编写 lambda 代码。当我试图用 TypeScript 编写单元测试时，我遇到了一些困难，我希望你在读完这篇文章后不会遇到这些困难。</p><p id="066c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我将展示使用一个流行的 JavaScript 测试框架<a class="ae jd" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank"> Jest </a>测试您的类型脚本代码的必要步骤，并提供您在编写单元测试时可能会遇到的一些常见问题的解决方案。对于下面提供的示例命令，我将使用 npm 作为包管理器。<br/>我的项目安装了下面提到的包的以下版本:<br/>-@ types/jest:" ^26.0.20 "<br/>-" jest ":" ^26.6.3 "<br/>-" ts-jest ":" ^26.4.4 "<br/>-" typescript ":" ^3.7.5 "</p><h1 id="719c" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">先决条件</h1><blockquote class="kd ke kf"><p id="993b" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><em class="hi">通过运行以下命令将</em> <code class="du kj kk kl km b"><em class="hi">jest</em></code> <em class="hi">和</em> <code class="du kj kk kl km b"><em class="hi">typescript</em></code> <em class="hi">安装到您的项目中:<br/> </em> <code class="du kj kk kl km b"><em class="hi">npm i -D jest typescript</em></code></p></blockquote><h1 id="2cf0" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated"><strong class="ak">第一步</strong></h1><blockquote class="kd ke kf"><p id="e497" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><em class="hi">通过运行以下命令将</em> <code class="du kj kk kl km b"><em class="hi">ts-jest</em></code> <em class="hi">和</em> <code class="du kj kk kl km b"><em class="hi">@types/jest</em></code> <em class="hi">安装到您的项目中:<br/> </em> <code class="du kj kk kl km b"><em class="hi">npm i -D ts-jest @types/jest</em></code></p></blockquote><h1 id="86c4" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">第二步</h1><blockquote class="kd ke kf"><p id="8877" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><em class="hi">通过运行以下命令，在与</em> <code class="du kj kk kl km b"><em class="hi">package.json</em></code> <em class="hi">相同的级别创建一个名为</em> <code class="du kj kk kl km b"><em class="hi">jest.config.js</em></code> <em class="hi">的配置文件:<br/></em><em class="hi"><br/>该文件应该有以下代码:</em></p></blockquote><pre class="kn ko kp kq fd kr km ks kt aw ku bi"><span id="41a7" class="kv jg hi km b fi kw kx l ky kz">module.exports = {<br/>  preset: "ts-jest",<br/>  testEnvironment: "node"<br/>};</span></pre><h1 id="7a96" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated">第三步</h1><blockquote class="kd ke kf"><p id="19f7" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><em class="hi">在</em> <code class="du kj kk kl km b"><em class="hi">package.json</em></code> <em class="hi">的同一层创建一个名为</em> <code class="du kj kk kl km b"><em class="hi">tests</em></code> <em class="hi">的文件夹，并将您的测试文件放在这个文件夹下。测试文件应该遵循</em> <code class="du kj kk kl km b"><em class="hi">{file_name}.test.ts</em></code> <em class="hi">的命名约定。通过运行以下命令执行测试:<br/> </em> <code class="du kj kk kl km b"><em class="hi">npm t</em></code></p></blockquote><h1 id="8c4e" class="jf jg hi bd jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc bi translated"><strong class="ak">常见问题解答</strong></h1><blockquote class="kd ke kf"><p id="b7aa" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><strong class="ih hj">问:<em class="hi"> <br/> </em> </strong> <em class="hi">我如何模仿一个导入的类？(用例:类 A 导入类 B，我想在测试类 A 时模仿类 B)。</em></p><p id="ec80" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><strong class="ih hj">答:<br/></strong></p></blockquote><pre class="kn ko kp kq fd kr km ks kt aw ku bi"><span id="46c9" class="kv jg hi km b fi kw kx l ky kz">// file: class_a.test.js</span><span id="9060" class="kv jg hi km b fi la kx l ky kz">import { ClassB } from "../src/class_b";<br/>jest.mock("../src/class_b");</span><span id="17fd" class="kv jg hi km b fi la kx l ky kz">it("should mock class B", () =&gt; {<br/>  const functionNameMock = jest.fn();<br/>  ClassB.mockImplementation(() =&gt; {<br/>    return {<br/>      functionName: functionNameMock<br/>    };<br/>  });<br/>});</span></pre><blockquote class="kd ke kf"><p id="9776" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><em class="hi">然而，这不能用于 TypeScript。它将显示类似以下内容的编译错误:“类型‘type of class b’上不存在属性‘mock implementation’”。ts”。而是可以在</em> <code class="du kj kk kl km b"><em class="hi">ClassB.prototype</em></code> <em class="hi">上使用</em> <code class="du kj kk kl km b"><em class="hi">jest.spyOn</em></code> <em class="hi">。</em></p></blockquote><pre class="kn ko kp kq fd kr km ks kt aw ku bi"><span id="0a4c" class="kv jg hi km b fi kw kx l ky kz">// file: class_a.test.js</span><span id="f7a5" class="kv jg hi km b fi la kx l ky kz">import { ClassB } from "../src/class_b";<br/>jest.mock("../src/class_b");</span><span id="78a2" class="kv jg hi km b fi la kx l ky kz">it("should mock class B", () =&gt; {<br/>  const functionNameMock = jest.fn();<br/>  jest.spyOn(ClassB.prototype, "functionName").mockImplementation(functionNameMock);<br/>});</span></pre><blockquote class="kd ke kf"><p id="8dd3" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><strong class="ih hj">问:</strong> <br/> <em class="hi">如何模拟导入类的静态函数？</em></p><p id="eb92" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><strong class="ih hj">答:</strong> <br/> <em class="hi">上面展示的用来模仿导入类的函数的方法对静态函数不起作用。相反，你可以使用</em> <code class="du kj kk kl km b"><em class="hi">jest.Mocked&lt;typeof ClassB&gt;</em></code> <em class="hi">来模仿静态函数。</em></p></blockquote><pre class="kn ko kp kq fd kr km ks kt aw ku bi"><span id="7c11" class="kv jg hi km b fi kw kx l ky kz">// file: class_a.test.js</span><span id="e99d" class="kv jg hi km b fi la kx l ky kz">import { ClassB } from "../src/class_b";<br/>jest.mock("../src/class_b");</span><span id="eec5" class="kv jg hi km b fi la kx l ky kz">it("should mock static function named 'staticFuncName' of class B", () =&gt; {<br/>  const staticFuncNameMock = jest.fn();<br/>  const MockClassB = ClassB as jest.Mocked&lt;typeof ClassB&gt;;<br/>  MockClassB.staticFuncName.mockImplementation(staticFuncNameMock);<br/>});</span></pre><blockquote class="kd ke kf"><p id="4a8a" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><strong class="ih hj">问:</strong> <br/> <em class="hi">如何模拟异步函数？</em></p><p id="5935" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><strong class="ih hj">答:</strong> <br/> <em class="hi">你既可以模拟异步函数的结果，也可以模拟异步函数本身，这取决于你想测试什么。</em></p></blockquote><pre class="kn ko kp kq fd kr km ks kt aw ku bi"><span id="6256" class="kv jg hi km b fi kw kx l ky kz">// file: class_a_test.js<br/>import { ClassA } from "../src/class_A";<br/>jest.mock("../src/class_a");</span><span id="60ee" class="kv jg hi km b fi la kx l ky kz">it("should mock result of async function of class A, async () =&gt; {<br/>  const classInstance = new ClassA();<br/>  jest.spyOn(classInstance, "asyncFunction").mockImplementation(async () =&gt; "");<br/>});</span><span id="4566" class="kv jg hi km b fi la kx l ky kz">it("should mock async function of class A, async () =&gt; {<br/>  const classInstance = new ClassA();<br/>  const asyncFunctionMock = jest.fn().mockResolvedValue("");<br/>  jest.spyOn(classInstance, "asyncFunction").mockImplementation(asyncFunctionMock);<br/>});</span></pre><blockquote class="kd ke kf"><p id="0be5" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><strong class="ih hj">问:</strong> <br/> <em class="hi">如何用无效的参数类型测试一个函数的行为？(用例:函数 A 需要一个接口类型为 B 的参数，当我传递一个与接口 B 不匹配的参数时，我想测试函数 A 的行为。例如，用户向触发 lambda 函数的 API 发送一个带有正文的 HTTP 请求，而您想测试您的 lambda 函数如何处理来自用户的无效输入。)</em></p><p id="9c03" class="if ig je ih b ii ij ik il im in io ip kg ir is it kh iv iw ix ki iz ja jb jc hb bi translated"><strong class="ih hj"> A: <em class="hi"> <br/> </em> </strong> <em class="hi">根据 TypeScript 的性质，将无效类型作为参数传递给函数 A 会引发编译错误，因为预期的和实际的参数类型不兼容。但是，如果您想通过传递无效类型来测试函数 A，您可以将参数类型强制转换为</em> <code class="du kj kk kl km b"><em class="hi">any</em></code> <em class="hi">以避免编译错误。</em></p></blockquote><pre class="kn ko kp kq fd kr km ks kt aw ku bi"><span id="9e63" class="kv jg hi km b fi kw kx l ky kz">// file: class_a.ts<br/>export Class A {<br/>  functionA(data: TypeB) { ... }<br/>}<br/></span><span id="53ea" class="kv jg hi km b fi la kx l ky kz">// file: class_a.test.ts</span><span id="b2ae" class="kv jg hi km b fi la kx l ky kz">it("should test invalid input, () =&gt; {<br/>  const data = { ... } as any;<br/>  const response = classA.functionA(data);<br/>});</span></pre><p id="a786" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您在测试 TypeScript 时遇到任何其他问题，请随时直接联系我。我很乐意帮助解决你们的问题，并学习更多关于测试 TypeScript 的知识！</p></div></div>    
</body>
</html>