<html>
<head>
<title>Wake-On-Lan from Public Network (MikroTik practical example)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从公共网络唤醒局域网(MikroTik实用示例)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/wake-on-lan-from-public-network-mikrotik-practical-example-b48551d9191e?source=collection_archive---------1-----------------------#2020-06-14">https://medium.com/nerd-for-tech/wake-on-lan-from-public-network-mikrotik-practical-example-b48551d9191e?source=collection_archive---------1-----------------------#2020-06-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="dcc2" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">一些网络设备和个人电脑甚至可以在关机时监听其以太网接口上传入的特殊数据包，这用于允许它们通过特殊的<em class="ix">神奇数据包</em>通电，该数据包由Wake-On-Lan(从现在的WOL)使用。让我们看看如何在基于RouterOS的Mikrotik路由器上使用公共网络中的WOL。</h2></div><p id="63b7" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">WOL通常通过生成目的IP地址为网络广播地址(在常见的192.168.0.0/24网络中，它被定向到192.168.0.255或255.255.255.255)的数据包来完成，这将生成一个带有FF:FF:FF:FF:FF:FF:FF:FF目的mac地址的以太网帧。该广播帧由lan网段中的所有主机处理。是什么让这包<em class="ju">变魔术</em>？它必须包含要被唤醒的设备的Mac地址，重复16次。当断电设备的以太网卡检测到这个特殊帧时，它会给设备加电。</p><p id="3e68" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">通常魔术包是目的端口为0、7或9的UDP包，但这不是强制性的。顺便说一下，我将在示例中使用UDP端口9。</p><p id="159c" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">你可以在维基百科上找到更多关于WOL的<a class="ae jv" href="https://en.wikipedia.org/wiki/Wake-on-LAN#Magic_packet" rel="noopener ugc nofollow" target="_blank">信息。</a></p><h1 id="5480" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">从互联网上使用WOL</h1><p id="7de0" class="pw-post-body-paragraph iy iz hi ja b jb ko ij jd je kp im jg jh kq jj jk jl kr jn jo jp ks jr js jt hb bi translated">假设您的家庭网络中有一个NAS，您希望仅在需要时才打开它，以获取您存储在其上的一些文档，并且您的家庭网络中没有其他活动的设备可供您连接以使用WOL，那么从互联网上使用WOL不是很有用吗？如何从公共网络在内部LAN上生成广播帧？</p><p id="7ccd" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我在Eve-NG network simulator中构建了这个简单的设置，使用一个虚拟MikroTik路由器来模拟我们的家庭路由器，使用eth1作为WAN接口(我在192.168.60.0/24中使用私有IP地址，但将其视为在互联网上公开的公共地址),将eth 2–3–4分组到一个名为<em class="ju"> lan_bridge </em>的网桥中，IP地址为192.168.1.1/24，DHCP服务器启用了192 . 168 . 1 . 10–10</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es kt"><img src="../Images/0f293dcb54077add29b3a47e9e37850d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WwZD71Yfk6GGdGF773VlDQ.png"/></div></div></figure><p id="c36d" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们可以生成一个指向我们家用路由器的公共IP地址的神奇数据包，但是我们如何强迫它将它变成一个广播数据包呢？我想到的第一个最简单的解决方案是使用目的地NAT将目的地为192.168.60.141的神奇数据包更改为192.168.1.255，但在基于MikroTik或Linux的路由器上，这不起作用(我认为不支持定向广播转发),数据包被丢弃。</p><p id="5960" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">那么，我们如何在192.168.1.0/24 lan上生成神奇的数据包来启动我们的设备呢？我们可以实现以下技巧:</p><ol class=""><li id="c947" class="lf lg hi ja b jb jc je jf jh lh jl li jp lj jt lk ll lm ln bi translated">分配192.168.1.0/24中未使用的IP地址，如192.168.1.100</li><li id="ff18" class="lf lg hi ja b jb lo je lp jh lq jl lr jp ls jt lk ll lm ln bi translated">在MikroTik路由器上定义静态ARP解析，将FF:FF:FF:FF:FF:FF设置为192.168.1.100 mac地址</li><li id="f50d" class="lf lg hi ja b jb lo je lp jh lq jl lr jp ls jt lk ll lm ln bi translated">在MikroTik路由器上实施预路由目的地nat规则，以便通过将目的地地址更改为192.168.1.100并将目的地端口更改为9，来更改定向到其面向互联网的接口和UDP端口X(让我们选择9999)的传入流量</li></ol><p id="a4a6" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">现在，当您将使用目标端口9999/UDP向192.168.60.141发送神奇数据包时，MikroTik预路由NAT处理会将目标地址更改为192.168.1.100。然后，MikroTik将数据包路由到位于该子网上的lan_bridge，当它准备包含转发数据包的以太网帧时，它会将FF:FF:FF:FF:FF:FF:FF作为目的Mac地址，从而在内部lan上产生一个广播数据包，即使目的IP地址是单播IP。</p><p id="e58c" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><strong class="ja hj">安全警告:</strong>使用路由器公共地址上的9999/UDP端口发送的数据包会在您的内部网络上生成广播数据包，因此强烈建议对转发的数据包数量进行速率限制。</p><h1 id="334f" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">米克罗提克构型</h1><h1 id="ee7e" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">基本配置</h1><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="aceb" class="ly jx hi lu b fi lz ma l mb mc"># Bridge eth2-3-4<br/><strong class="lu hj">/interface bridge<br/></strong>add name=lan_bridge<br/><strong class="lu hj">/interface bridge vlan<br/></strong>add bridge=lan_bridge vlan-ids=1<br/><strong class="lu hj">/interface bridge port<br/></strong>add bridge=lan_bridge interface=ether2<br/>add bridge=lan_bridge interface=ether3<br/>add bridge=lan_bridge interface=ether4<br/><br/># Enable DHCP client on eth1 (WAN interface)<br/><strong class="lu hj">/ip dhcp-client<br/></strong>add disabled=no interface=ether1<br/><br/># Setup internal network and enable DHCP Server<br/><strong class="lu hj">/ip address</strong><br/>add address=192.168.1.1/24 interface=lan_bridge network=192.168.1.0<br/><strong class="lu hj">/ip pool</strong><br/>add name=dhcp_pool ranges=192.168.1.10-192.168.1.50<br/><strong class="lu hj">/ip dhcp-server<br/></strong>add address-pool=dhcp_pool disabled=no interface=lan_bridge name=dhcp_server<br/><strong class="lu hj">/ip dhcp-server network<br/></strong>add address=192.168.1.0/24 gateway=192.168.1.1 netmask=24</span></pre><h1 id="1068" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">ARP解析“技巧”</h1><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="c5db" class="ly jx hi lu b fi lz ma l mb mc"><strong class="lu hj">/ip arp add address=192.168.1.100</strong> interface=lan_bridge <strong class="lu hj">mac-address=FF:FF:FF:FF:FF:FF</strong></span></pre><h1 id="91c2" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">防火墙NAT和转发规则</h1><p id="bbf0" class="pw-post-body-paragraph iy iz hi ja b jb ko ij jd je kp im jg jh kq jj jk jl kr jn jo jp ks jr js jt hb bi translated">如前所述，我们将实现一个转发规则，允许流量定向到192.168.1.100，但带有一个速率限制检查，允许每10秒从一个特定的公共源地址发送一个数据包，突发3个(这实际上允许转发4个数据包，这可能是由于MikroTik dst-limit的工作方式，我没有深入研究这一点，因为实际效果与本指南的目的相同)。</p><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="afa1" class="ly jx hi lu b fi lz ma l mb mc"><strong class="lu hj">/ip firewall nat</strong><br/><strong class="lu hj">add</strong> <strong class="lu hj">action=dst-nat</strong> <strong class="lu hj">chain=dstnat</strong> dst-port=9999 in-interface=ether1 log=yes log-prefix=PRE-RT: protocol=udp \<br/>    to-addresses=192.168.1.100 to-ports=9<br/><br/><strong class="lu hj">/ip firewall filter</strong><br/><strong class="lu hj">add</strong> <strong class="lu hj">action=accept chain=forward</strong> <strong class="lu hj">dst-address=192.168.1.100</strong> <strong class="lu hj">dst-limit=1/10s,3,src-address</strong> in-interface=ether1 log=yes \<br/>    log-prefix=FWD: out-interface=lan_bridge<br/><strong class="lu hj">add</strong> <strong class="lu hj">action=drop chain=forward</strong> log=yes log-prefix=DROP:</span></pre><p id="3eb6" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><strong class="ja hj">注意:</strong>在上面的配置中，我记录了所有用于测试目的的丢弃，在实际设置中，我建议您对每个src地址的丢弃进行速率限制，以避免如果有人从互联网上向您发送大量邮件，您的日志收集器会收到大量邮件。</p><p id="f2de" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">在这里，您可以看到整个配置的可读性更好，语法在Sublime文本中突出显示:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es md"><img src="../Images/19c3b6ca7dffa7d2d2e2416f2355005d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LHIlcDfcC2dx3yelTsp2gg.png"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">RouterOS配置</figcaption></figure><h1 id="cb00" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">测试MikroTik设置</h1><p id="c624" class="pw-post-body-paragraph iy iz hi ja b jb ko ij jd je kp im jg jh kq jj jk jl kr jn jo jp ks jr js jt hb bi translated">为了测试我实现了什么，我在我的MacBook Pro上下载了wakeonlan软件包(来自MacPorts)，并用以下命令连续生成了10个魔术包(sudo只在第一次询问密码，因此该命令很快重复了10次):</p><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="ca72" class="ly jx hi lu b fi lz ma l mb mc">% for i in $(seq 1 10) ; do sudo <strong class="lu hj">wakeonlan -i 192.168.60.141 -p 9999 aa:bb:cc:dd:ee:ff</strong> ; done<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff</span></pre><p id="2f80" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我选择了<em class="ju"> aa:bb:cc:dd:ee:ff </em>作为被唤醒设备的Mac地址。让我们看看MikroTik日志，看看发生了什么:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mi"><img src="../Images/07c6ecf6074b77aa1fa5214b612a80fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZI75_TkIPRmfALJCsZZ7TQ.png"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">Mikrotik路由器上的日志</figcaption></figure><p id="b4f4" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">如您所见，<strong class="ja hj">预路由NAT (src-nat chain)规则因上述10个数据包而被触发10次，但允许流量通过的转发规则仅被触发4次</strong>，其他6次我们都有丢弃。</p><p id="ced5" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我还在PC接口Fa0/0(它是一个虚拟路由器，这就是接口有这样一个名称的原因)上开始了一个数据包捕获。Fa0/0接口通过eth2 MikroTik接口连接到MikroTik lan_bridge，实际上它通过DHCP获得IP地址:</p><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="1587" class="ly jx hi lu b fi lz ma l mb mc">PC#sh dhcp lease<br/>Temp IP addr: 192.168.1.49 for peer on Interface: FastEthernet0/0<br/>Temp sub net mask: 255.255.255.0<br/>DHCP Lease server: 192.168.1.1, state: 5 Bound<br/>DHCP transaction id: 18AE<br/>Lease: 600 secs, Renewal: 300 secs, Rebind: 525 secs<br/>Temp default-gateway addr: 192.168.1.1<br/>Next timer fires after: 00:04:53<br/>Retry count: 0 Client-ID: cisco-c202.0c94.0000-Fa0/0<br/>Client-ID hex dump: 636973636F2D633230322E306339342E<br/>303030302D4661302F30<br/>Hostname: PC</span></pre><p id="013e" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">Fa0/0接口由于其FF:FF:FF:FF:FF:FF目的mac地址而接收到神奇数据包，但随后它会忽略该数据包，因为它不包含目的地为其IP地址的流量。PC的唯一目的是在实验室中激活lan网段，并在内部lan上显示神奇的数据包接收。<strong class="ja hj">在下图中，您可以看到包含aa:bb:cc:dd:ee:ff mac地址的4个魔术包出现了16次</strong>:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mj"><img src="../Images/9f51f21b1b838cde32d7443c85254250.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gFMu4XN4VNfpRHYzI5puHA.png"/></div></div></figure><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mk"><img src="../Images/4b026a185f7e68331d3de634d36a49fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LjfMoNeuyqDkFIlHofuQVw.png"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">局域网唤醒神奇数据包捕获</figcaption></figure><p id="4cb2" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">你也可以通过手机使用IOS上的WOL等应用程序来生成魔法包:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ml"><img src="../Images/d89aadc1b42068f689c3cea8888506a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PgF816QWExlqCGyRDXbYfA.jpeg"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">IOS WOL应用程序界面</figcaption></figure><p id="97c2" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">你可以配置你的家用路由器在类似<a class="ae jv" href="https://www.noip.com" rel="noopener ugc nofollow" target="_blank"> No-IP </a>的服务上注册它的公共IP地址，然后用你注册的FQDN配置你的WOL app(比如myhomenetwork.no-ip.org<em class="ju"/>)。</p><h1 id="7c1b" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">结论</h1><p id="e942" class="pw-post-body-paragraph iy iz hi ja b jb ko ij jd je kp im jg jh kq jj jk jl kr jn jo jp ks jr js jt hb bi translated">这一想法归功于我的老板全球动力局，当我在考虑如何从公共网络触发内部局域网上的广播包时，他给我指出了正确的方向。我希望这将是一些快速MikroTik How-Tos的第一步，向您展示这些令人难以置信的低成本但功能强大的路由器的灵活性。我花了大约70欧元买了一个MikroTik Hap路由器，它能够管理我的1Gbps互联网连接，在5Ghz上有4–500 Mbps的无线数据速率峰值，有几十个防火墙规则，两个pppoe连接(一个在专用vrf中， 也许这将是下一篇文章的主题)和在后台运行以管理动态访问控制列表的脚本(我检查一些众所周知的FQDNs的IP地址，并将它们添加到具有到期时间的可信来源列表中，以便只允许一些公共IP地址访问我的家庭网络中的服务)。 如果你喜欢实验，看看MikroTik网站，如果你想不花一欧元进行实验，只需<a class="ae jv" href="https://mikrotik.com/download" rel="noopener ugc nofollow" target="_blank">下载MikroTik云路由器的虚拟映像</a>并在<a class="ae jv" href="https://www.eve-ng.net/index.php/community/" rel="noopener ugc nofollow" target="_blank"> EVE-NG网络模拟器</a>中启动它，就可以玩得开心了！😉</p></div><div class="ab cl mm mn gp mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="hb hc hd he hf"><p id="4efc" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><em class="ju">原载于2020年6月14日http://networkingpills.wordpress.com</em><a class="ae jv" href="https://networkingpills.wordpress.com/2020/06/14/wake-on-lan-from-public-network-mikrotik-practical-example/" rel="noopener ugc nofollow" target="_blank"><em class="ju"/></a><em class="ju">。</em></p></div></div>    
</body>
</html>