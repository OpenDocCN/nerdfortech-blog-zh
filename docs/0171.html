<html>
<head>
<title>Wake-On-Lan from Public Network (MikroTik practical example)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从公共网络唤醒局域网(MikroTik 实用示例)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/wake-on-lan-from-public-network-mikrotik-practical-example-b48551d9191e?source=collection_archive---------1-----------------------#2020-06-14">https://medium.com/nerd-for-tech/wake-on-lan-from-public-network-mikrotik-practical-example-b48551d9191e?source=collection_archive---------1-----------------------#2020-06-14</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="dcc2" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">一些网络设备和个人电脑甚至可以在关机时监听其以太网接口上传入的特殊数据包，这用于允许它们通过特殊的<em class="ix">神奇数据包</em>通电，该数据包由 Wake-On-Lan(从现在的 WOL)使用。让我们看看如何在基于 RouterOS 的 Mikrotik 路由器上使用公共网络中的 WOL。</h2></div><p id="63b7" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">WOL 通常通过生成目的 IP 地址为网络广播地址(在常见的 192.168.0.0/24 网络中，它被定向到 192.168.0.255 或 255.255.255.255)的数据包来完成，这将生成一个带有 FF:FF:FF:FF:FF:FF:FF:FF 目的 mac 地址的以太网帧。该广播帧由 lan 网段中的所有主机处理。是什么让这包<em class="ju">变魔术</em>？它必须包含要被唤醒的设备的 Mac 地址，重复 16 次。当断电设备的以太网卡检测到这个特殊帧时，它会给设备加电。</p><p id="3e68" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">通常魔术包是目的端口为 0、7 或 9 的 UDP 包，但这不是强制性的。顺便说一下，我将在示例中使用 UDP 端口 9。</p><p id="159c" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">你可以在维基百科上找到更多关于 WOL 的<a class="ae jv" href="https://en.wikipedia.org/wiki/Wake-on-LAN#Magic_packet" rel="noopener ugc nofollow" target="_blank">信息。</a></p><h1 id="5480" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">从互联网上使用 WOL</h1><p id="7de0" class="pw-post-body-paragraph iy iz hi ja b jb ko ij jd je kp im jg jh kq jj jk jl kr jn jo jp ks jr js jt hb bi translated">假设您的家庭网络中有一个 NAS，您希望仅在需要时才打开它，以获取您存储在其上的一些文档，并且您的家庭网络中没有其他活动的设备可供您连接以使用 WOL，那么从互联网上使用 WOL 不是很有用吗？如何从公共网络在内部 LAN 上生成广播帧？</p><p id="7ccd" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我在 Eve-NG network simulator 中构建了这个简单的设置，使用一个虚拟 MikroTik 路由器来模拟我们的家庭路由器，使用 eth1 作为 WAN 接口(我在 192.168.60.0/24 中使用私有 IP 地址，但将其视为在互联网上公开的公共地址),将 eth 2–3–4 分组到一个名为<em class="ju"> lan_bridge </em>的网桥中，IP 地址为 192.168.1.1/24，DHCP 服务器启用了 192 . 168 . 1 . 10–10</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es kt"><img src="../Images/0f293dcb54077add29b3a47e9e37850d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WwZD71Yfk6GGdGF773VlDQ.png"/></div></div></figure><p id="c36d" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们可以生成一个指向我们家用路由器的公共 IP 地址的神奇数据包，但是我们如何强迫它将它变成一个广播数据包呢？我想到的第一个最简单的解决方案是使用目的地 NAT 将目的地为 192.168.60.141 的神奇数据包更改为 192.168.1.255，但在基于 MikroTik 或 Linux 的路由器上，这不起作用(我认为不支持定向广播转发),数据包被丢弃。</p><p id="5960" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">那么，我们如何在 192.168.1.0/24 lan 上生成神奇的数据包来启动我们的设备呢？我们可以实现以下技巧:</p><ol class=""><li id="c947" class="lf lg hi ja b jb jc je jf jh lh jl li jp lj jt lk ll lm ln bi translated">分配 192.168.1.0/24 中未使用的 IP 地址，如 192.168.1.100</li><li id="ff18" class="lf lg hi ja b jb lo je lp jh lq jl lr jp ls jt lk ll lm ln bi translated">在 MikroTik 路由器上定义静态 ARP 解析，将 FF:FF:FF:FF:FF:FF 设置为 192.168.1.100 mac 地址</li><li id="f50d" class="lf lg hi ja b jb lo je lp jh lq jl lr jp ls jt lk ll lm ln bi translated">在 MikroTik 路由器上实施预路由目的地 nat 规则，以便通过将目的地地址更改为 192.168.1.100 并将目的地端口更改为 9，来更改定向到其面向互联网的接口和 UDP 端口 X(让我们选择 9999)的传入流量</li></ol><p id="a4a6" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">现在，当您将使用目标端口 9999/UDP 向 192.168.60.141 发送神奇数据包时，MikroTik 预路由 NAT 处理会将目标地址更改为 192.168.1.100。然后，MikroTik 将数据包路由到位于该子网上的 lan_bridge，当它准备包含转发数据包的以太网帧时，它会将 FF:FF:FF:FF:FF:FF:FF 作为目的 Mac 地址，从而在内部 lan 上产生一个广播数据包，即使目的 IP 地址是单播 IP。</p><p id="e58c" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><strong class="ja hj">安全警告:</strong>使用路由器公共地址上的 9999/UDP 端口发送的数据包会在您的内部网络上生成广播数据包，因此强烈建议对转发的数据包数量进行速率限制。</p><h1 id="334f" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">米克罗提克构型</h1><h1 id="ee7e" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">基本配置</h1><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="aceb" class="ly jx hi lu b fi lz ma l mb mc"># Bridge eth2-3-4<br/><strong class="lu hj">/interface bridge<br/></strong>add name=lan_bridge<br/><strong class="lu hj">/interface bridge vlan<br/></strong>add bridge=lan_bridge vlan-ids=1<br/><strong class="lu hj">/interface bridge port<br/></strong>add bridge=lan_bridge interface=ether2<br/>add bridge=lan_bridge interface=ether3<br/>add bridge=lan_bridge interface=ether4<br/><br/># Enable DHCP client on eth1 (WAN interface)<br/><strong class="lu hj">/ip dhcp-client<br/></strong>add disabled=no interface=ether1<br/><br/># Setup internal network and enable DHCP Server<br/><strong class="lu hj">/ip address</strong><br/>add address=192.168.1.1/24 interface=lan_bridge network=192.168.1.0<br/><strong class="lu hj">/ip pool</strong><br/>add name=dhcp_pool ranges=192.168.1.10-192.168.1.50<br/><strong class="lu hj">/ip dhcp-server<br/></strong>add address-pool=dhcp_pool disabled=no interface=lan_bridge name=dhcp_server<br/><strong class="lu hj">/ip dhcp-server network<br/></strong>add address=192.168.1.0/24 gateway=192.168.1.1 netmask=24</span></pre><h1 id="1068" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">ARP 解析“技巧”</h1><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="c5db" class="ly jx hi lu b fi lz ma l mb mc"><strong class="lu hj">/ip arp add address=192.168.1.100</strong> interface=lan_bridge <strong class="lu hj">mac-address=FF:FF:FF:FF:FF:FF</strong></span></pre><h1 id="91c2" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">防火墙 NAT 和转发规则</h1><p id="bbf0" class="pw-post-body-paragraph iy iz hi ja b jb ko ij jd je kp im jg jh kq jj jk jl kr jn jo jp ks jr js jt hb bi translated">如前所述，我们将实现一个转发规则，允许流量定向到 192.168.1.100，但带有一个速率限制检查，允许每 10 秒从一个特定的公共源地址发送一个数据包，突发 3 个(这实际上允许转发 4 个数据包，这可能是由于 MikroTik dst-limit 的工作方式，我没有深入研究这一点，因为实际效果与本指南的目的相同)。</p><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="afa1" class="ly jx hi lu b fi lz ma l mb mc"><strong class="lu hj">/ip firewall nat</strong><br/><strong class="lu hj">add</strong> <strong class="lu hj">action=dst-nat</strong> <strong class="lu hj">chain=dstnat</strong> dst-port=9999 in-interface=ether1 log=yes log-prefix=PRE-RT: protocol=udp \<br/>    to-addresses=192.168.1.100 to-ports=9<br/><br/><strong class="lu hj">/ip firewall filter</strong><br/><strong class="lu hj">add</strong> <strong class="lu hj">action=accept chain=forward</strong> <strong class="lu hj">dst-address=192.168.1.100</strong> <strong class="lu hj">dst-limit=1/10s,3,src-address</strong> in-interface=ether1 log=yes \<br/>    log-prefix=FWD: out-interface=lan_bridge<br/><strong class="lu hj">add</strong> <strong class="lu hj">action=drop chain=forward</strong> log=yes log-prefix=DROP:</span></pre><p id="3eb6" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><strong class="ja hj">注意:</strong>在上面的配置中，我记录了所有用于测试目的的丢弃，在实际设置中，我建议您对每个 src 地址的丢弃进行速率限制，以避免如果有人从互联网上向您发送大量邮件，您的日志收集器会收到大量邮件。</p><p id="f2de" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">在这里，您可以看到整个配置的可读性更好，语法在 Sublime 文本中突出显示:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es md"><img src="../Images/19c3b6ca7dffa7d2d2e2416f2355005d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LHIlcDfcC2dx3yelTsp2gg.png"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">RouterOS 配置</figcaption></figure><h1 id="cb00" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">测试 MikroTik 设置</h1><p id="c624" class="pw-post-body-paragraph iy iz hi ja b jb ko ij jd je kp im jg jh kq jj jk jl kr jn jo jp ks jr js jt hb bi translated">为了测试我实现了什么，我在我的 MacBook Pro 上下载了 wakeonlan 软件包(来自 MacPorts)，并用以下命令连续生成了 10 个魔术包(sudo 只在第一次询问密码，因此该命令很快重复了 10 次):</p><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="ca72" class="ly jx hi lu b fi lz ma l mb mc">% for i in $(seq 1 10) ; do sudo <strong class="lu hj">wakeonlan -i 192.168.60.141 -p 9999 aa:bb:cc:dd:ee:ff</strong> ; done<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff<br/>Sending magic packet to 192.168.60.141:9999 with aa:bb:cc:dd:ee:ff</span></pre><p id="2f80" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我选择了<em class="ju"> aa:bb:cc:dd:ee:ff </em>作为被唤醒设备的 Mac 地址。让我们看看 MikroTik 日志，看看发生了什么:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mi"><img src="../Images/07c6ecf6074b77aa1fa5214b612a80fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZI75_TkIPRmfALJCsZZ7TQ.png"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">Mikrotik 路由器上的日志</figcaption></figure><p id="b4f4" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">如您所见，<strong class="ja hj">预路由 NAT (src-nat chain)规则因上述 10 个数据包而被触发 10 次，但允许流量通过的转发规则仅被触发 4 次</strong>，其他 6 次我们都有丢弃。</p><p id="ced5" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我还在 PC 接口 Fa0/0(它是一个虚拟路由器，这就是接口有这样一个名称的原因)上开始了一个数据包捕获。Fa0/0 接口通过 eth2 MikroTik 接口连接到 MikroTik lan_bridge，实际上它通过 DHCP 获得 IP 地址:</p><pre class="ku kv kw kx fd lt lu lv lw aw lx bi"><span id="1587" class="ly jx hi lu b fi lz ma l mb mc">PC#sh dhcp lease<br/>Temp IP addr: 192.168.1.49 for peer on Interface: FastEthernet0/0<br/>Temp sub net mask: 255.255.255.0<br/>DHCP Lease server: 192.168.1.1, state: 5 Bound<br/>DHCP transaction id: 18AE<br/>Lease: 600 secs, Renewal: 300 secs, Rebind: 525 secs<br/>Temp default-gateway addr: 192.168.1.1<br/>Next timer fires after: 00:04:53<br/>Retry count: 0 Client-ID: cisco-c202.0c94.0000-Fa0/0<br/>Client-ID hex dump: 636973636F2D633230322E306339342E<br/>303030302D4661302F30<br/>Hostname: PC</span></pre><p id="013e" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">Fa0/0 接口由于其 FF:FF:FF:FF:FF:FF 目的 mac 地址而接收到神奇数据包，但随后它会忽略该数据包，因为它不包含目的地为其 IP 地址的流量。PC 的唯一目的是在实验室中激活 lan 网段，并在内部 lan 上显示神奇的数据包接收。<strong class="ja hj">在下图中，您可以看到包含 aa:bb:cc:dd:ee:ff mac 地址的 4 个魔术包出现了 16 次</strong>:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mj"><img src="../Images/9f51f21b1b838cde32d7443c85254250.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gFMu4XN4VNfpRHYzI5puHA.png"/></div></div></figure><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es mk"><img src="../Images/4b026a185f7e68331d3de634d36a49fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LjfMoNeuyqDkFIlHofuQVw.png"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">局域网唤醒神奇数据包捕获</figcaption></figure><p id="4cb2" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">你也可以通过手机使用 IOS 上的 WOL 等应用程序来生成魔法包:</p><figure class="ku kv kw kx fd ky er es paragraph-image"><div role="button" tabindex="0" class="kz la di lb bf lc"><div class="er es ml"><img src="../Images/d89aadc1b42068f689c3cea8888506a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PgF816QWExlqCGyRDXbYfA.jpeg"/></div></div><figcaption class="me mf et er es mg mh bd b be z dx translated">IOS WOL 应用程序界面</figcaption></figure><p id="97c2" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">你可以配置你的家用路由器在类似<a class="ae jv" href="https://www.noip.com" rel="noopener ugc nofollow" target="_blank"> No-IP </a>的服务上注册它的公共 IP 地址，然后用你注册的 FQDN 配置你的 WOL app(比如 myhomenetwork.no-ip.org<em class="ju"/>)。</p><h1 id="7c1b" class="jw jx hi bd jy jz ka kb kc kd ke kf kg io kh ip ki ir kj is kk iu kl iv km kn bi translated">结论</h1><p id="e942" class="pw-post-body-paragraph iy iz hi ja b jb ko ij jd je kp im jg jh kq jj jk jl kr jn jo jp ks jr js jt hb bi translated">这一想法归功于我的老板全球动力局，当我在考虑如何从公共网络触发内部局域网上的广播包时，他给我指出了正确的方向。我希望这将是一些快速 MikroTik How-Tos 的第一步，向您展示这些令人难以置信的低成本但功能强大的路由器的灵活性。我花了大约 70 欧元买了一个 MikroTik Hap 路由器，它能够管理我的 1Gbps 互联网连接，在 5Ghz 上有 4–500 Mbps 的无线数据速率峰值，有几十个防火墙规则，两个 pppoe 连接(一个在专用 vrf 中， 也许这将是下一篇文章的主题)和在后台运行以管理动态访问控制列表的脚本(我检查一些众所周知的 FQDNs 的 IP 地址，并将它们添加到具有到期时间的可信来源列表中，以便只允许一些公共 IP 地址访问我的家庭网络中的服务)。 如果你喜欢实验，看看 MikroTik 网站，如果你想不花一欧元进行实验，只需<a class="ae jv" href="https://mikrotik.com/download" rel="noopener ugc nofollow" target="_blank">下载 MikroTik 云路由器的虚拟映像</a>并在<a class="ae jv" href="https://www.eve-ng.net/index.php/community/" rel="noopener ugc nofollow" target="_blank"> EVE-NG 网络模拟器</a>中启动它，就可以玩得开心了！😉</p></div><div class="ab cl mm mn gp mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="hb hc hd he hf"><p id="4efc" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated"><em class="ju">原载于 2020 年 6 月 14 日 http://networkingpills.wordpress.com</em><a class="ae jv" href="https://networkingpills.wordpress.com/2020/06/14/wake-on-lan-from-public-network-mikrotik-practical-example/" rel="noopener ugc nofollow" target="_blank"><em class="ju"/></a><em class="ju">。</em></p></div></div>    
</body>
</html>