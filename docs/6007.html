<html>
<head>
<title>Model Productionization Architecture Design in Data Science | Become Expert in Model Deployment Designs | Designing is not just for Software Engineers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据科学中的模型生产化体系结构设计|成为模型部署设计的专家|设计不仅仅是软件工程师的事情</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/model-productionization-architecture-design-in-data-science-become-expert-in-model-deployment-47718f299829?source=collection_archive---------2-----------------------#2021-12-18">https://medium.com/nerd-for-tech/model-productionization-architecture-design-in-data-science-become-expert-in-model-deployment-47718f299829?source=collection_archive---------2-----------------------#2021-12-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/c1ef7e6b1e1129374a144c59660255f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/1*XpdVmHbfJsDzZ_GqmOEIWg.gif"/></div><figcaption class="im in et er es io ip bd b be z dx translated">数据科学家生产模型</figcaption></figure><p id="8355" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">许多公司努力将他们的数据科学项目投入生产。</p><p id="e709" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这主要是因为存在巨大的知识缺口，数据科学家很好地理解了模型构建，但缺乏生产技能。原因很简单，这些技能不会在Youtube视频上教授，也很难在数据科学课程或Kaggle学习方法中接触到。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es jo"><img src="../Images/50e51ab35c8baa8e3e8b688232af1e4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:596/0*EigdtzrU4k-Z2OR5"/></div><figcaption class="im in et er es io ip bd b be z dx translated">知识流动</figcaption></figure><blockquote class="jt"><p id="8a69" class="ju jv hi bd jw jx jy jz ka kb kc jn dx translated"><em class="kd">本新闻简报的目的是分享我从各种部署中获得的经验。</em></p><p id="7a70" class="ju jv hi bd jw jx ke kf kg kh ki jn dx translated"><em class="kd">部署的技术规则:较少依赖∝更快部署</em></p></blockquote><p id="7e8c" class="pw-post-body-paragraph iq ir hi is b it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj kn jl jm jn hb bi translated"><strong class="is hj">让我们通过一个实际问题来了解数据科学模型部署。</strong>我的一个朋友打电话给我，请求帮助他完成用例，并将模型部署到生产中。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es ko"><img src="../Images/dde905cd8e8ffe50c9b4486df39d8da7.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/0*UF0nqzoytzwV81-v"/></div><figcaption class="im in et er es io ip bd b be z dx translated">呼叫振铃</figcaption></figure><blockquote class="jt"><p id="c812" class="ju jv hi bd jw jx jy jz ka kb kc jn dx translated">我们对这个问题讨论了一两个小时，以了解制约因素。</p></blockquote><h2 id="40c6" class="kp kq hi bd kr ks kt ku kv kw kx ky kz jb la lb lc jf ld le lf jj lg lh li lj bi translated">讨论的约束摘要:</h2><ul class=""><li id="1dd2" class="lk ll hi is b it lm ix ln jb lo jf lp jj lq jn lr ls lt lu bi translated">数据源是弹性搜索(ES非常频繁地用新条目更新)</li><li id="df65" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">实时或接近实时的推理(可接受10分钟的延迟)</li><li id="e266" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">预算低</li><li id="c10f" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">具有回退的最小失效率</li><li id="d0a6" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">发生任何故障时的警报系统</li></ul><blockquote class="ma mb mc"><p id="c3ff" class="iq ir md is b it iu iv iw ix iy iz ja me jc jd je mf jg jh ji mg jk jl jm jn hb bi translated"><em class="hi">波斯特了解这些制约因素和问题，他正在努力解决。我提出了一个接近实时(每5分钟批量推断一次)的架构(检查下图)，回退到最后一次模型更新(后端从s3获取以前的更新结果)，并共享了一个slack webhook简单的警报路径。</em></p></blockquote><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es mh"><img src="../Images/5282a0b5c14ff36687ae6bbaef8835d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/0*W72eLtss1vgFLD1A"/></div><figcaption class="im in et er es io ip bd b be z dx translated">批量模型设计</figcaption></figure><p id="76ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">大约两个星期后，他打电话告诉我，🥳的解决方案很有效(情绪非常激动)。以上是经过试验和测试的:低预算和低维护——模型生产设计。</p><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es mi"><img src="../Images/4ce200c0cb555f1181e19911822b02bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/0*u_kx0ukOjKb553DW"/></div></figure><blockquote class="jt"><p id="a166" class="ju jv hi bd jw jx jy jz ka kb kc jn dx translated"><em class="kd">咱们讲道理！</em></p><p id="415d" class="ju jv hi bd jw jx ke kf kg kh ki jn dx translated"><em class="kd">以上架构设计如何解决约束</em></p></blockquote><p id="56d9" class="pw-post-body-paragraph iq ir hi is b it kj iv iw ix kk iz ja jb kl jd je jf km jh ji jj kn jl jm jn hb bi translated">替代Sagemaker批处理推断:这可能是一个很好的选择，但我们没有采用，因为他已经有一个24x7运行的EC2实例，并且没有得到充分利用。除了上述5分钟推理(近实时推理架构)，不使用Sagemaker批量推理更安全，而实时推理选项成本更高。</p><p id="1ae5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">开发熟悉度是构建架构设计时另一个超级重要的因素，EC2一直是他的乐园。</p><blockquote class="ma mb mc"><p id="4603" class="iq ir md is b it iu iv iw ix iy iz ja me jc jd je mf jg jh ji mg jk jl jm jn hb bi translated"><em class="hi">另一个学习点:如果您正在运行一个更新频率为1天的模型，并且您希望每次运行时都在新的EC2机器上运行任务计算，那么您仍然可以使用上述架构。人们可以关注这个博客来学习“</em> <a class="ae mj" href="https://aws.amazon.com/premiumsupport/knowledge-center/start-stop-lambda-cloudwatch/" rel="noopener ugc nofollow" target="_blank"> <em class="hi">”如何使用Lambda定期停止和启动Amazon EC2实例？</em> </a> <em class="hi">"这将有助于节省EC2机器的成本，因为它只运行到计算窗口。</em></p></blockquote><h2 id="82a4" class="kp kq hi bd kr ks mk ku kv kw ml ky kz jb mm lb lc jf mn le lf jj mo lh li lj bi translated">为什么是气流？</h2><p id="f617" class="pw-post-body-paragraph iq ir hi is b it lm iv iw ix ln iz ja jb mp jd je jf mq jh ji jj mr jl jm jn hb bi translated">Apache Airflow 是一个开源调度程序，用于管理您的日常工作。这是一个很好的工具，可以组织、执行和监控您的工作流，使它们无缝地工作。</p><p id="3bea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">气流将在定义的时间间隔内触发从ES和预测任务获取数据，对于上述情况，该时间间隔为每5分钟。要编写调度器表达式，可以使用<a class="ae mj" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank"> Crontab。Guru </a>(这个表情编写工具很优秀，我在写一个气流任务的时候经常用到)。</p><h2 id="8938" class="kp kq hi bd kr ks mk ku kv kw ml ky kz jb mm lb lc jf mn le lf jj mo lh li lj bi translated">关于架构的其他推理要点:</h2><ul class=""><li id="2060" class="lk ll hi is b it lm ix ln jb lo jf lp jj lq jn lr ls lt lu bi translated">模型从内存中的S3加载以进行推理，因此模型权重不使用本地磁盘存储。建议:我见过许多数据科学家将模型文件保存在机器存储器上，当EC2出现问题时，所有文件都会被删除，他们的努力也白费了。始终将S3上的模型作为备份“<a class="ae mj" href="https://docs.aws.amazon.com/aws-backup/latest/devguide/s3-backups.html" rel="noopener ugc nofollow" target="_blank">创建S3备份</a>”。也可以查看<a class="ae mj" href="https://dvc.org/" rel="noopener ugc nofollow" target="_blank">数据版本控制(DVC) </a>。</li><li id="3269" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">输出在S3被覆盖，后端从S3选择模型结果；S3存储在AWS上是可靠且最便宜的。</li><li id="8a14" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">对于警报，slack是最好的选择，因为它在办公时间总是打开的，当你不在时，你的团队成员可以看到警报，甚至可以添加气流故障和重试电子邮件，但我更喜欢办公室通信工具上的webhooks警报:slack/flock/teams。</li></ul><figure class="jp jq jr js fd ij er es paragraph-image"><div class="er es ms"><img src="../Images/326ce27f7d670cf39f6839ddc71cd8e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*YXFB8K039YvZWdSS"/></div><figcaption class="im in et er es io ip bd b be z dx translated">简单并不总能解决问题</figcaption></figure><blockquote class="ma mb mc"><p id="5086" class="iq ir md is b it iu iv iw ix iy iz ja me jc jd je mf jg jh ji mg jk jl jm jn hb bi translated"><em class="hi">我知道有更好的气流组件选择，如Dagster或Perfect相似性对于体系结构中的其他组件，有新的/可比较的替代方案。但是，在为您的模型管道选择工具时，永远不要忘记熟悉开发的因素。工具越老，支持越好，不能轻视它。</em></p></blockquote><blockquote class="jt"><p id="834a" class="ju jv hi bd jw jx jy jz ka kb kc jn dx translated">"如果我们想在生产中部署一个实时模型呢？"—我的朋友问，就连这里的读者也一定是这么想的。</p></blockquote><figure class="mu mv mw mx my ij er es paragraph-image"><div class="er es mt"><img src="../Images/fafacd3ea0f37a264191ede4a10df37e.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/0*PooTpVpcRv7_xmRp"/></div><figcaption class="im in et er es io ip bd b be z dx translated">我有个问题？</figcaption></figure><h2 id="9815" class="kp kq hi bd kr ks mk ku kv kw ml ky kz jb mm lb lc jf mn le lf jj mo lh li lj bi translated">我们讨论了限制因素，总结如下:</h2><ul class=""><li id="a691" class="lk ll hi is b it lm ix ln jb lo jf lp jj lq jn lr ls lt lu bi translated">从ES中获取项目池</li><li id="7843" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">需要100毫秒超时的实时模型输出</li><li id="7fd4" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">超时时，模型会退回到缓存版本</li><li id="1450" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">需要日志记录</li></ul><p id="fed8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是实时模型生产化架构设计👇</p><figure class="jp jq jr js fd ij er es paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="er es mz"><img src="../Images/7a7e3c3ed5f067c932a1f10fa88782ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eXUsgsey9xMVywie"/></div></div><figcaption class="im in et er es io ip bd b be z dx translated">实时模型设计</figcaption></figure><h2 id="9399" class="kp kq hi bd kr ks mk ku kv kw ml ky kz jb mm lb lc jf mn le lf jj mo lh li lj bi translated">实时架构的推理和其他要点</h2><ul class=""><li id="c201" class="lk ll hi is b it lm ix ln jb lo jf lp jj lq jn lr ls lt lu bi translated">我已经展示了部署在EC2上的dockerized模型。它也可以部署在ECS/SageMaker上，让您自己选择。</li><li id="061d" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">对于缓存—个人偏好<a class="ae mj" href="https://redis.com/" rel="noopener ugc nofollow" target="_blank"> Redis </a>。</li><li id="1a8a" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated"><a class="ae mj" href="https://www.elastic.co/kibana/" rel="noopener ugc nofollow" target="_blank"> Kibana </a>用于记录模型服务中的响应和信息日志</li><li id="021d" class="lk ll hi is b it lv ix lw jb lx jf ly jj lz jn lr ls lt lu bi translated">对于模型服务，可以使用<a class="ae mj" href="https://mlflow.org/" rel="noopener ugc nofollow" target="_blank"> MLFlow </a>、<a class="ae mj" href="https://docs.bentoml.org/en/0.13-lts/" rel="noopener ugc nofollow" target="_blank"> BentoML </a>、<a class="ae mj" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> FastAPI </a>、<a class="ae mj" href="https://www.cortex.dev/" rel="noopener ugc nofollow" target="_blank"> Cortex </a>等。我更喜欢BentoML，因为在10分钟之内，您将能够通过HTTP API端点提供您的ML模型，并构建一个docker映像，准备在生产中部署。</li></ul><h2 id="b576" class="kp kq hi bd kr ks mk ku kv kw ml ky kz jb mm lb lc jf mn le lf jj mo lh li lj bi translated">结论</h2><p id="f3c9" class="pw-post-body-paragraph iq ir hi is b it lm iv iw ix ln iz ja jb mp jd je jf mq jh ji jj mr jl jm jn hb bi translated">希望，数据科学模型生产化架构设计不再是一个超出教学大纲的问题，它总是比我们所能涵盖的要多得多，但确实要花些时间绞尽脑汁..！</p><h2 id="c718" class="kp kq hi bd kr ks mk ku kv kw ml ky kz jb mm lb lc jf mn le lf jj mo lh li lj bi translated">我希望你从这篇文章中学到了一些新的东西。如果你喜欢，点击👍或者❤️，并与他人分享。敬请期待下一期！</h2><p id="bee4" class="pw-post-body-paragraph iq ir hi is b it lm iv iw ix ln iz ja jb mp jd je jf mq jh ji jj mr jl jm jn hb bi translated">如果你觉得这篇文章有用，请在LinkedIn<a class="ae mj" href="https://www.linkedin.com/in/shaurya-uppal/" rel="noopener ugc nofollow" target="_blank">上联系、关注或支持我。要了解更多关于我的信息，请访问:</a><a class="ae mj" href="https://linktr.ee/shauryauppal" rel="noopener ugc nofollow" target="_blank">此处</a></p></div></div>    
</body>
</html>