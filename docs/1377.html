<html>
<head>
<title>Google OAuth2.0 Authentication — using Node JS and PassportJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google OAuth2.0身份验证—使用Node JS和PassportJS</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/google-oauth2-0-authentication-using-node-js-and-passportjs-1a77f42b1111?source=collection_archive---------0-----------------------#2021-03-16">https://medium.com/nerd-for-tech/google-oauth2-0-authentication-using-node-js-and-passportjs-1a77f42b1111?source=collection_archive---------0-----------------------#2021-03-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/3103196318f9ce8b4f211c5f9ccd68d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jziaGgpXMKp4ctC_"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated"><a class="ae iu" href="https://unsplash.com/@kai_wenzel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">凯文泽尔</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</figcaption></figure><blockquote class="iv"><p id="d894" class="iw ix hi bd iy iz ja jb jc jd je jf dx translated">Google登录，简化您与Google APIs的集成。用户可以选择在任何时候撤销对应用程序的访问。OAuth是作为一种身份验证协议开发的，因此任何OAuth流的结果都是应用程序获得一个访问令牌。可以获取或修改用户帐户的某些信息。就其本身而言，权限令牌除了说明用户是谁之外，什么都不说。</p></blockquote><p id="cd6f" class="pw-post-body-paragraph jg jh hi ji b jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc jf hb bi translated">在本文中，我将讨论如何用Node JS和Passport JS完成与Google Sign-In的基本集成。</p><h1 id="0490" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">初始化NodeJS项目</h1><p id="8444" class="pw-post-body-paragraph jg jh hi ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc jf hb bi translated">首先，让我们创建一个Express应用程序。创建一个名为的新文件夹，并初始化Node.js。</p><p id="944f" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">您可以在项目目录或您喜欢的ide终端中的命令提示符下给出下面的命令。然后它将创建一个<code class="du ll lm ln lo b">package.json</code>文件，并填写必要的字段。</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="8779" class="lx ke hi lo b fi ly lz l ma mb">npm init</span></pre><figure class="lp lq lr ls fd ij er es paragraph-image"><div class="er es mc"><img src="../Images/26fb9a2559ab592e8094598eb6715176.png" data-original-src="https://miro.medium.com/v2/resize:fit:674/format:webp/1*v07XyIVQXoPXMU7pbH9L4g.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">图01 —您可以填写项目的必要细节</figcaption></figure><p id="a319" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">如下编辑<code class="du ll lm ln lo b">package.json</code>文件的<strong class="ji hj">【脚本】</strong>，然后在创建的文件夹中创建一个server.js文件。</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="2a33" class="lx ke hi lo b fi ly lz l ma mb">"scripts": {<br/> "test": "node server.js",<br/> "start": "nodemon server.js"<br/> }</span></pre><p id="1552" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">初始化节点项目后，安装所有必需的包。为此，我正在下载以下软件包。</p><p id="4415" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><strong class="ji hj"> express </strong> —面向服务器和API系统的轻量级应用。</p><p id="d34b" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><strong class="ji hj"> nodemon </strong> —这个包使运行服务器变得容易(在我们对我们的应用程序进行更改后，我们不必手动重新运行服务器)</p><p id="00da" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><strong class="ji hj"> cookie会话</strong> —存储会话。</p><p id="5e96" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><strong class="ji hj"> passport </strong> —节点和Express JS的认证中间件</p><p id="8096" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><strong class="ji hj">passport google oauth 20</strong>—passport认证策略，帮助您使用Google帐户登录。</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="9318" class="lx ke hi lo b fi ly lz l ma mb">npm install express nodemon cookie-session passport passport-google-oauth20 — save</span></pre><p id="2ed8" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">上面的命令安装所有的包。安装后，将下面的代码复制到您的<code class="du ll lm ln lo b">server.js </code>文件中，以测试我们创建的应用程序。</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="25f6" class="lx ke hi lo b fi ly lz l ma mb">const express = require(‘express’)<br/> const app = express()app.get(‘/’,(req,res)=&gt;{<br/> res.send(‘Hello world’)<br/> })app.listen(5000,()=&gt;{<br/> console.log(‘Serve is up and running at the port 5000’)<br/> })</span></pre><p id="ea4b" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">使用以下命令启动服务器:</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="2a92" class="lx ke hi lo b fi ly lz l ma mb">npm start</span></pre><p id="305f" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">然后导航到<a class="ae iu" href="http://localhost:5000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:5000/ </a>。你可以看到<strong class="ji hj">【你好世界】</strong>显示在你的浏览器中。</p><p id="4f2d" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">现在我们可以开始我们的身份验证应用程序了。我们开始吧😎</p><h1 id="437a" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">什么是Passport JS？</h1><p id="3b9f" class="pw-post-body-paragraph jg jh hi ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc jf hb bi translated"><a class="ae iu" href="http://www.passportjs.org/" rel="noopener ugc nofollow" target="_blank"> Passport JS </a>是express.js的一个<strong class="ji hj">中间件</strong>(下面我会解释一下中间件)。Passport JS支持各种登录类型，Token，Local(用户名，密码)，OAuth，OAuth2等。我们可以将这些结合起来，通过登录Google、FB或其他任何服务，用最少的代码进行认证。</p><p id="5de6" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">我们还可以使用它来连接外部身份验证服务，以选择使用选定的策略之一登录，例如Google、Twitter。使用Passport JS进行身份验证比自己从头构建要快得多。所以，这就是我们用Passport JS的原因。为此你不需要Passport JS，它只是让开发更快。</p><p id="a1b4" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><strong class="ji hj">一个中间件可以执行以下任务</strong> <br/>它可以执行任何代码。<br/>它将对请求和响应的对象进行调整。<br/>它将终止请求-响应的循环。<br/>在堆栈中，它将调用下一个中间件函数。</p><h1 id="32bc" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">什么是中间件？</h1><p id="9455" class="pw-post-body-paragraph jg jh hi ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc jf hb bi translated">在初始请求和最终期望的路由之间，中间件出现在中间。中间件特性通常按照它们被添加的顺序在栈中被调用。<br/>中间件广泛用于执行URL编码的任务或JSON请求体解析，cookie解析便于cookie处理。</p></div><div class="ab cl md me gp mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="hb hc hd he hf"><h1 id="15b6" class="kd ke hi bd kf kg mk ki kj kk ml km kn ko mm kq kr ks mn ku kv kw mo ky kz la bi translated">创建OAuth客户端ID</h1><p id="6dc4" class="pw-post-body-paragraph jg jh hi ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc jf hb bi translated">首先，你需要<a class="ae iu" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">创建一个谷歌云项目</a>。</p><p id="6ee3" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">您需要配置您的<strong class="ji hj"> OAuth同意屏幕</strong>。选择<strong class="ji hj">外部</strong>。然后，谷歌会询问应用程序的名称和标识，以及一些开发者的联系方式。</p><p id="e04d" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">然后，它将询问我们想要请求什么<strong class="ji hj">范围</strong>——读取数据和代表我们的用户采取行动的特殊权限。对于我们的例子，我们不需要这些。</p><p id="e1e1" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">最后，我们将添加我们自己的Google帐户作为测试用户。</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mp"><img src="../Images/fdcf85156da2ac19f1934ee0fd42a400.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*7F11JADlgnGlnF83a5Vkdw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">图02—GCP的证书页面</figcaption></figure><p id="dda6" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">现在我们可以转到<strong class="ji hj">凭证</strong>屏幕，为web应用程序创建一个新的<strong class="ji hj"> OAuth客户端ID </strong>(单击凭证屏幕顶部的+Create Credentials)<strong class="ji hj"/>。给它起一个你喜欢的名字。</p><p id="603b" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">谷歌将要求我们授权的来源和重定向URI。目前，我们关心本地测试，所以我们可以对两者都使用下面的值:</p><p id="9933" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><a class="ae iu" href="http://localhost:5000/google/callback" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/Google/回调</a></p><p id="2c09" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">创建后，您可以看到显示<strong class="ji hj">客户端ID </strong>和客户端密码的屏幕，如下所示。</p><figure class="lp lq lr ls fd ij er es paragraph-image"><div class="er es mp"><img src="../Images/3b31f18183d602ea6824d41f1afeaa24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*r4Y6nw-9oKnKkL-39AA8JA.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">图03 —我们可以在这个屏幕中看到客户端ID</figcaption></figure><p id="8f5c" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">然后谷歌会给我们一个客户端ID和客户端密码。在这种情况下，我们需要客户ID。</p><h1 id="9aca" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">配置Passport JS</h1><p id="c1b6" class="pw-post-body-paragraph jg jh hi ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc jf hb bi translated">现在，让我们开始整合我们的项目与谷歌认证。为此，我正在创建一个名为passport.js的新文件，它存储我们拥有的凭证。</p><p id="7db8" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">这里我们使用<code class="du ll lm ln lo b"><strong class="ji hj">GoogleStrategy</strong></code>,因为我们希望通过google进行身份验证。您可以从<a class="ae iu" href="http://www.passportjs.org/packages/passport-google-oauth2/" rel="noopener ugc nofollow" target="_blank">passport-Google-oauth 2(passportjs.org)</a>了解更多关于<code class="du ll lm ln lo b"><strong class="ji hj">GoogleStrategy</strong></code>的信息</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="9509" class="lx ke hi lo b fi ly lz l ma mb"><strong class="lo hj">clientID:"</strong>use the client ID given by Google", <br/><strong class="lo hj">clientSecret:"</strong>use the client secret given by Google", <strong class="lo hj">callbackURL:"</strong>URL that the user gets redirected after login into google."</span></pre><p id="68de" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><code class="du ll lm ln lo b">passport.js</code>文件应该包括以下代码:</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="mq mr l"/></div></figure><p id="a81c" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">身份验证成功后，用户详细信息将保存在cookie中。</p><h1 id="cc9f" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">路线测试</h1><p id="611c" class="pw-post-body-paragraph jg jh hi ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc jf hb bi translated">路由<code class="du ll lm ln lo b">/google</code>将客户端重定向到Google登录页面。</p><p id="46dd" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">如果Google认证成功，路由<code class="du ll lm ln lo b">/google/callback</code>将作为一个回调URL被调用。</p><p id="8332" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">Google认证成功后会调用路线<code class="du ll lm ln lo b">/success</code>。</p><p id="4a61" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">如果在Google认证期间出现任何故障，将调用路径<code class="du ll lm ln lo b">/failed</code>。</p><p id="b3dd" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">现在导航到<a class="ae iu" href="http://localhost:5000/google/" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/Google/</a>。您将被重定向到谷歌的登录页面。登录您的Google帐户后，您将被重定向回您的网页，您将看到您的电子邮件地址显示在您的网页上。</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="mq mr l"/></div></figure><h1 id="67f0" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">保护路由并添加注销视图</h1><p id="ee29" class="pw-post-body-paragraph jg jh hi ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc jf hb bi translated">在没有登录的情况下打开路由<a class="ae iu" href="http://localhost:5000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:5000/ </a>可以看到一个错误，就是没有定位到邮件地址。我正在创建一个中间件来消除检查用户是否在server.js中登录的错误。</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="658a" class="lx ke hi lo b fi ly lz l ma mb">const isLoggedIn = (req, res, next) =&gt; {<br/> if (req.user) {<br/> next();<br/> } else {<br/> res.sendStatus(401);<br/> }<br/> }</span></pre><p id="7b47" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">一旦完成，将中间件传递给路由<code class="du ll lm ln lo b"> /success</code>。所以登录的用户只能访问<code class="du ll lm ln lo b"> /success</code>路线。</p><p id="0169" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">现在让我们创建一个注销特性。您只需调用<code class="du ll lm ln lo b">req.logout()</code>功能即可注销您的Google帐户。</p><p id="0046" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><code class="du ll lm ln lo b">server.js</code>文件应该包括以下代码:</p><pre class="lp lq lr ls fd lt lo lu lv aw lw bi"><span id="ddc1" class="lx ke hi lo b fi ly lz l ma mb">app.get(“/logout”, (req, res) =&gt; {<br/> req.session = null;<br/> req.logout();<br/> res.redirect(‘/’);<br/> })</span></pre><p id="b20f" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">只需导航到<a class="ae iu" href="http://localhost:5000/logout" rel="noopener ugc nofollow" target="_blank">http://localhost:5000/logout</a>。您将被注销。</p><p id="7cfd" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated">最后<code class="du ll lm ln lo b">server.js</code>看起来是这样的:</p><figure class="lp lq lr ls fd ij"><div class="bz dy l di"><div class="mq mr l"/></div></figure><h1 id="5478" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">结论</h1><p id="78ee" class="pw-post-body-paragraph jg jh hi ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc jf hb bi translated">在本文中，我们学习了如何用NodeJS和PassportJS设置google OAuth2.0。如上所述，我们还可以使用PassportJS中的其他各种策略来设置脸书、Twitter GitHub认证。我想这篇文章会对你有很好的帮助，让我们在不久的将来遇到另一篇有趣的文章。😊</p><h1 id="40b7" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">参考</h1><p id="1259" class="pw-post-body-paragraph jg jh hi ji b jj lb jl jm jn lc jp jq jr ld jt ju jv le jx jy jz lf kb kc jf hb bi translated"><a class="ae iu" href="http://www.passportjs.org/" rel="noopener ugc nofollow" target="_blank"> Passport.js </a></p><p id="2874" class="pw-post-body-paragraph jg jh hi ji b jj lg jl jm jn lh jp jq jr li jt ju jv lj jx jy jz lk kb kc jf hb bi translated"><a class="ae iu" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a></p></div></div>    
</body>
</html>