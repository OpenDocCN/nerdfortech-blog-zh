<html>
<head>
<title>Query MS Graph API in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 Python 查询 MS Graph API</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/query-ms-graph-api-in-python-e8e04490b04e?source=collection_archive---------0-----------------------#2022-06-25">https://medium.com/nerd-for-tech/query-ms-graph-api-in-python-e8e04490b04e?source=collection_archive---------0-----------------------#2022-06-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="c6e9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用客户端 ID 和密码开始使用 Python 项目中的 Microsoft 365 数据</h2></div><h1 id="bbb6" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated"><strong class="ak">简介</strong></h1><p id="a4ab" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">在与那些 IT 生态系统围绕微软平台构建的客户合作时，我多次面临连接底层数据以进行各种数据分析或自动化的需求。在本文中，我将一步一步地介绍如何使用客户端 ID 和密码连接到 Microsoft Graph API，以验证数据并将其加载到 Python 项目中。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kl"><img src="../Images/d9f2076c149e598b51bc79feef7f35d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*haK4e0Vwb0-YaUJU"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated"><a class="ae lb" href="https://unsplash.com/@windows?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">车窗</a>在<a class="ae lb" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">挡泥板</a>上拍照</figcaption></figure><h1 id="d0b1" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">创建 Azure 广告应用程序注册</h1><p id="673a" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">为了授权我们对 API 的调用，我们需要 Azure AD 应用程序注册。使用具有全局管理员权限的帐户登录到 https://portal.azure.com/的 Azure 门户网站。</p><blockquote class="lc ld le"><p id="8098" class="jp jq lf jr b js lg ij ju jv lh im jx li lj ka kb lk ll ke kf lm ln ki kj kk hb bi translated">如果您没有全局管理权限，您可以稍后请求您组织中有权限的其他人授予您应用程序的管理权限。</p></blockquote><p id="d960" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">打开<strong class="jr hj">应用注册</strong>服务，方法是在屏幕顶部的搜索字段中搜索该服务，或者使用左侧门户导航转到 Azure Active Directory →应用注册。</p><p id="f836" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">点击<strong class="jr hj">新注册</strong>。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div class="er es lo"><img src="../Images/0c4256bcd1296284c034544736267d0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*Ztd8B2wzbB5nMk6jd_kpfQ.png"/></div></figure><p id="d3df" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">选择应用注册的名称、支持的帐户类型并重定向 URI。然后点击<strong class="jr hj">注册</strong>按钮。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lp"><img src="../Images/9cda666a952f6b16641f62a9259ba2d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pJCkUucl7jlNpqoZXtwLQQ.png"/></div></div></figure><p id="0ec3" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">成功注册应用程序后，您将看到它的概述。注意<strong class="jr hj">应用程序(客户端)ID </strong>和<strong class="jr hj">目录(租户)ID </strong>并复制它们的值，我们稍后将需要它们。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lq"><img src="../Images/bdfbf17723f6a48ae97ab5cba349a6eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UJUCPRBum0khopInbusxmw.png"/></div></div></figure><p id="b5a4" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">现在，让我们生成一个请求访问令牌时需要的秘密。转到<strong class="jr hj">证书&amp;机密</strong>并点击<strong class="jr hj">新客户机密</strong>。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lr"><img src="../Images/e51d3765551c3394448e5d387a901575.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*07e9r6G6n5Et3B30DLfp2g.png"/></div></div></figure><p id="a493" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">您可以在<strong class="jr hj">添加客户端密码</strong>窗格中更改密码的描述和到期时间。然后点击<strong class="jr hj">添加</strong>。请注意，密码过期后，您需要生成一个新密码。</p><p id="60fb" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">确保通过点击<strong class="jr hj">复制到剪贴板</strong>按钮复制整个秘密值。秘密只有在创建后才立即可见。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es ls"><img src="../Images/bd843074f02000b4ce1559e654cdeed4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V3B8jwINmnnge9GsQxhTRw.png"/></div></div></figure><p id="b745" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">现在，让我们为应用程序注册配置权限。转到<strong class="jr hj"> API 权限</strong>并点击<strong class="jr hj">添加权限</strong>。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lt"><img src="../Images/dc6a8a6fa2d349aae75d612bb31d47b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oulockh4DpGELdmUAzf9EA.png"/></div></div></figure><p id="c74f" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">选择<strong class="jr hj">微软图形</strong> → <strong class="jr hj">应用权限</strong>。然后找到您的应用程序所需的权限，选择它们并点击<strong class="jr hj">添加权限</strong>。在这个例子中，我们将查询 Azure 广告组的成员，为此我们需要该组。Read.All 和 User。读取。所有权限。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lu"><img src="../Images/cd7b22abafecda60b276435ea1baf926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0anx-tsYuj9HE2ek14fZeA.png"/></div></div></figure><p id="c79a" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">使用具有全局管理员权限的帐户，单击<strong class="jr hj">授予管理员权限……按钮</strong>。如果您没有权限，请向您组织中能够授予您的应用程序管理员许可的人询问。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lv"><img src="../Images/d5bb90f18758a65ae2a85a3df27d47d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iS7uFPb-z94gXudrRov8Dg.png"/></div></div></figure><p id="b5f6" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">完成后，您应该会在所有权限旁边看到一个绿色的勾号。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es lw"><img src="../Images/5b2a4fa31c5a0ff7e6e46db7b02e4ac6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YqRAOGiFsAP0TfuoeK1s5g.png"/></div></div></figure><p id="ff13" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">就是这样！应用程序注册现在已经配置好了，我们可以使用客户端 ID 和密码来授权我们对 Microsoft Graph API 的请求。</p><h1 id="2233" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">获取访问令牌</h1><p id="5dca" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">当向 MS Graph API 发送请求时，我们需要在请求头中提供一个访问令牌。在本文中，我们将使用 Python 的<code class="du lx ly lz ma b">msal</code>库来获取令牌。</p><p id="58ba" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">代码实现非常简单。不要忘记用你的 Azure 广告应用注册的值来更新<code class="du lx ly lz ma b">client_id</code>、<code class="du lx ly lz ma b">client_secret</code>和<code class="du lx ly lz ma b">authority</code>变量。</p><figure class="km kn ko kp fd kq"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="5882" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">运行代码后，您应该会看到类似的结果(实际的令牌会有所不同):</p><figure class="km kn ko kp fd kq er es paragraph-image"><div class="er es md"><img src="../Images/ea0cccf811db46a7307267ccec44c815.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*mzc2FrgHdmitTY4LCYQfkg.png"/></div></figure><p id="b729" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">当您再次运行从第 16 行开始的代码时(例如在 jupyter 笔记本中)，您应该看到访问令牌是从缓存中加载的，实际的令牌应该与之前相同。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div class="er es me"><img src="../Images/77599702dd301bfa773b6ff273e19035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*9Wht20J_uWoMkUuxNjz8SQ.png"/></div></figure><p id="51a3" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">稍后我们将重构代码。现在让我们第一次调用 MS Graph API！</p><h1 id="ada9" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">使用 client_id 和 secret 查询 MS 图</h1><p id="c73b" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">为了从 MS Graph API 获取数据，我们将使用 Python 中的<code class="du lx ly lz ma b">requests</code>库发出 get 请求。</p><figure class="km kn ko kp fd kq"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="91eb" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">如果请求成功，您应该会看到以 JSON 格式打印出来的结果的第一页(通常是前 100 项)。关于组的信息存储在数组<code class="du lx ly lz ma b">value</code>中。在截图中，JSON 输出已经被美化了。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div class="er es mf"><img src="../Images/235ce98d1a50083376070f72a7bae834.png" data-original-src="https://miro.medium.com/v2/resize:fit:1302/format:webp/1*gcOWFuleeA5XjYUu3oPPsQ.png"/></div><figcaption class="kx ky et er es kz la bd b be z dx translated">MS Graph API 响应示例</figcaption></figure><h2 id="271e" class="mg iy hi bd iz mh mi mj jd mk ml mm jh jy mn mo jj kc mp mq jl kg mr ms jn mt bi translated">页码</h2><p id="34fc" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">注意响应第二行的<code class="du lx ly lz ma b">@odata.nextLink</code>属性。这表明返回的数据不完整，我们需要遍历多个页面来检索所有数据。</p><p id="dc3d" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">幸运的是，MS Graph API 让这一切变得非常容易。<code class="du lx ly lz ma b">@odata.nextLink</code>属性仅在下一页包含更多数据时可用。我们需要做的是在响应中检查这个属性，只要它在那里，就将端点 URL 更改为它的值。</p><p id="7e6c" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">在 Python 中，它可能是这样的:</p><figure class="km kn ko kp fd kq"><div class="bz dy l di"><div class="mb mc l"/></div></figure><h1 id="8c32" class="ix iy hi bd iz ja jb jc jd je jf jg jh io ji ip jj ir jk is jl iu jm iv jn jo bi translated">重构和总结</h1><p id="90bf" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">我们经历了查询 Microsoft Graph API 以将数据放入 Python 项目的所有重要步骤。最后一步是重构代码。让我们创建一个<code class="du lx ly lz ma b">make_graph_call</code>函数，它负责获取一个访问令牌，从 API 获取数据并以 JSON 格式返回它们。该函数有两个参数——URL(我们调用的图形 API 端点)和 pagination(可选参数，如果设置为<code class="du lx ly lz ma b">False</code>，则只允许查询结果的第一页)。</p><figure class="km kn ko kp fd kq"><div class="bz dy l di"><div class="mb mc l"/></div></figure><p id="0256" class="pw-post-body-paragraph jp jq hi jr b js lg ij ju jv lh im jx jy lj ka kb kc ll ke kf kg ln ki kj kk hb bi translated">我希望你喜欢这个教程！请在评论中分享你的反馈。</p></div></div>    
</body>
</html>