<html>
<head>
<title>How to create tensorflow tfrecords out of any dataset:</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从任何数据集创建张量流tfrecords:</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-create-tensorflow-tfrecords-out-of-any-dataset-c64c3f98f4f8?source=collection_archive---------1-----------------------#2021-01-23">https://medium.com/nerd-for-tech/how-to-create-tensorflow-tfrecords-out-of-any-dataset-c64c3f98f4f8?source=collection_archive---------1-----------------------#2021-01-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6bce" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">一个完整的一步一步的教程，绝对初学者与例子</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/2eb3adcddfbf8685a7f64373e24d8622.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I9JhYb4nvzLJPzZHW7OFMA.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图片由<a class="ae jn" href="https://unsplash.com/photos/2xEQDxB0ss4" rel="noopener ugc nofollow" target="_blank"> dlanor_s: Unsplash </a></figcaption></figure><p id="5baf" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi kk translated"><span class="l kl km kn bm ko kp kq kr ks di"> W </span>在处理深度学习模型时，我们经常使用非常大的数据集。以占用较少空间的二进制文件格式存储它们非常有用，这样可以缩短训练时间。TFRecord格式是tensorflow中用于存储二进制记录序列的简单格式。我将一步一步地完成创建tfrecord的过程。但是在我们深入研究之前，我们需要了解一个叫做协议缓冲区的东西</p><h1 id="7f0f" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated">那么，什么是协议缓冲区？</h1><p id="c2df" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">协议缓冲区(或protobuf)用于结构化数据的高效序列化。假设您有两个用两种不同语言编写的服务。现在你需要在它们之间传递数据和通信。有一个问题，两种语言可能使用不同的格式来存储数据。所以我们需要一种中立的方式来传递数据。这正是protobuf所做的。它有助于序列化数据和在服务之间传递消息，确保类型一致性。这是一种跨平台、跨语言的库方式，用于结构化数据的高效序列化</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="lq lr l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">【GIPHY的gif</figcaption></figure><blockquote class="ls lt lu"><p id="729f" class="jo jp lv jq b jr js ij jt ju jv im jw lw jy jz ka lx kc kd ke ly kg kh ki kj hb bi translated">注意:如果你想了解更多关于协议缓冲区的知识，我发现这个<a class="ae jn" href="https://www.youtube.com/watch?v=BywIOD_Y3CE" rel="noopener ugc nofollow" target="_blank">视频</a>非常有用</p></blockquote><h1 id="410b" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated"><strong class="ak">将数据集转换为tfrecord: </strong></h1><p id="ff9d" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">Tensorflow有一个名为<strong class="jq hj"> tf.train.Example </strong>的东西，它保存我们希望tfrecords保存的protobuf消息(数据)。<strong class="jq hj"> tf.train.Example </strong>是一个{ " string ":<strong class="jq hj">tf.train.Feature</strong>}映射，其中TF . train . feature保存一个特征值。我们将这些tf.train.Examples写入tfrecord数据集。</p><h2 id="92d2" class="lz ku hi bd kv ma mb mc kz md me mf ld jx mg mh lf kb mi mj lh kf mk ml lj mm bi translated">创建tfrecord有三个步骤:</h2><ol class=""><li id="df80" class="mn mo hi jq b jr ll ju lm jx mp kb mq kf mr kj ms mt mu mv bi translated">将每个观测值转换为tf.train.Feature可接受的格式</li></ol><p id="d7ea" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 2。</strong>使用tf.train.Example映射特性并创建特性消息</p><p id="fdc1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> 3。</strong>将<strong class="jq hj"> </strong>的tf.train.Example消息序列化成tfrecord文件。</p><h2 id="ef55" class="lz ku hi bd kv ma mb mc kz md me mf ld jx mg mh lf kb mi mj lh kf mk ml lj mm bi translated">步骤1:将每个观测值转换成tf.train.Feature可接受的格式:</h2><p id="7b44" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">tf.train.Feature可以接受三种类型，它们是BytesList、Int64List和FloatList</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mw"><img src="../Images/5785c9bc65ac9ce3ff0f35194df361e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nUql8b48zXrA0GDONp10Zw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">作者图片</figcaption></figure><p id="6827" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">根据我们观察到的值的类型，我们必须首先将它们转换成BytesList、Int64List或FloatList。Tensorflow <a class="ae jn" href="https://www.tensorflow.org/tutorials/load_data/tfrecord" rel="noopener ugc nofollow" target="_blank"> docs </a>为我们提供了三个超级简单的快捷函数来帮助转换。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mx lr l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated"><a class="ae jn" href="https://www.tensorflow.org/tutorials/load_data/tfrecord" rel="noopener ugc nofollow" target="_blank">来自Tensorflow文档的代码</a></figcaption></figure><p id="e34e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这段代码返回一个tf.train.Feature，其中包含我们观察到的值。所以如果我对这些值调用这个函数:</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="31b4" class="lz ku hi mz b fi nd ne l nf ng"><strong class="mz hj">print(_bytes_feature(b'test_string'))<br/>print(_bytes_feature(u'test_bytes'.encode('utf-8')))<br/><br/>print(_float_feature(np.exp(1)))<br/><br/>print(_int64_feature(True))<br/>print(_int64_feature(1))</strong></span></pre><p id="fa93" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是我会得到的回报</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="1f90" class="lz ku hi mz b fi nd ne l nf ng"><strong class="mz hj">bytes_list {<br/>  value: "test_string"<br/>}<br/><br/>bytes_list {<br/>  value: "test_bytes"<br/>}<br/><br/>float_list {<br/>  value: 2.7182817459106445<br/>}<br/><br/>int64_list {<br/>  value: 1<br/>}<br/><br/>int64_list {<br/>  value: 1<br/>}</strong></span></pre><p id="1096" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">扎实！既然我们已经有了tf.train.Feature值，现在可以将它们映射到tf.train.Example中</p><h2 id="cde2" class="lz ku hi bd kv ma mb mc kz md me mf ld jx mg mh lf kb mi mj lh kf mk ml lj mm bi translated">步骤2:映射特性并使用tf.train创建特性消息。示例:</h2><p id="e65c" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">这一步非常简单，老实说，和你如何映射一个普通的字典没有什么不同。一旦您映射了所有内容，您需要使用tf.train.Example创建一个特征消息。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mx lr l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated"><a class="ae jn" href="https://www.tensorflow.org/tutorials/load_data/tfrecord" rel="noopener ugc nofollow" target="_blank">来自tensorflow文档的代码</a></figcaption></figure><p id="5a3a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">太好了！我们现在有一个观察的tf.train.Example。这是一条原始消息。下一步是将这个观察结果写入tfrecord</p><h2 id="59e5" class="lz ku hi bd kv ma mb mc kz md me mf ld jx mg mh lf kb mi mj lh kf mk ml lj mm bi translated">步骤3:将tf.train.Example消息序列化为tfrecord文件:</h2><p id="d145" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">tf.train.Example中的消息可以使用<code class="du nh ni nj mz b">.SerializeToString</code>方法序列化为二进制字符串。让我们把上面的两个步骤放在一个函数中。这个函数返回我们观察的序列化消息。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mx lr l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated"><a class="ae jn" href="https://www.tensorflow.org/tutorials/load_data/tfrecord" rel="noopener ugc nofollow" target="_blank">来自tensorflow文档的代码</a></figcaption></figure><p id="6ab4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">最后一步当然是将我们的proto消息写入tfrecord。为此，我们首先初始化一个编写器。</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="4444" class="lz ku hi mz b fi nd ne l nf ng"><strong class="mz hj">filename = 'test.tfrecord'</strong><br/><strong class="mz hj">writer = tf.data.experimental.TFRecordWriter(filename)</strong></span></pre><p id="65bb" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">filename参数接受您想要存储tf记录的路径。您现在要做的就是将序列化的消息传递给编写器</p><pre class="iy iz ja jb fd my mz na nb aw nc bi"><span id="e8d7" class="lz ku hi mz b fi nd ne l nf ng"><strong class="mz hj">writer.write(example.SerializeToString())</strong></span></pre><p id="eafd" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">就是这样！恭喜，我们已经成功地将观察结果写入tfrecord。要添加所有的观察值，您所要做的就是迭代您的数据集，并逐个写入它们。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mx lr l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated"><a class="ae jn" href="https://www.tensorflow.org/tutorials/load_data/tfrecord" rel="noopener ugc nofollow" target="_blank">来自张量流文档的代码</a></figcaption></figure><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="nk lr l"/></div></figure><h1 id="c6ca" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated">编写tfrecord的端到端示例:</h1><p id="7909" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">我现在将向你展示一个我如何将kaggle的pokemon数据转换成tfrecord的例子。数据由单独文件中的标签和图像组成。我通常喜欢将tfrecords存储在我的驱动器中，并从那里使用它。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es nl"><img src="../Images/189fd3913be6bdb42d2161aa81062d99.png" data-original-src="https://miro.medium.com/v2/resize:fit:384/format:webp/1*-tvjZxOIaVks4BkXyVnO9w.png"/></div></figure><p id="f6dc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">像往常一样，我首先复制粘贴助手函数来转换数据，并编辑上面的<code class="du nh ni nj mz b">serialize_example.py</code>方法来根据我的数据改变映射。</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mx lr l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">作者代码</figcaption></figure><p id="437b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj"> <em class="lv">注:</em> </strong> <em class="lv">我喜欢把我的图片转换成像素值的平面数组，并发送给help函数进行转换。在这种情况下，在_int64_feature </em>的返回语句中</p><p id="569d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du nh ni nj mz b"><em class="lv">tf.train.Feature(int64_list=tf.train.Int64List(value=[value]))</em></code> <em class="lv">，去掉value中的方括号，因为你已经在传递一个数组</em></p><blockquote class="ls lt lu"><p id="02b6" class="jo jp lv jq b jr js ij jt ju jv im jw lw jy jz ka lx kc kd ke ly kg kh ki kj hb bi translated"><code class="du nh ni nj mz b"><em class="hi">tf.train.Feature(int64_list=tf.train.Int64List(value=value))</em></code></p></blockquote><p id="20e1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们做到了！我们成功地将数据集转换成可以存储和使用的tfrecords。</p><h2 id="a1fd" class="lz ku hi bd kv ma mb mc kz md me mf ld jx mg mh lf kb mi mj lh kf mk ml lj mm bi translated">资源:</h2><ol class=""><li id="733a" class="mn mo hi jq b jr ll ju lm jx mp kb mq kf mr kj ms mt mu mv bi translated">tfrecords的Tensorflow <a class="ae jn" href="https://www.tensorflow.org/tutorials/load_data/tfrecord" rel="noopener ugc nofollow" target="_blank"> docs </a></li><li id="973b" class="mn mo hi jq b jr nm ju nn jx no kb np kf nq kj ms mt mu mv bi translated">协议缓冲区上的此<a class="ae jn" href="https://www.youtube.com/watch?v=BywIOD_Y3CE" rel="noopener ugc nofollow" target="_blank">视频</a></li></ol></div></div>    
</body>
</html>