<html>
<head>
<title>How to Manage Azure Resource Groups with Tags, Logic Apps, Automation Account and Runbooks Part — II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用标签、逻辑应用、自动化帐户和 Runbooks 管理 Azure 资源组第二部分</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-manage-azure-resource-groups-with-tags-logic-apps-automation-account-and-runbooks-part-c6111a1bc6b0?source=collection_archive---------2-----------------------#2019-08-11">https://medium.com/nerd-for-tech/how-to-manage-azure-resource-groups-with-tags-logic-apps-automation-account-and-runbooks-part-c6111a1bc6b0?source=collection_archive---------2-----------------------#2019-08-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="1157" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">使用逻辑应用、自动化帐户和 Powershell Runbooks 管理 Azure 资源组。</h2></div><p id="820f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">欢迎回来！在之前的<a class="ae jt" rel="noopener" href="/@kuharan/how-to-manage-azure-resource-groups-with-tags-logic-apps-automation-account-and-runbooks-part-i-82f65853e4c2?source=friends_link&amp;sk=5a7ed2439896cf7508a626c0e0e9c63f">文章</a>中，我们发现了一种自动供应资源组的方法。我们使用逻辑应用程序创建了一个流，当你从应用程序发出发布请求时，这个流就会触发。我们学习了如何使用标签进行管理。在本文中，我们将基于“expiration”标签来延长到期日期。够公平吗？我们走吧。</p><p id="8987" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这个想法是当资源组的到期日临近时通知用户，并让他通过点击一个链接来延长它。(<em class="ju">一次性</em>)</p><h2 id="40a1" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated">步骤 1:创建一个带递归的逻辑应用程序</h2><figure class="kr ks kt ku fd kv er es paragraph-image"><div class="er es kq"><img src="../Images/9505bd65abc63f568219f9e130d53f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*5yMHIezlmIZnzbsALgB0CA.png"/></div><figcaption class="ky kz et er es la lb bd b be z dx translated">逻辑应用程序的定期显示运行配置在每天上午 9 点。</figcaption></figure><h2 id="603e" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated">第二步:添加一本操作手册</h2><p id="1a93" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">使用创建作业操作来运行此 PowerShell 代码。如果你想知道如何创建一个，<a class="ae jt" rel="noopener" href="/@kuharan/how-to-manage-azure-resource-groups-with-tags-logic-apps-automation-account-and-runbooks-part-i-82f65853e4c2">看看我以前的帖子</a>。这个 PowerShell runbook 扫描了所有资源，并生成了一个包含详细信息的 JSON。</p><pre class="kr ks kt ku fd lh li lj lk aw ll bi"><span id="7e64" class="jv jw hi li b fi lm ln l lo lp">#This section uses the service principal that is connected as this logic app to log into azure for access to create resources.<br/>#since the service principal is a contributor on the root management group it has contributor level access to all subscription.</span><span id="8a82" class="jv jw hi li b fi lq ln l lo lp">$connectionName = "AzureRunAsConnection"</span><span id="00a4" class="jv jw hi li b fi lq ln l lo lp">try<br/>{<br/>    # Get the connection "AzureRunAsConnection "<br/>    $servicePrincipalConnection=Get-AutomationConnection -Name $connectionName</span><span id="80ec" class="jv jw hi li b fi lq ln l lo lp">    Add-AzureRmAccount `<br/>        -ServicePrincipal `<br/>        -TenantId $servicePrincipalConnection.TenantId `<br/>        -ApplicationId $servicePrincipalConnection.ApplicationId `<br/>        -CertificateThumbprint </span><span id="8bd6" class="jv jw hi li b fi lq ln l lo lp">    $servicePrincipalConnection.CertificateThumbprint | Out-Null<br/>}<br/>catch {<br/>    if (!$servicePrincipalConnection)<br/>    {<br/>        $ErrorMessage = "Connection $connectionName not found."<br/>        throw $ErrorMessage<br/>    } else{<br/>        Write-Error -Message $_.Exception<br/>        throw $_.Exception<br/>    }<br/>}</span><span id="7bb3" class="jv jw hi li b fi lq ln l lo lp">#List the Azure Resource Groups with tags<br/>$rgs = (Get-AzureRmResourceGroup)<br/>$results = @()</span><span id="b69e" class="jv jw hi li b fi lq ln l lo lp">foreach ($rg in $rgs){<br/>    $results += [PSCustomObject]@{<br/>        rgname = $rg.ResourceGroupName<br/>        tags = $rg.Tags<br/>    }<br/>}</span><span id="08a3" class="jv jw hi li b fi lq ln l lo lp">$rgjson = $results | ConvertTo-Json -compress<br/>$data =  $rgjson | ConvertFrom-Json<br/>$expiryobj = @()</span><span id="5bb5" class="jv jw hi li b fi lq ln l lo lp">foreach ($i in $data){<br/>    if ($i.tags.expiration -eq 'never'){<br/>        continue<br/>    }<br/>    else{<br/>        $expiryobj += [PSCustomObject]@{<br/>            rgname = $i.rgname<br/>            days_remaining = (New-TimeSpan -Start (Get-Date -format "d") -End ([DateTime]::ParseExact($i.tags.expiration, "M/d/yyyy h:mm:ss tt", $null))).Days<br/>            tags = $i.tags<br/>        }<br/>    }<br/>}</span><span id="d56a" class="jv jw hi li b fi lq ln l lo lp">$expiryjson = ConvertTo-Json -InputObject $expiryobj -compress<br/>write-output $expiryjson</span></pre><p id="44a9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请注意，这里我们跳过了具有被称为<em class="ju"> never </em>的<em class="ju"> expiration </em>标签的资源组，以及已经扩展的资源组，即具有<em class="ju">扩展</em>标签的资源组。现在添加一个<strong class="iz hj">获取作业输出</strong>动作来获取 RGs 的详细信息。</p><h2 id="7268" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated">步骤 3:添加解析 Json 组件</h2><p id="40cf" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">好了，现在只需添加 JSON 解析器和一个条件块，如果<em class="ju"> days_remaining </em>小于 20 ( <em class="ju">可能是 15 </em>)，就向用户发送电子邮件。要查看如何添加一个解析 Json 动作，<a class="ae jt" rel="noopener" href="/@kuharan/how-to-manage-azure-resource-groups-with-tags-logic-apps-automation-account-and-runbooks-part-i-82f65853e4c2">点击这里</a>。</p><h2 id="4d4c" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated">步骤 4:添加邮件组件</h2><p id="c4db" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">这是给这些资源的所有者发送电子邮件。在邮件正文中，提及 web 应用程序的链接。现在，当用户收到这封关于 RG 到期的邮件时，他将可以通过单击提供的链接来选择延期。链接显然应该重定向到 web 应用程序。在邮件正文中，添加以下内容，并将<strong class="iz hj"> Is Html </strong>设置为<strong class="iz hj"> True </strong>。</p><pre class="kr ks kt ku fd lh li lj lk aw ll bi"><span id="4c5b" class="jv jw hi li b fi lm ln l lo lp">&lt;a href=\”web_app_name.azurewebsites.net?data=rg_name”&gt;Click Here To Extend&lt;/a&gt;</span></pre><p id="07e1" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦用户点击这个链接，它就会打开 web 应用程序来接受请求。</p><h2 id="6eaf" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated">第五步:表演时间到了！</h2><p id="6103" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">web 应用程序自动接受请求并触发扩展 Runbook。我试着保持整洁。接受请求，完成工作。完成了。</p><figure class="kr ks kt ku fd kv er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lr"><img src="../Images/6e85d9b34ac714590404efa1c4c497a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gOGBr9jAFH3I6RfkmISVUA.png"/></div></div><figcaption class="ky kz et er es la lb bd b be z dx translated">自动接受请求的示例 Web 应用程序。</figcaption></figure><p id="b447" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">还记得《碟中谍 4》吗？</p><figure class="kr ks kt ku fd kv"><div class="bz dy l di"><div class="lw lx l"/></div></figure><p id="bc1e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">以下是网络应用的 3 个功能，以备不时之需。</p><pre class="kr ks kt ku fd lh li lj lk aw ll bi"><span id="0d5f" class="jv jw hi li b fi lm ln l lo lp">&lt;!-- parameter passed as web_app_url.azurewebsites.net?data=resource_group_name --&gt;<br/>function getUrlParameter(name) {<br/>    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');<br/>    var regex = new RegExp('[\\?&amp;]' + name + '=([^&amp;#]*)');<br/>    var results = regex.exec(location.search);<br/>    return results === null ? '' : decodeURIComponent ( results[1].replace(/\+/g, ' ' ));<br/>};</span><span id="11d7" class="jv jw hi li b fi lq ln l lo lp">function update_expiry(rg_name){<br/>    jQuery.ajax ({<br/>    url: "<em class="ju">url_of_Extension_Logic_App</em>",<br/>    type: "POST",<br/>    data: JSON.stringify({rgname:rg_name}),<br/>    dataType: "json",<br/>    contentType: "application/json; charset=utf-8"<br/>    });<br/>}</span><span id="7457" class="jv jw hi li b fi lq ln l lo lp">&lt;!-- This is the self destructive timer --&gt;<br/>var timeleft = 10;<br/>var selfClosingTimer = setInterval(function(){<br/>    timeleft--;<br/>    document.getElementById("countdowntimer").textContent = timeleft;<br/>    if(timeleft &lt;= 0){<br/>        clearInterval(selfClosingTimer);<br/>        self.close();<br/>    }<br/>},1000);</span></pre><h2 id="18de" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated">第六步:扩展逻辑应用程序</h2><p id="668b" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">当接收到 Http 请求时，添加一个<strong class="iz hj">动作来激活流。这将接受来自 web 应用程序的有效负载。使用<strong class="iz hj">创建作业</strong>动作连接这是一本操作手册。</strong></p><h2 id="c4ff" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated">步骤 7:扩展操作手册</h2><p id="3399" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">该 Powershell 代码接受来自有效负载的参数，并向到期日期添加 30 天。但就这一次！一个额外的标签“<strong class="iz hj">扩展</strong>”帮助我们识别它曾经被扩展过。所以下一次，它扫描所有资源组中的到期日，跳过具有这个“<strong class="iz hj"> extended </strong>标记的资源组。</p><pre class="kr ks kt ku fd lh li lj lk aw ll bi"><span id="5b2d" class="jv jw hi li b fi lm ln l lo lp">param(<br/>    [Parameter (Mandatory = $false)]<br/>    [object] $payload<br/>)</span><span id="b97c" class="jv jw hi li b fi lq ln l lo lp">#This section uses the service principal that is connected as this logic app to log into azure for access to create resources.</span><span id="868b" class="jv jw hi li b fi lq ln l lo lp">#since the service principal is a contributor on the root management group it has contributor level access to all subscription.</span><span id="3097" class="jv jw hi li b fi lq ln l lo lp">$connectionName = "AzureRunAsConnection"<br/>try{<br/>    # Get the connection "AzureRunAsConnection "<br/>    $servicePrincipalConnection=Get-AutomationConnection -Name </span><span id="7d81" class="jv jw hi li b fi lq ln l lo lp">    $connectionName Add-AzureRmAccount `<br/>        -ServicePrincipal `<br/>        -TenantId $servicePrincipalConnection.TenantId `<br/>        -ApplicationId $servicePrincipalConnection.ApplicationId `<br/>        -CertificateThumbprint </span><span id="a8da" class="jv jw hi li b fi lq ln l lo lp">    $servicePrincipalConnection.CertificateThumbprint | Out-Null<br/>}</span><span id="6e3a" class="jv jw hi li b fi lq ln l lo lp">catch {<br/>    if (!$servicePrincipalConnection){<br/>        $ErrorMessage = "Connection $connectionName not found."<br/>        throw $ErrorMessage<br/>    } else{<br/>        Write-Error -Message $_.Exception<br/>        throw $_.Exception<br/>    }<br/>}</span><span id="7af8" class="jv jw hi li b fi lq ln l lo lp">$data = ConvertFrom-Json -InputObject $payload<br/>$azureRGInfo = Get-AzureRmResourceGroup -Name $data.rgname</span><span id="7ddf" class="jv jw hi li b fi lq ln l lo lp">if($azureRGInfo.Tags.extended -eq 'True'){<br/>    Write-Output "None"<br/>}else{<br/>    $azureRGInfo.Tags+= @{extended="True"}<br/>    $olddate = $azureRGInfo.Tags['expiration']<br/>    $newdate = [DateTime]::ParseExact($olddate, "M/d/yyyy h:mm:ss tt", $null).AddDays(30).ToString('M/d/yyyy h:mm:ss tt')<br/>    $azureRGInfo.Tags['expiration'] = $newdate<br/>    $status = Set-AzureRmResourceGroup -Tag $azureRGInfo.Tags -Name<br/>    $data.rgname<br/>}</span><span id="886a" class="jv jw hi li b fi lq ln l lo lp">$status.ProvisioningState</span></pre><h2 id="52d7" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated">步骤 8:最后添加一个电子邮件组件来发送成功的扩展通知。</h2><p id="3167" class="pw-post-body-paragraph ix iy hi iz b ja lc ij jc jd ld im jf jg le ji jj jk lf jm jn jo lg jq jr js hb bi translated">最后，通过发送扩展确认让用户高兴。</p><p id="e7ee" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">恭喜你。您已经成功地延长了资源组的到期日期，并完成了资源组扩展自动化的第二部分内容。在接下来的几天里，我将写一篇关于资源组一旦过期就完全取消配置的文章。请继续关注最后一集——第三集。</p><p id="cdbc" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">我可以在这里找到——<br/></strong>LinkedIn——<a class="ae jt" href="https://www.linkedin.com/in/kuharan/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/kuharan/</a><br/>Github——<a class="ae jt" href="https://github.com/kuharan" rel="noopener ugc nofollow" target="_blank">https://github.com/kuharan</a></p></div></div>    
</body>
</html>