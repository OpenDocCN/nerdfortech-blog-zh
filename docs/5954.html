<html>
<head>
<title>Starting with Event Sourcing in PHP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从PHP中的事件源开始</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/starting-with-event-sourcing-in-php-161a83597d69?source=collection_archive---------1-----------------------#2021-12-11">https://medium.com/nerd-for-tech/starting-with-event-sourcing-in-php-161a83597d69?source=collection_archive---------1-----------------------#2021-12-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c6db01c7cccf3e25b05b13f5e1fcfdeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B9eAHJHJCvHc6Nbn.jpg"/></div></div></figure><p id="0d79" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你想开始使用PHP中的事件源，但是你觉得你没有足够的知识？也许你已经开始了演示项目，但工具太复杂，无法让学习过程变得愉快？<br/>或者你不知道这是怎么回事，你想知道？</p><p id="b9b7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果是这样的话，那么这篇博文将帮助你开始使用PHP开发事件源。</p><h1 id="d37e" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">什么是事件采购？</h1><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es km"><img src="../Images/d3dbd6e56eec7a9b655e9d40e9248de8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TxsSHMvT9KwDFK1m.jpg"/></div></div></figure><p id="80db" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">事件源是一种在一系列事件中存储特定状态的方法。<br/>要了解标准方法的区别，让我们看看<em class="kr">产品实体</em>。</p><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="21e4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这个例子中，我们有状态实体。这个实体允许我们改变产品的价格。我们通过更换旧价格来做到这一点。</p><p id="6f82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然而，如果任何客户会争辩说，当他买的产品便宜10美元。我们很难证实这一点。</p><blockquote class="ku kv kw"><p id="63db" class="iq ir kr is b it iu iv iw ix iy iz ja kx jc jd je ky jg jh ji kz jk jl jm jn hb bi translated"><em class="hi">另一方面，事件采购通过设计为这些问题提供了答案。你实现了实体，并获得了回顾过去的可能性，因为状态是从所有发生的事情中传递出来的。</em></p></blockquote><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="7f07" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们不是直接改变实体状态，而是返回一个事实，关于刚刚发生的事情。通过这种方式，我们可以获取事件并将其存储在数据库中。</p><p id="0932" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">那么状态是如何被改变的呢？</p><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="2dfd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通过提供获取事件和修改状态的方法。得益于此，当我们从数据库加载事件时，我们可以调用相关方法并填充实体状态。</p><h1 id="1120" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">活动采购来回答你最深层次的问题</h1><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/58fe17e3cf8be1883fda5becd883f31c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Nt6aWehKvPxIUCVp.jpg"/></div></div></figure><p id="b40f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们希望验证客户是否正确，价格应该比他必须支付的价格低10美元。怎么才能做到呢？</p><p id="f1f5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果我们存储事件发生的日期，那么我们可以浏览它们，看看在特定时刻的价格。</p><p id="50eb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们再举一个例子。假设我们的经理想知道每次价格变动之间的确切差价是多少。替他做计算就好了，这样他不用计算器就能直接看到答案。<br/>在这种情况下<strong class="is hj"> <em class="kr">突起</em> </strong>前来救援。</p><blockquote class="ku kv kw"><p id="740b" class="iq ir kr is b it iu iv iw ix iy iz ja kx jc jd je ky jg jh ji kz jk jl jm jn hb bi translated"><em class="hi">投影就像从事件构建的有状态实体，设计用于回答问题或为视图提供数据。</em></p></blockquote><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><p id="8515" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们已经创建了<em class="kr">投影</em>，无论何时价格发生变化，我们都会对其进行更新。回答经理关于价格如何变化的问题，变成了询问预测的问题，因为答案已经从事件中准备好了。</p><p id="ba35" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通常你会把它存储在某个数据库中，但是为了举例，我们会把它保存在内存实现中。</p><h1 id="4091" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">履行</h1><figure class="kn ko kp kq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/affed4338bb422b41f030e26a112c617.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9GxI1vUw2rNyndvO.jpg"/></div></div></figure><p id="4d85" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将使用<em class="kr">生态区</em>和<em class="kr">proof的事件商店</em>。它们一起工作就像胶水代码，所以你可以专注于重要的事情，业务功能和流程。</p><blockquote class="ku kv kw"><p id="3368" class="iq ir kr is b it iu iv iw ix iy iz ja kx jc jd je ky jg jh ji kz jk jl jm jn hb bi translated"><a class="ae la" href="https://docs.ecotone.tech/modelling/event-sourcing" rel="noopener ugc nofollow" target="_blank"> <em class="hi">交错区</em> </a> <em class="hi">与</em> <a class="ae la" href="https://getprooph.org/docs/html/event-store/event_store.html" rel="noopener ugc nofollow" target="_blank"> <em class="hi"> Prooph的事件存储</em> </a> <em class="hi">一起降低了在PHP中构建基于事件的应用程序的门槛，使之成为有趣而愉快的体验。</em></p></blockquote><p id="d39f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在了解更多细节之前，建议先了解一下<a class="ae la" href="https://blog.ecotone.tech/cqrs-in-php/" rel="noopener ugc nofollow" target="_blank"> CQRS </a>和<a class="ae la" href="https://blog.ecotone.tech/event-handling-in-php/" rel="noopener ugc nofollow" target="_blank">事件处理</a>的基础知识。</p><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><ol class=""><li id="93bc" class="lb lc hi is b it iu ix iy jb ld jf le jj lf jn lg lh li lj bi translated">首先，我们需要将我们的<em class="kr">实体</em>标记为#[<em class="kr">eventsourcingpaggregate]。</em> <br/>这将告诉生态区，产品应该用于事件采购。<br/>如果你想知道什么是集合，你可以把它想象成具有行为的实体。</li><li id="096c" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><em class="kr">#【aggregate identifier】</em>描述实体的标识符是什么属性。</li><li id="c47a" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated">为事件添加版本控制，因为这是证明所必需的</li><li id="e0bb" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><em class="kr"> #[CommandHandler] </em>描述对您的实体的可能操作</li><li id="e2d7" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><em class="kr">#[EventSourcingHandler]</em>描述从事件中恢复实体状态的操作</li></ol><p id="dd80" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们用命令调用我们实体之前，让我们也为经理的需求建立投影。</p><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><ol class=""><li id="226f" class="lb lc hi is b it iu ix iy jb ld jf le jj lf jn lg lh li lj bi translated"><em class="kr">#【Projection(" price _ change _ over _ time "，Product::class)】</em>这个告诉生态区，那个类是名为"<em class="kr"> price_change_over_time </em>"的投影，应该使用来自<em class="kr"> Product </em>的事件。</li><li id="976f" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><em class="kr">#【query handler(" product . getpricechange ")】</em>这允许我们使用路由关键字" product.getPriceChange" <em class="kr">来查询投影。</em></li><li id="fe74" class="lb lc hi is b it lk ix ll jb lm jf ln jj lo jn lg lh li lj bi translated"><em class="kr">#【EventHandler】</em>描述这个投影对什么事件感兴趣</li></ol><h1 id="9398" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">执行示例</h1><p id="1bd0" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">这一切是如何一起玩的？<br/> <em class="kr">命令处理程序</em>从<em class="kr">命令总线</em>调用，返回的事件存储在数据库中，从保存的事件中调用<em class="kr">事件源处理程序</em>和投影。</p><p id="14ca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们来执行这个例子:</p><figure class="kn ko kp kq fd ij"><div class="bz dy l di"><div class="ks kt l"/></div></figure><h1 id="4839" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">摘要</h1><p id="89e6" class="pw-post-body-paragraph iq ir hi is b it lp iv iw ix lq iz ja jb lr jd je jf ls jh ji jj lt jl jm jn hb bi translated">生态区和Prooph为你提供了在PHP中构建事件源应用程序的所有必要组件。你可以在内存中存储事件/<em class="kr">PostgreSQL</em>/<em class="kr">MySQL</em>/<em class="kr">Maria db</em>。得益于这两个框架的结合，您可以直接关注业务逻辑，而将粘合代码留给econtero和Prooph。</p><p id="3cad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想看这个例子的完整实现，你可以在这里找到它<a class="ae la" href="https://github.com/ecotoneframework/quickstart-examples/tree/master/EventSourcing" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>