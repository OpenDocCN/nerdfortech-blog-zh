<html>
<head>
<title>How to use AWS secret manager and SES with AWS SAM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将AWS secret manager和SES与AWS SAM一起使用</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-use-aws-secret-manager-and-ses-with-aws-sam-a93bb359d45a?source=collection_archive---------3-----------------------#2021-10-28">https://medium.com/nerd-for-tech/how-to-use-aws-secret-manager-and-ses-with-aws-sam-a93bb359d45a?source=collection_archive---------3-----------------------#2021-10-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/afa7dc57c2036a526c7db8ad5b5552cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MZbfrOdWjTUOBKcYOrAMyg.jpeg"/></div></div></figure><div class=""/><p id="508c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用Lambda Node.js构建一个代理rest服务，并集成简单的电子邮件服务、Secret Manager服务等等。</p><p id="4dcd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">AWS无服务器应用程序模型(AWS SAM)是一个开源框架，用于使用基础设施代码(IaC)构建无服务器应用程序。它提供开发者声明<a class="ae jo" href="https://aws.amazon.com/cloudformation/" rel="noopener ugc nofollow" target="_blank"><strong class="is hu">AWS CloudFormation</strong></a>资源或<a class="ae jo" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-resources-and-properties.html" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu"> SAM特定资源，属性引用</strong> </a>和SAM将SAM语法转换和扩展为AWS cloud formation语法，使您能够更快地构建无服务器应用。</p><p id="eb3e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我们将使用AWS SAM构建一个rest服务，该服务调用天气API以通过邮政编码、国家代码获取当前天气数据，我们将在secret manager中存储API令牌，并在调用rest API后通过电子邮件发送当前天气数据。</p><h1 id="eb84" class="jp jq ht bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">问题陈述:</h1><p id="f44c" class="pw-post-body-paragraph iq ir ht is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我们将使用AWS SAM创建一个无服务器代理Rest API端点，通过邮政编码和国家代码获取当前天气数据，详细信息如下:</p><ul class=""><li id="1f7d" class="ks kt ht is b it iu ix iy jb ku jf kv jj kw jn kx ky kz la bi translated">方法:获取</li><li id="756f" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">查询参数:邮政编码和国家</li><li id="d4c9" class="ks kt ht is b it lb ix lc jb ld jf le jj lf jn kx ky kz la bi translated">SAM策略模板，用于将Lambda功能的权限范围扩大到Secret Manager和简单电子邮件服务资源。</li></ul><p id="f870" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是完整的GITHUB项目:<a class="ae jo" href="https://github.com/SandeepKumarYaramchitti/aws-nodejs-rest-service" rel="noopener ugc nofollow" target="_blank">https://GITHUB . com/SandeepKumarYaramchitti/AWS-nodejs-rest-service</a></p><p id="f0f5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">步骤1: </strong>创建一个SAM项目</p><p id="cad4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用一些样板代码创建SAM项目，或者克隆我的git repo。选择Nodejs14作为运行时，并访问站点<a class="ae jo" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu">此处</strong> </a>了解安装AWS SAM cli的详细步骤</p><p id="a31c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hu">步骤2 </strong>:让我们开始编码</p><p id="eeb1" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦你生成了这个项目，它将会有一些模板代码，你可以从这里开始你的开发。下面是生成的代码片段。</p><figure class="lh li lj lk fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lg"><img src="../Images/f4f5446073c66def5e48b8990d201cf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yRs-htoQDYbBePmYy4AwlQ.png"/></div></div></figure><p id="59d3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于我们将使用开放的天气api来收集当前天气数据的细节，让我们前往<a class="ae jo" href="https://openweathermap.org/current#zip" rel="noopener ugc nofollow" target="_blank">https://openweathermap.org/current#zip</a>。按照网站上的说明创建一个API密钥，我们将特别使用下面的API端点</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="4d02" class="lq jq ht lm b fi lr ls l lt lu">api.openweathermap.org/data/2.5/weather?zip={zip code},{country code}&amp;appid=<a class="ae jo" href="https://home.openweathermap.org/api_keys" rel="noopener ugc nofollow" target="_blank">{API key}</a></span></pre><p id="5c9f" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们开始修改hello-world文件夹下的app.js。我们将使用axios在lambda处理程序中进行API调用。</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="ab48" class="lq jq ht lm b fi lr ls l lt lu">cd hello-world<br/>npm install axios</span></pre><p id="bea7" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是使用axios进行API调用的基本代码</p><figure class="lh li lj lk fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="de40" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将API_KEY存储在AWS Secret Manager中，我们将选择AWS SAM模板来确定lambda函数的权限范围，使其具有对Secret Manager的读取权限。</p><p id="2d46" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以使用AWS控制台在secret manager中存储API_KEY。此外，还有其他方法可以做到这一点。为了更容易理解，让我们将API密钥存储在Secret Manager中。</p><figure class="lh li lj lk fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lx"><img src="../Images/d5d130f9b3f499b20b907d1bc76e6922.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*he-aSL9tJXpOLpzbgKyUPg.png"/></div></div></figure><p id="7fc3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦你存储了新的秘密，你应该会看到一个类似的屏幕</p><figure class="lh li lj lk fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ly"><img src="../Images/32604fe303df0b6e4f7577937366a1fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jKm-XznO6vcQqiYEw6F7ww.png"/></div></div></figure><blockquote class="lz ma mb"><p id="4139" class="iq ir mc is b it iu iv iw ix iy iz ja md jc jd je me jg jh ji mf jk jl jm jn hb bi translated">现在让我们用允许lambda函数在Secret Manager中访问该资源的策略来更新模板yml。为此，我们将把AWSSecretsManagerGetSecretValuePolicy<em class="ht">应用到lambda函数</em></p></blockquote><p id="5ace" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是更新后的template.yml代码片段</p><figure class="lh li lj lk fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="65b4" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">应用上述SAM策略将允许lambda函数读取给定SecretArn的秘密管理器存储。</p><p id="84e3" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们使用aws-sdk获取代码中的API_KEY值，为此，您需要安装aws-sdk</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="02da" class="lq jq ht lm b fi lr ls l lt lu">npm install aws-sdk</span></pre><p id="c7fe" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">确保在hello-world文件夹中执行上述步骤。下面是app.js修改后的代码，我们导入了aws-sdk，用SecretManager()创建了一个实例。</p><p id="9a03" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在lambdahandle中，我们将通过提供SecretId来获取秘密值，并且我们将使用API_KEY来调用开放天气API</p><figure class="lh li lj lk fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="e0c9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此时，您可以运行以下命令来使用SAM进行构建和部署</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="fae5" class="lq jq ht lm b fi lr ls l lt lu">sam build<br/>sam deploy --guided --profile dev</span></pre><blockquote class="lz ma mb"><p id="3b21" class="iq ir mc is b it iu iv iw ix iy iz ja md jc jd je me jg jh ji mf jk jl jm jn hb bi translated">注意:我已经将我的aws配置文件配置为dev，并按照aws cli文档设置您的aws cli配置文件<a class="ae jo" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html" rel="noopener ugc nofollow" target="_blank">T3T5】</a></p></blockquote><p id="342b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您应该看到您的端点URL(理想情况下，您会希望将路由更改为类似/weatherdata的内容)</p><p id="c1a9" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://texcxw8me4.execute-api.us-east-2.amazonaws.com/Prod/weatherdata/" rel="noopener ugc nofollow" target="_blank">https://xxxxx . execute-API . xxxx . Amazon AWS . com/Prod/weather data/</a></p><p id="dacd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们尝试传递api查询参数，为此，我们需要用Lambda函数的<strong class="is hu"> RequestParameters </strong>更新template.yml</p><figure class="lh li lj lk fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="0529" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们更新Lambda处理程序来读取API查询参数。这里我们用event属性获取查询参数，query parameters可以用<strong class="is hu"> event.queryParameters </strong>读取</p><figure class="lh li lj lk fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="2c10" class="lq jq ht lm b fi lr ls l lt lu">sam build<br/>sam deploy --guided --profile dev</span></pre><blockquote class="lz ma mb"><p id="3d14" class="iq ir mc is b it iu iv iw ix iy iz ja md jc jd je me jg jh ji mf jk jl jm jn hb bi translated">注意:我已经将我的aws配置文件配置为dev，并按照aws cli文档设置您的aws cli配置文件<a class="ae jo" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu">此处</strong> </a></p></blockquote><p id="8f67" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">新的API端点如下:-</p><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="ed2d" class="lq jq ht lm b fi lr ls l lt lu">https://xxxx.execute-api.xxxx.amazonaws.com/Prod/weatherdata?zipcode=94040&amp;country=us</span></pre><p id="ed37" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们移动到这个博客的最后一部分，即以电子邮件的形式发送天气数据。为此，我们需要为AWS SAM使用<strong class="is hu"> SESCrudPolicy </strong>更新策略，然后更新代码以包含电子邮件功能。</p><figure class="lh li lj lk fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="d43a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在让我们更新发送电子邮件的App.js。在这个例子中，我只从api发送响应。您也可以格式化模板来发送电子邮件。</p><figure class="lh li lj lk fd hk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><pre class="lh li lj lk fd ll lm ln lo aw lp bi"><span id="506a" class="lq jq ht lm b fi lr ls l lt lu">sam build<br/>sam deploy --guided --profile dev</span></pre><blockquote class="lz ma mb"><p id="2734" class="iq ir mc is b it iu iv iw ix iy iz ja md jc jd je me jg jh ji mf jk jl jm jn hb bi translated">注意:我已经将我的aws配置文件配置为dev，并按照aws cli文档来设置您的aws cli配置文件<a class="ae jo" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-profiles.html" rel="noopener ugc nofollow" target="_blank"> <strong class="is hu">这里是</strong> </a></p></blockquote><p id="b14b" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">希望这篇博文能帮助你获得一些使用AWS SAM和一些AWS服务的实践经验。</p></div></div>    
</body>
</html>