<html>
<head>
<title>Direktiv: running Ansible CIS Hardening playbooks in workflows (part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Direktiv:在工作流中运行Ansible CIS强化行动手册(第2部分)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/direktiv-running-ansible-cis-hardening-playbooks-in-workflows-6e10258b833c?source=collection_archive---------6-----------------------#2021-07-27">https://medium.com/nerd-for-tech/direktiv-running-ansible-cis-hardening-playbooks-in-workflows-6e10258b833c?source=collection_archive---------6-----------------------#2021-07-27</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/5f21d1baced044f8d65b7bce3725e843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ezk50XQxINeAaNFW62c47Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Ansible和Direktiv携手合作</figcaption></figure><blockquote class="iu iv iw"><p id="6763" class="ix iy iz ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">这是3部分系列文章的第二部分。如果你想了解我们如何使用Terraform供应机器…请看一下<a class="ae jw" rel="noopener" href="/nerd-for-tech/direktiv-building-a-machine-on-aws-using-terraform-without-a-terraform-environment-def24fe3221d">这个</a></p></blockquote><p id="d744" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">最终，我们希望能够做到的是:</p><ul class=""><li id="d884" class="ka kb hi ja b jb jc jf jg jx kc jy kd jz ke jv kf kg kh ki bi translated">使用Terraform ( <a class="ae jw" rel="noopener" href="/nerd-for-tech/direktiv-building-a-machine-on-aws-using-terraform-without-a-terraform-environment-def24fe3221d">第1部分</a>)向AWS、GCP或任何云平台供应机器</li><li id="e0bd" class="ka kb hi ja b jb kj jf kk jx kl jy km jz kn jv kf kg kh ki bi translated">根据CIS强化指南(第2部分——本文)强化实例(在本例中为Ubuntu)</li><li id="0a54" class="ka kb hi ja b jb kj jf kk jx kl jy km jz kn jv kf kg kh ki bi translated">用CMDB信息更新IT服务台，通过Slack、Discord或Teams向系统管理员发送消息，并跟踪机器的状态(第3部分—下一篇文章)</li></ul><h1 id="5bdf" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">视频时间！</h1><p id="cc96" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jx lo jl jm jy lp jp jq jz lq jt ju jv hb bi translated">想跳过来看看…下面视频！</p><p id="1d1e" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">https://www.youtube.com/watch?v=0eNMwMff84U&amp;t = 30秒</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><h1 id="8b4b" class="ko kp hi bd kq kr ly kt ku kv lz kx ky kz ma lb lc ld mb lf lg lh mc lj lk ll bi translated">快速概述</h1><p id="6987" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jx lo jl jm jy lp jp jq jz lq jt ju jv hb bi translated">Direktiv是一个无服务器的工作流引擎，从技术上来说,<strong class="ja hj">* T7】意味着它按需旋转容器(使用Kubernetes和Knative)并按照你定义的顺序关闭它们(工作流)。所以在Terraform或Ansible的例子中——我们只是将提供者软件的最新版本作为一个容器。</strong></p><blockquote class="iu iv iw"><p id="8e4c" class="ix iy iz ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">第二个问题是为什么？</p></blockquote><ol class=""><li id="f6af" class="ka kb hi ja b jb jc jf jg jx kc jy kd jz ke jv md kg kh ki bi translated">Terraform和Ansible是基础设施供应和管理的优秀解决方案，拥有大量插件和扩展。为什么我们要尝试重新发明轮子——尤其是如果你考虑到两者都被广泛采用的话。Direktiv使用已经为这两种产品构建的插件、扩展和剧本，并将其扩展到我们提供的更广泛的微服务工作流架构中</li><li id="4880" class="ka kb hi ja b jb kj jf kk jx kl jy km jz kn jv md kg kh ki bi translated">您可以获得这两种环境，而无需安装或维护它们(或持续运行它们的资源成本)。如果你不想使用我们的<a class="ae jw" href="https://github.com/vorteil/direktiv-apps/tree/master/ansible" rel="noopener ugc nofollow" target="_blank"> Ansible插件</a>，只要用最新的(或者你觉得合适的版本)更新<a class="ae jw" href="https://github.com/vorteil/direktiv-apps/blob/master/ansible/Dockerfile" rel="noopener ugc nofollow" target="_blank"> Docker构建文件</a>即可。这就是Direktiv工作流的短暂本质！</li></ol><h1 id="6fa4" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">使用CIS强化行动手册</h1><p id="6678" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jx lo jl jm jy lp jp jq jz lq jt ju jv hb bi translated">至少这部分很简单——只需看看下面的GitHub库:</p><p id="f585" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated"><a class="ae jw" href="https://github.com/alivx/CIS-Ubuntu-20.04-Ansible" rel="noopener ugc nofollow" target="_blank">https://github.com/alivx/CIS-Ubuntu-20.04-Ansible</a></p><p id="5c3c" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">我将这个存储库克隆到我自己的私有存储库的子目录中，并创建了一个用于运行Ansible剧本的<code class="du me mf mg mh b">run.yaml</code>文件。</p><p id="e754" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">最终的存储库结构如下所示:</p><pre class="mi mj mk ml fd mm mh mn mo aw mp bi"><span id="bf95" class="mq kp hi mh b fi mr ms l mt mu">---&gt; Direktiv-CIS-Ubuntu-20.04-Ansible<br/>|<br/> -----&gt; run.yaml (created this file)<br/>|<br/> -----&gt; README.md (create this file)<br/>|<br/> -----&gt; CIS-Ubuntu-20.04-Ansible (cloned from <a class="ae jw" href="https://github.com/alivx/CIS-Ubuntu-20.04-Ansible" rel="noopener ugc nofollow" target="_blank">alivx</a> repository)</span></pre><p id="157e" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">公共存储库在此处可用<a class="ae jw" href="https://github.com/wwonigkeit/Direktiv-CIS-Ubuntu-20.04-Ansible" rel="noopener ugc nofollow" target="_blank"/>&amp;ansi ble playbook(<code class="du me mf mg mh b">run.yaml</code>)如下所示:</p><figure class="mi mj mk ml fd ij"><div class="bz dy l di"><div class="mv mw l"/></div></figure><h1 id="91c7" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">配置Direktiv工作流</h1><p id="3abf" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jx lo jl jm jy lp jp jq jz lq jt ju jv hb bi translated">对于Direktiv工作流配置，我们决定创建4个输入作为工作流的一部分。这是因为我们(在下一篇文章中)希望将Terraform和其他解决方案集成到一个端到端的工作流中。输入的JSON对象如下所示:</p><pre class="mi mj mk ml fd mm mh mn mo aw mp bi"><span id="8059" class="mq kp hi mh b fi mr ms l mt mu">{<br/>   "ip_address":"3.25.180.180",<br/>   "section":"section2",<br/>   "user":"ubuntu",<br/>   "playbook":"run.yaml"<br/>}</span></pre><p id="6ad1" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">工作流接受所供应的机器的IP地址、要应用的CIS强化指南的部分(<a class="ae jw" href="https://github.com/wwonigkeit/Direktiv-CIS-Ubuntu-20.04-Ansible/blob/main/CIS-Ubuntu-20.04-Ansible/README.md#table-of-roles" rel="noopener ugc nofollow" target="_blank">在此处了解更多信息</a>)、用于连接到机器的用户以及要运行的剧本(在本例中为<code class="du me mf mg mh b">run.yaml</code>)。</p><p id="be46" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">工作流程步骤如下图所示:</p><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/a98f6c99de6a9d44c497b0e75099e316.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2rqp-2O7LnUpt9LaJhDG3Q.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">GitHub存储库中的可转换工作流</figcaption></figure><p id="d9cd" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">Direktiv工作流YAML如下所示:</p><figure class="mi mj mk ml fd ij"><div class="bz dy l di"><div class="mv mw l"/></div></figure><p id="73f0" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">与Terraform工作流一样，此工作流分两步执行流程:</p><ol class=""><li id="3074" class="ka kb hi ja b jb jc jf jg jx kc jy kd jz ke jv md kg kh ki bi translated">首先，我们将GitHub存储库作为一个<code class="du me mf mg mh b">tar.gz</code>文件克隆到Direktiv工作流变量中。变量名叫做<code class="du me mf mg mh b">ansible-cis-var</code></li><li id="8b2a" class="ka kb hi ja b jb kj jf kk jx kl jy km jz kn jv md kg kh ki bi translated">其次，我们将<code class="du me mf mg mh b">cis-ansible-var</code>内容作为输入传递给ansible workflow容器(它将自动提取二进制文件的二进制压缩内容，并将其放在一个共享目录挂载点上)。<code class="du me mf mg mh b">ansible</code>函数定义中<code class="du me mf mg mh b">files</code>的定义(第11–13行)确保GitHub库在Ansible运行时可用！</li></ol><p id="e9f9" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">如您所见，我们还在运行时向Ansible传递了几个参数，特别是我们作为工作流输入传递的IP地址，我们希望为CIS强化和SSH设置运行的部分。</p><blockquote class="iu iv iw"><p id="d067" class="ix iy iz ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">另请注意:我们将SSH连接的PEM密钥保存为变量，以便在工作流中使用！</p></blockquote><h1 id="65b9" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">运行时！</h1><p id="7e6c" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jx lo jl jm jy lp jp jq jz lq jt ju jv hb bi translated">现在，我们总是可以从UI运行工作流，如下所示:</p><figure class="mi mj mk ml fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es my"><img src="../Images/600c19fbc2a053c4e410da9c84d0685a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MBi04y4RS1AF7rcZF_Tyfg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">手动运行可行的工作流</figcaption></figure><p id="d34e" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">但是，让我们使用API来运行它:</p><pre class="mi mj mk ml fd mm mh mn mo aw mp bi"><span id="8aa0" class="mq kp hi mh b fi mr ms l mt mu">$ curl -X POST http://localhost:8080/api/namespaces/ansible/workflows/ansible-cis-hardening/execute?wait=true --data '{ "ip_address":"3.25.180.180", "section":"section2", "user":"ubuntu", "playbook":"run.yaml" }' --header "Content-Type: application/json"</span><span id="dee9" class="mq kp hi mh b fi mz ms l mt mu">{"output":" PLAY [all] *********************************************************************</span><span id="62be" class="mq kp hi mh b fi mz ms l mt mu">TASK [CIS-Ubuntu-20.04-Ansible : 2.1.1 Ensure xinetd is not installed] *********<br/>ok: [3.25.180.180]</span><span id="57e4" class="mq kp hi mh b fi mz ms l mt mu">TASK [CIS-Ubuntu-20.04-Ansible : 2.1.2 Ensure openbsd-inetd is not installed] ***<br/>ok: [3.25.180.180]</span><span id="e9ce" class="mq kp hi mh b fi mz ms l mt mu">TASK [CIS-Ubuntu-20.04-Ansible : 2.2.1.1 Ensure time synchronization is in use - service install] ***<br/>[WARNING]: conditional statements should not include jinja2 templating<br/>delimiters such as {{ }} or {% %}. Found: {{enableNTP}}<br/>ok: [3.25.180.180]</span><span id="fafe" class="mq kp hi mh b fi mz ms l mt mu">:<br/>: &lt;information in here just playbook output&gt;<br/>:</span><span id="a28d" class="mq kp hi mh b fi mz ms l mt mu">TASK [CIS-Ubuntu-20.04-Ansible : 2.3.6 Ensure RPC is not installed] ************<br/>ok: [3.25.180.180]</span><span id="9538" class="mq kp hi mh b fi mz ms l mt mu">TASK [CIS-Ubuntu-20.04-Ansible : 2.4 Ensure nonessential services are removed or masked] ***<br/>ok: [3.25.180.180] =\u003e {\n    \"msg\": \"Run the following command: $ lsof -i -P -n | grep -v \\\"(ESTABLISHED)\\\"\\n  Review the output to ensure that all services listed are required on the system. If a listed\\n  service is not required, remove the package containing the service. If the package\\n  containing a non-essential service is required, stop and mask the non-essential service.\\n  Code Meaning \\n  S File size differs. \\n  M File mode differs (includes permissions and file type). \\n  5 The MD5 checksum differs. \\n  D The major and minor version numbers differ on a device file. \\n  L A mismatch occurs in a link. \\n  U The file ownership differs. \\n  G The file group owner differs. \\n  T The file time (mtime) differs.\\n\"\n}</span><span id="0d9a" class="mq kp hi mh b fi mz ms l mt mu">PLAY RECAP *********************************************************************<br/>3.25.180.180               : ok=29   changed=0    unreachable=0    failed=0    skipped=9    rescued=0    ignored=0"}<br/>$</span></pre><p id="9531" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">Ansible剧本的输出是一个JSON对象:</p><p id="258b" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated"><code class="du me mf mg mh b">{ "output" : "&lt;ansible output here&gt;"}</code></p><p id="994b" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">这个工作流产生的对象是一个简单的JSON对象，我们可以将它传递给一个字符串或文本解析引擎(或者使用内部JQ来创建JSON子对象，这显然是首选)。</p><p id="fed6" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">这使得使用Ansible输出、集成和公开可用的行动手册将Direktiv扩展到基础架构配置成为可能，同时仍然提供运行应用程序、容器和微服务集成的有状态工作流的能力。</p><p id="9e6a" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jx jk jl jm jy jo jp jq jz js jt ju jv hb bi translated">一如既往，欢迎反馈和提问！</p></div></div>    
</body>
</html>