<html>
<head>
<title>Creating a GKE Cluster with GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitHub操作创建GKE集群</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/creating-a-gke-cluster-with-github-actions-dd34e2de50a6?source=collection_archive---------0-----------------------#2020-12-25">https://medium.com/nerd-for-tech/creating-a-gke-cluster-with-github-actions-dd34e2de50a6?source=collection_archive---------0-----------------------#2020-12-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="e351" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用GitHub动作自动化Kubernetes集群创建和引导</p><p id="26f4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">GitHub Actions允许您直接在GitHub存储库中设计CI和CD工作流。GitHub动作与GitHub完全集成。构建、测试和部署可以直接从GitHub完成。因此您的CI/CD工作流可以位于您的源代码所在的位置。CI/CD管道可以由拉请求或分支合并等事件触发。在本文中，我们将使用GitHub操作通过terraform创建一个GKE集群，并使用一些工具如Istio和flagger引导集群。</p><h1 id="0ecc" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">整个故事是关于什么的？(TLDR)</h1><ol class=""><li id="cf4d" class="kb kc hi ih b ii kd im ke iq kf iu kg iy kh jc ki kj kk kl bi translated">GitHub Actions允许您直接在GitHub存储库中设计CI和CD工作流。构建、测试和部署可以直接从GitHub完成。</li><li id="2767" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">我们将使用GitHub操作创建一个GKE集群(使用terraform ),并通过安装Istio、Flagger等组件来引导集群。</li></ol><h1 id="050a" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">先决条件</h1><ol class=""><li id="2f8f" class="kb kc hi ih b ii kd im ke iq kf iu kg iy kh jc ki kj kk kl bi translated">GCP账户</li><li id="0f4c" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">GitHub帐户</li><li id="2ede" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">任何远程后端存储您的状态(可选)</li></ol><h1 id="f20d" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">演示</h1><p id="8929" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">在本演示中，我们将首先调配一个GKE集群，然后将一组可抢占的节点添加到同一个已调配的集群中。</p><p id="1b11" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以派生我的repo，它同时包含terraform和GitHub操作文件。</p><h2 id="2569" class="ku je hi bd jf kv kw kx jj ky kz la jn iq lb lc jr iu ld le jv iy lf lg jz lh bi translated"><a class="ae li" href="https://github.com/pavan-kumar-99/medium-manifests/tree/github-actions" rel="noopener ugc nofollow" target="_blank">https://github . com/pavan-Kumar-99/medium-manifests/tree/github-actions</a></h2><p id="18fd" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">这是我的terraform代码的一个示例片段。这将创建一个GKE集群，然后向通过我们的terraform创建的集群添加一个节点池。但是我们如何自动化这个呢？我们如何确保我们的terraform代码没有任何错误？我们如何确保主分支中的terraform代码没有任何格式问题？我们如何确保在合并之前对提交给主分支机构的任何拉请求进行适当的测试？最后，我们如何自动调配GKE集群和节点池？解决的办法是<a class="ae li" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> GitHub的动作。</strong> </a></p><p id="0b33" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们看一下GitHub动作在这里做了什么</p><figure class="lj lk ll lm fd ln"><div class="bz dy l di"><div class="lo lp l"/></div></figure><ol class=""><li id="27be" class="kb kc hi ih b ii ij im in iq lq iu lr iy ls jc ki kj kk kl bi translated">name:GitHub操作的名称。</li><li id="5e8c" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">on:触发此工作流的GitHub事件的名称。</li><li id="9428" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">push.paths:如果对该路径进行了任何更改，将会触发工作流。</li><li id="d131" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">分支:仅针对主分支在推送时触发工作流。</li><li id="c1d7" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">pull_request:在pull请求事件上触发工作流。</li><li id="34cc" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">作业:工作流由一个或多个作业组成(这些作业定义了要执行的一组步骤)。</li><li id="4d04" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">jobs.terraform:作业的id。</li><li id="080a" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">jobs.terraform.env:可用于作业中所有步骤的环境变量的映射。</li><li id="5314" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">runs-on:应该运行作业的计算机类型。</li><li id="0350" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">strategy.matrix:矩阵允许您通过在单个作业定义中执行变量替换来创建多个作业。这里我们告诉我们的工作流在gke_tf和worker_nodes文件夹中运行。</li><li id="e664" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">步骤:作业包含一系列称为步骤的任务。</li><li id="0eca" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">steps.uses:它指定要使用的预构建操作的名称。你可以在GitHub市场这里(<a class="ae li" href="https://github.com/marketplace?type=actions" rel="noopener ugc nofollow" target="_blank">https://github.com/marketplace?type=actions</a>)找到很多。</li><li id="0391" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">steps.run:指定要在shell中运行的命令。</li><li id="6e52" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">steps.if:阻止作业运行，直到满足某个条件。</li><li id="4dc6" class="kb kc hi ih b ii km im kn iq ko iu kp iy kq jc ki kj kk kl bi translated">bootstrap.needs:默认情况下，所有的作业都是并行运行的。“需求”部分确定了在运行作业之前应该成功完成的作业。</li></ol><h2 id="24f2" class="ku je hi bd jf kv kw kx jj ky kz la jn iq lb lc jr iu ld le jv iy lf lg jz lh bi translated">因此，我们的GitHub操作执行以下步骤</h2><ol class=""><li id="b617" class="kb kc hi ih b ii kd im ke iq kf iu kg iy kh jc ki kj kk kl bi translated"><strong class="ih hj">每当提出一个拉请求</strong> <br/> a)将代码从主分支签出到最新的ubuntu机器上。(name: Checkout ) <br/> b)检查我们的terraform代码格式是否正确。(name: Terraform Format ) <br/> c)初始化Terraform工作目录。(name: Terraform Init ) <br/> d)生成一个推测执行计划，显示Terraform将采取什么行动来应用当前配置。(名称:地形图)</li></ol><p id="18cc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.<strong class="ih hj">每当合并拉请求时</strong> <br/> a)根据当前目录中的Terraform配置文件创建或更新基础设施(名称:Terraform Apply ) <br/> b)通过安装flagger和Istio操作符(名称:bootstrap-cluster)引导集群。此作业等待terraform作业完成后才开始。</p><p id="a089" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们通过将gke_tf或worker_nodes文件夹中的worker节点计数从1增加到2来发出一个Pull请求。</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es lt"><img src="../Images/8839fd41ffb869bb123adb58691c47a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UVzwlNQv096jzwxR00zWWQ.png"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">显示我们支票状态的PR。</figcaption></figure><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es me"><img src="../Images/96239443b4c67c7083ec9ef554529641.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-pIrGyUmRpbZwDPfVITKA.png"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">地形平面图和格式</figcaption></figure><p id="35b4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">由于pull请求尚未合并，它将只检查格式问题并执行terraform计划。</p><p id="6d21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，必须合并拉取请求(手动)。我们把这个也自动化怎么样？是的，您现在可以从GitHub UI中启用拉请求的自动合并。</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mf"><img src="../Images/03178bd3d9db5ff7c8a747d2d48388ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HToB0NHo3sMYCT9SCZ2-9Q.png"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">拉请求的自动合并。</figcaption></figure><p id="6790" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们的拉请求被合并，我们的GitHub操作将开始在您的GCP帐户中创建一个集群。</p><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mg"><img src="../Images/2fdcdf85038a1fd0bc07510441f28519.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qfz9reYw6cz3jN1_dYCfgQ.png"/></div></div></figure><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mh"><img src="../Images/4709be687a00dd5eb8e8643adce3e159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yMN_AxARS2aWvnGxqaRR4w.png"/></div></div></figure><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mh"><img src="../Images/c208d24a8819fb5cdd99f2949aafea61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SXzsbJFMxGSpK5iL-s-UYg.png"/></div></div></figure><figure class="lj lk ll lm fd ln er es paragraph-image"><div role="button" tabindex="0" class="lu lv di lw bf lx"><div class="er es mf"><img src="../Images/197276c2508d781032bab2005bf03571.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TKjRu0hQJpUHPQ6CNG7oeA.png"/></div></div><figcaption class="ma mb et er es mc md bd b be z dx translated">在GCP创建集群</figcaption></figure><p id="22fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您登录到GCP控制台，您现在应该能够在GKE部分看到您的集群以及一个额外的节点组。</p><h1 id="67c6" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="7963" class="pw-post-body-paragraph if ig hi ih b ii kd ik il im ke io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">感谢阅读我的文章。希望你喜欢它。以下是我的一些其他文章，你可能会感兴趣。</p><h1 id="339e" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">被推荐的</h1><div class="mi mj ez fb mk ml"><a href="https://pavan1999-kumar.medium.com/create-a-kubernetes-cluster-using-kind-b364a67437b7" rel="noopener follow" target="_blank"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">使用Kind创建一个Kubernetes集群</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">如何使用kind在5分钟内创建一个Kubernetes集群？</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">pavan1999-kumar.medium.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz ly ml"/></div></div></a></div><div class="mi mj ez fb mk ml"><a href="https://pavan1999-kumar.medium.com/deploying-applications-in-kubernetes-using-flux-a9d171b11917" rel="noopener follow" target="_blank"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">使用Flux在Kubernetes中部署应用程序</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">通量介绍</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">pavan1999-kumar.medium.com</p></div></div><div class="mu l"><div class="na l mw mx my mu mz ly ml"/></div></div></a></div><div class="mi mj ez fb mk ml"><a href="https://pavan1999-kumar.medium.com/introduction-to-kustomize-97f990dc2f44" rel="noopener follow" target="_blank"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">Kustomize简介</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">如何使用Kustomize有效地管理您的Kubernetes清单。</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">pavan1999-kumar.medium.com</p></div></div><div class="mu l"><div class="nb l mw mx my mu mz ly ml"/></div></div></a></div><div class="mi mj ez fb mk ml"><a href="https://pavan1999-kumar.medium.com/deploying-applications-in-kubernetes-using-argo-cd-ab004a8cdb5e" rel="noopener follow" target="_blank"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">使用Argo CD在Kubernetes中部署应用程序</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">使用Argo CD在Kubernetes中部署应用程序</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">使用Argo CDpavan1999-kumar.medium.com在Kubernetes中部署应用程序</p></div></div><div class="mu l"><div class="nc l mw mx my mu mz ly ml"/></div></div></a></div><div class="mi mj ez fb mk ml"><a href="https://pavan1999-kumar.medium.com/introduction-to-istio-service-mesh-2bc68d2ffdac" rel="noopener follow" target="_blank"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">Istio服务网格简介</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">什么是Istio服务网格？</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">pavan1999-kumar.medium.com</p></div></div><div class="mu l"><div class="nd l mw mx my mu mz ly ml"/></div></div></a></div></div></div>    
</body>
</html>