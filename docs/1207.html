<html>
<head>
<title>How to scrape Dow Jones Industrial Average data from Yahoo finance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从雅虎财经抓取道琼斯工业平均指数数据</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-scrape-dow-jones-industrial-average-data-from-yahoo-finance-bd2cba5d163a?source=collection_archive---------11-----------------------#2021-03-09">https://medium.com/nerd-for-tech/how-to-scrape-dow-jones-industrial-average-data-from-yahoo-finance-bd2cba5d163a?source=collection_archive---------11-----------------------#2021-03-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ad49361d5b8d933f777e66b93e7a14fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3c3l_XxnsFwcUx-6"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">鸣谢:unsplash <a class="ae iu" href="https://unsplash.com/@markusspiske" rel="noopener ugc nofollow" target="_blank"> @markusspiske </a></figcaption></figure><p id="d957" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最近，我正在做一个股票价格预测项目，我们将使用头条新闻来预测道琼斯工业平均指数是上升还是下降。Kaggle 上有很多数据集供你使用，这很好。但是，要收集最新的数据，您可以考虑使用 web 抓取。挺好接的，那就开始吧！</p><h1 id="7d0d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">事情是如何在后台运行的</h1><p id="863a" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我们将从客户端和服务器如何通信开始，这样我们就可以对什么是 web 抓取有一个概念。这就是当你在浏览器上访问这个页面时将要发生的事情。您的浏览器将通过这个 URL(www.medium.com/…)向服务器发出一个<strong class="ix hj">请求</strong>，服务器将通过发送一个告诉浏览器如何显示数据的 HTML 文件做出响应。瞧啊。现在你的浏览器得到了数据，并很好地显示在你的浏览器上！</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kw"><img src="../Images/bb17cecb1c5b8eaeb188d529bf436cb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mG-kNZgR8Z4KVxvoRGjcYw.png"/></div></div></figure><p id="c859" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，web 抓取是从我们向服务器请求的 HTML 文件中提取数据，我们编写的 Python 脚本称为 web bot。</p><h1 id="3f33" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><strong class="ak">网页抓取所需的库</strong></h1><p id="7ca9" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">web 抓取只有两个步骤:下载网页和解析数据。我们将使用<code class="du lb lc ld le b">requests</code>库进行网页下载，使用<code class="du lb lc ld le b">beautifulsoup4</code>进行数据解析。在项目终端中运行以下命令来安装这些库。</p><pre class="kx ky kz la fd lf le lg lh aw li bi"><span id="7bdb" class="lj ju hi le b fi lk ll l lm ln">pip3 install beautifulsoup4<br/>pip3 install requests</span></pre><h2 id="acad" class="lj ju hi bd jv lo lp lq jz lr ls lt kd jg lu lv kh jk lw lx kl jo ly lz kp ma bi translated">为什么我们需要解析数据？</h2><p id="4d94" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">HTML 文件由数据和标签组成。因为我们只需要数据，所以我们需要解析 HTML 文件，删除标签和所有其他不需要的东西。正如您在下面的截图中看到的，要获取我们的文章标题，我们需要从突出显示的<h2>标签中提取标题。</h2></p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mb"><img src="../Images/48d50c295e30e4dc652fb9a5cc6e6a11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GVp8eA2IClRe2Uk63UfiUw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">medium.com 的视察</figcaption></figure><h1 id="03c2" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">从雅虎财经搜集数据</h1><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mc"><img src="../Images/ed5929aeeba1262c9ae9a576938f5007.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dySzsnh4KRAzcg6zd3gTlA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">雅虎财经<strong class="bd jv">道琼斯工业平均指数页面截图</strong></figcaption></figure><p id="70ea" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">既然我们知道了网络抓取是如何工作的，我们现在就可以进入正题了。我们想从<a class="ae iu" href="https://finance.yahoo.com/quote/%5EDJI/history?p=%5EDJI" rel="noopener ugc nofollow" target="_blank">雅虎财经</a>获取道琼斯工业平均指数数据，所以我们将提取我在截图中高亮显示的表格。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es md"><img src="../Images/05f854370bac2585ad9334733fc0a926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*29wsu-6rwwBbJNik9Yav6w.png"/></div></div></figure><p id="13d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">一旦你选择了时间段，点击应用按钮，你会看到网址已经改变。</p><pre class="kx ky kz la fd lf le lg lh aw li bi"><span id="7fdc" class="lj ju hi le b fi lk ll l lm ln"><a class="ae iu" href="https://finance.yahoo.com/quote/%5EDJI/history?period1=1362700800&amp;period2=1615161600&amp;interval=1d&amp;filter=history&amp;frequency=1d&amp;includeAdjustedClose=true" rel="noopener ugc nofollow" target="_blank">https://finance.yahoo.com/quote/%5EDJI/history?period1=1362700800&amp;period2=1615161600&amp;interval=1d&amp;filter=history&amp;frequency=1d&amp;includeAdjustedClose=true</a></span></pre><p id="64a5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">刚刚发生的是，我们发出了一个<strong class="ix hj"> GET </strong>请求，我们说我们想要从<code class="du lb lc ld le b">period1=1362700800</code>到<code class="du lb lc ld le b">period2=1615161600</code>的数据。这里时间戳的格式是*纪元时间。</p><h1 id="28e7" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">我们的网络机器人概述</h1><p id="b7b8" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">在我们的 web bot 中，我们可以编写一个接受两个时间戳的函数，这样我们就可以获得任何想要的时间间隔，而不必再打开网站。</p><figure class="kx ky kz la fd ij"><div class="bz dy l di"><div class="me mf l"/></div></figure><h1 id="d2fb" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">分解剧本</h1><p id="0bd0" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我知道上面的剧本是相当压倒性的。别担心，我会牵着你的手，一步一步地教你:)</p><h2 id="acfe" class="lj ju hi bd jv lo lp lq jz lr ls lt kd jg lu lv kh jk lw lx kl jo ly lz kp ma bi translated">下载网页</h2><p id="c0f4" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我们将使用我们上面讨论过的 URL，并且我们将用这个函数的参数交换纪元时间。接下来，编写一个 try-except 块，以防在请求数据时出现任何错误。</p><p id="bb0a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du lb lc ld le b">page = requests.get(url)</code>是魔法发生的地方，程序将发出请求并将数据存储在<code class="du lb lc ld le b">page</code>变量中。注意，返回的对象<code class="du lb lc ld le b">page</code>是一个响应对象。为了以字节串的形式获取 HTML 页面的内容，我们将做<code class="du lb lc ld le b">page.content</code></p><pre class="kx ky kz la fd lf le lg lh aw li bi"><span id="c50f" class="lj ju hi le b fi lk ll l lm ln">url = f"https://finance.yahoo.com/quote/%5EDJI/history?<br/>period1={period1}<br/>&amp;period2={period2}<br/>&amp;interval=1d<br/>&amp;filter=history<br/>&amp;frequency=1d<br/>&amp;includeAdjustedClose=true"</span><span id="4c79" class="lj ju hi le b fi mg ll l lm ln"><em class="mh">try</em>:<br/>    page = requests.get(url)<br/>    page.raise_for_status()</span><span id="dc3d" class="lj ju hi le b fi mg ll l lm ln"><em class="mh">except</em> requests.exceptions.HTTPError <em class="mh">as</em> e:<br/>    print("HTTP Error:", e)<br/><em class="mh">except</em> requests.exceptions.ConnectionError <em class="mh">as</em> e:<br/>    print("Error Connecting:", e)<br/><em class="mh">except</em> requests.exceptions.Timeout <em class="mh">as</em> e:<br/>    print("Timeout Error:", e)<br/><em class="mh">except</em> requests.exceptions.RequestException <em class="mh">as</em> e:<br/>    print("Request exception: ", e)</span></pre><h1 id="fe8b" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">解析数据</h1><p id="eb4d" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">因为 HTML 页面中的数据嵌入在 HTML 标签中，而标签并不遵循严格的语法。用普通 Python 解析 HTML 页面中的数据可能是一场噩梦。这就是为什么我们需要 BeautifulSoup，因为它让事情变得如此简单！用<code class="du lb lc ld le b">soup.table</code>可以很容易的得到<table>标签中的数据。</table></p><pre class="kx ky kz la fd lf le lg lh aw li bi"><span id="320e" class="lj ju hi le b fi lk ll l lm ln">soup = BeautifulSoup(page.content, "lxml")<br/>table = soup.table</span></pre><h2 id="51b4" class="lj ju hi bd jv lo lp lq jz lr ls lt kd jg lu lv kh jk lw lx kl jo ly lz kp ma bi translated">观察 HTML 文件</h2><p id="4b9e" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">在我们继续之前，我们需要知道数据位于何处，以便我们知道如何提取它。在下面的截图中，我们可以看到我们想要的数据在<code class="du lb lc ld le b">&lt;table&gt;</code>标签中，标题在<code class="du lb lc ld le b">&lt;thead&gt;</code>标签中，正文在<code class="du lb lc ld le b">&lt;tbody&gt;</code>标签中。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mi"><img src="../Images/0fce8d1ca6408a3a5eb878be30136579.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1dRynSE4UY8WGFzSiQKPJQ.png"/></div></div></figure><p id="4631" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们仔细看看表的结构。在<code class="du lb lc ld le b">&lt;thead&gt;</code>标签中，有一个<code class="du lb lc ld le b">&lt;tr&gt;</code>标签定义了表格中的一行，而<code class="du lb lc ld le b">&lt;th&gt; </code>标签定义了标题单元格。至于在<code class="du lb lc ld le b">&lt;tbody&gt;</code>标签里面有什么，这是非常相似的，但是我们在这里使用<code class="du lb lc ld le b">&lt;td&gt;</code>来定义标准的数据单元格。</p><pre class="kx ky kz la fd lf le lg lh aw li bi"><span id="1c20" class="lj ju hi le b fi lk ll l lm ln">&lt;table&gt;<br/>    &lt;thead&gt; <br/>        &lt;tr&gt;<br/>           &lt;th&gt;...&lt;/th&gt;<br/>           &lt;th&gt;...&lt;/th&gt;<br/>        &lt;/tr&gt;<br/>    &lt;/thead&gt;<br/>    &lt;tbody&gt;<br/>        &lt;tr&gt;<br/>           &lt;td&gt;...&lt;/td&gt;<br/>           &lt;td&gt;...&lt;/td&gt;<br/>        &lt;/tr&gt;<br/>    &lt;/tbody&gt;<br/>&lt;/table&gt;</span></pre><h2 id="33ec" class="lj ju hi bd jv lo lp lq jz lr ls lt kd jg lu lv kh jk lw lx kl jo ly lz kp ma bi translated">提取标题</h2><p id="7051" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">为了找到带有标签的数据，我们使用<code class="du lb lc ld le b">find()</code>或<code class="du lb lc ld le b">findall()</code>，所以我们在这里做的是从<code class="du lb lc ld le b">&lt;thead&gt;</code>中提取标题，并将它们存储到<code class="du lb lc ld le b">headings</code>列表中。</p><pre class="kx ky kz la fd lf le lg lh aw li bi"><span id="3fa8" class="lj ju hi le b fi lk ll l lm ln">table_head = table.find('thead')<br/>table_headrows = table_head.find_all('th')<br/><em class="mh">for</em> row <em class="mh">in</em> table_headrows:<br/>    col = row.text.strip()<br/>    headings.append(col.replace('*', ''))</span></pre><h2 id="aa58" class="lj ju hi bd jv lo lp lq jz lr ls lt kd jg lu lv kh jk lw lx kl jo ly lz kp ma bi translated">提取尸体</h2><pre class="kx ky kz la fd lf le lg lh aw li bi"><span id="cf28" class="lj ju hi le b fi lk ll l lm ln">table_body = table.find('tbody')<br/>table_bodyrows = table_body.find_all('tr')<br/><em class="mh">for</em> row <em class="mh">in</em> table_bodyrows:<br/>    cols = row.select('td span')<br/>    cols = [col.get_text() <em class="mh">for</em> col <em class="mh">in</em> cols]<br/>    data.append(cols)</span></pre><p id="bbbb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你研究一下<code class="du lb lc ld le b">&lt;td&gt;</code>标签里面的内容，你会发现数据是用一个&lt; span &gt;标签包装的，所以我们将<code class="du lb lc ld le b">use row.select(‘td span’)</code>来获取我们的数据。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mj"><img src="../Images/4c388781e13b7cfbd3b1be1480db8a0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nipwZ7Cj9FPyU7VnQ-n3pw.png"/></div></div></figure><p id="514e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们已经找到了数据所在的位置，为了移除标签，我们将使用<code class="du lb lc ld le b">get_text()</code>来移除标签。</p><p id="06df" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你有它！我们只是从网站上搜集了所有我们想要的数据。您可以使用<code class="du lb lc ld le b">pickle</code>库将其作为 JSON 文件转储，或者将它们写入 CSV 文件。</p><figure class="kx ky kz la fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mk"><img src="../Images/700fce3f38fa926d2506450129fb214c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S-OeMsNjnQPWXOSqf_TtJA.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">网络机器人的输出</figcaption></figure><h1 id="999e" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">笔记</h1><p id="264c" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated"><em class="mh">*什么是纪元时间？</em></p><p id="d886" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="mh"/><strong class="ix hj"><em class="mh">Unix epoch</em></strong><em class="mh">(或</em><strong class="ix hj"><em class="mh">Unix time</em></strong><em class="mh">或</em><strong class="ix hj"><em class="mh">POSIX time</em></strong><em class="mh">或</em><strong class="ix hj"><em class="mh">Unix timestamp</em></strong><em class="mh">)是自 1970 年 1 月 1 日(午夜 UTC/GMT)以来经过的秒数，不计算闰秒(in)</em></p><h1 id="c425" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">参考资料:</h1><ol class=""><li id="c7f3" class="ml mm hi ix b iy kr jc ks jg mn jk mo jo mp js mq mr ms mt bi translated"><a class="ae iu" href="https://www.kaggle.com/geminikeggler/stock-sentiment-analysis-classification-nlp/notebook?select=Stock_Dataa.csv" rel="noopener ugc nofollow" target="_blank">股票情绪分析-分类，NLP </a></li><li id="6080" class="ml mm hi ix b iy mu jc mv jg mw jk mx jo my js mq mr ms mt bi translated">我导师的课堂笔记<a class="ae iu" href="https://www.deanza.edu/faculty/nguyenclare/" rel="noopener ugc nofollow" target="_blank">克莱尔·阮</a></li><li id="9ff1" class="ml mm hi ix b iy mu jc mv jg mw jk mx jo my js mq mr ms mt bi translated">什么是纪元时间？引自历元转换器</li></ol></div></div>    
</body>
</html>