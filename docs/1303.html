<html>
<head>
<title>Azure Data Factory — Data Engineering Pipelines with Oracle As Source</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Azure数据工厂——以Oracle为源的数据工程管道</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/azure-data-factory-data-engineering-pipelines-with-oracle-as-source-5688f1cc7c90?source=collection_archive---------7-----------------------#2021-03-13">https://medium.com/nerd-for-tech/azure-data-factory-data-engineering-pipelines-with-oracle-as-source-5688f1cc7c90?source=collection_archive---------7-----------------------#2021-03-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="456a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Azure数据工厂是Azure云空间中几乎所有数据工程和数据编排的首选产品。尽管有许多连接器/链接服务可用于不同的源，但其中一些缺乏开箱即用的关键特性。Oracle连接器就是这样一种连接器。</p><p id="55e8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们将讨论Oracle连接器缺少的一个关键特性，以及如何构建数据工程管道来帮助弥合这一差距。本文旨在帮助那些使用Oracle数据库作为源代码并希望在Oracle中执行某些流程作为数据工程管道的一部分的开发人员。</p><p id="aa5e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Oracle连接器/链接服务对于“复制”和“查找”活动是高度可靠的。对于“存储过程”活动来说，情况并非如此。这是因为，连接器缺乏执行Oracle存储包/过程的能力。已经有相当多的请求发布到产品团队，但看起来这个功能可能不会很快可用。</p><p id="7867" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对此有什么解决办法？</p><p id="2ed9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">用Oracle的术语来说，就是PRAGMA自治_事务。是的，正是自主事务有助于弥合这一差距。</p><p id="1506" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们开始行动，看看这是如何在一个场景的帮助下工作的。</p><p id="fab9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">场景:</strong>一家银行希望对他们每天收到的贷款申请进行风险评估。假设银行正在使用Oracle数据库，并且他们将自己的定制逻辑编写为Oracle数据库中的存储包。该银行还使用数据湖存储和数据块来训练一个ML模型，其结果来自这个Oracle存储包。</p><p id="ac52" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，银行不希望在其他地方重写定制的复杂逻辑，而是希望尽可能多地重用Oracle对象以节省时间和成本。</p><p id="4c88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们假设执行风险评估的Oracle存储包的名称为XX_BANK_RISK_ASSESSMENT_CHECK。LOAN _ APPLICATION(p _ APPLICATION _ number = &gt;，p_age = &gt;，p_loan_amount = &gt;，p_salary = &gt;，p_job_type = &gt;)。存储的包捕获所有可能的异常和每个步骤的详细日志，作为带有日期和时间戳的自定义Oracle表中执行的一部分。在我们的案例中，关键字段将是申请号和风险评估结果。</p><p id="cd2a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">解决方案:</strong>在数据工厂中调用这个存储包的步骤如下:</p><p id="a5e0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤1:创建一个Oracle函数，作为这个存储包的包装器。该函数应该创建为PRAGMA自治事务，如下所示。这是为了确保存储过程可以通过函数调用，但作为一个单独的事务。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/f3cb7bbae66dfc7564a4cf10cf359abe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pDZ1RWn9A7e56q-aE-Tgkw.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在Oracle数据库中创建的Oracle函数</figcaption></figure><p id="9994" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤2:在数据工厂的控制流中包含一个查找活动。因为Oracle函数可以作为SELECT语句的一部分，所以现在我们可以通过查找活动查询中的Oracle函数调用存储的包作为自治事务。</p><p id="1669" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jt">查询</em>:从DUAL中选择XX _ BANK _ RISK _ ASSESSMENT _ CHECK(' app 123 '，' 35 '，' 100000.00 '，' 30000.00 '，'全日制')；</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ju"><img src="../Images/7690c12965fe7af7f4005565aa54e812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bQlPpi-FVSrwEHXGeg6Efg.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">从数据工厂调用Oracle函数</figcaption></figure><p id="d394" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">步骤3:添加一个Until操作来检查应用程序状态是否有结果。这就是日志表派上用场的地方。始终确保包含一个日志表，该表将作为Oracle存储包/过程的一部分捕获所有详细信息。表中的日志详细信息可以是每个贷款申请级别的，也可以是基于业务用例的所有申请的汇总级别。在这种情况下，我们将认为它是针对每个贷款申请的。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jv"><img src="../Images/d3e623b8e9a6e303d04929780fd6ed12.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*VNhfIm06HEMFGsmVZS4epg.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">直到在“调用Oracle函数”查找活动之后执行的活动</figcaption></figure><p id="dec1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jt">表达式</em>:<a class="ae jw" href="http://twitter.com/or" rel="noopener ugc nofollow" target="_blank">@或</a> (equals(activity('获取应用状态'). output.firstRow.STATUS，'成功')，equals(activity('获取应用状态'). output.firstRow.STATUS，'失败'))。</p><p id="6c00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Until活动将包含一个查找活动和一个If条件活动。查找活动将在日志表中查询贷款申请的最终状态，If条件将检查申请结果。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jx"><img src="../Images/4650c9b375ce2d5519c52094f7cdb7b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1094/format:webp/1*MDbUkUTOZR_K3I-szJpdZA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">Until活动中的活动</figcaption></figure><p id="1f35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">查找活动，</p><p id="895e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jt">查询</em>:从Risk_Assessment_Log中选择application_number，status，其中application _ number = ' APP123</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jy"><img src="../Images/7e7fcb993e0f0494aec9b1dee3d637b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1350/format:webp/1*TebJ-e3Wb_XfkkR7lhI3ag.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">查找活动中的查询</figcaption></figure><p id="0bec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果条件活动，</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jz"><img src="../Images/eb2627873eec1d673f9c44f37287369b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*gHHJcjKwrKA2vsMnB82mrg.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">If条件的表达式</figcaption></figure><p id="0f4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jt">表达式</em>:<a class="ae jw" href="http://twitter.com/or" rel="noopener ugc nofollow" target="_blank">@或</a> (equals(activity('获取应用状态'). output.firstRow.STATUS，'成功')，equals(activity('获取应用状态'). output.firstRow.STATUS，'失败'))。</p><blockquote class="ka kb kc"><p id="54eb" class="if ig jt ih b ii ij ik il im in io ip kd ir is it ke iv iw ix kf iz ja jb jc hb bi translated"><em class="hi">注意:</em>在我的例子中，If条件活动和Until活动的表达式是相同的。</p></blockquote><h2 id="db09" class="kg kh hi bd ki kj kk kl km kn ko kp kq iq kr ks kt iu ku kv kw iy kx ky kz la bi translated"><strong class="ak">可能的结果</strong></h2><p id="32c2" class="pw-post-body-paragraph if ig hi ih b ii lb ik il im lc io ip iq ld is it iu le iw ix iy lf ja jb jc hb bi translated">假设存储的包在Oracle中成功完成，并根据贷款申请号更新了状态为(成功或失败)的日志表。</p><p id="ff5d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果If Condition活动评估为True condition，它将不会执行任何进一步的任务，因为在此阶段我们已经有了贷款申请的结果。它会将控制转移到Until活动，在这种情况下，Until活动将依次退出，并继续进行数据管道中的下一个活动。</p><p id="0d89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果应用程序状态尚不可用，它将进入错误模式并执行等待。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es lg"><img src="../Images/9aa543599ec38ec28713f47a62cddd6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*DfwFAtlTvbpLBUZCe5JmpA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">在错误条件下要执行的等待间隔活动</figcaption></figure><p id="6ec4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在等待活动完成之后，Until活动将再次执行，以检查贷款申请的最终状态。Until活动将一直执行，直到它对退出条件的评估为true。</p><p id="1d93" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以根据用例将Until活动定制为在一定数量的计数后出错。如果是这种情况，您将需要使用一个变量并增加变量的计数，而不是等待活动。</p><p id="5767" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这篇文章能有所帮助，并为使用Oracle数据库的数据工程师提供急需的信息。该模板可以从我的GitHub存储库https://GitHub . com/Sri Nath-param/data-engineering/tree/main/data-factory-pipelines-Oracle-stored-packages-or-procedures-call下载</p><h1 id="7b07" class="lh kh hi bd ki li lj lk km ll lm ln kq lo lp lq kt lr ls lt kw lu lv lw kz lx bi translated">让我们学习，帮助别人学习！</h1></div></div>    
</body>
</html>