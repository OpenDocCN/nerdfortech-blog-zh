<html>
<head>
<title>Direktiv: provision using Terraform, harden using Ansible (part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Direktiv:使用Terraform提供，使用Ansible强化(第3部分)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/direktiv-provision-using-terraform-harden-using-ansible-part-3-73f655fb66f8?source=collection_archive---------8-----------------------#2021-08-09">https://medium.com/nerd-for-tech/direktiv-provision-using-terraform-harden-using-ansible-part-3-73f655fb66f8?source=collection_archive---------8-----------------------#2021-08-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="4608" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是3系列博客文章中的第3篇，也是最后一篇。在这里，我们将最终的工作流缝合在一起，使用Terraform来供应AWS或GCP Ubuntu实例，然后使用Ansible将CIS强化应用到2台机器。为了好玩，我们将集成到<a class="ae jd" href="https://freshservice.com/" rel="noopener ugc nofollow" target="_blank"> Freshservice </a>中，并为成功的供应创建CMDB记录，或者在失败时创建事件记录。</p><p id="8c7f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最终的工作流程如下所示:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/111ebe6f2cff11f6c2664f85e1eff530.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fRDpPJXwq8gyXMInJyE3fg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">端到端工作流</figcaption></figure><h1 id="8da4" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">地形部署</h1><p id="51cd" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">首先，Terraform将用于创建AWS或GCP实例。如果你想知道这是如何发生的，更多细节可以在<a class="ae jd" rel="noopener" href="/nerd-for-tech/direktiv-building-a-machine-on-aws-using-terraform-without-a-terraform-environment-def24fe3221d">这里</a>找到。</p><p id="5cb0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Terraform工作流在AWS或GCP中创建计算机，并存储Terraform脚本的状态。Terraform工作流的输出如下所示:</p><pre class="jf jg jh ji fd kx ky kz la aw lb bi"><span id="fceb" class="lc jv hi ky b fi ld le l lf lg">{<br/>  "terraform": {<br/>    "action": "apply",<br/>    "amazon_ip": "3.25.222.101",<br/>    "return": "",<br/>    "var": {<br/>      "awsinstance": {<br/>        "lineage": "",<br/>        "outputs": {<br/>          "ip-address": {<br/>            "type": "string",<br/>            "value": "3.25.222.101"<br/>          }<br/>        },<br/>        "resources": [<br/>          {<br/>            "instances": [<br/>              {<br/>                "attributes": {<br/>                  "architecture": "x86_64",<br/>                  "arn": "arn:aws:ec2:ap-southeast-2::image/ami-04b1878ebf78f7370",<br/>                  "block_device_mappings": [<br/>                    {<br/>                      "device_name": "/dev/sda1",<br/>                      "ebs": {<br/>                        "delete_on_termination": "true",<br/>                        "encrypted": "false",<br/>                        "iops": "0",<br/>                        "snapshot_id": "snap-071b73fa329b8fb2f",<br/>                        "throughput": "0",<br/>                        "volume_size": "8",<br/>                        "volume_type": "gp2"<br/>                      },<br/>                      "no_device": "",<br/>                      "virtual_name": ""<br/>                    },<br/>                    {<br/>                      "device_name": "/dev/sdb",<br/>                      "ebs": {},<br/>                      "no_device": "",<br/>                      "virtual_name": "ephemeral0"<br/>                    },<br/>                    {<br/>                      "device_name": "/dev/sdc",<br/>                      "ebs": {},<br/>                      "no_device": "",<br/>                      "virtual_name": "ephemeral1"<br/>                    }<br/>                  ],<br/>                  "creation_date": "2021-07-21T13:27:16.000Z",<br/>                  "description": "Canonical, Ubuntu, 20.04 LTS, amd64 focal image build on 2021-07-20",<br/>                  "ena_support": true,<br/>                  "executable_users": null,<br/>                  "filter": [<br/>                    {<br/>                      "name": "name",<br/>                      "values": [<br/>                        "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"<br/>                      ]<br/>                    },<br/>                    {<br/>                      "name": "virtualization-type",<br/>                      "values": [<br/>                        "hvm"<br/>                      ]<br/>                    }<br/>                  ],<br/>                  "hypervisor": "xen",<br/>                  "id": "ami-04b1878ebf78f7370",<br/>                  "image_id": "ami-04b1878ebf78f7370",<br/>                  "image_location": "099720109477/ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-20210720",<br/>                  "image_owner_alias": null,<br/>                  "image_type": "machine",<br/>                  "kernel_id": null,<br/>                  "most_recent": true,<br/>                  "name": "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-20210720",<br/>                  "name_regex": null,<br/>                  "owner_id": "099720109477",<br/>                  "owners": [<br/>                    "099720109477"<br/>                  ],<br/>                  "platform": null,<br/>                  "platform_details": "Linux/UNIX",<br/>                  "product_codes": [],<br/>                  "public": true,<br/>                  "ramdisk_id": null,<br/>                  "root_device_name": "/dev/sda1",<br/>                  "root_device_type": "ebs",<br/>                  "root_snapshot_id": "snap-071b73fa329b8fb2f",<br/>                  "sriov_net_support": "simple",<br/>                  "state": "available",<br/>                  "state_reason": {<br/>                    "code": "UNSET",<br/>                    "message": "UNSET"<br/>                  },<br/>                  "tags": {},<br/>                  "usage_operation": "RunInstances",<br/>                  "virtualization_type": "hvm"<br/>                },<br/>                "schema_version": 0,<br/>                "sensitive_attributes": []<br/>              }<br/>            ],<br/>            "mode": "data",<br/>            "name": "ubuntu",<br/>            "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",<br/>            "type": "aws_ami"<br/>          },<br/>          {<br/>            "instances": [<br/>              {<br/>                "attributes": {<br/>                  "ami": "ami-04b1878ebf78f7370",<br/>                  "arn": "arn:aws:ec2:ap-southeast-2:338328518639:instance/i-0cc5eecf4e741c528",<br/>                  "associate_public_ip_address": true,<br/>                  "availability_zone": "ap-southeast-2c",<br/>                  "capacity_reservation_specification": [<br/>                    {<br/>                      "capacity_reservation_preference": "open",<br/>                      "capacity_reservation_target": []<br/>                    }<br/>                  ],<br/>                  "cpu_core_count": 1,<br/>                  "cpu_threads_per_core": 2,<br/>                  "credit_specification": [<br/>                    {<br/>                      "cpu_credits": "unlimited"<br/>                    }<br/>                  ],<br/>                  "disable_api_termination": false,<br/>                  "ebs_block_device": [],<br/>                  "ebs_optimized": false,<br/>                  "enclave_options": [<br/>                    {<br/>                      "enabled": false<br/>                    }<br/>                  ],<br/>                  "ephemeral_block_device": [],<br/>                  "get_password_data": false,<br/>                  "hibernation": false,<br/>                  "host_id": null,<br/>                  "iam_instance_profile": "",<br/>                  "id": "i-0cc5eecf4e741c528",<br/>                  "instance_initiated_shutdown_behavior": "stop",<br/>                  "instance_state": "running",<br/>                  "instance_type": "t3.micro",<br/>                  "ipv6_address_count": 0,<br/>                  "ipv6_addresses": [],<br/>                  "key_name": "KEY_NAME",<br/>                  "launch_template": [],<br/>                  "metadata_options": [<br/>                    {<br/>                      "http_endpoint": "enabled",<br/>                      "http_put_response_hop_limit": 1,<br/>                      "http_tokens": "optional"<br/>                    }<br/>                  ],<br/>                  "monitoring": false,<br/>                  "network_interface": [],<br/>                  "outpost_arn": "",<br/>                  "password_data": "",<br/>                  "placement_group": "",<br/>                  "primary_network_interface_id": "eni-0626d7355c4448815",<br/>                  "private_dns": "ip-172-31-29-221.ap-southeast-2.compute.internal",<br/>                  "private_ip": "172.31.29.221",<br/>                  "public_dns": "ec2-3-25-222-101.ap-southeast-2.compute.amazonaws.com",<br/>                  "public_ip": "3.25.222.101",<br/>                  "root_block_device": [<br/>                    {<br/>                      "delete_on_termination": true,<br/>                      "device_name": "/dev/sda1",<br/>                      "encrypted": false,<br/>                      "iops": 100,<br/>                      "kms_key_id": "",<br/>                      "tags": {},<br/>                      "throughput": 0,<br/>                      "volume_id": "vol-08459839a0cea998e",<br/>                      "volume_size": 8,<br/>                      "volume_type": "gp2"<br/>                    }<br/>                  ],<br/>                  "secondary_private_ips": [],<br/>                  "security_groups": [<br/>                    "default"<br/>                  ],<br/>                  "source_dest_check": true,<br/>                  "subnet_id": "subnet-ecd6bfb4",<br/>                  "tags": null,<br/>                  "tags_all": {},<br/>                  "tenancy": "default",<br/>                  "timeouts": null,<br/>                  "user_data": null,<br/>                  "user_data_base64": null,<br/>                  "volume_tags": null,<br/>                  "vpc_security_group_ids": [<br/>                    "sg-33d72045"<br/>                  ]<br/>                },<br/>                "dependencies": [<br/>                  "data.aws_ami.ubuntu"<br/>                ],<br/>                "private": "PRIVATE_KEY",<br/>                "schema_version": 1,<br/>                "sensitive_attributes": []<br/>              }<br/>            ],<br/>            "mode": "managed",<br/>            "name": "web",<br/>            "provider": "provider[\"registry.terraform.io/hashicorp/aws\"]",<br/>            "type": "aws_instance"<br/>          }<br/>        ],<br/>        "serial": 24,<br/>        "terraform_version": "0.15.3",<br/>        "version": 4<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="2002" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的输出用于评估资源调配是成功还是失败。如果成功，需要创建CMDB项目，否则我们需要创建一个事件记录。接下来让我们看看CMDB创建工作流。</p><h1 id="88b7" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">CMDB工作流程</h1><p id="43fc" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">CMDB工作流是对<a class="ae jd" href="https://api.freshservice.com/v1/#asset" rel="noopener ugc nofollow" target="_blank"> Freshservice API </a>的简单<code class="du lh li lj ky b">request</code>调用。Direktiv中的配置非常简单:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lk ll l"/></div></figure><p id="1bce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建的CMDB项目非常标准:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lm"><img src="../Images/9ab3fe35e2097d4a555a08999f2d6dfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dUKde5i_2bLL68o00paeMg.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">在Freshservice中创建的CMDB项目</figcaption></figure><h1 id="32bf" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">可行的部署</h1><p id="c000" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">如果通过Terraform的供应成功，Ansible将用于运行Ubuntu 20.04的CIS强化行动手册。如果你想知道这是如何发生的，更多细节可以在这里找到。</p><p id="7065" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们的Ansible行动手册的输出如下所示(注意，在这种情况下，我们在行动手册上强加了一个错误条件，以便能够测试事件创建过程):</p><pre class="jf jg jh ji fd kx ky kz la aw lb bi"><span id="2603" class="lc jv hi ky b fi ld le l lf lg">[9:47:46.387] Preparing workflow triggered by API. <br/>[9:47:46.400] Running state logic -- clone-ansible-cis-hardening:1 (action) <br/>[9:47:46.413] Sleeping until function 'git-command' returns. <br/>[9:47:48.905] running command 0 'clone https://github.com/wwonigkeit/Direktiv-CIS-Ubuntu-20.04-Ansible.git /mnt/shared/1wSypRvilu7iK6X3VaW07D2cjU4/out/workflow/ansible-cis-var' <br/>[9:47:50.375] Function 'git-command' returned. <br/>[9:47:50.405] Transitioning to next state: run-ansible (2). <br/>[9:47:50.436] Running state logic -- run-ansible:2 (action) <br/>[9:47:50.497] Sleeping until function 'ansible' returns. <br/>[9:47:57.595] Function 'ansible' returned. <br/>[9:47:57.595] Action raised catchable error 'com.ansible.cmd': exit status 2:  PLAY [all] *********************************************************************  TASK [CIS-Ubuntu-20.04-Ansible : 2.1.1 Ensure xinetd is not installed] ********* ok: [52.64.29.123]  TASK [CIS-Ubuntu-20.04-Ansible : 2.1.2 Ensure openbsd-inetd is not installed] *** ok: [52.64.29.123]  TASK [CIS-Ubuntu-20.04-Ansible : 2.2.1.1 Ensure time synchronization is in use - service install] *** [WARNING]: conditional statements should not include jinja2 templating delimiters such as {{ }} or {% %}. Found: {{enableNTP}} fatal: [52.64.29.123]: FAILED! =&gt; {"changed": false, "msg": "No package matching 'ntp' is available"}  PLAY RECAP ********************************************************************* 52.64.29.123               : ok=2    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0. <br/>[9:47:57.632] Workflow failed with uncaught error 'com.ansible.cmd': exit status 2:  PLAY [all] *********************************************************************  TASK [CIS-Ubuntu-20.04-Ansible : 2.1.1 Ensure xinetd is not installed] ********* ok: [52.64.29.123]  TASK [CIS-Ubuntu-20.04-Ansible : 2.1.2 Ensure openbsd-inetd is not installed] *** ok: [52.64.29.123]  TASK [CIS-Ubuntu-20.04-Ansible : 2.2.1.1 Ensure time synchronization is in use - service install] *** [WARNING]: conditional statements should not include jinja2 templating delimiters such as {{ }} or {%}. Found: {{enableNTP}} fatal: [52.64.29.123]: FAILED! =&gt; {"changed": false, "msg": "No package matching 'ntp' is available"}  PLAY RECAP ********************************************************************* 52.64.29.123               : ok=2    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0</span></pre><p id="467f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下一步—让我们用票证更新服务台！</p><h1 id="905c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">新鲜服务票证创建</h1><p id="4a5d" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">票证创建工作流是对<a class="ae jd" href="https://api.freshservice.com/v1/#create_ticket" rel="noopener ugc nofollow" target="_blank"> Freshservice API </a>的一个简单的<code class="du lh li lj ky b">request</code>调用(再次)…这里出现了一个模式！Direktiv中的配置非常简单:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lk ll l"/></div></figure><p id="e9fc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在Freshservice的机票:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es lm"><img src="../Images/f99536dd96edf95d38c97adf3b6173b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4SDwcnkSl6QBV1Y6OT9Idw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">新鲜服务票证创建</figcaption></figure><h1 id="ff39" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">最终工作流程</h1><p id="3367" class="pw-post-body-paragraph if ig hi ih b ii ks ik il im kt io ip iq ku is it iu kv iw ix iy kw ja jb jc hb bi translated">最终的工作流程如下所示:</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ln"><img src="../Images/1ccd963201f5cabdd82ab491481eee6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gcXZ9nvYz2JcYyVy9_mUEw.png"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">端到端工作流执行</figcaption></figure><p id="bd72" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">和YAML配置文件:</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lk ll l"/></div></figure></div></div>    
</body>
</html>