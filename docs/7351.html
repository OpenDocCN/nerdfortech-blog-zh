<html>
<head>
<title>EffectFnAff — Let’s create Async Foreign Functions in purescript — Exploring purescript-modules #3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">EffectFnAff —让我们在 purescript 中创建异步外部函数—探索 purescript 模块#3</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/effectfnaff-lets-create-async-foreign-functions-in-purescript-exploring-purescript-modules-3-b0e168547851?source=collection_archive---------5-----------------------#2022-10-05">https://medium.com/nerd-for-tech/effectfnaff-lets-create-async-foreign-functions-in-purescript-exploring-purescript-modules-3-b0e168547851?source=collection_archive---------5-----------------------#2022-10-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cf1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我在<strong class="ih hj"><em class="jd">#探索 ps 模块系列中的第三篇文章。在这篇文章中，我们将探索一个非常酷的 purescript 模块。</em></strong></p><p id="b293" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们接受这一点，我们不能单独用 purescript 做所有的事情，有时我们需要 javascript 的帮助，为此我们使用 FFI(外部函数接口),它支持 PureScript 代码与 JavaScript 代码之间的通信，反之亦然。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/6a291adcb717c3f58a14311b75ff92c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q0Im08fqayc_H6tDtdu5sQ.jpeg"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated"><a class="ae ju" href="https://unsplash.com/@adriencesard?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Adrien céSARD</a>在<a class="ae ju" href="https://unsplash.com/s/photos/bridge?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="10bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设您想要实现<code class="du jv jw jx jy b">Euclidean algorithm</code>来寻找两个数字的 GCD，但是您不想用 purescript 编写它，所以您用 JS 创建了这个函数。</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="1b58" class="kd ke hi jy b fi kf kg l kh ki">//example.js</span><span id="badc" class="kd ke hi jy b fi kj kg l kh ki">exports["gcd"] = function (a){<br/>  return function(b){<br/>        //..... <br/>        return result;<br/>    }<br/>}</span></pre><p id="c94f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们从 purescript 端对外导入</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="2eaa" class="kd ke hi jy b fi kf kg l kh ki">//example.purs<br/>foreign import gcd :: Int -&gt; Int -&gt; Int </span></pre><p id="4840" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这很简单。但是你试过国外导入异步函数吗？</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="b9b0" class="kd ke hi jy b fi kf kg l kh ki">foreign import myAsyncGCDFunction :: Int -&gt; Int -&gt; Aff Int</span></pre><p id="f8fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以使用<code class="du jv jw jx jy b">Aff</code>作为国外进口的退货类型吗？</p><p id="085a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不，我们不能这么做。为什么？因为 Aff 是一个复杂的 purescript 数据结构，它不仅仅是一个我们可以从 JS 返回的普通函数。</p><p id="3dd6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于这类用例，我们有一个叫做<code class="du jv jw jx jy b">EffectFnAff</code>的特殊类型，它可以让我们为异步 javascript 函数创建一个 purescript 接口。</p><p id="0f30" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">出于演示目的，我们将创建一个异步函数<code class="du jv jw jx jy b">addWithDelay</code>，它将接受两个整数并在 1 秒钟后返回结果。</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="a936" class="kd ke hi jy b fi kf kg l kh ki">function adddWithDelay(a,b) {<br/>   return new Promise((resolve, reject) =&gt; {<br/>           setTimeout(() =&gt; resolve(a+b) , 1000);<br/>          });<br/>}</span></pre><blockquote class="kk kl km"><p id="6b2c" class="if ig jd ih b ii ij ik il im in io ip kn ir is it ko iv iw ix kp iz ja jb jc hb bi translated"><strong class="ih hj">注意:</strong>我没有导入这个函数</p></blockquote><p id="a47f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如何将这个转换成与 purescript 兼容的外来函数？</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kq kr l"/></div></figure><p id="77ad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">好了，我们来一点一点的解剖一下上面的函数。</p><p id="4707" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第 4 行:</strong> <code class="du jv jw jx jy b">EffectFnAff</code>会给我们两个回调<code class="du jv jw jx jy b">onError</code> &amp; <code class="du jv jw jx jy b">onSuccess.</code>一个可以用错误调用，另一个可以用我们函数要返回的实际值调用。</p><p id="3bcf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第 8 行:</strong>我们打电话给<code class="du jv jw jx jy b">onSuccess</code>，承诺的结果是<code class="du jv jw jx jy b">r</code></p><p id="50cf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">第 10 行:</strong> EffectFnAff 需要返回一个取消器，它是一个带有 3 个参数的函数，第一个参数是负责触发取消器的<code class="du jv jw jx jy b">error</code>，第二个参数是当我们不能取消操作时将被调用的函数，第三个参数是当我们完成取消异步操作(如清除资源、关闭数据库连接等)时必须调用的函数。</p><p id="8aee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上面的例子中，我们没有处理任何取消错误，而是直接调用<code class="du jv jw jx jy b">onCancelerSuccess()</code>来告知我们已经成功取消了操作。</p><p id="7445" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">既然我们已经理解了如何从 JS 端编写<code class="du jv jw jx jy b">EffectFnAff</code>，让我们从 purescript 端创建一个接口，这样我们就可以利用它了。</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="3fa9" class="kd ke hi jy b fi kf kg l kh ki">foreign import addWithDelay_ :: Int -&gt; Int -&gt; EffectFnAff Int</span></pre><p id="6e53" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有了外来的导入函数，我们不得不写另一个 purescript 接口，可以将这个“无用的”<code class="du jv jw jx jy b">EffectFnAff</code>转换成<code class="du jv jw jx jy b">Aff.</code>如果你在<a class="ae ju" href="https://pursuit.purescript.org/packages/purescript-aff/7.1.0/docs/Effect.Aff.Compat#v:fromEffectFnAff" rel="noopener ugc nofollow" target="_blank"> pursuit </a>上搜索一个转换<code class="du jv jw jx jy b">EffectFnAff -&gt; Aff</code>的函数，那么你会找到一个名为<code class="du jv jw jx jy b">fromEffectFnAff</code>的函数</p><pre class="jf jg jh ji fd jz jy ka kb aw kc bi"><span id="259c" class="kd ke hi jy b fi kf kg l kh ki">addWithDelay :: Int -&gt; Int -&gt; Aff Int<br/>addWithDelay a b = fromEffectFnAff $ addWithDelay_ a b</span></pre><p id="06bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的，我的朋友，这就是把你漂亮的异步函数转换成一个你可以从 purescript 端使用的<code class="du jv jw jx jy b">Aff</code>的全部工作。</p></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><h2 id="3497" class="kd ke hi bd kz la lb lc ld le lf lg lh iq li lj lk iu ll lm ln iy lo lp lq lr bi translated"><strong class="ak">奖金</strong></h2><p id="5e68" class="pw-post-body-paragraph if ig hi ih b ii ls ik il im lt io ip iq lu is it iu lv iw ix iy lw ja jb jc hb bi translated">如果你有兴趣看看<code class="du jv jw jx jy b">EffectFnAff</code>的取消器是如何工作的，只需杀死会自动调用取消器的<code class="du jv jw jx jy b">Aff</code>。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="kq kr l"/></div></figure></div><div class="ab cl ks kt gp ku" role="separator"><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx ky"/><span class="kv bw bk kw kx"/></div><div class="hb hc hd he hf"><p id="3cdb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">希望你喜欢这篇文章，并了解了我们如何在 async Javascript 和 Purescript 之间架起一座桥梁。</p><p id="ca5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">拍手声👏如果你喜欢这篇文章，分享给你的朋友来传播知识。让我们让 Purescript 流行起来💪。</p></div></div>    
</body>
</html>