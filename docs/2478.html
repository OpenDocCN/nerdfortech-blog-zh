<html>
<head>
<title>Deep Dive into Thanos-Part I</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入灭霸——第一部分</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/deep-dive-into-thanos-part-i-f72ecba39f76?source=collection_archive---------1-----------------------#2021-05-08">https://medium.com/nerd-for-tech/deep-dive-into-thanos-part-i-f72ecba39f76?source=collection_archive---------1-----------------------#2021-05-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2b4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用灭霸和普罗米修斯操作员监控Kubernetes的工作负载</p><p id="5eec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您的应用程序运行在Kubernetes上吗？它是高度可扩展的吗？你对它的工作方式满意吗？等等，你是怎么监控他们的？啊，普罗米修斯对吧？太棒了，您有没有想过您的Prometheus集群的可伸缩性和高可用性如何？在此之前，这里有一封来自你老板的邮件，要求你找出你的网站在去年圣诞节收到的http_requests的数量，或者让我们把它变成印度风格。你的老板想知道上一个Sankranthi(一年前)访问过你的网站的客户数量(http_requests总数)。现在你试着进入你的普罗米修斯/格拉夫纳服务器。您刚刚意识到没有找到度量标准。你现在怎么跟老板说？在这种情况真正出现之前，让我们尝试使用<a class="ae jd" href="https://thanos.io/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"/></a>来解决这个问题。灭霸是一种工具，用于设置具有长期存储能力的高可用性Prometheus。灭霸是开源的，是<strong class="ih hj"> CNCF孵化项目</strong>。灭霸的特色是</p><ol class=""><li id="57c6" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc jj jk jl jm bi translated">在GCS、S3、Azure Blob、Swift和Tencent COS等受支持的对象存储中无限制保留Prometheus指标。</li><li id="2740" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">全局查询视图帮助我们查看跨各种名称空间和各种集群产生的多个Prometheus实例的指标。</li><li id="3ab0" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">它与您现有的监控工具兼容，如Prometheus和Grafana。</li><li id="4d3d" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">在查询较大的时间范围或配置复杂的保留策略时，对历史数据进行缩减采样可以大幅提高查询速度。</li></ol><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es js"><img src="../Images/360549a32077cb5b4c54961d34a8aee8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VfjiXizm_ZFZD6foFaxiGQ.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">图片来源<a class="ae jd" href="https://thanos.io/" rel="noopener ugc nofollow" target="_blank">灭霸网站</a></figcaption></figure><h1 id="e6e8" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">整个故事是关于什么的？(TLDR)</h1><ol class=""><li id="1371" class="je jf hi ih b ii lg im lh iq li iu lj iy lk jc jj jk jl jm bi translated">了解灭霸组件。</li><li id="a6c0" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">用灭霸、普罗米修斯操作符和GCS(对象存储)实现HA-Prometheus。</li></ol><h1 id="5927" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">先决条件</h1><ol class=""><li id="2c97" class="je jf hi ih b ii lg im lh iq li iu lj iy lk jc jj jk jl jm bi translated">对普罗米修斯的基本了解。</li></ol><h1 id="71db" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">故事资源</h1><ol class=""><li id="29b6" class="je jf hi ih b ii lg im lh iq li iu lj iy lk jc jj jk jl jm bi translated">GitHub链接:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests</a></li><li id="8cc4" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc jj jk jl jm bi translated">GitHub分支:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/tree/thanos" rel="noopener ugc nofollow" target="_blank"> thanos </a></li></ol><h2 id="55d0" class="ll kj hi bd kk lm ln lo ko lp lq lr ks iq ls lt kw iu lu lv la iy lw lx le ly bi translated">了解灭霸组件</h2><p id="065a" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">开始之前，让我们先详细了解一下灭霸的组件。当我最初试图研究灭霸时，我真的很难理解灭霸是如何运作的，灭霸要完全发挥作用需要哪些组成部分，以及每个组成部分的作用。因此，让我们通过灭霸官方网站上的一个非常有用的架构图来详细解释每个组件并理解它们的用法。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mc"><img src="../Images/4bad0c532bf982f381a3accb2dfa1114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*skb_rR6Qpa1f84Kl-8IQ8w.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">灭霸建筑</figcaption></figure><p id="eca1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> a)灭霸边车</strong></p><p id="97db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">灭霸边车被部署为普罗米修斯舱的边车集装箱。[ <strong class="ih hj">边车容器</strong>是应该与pod中的主容器一起运行的容器]。这是与你的对象存储交互的组件之一(比如S3、GCS、Azure Blob等)。它负责将TSBD块上传到对象存储器。普罗米修斯每两小时生产的积木由灭霸边车上传(每两小时一次)到目标存储器。让我给你看一个样本灭霸边车集装箱上传TSBD块到GCS的日志。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="md me l"/></div></figure><p id="6204" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> b)灭霸查询者/查询者</strong></p><p id="94e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">灭霸查询程序是一个无状态组件，它实现了Prometheus HTTP v1 API来查询灭霸集群中的数据。它通过gRPC协议从底层商店API收集评估PromQL查询所需的数据。商店可以是实现gRPC商店API的数据源之一。</p><ul class=""><li id="cfa8" class="je jf hi ih b ii ij im in iq jg iu jh iy ji jc mf jk jl jm bi translated">普罗米修斯(灭霸边车通过无头服务发现启用)。</li><li id="02d9" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc mf jk jl jm bi translated">通过存储网关从S3、GCS等对象存储。</li><li id="a07e" class="je jf hi ih b ii jn im jo iq jp iu jq iy jr jc mf jk jl jm bi translated">另一个灭霸查询者(可以来自不同的集群)。</li></ul><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mg"><img src="../Images/e8fc460c3693692f8004b853d32968f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lqzJGRRk49cd6qbS8-71ug.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">灭霸Querier UI</figcaption></figure><p id="ba79" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">灭霸·奎尔界面显示了各种商店(通过普罗米修斯边车和来自不同集群的另一个商店发现)。</p><p id="00f6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> c)灭霸查询前端</strong></p><p id="1960" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">灭霸查询前端是一个放在灭霸查询器前面的服务，用于改善读取路径。它帮助我们将一个长查询拆分成多个短查询。这有助于更好地并行化查询，也有助于更好地平衡查询的负载。这也有助于缓存查询，并提高较长查询的效率。目前支持内存缓存(FIFO缓存)和Memcached。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mh"><img src="../Images/9d2500ba4795fb78d44d23e6a481d552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*63XiNX0kxPkLyKbnjngZgg.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">灭霸查询前端</figcaption></figure><p id="4afb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这与灭霸的查询用户界面非常相似。但是支持查询拆分和查询缓存等功能。</p><p id="a994" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> d)灭霸商场入口(灭霸商场)</strong></p><p id="c7c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">灭霸存储网关充当灭霸集群和对象存储之间的API网关。这是需要访问对象存储的组件之一。它在对象存储桶中的历史数据之上实现Store API。它在本地磁盘上保留了关于所有远程块的少量信息，并使其与桶保持同步。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="md me l"/></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">灭霸商店网关日志示例</figcaption></figure><p id="9321" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> e)灭霸压实机</strong></p><p id="99bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">众所周知，Prometheus会定期压缩数据块以提高查询效率。同样，压缩器扫描存储在对象存储中的对象(如AWS S3、GCS、Azure Blob等),并在必要时应用压缩。该组件还有助于对数据进行缩减采样，以提高较大数据块的查询效率。</p><p id="2890" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，一旦压缩了对象，压缩就会运行到完成。要使其无限期运行，请确保添加标记—在运行该压实机时等待。它必须作为单例部署在存储桶上。压缩器通常需要100–300 GB的本地数据来处理本地数据。在理想情况下，50–70GB的数据就足够了，除非您的指标非常大。</p><figure class="jt ju jv jw fd jx"><div class="bz dy l di"><div class="md me l"/></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">灭霸压缩日志示例</figcaption></figure><p id="a78b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> f)灭霸尺</strong></p><p id="9a25" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">统治者根据所选择的查询API评估普罗米修斯记录和警报规则。您可以将Rule看作一个简化的Prometheus，它不需要sidecar，也不进行PromQL评估(没有QueryAPI)。</p><p id="15e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> g)灭霸接收</strong></p><p id="956a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">灭霸接收实现了普罗米修斯远程写API。灭霸边车对此是不够的，因为系统总是滞后于街区长度(通常2小时)。在此阅读更多关于灭霸接收<a class="ae jd" href="https://thanos.io/tip/components/receive.md/" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj"/></a><strong class="ih hj">。</strong></p><p id="e072" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> h)灭霸工具</strong></p><p id="0191" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">与其他灭霸组件相比，灭霸工具是提供附加功能和工具的附加工具。其中一些是</p><p id="67ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1)灭霸工具桶web:这用于从Web UI检查桶块。</p><p id="1d46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2)灭霸工具桶ls:用于列出指定桶中的所有块。</p><p id="bad3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3)灭霸工具桶复制:这用于将桶从一个对象存储复制到另一个对象存储。</p><figure class="jt ju jv jw fd jx er es paragraph-image"><div role="button" tabindex="0" class="jy jz di ka bf kb"><div class="er es mi"><img src="../Images/6fb357f49f8205efe20af9525bf7b561.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DLH2K_VvN29BQN7jLM_W8A.png"/></div></div><figcaption class="ke kf et er es kg kh bd b be z dx translated">灭霸网络存储桶查看器</figcaption></figure><p id="6f5a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些是灭霸各个组成部分的细节。在本文的<a class="ae jd" href="https://pavan1999-kumar.medium.com/deep-dive-into-thanos-part-ii-8f48b8bba132" rel="noopener"> <strong class="ih hj"> <em class="mj">第二部分</em> </strong> </a>中，我们将动手探索灭霸的各个组成部分，并将灭霸与普罗米修斯和格拉法纳结合起来。</p><h1 id="31fa" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">结论</h1><p id="a08e" class="pw-post-body-paragraph if ig hi ih b ii lg ik il im lh io ip iq lz is it iu ma iw ix iy mb ja jb jc hb bi translated">这些是灭霸存在的各种成分。在本文的<a class="ae jd" href="https://pavan1999-kumar.medium.com/deep-dive-into-thanos-part-ii-8f48b8bba132" rel="noopener"> <strong class="ih hj"> <em class="mj">第二部分</em> </strong> </a>中，我已经解释了如何设置一个HA-Prometheus，用灭霸边车将TSBD石块推到GCS桶中。我还解释了如何使用Bitnami的灭霸掌舵图安装灭霸集群。</p><p id="4512" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">直到下一次…..</p><h1 id="d77e" class="ki kj hi bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">被推荐的</h1><div class="mk ml ez fb mm mn"><a href="https://pavan1999-kumar.medium.com/deep-dive-into-thanos-part-ii-8f48b8bba132" rel="noopener follow" target="_blank"><div class="mo ab dw"><div class="mp ab mq cl cj mr"><h2 class="bd hj fi z dy ms ea eb mt ed ef hh bi translated">深入灭霸——第二部分</h2><div class="mu l"><h3 class="bd b fi z dy ms ea eb mt ed ef dx translated">使用灭霸和普罗米修斯操作员监控Kubernetes的工作负载</h3></div><div class="mv l"><p class="bd b fp z dy ms ea eb mt ed ef dx translated">pavan1999-kumar.medium.com</p></div></div><div class="mw l"><div class="mx l my mz na mw nb kc mn"/></div></div></a></div><div class="mk ml ez fb mm mn"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/autoscaling-in-kubernetes-hpa-vpa-ab61a2177950"><div class="mo ab dw"><div class="mp ab mq cl cj mr"><h2 class="bd hj fi z dy ms ea eb mt ed ef hh bi translated">Kubernetes中的自动缩放(HPA / VPA)</h2><div class="mu l"><h3 class="bd b fi z dy ms ea eb mt ed ef dx translated">使用垂直Pod自动缩放器(VPA)和水平Pod自动缩放器(HPA)在Kubernetes中自动缩放您的应用程序</h3></div><div class="mv l"><p class="bd b fp z dy ms ea eb mt ed ef dx translated">medium.com</p></div></div><div class="mw l"><div class="nc l my mz na mw nb kc mn"/></div></div></a></div><div class="mk ml ez fb mm mn"><a href="https://www.techmanyu.com/creating-self-hosted-github-runners-in-a-kubernetes-cluster-fd05560de34a" rel="noopener  ugc nofollow" target="_blank"><div class="mo ab dw"><div class="mp ab mq cl cj mr"><h2 class="bd hj fi z dy ms ea eb mt ed ef hh bi translated">在Kubernetes集群中创建自托管GitHub运行程序</h2><div class="mu l"><h3 class="bd b fi z dy ms ea eb mt ed ef dx translated">在您自己的Kubernetes集群上运行GitHub操作</h3></div><div class="mv l"><p class="bd b fp z dy ms ea eb mt ed ef dx translated">www.techmanyu.com</p></div></div><div class="mw l"><div class="nd l my mz na mw nb kc mn"/></div></div></a></div><div class="mk ml ez fb mm mn"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/creating-a-gke-cluster-with-github-actions-dd34e2de50a6"><div class="mo ab dw"><div class="mp ab mq cl cj mr"><h2 class="bd hj fi z dy ms ea eb mt ed ef hh bi translated">使用GitHub操作创建GKE集群</h2><div class="mu l"><h3 class="bd b fi z dy ms ea eb mt ed ef dx translated">使用GitHub动作自动化Kubernetes集群创建和引导</h3></div><div class="mv l"><p class="bd b fp z dy ms ea eb mt ed ef dx translated">medium.com</p></div></div><div class="mw l"><div class="ne l my mz na mw nb kc mn"/></div></div></a></div></div></div>    
</body>
</html>