<html>
<head>
<title>How to have a mirror repository on GitLab without the premium</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在 GitLab 上拥有一个镜像库而无需额外费用</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-have-a-mirror-repository-on-gitlab-without-the-premium-ee97cfb0954a?source=collection_archive---------2-----------------------#2021-05-12">https://medium.com/nerd-for-tech/how-to-have-a-mirror-repository-on-gitlab-without-the-premium-ee97cfb0954a?source=collection_archive---------2-----------------------#2021-05-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><blockquote class="if ig ih"><p id="e43a" class="ii ij ik il b im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg hb bi translated">在这篇文章中，我将解释一个想法，即有一个半镜像历史功能，而没有 GitLab 的高级版本，因为具有拉模式的镜像是高级的</p></blockquote><p id="8822" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">首先，什么是镜像存储库功能？</p><p id="026a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">例如，如果您在 GitHub 或 azure-DevOps 上有一个库，并且您希望在 GitLab 上有一个镜像，以使用 GitLab CI/CD 特性或有一个备份库等等。GitLab 提供了带有拉/推模式的镜像库特性，但只有推是免费的，CI/CD 库也是收费的。</p><p id="936b" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我们可以做一个非常简单的步骤，通过使用以下步骤编写 GitLab 管道来模拟该功能</p><ul class=""><li id="260a" class="jk jl hi il b im in iq ir jh jm ji jn jj jo jg jp jq jr js bi translated">创建一个新的空 GitLab 项目</li><li id="bac9" class="jk jl hi il b im jt iq ju jh jv ji jw jj jx jg jp jq jr js bi translated">添加新的。gitlab-ci.yml (GitLab CI)包含以下内容</li></ul><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="17e4" class="kh ki hi kd b fi kj kk l kl km">stages:<br/>- mirror-from-external<br/>mirror-from-external:<br/>stage: mirror-from-external<br/>image: ubuntu:18.04<br/>before_script:<br/>- apt-get update -y &amp;&amp; apt-get install openssh-client -y<br/>- apt install git -y<br/>- eval $(ssh-agent -s)<br/>- echo "$GIT_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -<br/>- mkdir -p ~/.ssh<br/>- chmod 700 ~/.ssh<br/>- ssh-keyscan $GIT_LAB_HOST &gt;&gt; ~/.ssh/known_hosts<br/>- chmod 644 ~/.ssh/known_hosts<br/>- git config --global user.name "${GIT_USER_NAME}"<br/>- git config --global user.email "${GIT_USER_EMAIL}"<br/>- ssh "git@$GIT_LAB_HOST"<br/>script:<br/>- echo $SOURCE_REPOSITORY<br/>- git clone --mirror $SOURCE_REPOSITORY Your_Repo_folder_name<br/>- cd Your_Repo_folder_name<br/>- git remote remove origin<br/>- git remote add origin $DESTINATION_REPOSITORY<br/>- git push --prune --all<br/>- git push --prune --tags<br/>only:<br/>- branches</span></pre><p id="b278" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">解释:</p><p id="f0e4" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我们只需使用带有 ssh 和 git 的 ubuntu 映像，然后从源库克隆并删除远程源，然后添加 GitLab 库作为远程源，然后使用 prune 推送所有和标签，以删除已删除的分支和标签</p><p id="679a" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">现在我们有了自己的管道，每次触发时，这个管道都会从源代码库到 GitLab 库获取一个快照。</p><p id="c442" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">您可以添加一个 CI 计划程序来自动触发管道，只需转到 CI/CD 并选择 schedule 选项，然后创建一个新的计划。</p><p id="5c87" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">此外，您可以在本地机器的源存储库中添加一个 git 挂钩，通过使用 GitLab API 来触发源存储库上的每次推送</p><ul class=""><li id="0982" class="jk jl hi il b im in iq ir jh jm ji jn jj jo jg jp jq jr js bi translated">转到设置&gt; &gt; CI/CD，并在最后展开管道触发器折叠，然后单击添加触发器</li></ul><figure class="jy jz ka kb fd ko er es paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="er es kn"><img src="../Images/52b9cc4026e359789398244a85664e82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qsm1EeNFPjM6DGLSXsn3ug.png"/></div></div></figure><p id="da20" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">然后我们有一个 API 来触发我们的管道</p><ul class=""><li id="e7dd" class="jk jl hi il b im in iq ir jh jm ji jn jj jo jg jp jq jr js bi translated">去你的。git\hooks 在您的开发机器上的源存储库路径上，创建一个名为“pre-push”的新钩子文件，其内容如下</li></ul><pre class="jy jz ka kb fd kc kd ke kf aw kg bi"><span id="d439" class="kh ki hi kd b fi kj kk l kl km">#!/bin/sh<br/>curl -X POST -F token=84accae6178539643a7177de83d552 -F ref=master <a class="ae kv" href="https://your-git-lab-url/api/v4/projects/{projectID}/trigger/pipeline" rel="noopener ugc nofollow" target="_blank">https://your-git-lab-url/api/v4/projects/{projectID}/trigger/pipeline</a></span></pre><p id="a153" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">就像触发器上解释的那样，用您的 API URL 替换 URL</p><p id="8ec7" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">之后，每个 git push 命令将触发镜像管道工作，从源存储库到 GitLab 存储库获取快照，如此而已。</p><p id="1951" class="pw-post-body-paragraph ii ij hi il b im in io ip iq ir is it jh iv iw ix ji iz ja jb jj jd je jf jg hb bi translated">我希望我帮助了你，谢谢。</p></div></div>    
</body>
</html>