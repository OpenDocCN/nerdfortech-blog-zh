<html>
<head>
<title>CI: Build performance testing with github action</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CI:用 github 动作构建性能测试</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/ci-build-performance-testing-with-github-action-e6b227097c83?source=collection_archive---------0-----------------------#2020-05-18">https://medium.com/nerd-for-tech/ci-build-performance-testing-with-github-action-e6b227097c83?source=collection_archive---------0-----------------------#2020-05-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/06fe5eb2fb141f2185d36e678d341481.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GGvk_pzxNmkShp3F.png"/></div></div></figure><p id="0006" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果<strong class="is hj"> DevOps </strong>和<strong class="is hj"> CI/CD </strong>已经在你的公司完全采用，我相信你已经有一些自动化测试，但是你测试你的<strong class="is hj">性能</strong>吗？如果没有，您应该考虑在您的发布系列中添加性能测试。</p><p id="58a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我将展示我如何使用<strong class="is hj"> GitHub action </strong>在我的一个 npm 库上测试性能。它提供了检查您是否有性能退化的工具。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h1 id="a044" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">编写性能测试</h1><p id="623a" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">可以想象，第一件事就是写性能测试。<br/>因为我在这个库上使用了 typescript，所以我使用了<a class="ae ky" href="https://benchmarkjs.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> benchmarkjs </strong> </a>框架来编写它。</p><p id="a246" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一个基本的性能测试将如下所示:</p><pre class="kz la lb lc fd ld le lf lg aw lh bi"><span id="0a58" class="li jw hi le b fi lj lk l ll lm"><strong class="le hj">import</strong> Benchmark = <strong class="le hj">require</strong>('benchmark');</span><span id="e569" class="li jw hi le b fi ln lk l ll lm"><strong class="le hj">const</strong> suite = <strong class="le hj">new</strong> Benchmark.Suite;<br/><strong class="le hj">suite</strong><br/>    .<strong class="le hj">add</strong>('some test case', () =&gt; {<br/>        <em class="lo">// here call the code you want to test.</em><br/>    })<br/>    .<strong class="le hj">on</strong>('cycle', event =&gt; {<br/>        <em class="lo">// Output benchmark result by converting benchmark result to string</em><br/>        <strong class="le hj">console.log(String(event.target));</strong><br/>    })<br/>    .<strong class="le hj">run</strong>();</span></pre><p id="0fef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您没有使用 Typescript/Javascript，请注意 GitHub 动作与以下内容兼容:</p><ul class=""><li id="4d6e" class="lp lq hi is b it iu ix iy jb lr jf ls jj lt jn lu lv lw lx bi translated"><code class="du ly lz ma le b"><a class="ae ky" href="https://doc.rust-lang.org/cargo/commands/cargo-bench.html" rel="noopener ugc nofollow" target="_blank">cargo bench</a></code>对于 Rust 项目</li><li id="b636" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn lu lv lw lx bi translated"><code class="du ly lz ma le b">go test -bench</code>对于 Go 项目</li><li id="a928" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn lu lv lw lx bi translated">用于 JavaScript/TypeScript 项目的<a class="ae ky" href="https://benchmarkjs.com/" rel="noopener ugc nofollow" target="_blank"> benchmark.js </a></li><li id="f07c" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn lu lv lw lx bi translated"><a class="ae ky" href="https://pypi.org/project/pytest-benchmark/" rel="noopener ugc nofollow" target="_blank">py test-用<a class="ae ky" href="https://pypi.org/project/pytest/" rel="noopener ugc nofollow" target="_blank"> pytest </a>对 Python 项目进行基准测试</a></li><li id="e6fb" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn lu lv lw lx bi translated">用于 C++项目的谷歌基准框架</li><li id="9b9a" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn lu lv lw lx bi translated">对于 C++项目来说</li></ul><h2 id="76f1" class="li jw hi bd jx mg mh mi kb mj mk ml kf jb mm mn kj jf mo mp kn jj mq mr kr ms bi translated">为什么要使用基准库</h2><p id="e5e6" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">因为在代码中实现它总是一个噩梦，所以这些库运行相同的代码 X 次，以确保在最后有更多相关的统计数据。</p></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h1 id="6c0b" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">设置您的 GitHub 操作</h1><p id="ffd2" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">GitHub 动作是<strong class="is hj">连续基准</strong>，在<a class="ae ky" href="https://github.com/marketplace/actions/continuous-benchmark" rel="noopener ugc nofollow" target="_blank"> GitHub 动作市场</a>有售。</p><p id="0c1b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">这个 GitHub 有什么作用？</strong></p><ol class=""><li id="dcb7" class="lp lq hi is b it iu ix iy jb lr jf ls jj lt jn mt lv lw lx bi translated">它运行您的性能测试</li><li id="4991" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn mt lv lw lx bi translated">它将结果存储在您的 gh 页面中。</li><li id="2439" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn mt lv lw lx bi translated">它将其与最后的结果进行比较。</li><li id="d286" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn mt lv lw lx bi translated">如果达到了性能阈值，它会对您的提交进行注释。</li></ol></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h2 id="3fe0" class="li jw hi bd jx mg mh mi kb mj mk ml kf jb mm mn kj jf mo mp kn jj mq mr kr ms bi translated">1.创建您的<code class="du ly lz ma le b">gh-pages</code>分公司</h2><p id="d5ac" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">首先，如果您还没有为 GitHub 页面创建分支，那么您需要为它创建一个分支。这用于显示您的仪表板。</p><pre class="kz la lb lc fd ld le lf lg aw lh bi"><span id="ebdd" class="li jw hi le b fi lj lk l ll lm"><em class="lo"># Create a local branch</em><br/>$ <strong class="le hj">git checkout --orphan gh-pages</strong><br/><em class="lo"># Push it to create a remote branch</em><br/>$ <strong class="le hj">git push origin gh-pages:gh-pages</strong></span></pre><p id="fef1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">不要忘记在这个分支上激活这个项目的 GitHub 页面。为此，你应该去你的项目设置。</p><figure class="kz la lb lc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/cccf99858ef0b74c54162504754744bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*krLgjVnLnnpNQZv5kVZATg.png"/></div></div></figure><h2 id="57fa" class="li jw hi bd jx mg mh mi kb mj mk ml kf jb mm mn kj jf mo mp kn jj mq mr kr ms bi translated">2.创建 GitHub 个人访问令牌</h2><p id="2b50" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">您应该<a class="ae ky" href="https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line" rel="noopener ugc nofollow" target="_blank">创建 GitHub 个人访问令牌</a>和作用域<code class="du ly lz ma le b">repo</code>，我们用它来推动<code class="du ly lz ma le b">gh-pages</code>分支。</p><p id="e662" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当它被展示的时候不要忘记拷贝它😉。</p><h2 id="72e5" class="li jw hi bd jx mg mh mi kb mj mk ml kf jb mm mn kj jf mo mp kn jj mq mr kr ms bi translated">3.创建您的工作流程</h2><p id="8ee7" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">在你的项目中创建一个文件<code class="du ly lz ma le b">.github/workflow/benchmark.yml</code>。</p><p id="1ef9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该文件应该包含如下内容:</p><pre class="kz la lb lc fd ld le lf lg aw lh bi"><span id="351f" class="li jw hi le b fi lj lk l ll lm">name: Benchmark<br/><strong class="le hj">on:<br/>  push:<br/>    branches:<br/>      - master</strong><br/><br/>jobs:<br/>  benchmark:<br/>    name: Check performance regeression.<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - uses: actions/checkout@v2<br/>      - uses: actions/setup-node@v1<br/>      - name: Run benchmark<br/><strong class="le hj">        run: npm install &amp;&amp; npm run bench | tee output.txt</strong><br/>      - name: Store benchmark result<br/>        uses: rhysd/github-action-benchmark@v1<br/>        with:<br/>          name: Benchmark.js Benchmark<br/>          tool: 'benchmarkjs'<br/>          output-file-path: output.txt<em class="lo"><br/>          </em>github-token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}<br/>          auto-push: true<em class="lo"><br/></em><strong class="le hj"><em class="lo">          </em>alert-threshold: '130%'</strong><br/>          comment-on-alert: true<br/>          fail-on-alert: true<br/><strong class="le hj">          alert-comment-cc-users: '@thomaspoignant'</strong></span></pre><p id="13e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">该文件中的重要内容有:</strong></p><ul class=""><li id="843a" class="lp lq hi is b it iu ix iy jb lr jf ls jj lt jn lu lv lw lx bi translated"><code class="du ly lz ma le b"><strong class="is hj">on</strong></code>部分，如你所见，我们只检查了<code class="du ly lz ma le b">master</code>分公司的绩效。我们这样做是为了在最后有一个可理解的图，如果我们在多个 branch/pull 请求上这样做，结果将是混乱的。</li><li id="a7f8" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn lu lv lw lx bi translated"><code class="du ly lz ma le b"><strong class="is hj">run</strong></code> part 是执行工作台并将结果输出到文件中的命令。</li><li id="dfed" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn lu lv lw lx bi translated"><code class="du ly lz ma le b"><strong class="is hj">alert-threshold</strong></code> <strong class="is hj">，</strong>这是在性能下降时评论您提交的阈值。</li><li id="fc83" class="lp lq hi is b it mb ix mc jb md jf me jj mf jn lu lv lw lx bi translated"><code class="du ly lz ma le b"><strong class="is hj">alert-comment-cc-users</strong></code> <strong class="is hj">，</strong>每次有 commit 上的注释，它也会 ping 这个用户。</li></ul><h2 id="b280" class="li jw hi bd jx mg mh mi kb mj mk ml kf jb mm mn kj jf mo mp kn jj mq mr kr ms bi translated">4.它看起来怎么样</h2><p id="0096" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">第一次工作流运行后，您将在<code class="du ly lz ma le b">https://you.github.io/repo/dev/bench</code> <a class="ae ky" href="https://rhysd.github.io/github-action-benchmark/dev/bench/" rel="noopener ugc nofollow" target="_blank">上获得第一个结果，如下图</a>。</p><figure class="kz la lb lc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mv"><img src="../Images/6a871c630c14b0458cfdf7058452ba61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vn6oIqCjyPj1hNfW90xFmA.png"/></div></div></figure><p id="0fac" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果达到阈值，您将在提交中直接看到一条注释，如下所示:</p><figure class="kz la lb lc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/f352de097170e5e65d292015d9ec2b9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rObpTbdkpH2PlH03"/></div></div></figure></div><div class="ab cl jo jp gp jq" role="separator"><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt ju"/><span class="jr bw bk js jt"/></div><div class="hb hc hd he hf"><h1 id="6027" class="jv jw hi bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">结论</h1><p id="1658" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb kv jd je jf kw jh ji jj kx jl jm jn hb bi translated">我使用这个系统来检测库的性能问题，以测试基本的算法回归。但是您可以使用它来调用 HTTP 端点，或者执行您想要测试和监控的更复杂的逻辑。</p><p id="5f7b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">尽可能多地添加性能测试。这将有助于你和你的团队拥有一个更好的产品，并且在一个版本发布后能快速检测出某个东西是否花费了比平常更长的时间。</p></div></div>    
</body>
</html>