<html>
<head>
<title>How to Plot Timeseries Data in Python and Plotly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Python和Plotly绘制时间序列数据</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-plot-timeseries-data-in-python-and-plotly-1382d205cc2?source=collection_archive---------0-----------------------#2021-02-28">https://medium.com/nerd-for-tech/how-to-plot-timeseries-data-in-python-and-plotly-1382d205cc2?source=collection_archive---------0-----------------------#2021-02-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="336d" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">这是一个关于用Python处理时间序列数据的简单教程，从提取日期和其他数据到将它们绘制成图表。</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/45eab285e6c149289ff9a1da4cd6676e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iDGMQrCfOciDK3ikdllcSw.jpeg"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">图片由<a class="ae jn" href="https://www.pexels.com/@burst" rel="noopener ugc nofollow" target="_blank">爆</a>发自【Pexels.com】T2</figcaption></figure><p id="ae06" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi kk translated">处理时间序列数据可能有点棘手。当我第一次不得不用Python处理时间序列数据并将它们放入图表时，我真的很沮丧。我可能花了一整天的时间试图找出如何从一系列时间戳数据中提取日期或月份，到最后，我仍然不明白很多事情。</p><p id="7033" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后当我不得不使用像<a class="ae jn" href="https://matplotlib.org/stable/index.html" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> matplotlib </strong> </a>或<a class="ae jn" href="https://plotly.com/python/" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> plotly </strong> </a> <strong class="jq hj">，</strong>这样的库将这些数据转换成图表时，这只会给我增加更多的困惑。幸运的是，现在我终于学会了如何解决这些问题。</p><p id="7802" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我将向你们展示一些我最近学到的代码。希望我未来的自己或任何寻找时间序列可视化线索的人会发现这很有帮助。</p><h1 id="e2e2" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated">数据</h1><p id="5aa6" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">我不想在我们的例子中使用虚拟数据，所以我将使用真实数据。我收集了从2020年1月1日到2021年1月31日(13个月的数据)所有包含单词<strong class="jq hj">“malio boro”</strong>的推文。</p><p id="2c53" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Malioboro是日惹的一条街道，我在这个城市生活了两年，它被认为是这个城市最大的旅游景点。它不仅为当地游客所知，也为国际游客所知(至少在新冠肺炎疫情之前，这个地方曾被来自世界各国的游客所包围)。因此，我认为它必须每天在Twitter上被提及。</p><p id="34b1" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我使用了一个名为<a class="ae jn" href="https://github.com/twintproject/twint/" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hj"> Twint </strong> </a>的库来收集来自Twitter的数据。你可以在这里下载<a class="ae jn" href="https://github.com/catris25/timeline-plotly-examples/blob/master/data/keyword-malioboro.json" rel="noopener ugc nofollow" target="_blank">数据</a> (JSON格式)并在我的Github页面上查看<a class="ae jn" href="https://github.com/catris25/timeline-plotly-examples/blob/master/get%20data%20using%20twint.ipynb" rel="noopener ugc nofollow" target="_blank">我用来收集数据的代码</a>。但是，您可以使用您拥有的任何数据(只要其中包含日期)来遵循本教程。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lq"><img src="../Images/14dd1d8c08c46c7d62e07efce23a52ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JMxsagwLa-Ng6Ai7"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">马利奥博罗街的人们。(照片由<a class="ae jn" href="https://unsplash.com/@arialqadri22?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> arialqadri </a>拍摄——在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上)</figcaption></figure><h1 id="6b27" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated">加载数据</h1><p id="c6a3" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">让我们从导入一些重要的包和数据本身开始。</p><p id="7027" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">由于收集的数据是JSON格式的，我需要让Python逐行读取它们，并将其转换为pandas数据帧格式。</p><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="1658" class="lw ku hi ls b fi lx ly l lz ma">import pandas as pd<br/>import json</span><span id="9109" class="lw ku hi ls b fi mb ly l lz ma">tweets = []<br/>for line in open('data/keyword-malioboro.json', 'r', encoding='UTF-8'):<br/>    tweets.append(json.loads(line))<br/>df = pd.json_normalize(tweets)<br/>len(df)</span></pre><p id="bd60" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">总共收集了88035条推文。</p><p id="d4e7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">对于一年之久的数据来说，相当牛逼吧？马利奥博罗确实是个有名的地方，不然推特也不会说这个了。</p><h1 id="8259" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated">提取日期</h1><p id="285f" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">时间数据还没有标准格式。如果你看下面的图片，你会看到它后面有时区名称。我的笔记本电脑的时区设置为GMT+07(曼谷/雅加达，东南亚)，Twint可能也遵循了这种格式。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mc"><img src="../Images/681898b593da4932d9b31f1d7d723476.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*EKD_ALCsrVxlW9f_2Zr0Aw.png"/></div></figure><p id="f4d5" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">根据您笔记本电脑上设置的时区，您可能会看到类似的情况。我们将删除这些子字符串，只将日期时间存储到一个新的<code class="du md me mf ls b">created</code>列中。</p><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="f6c7" class="lw ku hi ls b fi lx ly l lz ma">from dateutil.parser import parse</span><span id="3ac8" class="lw ku hi ls b fi mb ly l lz ma">df['created'] = [x.replace(" SE Asia Standard Time", "") for x in df['created_at']]</span></pre><p id="ac8f" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们已经将日期时间数据存储在了<code class="du md me mf ls b">created</code>列中。然而，由于我们只需要日期和月份数据，我们将使用下面的代码解析这些数据。</p><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="30be" class="lw ku hi ls b fi lx ly l lz ma">df['date'] = [parse(date).date() for date in df['created']]<br/>df['monthyear'] = pd.to_datetime(df['date']).dt.to_period('M')</span></pre><p id="75d7" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">为了绘制数据，我们需要每个时间单位(月或天)的推文数量。</p><h1 id="f6bc" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated">按月绘图</h1><p id="1669" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">首先，我们将按月绘制数据。为此，我们制作了一个新的数据框架，由每个月及其各自的推文数量组成。</p><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="da4d" class="lw ku hi ls b fi lx ly l lz ma">by_month = pd.to_datetime(df['date']).dt.to_period('M').value_counts().sort_index()<br/>by_month.index = pd.PeriodIndex(by_month.index)</span><span id="2de6" class="lw ku hi ls b fi mb ly l lz ma">df_month = by_month.rename_axis('month').reset_index(name='counts')<br/>df_month</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mg"><img src="../Images/873fadbe0a21a5787d0771fe0c898963.png" data-original-src="https://miro.medium.com/v2/resize:fit:466/format:webp/1*GzY6YlndAHCMhLPJTg__yQ.png"/></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">从2020年1月到2021年1月有13个月。</figcaption></figure><p id="69de" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这些数据现在可以绘制出来了。</p><h2 id="8cb1" class="lw ku hi bd kv mh mi mj kz mk ml mm ld jx mn mo lf kb mp mq lh kf mr ms lj mt bi translated">在折线图中按月绘制</h2><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="bb08" class="lw ku hi ls b fi lx ly l lz ma">import plotly.express as px<br/>import plotly.graph_objs as go</span><span id="4b5b" class="lw ku hi ls b fi mb ly l lz ma">fig = go.Figure(data=go.Scatter(x=df_month['month'].astype(dtype=str), <br/>                        y=df_month['counts'],<br/>                        marker_color='indianred', text="counts"))</span><span id="9572" class="lw ku hi ls b fi mb ly l lz ma">fig.update_layout({"title": 'Tweets about Malioboro from Jan 2020 to Jan 2021',<br/>                   "xaxis": {"title":"Months"},<br/>                   "yaxis": {"title":"Total tweets"},<br/>                   "showlegend": False})<br/>fig.write_image("by-month.png",format="png", width=1000, height=600, scale=3)<br/>fig.show()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mu"><img src="../Images/69839eee9cf9bf7fff749d5542905465.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GGc6P7uzz8NhrflOjaHClQ.png"/></div></div></figure><h2 id="a5b2" class="lw ku hi bd kv mh mi mj kz mk ml mm ld jx mn mo lf kb mp mq lh kf mr ms lj mt bi translated">在条形图中按月绘制</h2><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="9b09" class="lw ku hi ls b fi lx ly l lz ma">fig = go.Figure(data=go.Bar(x=df_month['month'].astype(dtype=str), <br/>                        y=df_month['counts'],<br/>                        marker_color='indianred', text="counts"))</span><span id="0a11" class="lw ku hi ls b fi mb ly l lz ma">fig.update_layout({"title": 'Tweets about Malioboro from Jan 2020 to Jan 2021',<br/>                   "xaxis": {"title":"Months"},<br/>                   "yaxis": {"title":"Total tweets"},<br/>                   "showlegend": False})<br/><br/>fig.show()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mu"><img src="../Images/5133b0483c6c76ea6255e36f55ae2ed2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yz9IRS4Z62LNlFDUSyPAbw.png"/></div></div></figure><h1 id="7f51" class="kt ku hi bd kv kw kx ky kz la lb lc ld io le ip lf ir lg is lh iu li iv lj lk bi translated">白天绘图</h1><p id="214a" class="pw-post-body-paragraph jo jp hi jq b jr ll ij jt ju lm im jw jx ln jz ka kb lo kd ke kf lp kh ki kj hb bi translated">你也可以做一个更详细的图表，显示每天的趋势，但是我不建议你做更长时间的数据(比如说，三年或更长时间)，因为这些线会变得很混乱，很难读懂。</p><p id="6421" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我们通过创建一个数据框架来存储每天的推文数量。</p><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="7343" class="lw ku hi ls b fi lx ly l lz ma">by_date = pd.Series(df['date']).value_counts().sort_index()<br/>by_date.index = pd.DatetimeIndex(by_date.index)</span><span id="032f" class="lw ku hi ls b fi mb ly l lz ma">df_date = by_date.rename_axis('date').reset_index(name='counts')<br/>df_date</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mv"><img src="../Images/1c143821b525f55262753998c20d8858.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/format:webp/1*ETuKw7WiP041CzsJMnh3fw.png"/></div></figure><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="53ea" class="lw ku hi ls b fi lx ly l lz ma">fig = go.Figure(data=go.Scatter(x=df_date['date'].astype(dtype=str), <br/>                                y=df_date['counts'],<br/>                                marker_color='black', text="counts"))</span><span id="1afd" class="lw ku hi ls b fi mb ly l lz ma">fig.update_layout({"title": 'Tweets about Malioboro from Jan 2020 to Jan 2021 Day by Day',<br/>                   "xaxis": {"title":"Time"},<br/>                   "yaxis": {"title":"Total tweets"},<br/>                   "showlegend": False})</span><span id="8613" class="lw ku hi ls b fi mb ly l lz ma">fig.show()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mw"><img src="../Images/eebd1e80d3c2bef7327cb08160990e16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6zbd4SZNm3ZVUy_xWmTH7w.png"/></div></div></figure><p id="2b91" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这个图表看起来非常有趣，因为现在你可以看到特定日期的峰值。在那些日子里，一定发生了什么重要的事情，导致Twitter比往常更多地谈论Malioboro。</p><p id="b215" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">我将突出这些重要的日期，用一些点来表示它们在数据中的重要性。</p><p id="7424" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在这里，我将获取前三个峰值日期，并将它们存储在一个数据框中。</p><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="2d53" class="lw ku hi ls b fi lx ly l lz ma">top_dates = df_date.sort_values(by=['counts'],ascending=False).head(3)<br/>vals = []<br/>for tgl, tot in zip(top_dates["date"], top_dates["counts"]):<br/>    tgl = tgl.strftime("%d %B")<br/>    val = "%d (%s)"%(tot, tgl)<br/>    vals.append(val)<br/>top_dates['tgl'] = vals<br/>top_dates</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es mx"><img src="../Images/c762b8e3c3d93853b0d4410932fd6864.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*8y9fZNhhAVAs99_-bfbC9g.png"/></div></figure><p id="f749" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后我用这个数据框在图表上做笔记。它与我们之前制作的图表非常相似，但它有一些点突出了这些日期。</p><pre class="iy iz ja jb fd lr ls lt lu aw lv bi"><span id="a059" class="lw ku hi ls b fi lx ly l lz ma">fig = go.Figure(data=go.Scatter(x=df_date['date'].astype(dtype=str), <br/>                                y=df_date['counts'],<br/>                                marker_color='black', text="counts"))</span><span id="8587" class="lw ku hi ls b fi mb ly l lz ma">fig.update_layout({"title": 'Tweets about Malioboro from Jan 2020 to Jan 2021 Day by Day',<br/>                   "xaxis": {"title":"Time"},<br/>                   "yaxis": {"title":"Total tweets"},<br/>                   "showlegend": False})<br/>fig.add_traces(go.Scatter(x=top_dates['date'], y=top_dates['counts'],<br/>                          textposition='top left',<br/>                          textfont=dict(color='#233a77'),<br/>                          mode='markers+text',<br/>                          marker=dict(color='red', size=6),<br/>                          text = top_dates["tgl"]))<br/>fig.show()</span></pre><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mw"><img src="../Images/d514cc55011ae2c53016d8c8ea9abb14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_tPRpjMmQGCxXPfkz3pzbw.png"/></div></div></figure><p id="1dca" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">您可以将点上显示的文本更改为您想要的任何文本，例如，您可以使用它来写下一些关于导致峰值点的事件的注释。</p><p id="d26a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这些图表很有趣，但是如果没有一个故事来伴随它们，读者不会得到很多线索。</p><p id="12ed" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在我的例子中，10月4日和10月8日成为图表中的顶点，因为在这两天马里奥博罗发生了大规模的示威游行。Twitter用户很快更新了导致Malioboro一词流行并成为新闻话题的情况。</p><p id="df4c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">12月31日出现了另一个高峰，因为尽管日惹的新冠肺炎病例不断增加，T2地方政府决定在新年前夕不封锁或限制马利奥博罗。推特上的用户立即加入了争论，在推特上发表了他们的观点。</p><p id="9708" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这些图表和背景有望创造出某种关于我们数据的故事。</p></div><div class="ab cl my mz gp na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hb hc hd he hf"><p id="845d" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">简而言之，使用Plotly绘制时间序列数据实际上非常简单明了。如果你仍然觉得有些事情令人困惑，没关系，你不必第一次就把所有东西都弄懂，因为有时需要一些时间来适应。</p><p id="cb41" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">希望你觉得这个教程很容易理解，否则请给我一些建议！</p></div><div class="ab cl my mz gp na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="hb hc hd he hf"><p id="694e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">你可以在下面我的Github库中查看我在本文中使用的全部代码。感谢阅读！</p><div class="nf ng ez fb nh ni"><a href="https://github.com/catris25/timeline-plotly-examples" rel="noopener  ugc nofollow" target="_blank"><div class="nj ab dw"><div class="nk ab nl cl cj nm"><h2 class="bd hj fi z dy nn ea eb no ed ef hh bi translated">catris 25/timeline-plotly-示例</h2><div class="np l"><h3 class="bd b fi z dy nn ea eb no ed ef dx translated">通过在GitHub上创建一个帐户，为catris 25/timeline-plot ly-examples开发做出贡献。</h3></div><div class="nq l"><p class="bd b fp z dy nn ea eb no ed ef dx translated">github.com</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw jh ni"/></div></div></a></div></div></div>    
</body>
</html>