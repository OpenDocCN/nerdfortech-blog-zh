<html>
<head>
<title>Direktiv: building a machine on AWS using Terraform WITHOUT a Terraform environment? (part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Direktiv:在没有 Terraform 环境的情况下使用 Terraform 在 AWS 上构建机器？(第一部分)</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/direktiv-building-a-machine-on-aws-using-terraform-without-a-terraform-environment-def24fe3221d?source=collection_archive---------6-----------------------#2021-07-07">https://medium.com/nerd-for-tech/direktiv-building-a-machine-on-aws-using-terraform-without-a-terraform-environment-def24fe3221d?source=collection_archive---------6-----------------------#2021-07-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/48beb69888a5d2766ca0f14e8a4c282a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4uodOQlOaXGn9J888QnCOg.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">Terraform 和 Direktiv 携手合作</figcaption></figure><blockquote class="iu iv iw"><p id="6763" class="ix iy iz ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">第一个问题是怎么做？</p></blockquote><p id="6987" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">Direktiv 是一个无服务器的工作流引擎，<strong class="ja hj">*技术上* </strong>意味着它按需旋转容器(使用 Kubernetes 和 Knative)并按照您定义的顺序关闭它们(工作流)。所以在 Terraform(或 Ansible，在另一篇文章中展示)的情况下，我们只是将提供者软件的最新版本作为一个容器！</p><blockquote class="iu iv iw"><p id="8e4c" class="ix iy iz ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">第二个问题是为什么？</p></blockquote><ol class=""><li id="f6af" class="jz ka hi ja b jb jc jf jg jw kb jx kc jy kd jv ke kf kg kh bi translated">Terraform 和 Ansible 是基础设施供应和管理的优秀解决方案，拥有大量插件和扩展。为什么我们要尝试重新发明轮子——尤其是如果你考虑到两者都被广泛采用的话。Direktiv 使用已经为这两种产品构建的插件、扩展和剧本，并将其扩展到我们提供的更广泛的微服务工作流架构中</li><li id="4880" class="jz ka hi ja b jb ki jf kj jw kk jx kl jy km jv ke kf kg kh bi translated">您可以获得这两种环境，而无需安装或维护它们(或持续运行它们的资源成本)。如果你不想使用我们提供的版本的<a class="ae kn" href="https://github.com/vorteil/direktiv-apps/tree/master/terraform" rel="noopener ugc nofollow" target="_blank">，就用最新的(或者你觉得合适的版本)更新</a><a class="ae kn" href="https://github.com/vorteil/direktiv-apps/blob/master/terraform/Dockerfile" rel="noopener ugc nofollow" target="_blank"> Docker build </a>文件。这就是 Direktiv 工作流的短暂本质！</li></ol><blockquote class="iu iv iw"><p id="8f44" class="ix iy iz ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">顺便说一下，这同样适用于<a class="ae kn" href="https://github.com/vorteil/direktiv-apps/tree/master/ansible" rel="noopener ugc nofollow" target="_blank"> Ansible 插件</a>和<a class="ae kn" href="https://github.com/vorteil/direktiv-apps/blob/master/ansible/Dockerfile" rel="noopener ugc nofollow" target="_blank"> Docker 构建文件</a>。</p><p id="9441" class="ix iy iz ja b jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv hb bi translated">你自己也可以这么做！安装<a class="ae kn" href="https://docs.direktiv.io/docs/development.html" rel="noopener ugc nofollow" target="_blank">多功能一体机</a>并配合使用！！</p></blockquote><h1 id="2454" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">Terraform 脚本</h1><p id="6678" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jw lo jl jm jx lp jp jq jy lq jt ju jv hb bi translated">在这篇文章中，我们将看到一个地形脚本的实现。首先，我们将使用下面的 Terraform 脚本为 Amazon Web Services 提供一个虚拟机(Linux ):</p><figure class="lr ls lt lu fd ij"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">用于将 Linux 机器部署到 AWS 的 Terraform 脚本</figcaption></figure><p id="be46" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated"><strong class="ja hj">注:此处</strong> 为 GCP 和天蓝色 <a class="ae kn" href="https://github.com/vorteil/terraform-examples" rel="noopener ugc nofollow" target="_blank"> <strong class="ja hj">的例子</strong></a></p><p id="24c7" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">上面的 Terraform 脚本将把一台 Ubuntu 机器部署到一个 AWS 区域。我们将通过 Direktiv 工作流传递几个配置参数(region、secret 和 key)。</p><h1 id="d9cd" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">Direktiv 工作流程</h1><p id="589e" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jw lo jl jm jx lp jp jq jy lq jt ju jv hb bi translated">现在让我们来看看 YAML 的工作流程。我们将逐个州地分解这个工作流程。</p><figure class="lr ls lt lu fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lx"><img src="../Images/bb49f4ff0047b39c2d1defe43ac52942.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zczLrUh4pAR-GLetsIZkQw.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">各州的细目分类</figcaption></figure><h2 id="1aa3" class="ly kp hi bd kq lz ma mb ku mc md me ky jw mf mg lc jx mh mi lg jy mj mk lk ml bi translated">获取地形脚本(Git)</h2><p id="3457" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jw lo jl jm jx lp jp jq jy lq jt ju jv hb bi translated">让我们使用<a class="ae kn" href="https://github.com/vorteil/direktiv-apps/tree/master/git" rel="noopener ugc nofollow" target="_blank"> Git 插件</a>从 GitHub 获取 Terraform 脚本。让我们看看下面的工作流程摘录:</p><figure class="lr ls lt lu fd ij"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="ae1d" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">这是正在发生的事情的明细。Git 插件正在克隆我们的 Terraform 范例库。<code class="du mm mn mo mp b">git</code>命令的以下参数非常重要:</p><pre class="lr ls lt lu fd mq mp mr ms aw mt bi"><span id="0a4c" class="ly kp hi mp b fi mu mv l mw mx">$out/instance/terraform-git-var</span></pre><ul class=""><li id="e790" class="jz ka hi ja b jb jc jf jg jw kb jx kc jy kd jv my kf kg kh bi translated">该插件将 git 克隆的输出(一个 tar.gz 文件)写入一个名为<code class="du mm mn mo mp b">terraform-git-var</code>的内部 Direktiv 变量。</li><li id="40fe" class="jz ka hi ja b jb ki jf kj jw kk jx kl jy km jv my kf kg kh bi translated">参数的<code class="du mm mn mo mp b">/instance/</code>部分指示 Direktiv 在运行时只为工作流实例创建这个变量(这意味着这个值只对这个特定的工作流可用，并且只在它运行时创建——更多关于变量的信息<a class="ae kn" href="https://docs.direktiv.io/docs/walkthrough/persistent-data.html" rel="noopener ugc nofollow" target="_blank">在这里</a>)。</li></ul><p id="f728" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">实际上，我们现在有了一个完整的 Git 存储库，作为一个二进制 tar.gz 文件！</p><h2 id="315f" class="ly kp hi bd kq lz ma mb ku mc md me ky jw mf mg lc jx mh mi lg jy mj mk lk ml bi translated">运行 Terraform 脚本</h2><p id="2642" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jw lo jl jm jx lp jp jq jy lq jt ju jv hb bi translated">好的…我们开始吧！下面是调用 Terraform 的代码片段:</p><figure class="lr ls lt lu fd ij"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">运行脚本的 Terraform 片段</figcaption></figure><p id="6124" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">好了，我们有了完整的二进制存储库，其中包含了我们要在一个名为<code class="du mm mn mo mp b">terraform-git-var</code>的变量中使用的 Terraform 脚本(位于<code class="du mm mn mo mp b">/amazon</code>目录中)。</p><p id="ed4a" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">因此，为了运行 Terraform 脚本，我们定义了名为<code class="du mm mn mo mp b">tfrun</code>的函数。<code class="du mm mn mo mp b">tfrun</code>接受几个输入:</p><ul class=""><li id="1ed4" class="jz ka hi ja b jb jc jf jg jw kb jx kc jy kd jv my kf kg kh bi translated"><code class="du mm mn mo mp b">execution-folder: terraform-git-var/amazon</code>:这是一个指向 Git 存储库的位置(变量+Git 目录结构，其中有<code class="du mm mn mo mp b">main.tf</code>文件)</li><li id="ab9c" class="jz ka hi ja b jb ki jf kj jw kk jx kl jy km jv my kf kg kh bi translated"><code class="du mm mn mo mp b">action: jq(.action)</code>:动作 Terraform 需要应用于脚本，作为 JSON 输入传递，格式如下:</li></ul><pre class="lr ls lt lu fd mq mp mr ms aw mt bi"><span id="75c0" class="ly kp hi mp b fi mu mv l mw mx">{<br/>   "action": "apply"<br/>}</span></pre><ul class=""><li id="0cd0" class="jz ka hi ja b jb jc jf jg jw kb jx kc jy kd jv my kf kg kh bi translated"><code class="du mm mn mo mp b">args-on-init: ["-backend-config=address=http://localhost:8001/terraform-amazon-instance</code>:我们要求 Terraform 将脚本的状态输出传递回容器(“插件”)，并将其存储在一个名为<code class="du mm mn mo mp b">terraform-amazon-instance</code>的变量中，以便在以后的阶段或不同的工作流中使用(稍后将详细介绍)</li><li id="4322" class="jz ka hi ja b jb ki jf kj jw kk jx kl jy km jv my kf kg kh bi translated"><code class="du mm mn mo mp b">variables</code>:这些是 Terraform <code class="du mm mn mo mp b">main.tf</code>脚本使用的变量。最重要的部分是<code class="du mm mn mo mp b">state-name</code>需要匹配到<code class="du mm mn mo mp b">args-on-init</code>值的前一个值。</li></ul><p id="446e" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">现在让我们看看<code class="du mm mn mo mp b">tfrun</code>的<code class="du mm mn mo mp b">function</code>定义:</p><ul class=""><li id="1caf" class="jz ka hi ja b jb jc jf jg jw kb jx kc jy kd jv my kf kg kh bi translated"><code class="du mm mn mo mp b">image</code>:指示 Direktiv 使用<code class="du mm mn mo mp b">vorteil/terraform:v1</code>容器作为插件或扩展</li><li id="ab8d" class="jz ka hi ja b jb ki jf kj jw kk jx kl jy km jv my kf kg kh bi translated"><code class="du mm mn mo mp b">files</code>:这个申报在<a class="ae kn" href="https://docs.direktiv.io/docs/specification.html#functionfiledefinition" rel="noopener ugc nofollow" target="_blank">这里</a>记载。Direktiv 的这个特性指示函数获取被定义为<code class="du mm mn mo mp b">instance</code>作用域变量(<code class="du mm mn mo mp b">scope: instance</code>)的<code class="du mm mn mo mp b">terraform-git-var</code>变量(<code class="du mm mn mo mp b">key: terraform-git-var</code>，并将其解压缩为<code class="du mm mn mo mp b">tar.gz</code>文件类型！</li></ul><p id="8793" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">理解上述内容的重要性非常重要——这意味着变量中的文件可以作为容器的挂载和共享驱动器使用！它还允许容器的<code class="du mm mn mo mp b">execution-folder</code>参数从目录中读取<code class="du mm mn mo mp b">main.tf</code>文件。</p><h2 id="cf52" class="ly kp hi bd kq lz ma mb ku mc md me ky jw mf mg lc jx mh mi lg jy mj mk lk ml bi translated">清理并通知</h2><figure class="lr ls lt lu fd ij"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="689b" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">最后两个状态检查发送到 Terraform 脚本的<code class="du mm mn mo mp b">action</code>(或者<code class="du mm mn mo mp b">apply</code>或者<code class="du mm mn mo mp b">destroy</code>)。如果是<code class="du mm mn mo mp b">apply</code>，则发送一条与机器详细信息不一致的消息。</p><h1 id="68f4" class="ko kp hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">最终工作流程</h1><p id="3395" class="pw-post-body-paragraph ix iy hi ja b jb lm jd je jf ln jh ji jw lo jl jm jx lp jp jq jy lq jt ju jv hb bi translated">以下是工作流程的视频:</p><figure class="lr ls lt lu fd ij"><div class="bz dy l di"><div class="mz lw l"/></div></figure><p id="674a" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">这是最终的工作流程:</p><figure class="lr ls lt lu fd ij"><div class="bz dy l di"><div class="lv lw l"/></div></figure><p id="71db" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">一如既往，欢迎反馈和提问！</p><p id="c15d" class="pw-post-body-paragraph ix iy hi ja b jb jc jd je jf jg jh ji jw jk jl jm jx jo jp jq jy js jt ju jv hb bi translated">PS:有人要求看工作流的输出。以下是“应用”操作输出:</p><pre class="lr ls lt lu fd mq mp mr ms aw mt bi"><span id="775d" class="ly kp hi mp b fi mu mv l mw mx">[38;5;248m[10:31:48.257][0m Preparing workflow triggered by API. <br/>[38;5;248m[10:31:48.356][0m Running state logic -- clone-terraform-examples:1 (action) <br/>[38;5;248m[10:31:48.431][0m Sleeping until function 'git-command' returns. <br/>[38;5;248m[10:31:49.991][0m running command 0 'clone <a class="ae kn" href="https://github.com/vorteil/terraform-examples.git" rel="noopener ugc nofollow" target="_blank">https://github.com/vorteil/terraform-examples.git</a> /mnt/shared/1uxr6qlijtrPRTCPEE9nwRJ9LyO/out/instance/terraform-git-var' <br/>[38;5;248m[10:31:50.754][0m Function 'git-command' returned. <br/>[38;5;248m[10:31:50.762][0m Transitioning to next state: deploy-aws (2). <br/>[38;5;248m[10:31:50.769][0m Running state logic -- deploy-aws:2 (action) <br/>[38;5;248m[10:31:50.769][0m {<br/>  "action": "apply",<br/>  "return": {<br/>    "cmd0": {<br/>      "cmd": "clone <a class="ae kn" href="https://github.com/vorteil/terraform-examples.git" rel="noopener ugc nofollow" target="_blank">https://github.com/vorteil/terraform-examples.git</a> /mnt/shared/1uxr6qlijtrPRTCPEE9nwRJ9LyO/out/instance/terraform-git-var",<br/>      "output": "/mnt/shared/1uxr6qlijtrPRTCPEE9nwRJ9LyO/out/instance/terraform-git-var"<br/>    }<br/>  }<br/>} <br/>[38;5;248m[10:31:50.769][0m Decrypting secrets. <br/>[38;5;248m[10:31:50.782][0m Sleeping until function 'tfrun' returns. <br/>[38;5;248m[10:31:53.533][0m adding to the global map to control action ids <br/>[38;5;248m[10:31:53.628][0m Checking if tfstate service http backend is alive... <br/>[38;5;248m[10:31:53.706][0m Wait till backend service is functional <br/>[38;5;248m[10:31:53.776][0m Initializing terraform.... <br/>[38;5;248m[10:31:53.840][0m Reading in TFVars.json... <br/>[38;5;248m[10:31:53.180][0m <br/>[0m[1mInitializing the backend...[0m<br/> <br/>[38;5;248m[10:31:53.186][0m Fetching tfstate variable... <br/>[38;5;248m[10:31:53.190][0m [0m[32m<br/>Successfully configured the backend "http"! Terraform will automatically<br/>use this backend unless the backend configuration changes.[0m<br/>2021/07/07 00:31:53 [DEBUG] GET <a class="ae kn" href="http://localhost:8001/terraform-amazon-instance" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/terraform-amazon-instance</a><br/> <br/>[38;5;248m[10:31:53.214][0m <br/>[0m[1mInitializing provider plugins...[0m<br/>- Finding latest version of hashicorp/aws...<br/> <br/>[38;5;248m[10:31:54.625][0m - Installing hashicorp/aws v3.48.0...<br/> <br/>[38;5;248m[10:32:01.466][0m - Installed hashicorp/aws v3.48.0 (signed by HashiCorp)</span><span id="5458" class="ly kp hi mp b fi na mv l mw mx">Terraform has created a lock file [1m.terraform.lock.hcl[0m to record the provider<br/>selections it made above. Include this file in your version control repository<br/>so that Terraform can guarantee to make the same selections by default when<br/>you run "terraform init" in the future.[0m<br/> <br/>[38;5;248m[10:32:01.474][0m <br/>[0m[1m[32mTerraform has been successfully initialized![0m[32m[0m<br/>[0m[32m<br/>You may now begin working with Terraform. Try running "terraform plan" to see<br/>any changes that are required for your infrastructure. All Terraform commands<br/>should now work.</span><span id="624c" class="ly kp hi mp b fi na mv l mw mx">If you ever set or change modules or backend configuration for Terraform,<br/>rerun this command to reinitialize your working directory. If you forget, other<br/>commands will detect it and remind you to do so if necessary.[0m<br/> <br/>[38;5;248m[10:32:01.479][0m Executing 'apply' for terraform <br/>[38;5;248m[10:32:02.152][0m 2021/07/07 00:32:02 [DEBUG] GET <a class="ae kn" href="http://localhost:8001/terraform-amazon-instance" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/terraform-amazon-instance</a><br/> <br/>[38;5;248m[10:32:02.157][0m Fetching tfstate variable... <br/>[38;5;248m[10:32:09.194][0m [0m[1maws_instance.web: Creating...[0m[0m<br/> <br/>[38;5;248m[10:32:19.161][0m [0m[1maws_instance.web: Still creating... [10s elapsed][0m[0m<br/> <br/>[38;5;248m[10:32:21.572][0m [0m[1maws_instance.web: Creation complete after 13s [id=i-0382710118e5f441d][0m<br/> <br/>[38;5;248m[10:32:21.588][0m 2021/07/07 00:32:21 [DEBUG] POST <a class="ae kn" href="http://localhost:8001/terraform-amazon-instance" rel="noopener ugc nofollow" target="_blank">http://localhost:8001/terraform-amazon-instance</a><br/> <br/>[38;5;248m[10:32:21.592][0m Saving new tfstate variable... <br/>[38;5;248m[10:32:21.617][0m [33m╷[0m[0m<br/>[33m│[0m [0m[1m[33mWarning: [0m[0m[1mValue for undeclared variable[0m<br/>[33m│[0m [0m<br/>[33m│[0m [0m[0mThe root module does not declare a variable named "state-name" but a value<br/>[33m│[0m [0mwas found in file "terraform.tfvars.json". If you meant to use this value,<br/>[33m│[0m [0madd a "variable" block to the configuration.<br/>[33m│[0m [0m<br/>[33m│[0m [0mTo silence these warnings, use TF_VAR_... environment variables to provide<br/>[33m│[0m [0mcertain "global" settings to all configurations in your organization. To<br/>[33m│[0m [0mreduce the verbosity of these warnings, use the -compact-warnings option.<br/>[33m╵[0m[0m<br/>[0m[1m[32m<br/>Apply complete! Resources: 1 added, 0 changed, 0 destroyed.<br/>[0m[0m[1m[32m<br/>Outputs:</span><span id="f4b3" class="ly kp hi mp b fi na mv l mw mx">[0mip-address = "3.26.57.150"<br/> <br/>[38;5;248m[10:32:21.632][0m Sending output back to direktiv... <br/>[38;5;248m[10:32:22.320][0m Fetching tfstate variable... <br/>[38;5;248m[10:32:22.359][0m Fetching tfstate variable... <br/>[38;5;248m[10:32:22.385][0m Function 'tfrun' returned. <br/>[38;5;248m[10:32:22.386][0m Transforming state data. <br/>[38;5;248m[10:32:22.393][0m Transitioning to next state: check_apply_or_destroy (3). <br/>[38;5;248m[10:32:22.399][0m Running state logic -- check_apply_or_destroy:3 (switch) <br/>[38;5;248m[10:32:22.399][0m {<br/>  "action": "apply",<br/>  "amazon_ip": "3.26.57.150"<br/>} <br/>[38;5;248m[10:32:22.399][0m Switch condition 0 succeeded <br/>[38;5;248m[10:32:22.403][0m Transitioning to next state: send_message (4). <br/>[38;5;248m[10:32:22.410][0m Running state logic -- send_message:4 (action) <br/>[38;5;248m[10:32:22.410][0m Decrypting secrets. <br/>[38;5;248m[10:32:22.421][0m Sleeping until function 'discordmsg' returns. <br/>[38;5;248m[10:32:24.578][0m Function 'discordmsg' returned. <br/>[38;5;248m[10:32:24.585][0m Workflow completed.</span></pre></div></div>    
</body>
</html>