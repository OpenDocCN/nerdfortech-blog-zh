<html>
<head>
<title>Upgrading Kubernetes v1.19.0 to v1.20.0 ? |Read this first!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将 Kubernetes v1.19.0 升级到 v1.20.0？|先看这个！</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/upgrading-kubernetes-v1-19-0-to-v1-20-0-read-this-first-820656edabb7?source=collection_archive---------20-----------------------#2021-03-01">https://medium.com/nerd-for-tech/upgrading-kubernetes-v1-19-0-to-v1-20-0-read-this-first-820656edabb7?source=collection_archive---------20-----------------------#2021-03-01</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/f15bbf5b0e8ba92da65f1cefaec37cfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QLAU2yJea_l9YjXDt5c9Dg.png"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">HiFX 的 Kubernetes 咨询公司</figcaption></figure><div class=""/><p id="79fa" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Kubernetes 是一个开源的可扩展平台，用于管理容器化的工作负载和服务，以其服务发现、负载平衡、存储系统的自动安装、自动推出以及 bin 打包、自我修复和敏感配置管理而闻名。</p><p id="d7a4" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在使用容器引擎创建新的 Kubernetes 集群时，将在控制平面节点和工作者节点上运行的 Kubernetes 的版本是已知的。Kubernetes 版本通常表示为 x.y.z，其中 x 表示主版本，y 表示次版本，z 表示补丁版本。Kubernetes 最新的次要版本是 v1.20，这是 2020 年的第三个也是最后一个版本，提供大约一年的补丁支持；并且可以从<a class="ae js" href="https://dl.k8s.io/v1.20.0/kubernetes.tar.gz" rel="noopener ugc nofollow" target="_blank">kubernetes.tar.gz</a>、<a class="ae js" href="https://dl.k8s.io/v1.20.0/kubernetes.tar.gz" rel="noopener ugc nofollow" target="_blank">kubernetes-src.tar.gz</a>和<a class="ae js" href="https://github.com/kubernetes/kubernetes" rel="noopener ugc nofollow" target="_blank"> GitHub </a>下载。<em class="jt">此外，该版本整合了 44 项增强功能，其中 11 项已经稳定，15 项正在进入 beta 版，16 项正在进入 alpha 版。</em></p><h1 id="7b39" class="ju jv hx bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">升级到 1.20 版时的主要主题和变化</h1><p id="9df8" class="pw-post-body-paragraph iu iv hx iw b ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn kw jp jq jr hb bi translated">自 1.19 版以来，1.20 版的主要变化如下:</p><p id="7b33" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">Docker shim 的弃用或过时</strong>:Docker 的容器运行时接口(CRI)Docker shim 已经弃用。但是，docker 生成的映像将在您的集群中继续工作，保持 CRI 兼容运行时。此外，应该确保工作节点使用受支持的容器运行时，因为对 Docker 的支持将在未来的版本中停止。服务提供商的协助将确保正确的升级规划和测试。</p><p id="0ba9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">执行探测超时</strong>的处理:影响现有 pod 定义的调试可以通过将特征门<em class="jt">execprobetime</em>设置为<em class="jt"> false </em>来处理。</p><p id="0227" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">client-go 的外部认证</strong>:当前集群通过<em class="jt"> KUBERNETES_EXEC_INFO </em>环境变量启用 client-go 凭证插件。</p><p id="3639" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">cron job 控制器 v2 通过特征门</strong>的可用性:<em class="jt"> CronJob </em>控制器，使用通知器代替轮询，在 1.20 的 alpha 版本中可用</p><p id="38c3" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">过程 ID (PID)限制</strong>的简单设置:PID 限制在<em class="jt"> SupportNodePidsLimit </em>和<em class="jt"> SupportPodPidsLimit </em>上的一般可用性(GA)的分级。</p><p id="74cc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">默认启用 API 优先级和公平性(APF) </strong>:支持<em class="jt"> kube </em> - <em class="jt"> apiserver </em>按照优先级对传入的请求进行分类。</p><p id="d812" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">重新实施 IPv4/Ipv6 双栈</strong>:根据用户和社区的反馈，支持双栈服务以及将 IPv4 和 Ipv6 服务集群 IP 地址分配给单一来源。此外，支持将服务从单 IP 栈转移到双 IP 栈，反之亦然。</p><p id="a1cc" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">优雅节点关机</strong>介绍:<em class="jt"> GracefulNodeShutdown </em>的<em class="jt"> Alpha 版本模式</em>在任何节点系统开始关机时唤醒<em class="jt"> kubelet </em>，允许 pod 在关机期间优雅地终止。</p><p id="f3b5" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在 1.20 版中观察到的主要特性是卷容器存储接口(CSI)快照操作的分级，这启动了为 Kubernetes 开发应用程序的步骤，以实现全面可用性(GA)。这确保了在每个 Kubernetes 环境以及相关存储提供商上轻松触发和整合稳定的操作。</p><p id="977d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">v1.20 的另一个值得注意的特性是首次推出了两个测试版特性，使使用 Kubernetes 的用户和管理员能够充分控制与 pod 中挂载的卷相关的权限。此外，这个版本还包括了从<em class="jt"> kubectl </em>到 beta 的升级，它直接提供了对调试工作流的支持。</p><p id="6f3b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">新版本包含了对以下调试进行故障排除的好处:</strong></p><p id="0329" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">启动时崩溃的工作负载</strong>:可以创建一个使用不同命令或映像的 pod 副本来解决相同的问题。</p><p id="662d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">分发容器</strong>:这可以通过在 pod 的新副本上添加一个带有调试工具的新容器来解决。尽管如此，也可以使用临时容器来执行。</p><p id="5338" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">受影响的节点</strong>:可以通过创建具有主机名称空间的容器以及访问主机的文件系统来执行节点上的故障排除。</p><p id="e1da" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">此外，<em class="jt"> kubectl </em>组件比<em class="jt"> kubectl </em>插件“debug”持有更高的值。因此，用户需要替换调试插件的名称。</p><p id="dc96" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy"><em class="jt">1.20 版本的其他改进包括:</em> </strong></p><p id="09fa" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Golang1.15.5 的集成</p><p id="e044" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">非递归卷所有权和权限的测试版</p><p id="a518" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">FSGroup 的 CSI 驱动程序策略的测试版</p><p id="8896" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">CSI 驱动程序中用于安全性改进的 alpha 功能</p><p id="2319" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">Pod 资源指标</p><p id="f204" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">RuntimeClass 和 API 类型的分级默认为稳定</p><p id="e750" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">token request/TokenRequestProjection 升级到 GA</p><p id="9384" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">云控制器管理器由其各自的云提供商独家提供</p><h1 id="5554" class="ju jv hx bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">从 1.19 版升级到 1.20 版的系统顺序</h1><p id="5c8d" class="pw-post-body-paragraph iu iv hx iw b ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn kw jp jq jr hb bi translated">以下先决条件以<strong class="iw hy"><em class="jt">kube</em>-<em class="jt">API server</em></strong>，<strong class="iw hy"><em class="jt">kube</em>-<em class="jt">controller</em><em class="jt">manager</em></strong>，<strong class="iw hy"><em class="jt">kube</em>-<em class="jt">scheduler</em>，</strong><strong class="iw hy"><em class="jt">cloud</em>-<em class="jt">controller</em><em class="jt">manager</em></strong>，</p><p id="4653" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy"> Kube-apiserver </strong></p><p id="659c" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在单集群实例中，<em class="jt">kube</em>-<em class="jt">API server</em>实例的当前版本应该是 v1.19。</p><p id="f58f" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">高可用性(HA)集群中的<em class="jt">kube</em>-<em class="jt">API server</em>组件可以是 v1.19 或 v1.20，以保证任何一个次要版本(即 HA 集群内)的最大偏差，而支持的最新<em class="jt"> kube-apiserver </em>是 v1.20，最旧的版本必须是 v1.19。</p><p id="3eea" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">与 API 服务器通信的<em class="jt"> kube </em> - <em class="jt">控制器</em> - <em class="jt">管理器</em>、<em class="jt"> kube </em> - <em class="jt">调度器</em>和<em class="jt">云</em> - <em class="jt">控制器</em>管理器组件必须是 v1.19，以确定它们比现有的 API 服务器版本旧。</p><p id="a170" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">kubelet 组件必须保持在 v1.18 或 v1.19，从而确保它们比现有的 API 服务器版本旧。</p><p id="7bec" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">注册的准入网页挂钩，如<em class="jt">ValidatingWebhookConfiguration</em>和<em class="jt">MutatingWebhookConfiguration</em>应该能够在 v1.20 中整合任何新的信息或 REST 资源版本。</p><p id="9a48" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在确保上述所有内容后，kube<em class="jt">-<em class="jt">API server</em>的 1.19 版可以升级到 1.20 版。API 变更指南和 API 弃用项目政策要求 kube-apiserver 不得考虑省略任何次要版本，无论是在单集群组件中。</em></p><p id="de83" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">Kube-控制器管理器、Kube-调度器、云控制器管理器</strong></p><p id="b5af" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在感知到<em class="jt"> kube </em> - <em class="jt">控制器</em> <em class="jt">管理器</em>、<em class="jt"> kube </em> - <em class="jt">调度器</em>和<em class="jt">云</em> - <em class="jt">控制器</em> <em class="jt">管理器</em>升级之前，必须确定<em class="jt">kube</em>-<em class="jt">API server</em>升级到 v1.20</p><p id="2272" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy">库伯莱</strong></p><p id="44b9" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">与上述先决条件类似，在将<em class="jt"> kubelet </em>组件升级到 1.20 版之前，必须将<em class="jt">kube</em>-<em class="jt">API server</em>组件升级到 1.20 版。</p><p id="228d" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">此外，在执行<em class="jt"> kubelet </em>组件的升级时，不应该忘记从节点吸取 pod。</p><p id="7de1" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="jt">注意</em>:不建议拥有比<em class="jt"> kube </em> - <em class="jt"> apiserver </em>少两个版本的<em class="jt"> kubelet </em>版本。</p><p id="2bf8" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><strong class="iw hy"> Kube-proxy </strong></p><p id="2c27" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">在考虑升级<em class="jt"> kube </em> - <em class="jt"> proxy </em>时，需要考虑三个前提条件。</p><p id="0cfb" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="jt"> kube </em> - <em class="jt"> proxy </em>的版本必须与<em class="jt"> kubelet </em>在一个节点上的版本相似。</p><p id="8549" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="jt"> kube </em> - <em class="jt">代理</em>的版本不得高于<em class="jt">kube</em>-<em class="jt">API server</em>组件。</p><p id="3b35" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">此外，<em class="jt"> kube </em> - <em class="jt">代理</em>的最低允许版本必须比<em class="jt">kube</em>-<em class="jt">API server</em>的版本低两个版本。</p><p id="2307" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="jt">注意</em>:在<em class="jt">kube</em>-<em class="jt">API server</em>组件中存在版本倾斜，限制了<em class="jt"> kubelet </em>、<em class="jt"> kube </em> - <em class="jt">控制器管理器</em>、<em class="jt"> kube 调度器</em>、<em class="jt">云</em> - <em class="jt">控制器管理器</em>和<em class="jt"> kubectl </em>组件的使用。</p><p id="c56a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">值得注意的是，<em class="jt"> kubectl </em>版本受比当前版本高一个版本或低一个版本的<em class="jt">kube</em>-<em class="jt">API server</em>版本支持，即如果<em class="jt">kube</em>-<em class="jt">API server</em>的版本是 v1.20，<em class="jt"> kubectl </em>受 v1.21、v1.20 和 v1 支持</p><h1 id="9a21" class="ju jv hx bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">1.20 版的普遍缺点</h1><p id="288d" class="pw-post-body-paragraph iu iv hx iw b ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn kw jp jq jr hb bi translated"><em class="jt"> kubelet </em>内的汇总 API 中缺少加速器指标(AcceleratorStats)。</p><p id="dd0b" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated">虽然这些变化看起来有点令人困惑，但从长远来看，与 Kubernetes 的扩展交互将确保轻松。</p><h1 id="c98c" class="ju jv hx bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated"><strong class="ak">总结</strong></h1><p id="b990" class="pw-post-body-paragraph iu iv hx iw b ix ks iz ja jb kt jd je jf ku jh ji jj kv jl jm jn kw jp jq jr hb bi translated">Dockershim 的贬值是一个需要考虑的因素，从长远来看，由于对 Docker 的支持将会停止，因此最好开始规划升级。</p><p id="bf6e" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><a class="ae js" href="https://www.hifx.in" rel="noopener ugc nofollow" target="_blank"> <strong class="iw hy"> <em class="jt">关于 HiFX </em> </strong> </a></p><p id="1862" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="jt">我们成立于 2001 年，是一群充满激情的技术专家，专注于追求卓越，致力于为客户提供高质量、高性价比的解决方案。</em></p><p id="2a06" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="jt">在 HiFX，我们理解拥有大量不同数据而没有任何可操作的见解的痛苦。</em></p><p id="607a" class="pw-post-body-paragraph iu iv hx iw b ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr hb bi translated"><em class="jt">通过各种来源以结构化和非结构化形式积累的大量复杂数据蕴含着重要的业务洞察力，这些洞察力与各种规模的组织的成功发展息息相关。借助 HiFX 战略顾问团队，将这些 Pb 级数据转化为实时见解，以增强您的业务策略并提高您组织的收入。我们提供的解决方案将把您的组织转变为数据驱动的发电站。</em></p></div></div>    
</body>
</html>