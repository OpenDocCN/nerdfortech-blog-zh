<html>
<head>
<title>Simplifying Dispatch.main.async</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">简化调度. main.async</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/simplifying-dispatch-main-async-ab9313b87293?source=collection_archive---------10-----------------------#2021-06-23">https://medium.com/nerd-for-tech/simplifying-dispatch-main-async-ab9313b87293?source=collection_archive---------10-----------------------#2021-06-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="da96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有时我们需要将动作的结果从一个线程转移到另一个线程。</p><p id="047a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">典型的情况是，当您在默认或后台队列上进行一些计算，并将更改传播到主队列(线程)时。</p><p id="0790" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在不使用<strong class="ih hj">反应式</strong>方法或者<strong class="ih hj">组合框架的情况下(</strong>出现在 iOS 13，macOS 10.15)，我们需要将执行调度到另一个线程。</p><p id="1a46" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在许多情况下，我调用<strong class="ih hj"> DispatchQueue </strong>的异步方法:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="7e96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样的回调导致“嵌套”。此外，我们不应该忘记使用弱或无主的自我，否则对象将被保留。不管怎样，上面的代码导致了某种重复:</p><pre class="jd je jf jg fd jk jl jm jn aw jo bi"><span id="0789" class="jp jq hi jl b fi jr js l jt ju">DispatchQueue.main.async { [weak self] in             <br/>    guard let self = self else { return } <br/>    // Inner code...</span><span id="cc7a" class="jp jq hi jl b fi jv js l jt ju">}</span></pre><p id="210b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哪个因为括号而让我不愉快:)。我们可以在 Xcode 中使用代码片段，让生活变得更简单。否则，可以在 UI 线程上创建一些协议(我称之为<strong class="ih hj"> MainThreadRunnerType </strong>)和智能调度方法(<strong class="ih hj"> runOnMain </strong>):</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div><figcaption class="jw jx et er es jy jz bd b be z dx translated">MainThreadRunnerType.runOnMain</figcaption></figure><pre class="jd je jf jg fd jk jl jm jn aw jo bi"><span id="f098" class="jp jq hi jl b fi jr js l jt ju">So in such case "repetition" is going to look in the following way:</span><span id="0233" class="jp jq hi jl b fi jv js l jt ju">runOnMain { [weak self] in<br/>    self?.runSecond()<br/>}</span><span id="f774" class="jp jq hi jl b fi jv js l jt ju">runOnMain { [weak self] in<br/>      guard let self = self else { return }</span><span id="c324" class="jp jq hi jl b fi jv js l jt ju">      self.runThird()<br/>}</span></pre><p id="88d7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们给协议添加一个扩展，允许<strong class="ih hj">弱</strong>调用对象的方法。如果我没看错的话，我在<em class="ka"> RxCocoa </em>看到了最初的想法:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="cd49" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上述代码<strong class="ih hj">中，自身</strong>用于扩展，因此可以使用协议作为类型，并为对象创建弱引用。</p><p id="d55f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看一些例子:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="791d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">还有“代码重复”模式，可以通过 Xcode 的代码片段解决。然而，它看起来更好:</p><pre class="jd je jf jg fd jk jl jm jn aw jo bi"><span id="99a3" class="jp jq hi jl b fi jr js l jt ju">runOnMainWeakly(method: type(of: self).displayEndMessage) </span><span id="cdae" class="jp jq hi jl b fi jv js l jt ju">runOnMainWeakly(method: type(of: self).displayMessage2(_:), <br/>                parameter: "Messsage 2nd")</span></pre></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="0b24" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文中，我们设法简化了<strong class="ih hj"> Dispatch.main.async </strong>调用模式。</p></div></div>    
</body>
</html>