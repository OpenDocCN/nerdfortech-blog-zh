<html>
<head>
<title>Peer-to-Peer Chat app using WebRTC and React Native</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 WebRTC 和 React Native 的点对点聊天应用程序</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/peer-to-peer-chat-app-using-webrtc-and-react-native-6c15759f92ec?source=collection_archive---------0-----------------------#2021-05-23">https://medium.com/nerd-for-tech/peer-to-peer-chat-app-using-webrtc-and-react-native-6c15759f92ec?source=collection_archive---------0-----------------------#2021-05-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="222f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你有没有想过使用一个不依赖中央服务器的聊天应用？</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/a52b1efa5f8e3739fbab405c10ac93d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ra8hPRdS4WvtK04_nfmYSQ.png"/></div></div></figure><p id="8c5f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嘿各位开发者！今天我们将使用 react-native 开发一个对等聊天应用程序，利用<a class="ae jp" href="https://webrtc.org/" rel="noopener ugc nofollow" target="_blank"> WebRTC </a>的能力。这篇文章的灵感来自于我在 GSoC 之前为<a class="ae jp" href="https://gitlab.com/aossie" rel="noopener ugc nofollow" target="_blank"> AOSSIE </a>组织所做的研究，我们正在那里开发一个类似的应用程序。</p><p id="9a4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们先试着从高层次理解核心概念，然后我们将深入挖掘代码。那么，WebRTC 到底是什么？WebRTC 代表 Web 实时通信。这是一个免费的<strong class="ih hj">开源</strong>项目，通过简单的 API 为网络浏览器和移动应用提供实时通信。WebRTC 技术是 Google 在 2011 年 5 月作为开源项目发布的。现在让我们试着理解 WebRTC 是如何工作的，以及对等体之间的连接是如何建立的。为了更好地理解，我将试着把这些概念分成几点。</p><h1 id="4e85" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated"><strong class="ak">信令</strong></h1><p id="5e91" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">首先，为了让对等体能够相互聊天，我们需要在它们之间架起一座连接或一个通道，让它们能够开始交流。并且，为了在对等体之间建立通信，我们需要知道我们必须为谁建立连接。上面提到的所有功能都由信令服务器处理，信令服务器使用一组底层协议来发现对等体并协商/终止它们之间的连接。信令交换配置信息并管理对等体/设备之间的连接。</p><p id="6986" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">简而言之，信令使一个对等点能够在网络中找到另一个对等点，并在它们之间建立通信通道。</strong></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es kt"><img src="../Images/554086d832460e52ce0ba519c79cf9b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FGdB1awozWRRP8vT"/></div></div></figure><h1 id="1faa" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">RTCPeerConnection</h1><p id="8608" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">对等连接是 WebRTC 的核心。它为对等体提供了一种无需中间服务器就能与其对等体建立直接连接的方式。它处理 SDP(会话描述协议), SDP 负责对等体之间的信息交换，包括协商、编解码器实现、NAT 穿越、数据包丢失和数据传输。</p><h1 id="9e7f" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">rtcdataschannel</h1><p id="b9db" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">RTCDataChannel 是对等体相互通信的网络通道。RTCDataChannel 负责所有非视听实时数据的交换。因为我们正在开发一个聊天(文本)应用程序，所以我们将使用这个数据通道。它为开发者提供了一种快速安全的点对点传输数据的方式。WebRTC 通过<strong class="ih hj"> UDP </strong>(用户数据报协议)传输数据。RTCDataChannel 允许对等体之间直接进行双向数据传输。</p><h1 id="3b71" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated"><strong class="ak">击晕和转动服务器</strong></h1><p id="7296" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">STUN 代表 NAT 的会话遍历实用程序，它允许客户端发现网络中其他对等体的公共 IP 地址以及它们后面的 NAT 类型。在大多数情况下，STUN 服务器用于连接建立，并且一旦连接建立，数据就直接在对等体之间流动。</p><p id="a5ab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">TURN 代表在特定情况下 STUN 服务器无法在对等体之间建立连接时，使用 NAT 周围的中继进行遍历。</p><h1 id="6f16" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">编解码器</h1><p id="3325" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">在通过对等连接发送数据/媒体之前，必须对其进行压缩。原始音频和视频太大，无法通过互联网有效发送。同样，通过对等连接接收媒体后，必须对其进行解压缩。媒体编解码器(编码器-解码器)就是这样做的。</p><p id="35ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以将 WebRTC 的工作步骤总结如下:<br/> 1 .发起对等方<strong class="ih hj">向</strong>提供到信号服务器的连接。</p><p id="8a04" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.接收对等体<strong class="ih hj">从信号服务器接受</strong>发起对等体的提议。</p><p id="ff26" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.接受提议后，两个对等体共享彼此的配置信息，并协商它们之间的连接。</p><p id="0bfe" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.一旦协商完成，RTCPeerConnection 就建立起来了，对等体现在可以使用这个连接互相聊天了。</p><blockquote class="ku kv kw"><p id="6a41" class="if ig kx ih b ii ij ik il im in io ip ky ir is it kz iv iw ix la iz ja jb jc hb bi translated">注意:这些概念只是冰山一角。WebRTC 中使用了更多的细节和底层协议。但是，我已经向你们展示了一个高度抽象的版本。如果你想深入了解 WebRTC，请告诉我，我很乐意写一篇关于它的文章。</p></blockquote><h1 id="2b9a" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">先决条件</h1><ul class=""><li id="2712" class="lb lc hi ih b ii ko im kp iq ld iu le iy lf jc lg lh li lj bi translated">对<a class="ae jp" href="https://reactnative.dev/" rel="noopener ugc nofollow" target="_blank"> React-Native </a>库的基本了解</li><li id="61d2" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated"><a class="ae jp" href="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API" rel="noopener ugc nofollow" target="_blank"> WebRTC </a>的基础知识</li><li id="d88b" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated"><a class="ae jp" href="https://www.tutorialspoint.com/unix_sockets/what_is_socket.htm" rel="noopener ugc nofollow" target="_blank">插座的知识</a></li></ul><p id="cd82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们尝试在代码中模拟上面提到的几点。因此，为了实现代码，我们将使用库<strong class="ih hj"> react-native-webrtc </strong>，它是 react-native 的 webrtc 模块。让我们做一个反应式的项目。我将在这里使用<strong class="ih hj"> react-native-cli </strong>。所以，打开你的终端，写下:</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="94de" class="lu jr hi lq b fi lv lw l lx ly">react-native init p2p</span></pre><p id="2f96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，我们将安装依赖项。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="20fb" class="lu jr hi lq b fi lv lw l lx ly">yarn add @react-navigation/native<br/>yarn add @react-navigation/stack<br/>yarn add react-native-webrtc</span></pre><p id="7e84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将使用 react-navigation 在不同的屏幕之间导航。现在，根据 react-navigation 的<a class="ae jp" href="https://reactnavigation.org/docs/getting-started/" rel="noopener ugc nofollow" target="_blank">文档</a>，我们需要为 react-navigation 安装额外的依赖项。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="04e9" class="lu jr hi lq b fi lv lw l lx ly">yarn add react-native-reanimated react-native-gesture-handler react-native-screens react-native-safe-area-context @react-native-community/masked-view</span></pre><blockquote class="ku kv kw"><p id="4fd4" class="if ig kx ih b ii ij ik il im in io ip ky ir is it kz iv iw ix la iz ja jb jc hb bi translated">注意:如果你使用低于 0.60 的 react-native 版本，使用`<strong class="ih hj"> react-native link </strong>命令链接依赖项。</p></blockquote><p id="603f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了发现网络中的对等点并在它们之间建立连接，我们需要一个信号服务器。所以，让我们先写我们的信号服务器的实现。我将使用同样的快速和插座。因此，我们需要在我们的项目中安装它们。所以，在你的终端里:</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="533b" class="lu jr hi lq b fi lv lw l lx ly">yarn add express<br/>yarn add socket.io<br/>yarn add socket.io-client</span></pre><p id="678b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，在根文件夹或任何其他文件夹(没关系)中创建一个文件<code class="du lz ma mb lq b">server.js</code>,并添加以下代码。我为代码的解释部分添加了注释。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="1f5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们实现应用程序逻辑之后，套接字连接将变得更有意义。因此，我们的应用程序将以如下方式工作。发起方将创建一个房间。这个房间(代码)将与接收方共享(有点像谷歌会议)，他/她将在他/她的应用程序中输入房间代码。通过这种方式，接收和发起对等端都将加入房间，并可以相互聊天。</p><p id="a1cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，在主屏幕上，我们将有一个简单的文本字段，用户可以在其中输入/创建房间代码。因此，在<strong class="ih hj"> src/screens </strong>目录中创建一个 Home.js 文件，并添加以下代码:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="381c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">主屏幕的代码非常简单。我们添加了一个文本字段，让对方可以输入房间代码。否则，我们有一个<code class="du lz ma mb lq b">Create Room</code>按钮为发起对等体创建一个新房间。我们的主屏幕看起来会像这样:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es me"><img src="../Images/b089fa1fc2f4341ce8b9df898589c5fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*ic9AJPvTQffTVe82Ui_y_A.jpeg"/></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">主屏幕</figcaption></figure><p id="4ee5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，如前所述，发起对等体将简单地生成一个房间，并与接收对等体共享房间 id/代码。接收方将在提供的字段中输入代码，然后他们将进行 p2p 连接。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mj"><img src="../Images/204758ce1787c02dea217582cf43bd92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q0uUdGDrsaByPZ7f2gwhkA.png"/></div></div></figure><p id="fa85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们将制作一个聊天 UI 并实现 WebRTC 逻辑。对于聊天 UI，我们准备用<a class="ae jp" href="https://github.com/FaridSafi/react-native-gifted-chat" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">react-native-gifted-chat</strong></a><strong class="ih hj">。</strong>那么，我们来安装这个库吧。</p><pre class="je jf jg jh fd lp lq lr ls aw lt bi"><span id="8591" class="lu jr hi lq b fi lv lw l lx ly">yarn add react-native-gifted-chat</span></pre><p id="5c62" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们在<code class="du lz ma mb lq b">src/screens</code>目录下创建一个聊天屏幕<code class="du lz ma mb lq b">Chat.js</code>，并实现聊天 UI 和 WebRTC 逻辑。在<code class="du lz ma mb lq b">Chat.js</code>中添加下面的代码。同样，我添加了注释来解释代码实际上在做什么，还添加了一些引用。</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="4342" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">哼，phew 相当长的实现。现在，我们要做的最后一件事是更新<code class="du lz ma mb lq b">App.js</code>文件，这样我们就可以向用户显示我们的主页和聊天屏幕。让我们跳转到<code class="du lz ma mb lq b">App.js</code>文件，按如下方式进行更改:</p><figure class="je jf jg jh fd ji"><div class="bz dy l di"><div class="mc md l"/></div></figure><p id="440e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，我们完成了我们的 P2P 应用程序。只要使用<code class="du lz ma mb lq b">node signal.js</code>启动信号服务器，我们就可以开始了。请记住在<code class="du lz ma mb lq b">signal.js</code>中提供您的网络的<code class="du lz ma mb lq b">IP ADDRESS</code>，以便应用程序可以与服务器通信，以便在本地运行。否则，您也可以托管信号服务器。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es mk"><img src="../Images/096b310ca0e544b2b984152769add25e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1E3VzKfiATiWibQq0HppjA.png"/></div></div><figcaption class="mf mg et er es mh mi bd b be z dx translated">P2P 消息传输</figcaption></figure><p id="9b3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是我们使用 react-native 和 webrtc 进行的点对点消息传输。实现很长，有点乱，有什么问题请尽管提。你可以在<a class="ae jp" href="https://www.linkedin.com/in/rits1272/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>、<a class="ae jp" href="https://twitter.com/Rits1272" rel="noopener ugc nofollow" target="_blank"> Twitter </a>和<a class="ae jp" href="https://www.instagram.com/rits1272/" rel="noopener ugc nofollow" target="_blank"> Instagram </a>上和我联系。</p><p id="87c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以从这里找到应用程序的源代码:</p><div class="ml mm ez fb mn mo"><a href="https://github.com/Rits1272/Peer-to-Peer-Chat/tree/main/p2p" rel="noopener  ugc nofollow" target="_blank"><div class="mp ab dw"><div class="mq ab mr cl cj ms"><h2 class="bd hj fi z dy mt ea eb mu ed ef hh bi translated">rits 1272/点对点聊天</h2><div class="mv l"><h3 class="bd b fi z dy mt ea eb mu ed ef dx translated">一款点对点消息应用。通过在 GitHub 上创建帐户，为 rits 1272/点对点聊天开发做出贡献。</h3></div><div class="mw l"><p class="bd b fp z dy mt ea eb mu ed ef dx translated">github.com</p></div></div><div class="mx l"><div class="my l mz na nb mx nc jn mo"/></div></div></a></div><p id="14c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望你喜欢这篇文章，并从中学到一些有价值的东西。所以，下一篇文章再见，永远不要忘记加上分号；)-再见</p></div></div>    
</body>
</html>