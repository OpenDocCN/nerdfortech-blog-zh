<html>
<head>
<title>AWS Logs Insights</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS 日志洞察</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/aws-logs-insights-384d1fcf2786?source=collection_archive---------0-----------------------#2020-12-09">https://medium.com/nerd-for-tech/aws-logs-insights-384d1fcf2786?source=collection_archive---------0-----------------------#2020-12-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/c3dfac5782d25e231e1737505749d6ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zD1lJcoib1Sf_mXHSWbPJQ.jpeg"/></div></div><figcaption class="hr hs et er es ht hu bd b be z dx translated">斯蒂芬·菲利普斯-Hostreviews.co.uk 在<a class="ae hv" href="https://unsplash.com/s/photos/insights?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><div class=""/><p id="7985" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><em class="jt"> AWS CloudWatch Logs Insights 是一个类似 SQL 的交互式解决方案，用于查询、分析&amp;来自 CloudWatch 的可视化日志数据。Cloudwatch 日志可以是 VPC 流日志、cloudTrail 日志、联系流日志、RDS 日志、服务规范日志或自定义应用程序日志。</em></p><figure class="jv jw jx jy fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es ju"><img src="../Images/861a3b07621511e3e18119dd1ac25024.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8hR4R9HIsUjlPHqAhSrWVQ.png"/></div></div></figure><figure class="jv jw jx jy fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es jz"><img src="../Images/62d29250ed356911349463b170d9a31d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fkb9b09CQBWy8DGMm7Qc4Q.png"/></div></div></figure><p id="ae31" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Log insights 有一个定制的查询语言，非常类似于 SQL</p><blockquote class="ka kb kc"><p id="be1a" class="iv iw jt ix b iy iz ja jb jc jd je jf kd jh ji jj ke jl jm jn kf jp jq jr js hb bi translated"><em class="hy">显示→选择<br/>字段→可显示的属性/列<br/>过滤→ where <br/>统计→分组依据<br/>排序→排序依据<br/>限制→限制</em></p></blockquote><p id="c0e9" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">与 SQL 中的 select … From … where …是单个命令不同，log insights 将它们分成单独的命令。要组合它们，我们需要使用 unix 风格的管道(|)。</p><p id="540f" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">默认情况下，我们得到四个字段@log、@timestamp、@message、@logstream。</p><p id="ff4c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看一个基本的查询。</p><pre class="jv jw jx jy fd kg kh ki kj aw kk bi"><span id="8906" class="kl km hy kh b fi kn ko l kp kq">fields @log, @logStream, @timestamp, @message<br/>| sort @timestamp desc<br/>| limit 100</span></pre><p id="53b1" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在上面的查询中，我们将获得 100 条记录，每条记录都有日志组名、日志流名、日志的时间戳和实际消息，按照时间戳的降序排列。</p><p id="9191" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">AWS 服务生成的日志是 JSON 格式的，您可以直接访问各个属性。</p><pre class="jv jw jx jy fd kg kh ki kj aw kk bi"><span id="e439" class="kl km hy kh b fi kn ko l kp kq">fields eventName, eventSource, errorCode, userIdentity.arn<br/>|filter @message <!-- -->like /(?i)(Exception|error|fail)/<!-- --> <br/>|filter eventSource ='sagemaker.amazonaws.com'<br/>|limit 200</span></pre><h2 id="797c" class="kl km hy bd kr ks kt ku kv kw kx ky kz jg la lb lc jk ld le lf jo lg lh li lj bi translated">从语法上分析</h2><p id="db14" class="pw-post-body-paragraph iv iw hy ix b iy lk ja jb jc ll je jf jg lm ji jj jk ln jm jn jo lo jq jr js hb bi translated">如果日志是 JSON 格式的，那么我们可以直接得到消息的单个属性，否则我们需要使用<strong class="ix hz">‘PARSE’</strong>。Parse 接受全局表达式和正则表达式。</p><p id="2ba7" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">假设您在日志中有一个字符串字段。</p><pre class="jv jw jx jy fd kg kh ki kj aw kk bi"><span id="9bfd" class="kl km hy kh b fi kn ko l kp kq">config_rule_name: AWS-007-EBSEncryption</span></pre><p id="9873" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您想要从名称中提取单个元素，那么查询将是:</p><pre class="jv jw jx jy fd kg kh ki kj aw kk bi"><span id="efdf" class="kl km hy kh b fi kn ko l kp kq">fields @message<em class="jt"><br/></em>| PARSE Details.config_rule_name "*-*-*" Scope, RuleId, RuleName<br/>| filter Scope = 'AWS'<br/>| DISPLAY @log<em class="jt">, </em>@logStream,<em class="jt"> </em>Scope, RuleId, RuleName<em class="jt"><br/></em>| limit 20</span></pre><p id="a68d" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz">使用 API 查询:</strong></p><p id="d9b4" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用控制台查询日志是一个好的开始。但是通常我们应该通过 API 调用来实现自动化。让我们看看如何使用 insights API。</p><figure class="jv jw jx jy fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lp"><img src="../Images/9201bcc0b1406b05d9ee5920d7abcfac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jlqETjHJTAGklR7o5O1smw.png"/></div></div></figure><p id="96ec" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">从上图可以明显看出，查询日志是一个两步过程。首先开始查询，一旦完成，然后得到结果。用 python 实现同样的功能，如下所示。</p><figure class="jv jw jx jy fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lq"><img src="../Images/66afe75ae573ac9c866cceb020266248.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GRu3dT8hG4D1FZW7lxgQwg.png"/></div></div></figure><p id="0258" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意:查询结果不是实时的。事件和日志被推送到 CloudWatch 之间存在延迟。此外，随着查询扫描越来越多的数据，它可能会花费一些时间。</p><p id="e51a" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">让我们看看不同类型日志的一些日志查询。</p><p id="3cd9" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz"> RDS 日志:</strong></p><figure class="jv jw jx jy fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lr"><img src="../Images/e605e4623fd4073abf321c1ed9cba1da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pkWpxHifvAxOXSbJcfPPiw.png"/></div></div></figure><p id="0221" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz"> CloudTrail 日志:</strong></p><pre class="jv jw jx jy fd kg kh ki kj aw kk bi"><span id="1eab" class="kl km hy kh b fi kn ko l kp kq">fields eventSource, errorCode<br/>| filter errorCode =~ /^(?i)\w/<br/>| stats count(*) as eventCount by eventSource, errorCode<br/>| sort eventCount desc</span></pre><blockquote class="ka kb kc"><p id="5f3b" class="iv iw jt ix b iy iz ja jb jc jd je jf kd jh ji jj ke jl jm jn kf jp jq jr js hb bi translated">默认情况下，CloudTrail 中根本不会记录数据层事件(例如调用 lambda、s3 get、Cloudwatch put metric)。S3 和 Lambda 数据平面事件可以通过专门启用它来捕获。</p><p id="edc2" class="iv iw jt ix b iy iz ja jb jc jd je jf kd jh ji jj ke jl jm jn kf jp jq jr js hb bi translated">所有通过 VPC 端点执行并被拒绝的 API 调用都不会被记录到 CloudTrail 中。</p></blockquote><p id="b55c" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hz"> VPC 流量日志:</strong></p><pre class="jv jw jx jy fd kg kh ki kj aw kk bi"><span id="00fd" class="kl km hy kh b fi kn ko l kp kq">filter interfaceId =~ /&lt;eni-id1&gt;|&lt;eni-id2&gt;|&lt;eni-id3&gt;/<br/>| filter dstPort = 443<br/>| fields @timestamp, dstAddr, srcAddr, dstPort<br/>| stats count(srcAddr) by srcAddr</span></pre><p id="af03" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">寻找快乐！！</p><p id="bf00" class="pw-post-body-paragraph iv iw hy ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">参考资料:</p><ul class=""><li id="5fe7" class="ls lt hy ix b iy iz jc jd jg lu jk lv jo lw js lx ly lz ma bi translated"><a class="ae hv" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html" rel="noopener ugc nofollow" target="_blank">洞察查询语法</a></li><li id="3a0b" class="ls lt hy ix b iy mb jc mc jg md jk me jo mf js lx ly lz ma bi translated"><a class="ae hv" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax-examples.html" rel="noopener ugc nofollow" target="_blank">样本查询</a></li></ul></div></div>    
</body>
</html>