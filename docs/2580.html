<html>
<head>
<title>How to build a microservice with NodeJs, Express and MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用 NodeJs，Express，MongoDB 搭建一个微服务</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-to-build-a-microservice-with-nodejs-express-and-mongodb-73737b6fa868?source=collection_archive---------1-----------------------#2021-05-12">https://medium.com/nerd-for-tech/how-to-build-a-microservice-with-nodejs-express-and-mongodb-73737b6fa868?source=collection_archive---------1-----------------------#2021-05-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/98f2d477e5d3cb98c283e2a28735e531.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qkxnndNb1ETR0V_78L2Pwg.png"/></div></div></figure><p id="b6c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们大多数人都经历过这样的困难时期，你有一个大规模的应用程序，它有一堆特性、API 集成、数据库连接等等。新的特性和更新发布了，当然你需要修复错误和维护代码。</p><p id="9917" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">构建这个真实世界的应用程序需要动态编程，应用程序的规模会不受控制地增长。</p><p id="0348" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这种整体模式很难缩小或简化应用程序。因此，为了流畅地运行应用程序，有必要将庞大的同构结构转换成小而独立的程序。当 NodeJs 应用程序构建在<strong class="is hj">微服务上时，类似的复杂性可以毫不费力地解决，</strong>node . js 生态系统更是如此。</p><p id="4411" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因此，我将向您展示如何构建微服务…</p><blockquote class="jo jp jq"><p id="b4d0" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated">这个博客只是对如何构建服务的一个概述，请访问 https://github.com/Nomercy10/ecommerce-micro-services<a class="ae jv" href="https://github.com/Nomercy10/ecommerce-micro-services" rel="noopener ugc nofollow" target="_blank"/>获得一个全功能的工作微服务演示。</p></blockquote><p id="22c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们的示例中，我们将构建两个微服务，<strong class="is hj"> <em class="jr">用户&amp;订单。</em> </strong>想法很简单，用户下单。我们用所有需要的细节创建订单，等等。</p><p id="c873" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是这些微服务将具备的功能列表</p><h2 id="a1be" class="jw jx hi bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq bi translated">用户</h2><ul class=""><li id="8a89" class="kr ks hi is b it kt ix ku jb kv jf kw jj kx jn ky kz la lb bi translated">获取所有用户</li><li id="fc49" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">获取用户</li><li id="b161" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">创建新用户</li><li id="1192" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">按用户标识删除用户</li></ul><h2 id="977f" class="jw jx hi bd jy jz ka kb kc kd ke kf kg jb kh ki kj jf kk kl km jj kn ko kp kq bi translated">命令</h2><ul class=""><li id="a89d" class="kr ks hi is b it kt ix ku jb kv jf kw jj kx jn ky kz la lb bi translated">获取所有订单</li><li id="971c" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">获得订单</li><li id="0836" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">为用户获取订单</li><li id="9cd1" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">为用户创建新订单</li><li id="48b4" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">取消订单</li><li id="679b" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">为用户删除订单</li></ul><h1 id="6687" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">技术</h1><ul class=""><li id="f254" class="kr ks hi is b it kt ix ku jb kv jf kw jj kx jn ky kz la lb bi translated"><a class="ae jv" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>:后端的事件化 I/O</li><li id="e80f" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated"><a class="ae jv" href="http://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a> : Fast node.js 网络 app 框架</li><li id="b8ec" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated">MongoDb:一个面向现代应用的 NoSql 数据库</li></ul><p id="5421" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在构建这些微服务时，我们将为每个微服务创建单独的文件夹。每个文件夹都将安装自己的 package.json 和节点模块。</p><p id="9082" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们开始吧…</p><h1 id="fcc8" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">装置</h1><p id="0d4f" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">创建<code class="du mb mc md me b">Users</code>文件夹并安装以下依赖项</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div class="er es mf"><img src="../Images/46c8ef5a559320cd097b5699a3ea16aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/1*wDmPGwtWmkeDf41LCZve3w.png"/></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">用户安装的依赖项</figcaption></figure><p id="c084" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">关于依赖关系的信息</p><ul class=""><li id="eacb" class="kr ks hi is b it iu ix iy jb mo jf mp jj mq jn ky kz la lb bi translated"><strong class="is hj"><em class="jr">body-parser</em></strong><em class="jr">:</em><em class="jr">它是一个 Node.js 体解析中间件，在你的处理程序之前在中间件中解析传入的请求体，在</em> <code class="du mb mc md me b">req.body</code> <em class="jr">属性下可用。</em></li><li id="4457" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated"><strong class="is hj"> <em class="jr"> axios </em> </strong> <em class="jr">:一个基于 promise 的 HTTP 客户端，用于浏览器和节点 Js。</em></li><li id="69fe" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated"><strong class="is hj"> <em class="jr"> nodemon </em> </strong> <em class="jr">:一个用于 Node Js 开发的工具，因为它提供了对任何文件更改的热重装。</em></li><li id="ec2c" class="kr ks hi is b it lc ix ld jb le jf lf jj lg jn ky kz la lb bi translated"><strong class="is hj"><em class="jr">mongose</em></strong><em class="jr">:一个 MongoDB 对象建模工具，设计用于在异步环境中工作。</em></li></ul><h1 id="fe6b" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">发展</h1><p id="eefd" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">在<code class="du mb mc md me b">/Users</code>文件夹中创建<code class="du mb mc md me b">Users.js</code>，这个文件将是我们进入用户微服务的入口点。</p><p id="42f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">加载依赖项</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mr"><img src="../Images/5753b99d5c8c0be5b6c65871c3a9ebd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*puf0ITJf2bHxqzOVesgmmA.png"/></div></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">加载依赖项</figcaption></figure><h1 id="43a6" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">安装 MongoDB Node.js 驱动程序</h1><p id="147d" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">MongoDB Node.js 驱动程序允许您在 Node.js 应用程序中轻松地与 MongoDB 数据库进行交互。为了连接到数据库并执行本快速入门系列中描述的查询，您将需要该驱动程序。</p><p id="3697" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果没有安装 MongoDB Node.js 驱动程序，可以用下面的命令安装。</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ms"><img src="../Images/3a8a4faf1f81c043ad96a0e4750d0599.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hfUl7T8uYc-p60FK_D4LBw.png"/></div></div></figure><h1 id="dc23" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">创建一个免费的 MongoDB Atlas 集群并加载样本数据</h1><p id="9148" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">接下来，您需要一个 MongoDB 数据库。开始使用 MongoDB 最简单的方法是使用 Atlas，它是 MongoDB 的完全托管的数据库即服务。</p><p id="5ebf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jv" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank">转到 Atlas </a>并在空闲层创建一个新集群。概括地说，集群是一组存储数据库副本的节点。一旦创建了您的层，<a class="ae jv" href="https://docs.atlas.mongodb.com/sample-data/" rel="noopener ugc nofollow" target="_blank">加载示例数据</a>。</p><h1 id="00ca" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">获取集群的连接信息</h1><p id="81e2" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">最后一步是为集群连接做准备。</p><p id="e01c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<a class="ae jv" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank">图集</a>中，导航到您的集群，点击<strong class="is hj">连接</strong>。将出现群集连接向导。</p><p id="b574" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">向导会提示您将当前 IP 地址添加到 IP 访问列表中，并创建一个 MongoDB 用户(如果您还没有这样做的话)。请务必记下您为新 MongoDB 用户使用的用户名和密码，因为您将在后面的步骤中需要它们。</p><p id="2cba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，向导将提示您选择一种连接方法。选择连接您的应用程序。当向导提示您选择驱动程序版本时，请选择 Node.js 和 3.6 或更高版本。复制提供的连接字符串，因为您将在下一节中使用。</p><p id="e1c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有关如何访问连接向导并完成上述步骤的更多详细信息，请参见<a class="ae jv" href="https://docs.atlas.mongodb.com/connect-to-cluster/" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p><h1 id="25f5" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">从 Node.js 应用程序连接到数据库</h1><p id="d40c" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">现在一切都设置好了，是时候编码了！让我们编写一个 Node.js 脚本，它连接到您的数据库并列出集群中的数据库。</p><h1 id="4be8" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">导入 mongoose 客户端</h1><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mt"><img src="../Images/192f7b13f19d3944bd529e1876f8a0b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Elg2AMZsZ-n6-oNEgtNt7w.png"/></div></div></figure><p id="3a26" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du mb mc md me b">mongoose</code>客户端将用于连接到 MongoDB 数据库。这是一个 MongoDb 实例，用于连接到一个集群，访问该集群中的数据库，并关闭到该集群的连接。</p><p id="6047" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">之后我们要做的第一件事是为我们的连接 URI 创建一个常量。连接 URI 是您在上一节中在 Atlas 中复制的连接字符串。粘贴字符串时，不要忘记将<code class="du mb mc md me b">&lt;username&gt;</code>和<code class="du mb mc md me b">&lt;password&gt;</code>更新为您在上一节中创建的用户的凭证。连接字符串包含一个<code class="du mb mc md me b">&lt;dbname&gt;</code>占位符。</p><p id="cff9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>您在连接字符串中提供的用户名和密码与您的 Atlas 凭据不同。</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mu"><img src="../Images/7f30649d25e70daf5254a18d0c077660.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ImrgGjVZcODWYaOE7n-bhw.png"/></div></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">连接字符串 URI</figcaption></figure><p id="0dec" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们有了 URI，我们可以创建一个 MongoDB 的实例</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mv"><img src="../Images/b4e5c14338547da48e40ce0458d2f654.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BZB_wZDkkyOEyv_eqbO3BA.png"/></div></div><figcaption class="mk ml et er es mm mn bd b be z dx translated">MongoDB 客户机的初始化和加载全局实例</figcaption></figure><h1 id="c5ba" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">数据库模型</h1><p id="a49d" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">现在我们已经建立了连接，让我们继续创建 MongoDB 数据模型。我们将使用<code class="du mb mc md me b">mongoose.model</code> <br/> <a class="ae jv" href="https://mongoosejs.com/docs/api.html#model-js" rel="noopener ugc nofollow" target="_blank">模型</a>是从<code class="du mb mc md me b">Schema</code>定义编译而来的奇特构造函数。一个模型的实例被称为<a class="ae jv" href="https://mongoosejs.com/docs/documents.html" rel="noopener ugc nofollow" target="_blank">文档</a>。模型负责从底层 MongoDB 数据库创建和读取文档。</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mw"><img src="../Images/2484355710a39cad8e4d5fc592a09ffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xtBSq2cMu-8kkHN8XF9Ctg.png"/></div></div></figure><h1 id="5221" class="lh jx hi bd jy li lj lk kc ll lm ln kg lo lp lq kj lr ls lt km lu lv lw kp lx bi translated">蜜蜂</h1><p id="bee8" class="pw-post-body-paragraph iq ir hi is b it kt iv iw ix ku iz ja jb ly jd je jf lz jh ji jj ma jl jm jn hb bi translated">为了避免这篇博客太长而无法阅读，我将只展示两个 API。您可以创建我提到的其他功能，也可以创建任意多的功能。</p><p id="5839" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jr">获取用户 API 的所有订单</em></p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mx"><img src="../Images/65f2f54999f6c767732bf955407d8b92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nMAaGOPyy65eRaRt2Sw96Q.png"/></div></div></figure><p id="a87b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如您在上面看到的，当我们触发“/users/:uid/”订单时，我们对 orders 微服务进行外部 API 调用，并调用“/orders？uid= "。通过这种方式，我们可以在微服务之间进行交流，共享数据。</p><p id="93a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="jr">创建新的用户 API </em></p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es my"><img src="../Images/d39fd282836aa2668adbbcd56aff6d28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DlrhSBuY6nQTuHVhs9t6DQ.png"/></div></div></figure><p id="dbba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上面的例子中，我们正在创建一个新用户。首先，我们用来自请求体的响应创建一个 newUser 对象。<br/>然后我们创建一个新的“用户”实例，一个 MongoDB 数据模型用户实例&amp;将“新用户”传递给它。</p><p id="4367" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们现在可以使用。save()属性将数据保存到 MongoDB。因为它是一个基于承诺的属性，所以我们可以使用<code class="du mb mc md me b">.then</code>来执行我们想要的操作。</p><p id="9a29" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>注意:我在这里没有展示如何为订单创建微服务，因为它非常简单，类似于我们为用户微服务所做的工作。如果你还需要了解如何实现，请访问我在博客开头提到的 github repo 链接。</p><blockquote class="jo jp jq"><p id="052d" class="iq ir jr is b it iu iv iw ix iy iz ja js jc jd je jt jg jh ji ju jk jl jm jn hb bi translated">PS:这是我的第一个技术博客，如果你觉得我应该补充一些我遗漏的东西，请留下评论，或者如果你喜欢，请鼓掌。</p></blockquote><p id="1f9e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谢谢你！</p><p id="c6d1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编码快乐！</p></div></div>    
</body>
</html>