<html>
<head>
<title>Knowing this Kotlin pitfall can save you from bugs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解这个Kotlin陷阱可以让你远离bug</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/knowing-this-kotlin-pitfall-may-save-you-from-bugs-b9744060c7ad?source=collection_archive---------1-----------------------#2021-09-12">https://medium.com/nerd-for-tech/knowing-this-kotlin-pitfall-may-save-you-from-bugs-b9744060c7ad?source=collection_archive---------1-----------------------#2021-09-12</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2dac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Kotlin是一种令人敬畏的语言，但它的“语法糖”有时会令人困惑。虽然在文档中提到了这个特殊的东西，但是它很容易被忽略。让我们从一个例子开始:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/88bb189a7fd725f0eab91174f2fa7d29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pNmibe0TKPctPD5dmKOyVw.png"/></div></div></figure><p id="26a7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们有一个带有一个属性的类<code class="du jp jq jr js b">AspectRatioScreen</code>，默认为老好人<code class="du jp jq jr js b">4:3</code>。然后我们有<code class="du jp jq jr js b">ResolutionScreen</code>和<code class="du jp jq jr js b">width</code>属性的<code class="du jp jq jr js b">height</code>。它们的设置器会自动更新纵横比。</p><p id="acc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在main中，我们创建一个<code class="du jp jq jr js b">ResolutionScreen</code>对象并打印其参数。默认情况下，分辨率设置为与<code class="du jp jq jr js b">16:9</code>纵横比相对应的<code class="du jp jq jr js b">1920x1080</code>。但是程序输出是:</p><pre class="je jf jg jh fd jt js ju jv aw jw bi"><span id="acf7" class="jx jy hi js b fi jz ka l kb kc">Screen resolution: 1920x1080, ratio: 4/3</span></pre><p id="0914" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">纵横比与分辨率不匹配。为什么？科特林文件中写道:</p><blockquote class="ke"><p id="049e" class="kf kg hi bd kh ki kj kk kl km kn jc dx translated">如果定义了自定义setter，则每次为属性赋值时都会调用它，初始化除外。</p></blockquote><p id="3f21" class="pw-post-body-paragraph if ig hi ih b ii ko ik il im kp io ip iq kq is it iu kr iw ix iy ks ja jb jc hb bi translated">这意味着设置<code class="du jp jq jr js b">width</code>和<code class="du jp jq jr js b">height</code>的初始尺寸不会调用它们的设置器。解决这个问题的一个方法是在<code class="du jp jq jr js b">ResolutionScreen</code>类中添加一个<code class="du jp jq jr js b">init</code>块:</p><pre class="je jf jg jh fd jt js ju jv aw jw bi"><span id="f3a0" class="jx jy hi js b fi jz ka l kb kc"><strong class="js hj">class </strong>ResolutionScreen : AspectRatioScreen() {<br/>    <strong class="js hj">var width </strong>= 1920<br/>        <strong class="js hj">// ...</strong><br/>    <strong class="js hj">var height </strong>= 1080<br/>        <strong class="js hj">// ...</strong><br/><br/>    <strong class="js hj">init </strong>{<br/>        <strong class="js hj">width </strong>= 1920<br/>        <strong class="js hj">height </strong>= 1080<br/>    }<br/>}</span></pre><p id="f89c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将重新分配默认值和调用设置器。现在显示的结果是正确的:</p><pre class="je jf jg jh fd jt js ju jv aw jw bi"><span id="a17b" class="jx jy hi js b fi jz ka l kb kc">Set width to 1920<br/>Set height to 1080<br/>Screen resolution: 1920x1080, ratio: 16/9</span></pre><p id="0e2f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种解决方案有一个缺点:您必须声明默认值两次，因为属性不能没有初始值设定项。一种解决方法是定义常量:<code class="du jp jq jr js b">private const val DEFAULT_WIDTH = 1920</code>并在两个地方使用它们。</p><p id="4a69" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最简单的解决方案是在<code class="du jp jq jr js b">init</code>块中直接调用<code class="du jp jq jr js b">reacalculateAspectRatio()</code>:</p><pre class="je jf jg jh fd jt js ju jv aw jw bi"><span id="6477" class="jx jy hi js b fi jz ka l kb kc"><strong class="js hj">class </strong>ResolutionScreen : AspectRatioScreen() {<br/>    <strong class="js hj">var width </strong>= 1920<br/>        <strong class="js hj">// ...</strong><br/>    <strong class="js hj">var height </strong>= 1080<br/>        <strong class="js hj">// ...</strong><br/><br/>    <strong class="js hj">init </strong>{<br/>        recalculateAspectRatio()<br/>    }<br/>}</span></pre><p id="a0db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于这种特殊情况，这是最明确的解决方案。还有另一种方法，当只有一个属性时看起来更好，我们希望初始化它的<em class="kt">后台属性</em>:</p><pre class="je jf jg jh fd jt js ju jv aw jw bi"><span id="c43a" class="jx jy hi js b fi jz ka l kb kc"><strong class="js hj">class</strong> Duration {<br/>    <strong class="js hj">var durationInSeconds</strong>: Int = 1<br/>}</span><span id="830d" class="jx jy hi js b fi ku ka l kb kc"><strong class="js hj">class</strong> EnhancedDuration : Duration() {<br/>    <strong class="js hj">var durationInHours</strong> = 1.<strong class="js hj">also</strong> { durationInSeconds = 3600 * <strong class="js hj">it</strong> }<br/>        <strong class="js hj">// ...</strong><br/>}</span></pre><p id="eb4c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这种语法有一个优点——我们在初始化原始属性的相同位置初始化支持属性(本例中为<code class="du jp jq jr js b">durationInSeconds</code>)。</p><p id="81dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们的例子中，它看起来像这样:</p><pre class="je jf jg jh fd jt js ju jv aw jw bi"><span id="9154" class="jx jy hi js b fi jz ka l kb kc"><strong class="js hj">class </strong>ResolutionScreen : AspectRatioScreen() {<br/>    <strong class="js hj">var width </strong>= 1920<br/>        <strong class="js hj">set</strong>(value) {<br/>            <strong class="js hj">field </strong>= value<br/>            <!-- -->recalculateAspectRatio<!-- -->()<br/>        }<br/>    <strong class="js hj">var height </strong>= 1080.<strong class="js hj"><em class="kt">also</em></strong><em class="kt"> </em><strong class="js hj">{ aspectRatio </strong>= width divBy <strong class="js hj">it</strong> <strong class="js hj">}<br/>        set</strong>(value) {<br/>            <strong class="js hj">field </strong>= value<br/>            <!-- -->recalculateAspectRatio<!-- -->()<br/>        }<br/><br/>    <strong class="js hj">// ...</strong><br/>}</span></pre><p id="92fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du jp jq jr js b">also</code>块只存在于<code class="du jp jq jr js b">height</code>初始化器中，因为初始化是从上到下进行的——在初始化之前，我们不能使用<code class="du jp jq jr js b">width</code>或<code class="du jp jq jr js b">height</code>。即使在<code class="du jp jq jr js b">also</code>块中，<code class="du jp jq jr js b">height</code>也不能使用，因为它还没有被初始化。这就是为什么在两个或更多属性以某种方式相关的情况下，最好使用<code class="du jp jq jr js b">init</code>块。</p></div><div class="ab cl kv kw gp kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="hb hc hd he hf"><p id="37a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就这些了，编码快乐！</p><div class="lc ld ez fb le lf"><a href="https://kotlinlang.org/docs/properties.html#getters-and-setters" rel="noopener  ugc nofollow" target="_blank"><div class="lg ab dw"><div class="lh ab li cl cj lj"><h2 class="bd hj fi z dy lk ea eb ll ed ef hh bi translated">属性| Kotlin</h2><div class="lm l"><h3 class="bd b fi z dy lk ea eb ll ed ef dx translated">Kotlin类中的属性既可以用var关键字声明为可变的，也可以用val…</h3></div><div class="ln l"><p class="bd b fp z dy lk ea eb ll ed ef dx translated">kotlinlang.org</p></div></div><div class="lo l"><div class="lp l lq lr ls lo lt jn lf"/></div></div></a></div></div></div>    
</body>
</html>