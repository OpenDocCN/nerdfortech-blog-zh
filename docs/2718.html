<html>
<head>
<title>Practical Applications of Background Services Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">后台服务的实际应用第二部分</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/practical-applications-of-background-services-part-2-c1082bb2c613?source=collection_archive---------17-----------------------#2021-05-17">https://medium.com/nerd-for-tech/practical-applications-of-background-services-part-2-c1082bb2c613?source=collection_archive---------17-----------------------#2021-05-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/ccddab469d7fe754970f9ec755b3b6be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2jV-t4OtfJi1VZXF0g2W4g.jpeg"/></div></div></figure><p id="dfaf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们之前名为<a class="ae jo" href="https://www.partech.nl/nl/publicaties/2021/04/practical-implementation---net-core-background-services" rel="noopener ugc nofollow" target="_blank">的博客中，实际实施:。NET Core BackgroundServices </a>，我们已经看到了如何使用一个实际的实现来实现后台服务。让我们再深入一点，了解更多..</p><p id="e1af" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设有一个服务器托管了一个API。我们希望在API开始时就记录下这个服务器的内存使用情况。在API停止之前必须这样做，这样我们才能知道在一天的某个特定时刻使用数据消耗了多少内存。为了实现这一点，我们将每隔15秒监控服务器的内存使用情况并保存在一个文件中(可以根据需要进行配置)。</p><p id="afa5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看如何在API中使用后台服务来实现这一点。</p><p id="5c29" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">除此之外，要查看后台服务在。Net核心，我们将学习如何在Windows服务器上的Internet信息服务(IIS)中托管API。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es jp"><img src="../Images/3a5d4b223b49d320ab20cdda3504b684.png" data-original-src="https://miro.medium.com/v2/resize:fit:904/0*slMMUKvJ_axlFbB8"/></div></figure><p id="d648" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，打开运行窗口(Winkey + R)并键入' inetmgr '。如果您得到下面的错误，那么需要安装IIS。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ju"><img src="../Images/0ad0cd5df773928770d9df8ebf9e5bb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZD0xlfOZL1zi6fi1"/></div></div></figure><p id="bda3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">若要安装，请再次打开运行窗口并键入“appwiz.cpl”，这将打开安装在您机器上的程序和功能。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es jv"><img src="../Images/7de50851e4acf1a10e6b2437068f155f.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/0*zT4HmSHIQPUG-oSX"/></div></figure><p id="3984" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在屏幕的左侧，会有一个选项“打开或关闭Windows功能”。点击那个。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es jw"><img src="../Images/d5dd6e3558c6f36c759573094c5511aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:494/0*URr-rW3C_ZaUPrhQ"/></div></figure><p id="6a7b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择该选项后，会出现一个弹出窗口。选择下面突出显示的复选框，并在安装完成后重启机器。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es jx"><img src="../Images/d4de9f4678ccdad5835c4eb686bf9ca9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/0*hwdkfI3NSpCNLL5g"/></div></figure><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jy"><img src="../Images/479ea71a711ceddff2c69eff447d2d6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/0*ZLP8bK2BV252Z6cc"/></div></div></figure><p id="6046" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">约束后，安装URL重写和。来自互联网的Net Core运行时和托管包。</p><p id="2877" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">【https://www.iis.net/downloads/microsoft/url-rewrite】链接网址改写<a class="ae jo" href="https://www.iis.net/downloads/microsoft/url-rewrite" rel="noopener ugc nofollow" target="_blank">—</a></p><p id="9b7f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">。网芯托管捆绑</strong><a class="ae jo" href="https://dotnet.microsoft.com/download/dotnet/3.1" rel="noopener ugc nofollow" target="_blank">—https://dotnet.microsoft.com/download/dotnet/3.1</a></p><p id="48a6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦安装了上述所有工具，尝试从运行窗口打开inetmgr。应该会出现如下所示的屏幕。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jz"><img src="../Images/42d180b618d1539a94df4799c6b60943.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pe3T4j7wpNNQMXOY"/></div></div></figure><p id="4a6a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们开始创建一个可以在IIS中托管的API。</p><p id="ff11" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个ASP。Net Core Web应用程序，并为解决方案提供一个有效的名称。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es ka"><img src="../Images/0b02ddd96e90091e88097d1c70bea447.png" data-original-src="https://miro.medium.com/v2/resize:fit:1296/0*QCG8HfHhOUcrTnOZ"/></div></figure><p id="c48b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">从可用模板中选择项目类型作为API。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ju"><img src="../Images/9fbab69b72accee14c7a6efb570ac48b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S1Tjc2fb-qZRyUa6"/></div></div></figure><p id="34cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建后，解决方案资源管理器将如下所示。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es kb"><img src="../Images/6742ddcfa2dfdde9c265528d49233a3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:744/0*K6cU1Qhjn3QuITCL"/></div></figure><p id="4b79" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">添加一个包含HostedServices逻辑的类文件。为该类提供一个有效的名称，并从Microsoft.Extensions.Hosting继承接口“IHostedService”</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ju"><img src="../Images/f61d46a272b0a479606cf441f2781c0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WDp6_k_FsK_DX5-Y"/></div></div></figure><p id="0a69" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">实现所需的方法(StartAsync、StopAsync)。与此同时，实现将内存利用率写入类文件中的一个文件的逻辑，如下所示。这将在每15秒后寻找所利用的内存，并将数据写入一个文件。文件名后面会附加日期时间。</p><pre class="jq jr js jt fd kc kd ke kf aw kg bi"><span id="bf7e" class="kh ki hi kd b fi kj kk l kl km">using Microsoft.Extensions.Hosting; using System; using System.IO; using System.Collections.Generic; using System.Diagnostics; using System.Linq; using System.Threading; using System.Threading.Tasks; namespace PARTECH_BackgroundServices2 { public class PartechHostedService : IHostedService { ​ private Timer _timer; ​ public Task StartAsync(CancellationToken cancellationToken) ​ { ​ _timer = new Timer(WriteSystemData, null, 0, 15000); ​ return Task.CompletedTask; ​ } ​ void WriteSystemData(object state) ​ { ​ PerformanceCounter ramCounter; ​ ramCounter = new PerformanceCounter("Memory", "Available MBytes"); ​ var data = $"Available Memory - { ramCounter.next() } MB"; File.WriteAllText($"D:\\PARTECH\\SystemInfo_{DateTime.Now.ToString("MM_dd_yyyy_HH_mm_ss") }.txt", data); ​ } ​ public Task StopAsync(CancellationToken cancellationToken) ​ { ​ //New Timer does not have a stop. ​ _timer?.Change(Timeout.Infinite, 0); ​ return Task.CompletedTask; ​ } } }</span></pre><p id="42a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在Startup.cs文件中的configureServices方法中插入托管服务类文件。现在，您可以运行解决方案并检查所需的数据是否在提供的路径中被接收。</p><pre class="jq jr js jt fd kc kd ke kf aw kg bi"><span id="b026" class="kh ki hi kd b fi kj kk l kl km">services.AddHostedService&lt;PartechHostedService&gt;();</span></pre><figure class="jq jr js jt fd ij er es paragraph-image"><div class="er es kn"><img src="../Images/63805d8701bb4add2c8765f26c648822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/0*6wVMZBcP9r6Ac6oT"/></div></figure><p id="a7be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">之后，将项目发布到创建网站的路径。要发布，请选择文件夹目标选项。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ju"><img src="../Images/bcf89e6e12b023c6ed846a5c7ded09c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kuGSABvSUxw6s5Tj"/></div></div></figure><p id="bdc5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，转到IIS，右键单击左窗格中的“站点”,选择“添加网站”,并提供如下图所示的选项。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/eabad28fa0ccaa62f8c22b69f74c00a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SKqISWz6n1LmqqKE"/></div></div></figure><p id="952d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里，Sitename是存储在IIS中的网站的名称。下一个字段是应用程序池。顾名思义，它表示应用程序正在其中运行的应用程序池。我们可以在应用程序池级别单独配置元素。</p><p id="e04c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来是发布后台服务的代码的路径。点击“测试设置”。如果您发现没有访问该路径的授权，请单击“连接身份”。提供登录服务器的凭据。</p><p id="c3e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来提供绑定类型为HTTPS。从下拉列表中，选择可用的IP并提供有效的端口号。在屏蔽IP的情况下，还可以提供主机名，通过该主机名可以从浏览器访问应用程序。</p><p id="36d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">因为已经选择了HTTPS选项，所以选择一个有效的证书，最后单击确定按钮。这将创建一个网站的网站下提供的名称，它将通过提供的IP和屏蔽的网址访问。</p><p id="4194" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，为站点启用目录浏览。并尝试从浏览器点击API来验证它是否工作。这里的网址是<a class="ae jo" href="https://192.168.0.18/weatherforecast." rel="noopener ugc nofollow" target="_blank">https://192 . 168 . 0 . 18/weather forecast。</a>你看到浏览器页面上的结果了吗？</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ju"><img src="../Images/2cdc339128657b11e3965f49cbcb4f8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ql7F8Pg6dSOgiYZI"/></div></div></figure><p id="73a9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，打开文件资源管理器，导航到已配置为写入利用率数据的文件夹路径。你会看到每15秒钟就有一个文件被创建。</p><figure class="jq jr js jt fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ju"><img src="../Images/ffcdb4197dcac57065b68262c2e96da5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vrzT2xnc7tvbaaSe"/></div></div></figure><h1 id="74ed" class="kp ki hi bd kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll bi translated">结论</h1><p id="189d" class="pw-post-body-paragraph iq ir hi is b it lm iv iw ix ln iz ja jb lo jd je jf lp jh ji jj lq jl jm jn hb bi translated">这是另一个简单实用的例子，展示了如何使用后台服务并在Windows服务器上托管它们。像这样，许多其他后台计划可以通过该代码处理。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="60e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="ly">原载于</em><a class="ae jo" href="https://www.partech.nl/nl/publicaties/2021/05/practical-applications-of-background-services-part-2" rel="noopener ugc nofollow" target="_blank"><em class="ly">https://www . partech . nl</em></a><em class="ly">。</em></p></div></div>    
</body>
</html>