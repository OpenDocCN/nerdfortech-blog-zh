<html>
<head>
<title>Deep Dive into Cortex Metrics Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入探究皮层指标第二部分</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/deep-dive-into-cortex-metrics-part-ii-666f74cb781a?source=collection_archive---------0-----------------------#2021-12-17">https://medium.com/nerd-for-tech/deep-dive-into-cortex-metrics-part-ii-666f74cb781a?source=collection_archive---------0-----------------------#2021-12-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="3f82" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">深入探究Cortex Metrics.io第二部分</p><p id="5747" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在本文的<a class="ae jd" rel="noopener" href="/nerd-for-tech/deep-dive-into-cortex-part-i-c228e01f8c58"> <strong class="ih hj"> <em class="je">第一部分</em> </strong> </a>中，我们已经了解了皮层的各个组成部分及其用例。在第二部分中，我们将使用AWS S3配置Cortex作为其后端存储桶，并了解如何使用Cortex将指标保留更长时间。我们还将配置Grafana使用Cortex查询前端来可视化来自各种Prometheus集群的图形。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es jf"><img src="../Images/e575b2a6de942ff94cff4f99ae88e8bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/0*kPUQ6-MNKjN9BRtE.jpg"/></div><figcaption class="jn jo et er es jp jq bd b be z dx translated">皮质指标</figcaption></figure><h1 id="4910" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">整个故事是关于什么的？(TLDR)</h1><ol class=""><li id="ae1e" class="kp kq hi ih b ii kr im ks iq kt iu ku iy kv jc kw kx ky kz bi translated">使用官方舵图安装Cortex。</li><li id="ec6f" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">将Cortex配置为使用AWS S3作为其对象存储。</li></ol><h1 id="d780" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">先决条件</h1><ol class=""><li id="fb57" class="kp kq hi ih b ii kr im ks iq kt iu ku iy kv jc kw kx ky kz bi translated">Kubernetes集群(可以是本地、AKS、EKS、GKE、Kind)。</li><li id="5bb3" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">头盔，已安装kubectl。</li></ol><h1 id="1cdf" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">这篇文章没有涉及到什么</h1><ol class=""><li id="0903" class="kp kq hi ih b ii kr im ks iq kt iu ku iy kv jc kw kx ky kz bi translated">如何建立基于生产的Cortex集群？</li><li id="0644" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">比较市场上的各种监控解决方案(灭霸与Cortex)</li></ol><h1 id="9c09" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">故事资源</h1><ol class=""><li id="eaae" class="kp kq hi ih b ii kr im ks iq kt iu ku iy kv jc kw kx ky kz bi translated">GitHub链接:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests</a></li><li id="c943" class="kp kq hi ih b ii la im lb iq lc iu ld iy le jc kw kx ky kz bi translated">GitHub分支:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/tree/cortex" rel="noopener ugc nofollow" target="_blank">皮层</a></li></ol><p id="5430" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">安装普罗米修斯操作器。</strong></p><p id="4f21" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你使用helm这样的包管理器，Cortex的安装会更容易。Cortex有一个官方的掌舵图，可以用来在Kubernetes集群上安装Cortex集群。你可以在这里找到舵图<a class="ae jd" href="https://github.com/cortexproject/cortex-helm-chart" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="5e78" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们安装Cortex集群之前，让我们使用此处的舵图安装Prometheus操作器。稍后，Prometheus实例将被配置一个远程写配置，以将其推送到Cortex入口。但是现在，让我们按照您的定制安装Prometheus操作器。此图表的值可在此配置<a class="ae jd" href="https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml" rel="noopener ugc nofollow" target="_blank">。不过，我在非HA模式下安装了consul。舵值可以在</a><a class="ae jd" href="https://raw.githubusercontent.com/pavan-kumar-99/medium-manifests/cortex/consul-helm-values.yaml" rel="noopener ugc nofollow" target="_blank"> <em class="je">这里找到</em> </a>。</p><pre class="jg jh ji jj fd lf lg lh li aw lj bi"><span id="10a8" class="lk js hi lg b fi ll lm l ln lo">$ helm repo add prometheus-community \ <a class="ae jd" href="https://prometheus-community.github.io/helm-charts" rel="noopener ugc nofollow" target="_blank">https://prometheuscommunity.github.io/helm-charts</a></span><span id="1730" class="lk js hi lg b fi lp lm l ln lo">$ helm repo update</span><span id="1475" class="lk js hi lg b fi lp lm l ln lo">$ helm upgrade -i prom prometheus-community/kube-prometheus-stack</span></pre><p id="a7bd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在Kubernetes集群中安装Cortex</strong></p><p id="a6cb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">普罗米修斯操作员现在已经安装好了。现在让我们使用官方的舵图来安装Cortex。但是在cortex要求安装consul之前，我已经使用了Harshicorp存储库中的官方舵图。您可以在cortex名称空间中遵循文档<a class="ae jd" href="https://www.consul.io/docs/k8s/installation/install#helm-chart-installation" rel="noopener ugc nofollow" target="_blank">这里</a>中提到的步骤。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lq"><img src="../Images/38f641be312b04c5c9c86c1c0126c47e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hc7jR2rYboK6nKsG4Jm_1A.png"/></div></div><figcaption class="jn jo et er es jp jq bd b be z dx translated">领事舵图安装</figcaption></figure><p id="7fe6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如前所述，对于这个cortex安装，我们将使用AWS S3存储桶作为后端对象存储。我已经从IAM控制台创建了一个AWS密钥和访问密钥，并将它们添加到我的cortex-values.yaml(第25、26行)文件中，还添加了consul URL(第18行)、S3存储桶名称(第24行)，并且我还启用了带有自定义标签的Prometheus服务监视器。</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><pre class="jg jh ji jj fd lf lg lh li aw lj bi"><span id="a61b" class="lk js hi lg b fi ll lm l ln lo">$ git clone <a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b cortex</span><span id="aa47" class="lk js hi lg b fi lp lm l ln lo">$ helm repo add cortex-helm \<br/>https://cortexproject.github.io/cortex-helm-chart</span><span id="2389" class="lk js hi lg b fi lp lm l ln lo">$ helm repo update </span><span id="5e41" class="lk js hi lg b fi lp lm l ln lo">$ helm install cortex --namespace cortex cortex-helm/cortex \<br/>-f cortex-values.yaml</span></pre><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lx"><img src="../Images/7666ea2fe873db7b996684a84a6b5b77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*prtsjSB977pDKOZO_lcE6Q.png"/></div></div><figcaption class="jn jo et er es jp jq bd b be z dx translated">Cortex安装</figcaption></figure><p id="d9e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Cortex名称空间中的cortex和Consul组件</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es ly"><img src="../Images/44d6c37439bcf817717bc39cabfe9d1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0h3NVeZtDgphsrdZylKZZQ.png"/></div></div></figure><p id="1ac6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们看看，cortex名称空间中存在的服务。就目前而言，我们应该考虑更多地关注以下服务。</p><p id="67ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a)cortex-nginx(http://192 . 168 . 29 . 168)</p><p id="2ca0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b)皮层-查询-前端(<a class="ae jd" href="http://192.168.29.171" rel="noopener ugc nofollow" target="_blank"> http://192.168.29.171 </a></p><p id="e4ef" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请随意在此暂停，了解本系列<a class="ae jd" rel="noopener" href="/nerd-for-tech/deep-dive-into-cortex-part-i-c228e01f8c58"> <strong class="ih hj"> Part-I </strong> </a>中的皮质成分。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es lz"><img src="../Images/8e2611445f7d158fee4fb90bdbdfd7f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZMnXWBtlmrNlr4JZgAvYqA.png"/></div></div><figcaption class="jn jo et er es jp jq bd b be z dx translated">Cortex名称空间服务</figcaption></figure><p id="2d65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用Prometheus操作员安装Prometheus实例(具有远程写入配置)。</strong></p><p id="2d84" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以使用Prometheus自定义资源定义来创建Prometheus实例。但是我们带来的新变化是增加了这两行。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div class="er es ma"><img src="../Images/48dccb7f1a6ec102828d1cd06c3cbb95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1044/format:webp/1*4NBX-Jnw0HQ5cxd59kV4Kw.png"/></div><figcaption class="jn jo et er es jp jq bd b be z dx translated">Prometheus远程写入配置</figcaption></figure><p id="a729" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你清楚地注意到网址，你会意识到网址是cortex-nginx IP。现在理解起来应该更容易了。我们将所有指标从Prometheus发送到cortex-nginx，cortex-nginx再发送到其余的cortex组件。</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="lv lw l"/></div></figure><pre class="jg jh ji jj fd lf lg lh li aw lj bi"><span id="c773" class="lk js hi lg b fi ll lm l ln lo">$ git clone <a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b cortex</span><span id="08f3" class="lk js hi lg b fi lp lm l ln lo">$ kubectl apply -f prometheus-rbac.yaml</span><span id="7b26" class="lk js hi lg b fi lp lm l ln lo">$ kubectl apply -f prometheus-monitoring.yaml</span></pre><p id="67e1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们应该看到所有的指标都被写入cortex nginx pods，并且这些指标正在被其余的cortex组件处理。来自不同名称空间的多个Prometheus实例也可以推送到这个cortex实例。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es mb"><img src="../Images/e6095b5d75d7ff242e025ec3df7e9204.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8mTcPbVCxRrho2uFZs2lDQ.png"/></div></div><figcaption class="jn jo et er es jp jq bd b be z dx translated">Cortex Nginx通过RemoteWrite接收所有指标</figcaption></figure><p id="9362" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Cortex前端Querier UI？</strong></p><p id="127c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，我如何从单一来源获得所有这些指标呢？不幸的是，Cortex没有像灭霸那样的查询前端UI。因此，我们必须部署另一个具有远程读取配置的Prometheus实例。该配置将从Cortex查询前端端点读取。如果您现在看到第23行，您应该意识到这个IP是cortex-query-frontend的IP。</p><figure class="jg jh ji jj fd jk"><div class="bz dy l di"><div class="lv lw l"/></div><figcaption class="jn jo et er es jp jq bd b be z dx translated">Cortex远程读取配置</figcaption></figure><pre class="jg jh ji jj fd lf lg lh li aw lj bi"><span id="bcdb" class="lk js hi lg b fi ll lm l ln lo">$ git clone <a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b cortex</span><span id="55db" class="lk js hi lg b fi lp lm l ln lo">$ kubectl apply -f prometheus-remote-read.yaml</span></pre><p id="cbaa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您应该可以在这里看到所有不同的普罗米修斯集群的指标。是不是很酷？是的，它是！！</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es mc"><img src="../Images/51e6ad1dd33b51f50d3105c66ccda1aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vw0RHxCx3HyGH8oG4ETKug.png"/></div></div><figcaption class="jn jo et er es jp jq bd b be z dx translated">来自各种普罗米修斯集群的指标</figcaption></figure><p id="8ac9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在是验证主要事情的时候了。是的，保留。我已经在我的家庭集群中运行cortex metrics很长时间了。我现在想获得过去30天的计算资源利用率。我能做到吗？是的，显然是因为我已经将cortex配置为使用AWS S3存储桶作为其后端块存储。啊，这是数据。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es md"><img src="../Images/61a226eb299f3d57a0ee8d80b9e22277.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LOlpBLYr_N4gU1RlUfBdeQ.png"/></div></div></figure><p id="1d5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Cortex性能仪表板:</strong></p><p id="b4c5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个漂亮的仪表板<a class="ae jd" href="https://grafana.com/grafana/dashboards/9820" rel="noopener ugc nofollow" target="_blank"/>，用来可视化Grafana中Cortex的性能。我通过改变几个面板和查询对它进行了调整，使它看起来更有吸引力。我已经把它添加到我的<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/blob/cortex/cortex-grafana-dashboard.yaml" rel="noopener ugc nofollow" target="_blank">回购</a>中，随时对仪表盘提出一些修改建议。</p><figure class="jg jh ji jj fd jk er es paragraph-image"><div role="button" tabindex="0" class="lr ls di lt bf lu"><div class="er es me"><img src="../Images/b2d15780569e8757d65e990eb8f22391.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cpo3qrTRiEFkS0SLtGi6Ww.png"/></div></div><figcaption class="jn jo et er es jp jq bd b be z dx translated">皮层性能指标</figcaption></figure><h1 id="751a" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">结论</h1><p id="1714" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq mf is it iu mg iw ix iy mh ja jb jc hb bi translated">因此，在Cortex和Prometheus的帮助下，我们可以建立一个HA指标聚合解决方案。虽然市场上有许多其他解决方案，但cortex是许多公司在其生产环境中使用的解决方案之一。最初，我很难理解皮层的每个组成部分。但是单独探索每个组件让我对皮层指标有了更深入的了解。请在下面的评论区分享您使用Cortex的体验。</p><p id="e5b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">直到下一次…..</p><h1 id="1271" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">被推荐的</h1><div class="mi mj ez fb mk ml"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/deep-dive-into-cortex-part-i-c228e01f8c58"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">深入探究皮层指标—第一部分</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">深入探究Cortex Metrics.io第一部分</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">medium.com</p></div></div><div class="mu l"><div class="mv l mw mx my mu mz jl ml"/></div></div></a></div><div class="mi mj ez fb mk ml"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/deep-dive-into-thanos-part-ii-8f48b8bba132"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">深入灭霸——第二部分</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">使用灭霸和普罗米修斯操作员监控Kubernetes的工作负载</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">medium.com</p></div></div><div class="mu l"><div class="na l mw mx my mu mz jl ml"/></div></div></a></div><div class="mi mj ez fb mk ml"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/kubernetes-cluster-autoscaler-in-action-6172a023f542"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">Kubernetes集群自动缩放器正在运行</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">使用Kubernetes集群自动缩放器有效节约成本</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">medium.com</p></div></div><div class="mu l"><div class="nb l mw mx my mu mz jl ml"/></div></div></a></div><div class="mi mj ez fb mk ml"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/running-apache-spark-on-eks-with-aws-spot-instances-f8ce91d319b9"><div class="mm ab dw"><div class="mn ab mo cl cj mp"><h2 class="bd hj fi z dy mq ea eb mr ed ef hh bi translated">使用AWS Spot实例在EKS上运行Apache Spark</h2><div class="ms l"><h3 class="bd b fi z dy mq ea eb mr ed ef dx translated">通过AWS Spot实例为EKS上的Apache Spark工作负载有效节约成本</h3></div><div class="mt l"><p class="bd b fp z dy mq ea eb mr ed ef dx translated">medium.com</p></div></div><div class="mu l"><div class="nc l mw mx my mu mz jl ml"/></div></div></a></div></div></div>    
</body>
</html>