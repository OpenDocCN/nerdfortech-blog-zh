<html>
<head>
<title>Terraform: Two-Tier Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform:双层架构</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/terraform-two-tier-architecture-f4fe80a95c27?source=collection_archive---------0-----------------------#2022-08-25">https://medium.com/nerd-for-tech/terraform-two-tier-architecture-f4fe80a95c27?source=collection_archive---------0-----------------------#2022-08-25</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/32e23ee2aa2fa847e1c72137d63f7bae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*UtY6E5qDlYZZr00pEhYi9A.png"/></div><figcaption class="im in et er es io ip bd b be z dx translated">使用 Terraform 的双层架构</figcaption></figure><p id="dceb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">目标:</strong></p><p id="6321" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您的团队需要您为您的公司绘制和部署一个双层架构。</p><ol class=""><li id="f9e4" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">使用 CIDR 10.0.0.0/16 部署一个 VPC，并使用 CIDR 10.0.1.0/24 和 10.0.2.0/24 部署两个公共子网。为了实现高可用性，每个公共子网应该位于不同的 AZ 中。</li><li id="cabb" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">使用 RDS MySQL 实例(微型)创建两个专用子网，分别为 CIDR 10 . 0 . 3 . 0/24 和 10.0.4.0/24。每个专用子网应该位于不同的 AZ 中。</li><li id="8efe" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">将流量导向公共子网的负载平衡器。</li></ol></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><h2 id="857d" class="kj kk hi bd kl km kn ko kp kq kr ks kt jb ku kv kw jf kx ky kz jj la lb lc ld bi translated">我们开始吧！</h2><h2 id="3870" class="kj kk hi bd kl km kn ko kp kq kr ks kt jb ku kv kw jf kx ky kz jj la lb lc ld bi translated">先决条件:</h2><ul class=""><li id="1674" class="jo jp hi is b it le ix lf jb lg jf lh jj li jn lj ju jv jw bi translated">安装<a class="ae lk" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">地形</a>和<a class="ae lk" href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a></li><li id="14e8" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lj ju jv jw bi translated">GitHub 帐户</li><li id="50aa" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lj ju jv jw bi translated">具有适当权限的 AWS IAM 用户帐户</li><li id="a5b5" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn lj ju jv jw bi translated">首选 IDE(我使用 VS 代码)</li></ul><p id="c1ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第一步:</strong></p><p id="6a05" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">将基础设施创建为代码的最佳实践之一是创建变量文件。</strong></p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="f5d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我已经创建了几个变量，如 AWS 地区，VPC，数据库，负载平衡器。这些变量将在代码的不同部分使用。</p><p id="552c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第二步:</strong></p><p id="9e99" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">创建具有 2 个公共子网和 2 个私有子网的 AWS VPC</strong></p><p id="01d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是创建 VPC 的 Terraform 代码要点，已使用变量引用了“<em class="lr"> cidr_block </em>”:</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="fbf0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是创建两个公共子网的要点:</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="6eeb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是创建互联网网关的要点:</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="ece1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是使用 cidr 10.0.3.0/24 和 10.0.4.0/24 创建两个私有子网的要点</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="73ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第三步:</strong></p><p id="4582" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">创建 AWS RDS MySQL 实例</strong></p><p id="e802" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">以下是创建 RDS 数据库(t2 微型)的代码要点:</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="dd55" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:</strong>当您提供用户名或密码等任何敏感信息时，这些信息应设置为敏感，如上面的“<em class="lr"> variables.tf </em>”文件所示。</p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="1e92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">像这样的敏感信息应该存储在一个名为“<em class="lr"> secret.tfvars </em>”的单独文件中。更多信息可在<a class="ae lk" href="https://learn.hashicorp.com/tutorials/terraform/sensitive-variables" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="e257" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第四步:</strong></p><p id="fcda" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">创建负载平衡器</strong></p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="fb13" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第五步:</strong></p><p id="b284" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">创建一个 main.tf 文件，其中包含提供者列表(在我们的例子中是 AWS)</strong></p><figure class="ll lm ln lo fd ij"><div class="bz dy l di"><div class="lp lq l"/></div></figure><p id="2cd8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第六步:</strong></p><p id="05e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">运行 Terraform 命令创建基础设施</strong></p><p id="827e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建所有必需的文件后，第一步是使用以下命令初始化 terraform 后端:</p><pre class="ll lm ln lo fd ls lt lu lv aw lw bi"><span id="e581" class="kj kk hi lt b fi lx ly l lz ma">terraform init</span></pre><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mb"><img src="../Images/9d42334bd77402c9a2d7ba45c5d95f71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WHqm94B1aFPUaMH3m0_bHw.jpeg"/></div></div></figure><p id="75d3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">运行 terraform validate 以确保您的代码配置有效:</p><pre class="ll lm ln lo fd ls lt lu lv aw lw bi"><span id="3843" class="kj kk hi lt b fi lx ly l lz ma">terraform validate</span></pre><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mg"><img src="../Images/5e0e1949a3b091e5bb066344428d69c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zYIQnLaeJxlWowa2zIxUUA.jpeg"/></div></div></figure><p id="665d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，运行以下命令评估 Terraform 配置-</p><pre class="ll lm ln lo fd ls lt lu lv aw lw bi"><span id="0a9e" class="kj kk hi lt b fi lx ly l lz ma">terraform plan</span></pre><p id="b207" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是可选的，但是我建议运行下面的命令以确保您的格式整洁:</p><pre class="ll lm ln lo fd ls lt lu lv aw lw bi"><span id="c911" class="kj kk hi lt b fi lx ly l lz ma">terraform fmt</span></pre><p id="1c72" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，运行以下命令来应用您的配置-</p><pre class="ll lm ln lo fd ls lt lu lv aw lw bi"><span id="ef0e" class="kj kk hi lt b fi lx ly l lz ma">terraform apply -var-file="secret.tfvars"</span></pre><p id="f2b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我在这里使用标记的原因是，我希望代码使用存储在"<em class="lr"> secret.tfvars </em>"文件中的我的数据库凭证。</p><p id="f424" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果一切运行顺利，没有错误，您应该在控制台中看到类似的结果。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mh"><img src="../Images/15c969db1c6433f97c1dfd313ad7529c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bgslsg0AlemD0aa_039VUA.jpeg"/></div></div></figure><p id="508c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第七步:</strong></p><p id="ff08" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">验证 AWS 控制台中的资源</strong></p><p id="f3d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">VPC:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mi"><img src="../Images/c1f16157ce8aa405f470cae0151323fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FqUdV90y2jSsfEWsRg3vAQ.jpeg"/></div></div></figure><p id="6e0f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">子网:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mj"><img src="../Images/d177479b0e99e963837a92a7ff9c50c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MdQUZy-Dg7ICFASyQfzhxA.jpeg"/></div></div></figure><p id="d197" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">互联网网关:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mk"><img src="../Images/0862764b9681da7335b6a0a24cacdd6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uhVWbbE2wD8pVt-KzoM13A.jpeg"/></div></div></figure><p id="dfa9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">负载平衡器:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es ml"><img src="../Images/5db18ef937f4f4012c29328f21f8724e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*duRZIl2TeQsnje3CMxEA-Q.jpeg"/></div></div></figure><p id="f310" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">数据库:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mm"><img src="../Images/eb7927d921d459face6255a05996186f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TXm-wBon3SkwpcmFTJDC6Q.jpeg"/></div></div></figure><p id="b9b2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">第八步:</strong></p><p id="3cfb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">删除已创建的资源</strong></p><p id="522e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦您完成了资源的创建并验证了它，下一步就是销毁所有创建的资源，以避免 AWS 的任何不必要的费用。请小心使用此命令，因为这将删除您创建的整个基础结构。使用以下命令来执行此操作:</p><pre class="ll lm ln lo fd ls lt lu lv aw lw bi"><span id="82f2" class="kj kk hi lt b fi lx ly l lz ma">terraform destroy -var-file="secret.tfvars"</span></pre><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mn"><img src="../Images/ba9bdf0bab41ca55d3749d6c41561bf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cDhZgHNrEqLytiRrXGtmTA.jpeg"/></div></div></figure><p id="1b8b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">注意:进行修改</strong></p><p id="1339" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在生产环境中工作时，您不必删除整个基础结构。只需修改所需的文件(在这种情况下，我将数据库的存储值从 5 修改为 10)并运行“<em class="lr">terra form plan”</em>。这将显示必要的修改，如下所示:</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mo"><img src="../Images/f1689aad49b8d7071140f4af176f6137.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9HHMPKTwJwpCYh1IlrKN_A.jpeg"/></div></div></figure><p id="8151" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您对修改满意，运行<em class="lr">terra form apply-var-file = " secret . TF vars "</em>刷新状态文件。</p><figure class="ll lm ln lo fd ij er es paragraph-image"><div role="button" tabindex="0" class="mc md di me bf mf"><div class="er es mp"><img src="../Images/4262b3a2980ea52c95e2929beeeecfe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qOPfUXfYfUercE4Ia0E4mg.jpeg"/></div></div></figure><p id="d8ae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">祝贺您</strong>，您已经使用 Terraform 成功创建并部署了一个 2 层架构。</p><p id="4096" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谢谢你看我的文章！！</p></div></div>    
</body>
</html>