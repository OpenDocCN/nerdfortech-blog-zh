<html>
<head>
<title>Redis — Getting Notified When a Key is Expired or Changed</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Redis —在密钥过期或更改时得到通知</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/redis-getting-notified-when-a-key-is-expired-or-changed-ca3e1f1c7f0a?source=collection_archive---------0-----------------------#2021-06-16">https://medium.com/nerd-for-tech/redis-getting-notified-when-a-key-is-expired-or-changed-ca3e1f1c7f0a?source=collection_archive---------0-----------------------#2021-06-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/dc9cfb3e2b5d08cc9fbec64a861e8368.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CegyftyO7KfQ74so"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">布雷特·乔丹(<a class="ae iu" href="https://unsplash.com/photos/LPZy4da9aRo" rel="noopener ugc nofollow" target="_blank">https://unsplash.com/photos/LPZy4da9aRo</a>)的功劳</figcaption></figure><p id="db5a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">你听说过<strong class="ix hj"> Redis Keyspace 通知</strong>吗？也许你们中的大多数人已经熟悉 redis，甚至每天都在使用它，但是你知道如果有一个关键的变化/过期发生，我们可以得到“通知”吗？</p><h1 id="7a8d" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">这是什么键空间通知？</h1><p id="3e94" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">长话短说，这是一种 pubsub 机制，允许您监听 redis 中的数据变化。使用该特性可能会有好处的简单用例，例如，您希望在某些密钥过期时得到通知，您希望监视某个特殊密钥的更改，以及您能想到的任何其他扩展用例。</p><p id="9788" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你想了解更多的细节，你可以访问这个链接</p><div class="kw kx ez fb ky kz"><a href="https://redis.io/topics/notifications" rel="noopener  ugc nofollow" target="_blank"><div class="la ab dw"><div class="lb ab lc cl cj ld"><h2 class="bd hj fi z dy le ea eb lf ed ef hh bi translated">关键空间通知</h2><div class="lg l"><h3 class="bd b fi z dy le ea eb lf ed ef dx translated">重要说明:自 2.8.0 密钥空间通知允许客户端订阅以来，密钥空间通知是一项可用的功能…</h3></div><div class="lh l"><p class="bd b fp z dy le ea eb lf ed ef dx translated">redis.io</p></div></div><div class="li l"><div class="lj l lk ll lm li ln io kz"/></div></div></a></div><h1 id="ff97" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">闲聊够了，这里有一些例子</h1><p id="2841" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">以下是“使用此功能”的步骤:</p><ol class=""><li id="9225" class="lo lp hi ix b iy iz jc jd jg lq jk lr jo ls js lt lu lv lw bi translated">使用 CONFIG SET 命令在 redis.conf /中启用 redis 通知</li><li id="7524" class="lo lp hi ix b iy lx jc ly jg lz jk ma jo mb js lt lu lv lw bi translated">使用确定的密钥模式创建订阅 redis 连接</li></ol><p id="d77a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">关于第 1 点，默认情况下<strong class="ix hj">被禁用</strong>，根据文档，这是由于在启用该功能时使用了一些 CPU 功率。</p><figure class="md me mf mg fd ij er es paragraph-image"><div class="er es mc"><img src="../Images/330a57bb10530f2e213e0237b764a9c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*SC1To8C1EnekmeuAtJeBzg.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">这是我电脑上的例子</figcaption></figure><p id="0f8e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用命令设置要启用的功能</p><blockquote class="mh mi mj"><p id="0921" class="iv iw mk ix b iy iz ja jb jc jd je jf ml jh ji jj mm jl jm jn mn jp jq jr js hb bi translated"><strong class="ix hj">配置设置通知-密钥空间-事件 KEA </strong></p></blockquote><p id="35d2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">KEA 代表什么？它基本上设置了通知大量事件的功能，如列表、集合、散列、排序集合、过期密钥、逐出密钥等，详细信息可以在文档页面上阅读。你可以根据需要配置它，如果你只需要监听列表、散列和过期密钥修改，那么你可以像<strong class="ix hj"> KElhe </strong>那样定义它。</p><figure class="md me mf mg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mo"><img src="../Images/09a2a23f86635e26ea4da78272d50dbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kC1zZSp74f-4j073H9GV1A.png"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">基于文档的片段</figcaption></figure><p id="410c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我们可以使用 PSUBSCRIBE redis 命令来订阅一个模式</p><figure class="md me mf mg fd ij er es paragraph-image"><div class="er es mp"><img src="../Images/1b801ee8ee393e9cbec22290a1ed658d.png" data-original-src="https://miro.medium.com/v2/resize:fit:634/format:webp/1*8NCdl82P4Or8slKe-AfVHw.png"/></div><figcaption class="iq ir et er es is it bd b be z dx translated">PSU subscribe 代表用你想要的模式订阅(<a class="ae iu" href="https://redis.io/commands/psubscribe" rel="noopener ugc nofollow" target="_blank">https://redis.io/commands/psubscribe</a>)</figcaption></figure><p id="aca4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们可以测试一旦密钥被更改/设置/过期，我们的订阅客户端会得到通知。创建一个单独的终端，然后假设我们正在发送这个命令</p><blockquote class="mh mi mj"><p id="b60b" class="iv iw mk ix b iy iz ja jb jc jd je jf ml jh ji jj mm jl jm jn mn jp jq jr js hb bi translated">设置我的密钥 20</p><p id="de8d" class="iv iw mk ix b iy iz ja jb jc jd je jf ml jh ji jj mm jl jm jn mn jp jq jr js hb bi translated">使我的密钥 10 过期</p></blockquote><figure class="md me mf mg fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/4b69bcb43517928c3825286108f6bcb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DtBk0Hy7sMJcXj1cLWICwA.png"/></div></div></figure><p id="7f8b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我把左边分成 3 个部分，这样你可以更容易地看到它。在第一个 SET 命令之后，我们得到了两次通知点<strong class="ix hj">1–4</strong>。我试着一个一个解释。看出来这 4 行(<strong class="ix hj">第一条消息</strong>):</p><p id="8f2d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">1.)p 讯息<br/> 2。)__key*__:* <br/> 3。)__keyspace@0__:mykey <br/> 4。)设置</p><p id="44f8" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当你设置了一个 key，redis 会发布一个 pub sub 消息(点号 1)，带有一种“通道”点号 3(带有<strong class="ix hj"> mykey </strong>是正在更改的 key，我猜 0 是 redis 默认的 DB？)，其中我们得到了自我们听 __key*__:*(订阅模式)以来，点号 4 是命令发生在该键，这是<strong class="ix hj">设置</strong>。</p><blockquote class="mh mi mj"><p id="7efe" class="iv iw mk ix b iy iz ja jb jc jd je jf ml jh ji jj mm jl jm jn mn jp jq jr js hb bi translated">在某种程度上，<strong class="ix hj">的 mykey </strong>已经被<strong class="ix hj">设置</strong>为第一条消息。</p></blockquote><p id="8022" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后找出另外 4 行(<strong class="ix hj">第二条消息</strong> ): <br/> 1。)p 讯息<br/> 2。)__key*__:* <br/> 3。)__keyevent@0__:set <br/> 4。)我的钥匙</p><p id="7424" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它与前一个类似，但我们从不同的角度来看，当我们执行 SET 命令时，redis 还发布了一个针对 key <strong class="ix hj"> mykey </strong> (point 4)的<strong class="ix hj"> set </strong> (point 3)的 pub 子消息“key event”。</p><blockquote class="mh mi mj"><p id="1179" class="iv iw mk ix b iy iz ja jb jc jd je jf ml jh ji jj mm jl jm jn mn jp jq jr js hb bi translated">在某种程度上，<strong class="ix hj"> set </strong>已经在<strong class="ix hj"> mykey </strong>上发生了第二条消息。</p></blockquote><p id="dc85" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">对于 SET 命令，我们得到两个 pub sub 消息(如上),因为我们监听(订阅)了<strong class="ix hj"> __key*__:* </strong>模式。例如，如果我们将订阅模式命令改为<strong class="ix hj"> __keyevent*:* </strong>，那么我们将只获得第二条消息。</p><p id="84a9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最后，留意最后两条信息(两条 1-4 分)。当密钥过期时，我们也会收到相同模式的通知。第一条消息(keyspace)通知<strong class="ix hj"> mykey </strong>是<strong class="ix hj">过期</strong>。而第二条消息表明<strong class="ix hj">到期</strong>事件正在<strong class="ix hj"> mykey </strong>上发生。</p><blockquote class="mh mi mj"><p id="4fd3" class="iv iw mk ix b iy iz ja jb jc jd je jf ml jh ji jj mm jl jm jn mn jp jq jr js hb bi translated"><strong class="ix hj">因此，如果您需要在您的“受监控”密钥更改/过期时得到一些通知，以便您可以在应用程序中进行一些处理，那么尝试考虑 Redis 中的这个密钥空间通知特性会很好。</strong></p></blockquote><h1 id="a533" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">需要关注的事情(必读)</h1><p id="282c" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">虽然这个“特性”对于那些可能需要这样一个用例的人来说似乎很方便。请注意文档中的一些内容:</p><ol class=""><li id="1789" class="lo lp hi ix b iy iz jc jd jg lq jk lr jo ls js lt lu lv lw bi translated">当通知特性打开时，redis 上的 cpu 使用率增加了(我不知道有多少，可能是基于正在发生的许多事件，存在多少个键，等等)，这就是默认配置关闭的原因</li><li id="549c" class="lo lp hi ix b iy lx jc ly jg lz jk ma jo mb js lt lu lv lw bi translated">编程语言对 PSUBSCRIBE 命令的支持可以根据库的不同而不同，几年前我曾尝试使用 Golang redigo，它是受支持的。您可能希望检查您的编程/库对 redis 的客户端订阅/模式的支持</li><li id="ce84" class="lo lp hi ix b iy lx jc ly jg lz jk ma jo mb js lt lu lv lw bi translated">密钥过期不是实时的，虽然如果您在本地(小密钥)上尝试，它看起来像是实时的，但文档中已经说明，由于 redis 过期逻辑，密钥可能不会在过期事件时被实时通知(请阅读文档的<strong class="ix hj">过期事件的定时</strong>部分)</li><li id="ef86" class="lo lp hi ix b iy lx jc ly jg lz jk ma jo mb js lt lu lv lw bi translated">如果您使用 redis 集群，通知事件在每个节点上独立发生，如果您想要在跨节点的所有键上得到通知，您必须监听所有节点(参见文档中的集群中的<strong class="ix hj">事件一节)</strong></li></ol></div></div>    
</body>
</html>