<html>
<head>
<title>ActiveRecord::Enum validation in Rails API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Rails API 中的 ActiveRecord::枚举验证</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/using-activerecord-enum-in-rails-35edc2e9070f?source=collection_archive---------0-----------------------#2021-04-23">https://medium.com/nerd-for-tech/using-activerecord-enum-in-rails-35edc2e9070f?source=collection_archive---------0-----------------------#2021-04-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="519f" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated"><em class="ix"> ActiveRecord::Enum </em>允许您声明一个<strong class="ak"> enum </strong>属性，其中的值映射到数据库中的整数，但是可以通过名称进行查询。</h2></div><p id="c194" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi ju translated">最近，我一直在构建一个 Rails RESTful-API，并在<em class="kh"> ActiveRecord </em>中发现了<code class="du kd ke kf kg b">enum</code>特性。让我们看看你如何使用它。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div class="er es ki"><img src="../Images/0ca45c5194a43747c47cceb2d075e472.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/format:webp/1*xWia5niiH9GMfGZX-Fky4Q.png"/></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">blog_posts 表模式</figcaption></figure><p id="b750" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们将建立一个非常简单的博客应用程序，其中我们有一个 BlogPost 模型来存储帖子。<br/>注意，我们使用<code class="du kd ke kf kg b">int</code>作为<em class="kh">状态</em>属性的数据类型。这是因为<em class="kh"> ActiveRecord::Enum </em>在内部将数据存储为整数，并允许您将它用作字符串。优点包括需要更小的存储空间，更快的查询和索引。</p><p id="8ffb" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们从生成一个仅支持 API 的应用程序开始，并亲自动手:</p><pre class="kj kk kl km fd ku kg kv kw aw kx bi"><span id="f5c7" class="ky kz hi kg b fi la lb l lc ld">rails new blog --api</span></pre><p id="a270" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">为了加快速度，让我们搭建一个资源并运行迁移以将更改应用到数据库:</p><pre class="kj kk kl km fd ku kg kv kw aw kx bi"><span id="adf8" class="ky kz hi kg b fi la lb l lc ld">rails g scaffold BlogPost title content:text state:integer<br/>rails db:migrate</span></pre><p id="f44e" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们将博客模型中的<code class="du kd ke kf kg b">enum</code>添加到<em class="kh">状态</em>中:</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="le lf l"/></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">app/models/blog_post.rb</figcaption></figure><p id="098b" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">不要忘记运行 Rails 服务器<code class="du kd ke kf kg b">rails s</code>。你应该可以通过 http://localhost:3000 访问服务器。</p><p id="d0f5" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">好了，现在让我们试着写一篇博文，看看是否一切都如预期的那样</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lh"><img src="../Images/9dfa0dc8850b8069082246bffdc7d6aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-HPB_Cgp9Hhzj37GwyKaPA.png"/></div></div></figure><p id="3137" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">酷！太好了。✨</p><p id="68e4" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">到目前为止，一切顺利。但是，如果我们试图发送除了为<em class="kh">状态</em>枚举<code class="du kd ke kf kg b">[draft published]</code>定义的值之外的值，会发生什么呢？让我们试一试。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lm"><img src="../Images/86808ca71cf4f442084531b99972bbc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oXQH5mewYFB7VzAKOAzvsQ.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">哦，呸！那是 500 美元。😕</figcaption></figure><p id="a9ac" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">这很奇怪，所以我们来调查一下…</p><p id="684a" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">框架跟踪具有以下对象:</p><pre class="kj kk kl km fd ku kg kv kw aw kx bi"><span id="22d2" class="ky kz hi kg b fi la lb l lc ld">{<br/>   "exception_object_id": 31080,<br/>   "id": 0,<br/>   "trace": "activerecord (6.1.3.1) <br/>             lib/active_record/enum.rb:152:in `assert_valid_value'"<br/>}</span></pre><p id="b2cc" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">阅读<code class="du kd ke kf kg b">lib/active_record/enum.rb</code>源代码，确切地说是<code class="du kd ke kf kg b">assert_valid_value</code>函数定义，我们会发现:</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="le lf l"/></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">源代码复制自<a class="ae lg" href="https://github.com/rails/rails/blob/main/activerecord/lib/active_record/enum.rb#L148-L152" rel="noopener ugc nofollow" target="_blank">https://github . com/rails/rails/blob/main/active record/lib/active _ record/enum . Rb # L148-L152</a></figcaption></figure><p id="c9d8" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">这意味着，只要分配给 enum 属性的值在提供的键中不存在(在我们的例子中是 draft 和 published ),就会引发<em class="kh"> ArgumentError </em>。</p><blockquote class="ln lo lp"><p id="de9c" class="iy iz kh ja b jb jc ij jd je jf im jg lq ji jj jk lr jm jn jo ls jq jr js jt hb bi translated">可以说，rails 团队选择引发<code class="du kd ke kf kg b">ArgumentError</code>而不是验证错误是正确的，因为我们可以完全控制用户可以从单选按钮组中选择什么选项，或者可以在<code class="du kd ke kf kg b">select</code>字段中选择什么选项，所以如果程序员碰巧添加了一个新的单选按钮，而该按钮的值有一个错别字，那么引发一个错误是好的，因为这是一个应用程序错误，而不是用户错误。</p><p id="3dd4" class="iy iz kh ja b jb jc ij jd je jf im jg lq ji jj jk lr jm jn jo ls jq jr js jt hb bi translated">然而，对于 API 来说，这是行不通的，因为我们不再能够控制发送给服务器的值。<br/><br/>—stack overflow<a class="ae lg" href="https://stackoverflow.com/a/37184383/9329261" rel="noopener ugc nofollow" target="_blank">答</a>作者<a class="ae lg" href="https://stackoverflow.com/users/3073313/jay-ar-polidario" rel="noopener ugc nofollow" target="_blank"> Jay-Ar Polidario </a></p></blockquote><p id="2b36" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">那么，我们如何调整这种行为来满足我们的 API 需求呢？</p><p id="3e3f" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们将不得不覆盖 ActiveRecord::Enum 的<code class="du kd ke kf kg b">assert_valid_value</code>的行为。我们将通过从 ActiveRecord::Enum 继承，然后将修复应用到新类中的<code class="du kd ke kf kg b">assert_valid_value</code>来间接完成这个修复。</p><blockquote class="ln lo lp"><p id="83d6" class="iy iz kh ja b jb jc ij jd je jf im jg lq ji jj jk lr jm jn jo ls jq jr js jt hb bi translated">这个解决方案深受这个答案的影响<a class="ae lg" href="https://stackoverflow.com/a/58416806/9329261" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/a/58416806/9329261</a>。</p></blockquote><p id="bc47" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们首先为可验证的枚举类型创建一个类</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="le lf l"/></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">app/types/validatable _ enum _ type . Rb</figcaption></figure><p id="08fb" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">我们将使用<code class="du kd ke kf kg b"><strong class="ja hj"><em class="kh">decorate_attribute_type</em></strong><em class="kh">(column_name, decorator_name, &amp;block)</em></code>。</p><blockquote class="ln lo lp"><p id="38d0" class="iy iz kh ja b jb jc ij jd je jf im jg lq ji jj jk lr jm jn jo ls jq jr js jt hb bi translated">此方法是一个内部 API，用于创建类宏(如 serialize)和功能(如时区感知属性)。</p><p id="e298" class="iy iz kh ja b jb jc ij jd je jf im jg lq ji jj jk lr jm jn jo ls jq jr js jt hb bi translated">用于将属性的类型包装在新类型中。当加载模型的模式时，与 column_name 同名的属性的类型将让位于给定的块。将改为使用该块的返回值。<br/> <br/> —来源:<a class="ae lg" href="https://apidock.com/rails/v6.0.0/ActiveRecord/AttributeDecorators/ClassMethods/decorate_attribute_type" rel="noopener ugc nofollow" target="_blank">https://API dock . com/rails/v 6 . 0 . 0/active record/attribute decorators/class methods/decorate _ attribute _ type</a></p></blockquote><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="le lf l"/></div></figure><p id="ae0f" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">这里，我们允许传递多个枚举来应用所需的行为。对于每个传递的枚举，我们用 ValidatableEnumType 包装它的数据类型，它覆盖了抛出<code class="du kd ke kf kg b">ArgumentError</code>的<code class="du kd ke kf kg b">assert_valid_value</code>。</p><p id="3116" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">现在我们需要在 BlogPost 模型中包含我们的关注点，并将新的行为应用到我们的<em class="kh"> state </em> enum。</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="le lf l"/></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">app/models/blog_post.rb</figcaption></figure><p id="df01" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">让我们重试上一次失败的 POST 请求，创建一个状态无效的 BlogPost，看看是否一切正常</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lt"><img src="../Images/0585bf0f8b8b7dd658346ecff5261ceb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CWnbNaLGYYB7S2DRIn2PGA.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">喔喔喔🎉！</figcaption></figure><p id="9755" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">您可以轻松定制出错时返回的消息</p><figure class="kj kk kl km fd kn"><div class="bz dy l di"><div class="le lf l"/></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">app/models/blog_post.rb</figcaption></figure><p id="808f" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">试一试，看看消息看起来怎么样</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lu"><img src="../Images/52d1f5b89e1914036c005bf49c433758.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FdzuMeXr9vqo6cxSsQ3MnA.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">关于验证错误的自定义消息</figcaption></figure><p id="4e3a" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">好多了，是吧？我们还没完。ActiveRecord::Enum 不仅仅局限于将数据从字符串转换为整数并存储在数据库中。</p><figure class="kj kk kl km fd kn er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lv"><img src="../Images/64f8dccd593f8c2c77492de9effa464e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RVOQTbYCLdXlyBcSha_Olg.png"/></div></div><figcaption class="kq kr et er es ks kt bd b be z dx translated">ActiveRecord::Enum 的用法</figcaption></figure><p id="fb02" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">您将获得以下功能:</p><ul class=""><li id="af17" class="lw lx hi ja b jb jc je jf jh ly jl lz jp ma jt mb mc md me bi translated">使用范围按提供的值进行查询(例如:BlogPost.draft)</li><li id="ca74" class="lw lx hi ja b jb mf je mg jh mh jl mi jp mj jt mb mc md me bi translated">更新记录的枚举值(例如:BlogPost.pubilshed！)</li><li id="9e7f" class="lw lx hi ja b jb mf je mg jh mh jl mi jp mj jt mb mc md me bi translated">检查枚举值的相等性(例如:BlogPost.published？)</li></ul><p id="d1ac" class="pw-post-body-paragraph iy iz hi ja b jb jc ij jd je jf im jg jh ji jj jk jl jm jn jo jp jq jr js jt hb bi translated">你可以在下面的 GitHub 库中找到我们写的源代码。<a class="ae lg" href="https://github.com/kerolloz/active-record-enum-example" rel="noopener ugc nofollow" target="_blank">https://github.com/kerolloz/active-record-enum-example</a></p></div></div>    
</body>
</html>