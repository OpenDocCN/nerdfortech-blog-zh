<html>
<head>
<title>AWS Knowledge Series — OCR with AWS Lambda &amp; Tesseract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS知识系列—带AWS Lambda &amp; Tesseract的OCR</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/aws-knowledge-series-ocr-with-aws-lambda-tesseract-b0daeb2fd8fa?source=collection_archive---------3-----------------------#2021-06-19">https://medium.com/nerd-for-tech/aws-knowledge-series-ocr-with-aws-lambda-tesseract-b0daeb2fd8fa?source=collection_archive---------3-----------------------#2021-06-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/b671ae9ef7d16329946f2771fe7e6348.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZzTSYeY4d8KaiL2LQ8Epyw.jpeg"/></div></div></figure><p id="6eb8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当今世界，你的平台/服务/应用拥有正版注册用户很重要。当人们知道平台上的其他用户也是像他们一样的真正用户时，它会增加你的产品的信任度。虽然有许多方法可以确保清除机器人和冒名顶替，但一种流行的方法是确保用户在手持包含随机文本的标语牌时给自己拍照。这种随机文本会在用户登录或个人资料验证过程中显示给用户。重要的是，只允许用户使用他们当前设备的相机拍照，而不要从设备磁盘或相册中选择图片。这大大减少了伪造的机会。如果你曾经用Zerodha创建了一个投资者账户，你会在注册过程中上传你的个人资料图片，并附上一张随机数字的海报。为了验证个人资料，后端服务需要检查用户拍摄和上传的照片是否包含在入职/个人资料验证工作流程中向用户显示的随机文本。这需要后端服务对上传的图片进行光学字符识别。AWS提供了一个非常易于使用的OCR APIs，作为AWS Rekognition服务的一部分。然而，AWS重新识别的成本非常高——处理100万张图像将花费您1000美元！在本文中，我将向您展示如何在AWS Lambda中使用Google的开源OCR库Tesseract来执行OCR。</p><h1 id="31f5" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">什么是宇宙魔方？</strong></h1><p id="f907" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">宇宙魔方(【https://opensource.google/projects/tesseract】T2)是一个用于各种操作系统的光学字符识别引擎。它由惠普开发，并于2005年开源。它的开发一直由谷歌赞助。它可以识别100多种语言。它为各种支持的语言提供了两种语言训练模型——FAST和BEST。Tesseract是一个可执行文件，可以读取各种图像文件类型(JPEG，PNG，TIFF等。)并读取图像文件中的文本。</p><h1 id="cba6" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">剖面验证工作流程</strong></h1><p id="f420" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们将构建以下工作流。本练习的目的是展示如何在AWS Lambda中使用tesseract，而不是获得一个功能完善的概要文件验证工作流！</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div class="er es ks"><img src="../Images/d8e31ee0296953b6e80336afbe2e7910.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*u_BawI5c1bKAs50bo5hlbg.jpeg"/></div></figure><h1 id="352a" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">获取AWS Lambda的宇宙魔方</strong></h1><p id="f0eb" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">AWS Lambda虚拟机在AWS Linux上运行，因此我们需要一个为AWS Linux构建的Tesseract可执行文件/库。幸运的是，Benjamin Genz(GitHub:<a class="ae kr" href="https://github.com/bweigel," rel="noopener ugc nofollow" target="_blank">https://github.com/bweigel,</a>Twitter—【https://twitter.com/dreigelb】T2)已经完成了这项艰巨的工作，可以在GitHub上下载。他还记录了如何使用Docker为AWS Linux创建Tesseract版本。从这里下载预建的Tesseract二进制文件和库—<a class="ae kr" href="https://github.com/bweigel/aws-lambda-tesseract-layer/tree/master/ready-to-use/amazonlinux-2" rel="noopener ugc nofollow" target="_blank">https://github . com/bweigel/AWS-lambda-tessera CT-layer/tree/master/ready-to-use/Amazon Linux-2</a></p><h1 id="8212" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak"> Tesseract、NodeJS和AWS Lambda VM </strong></h1><p id="60c2" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们的Lambda将为NodeJS 12.x运行时构建。Node-tesserac-ocr NodeJS模块使用子流程NodeJS模块包装tesserac可执行文件，并公开一个易于使用的节点API，我们可以在lambda函数中使用它。然而，node-tesseract-ocr模块期望在NodeJS代码执行的环境中安装并使用tesseract。因此，我们需要能够在执行Lambda代码的虚拟机中执行tesseract可执行文件。那么如何从Lambda执行可执行文件呢？嗯这是在这里描述的—<a class="ae kr" href="https://aws.amazon.com/blogs/compute/running-executables-in-aws-lambda/." rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/compute/running-executables-in-AWS-lambda/。我们必须将tesseract可执行文件及其库与Lambda函数代码捆绑在一起。默认情况下，Lambda VM可执行文件位于/opt/bin中——但是我们打包的tesseract没有Lambda代码，那么我们如何使可执行文件和库在PATH中可用，以便它可以被执行呢？答案很简单——修改环境变量！这里有一篇文章描述了Lambda VM的各种环境变量是什么—</a><a class="ae kr" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html." rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/Lambda/latest/DG/configuration-env vars . html .</a>有两个感兴趣的环境变量:</p><p id="2d93" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> PATH </strong> —我们必须修改PATH环境变量，以便tesseract可执行文件在VM路径中可用。</p><p id="5876" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> LD_LIBRARY_PATH </strong> —这是指向可以动态加载的库模块的路径。所以我们必须修改它，以确保tesseract可执行文件使用的所有同步模块都可以在这个路径中使用。</p><h1 id="6416" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">λ函数</strong></h1><p id="a73d" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们需要写两个Lambda函数。第一个用于生成我们需要显示给用户的随机6位数。在这个示例中，所有的API都是未经认证的，但是在生产中，您将只允许注册用户调用这个API函数。</p><h2 id="5a03" class="kx jp hi bd jq ky kz la ju lb lc ld jy jb le lf kc jf lg lh kg jj li lj kk lk bi translated"><strong class="ak"> Lambda函数—生成配置文件ID和随机数</strong></h2><p id="46de" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">该功能执行以下任务:</p><ul class=""><li id="1952" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">生成要用作配置文件ID的UUID。在实际应用中，这将是用户的身份ID。</li><li id="8bc0" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">生成一个随机的6位数</li><li id="f9b9" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">将配置文件ID和随机数字作为JSON对象保存在S3桶中，以备将来使用。在实际应用中，根据您的架构，您可以将它存储在S3、DynamoDB或RDS DB中。我们的想法是，当用户给我们发送图片时，我们应该能够检索这些信息，以便我们可以进行比较。</li><li id="56c5" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">向客户端发送配置文件ID和随机数。</li></ul><h2 id="fc92" class="kx jp hi bd jq ky kz la ju lb lc ld jy jb le lf kc jf lg lh kg jj li lj kk lk bi translated"><strong class="ak"> Lambda函数—获取配置文件验证状态</strong></h2><p id="84a4" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">这个函数做了一些假设:</p><ul class=""><li id="4d09" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">用户必须调用生成配置文件ID和随机数API</li><li id="fd4b" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">用户必须已将带有随机数的个人资料图片上传到S3桶</li><li id="5b93" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">配置文件图片文件的名称必须是配置文件ID，以便我们可以定位和加载它</li></ul><p id="2965" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个函数需要访问为AWS Linux编译的Tesseract可执行文件和库模块。因此，Lambda的文件夹结构必须配置如下:</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lz"><img src="../Images/97b4bfe6ac73a65f232f981b23bea142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d59QOx-jvBMsj5L8am-h-w.png"/></div></div></figure><p id="0d91" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在上面看到，宇宙魔方二进制文件位于子文件夹“宇宙魔方”中。</p><p id="84d7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> bin </strong> —这个文件夹包含宇宙魔方可执行文件</p><p id="5aef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> lib </strong> —该文件夹包含tesseract使用的动态库</p><p id="2a21" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">tesseract/share/Tess data</strong>—该文件夹包含tesserac t使用的训练模型数据。我们将使用快速版本的训练数据模型，因为它的大小更小，对于我们的用例来说足够准确。</p><p id="991f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面的代码确保VM环境变量按照上面“Tesseract，NodeJS和AWS Lambda VM”一节中的讨论进行修改。</p><pre class="kt ku kv kw fd ma mb mc md aw me bi"><span id="4907" class="kx jp hi mb b fi mf mg l mh mi">// Inspired by <a class="ae kr" href="https://aws.amazon.com/blogs/compute/running-executables-in-aws-lambda/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/blogs/compute/running-executables-in-aws-lambda/</a><br/>// to make sure that tesseract executable and libraries are available<br/>// in path</span><span id="711c" class="kx jp hi mb b fi mj mg l mh mi">const lambdaPath = process.env["LAMBDA_TASK_ROOT"];<br/>const libPath = process.env["LAMBDA_TASK_ROOT"] + "/tesseract/lib";<br/>const binPath = process.env["LAMBDA_TASK_ROOT"] + "/tesseract/bin";</span><span id="9aac" class="kx jp hi mb b fi mj mg l mh mi">const dataPath = process.env["LAMBDA_TASK_ROOT"] + "/tesseract/tesseract/share/tessdata";</span><span id="fb14" class="kx jp hi mb b fi mj mg l mh mi">// Add the tesseract in pathprocess.env["PATH"] = process.env["PATH"] + ":" + lambdaPath + ":" + binPath + ":" + libPath;</span><span id="1cbf" class="kx jp hi mb b fi mj mg l mh mi">// Add path to libraries required by teserract<br/>process.env["LD_LIBRARY_PATH"] = process.env["LD_LIBRARY_PATH"] + ":" + lambdaPath + ":" + binPath + ":" + libPath;</span><span id="fca8" class="kx jp hi mb b fi mj mg l mh mi">// Path where the training data is located - "fast" training data for english is used in this sample.<br/>process.env["TESSDATA_PREFIX"] = dataPath;</span></pre><p id="29c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">lambda函数加载用户上传的图像文件以及包含从S3发送到客户端的随机代码的JSON文件。使用node-tesseract-ocr模块，我们调用tesseract识别从图像文件中提取文本，并将其与发送给客户端的内容进行比较，以确定用户配置文件的验证状态。</p><h1 id="fe2a" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">提高文本识别的速度/准确性</strong></h1><p id="0e12" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">您可以做各种事情来提高文本识别的准确性。</p><ul class=""><li id="854b" class="ll lm hi is b it iu ix iy jb ln jf lo jj lp jn lq lr ls lt bi translated">按照这里的建议执行图像处理—<a class="ae kr" href="https://tesseract-ocr.github.io/tessdoc/ImproveQuality.html#image-processing" rel="noopener ugc nofollow" target="_blank">https://tesserac-ocr . github . io/Tess doc/improve quality . html #图像处理</a>。您可以使用sharp库执行一些图像处理功能。</li><li id="d765" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">因为我们知道我们发送的是一个随机的6位数字，这就是我们期望出现在图像文件中的数字，所以我们可以提供一个模式文件，指示我们应该寻找6位数字。参见Lambda代码库中的pattern.txt文件和本文—<a class="ae kr" href="https://tesseract-ocr.github.io/tessdoc/ImproveQuality.html#dictionaries-word-lists-and-patterns" rel="noopener ugc nofollow" target="_blank">https://tesserac-ocr . github . io/Tess doc/improve quality . html # dictionary-word-lists-and-patterns</a></li><li id="6644" class="ll lm hi is b it lu ix lv jb lw jf lx jj ly jn lq lr ls lt bi translated">为了提高准确性，您还可以使用最佳训练模型，而不是快速训练模型。然而，这将增加Lambda代码包的大小，并且识别速度将比使用FAST慢。</li></ul><h1 id="0a54" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated"><strong class="ak">实现&amp;测试</strong></h1><p id="c952" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">完整的样本可以在GitHub这里找到——https://github.com/santhedan/ocrsample<a class="ae kr" href="https://github.com/santhedan/ocrsample" rel="noopener ugc nofollow" target="_blank"/></p><p id="5e18" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">可以使用testprofile.js NodeJS脚本测试整个工作流。它使用文本到图像的sharp NodeJS模块来合成带有随机6位数的图像。</p></div></div>    
</body>
</html>