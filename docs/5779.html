<html>
<head>
<title>Replacing case_when() with joins in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用 R 中的连接替换 case_when()</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/replacing-case-when-with-joins-in-r-76db708b17f4?source=collection_archive---------3-----------------------#2021-11-15">https://medium.com/nerd-for-tech/replacing-case-when-with-joins-in-r-76db708b17f4?source=collection_archive---------3-----------------------#2021-11-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="2a35" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我曾经发现自己编写了大量的<code class="du jd je jf jg b">ifelse()</code>或<code class="du jd je jf jg b">case_when()</code>语句来重新编码值或创建新列——直到有人告诉我可以使用 join 来代替。</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div class="er es jh"><img src="../Images/3bcc1f2d41c6272f97222b8a7642b48c.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/0*Oc9tLmSiznLwh_o3"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">case_when()的概念图</figcaption></figure><h1 id="b3c2" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">如何用连接替换 case_when()的示例。</h1><p id="cdf2" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">让我们在 R 中使用一个公共数据集:</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div class="er es kw"><img src="../Images/4e4a594cc8d986e8a0bc5b3a49cf2a27.png" data-original-src="https://miro.medium.com/v2/resize:fit:540/format:webp/1*5_fOCo5uHdIuV-oGR6goGA.png"/></div><figcaption class="jp jq et er es jr js bd b be z dx translated">使用攻击和城市人口列的美国记录</figcaption></figure><p id="f526" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过运行一个快速的最小/最大集合函数，我们可以看到最小攻击是<code class="du jd je jf jg b">45</code>，最大攻击是<code class="du jd je jf jg b">337.</code></p><p id="ddeb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">假设我们想要创建一个新的列来表示大量的攻击:高攻击、中高、中、中低和低攻击？</p><p id="fc14" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以做一个<code class="du jd je jf jg b">case_when()</code> …</p><pre class="ji jj jk jl fd kx jg ky kz aw la bi"><span id="d3ed" class="lb ju hi jg b fi lc ld l le lf">USArrests %&gt;%<br/>  mutate(buckets = case_when(Assault &gt;= 300 ~ "High",<br/>                      Assault &lt; 300 &amp; Assult &gt;= 250 ~ "High-Medium",<br/>                      Assault &lt; 250 &amp; Assult &gt;=200 ~ "Medium",<br/>                      Assault &lt; 200 &amp; Assult &gt;=150 ~ "Medium-Low",<br/>                      Assault &lt; 150 ~ "Low"))<br/></span></pre><p id="8326" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它可以工作，但是很快就变得很麻烦，我不认为这是优化。相反，我们可以创建一个引用表，然后使用一个<code class="du jd je jf jg b">fuzzy_join()</code>。你也可以用<code class="du jd je jf jg b">left_join()</code>来做这件事，但是我认为<code class="du jd je jf jg b">fuzzy_join</code>是最好的选择，所以我将展示它。</p><p id="b31a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lg">注:如果我有几个类别，我就只做一个</em> <code class="du jd je jf jg b"><em class="lg">case_when()</em></code> <em class="lg">或者</em> <code class="du jd je jf jg b"><em class="lg">if_else()</em></code> <em class="lg">。为了简单起见，我举了一个包含几个类别的例子。我也很喜欢使用其他函数的连接来创建引用表，我会用它来创建多个数据集，而不是复制大型的</em> <code class="du jd je jf jg b"><em class="lg">case_when()</em></code> <em class="lg">或</em> <code class="du jd je jf jg b"><em class="lg">if_else()</em></code> <em class="lg">语句。</em></p><figure class="ji jj jk jl fd jm er es paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="er es lh"><img src="../Images/ad9e601f53a8cd34c66f42f96faa58f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TVuede9yQfsbkPwP.png"/></div></div><figcaption class="jp jq et er es jr js bd b be z dx translated">fuzzy_join()的一般示例</figcaption></figure><h1 id="7846" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">fuzzyjoin::fuzzy_join()</h1><p id="6b95" class="pw-post-body-paragraph if ig hi ih b ii kr ik il im ks io ip iq kt is it iu ku iw ix iy kv ja jb jc hb bi translated">创建参考数据框:</p><pre class="ji jj jk jl fd kx jg ky kz aw la bi"><span id="68dd" class="lb ju hi jg b fi lc ld l le lf">ref.df &lt;- data.frame(<br/>             bucket = c(“High”, “Medium-High”, “Medium-Low”, “Low”),<br/>             value.high = c(max(USArrests$Assault), 249, 199, 149),<br/>             value.low = c(250, 200, 150, min(USArrests$Assault)))</span></pre><p id="54a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面，我知道我想要高低桶来分别包括最大和最小攻击。为了使用硬编码值的例子，我只是创建了随机桶。</p><p id="6866" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">接下来，使用<code class="du jd je jf jg b">fuzzy_join()</code>匹配您的高值和低值之间的值:</p><pre class="ji jj jk jl fd kx jg ky kz aw la bi"><span id="4c56" class="lb ju hi jg b fi lc ld l le lf">USArrests %&gt;% <br/>  fuzzy_join(ref.df, <br/>                    by = c("Assault"="value.low",<br/>                           "Assault" = 'value.high'), <br/>             match_fun = c(`&gt;=`,`&lt;=`)) %&gt;% <br/>  select(-c(value.high, value.low))</span></pre><h2 id="095d" class="lb ju hi bd jv lm ln lo jz lp lq lr kd iq ls lt kh iu lu lv kl iy lw lx kp ly bi translated">fuzzy_join()逐行:</h2><ol class=""><li id="df1d" class="lz ma hi ih b ii kr im ks iq mb iu mc iy md jc me mf mg mh bi translated">在您要加入的数据帧中加入管道(主 df)</li><li id="859d" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">调用函数并输入参考数据帧</li><li id="e1d6" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">我们要匹配低(<code class="du jd je jf jg b">value.low</code>)和高(<code class="du jd je jf jg b">value.high</code>)。</li><li id="1472" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">接下来，<code class="du jd je jf jg b">match_fun()</code>会告诉 R 你想要如何匹配每一个。<code class="du jd je jf jg b">match_fun()</code>中的第一个参数与<code class="du jd je jf jg b">by = c()</code>中的第一个参数一致，第二个参数与<code class="du jd je jf jg b">by = c()</code>中的第二个参数一致。我在这里做的是说:匹配如果<code class="du jd je jf jg b">Assault</code>大于或等于(<code class="du jd je jf jg b">≥</code>)到<code class="du jd je jf jg b">value.low</code> <strong class="ih hj">，如果</strong> <code class="du jd je jf jg b">Assault</code>小于或等于(<code class="du jd je jf jg b">≤</code>)到<code class="du jd je jf jg b">value.high</code>。<code class="du jd je jf jg b">match_fun()</code>接受任何逻辑运算符。如果这很混乱，你可以把它想象成<code class="du jd je jf jg b">between()</code>。。</li><li id="21ba" class="lz ma hi ih b ii mi im mj iq mk iu ml iy mm jc me mf mg mh bi translated">最后，我使用<code class="du jd je jf jg b">select(-c)</code>从最终的数据帧中删除了不必要的列。</li></ol><p id="81fd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">结果是:</p><figure class="ji jj jk jl fd jm er es paragraph-image"><div class="er es mn"><img src="../Images/7935133474d5039f8f4180f7c4dcec52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/format:webp/1*wbiu2bFGlkFMkAnLVEIzWw.png"/></div></figure><p id="3f39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有的方法都可以让你得到相同的结果，并有他们的位置。对于我想重用的许多类别(与示例不同)或代码，我倾向于使用<code class="du jd je jf jg b">fuzzy_join()</code>选项，因为在我看来，它更具可伸缩性，更容易出错。</p><p id="d257" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的 Github 上，我还有其他关于如何使用日期的例子。</p></div></div>    
</body>
</html>