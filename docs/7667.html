<html>
<head>
<title>Slack integration and posting chat messages using OAuth2 in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Slack 集成和在 Node.js 中使用 OAuth2 发布聊天消息</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/slack-integration-and-posting-chat-messages-using-oauth2-in-node-js-758af767330f?source=collection_archive---------1-----------------------#2022-12-26">https://medium.com/nerd-for-tech/slack-integration-and-posting-chat-messages-using-oauth2-in-node-js-758af767330f?source=collection_archive---------1-----------------------#2022-12-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/1eeee94b79f11edf70a963172b57737f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pej4em0GV-HJAg0P0Ihjhw.png"/></div></div></figure><p id="3621" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">OAuth 2.0 是一种协议，允许您的应用程序请求授权来访问用户 Slack 帐户中的私人详细信息，而无需获得他们的密码。</p><p id="b1e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">通常，OAuth 2.0 最常用的流程分为三个主要步骤:</p><ol class=""><li id="22db" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">应用程序为第三方授权应用程序弹出一个新窗口，要求用户(必须拥有帐户并登录系统)授予您的应用程序权限，然后能够代表他/她采取行动。</li><li id="a8f9" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">经过正确的身份验证和授权后，第三方应用程序会确认权限，并通过预先配置的 URL 将用户重定向到您的应用程序。</li><li id="0e52" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">您的应用程序为此类回调操作公开一个端点。它访问第三方提供者 API，根据前面重定向过程返回的响应代码请求一个访问令牌。</li></ol><p id="93a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">环境设置</strong></p><p id="7ccf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于本文，我将使用<a class="ae kc" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>和<a class="ae kc" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> npm </a>作为默认的包管理器。这里我将创建两个不同的应用程序，一个用于客户端(在 React 中),另一个用于服务器功能。</p><p id="4d93" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">松弛应用配置</strong></p><p id="9827" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里我们使用了<a class="ae kc" href="https://api.slack.com/" rel="noopener ugc nofollow" target="_blank"> Slack OAuth2 API </a>，它允许您在自己的帐户下创建一个应用程序，并为您提供一些 OAuth2 客户端凭据，以便在其他应用程序中使用。</p><p id="c4ef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这样，您可以轻松地允许应用程序的用户通过他们的 Slack 帐户登录。</p><p id="e633" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以，让我们通过点击这个<a class="ae kc" href="https://api.slack.com/apps?new_app" rel="noopener ugc nofollow" target="_blank">链接</a>来创建一个新的应用程序。确保在所有字段中填写应用程序名称和用于开发应用程序的工作空间。</p><p id="fa8a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后进入基本信息部分。您将找到带有客户端 ID 和客户端密码的应用程序凭据。接下来，转到 OAuth &amp; Permissions 并添加重定向 URL。授权回调 URL 是最重要的字段，因为它界定了一旦授权过程完成，Slack 应该将用户重定向到哪里。</p><p id="bafc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以在这里输入任何您喜欢的 URL，如下图所示。</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kd"><img src="../Images/4e3bc9ceb954c4dddf96608efa5da886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IT6qdkNwxTwZPQw2NL8_Xg.png"/></div></div></figure><p id="506c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，您需要添加范围来指示您的应用程序可以访问的内容。</p><p id="5eb2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里的 bot 令牌作用域中，我添加了如下所示的权限。</p><p id="d02f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kc" href="https://api.slack.com/scopes/channels:history" rel="noopener ugc nofollow" target="_blank">频道:历史</a>-查看已添加应用的公共频道中的消息和其他内容</p><p id="2a1b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kc" href="https://api.slack.com/scopes/channels:manage" rel="noopener ugc nofollow" target="_blank">频道:管理</a>-管理已添加应用的公共频道，并创建新频道</p><p id="fda5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kc" href="https://api.slack.com/scopes/chat:write" rel="noopener ugc nofollow" target="_blank">聊天:写</a>-以 TestApp 的身份发送消息</p><p id="5c20" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kc" href="https://api.slack.com/scopes/groups:write" rel="noopener ugc nofollow" target="_blank">群组:编写</a>-管理已添加应用的私人频道并创建新频道</p><p id="9346" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kc" href="https://api.slack.com/scopes/im:write" rel="noopener ugc nofollow" target="_blank">即时消息:编写</a>-开始与人直接通信</p><p id="50f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae kc" href="https://api.slack.com/scopes/mpim:write" rel="noopener ugc nofollow" target="_blank"> mpim:编写</a>-开始与人群发直接消息</p><p id="3431" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">服务器项目</strong></p><p id="54b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们回到项目创建。选择一个文件夹并运行以下命令:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="227c" class="kn ko hi kj b be kp kq l kr ks">mkdir oauth2-node-server<br/>cd oauth2-node-server<br/>npm init</span></pre><p id="aafa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同样，把所有的选项留到最后。然后，运行以下命令安装所需的 NPM 依赖项:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="c357" class="kn ko hi kj b be kp kq l kr ks">npm install axios express cors</span></pre><p id="d40d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="kt"> Axios </em>将用于向 Slack OAuth2 服务器发出 HTTP 请求调用。<em class="kt"> Express </em>将是我们的服务器版本，<em class="kt"> cors </em>只是为了避免与浏览器的<em class="kt">同源</em>策略冲突。</p><p id="73a3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">服务器的代码非常简单，可以在下面的代码中找到。确保将其添加到名为<em class="kt"> index.js </em>的文件中:</p><figure class="ke kf kg kh fd ij"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="8693" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里，从<code class="du kw kx ky kj b"><em class="kt">/oauth/redirect</em></code> <em class="kt"> </em>端点<em class="kt"> </em>您将获得一个有效的访问令牌，然后我们可以将响应及其所有内容重定向到监听端口 3000 的 React 客户端应用程序。</p><p id="3397" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在进入下一部分之前，通过运行以下命令确保一切正常:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="fc33" class="kn ko hi kj b be kp kq l kr ks">node index.js</span></pre><p id="c345" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这又会产生如下所示的输出:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="f96c" class="kn ko hi kj b be kp kq l kr ks">➜ Listening at port 8080</span></pre><p id="99cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">客户项目</strong></p><p id="5232" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">离开当前服务器文件夹，运行以下命令创建客户端项目:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="3450" class="kn ko hi kj b be kp kq l kr ks">npx create-react-app oauth2-node-app</span></pre><p id="a81f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后，运行以下命令添加所需的节点依赖关系:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="f213" class="kn ko hi kj b be kp kq l kr ks">npm install axios</span></pre><p id="b004" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后用以下内容替换您的<em class="kt"> App.js </em>文件内容:</p><figure class="ke kf kg kh fd ij"><div class="bz dy l di"><div class="ku kv l"/></div></figure><p id="861a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">测试</strong></p><p id="c494" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要测试客户端实现，您可以在客户端的根文件夹中运行以下命令:</p><pre class="ke kf kg kh fd ki kj kk bn kl km bi"><span id="b365" class="kn ko hi kj b be kp kq l kr ks">npm start</span></pre><p id="45ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在日志中查找错误，并等待 React 在您的 web 浏览器上加载应用程序。</p><p id="d2b4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在按钮中，您可能会看到带有<em class="kt">符号的以下屏幕。在点按它之前，请确保 server 应用程序和代理都已启动。</em></p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kz"><img src="../Images/b071e2f771dde842dec34ffd9d0d627a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-3EijoLCU2fvXpV0hRRDIQ.png"/></div></div></figure><p id="0f5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<em class="kt">登录</em>按钮后，您将被重定向到 Slack 授权页面，如下图所示。</p><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es la"><img src="../Images/25e799a9dc4e10637af7b4b49486ae65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BAD5R1HN3oSM_xpJmhA5iw.png"/></div></div></figure><p id="4872" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击<em class="kt"> Authorize </em>按钮，Slack 也会在重定向过程完成后处理它，您将获得一个访问 slack APIs 的访问令牌。因此，这个访问令牌称为承载令牌，我们可以使用这个令牌调用 API 方法来创建通道，并使用下面的 API 向通道发布消息，您可以在上面代码的服务器项目中看到这些 API。</p><p id="4f86" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1 .conversations.create API 创建通道</p><p id="7ba4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2 .chat.postMessageAPI 发布聊天消息。</p><p id="5b22" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢您的阅读！</p></div></div>    
</body>
</html>