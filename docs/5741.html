<html>
<head>
<title>Wallstreetbets Sentiment Analysis Part 2: Predicting the Stock Market</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">华尔街投资者情绪分析第二部分:预测股票市场</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/wallstreetbets-sentiment-analysis-part-2-predicting-the-stock-market-895422c172a7?source=collection_archive---------1-----------------------#2021-11-10">https://medium.com/nerd-for-tech/wallstreetbets-sentiment-analysis-part-2-predicting-the-stock-market-895422c172a7?source=collection_archive---------1-----------------------#2021-11-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="fd1e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated">以前，在华尔街的情绪分析上，我从情绪提取和数据库开发开始了这个项目。关于这个项目是如何建设的详细分析，见本系列的<a class="ae jm" rel="noopener" href="/nerd-for-tech/wallstreetbets-sentiment-analysis-on-stock-prices-using-natural-language-processing-ed1e9e109a37">第一部分。以下是关于数据库生态系统的详细信息:</a></p><ol class=""><li id="0c64" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">数据:来自4个子主题的情绪得分，关于公司业绩的信息(净收益利润率，债务股本比，等等。)，以及价格变动(调整后收盘)。</li><li id="59ec" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated">数据被编译成CSV文件，然后存储在PostgreSQL数据库中。我发现从CSV文件进行研究更容易。存储在PostgreSQL中提供了额外的安全层，以防CSV文件发生问题。</li></ol><p id="2fad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我最终得到了大约1300行数据。我们试图预测价格的走向，而不是价格本身。所以这是一个编码如下的多分类问题(0 =不运动，1 =向上运动，2 =向下运动)。</p><p id="ab4b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在深入讨论实际模型之前，我们需要讨论所有重要的数据清理和处理。</p></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="1b60" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">清理数据</strong></p><p id="453a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">清理数据对于建模过程至关重要。虽然我会将代码发布到清理过程中，但是更详细的解释可以在<a class="ae jm" href="https://github.com/mdominguez2010/wsb-sentiment-analysis" rel="noopener ugc nofollow" target="_blank"> GitHub Repo </a>中找到。我采取了以下步骤来去除数据中的不一致和噪音:</p><ol class=""><li id="ee7b" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">删除重复的列。如果我们更深入地研究包含股息信息的列，我们会发现有重复的列。</li></ol><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="8631" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.正在删除标识符。这些列中的信息是标识符、重复项或空项。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="2114" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.删除具有1个唯一值的列，这可能不会增加可预测性。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="823b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">使用Alpha Vantage API引入价格数据</strong></p><p id="ba27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在我们有了过去6个月的情绪数据，让我们同步每天的情绪数据，以填补任何时间缺口。这样，我们可以计算1天、2天和5天的回报。</p><p id="be42" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">代码有点多，所以我就把它放在这里。不复杂，但是很多。如果您对代码有任何疑问，请联系我。</p><p id="b00c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这一次，我将使用的API是Alpha Vantage，与上一篇文章不同。这里有一个链接指向Alpha Vantage的API文档。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="4d6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结果</strong></p><p id="acb9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不再赘述，让我们看看结果:</p><p id="d1ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">多级模型的ROC-AUC</em>。类别1和类别2的ROC曲线下的区域(分别为橙色和蓝色实线)是这里的焦点。他们各自的面积是0.56和0.57。将图表对角分成两半的黑色虚线的曲线下面积为0.50(即:随机选择方向的概率)。总体而言，该模型预测类别1(股价上涨)的正确率为56%，预测类别2(股价下跌)的正确率为57%。这些结果充其量是平庸的，但这是一个开始。目标是逐步提高准确率到70%-80%左右。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kq"><img src="../Images/c738ee859bc456280e70126bff7e6790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KKp9hEaHygHBoVeh4EHhCA.png"/></div></div></figure><p id="6d59" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">精度&amp;召回分数</em> : 0.57。原始分数为0.54，但在对少数类(0)进行过采样后，分数略有增加。</p><p id="e37d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">混乱矩阵</em>。如你所见，超过一半的预测被正确分类。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kx"><img src="../Images/ddad80e68d5f651bb928522970ee2987.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*8feSe2qgVUheg_5FAD5EXQ.png"/></div><figcaption class="ky kz et er es la lb bd b be z dx translated">1.0 =股价上涨，2.0 =股价下跌</figcaption></figure></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="bdff" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">模型解释</strong></p><p id="2b9d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最终模型是正则化梯度推进模型。XGBoost 是一个很棒的开源软件库，用于指导这些模型。</p><p id="828d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">检查特征并考虑为什么模型预测它所预测的东西是很重要的。每个特征对最终预测和平均预测之间的差异有多大贡献？回答这些问题可以让我们在单个特征层面上充分理解模型。为了实现这一点，我们将使用SHAP价值观来解释我们的模型。</p><p id="87a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">简而言之，SHAP (Shapley附加解释)值有助于回答这个问题:“当从模型中移除特征<em class="kp"> j </em>时，预测<em class="kp"> i </em>如何变化？”要深入分析什么是SHAP值以及如何计算它们，请查看Khuyen Tran的文章<a class="ae jm" href="https://towardsdatascience.com/shap-explain-any-machine-learning-model-in-python-24207127cad7" rel="noopener" target="_blank"> SHAP:用Python解释任何机器学习模型</a>。</p><p id="bc31" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp"> SHAP总结剧情</em>。看来“报价时间”对股价是上涨、下跌还是保持中性有最大的影响。此图显示了主要要素及其对正类数据集的影响范围(价格变动增加)。以下是我们可以从这幅图中获得的一些见解:</p><ul class=""><li id="1191" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc lc jt ju jv bi translated">随着“quotetimeinlong”的增加，股票不太可能增加</li><li id="dfc0" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc lc jt ju jv bi translated">随着“贝塔”的增加，股票不太可能增加</li><li id="33d9" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc lc jt ju jv bi translated">随着“看跌”情绪的增加，该股不太可能上涨</li></ul><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es ld"><img src="../Images/523ecea0393c57b36b6cf1fb7fe262d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1234/format:webp/1*Uu2DcirEQq3HDogOA5k-JA.png"/></div></figure><p id="f72c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp">平均重要性条形图</em>。这将获取整个数据集的SHAP值的平均值，并将其绘制为一个简单的条形图。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es le"><img src="../Images/24ac0473dd03ec42d28622ce1ba11b5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*sHcGqtazvQ4m_cqssFsDlQ.png"/></div></figure><p id="f9e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="kp"> SHAP依赖图</em>说明了相互作用的影响。下图显示了整个数据集的看跌特征。似乎与“regularmmarkettradingtimeinlong”有一些交互。在看跌值约为0.025时，这两个特征的SHAP值似乎存在垂直离差。这是由两个特征之间的相互作用驱动的。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lf"><img src="../Images/c1e6307633c08a066e4f92ae16054c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*X5EdUtTcA7cL2oMJ_YXp9g.png"/></div><figcaption class="ky kz et er es la lb bd b be z dx translated">看跌情绪变量的SHAP值</figcaption></figure><p id="c8ac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">结论</strong></p><p id="a3da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">嗯，我的模型只是比预测掷硬币稍微准确一点。好消息是，还有改进的空间！</p></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="f6ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">未来工作</strong></p><p id="7b92" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将利用这些信息改进未来的模型。我进行了最小的特征工程，我相信这会带来巨大的不同。此外，我想提高情感分数的鲁棒性。我需要更多的情绪来源来捕捉市场上更多的信息。</p><p id="77c4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用PCA成分分析记录正向概率。你可以看到某些区域的红色浓度较高，而其他区域的蓝色浓度较高。对于未来的模型来说，这可能是有趣的。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es lg"><img src="../Images/5176b56896408c6a9ef9b5c3496a2a73.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/format:webp/1*nG2th-qW1kyVLEw0fmro8A.png"/></div></figure></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="dbbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">问题/评论？</strong></p><p id="a39c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您有任何问题、意见或只是想聊聊ML、股票市场或一般的数据科学，请随时联系我。</p><ol class=""><li id="31bf" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated">电子邮件:md.ghsd@gmail.com</li><li id="3d17" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><a class="ae jm" href="https://twitter.com/mdcruz2010" rel="noopener ugc nofollow" target="_blank">推特</a></li><li id="6185" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><a class="ae jm" href="https://www.linkedin.com/in/marcosdominguez2018/" rel="noopener ugc nofollow" target="_blank">领英</a></li></ol></div></div>    
</body>
</html>