<html>
<head>
<title>Rails Context without Context &amp; Callback / Validation Conditions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">没有上下文和回调/验证条件的Rails上下文</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/rails-context-without-context-callback-validation-conditions-8015ab28ac0?source=collection_archive---------2-----------------------#2021-01-06">https://medium.com/nerd-for-tech/rails-context-without-context-callback-validation-conditions-8015ab28ac0?source=collection_archive---------2-----------------------#2021-01-06</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="01d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当你越来越喜欢Rails或任何其他框架时，有时你会认为默认的<strong class="ih hj">并不是你所需要的</strong>。在Ruby on Rails的那个案例中，我就遇到过这种情况。</p><h1 id="a8fe" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">让我提出我的理由:</h1><p id="6a27" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我开发的应用程序有两个生产应用程序在Heroku上运行。CI通过后，这两个应用程序会自动从同一个Github repo部署。不幸的是，在其中一个应用程序中，一个模型中必须有一个非常小的差异。然而，他们必须在未来的每一次代码变更中保持同步，当然，除了这一点点差异和数据库。</p><p id="eb01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当这两个应用程序必须在幕后拥有相同的代码时，它们应该如何做一些不同于其他应用程序的事情呢？</p><p id="a511" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">很快，我发现我可以使用的区别是网址。如果用户在某个域中，我需要验证一个模型并调用回调函数。</p><p id="8f5c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">作为最初的想法，我提出了这样的东西:</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="8e71" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">当然，这太简单了，因为你已经想到当你在服务器上的模型中时，你不能访问域名…</p><h1 id="b7c0" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">Rails '验证上下文</h1><p id="f13c" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">继续搜索，我发现Rails实际上有对上下文的原生支持！我只需在控制器中保存“我的模型”时给出上下文，我可以这样使用它:</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="0b9b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">看起来不错，对吧？好吧，这里发生了什么？在控制器中，我通过检查请求来检查用户是否在正确的URL上。如果用户是，我通过转发一个上下文来保存模型。然后可以在模型中访问这个上下文，这样只有在给出相应的上下文时才会调用验证。</p><p id="2765" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">到目前为止一切顺利！但是该死的，这不能用在回调上，如果你对不同的上下文有不同的验证，你的“if-statement”在保存上下文时会变得很长。</p><h1 id="e3ee" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">PORO(普通的老红宝石对象)的方式</h1><p id="59c7" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我们还在编写ruby代码，对吧？最终，<strong class="ih hj">Rails模型只不过是一个带有一些Rails魔力的PORO </strong>。让我们利用这一点！</p><p id="1bc7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以简单地给模型一个非数据库实例变量，并使用它来检查验证/回调是否应该运行。这样，当然，这个变量不会被写入数据库，但是我们不需要它，因为它只是一些上下文，对吗？</p><p id="b8c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">让我们PORO一下:</strong></p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="e945" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们在这里所做的最终是非常基本的。在从前端的表单中获得允许的参数(最终只是一个散列)后，我们添加另一个键值对<code class="du kn ko kp kq b">on_my_domain: on_my_domain?</code>，它解析为<code class="du kn ko kp kq b">on_my_domain: true</code>或<code class="du kn ko kp kq b">on_my_domain: false</code>。这将使用<code class="du kn ko kp kq b">attr_writer</code>将我们的上下文实例变量添加到模型的实例中。我们可以使用<code class="du kn ko kp kq b">@on_my_domain</code>来访问它，或者在我们的例子中通过<code class="du kn ko kp kq b">on_my_domain?</code>来访问。验证、回调和其他一切现在都可以使用这些信息了！</p><p id="9ae0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">太棒了，对吧？！</p><p id="65bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请记住，一旦实例消失了,“上下文”也将消失。</p><h1 id="b12b" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">让它更滑稽</h1><p id="3bb0" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">综上所述，它已经运行得非常好了！不过，在更大的应用程序中，在不同的控制器和不同的模型中使用这样的上下文变量可能会很有趣。幸运的是，我们在这里讨论的是Rails，所以请放松:)</p><p id="e2f9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们可以将我们的前端检查放入一个助手中，这样它就可以在几个控制器中使用，如下所示:</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="64e6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们完成它并写一个关注点，这样每个需要它的模型都可以使用我们的上下文变量:</p><figure class="kg kh ki kj fd kk"><div class="bz dy l di"><div class="kl km l"/></div></figure><p id="5f91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！我希望这对你有所帮助。祝您愉快:)</p></div></div>    
</body>
</html>