<html>
<head>
<title>How pure and impure pipes work in Angular Ivy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">纯净和不纯净的管道在角状常春藤中是如何工作的</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/how-pure-and-impure-pipes-work-in-angular-ivy-ebdfd51df932?source=collection_archive---------13-----------------------#2021-05-24">https://medium.com/nerd-for-tech/how-pure-and-impure-pipes-work-in-angular-ivy-ebdfd51df932?source=collection_archive---------13-----------------------#2021-05-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="b9d9" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">通过查看它们在Ivy中的实现细节来理解管道是如何工作的</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/2ca1f978a0895142349ee49cace271ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WTm_bi55SeebZeUS"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">Samuel Sianipar 在<a class="ae jn" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</figcaption></figure><p id="1bda" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">Angular的<a class="ae jn" href="https://angular.io/guide/pipes" rel="noopener ugc nofollow" target="_blank">管道机制</a>是Angular开发者日常使用的东西。有一篇优秀的<a class="ae jn" href="https://indepth.dev/posts/1061/the-essential-difference-between-pure-and-impure-pipes-in-angular-and-why-that-matters" rel="noopener ugc nofollow" target="_blank">文章深入探讨了管道</a>，文章的要点如下:</p><blockquote class="kk kl km"><p id="b6ac" class="jo jp kn jq b jr js ij jt ju jv im jw ko jy jz ka kp kc kd ke kq kg kh ki kj hb bi translated">当pipe为纯时，<code class="du kr ks kt ku b">transform()</code>方法仅在其输入参数改变时被调用。默认情况下，管道是纯的。<br/>如果管道有内部状态(即结果取决于状态而不是参数)，将<code class="du kr ks kt ku b">pure</code>设置为<code class="du kr ks kt ku b">false</code>。在这种情况下，即使参数没有变化，管道也会在每个变化检测周期被调用。</p></blockquote><p id="6a8b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">纯管道的另一个有趣的特性是Angular只创建一个纯管道实例，而不管管道在模板中使用了多少次:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es kv"><img src="../Images/0e28c25fd71787cced35a58c60cfe8ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M_jUG7yud3rAXQr2duFtJw.png"/></div></div></figure><p id="b184" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里应该只创建一个<code class="du kr ks kt ku b">myCustomPurePipe</code>实例。</p><p id="6eb6" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在Ivy出现之前，这是真的，在这篇文章中，我将深入了解这一点，看看它是否仍然适用于Ivy。</p><h2 id="a6a2" class="kw kx hi bd ky kz la lb lc ld le lf lg jx lh li lj kb lk ll lm kf ln lo lp lq bi translated">设置事物</h2><p id="0918" class="pw-post-body-paragraph jo jp hi jq b jr lr ij jt ju ls im jw jx lt jz ka kb lu kd ke kf lv kh ki kj hb bi translated">首先，让我们创建一个版本≥ 9的新Angular项目，因为我们正在Ivy实现中探索管道。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lw"><img src="../Images/d06ad5adfcd868cd94b7be8f81289d59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uv5qOF3SToTxeJULIsO4_g.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">创建新Angular 9项目</figcaption></figure><h2 id="ca63" class="kw kx hi bd ky kz la lb lc ld le lf lg jx lh li lj kb lk ll lm kf ln lo lp lq bi translated">创建自定义纯管道和非纯管道</h2><p id="f76d" class="pw-post-body-paragraph jo jp hi jq b jr lr ij jt ju ls im jw jx lt jz ka kb lu kd ke kf lv kh ki kj hb bi translated">接下来，我们将创建一个名为<code class="du kr ks kt ku b">my-custom-pure-pipe</code>和<code class="du kr ks kt ku b">my-custom-impure-pipe</code>的定制管道:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lx"><img src="../Images/aa7751d5ceb9cd2157c6ad390457e6b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aaWhGzkL23XW2z3BW2oYEg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">创建自定义纯管道和不纯管道</figcaption></figure><p id="3d3e" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">然后，像这样更改<code class="du kr ks kt ku b">my-custom-pure-pipe</code>的实现:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ly"><img src="../Images/10eec9885b2e93c440544cfea3a06c49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BLgv6Tc-O_19cI-0J94lZw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">MyCustomPurePipe代码</figcaption></figure><p id="48ad" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">像这样改变<code class="du kr ks kt ku b">my-custom-impure-pipe</code>:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lz"><img src="../Images/1f9b34210b5fa2f96fb8b9e7490ae534.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_xy1SmskN_6m-EoJicYXjA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">MyCustomImpurePipe代码</figcaption></figure><p id="daf8" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">基本上，这里我们只是在实例创建阶段以及在变更检测期间Angular调用<code class="du kr ks kt ku b">transform</code>时进行日志记录。</p><p id="4f2a" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在<code class="du kr ks kt ku b">app.component.ts</code>中，修改代码如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ma"><img src="../Images/e6da8991dd4ecb44814e5ce6e6ebe8c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u5N6M5snILgLGHHnwtYJvw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">AppComponent代码</figcaption></figure><p id="2500" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在<code class="du kr ks kt ku b">angular.json</code>文件中，将<code class="du kr ks kt ku b">projects -&gt; study-pipes -&gt; architect -&gt; build -&gt; options -&gt; aot</code>的<code class="du kr ks kt ku b">aot</code>选项从<code class="du kr ks kt ku b">true</code>改为<code class="du kr ks kt ku b">false</code>，禁用提前(AOT)编译。这将允许我们更容易地探索生成的代码。</p><p id="d92b" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在我们已经完成了项目的设置。让我们开始我们的探索之旅。</p><h2 id="f87b" class="kw kx hi bd ky kz la lb lc ld le lf lg jx lh li lj kb lk ll lm kf ln lo lp lq bi translated">探索管道</h2><p id="0c22" class="pw-post-body-paragraph jo jp hi jq b jr lr ij jt ju ls im jw jx lt jz ka kb lu kd ke kf lv kh ki kj hb bi translated">假设在<code class="du kr ks kt ku b">app.component.html</code>中我们有以下模板</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mb"><img src="../Images/00587ac0856b850a556b5cac2d48034e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NB1yPVvZydJtVFaGBmW4TQ.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">AppComponent模板代码</figcaption></figure><p id="8223" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">让我们打开Chrome开发工具，在源代码选项卡中，导航到应用程序组件文件，您将看到以下代码:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mc"><img src="../Images/bd2d12e495b46bc23f962f644a65a458.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-lkODj81CumJ3hY6"/></div></div></figure><p id="8781" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">在<code class="du kr ks kt ku b">AppComponent_Template</code>内部生成的代码中有两个主要的<code class="du kr ks kt ku b">if</code>块:组件实例化过程中执行的代码<code class="du kr ks kt ku b">rf &amp; 1</code>和变更检测逻辑<code class="du kr ks kt ku b">rf &amp; 2</code>。</p><p id="3002" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这是创作板块:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es md"><img src="../Images/c5439349da37a60645754d9f8ef2b24a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GLufcpSBHPnraRFHdEBmTw.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">AppComponent创建阶段代码</figcaption></figure><p id="e483" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du kr ks kt ku b">jit__pipe_4</code>实际上是创建管道新实例的函数。因此，您可以看到我们将有4个管道实例。这意味着在常春藤中，每根管子都有它自己的实例，不管它是纯净的还是不纯净的。而在View Engine中，pure pipe有一个共享实例。</p><p id="77c4" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">现在让我们看一下变化检测模块:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lw"><img src="../Images/8b01009ae3de803560fea2f54dcc3998.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wrq7r_fDzOxDZOdsMSn6Ww.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx translated">AppComponent更改检测阶段</figcaption></figure><p id="b1dc" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><code class="du kr ks kt ku b">jit___pipeBind1_8</code>是在管道上调用转换的函数。</p><p id="453c" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">下面是管道执行转换任务时的<a class="ae jn" href="https://github.com/angular/angular/blob/84b8f250f9d13ba652d273e586cae2144d2ba055/packages/core/src/render3/pipe.ts#L98" rel="noopener ugc nofollow" target="_blank">代码</a>。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es me"><img src="../Images/f3df6066ef2f1c748638cc9cb11996bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZiLTuQbi3PBnS1MG-NhqEA.png"/></div></div></figure><p id="6f85" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">从上面的代码中，<code class="du kr ks kt ku b">isPure</code>方法将通过查看<code class="du kr ks kt ku b">@Pipe</code> decorator中的<code class="du kr ks kt ku b">pure</code>属性来检查管道是纯的还是不纯的。</p><p id="61db" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">对于不纯的管道棱角调用</strong> <code class="du kr ks kt ku b">transform</code> <strong class="jq hj">方法对每一个变化进行检测。对于纯管道的任何输入变化，它将调用</strong> <code class="du kr ks kt ku b">transform</code> <strong class="jq hj">函数。否则，它将返回一个缓存值。</strong></p><h2 id="421c" class="kw kx hi bd ky kz la lb lc ld le lf lg jx lh li lj kb lk ll lm kf ln lo lp lq bi translated">结论</h2><p id="0d03" class="pw-post-body-paragraph jo jp hi jq b jr lr ij jt ju ls im jw jx lt jz ka kb lu kd ke kf lv kh ki kj hb bi translated">所以，总结一下:</p><ul class=""><li id="a613" class="mf mg hi jq b jr js ju jv jx mh kb mi kf mj kj mk ml mm mn bi translated">在常春藤中，每根管子都有它自己的实例，不管它是纯净的还是不纯净的。而在View Engine中，pure pipe有一个共享实例。例如，在Ivy中，如果我在一个模板中的两个地方使用了<code class="du kr ks kt ku b">myCustomPurePipe</code>，那么就会创建两个<code class="du kr ks kt ku b">MyCustomPurePipe</code>实例。</li><li id="857f" class="mf mg hi jq b jr mo ju mp jx mq kb mr kf ms kj mk ml mm mn bi translated">在使用默认变更检测策略的组件中，当变更检测发生时，如果管道不纯，那么将调用<code class="du kr ks kt ku b">transform</code>方法。如果管道是纯的，无论从最后一次调用开始<code class="du kr ks kt ku b">transform</code>方法中的输入参数是否有任何变化，那么transform方法将被调用。否则，管道将返回上次转换调用的缓存值。</li><li id="0f58" class="mf mg hi jq b jr mo ju mp jx mq kb mr kf ms kj mk ml mm mn bi translated">当使用不纯管道<code class="du kr ks kt ku b">async</code>时，您应该将它与OnPush变更检测一起使用，以避免每次变更检测时对<code class="du kr ks kt ku b">transform</code>的不必要调用。</li></ul><p id="5957" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">这里有两个StackBlitz repos供你玩，一个是给<a class="ae jn" href="https://stackblitz.com/edit/angular-view-engine-pure-pipe?file=src/app/app.component.ts" rel="noopener ugc nofollow" target="_blank">视图引擎</a>，另一个是给<a class="ae jn" href="https://stackblitz.com/edit/angular-ivy-pure-pipe?file=src/app/app.component.ts" rel="noopener ugc nofollow" target="_blank"> Ivy </a>。</p><p id="4871" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated"><strong class="jq hj">更新2022.04.04 </strong>:如果你想探索Angular Ivy的更多方面，比如新的调试工具、新的API以及语言语法，我强烈推荐由<a class="ae jn" href="https://twitter.com/LayZeeDK" rel="noopener ugc nofollow" target="_blank"> Lars Gyrup Brink Nielsen </a>和<a class="ae jn" href="https://twitter.com/jacobandresen" rel="noopener ugc nofollow" target="_blank"> Jacob Andresen </a>所著的《用Ivy加速Angular Development】一书。</p><p id="f317" class="pw-post-body-paragraph jo jp hi jq b jr js ij jt ju jv im jw jx jy jz ka kb kc kd ke kf kg kh ki kj hb bi translated">感谢您的时间和愉快的编码！</p></div></div>    
</body>
</html>