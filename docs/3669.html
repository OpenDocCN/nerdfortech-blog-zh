<html>
<head>
<title>Activate Your Data Streams Using RudderStack: A Use-Case with AWS Lambda and Amazon Kinesis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用RudderStack激活数据流:AWS Lambda和Amazon Kinesis的一个用例</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/activate-your-data-streams-using-rudderstack-a-use-case-with-aws-lambda-and-amazon-kinesis-eff443543183?source=collection_archive---------17-----------------------#2021-06-18">https://medium.com/nerd-for-tech/activate-your-data-streams-using-rudderstack-a-use-case-with-aws-lambda-and-amazon-kinesis-eff443543183?source=collection_archive---------17-----------------------#2021-06-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/e27046152378c5c5888d0f1c7400be6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ETfTdm1zByNzR_0mqoFlEg.png"/></div></div></figure><p id="b632" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本博客介绍了一种使用Amazon Kinesis和AWS Lambda函数将数据路由到RudderStack的方法。</p><h1 id="b2dd" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">介绍</h1><p id="bb2e" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">如今，许多组织利用来自其应用程序和网站的流式事件数据。为了收集数据流，他们使用像亚马逊Kinesis这样的工具。但是，这些企业如何将数据流转化为可操作的见解呢？一个流行的方法是通过一个叫做<em class="kr">激活</em>的过程。在这个过程中，我们转换原始数据，然后将其路由到不同的应用程序和服务以获得洞察力。例如，我们可以向我们的CRM发送注册事件，以便销售团队可以处理新的线索并建立业务机会。</p><p id="9ad5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本帖中，我们展示了一个非常强大的架构，它使用现成的服务来完成上述任务。我们将亚马逊Kinesis与AWS Lambda函数和<a class="ae ks" href="https://www.rudderstack.com/" rel="noopener ugc nofollow" target="_blank"> RudderStack </a>相结合，这是一个开源和灵活的客户数据基础设施，可以执行我们正在寻找的激活。AWS中的lambda函数读取Kinesis数据流，并将它们传递给RudderStack，以执行必要的数据映射。RudderStack然后将这些映射数据传递给分析平台(Google Analytics、Amplitude等)。)进行分析。</p><blockquote class="kt ku kv"><p id="b287" class="iq ir kr is b it iu iv iw ix iy iz ja kw jc jd je kx jg jh ji ky jk jl jm jn hb bi translated"><strong class="is hj"> <em class="hi">注</em> </strong> <em class="hi">:在本帖中，我们以AWS栈为例。然而，可以用Kafka替代Kinesis，用任何其他云提供商替代AWS。该堆栈仍将与RudderStack无缝协作。</em></p></blockquote><h1 id="77f6" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">AWS Lambda如何与RudderStack集成</h1><p id="b1c5" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">如上所述，我们在AWS中使用Lambda函数作为中介来处理和路由数据流以进行分析。由于Lambda函数可以在Node.js中编码，因此它与RudderStack等数据路由工具的集成非常容易。RudderStack提供了一个<a class="ae ks" href="https://github.com/rudderlabs/rudder-sdk-node" rel="noopener ugc nofollow" target="_blank"> <strong class="is hj"> Node.js SDK </strong> </a>，我们可以将它与Lambda代码一起使用。</p><h1 id="9212" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">数据流的快速概述</h1><p id="c054" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">出于本博客的目的，我们设计了一个简单的应用流程:</p><ul class=""><li id="9cab" class="kz la hi is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">使用<a class="ae ks" href="https://github.com/awslabs/amazon-kinesis-agent" rel="noopener ugc nofollow" target="_blank"><strong class="is hj">AWS Kinesis Agent</strong></a>来:</li><li id="9b9d" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">监视文件系统中指定位置的特定文件模式</li><li id="4f0a" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">将新收到的文件上传到预定义的Kinesis流</li><li id="d62c" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">消费者触发AWS Lambda功能</li><li id="6709" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">Lambda函数将Kinesis数据映射到RudderStack API参数</li><li id="1545" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">Lambda函数调用RudderStack API</li><li id="87f3" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">RudderStack将数据发送到两个目的地——AWS S3和谷歌分析</li></ul><h1 id="b73f" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设置AWS Kinesis代理</h1><p id="190d" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们可以使用以下代码行配置AWS Kinesis代理:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="e858" class="lw jp hi ls b fi lx ly l lz ma">{<br/>  "cloudwatch.emitMetrics": true,<br/>  "kinesis.endpoint": "",<br/>  "firehose.endpoint": "",<br/>  <br/>  "flows": [<br/>    {<br/>      "filePattern": "/tmp/*.csv",<br/>      "kinesisStream": "lambda-integration-poc",<br/>      "partitionKeyOption": "RANDOM",<br/>      "dataProcessingOptions": [<br/>                {<br/>                    "optionName": "CSVTOJSON",<br/>                    "customFieldNames": ["anonymousId","orderId", "itemId", "itemName", "qty", "unitPrice"],<br/>                    "delimiter": ","<br/>                }<br/>	]<br/>    }<br/>  ]<br/>}</span></pre><p id="13e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里需要注意一些要点:</p><ul class=""><li id="2053" class="kz la hi is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">我们配置AWS Kinesis代理来监控<code class="du mb mc md ls b">/tmp</code>目录中的CSV文件。</li><li id="9a5d" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">Kinesis代理将数据传递给<code class="du mb mc md ls b">lambda-integration-poc</code> Kinesis数据流。</li><li id="5eb2" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">数据处理选项规定将CSV数据转换为JSON。还提到了生成的JSON的字段名。</li></ul><p id="c012" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面是CSV文件样本和相应生成的Kinesis记录的一些示例:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="ed9d" class="lw jp hi ls b fi lx ly l lz ma">testuser1,0001,0001,sample product 1,001,51.00</span><span id="6485" class="lw jp hi ls b fi me ly l lz ma">testuser1,0001,0002,sample product 2,002,23.50</span><span id="4632" class="lw jp hi ls b fi me ly l lz ma">{ "anonymousId": "testuser1", "orderId": "0001", "itemId": "0001", "itemName": "sample product 1", <br/>"qty": "001", "unitPrice": "51.00" }</span><span id="a33c" class="lw jp hi ls b fi me ly l lz ma">{ "anonymousId": "testuser1", "orderId": "0001", "itemId": "0002", "itemName": "sample product 2", <br/>"qty": "002", "unitPrice": "23.50" }</span></pre><blockquote class="kt ku kv"><p id="b9f0" class="iq ir kr is b it iu iv iw ix iy iz ja kw jc jd je kx jg jh ji ky jk jl jm jn hb bi translated"><strong class="is hj"> <em class="hi">注</em> </strong> <em class="hi">:我们以这个变换为例来演示AWS Kinesis Agent的操作。一些企业已经有了自己的程序，以适合其业务需求的格式编写Kinesis。没有必要改变这样的程序和/或格式。</em></p></blockquote><h1 id="f459" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设置AWS Lambda</h1><p id="e5a3" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在我们进入Lambda函数代码之前，我们必须回顾一下整体设置。对于这篇博客，我们在EC2实例中设置了一个Docker版本的RudderStack服务器。你可以在这里找到关于设置<a class="ae ks" href="https://github.com/rudderlabs/rudder-server#setup-instructions-docker" rel="noopener ugc nofollow" target="_blank">的更多说明。</a></p><blockquote class="kt ku kv"><p id="711a" class="iq ir kr is b it iu iv iw ix iy iz ja kw jc jd je kx jg jh ji ky jk jl jm jn hb bi translated"><strong class="is hj"> <em class="hi">注意</em> </strong> <em class="hi">:您还需要在您的开发环境中安装AWS CLI。</em></p></blockquote><h1 id="2b15" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">将方向舵堆栈与AWS Lambda集成</h1><p id="fb97" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">如前所述，我们可以将AWS Lambda与RudderStack Node.js SDK等第三方库无缝集成。lambda函数调用这个SDK来执行必要的数据映射，并将数据流路由到指定的分析目的地。因此，在这一点上，仔细查看将RudderStack节点SDK与Lambda函数集成起来所必需的几个步骤也是明智的。</p><ul class=""><li id="34c5" class="kz la hi is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">您应该在开发环境中维护Lambda函数工件的位置安装RudderStack Node.js SDK，如下所示:</li></ul><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="03f0" class="lw jp hi ls b fi lx ly l lz ma">[ec2-user@ip-172-31-44-230 ~]$ npm install --prefix=~/lambda-apps @rudderstack/rudder-sdk-node</span></pre><ul class=""><li id="faa0" class="kz la hi is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">将Lambda函数开发目录的所有内容存档在一个ZIP文件中。</li></ul><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="edd5" class="lw jp hi ls b fi lx ly l lz ma">[ec2-user@ip-172-31-44-230 lambda-apps]$ zip -r function.zip</span></pre><ul class=""><li id="7895" class="kz la hi is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">更新lambda函数部署，如图所示:</li></ul><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="6efd" class="lw jp hi ls b fi lx ly l lz ma">[ec2-user@ip-172-31-44-230 lambda-apps]$ aws lambda update-function-code --function-name lambda-apps-dev-helloWorld --zip-file fileb://~/lambda-apps/function.zip</span></pre><h1 id="af4b" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">使用λ函数</h1><p id="fdf2" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">作为下一步，下面的代码片段展示了Lambda代码。您可以使用Lambda代码响应在AWS指定的web端点上测试函数的可用性，该端点是在首次部署函数时创建的。</p><p id="87cd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在下面的代码片段中，发生了以下操作:</p><ul class=""><li id="2b4a" class="kz la hi is b it iu ix iy jb lb jf lc jj ld jn le lf lg lh bi translated">该函数初始化一些用于构造RudderStack规范对象的变量</li><li id="3d5d" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">lambda函数迭代Kinesis事件中的每条记录</li><li id="a0ea" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">该函数解析JSON格式的记录</li><li id="ddb7" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">然后，该函数使用JSON对象的属性值作为RudderStack对象的属性值</li><li id="4113" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">在某些情况下，RudderStack对象属性值是通过聚合JSON对象属性值得到的，如<code class="du mb mc md ls b">revenue</code>的情况</li><li id="47b9" class="kz la hi is b it li ix lj jb lk jf ll jj lm jn le lf lg lh bi translated">每个记录用于创建一个<code class="du mb mc md ls b">product</code>对象。多个<code class="du mb mc md ls b">product</code>对象被收集到一个<code class="du mb mc md ls b">products</code>数组中。使用<code class="du mb mc md ls b">products</code>数组、记录中的<code class="du mb mc md ls b">order_id</code>和<code class="du mb mc md ls b">revenue</code>构造一个<code class="du mb mc md ls b">order</code>对象</li></ul><p id="e653" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此后，在调用RudderStack的<code class="du mb mc md ls b">track</code> API时，<code class="du mb mc md ls b">order</code>对象被用作<code class="du mb mc md ls b">properties</code>键的值。</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="6210" class="lw jp hi ls b fi lx ly l lz ma">'use strict';<br/>const Analytics = require("@rudderstack/rudder-sdk-node");</span><span id="fc3f" class="lw jp hi ls b fi me ly l lz ma">//<br/>//<br/>module.exports.helloWorld = (event, context, callback) =&gt; {<br/>    const response = {<br/>   	 statusCode: 200,<br/>   	 headers: {<br/>   		 'Access-Control-Allow-Origin': '*', // Required for CORS support to work<br/>   	 },<br/>   	 body: JSON.stringify({<br/>   		 message: 'Go Serverless v1.0! Your function executed successfully!',<br/>   		 input: event,<br/>   	 }),<br/>    };<br/>    var order = {};<br/>    var revenue = 0;<br/>    var anonymousId = "dummy";<br/>    order["products"] = [];<br/>    event.Records.forEach(function(record) {<br/>   	 // Kinesis data is base64 encoded so decode here<br/>   	 var payload = Buffer.from(record.kinesis.data, 'base64').toString('ascii');<br/>   	 console.log('Decoded payload:', payload);<br/>   	 <br/>   	 //Construct order line item as expected by GA from Kinesis record<br/>   	 var orderLine = JSON.parse(payload);<br/>   	 var product = {};<br/>   	 product["product_id"] = orderLine.itemId;<br/>   	 product["name"] = orderLine.itemName;<br/>   	 <br/>   	 revenue += orderLine.qty * orderLine.unitPrice;<br/>   	 order["products"].push(product);<br/>   	 order["order_id"] = orderLine.orderId; //keeping it simple, all line items from same order<br/>   	 anonymousId = orderLine.anonymousId; //keeping simple again, as above</span><span id="ec9d" class="lw jp hi ls b fi me ly l lz ma">    });<br/>    <br/>    order["revenue"] = revenue;<br/>    console.log("Order : ", JSON.stringify(order));<br/>    // we need the batch endpoint of the Rudder server you are running<br/>    const client = new Analytics("1ZINZh5pUNcKwgVGccCuSE4hi7K", "Data Plane URL");<br/>    //remember to handle error and allow for processing to continue<br/>    try {<br/>   	 client.track({"event" : "Order Completed", "anonymousId" : anonymousId, "properties" :  {order}});<br/>   	 console.log("Rudder Success");<br/>    } catch(err) {<br/>   	 console.log("Rudder Error");<br/>    }<br/>    callback(null, response);<br/>};</span></pre><p id="b142" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du mb mc md ls b">write_key</code>和RudderStack端点用于初始化Rudder客户端。在这个特殊的例子中，我们配置RudderStack将事件转储到<strong class="is hj">亚马逊S3 </strong>以及<strong class="is hj">谷歌分析、</strong>进行分析。点击了解更多关于在方向舵堆栈<a class="ae ks" href="https://docs.rudderstack.com/getting-started/adding-source-and-destination-rudderstack" rel="noopener ugc nofollow" target="_blank">中配置源和目的地的信息:</a></p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mf"><img src="../Images/709430860d85ade16ca3b0a433e7326e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*epao3ClugjvR6Z8h.png"/></div></div></figure><p id="faf0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">舵杆连接配置</strong></p><p id="a15a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">转储到亚马逊S3的交付事件如下所示:</p><pre class="ln lo lp lq fd lr ls lt lu aw lv bi"><span id="dc9b" class="lw jp hi ls b fi lx ly l lz ma">{"type": "track", "event": "Order Completed", "sentAt": "2020-04-15T09:59:50.246Z", "context": {"library": {"name": "analytics-node", "version": "0.0.1"}}, "_metadata": {"nodeVersion": "12.16.1"}, "messageId": "node-5306d64b863bdf7c95cce1442c70f3ac-1345b9b5-c5a9-4c1b-8338-64762ff2de8d", "timestamp": "2020-04-15T09:59:50.27Z", "properties": {"order": {"revenue": 98, "order_id": "0001", "products": [{"name": "sample product 1", "product_id": "0001"}, {"name": "sample product 2", "product_id": "0002"}]}}, "receivedAt": "2020-04-15T09:59:50.271Z", "request_ip": "34.205.171.63:54764", "anonymousId": "testuser1", "originalTimestamp": "2020-04-15T09:59:50.245Z"}</span></pre><p id="e0ce" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面的屏幕截图显示了Google Analytics中交付的事件:</p><figure class="ln lo lp lq fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mg"><img src="../Images/43b8d07a87b3ff59ec537054bd1fd7cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-s43JeM3t-CaowR6.png"/></div></div></figure><p id="defc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">谷歌分析中看到的舵栈事件</strong></p><h1 id="2158" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">摘要</h1><p id="77c2" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在这篇文章中，我们看到了如何将数据流与RudderStack和AWS Lambda函数结合起来，为您的事件数据创建一个极其灵活和实时的激活数据流。将AWS Kinesis和AWS Lambdas等基础设施与RudderStack相结合，可以产生一个精简且可扩展的数据基础设施，可以立即从您的数据中提取价值。</p><p id="fe16" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此外，RudderStack是一个开放和灵活的客户数据基础设施，这意味着它可以与您能找到的任何常见数据平台相结合。在这篇文章中，我们使用AWS栈作为例子，但是可以用Kafka代替Kinesis，用任何其他云提供商代替AWS。</p><h1 id="c153" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">免费注册并开始发送数据</h1><p id="3f60" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">测试我们的事件流、ELT和反向ETL管道。使用我们的HTTP源在不到5分钟的时间内发送数据，或者在您的网站或应用程序中安装我们12个SDK中的一个。<a class="ae ks" href="https://app.rudderlabs.com/signup?type=freetrial" rel="noopener ugc nofollow" target="_blank">上手</a>。</p><p id="42d8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这篇博客最初发表于<br/><a class="ae ks" href="https://rudderstack.com/blog/data-streams-using-rudderstack-with-aws-lambda-and-amazon-kinesis" rel="noopener ugc nofollow" target="_blank">https://rudder stack . com/blog/data-streams-using-rudder stack-with-AWS-lambda-and-Amazon-kinesis</a></p></div></div>    
</body>
</html>