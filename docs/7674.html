<html>
<head>
<title>Building an Aggregation Pipeline in MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 MongoDB 中构建聚合管道</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/building-an-aggregation-pipeline-in-mongodb-42f4624509c0?source=collection_archive---------1-----------------------#2022-12-28">https://medium.com/nerd-for-tech/building-an-aggregation-pipeline-in-mongodb-42f4624509c0?source=collection_archive---------1-----------------------#2022-12-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/9030e2eb008073f9f20b2ad7cb345d1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sxvj2r43bvKQ0pAOQ0alrg.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">昆腾·德格拉夫在<a class="ae iu" href="https://unsplash.com/photos/L4gN0aeaPY4?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</figcaption></figure><p id="20c7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">MongoDB 是一个常用的<strong class="ix hj"> NoSQL 数据库</strong>，用于存储和管理海量数据。MongoDB 的核心特性之一是它的<strong class="ix hj">聚合管道</strong>，它允许您分阶段处理和更改来自集合的数据。在这篇文章中，我们将看看如何在 MongoDB 中创建一个聚合管道。</p><h2 id="605a" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">什么是聚合管道？</h2><p id="122d" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">聚合管道是一组处理数据并返回计算结果的操作。它可用于执行复杂的数据分析和报告活动，并允许您对数据执行众多操作，如<strong class="ix hj">过滤</strong>、<strong class="ix hj">分组</strong>和<strong class="ix hj">排序</strong>。</p><p id="0987" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要创建聚合管道，请对集合使用<strong class="ix hj"> aggregate() </strong>方法。aggregate()方法接受一组管道阶段作为参数，每个阶段都以不同的方式处理数据。任何聚合阶段，如<strong class="ix hj"> $match </strong>、<strong class="ix hj"> $group </strong>、<strong class="ix hj"> $sort </strong>、<strong class="ix hj"> $project </strong>等，都可以作为流水线阶段。</p><p id="152a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，您可以使用以下代码创建一个简单的管道，该管道根据特定条件过滤文档，然后按特定字段组织结果:</p><pre class="kt ku kv kw fd kx ky kz bn la lb bi"><span id="4de3" class="lc ju hi ky b be ld le l lf lg">db.collection.aggregate([<br/>  { $match: { field: "value" } },<br/>  { $group: { _id: "$groupField", count: { $sum: 1 } } }<br/>])</span></pre><p id="f35a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该管道首先通过匹配字段等于“值”的文档来过滤集合，然后按照组名对剩余的文档进行分组。每个组字段中的文档数在字段中计数。</p><p id="0bd7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以根据需要向管道添加更多阶段，以进一步处理和分析数据。您可以使用<strong class="ix hj"> $sort </strong>阶段按照 count 字段对结果进行排序，或者使用<strong class="ix hj"> $project </strong>阶段对输出页面进行重组。</p></div><div class="ab cl lh li gp lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="hb hc hd he hf"><h2 id="6aa2" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">聚集阶段类型:</h2><p id="893b" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在 MongoDB 中，有几个<a class="ae iu" href="https://www.mongodb.com/docs/manual/reference/operator/aggregation-pipeline/" rel="noopener ugc nofollow" target="_blank">聚合阶段</a>，每个阶段都有自己的功能和语法。以下是一些最常用的阶段:</p><p id="a68a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> $match </strong>:过滤文档，只返回符合所提供条件的文档。<br/> <strong class="ix hj"> $group </strong>:使用提供的标识符表达式对输入文档进行分组，并对每个组应用累加器表达式(如果指定了的话)。<br/> <strong class="ix hj"> $sort </strong>:对输入的文档进行排序。<br/> <strong class="ix hj"> $project </strong>:调整输入流中每个文档的大小，例如，通过添加新字段或删除旧字段。<br/> <strong class="ix hj"> $limit </strong>:设置可以传送到管道下一阶段的最大文档数。<br/> <strong class="ix hj"> $skip </strong>:跳过管道中的一些文档，将剩余的文档移到下一阶段。</p><p id="6e19" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有许多不同的阶段，每个阶段都有其独特的应用。MongoDB 手册有可用阶段的完整列表。</p></div><div class="ab cl lh li gp lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="hb hc hd he hf"><h2 id="0913" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">构建聚合管道:</h2><p id="a3a9" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">若要创建聚合管道，请对集合调用 aggregate()函数，并传递管道阶段数组。每个阶段都应该是一个对象，它有一个表示阶段操作符的键和一个表示阶段参数的值。</p><p id="380f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如，您可以使用以下代码创建一个管道，该管道根据特定条件筛选文档，按特定字段对结果进行分组，然后对结果进行排序:</p><pre class="kt ku kv kw fd kx ky kz bn la lb bi"><span id="57da" class="lc ju hi ky b be ld le l lf lg">db.collection.aggregate([<br/>  { $match: { field: "value" } },<br/>  { $group: { _id: "$groupField", count: { $sum: 1 } } },<br/>  { $sort: { count: -1 } }<br/>])</span></pre><p id="a99e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">该管道首先通过匹配<code class="du lo lp lq ky b">field</code>等于“值”的文档来过滤集合中的文档。然后，它通过<code class="du lo lp lq ky b">groupField</code>字段对剩余的文档进行分组，计算每组中的文档数量。最后，它按照<code class="du lo lp lq ky b">count</code>字段降序排列结果。</p><p id="b963" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以根据需要向管道添加更多阶段，以进一步处理和分析数据。例如，您可以使用<strong class="ix hj"> $limit </strong>阶段来限制返回的文档数量，或者使用<strong class="ix hj"> $project </strong>阶段来调整输出文档的形状。</p><p id="8077" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">注意到流水线步骤的<strong class="ix hj">顺序</strong>非常重要。因为每个阶段的输入都是前一阶段的输出，所以这些步骤按提供的顺序执行。</p></div><div class="ab cl lh li gp lj" role="separator"><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm ln"/><span class="lk bw bk ll lm"/></div><div class="hb hc hd he hf"><h2 id="c5dd" class="jt ju hi bd jv jw jx jy jz ka kb kc kd jg ke kf kg jk kh ki kj jo kk kl km kn bi translated">结论:</h2><p id="97da" class="pw-post-body-paragraph iv iw hi ix b iy ko ja jb jc kp je jf jg kq ji jj jk kr jm jn jo ks jq jr js hb bi translated">在 MongoDB 中，创建聚合管道允许您对集合进行复杂的数据分析和报告活动。通过使用各种聚合过程，您可以根据需要对数据进行筛选、分组、排序和更改，以满足您的个人需求。借助聚合管道的功能，您可以更深入地了解数据，做出更明智的决策。</p><p id="54fa" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我希望这篇文章对你有所帮助。<strong class="ix hj"> <em class="lr">感谢阅读。</em>T29】</strong></p></div></div>    
</body>
</html>