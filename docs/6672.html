<html>
<head>
<title>When the canary stops singing…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当金丝雀停止歌唱…</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/when-the-canary-stops-singing-37bbdf9d8755?source=collection_archive---------0-----------------------#2022-04-18">https://medium.com/nerd-for-tech/when-the-canary-stops-singing-37bbdf9d8755?source=collection_archive---------0-----------------------#2022-04-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="6b5f" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">确保 2016 年 AWS 的可用性</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/a38abb5c74aee0d9783d088d7b5e729a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sqn5MHad6_W3RYBDyyuyoQ.png"/></div></div></figure><p id="fb17" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这是我不得不在亚马逊的高级副总裁面前张开大嘴的故事，以及这个冲动的决定让我踏上的旅程。</p><p id="e212" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在将近 24 年的时间里，查理·贝尔绝对是亚马逊的传奇人物。你可能听说过他，因为他最近高调跳槽到微软引起了一些不满。查理是<a class="ae kf" href="https://www.podean.com/jeff-bezoss-s-team-the-senior-execs-leading-amazon-through-covid-19" rel="noopener ugc nofollow" target="_blank"> S-team 成员</a>，是少数能直接接触杰夫·贝索斯、对全公司决策有巨大影响力的精英之一。他的成就令人印象深刻。但我个人知道他一件事。</p><p id="116c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><em class="kg">周三上午的</em><a class="ae kf" href="https://aws.amazon.com/blogs/opensource/the-wheel/" rel="noopener ugc nofollow" target="_blank"><em class="kg">AWS Ops 会议</em> </a> <em class="kg">。</em></p><p id="b91e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">每周三，Charlie 都会花两个小时深入 AWS 运营的各个方面。这是一个非常开放的会议:大约一万名 AWS 工程师中的任何人都可以自由参加。从开普敦、爱丁堡到班加罗尔，我们经常有来自世界上每个偏远工程前哨的人打电话进来。我碰巧在西雅图主持会议的大楼里工作，所以我把亲自出席作为一个传统。无论晴雨，我都不会错过的。这确实是地球上最伟大的表演。我经常被明星吸引，因为这个巨大的会议室挤满了我最喜欢的亚马逊高级负责人和杰出的工程师、董事和副总裁。查理是一名高管，手下有数千名工程师，但他仍然有一种不可思议的能力，在会议期间深入到令人难以置信的低级技术细节，并毫不客气地挑战任何不懂或试图给出回避答案的人。</p><p id="079f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">由于 AWS 太大，无法在一次会议中涵盖，所以有一个手工制作的<a class="ae kf" href="https://aws.amazon.com/blogs/opensource/the-wheel/" rel="noopener ugc nofollow" target="_blank">幸运轮</a>提供所有 AWS 服务，以选择那天查理要审查的可怜灵魂。最终，我们有太多的 AWS 服务，所以我们用它的数字版本取代了它。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div class="er es kh"><img src="../Images/c40e9b56d3888c9bb0da922e8faf848f.png" data-original-src="https://miro.medium.com/v2/resize:fit:750/format:webp/0*uI35cPkeKgXVuhSm.jpg"/></div></figure><p id="a718" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">对于每一个有趣的操作问题，都有一个写好的<a class="ae kf" href="https://wa.aws.amazon.com/wat.concept.coe.en.html" rel="noopener ugc nofollow" target="_blank"> COE(纠错)</a>文档，查理利用周三上午的会议来剖析它。COE 过程有助于确保团队了解根本原因，以一致的方式审查这些原因，并且正确地解决这些原因。Charlie 利用学到的经验确保 AWS 中的每个人都像他一样关心质量和卓越运营。</p><p id="3226" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我清楚地记得在 2016 年的一次周三上午的会议上，查理非常坦率地表达了他对一个特别严重的运营问题的不满，这个问题本应通过更好的监控来发现。我们需要更好的 T2 金丝雀。</p><p id="5dc3" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">金丝雀，可爱的黄色小鸟？</p><p id="6341" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">大约一个世纪前，金丝雀被用于煤矿探测一氧化碳的存在。鉴于它们的高新陈代谢，这些鸟会在人类受到影响之前死于一氧化碳中毒。如果你是一名矿工，只要你能听到鸟儿歌唱，你就没事。当它停止歌唱时，你知道前面有麻烦了，所以是时候离开矿井了。</p><p id="75f7" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这启发了软件工程上下文中的“金丝雀”一词，尽管它在行业中有点超载。</p><p id="c77d" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">像网飞这样的公司创造了这个术语来描述在正式推向所有生产之前将代码部署到测试阶段的<a class="ae kf" href="https://www.infoq.com/presentations/canary-analysis-deployment-pattern/" rel="noopener ugc nofollow" target="_blank"> <em class="kg">过程，并在一段时间内将一小部分生产流量转移到 it </em> </a>以分析是否有任何关键指标受到变化的负面影响。</p><p id="7ae0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在亚马逊，有一种完全不同的东西，我们称之为“金丝雀”金丝雀是针对 <strong class="jl hj"> <em class="kg">生产</em> </strong> <em class="kg">环境连续运行的<em class="kg">测试，验证关键用户场景仍可运行。</em>假设确保您能在 Amazon.com 上购买到特定的牙刷对业务至关重要，那么您将编写一个测试来模拟这样做的客户，并且您将每分钟运行该测试以确保即使在凌晨 3 点，客户也能购买牙刷。最后一步是将您的测试结果与分页系统联系起来，这样当用户场景被破坏时，您就可以得到警告。</em></p><p id="4d8e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">当然，在将代码推向生产之前针对测试阶段进行测试是最重要的，但是即使在将完全有效的代码安全地推向生产之后，事情也可能出错——例如，如果一个关键的依赖项出现问题。因此，针对生产的持续测试也很重要。当然，你可以依赖你已经在常规生产流量上设置的警报。但是问题是生产流量是不确定的，所以你不能保证所有的关键场景都是由客户使用的 T2。如果某件事很重要，你写一个测试，然后 24x7 验证它。</p><p id="1c1a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我一直不太明白亚马逊和网飞历史上是如何以两个完全不同的同名事物告终的，但我认为“金丝雀”的高级概念在这两个地方都是正确的:金丝雀发出某种鸣叫声来表示事情正常，没有积极的鸣叫声则表示有问题。</p><p id="b738" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在 AWS 运营会议开始时，Charlie 非正式地宣布，AWS 中的所有关键业务场景都需要有金丝雀来验证该场景在任何时候都有效。问题是，我们没有很好的工具来做这件事。他指定了一个目的地，但如何到达那里取决于工程师个人。</p><p id="85c9" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我们需要的是能够引导一段测试代码并在多个网络(我们的内部公司和生产网络，以及公共 AWS 区域)中执行它的基础设施。这些代码需要以某个期望的吞吐量(比如每分钟一次)永远执行。它还需要发出通过/失败和延迟等指标，以便工程师能够显示这些指标并发出警报。在 2022 年的今天，使用快速的 AWS Lambda 功能，这种事情相对来说是微不足道的，但在当时，要让这一切都工作起来更难。</p><p id="bfa4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">查理说话时，我突然顿悟了。我有一个具有这种功能的工具！<a class="ae kf" href="https://carloarg02.medium.com/how-i-grew-an-engineering-productivity-tool-to-impact-thousands-of-engineers-at-amazon-and-how-28a990091207" rel="noopener">我创建了负载和性能测试平台，亚马逊用它来确保它的数以千计的服务准备好处理高峰流量</a>(“TPS generator”)。我从未设想它是一个<em class="kg">金丝雀</em>执行平台，但是一旦你抽象地思考你在金丝雀平台中需要什么功能，它惊人地相似。最终，它<em class="kg">是一个以期望的速度执行测试的平台。</em>我用它在潜在的数千台机器上以每秒数百万次的速度运行测试，但是没有什么能阻止我们以每分钟一次的速度运行测试。该平台拥有在所有网络中引导测试的所有正确挂钩，并将正确的指标发布到亚马逊的内部监控系统(我们的内部版本 AWS Cloudwatch)，因此您可以免费获得仪表板和警报等东西——所有金丝雀平台的理想功能！而且，工程师已经知道如何运行 TPSGenerator(用于负载测试)，因为大多数 AWS 服务已经在使用它，所以不会有很大的成本(不需要学习另一个工具)。</p><p id="a557" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我只需要一些小小的改变。我需要一只金丝雀来永远运行<em class="kg"/>，而负载测试平台已经被优化为运行有限的时间。这应该很容易改变！我以为。我应该现在就做！当我打开笔记本电脑，启动我的 IDE (Eclipse)并开始修改代码时，查理的声音突然消失在背景中，就在那里，完全忘记了会议上发生的事情，只是沉浸在我的新技术挑战中。</p><p id="7f12" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">会议持续了两个小时。我疯狂地写了大约一个小时的代码。我添加了一个轻量级守护程序来监控主应用程序的健康状况，如果它不健康，就杀死它并重启它。我对 main()做了一些修改，以便在无限循环中运行。这个想法似乎很可靠，我的概念证明也很有希望。我头晕目眩。</p><p id="3a4b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我合上笔记本电脑，将注意力转回到会议上。大约还有五分钟，Charlie 有力地重申了他的强烈期望，即 AWS 团队需要花时间创建 canaries，一些高级副总裁推迟了他期望的时间，因为执行 canaries 和 alarm 的基础设施不存在。</p><p id="c603" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我羞答答地举起我的手，无视我的每一根纤维，告诉我不要为可能超出我意料的事情签约。毕竟，利用金丝雀的负载和性能测试基础设施的想法有些冲动。谨慎的做法是再等一会儿，冲洗出我的设计，在一两个团队中测试，然后更广泛地介绍它。但是我一激动就没耐心，对事情看涨。有时候你需要趁热打铁。机不可失，时不再来。</p><p id="3523" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">“嗯，查理，我已经改造了 TPSGenerator，使它能够运行金丝雀，它也能处理令人担忧的部分，”我紧张地说，我的嘴很干。</p><p id="a5af" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">查理扬起眉毛。“好的，下周呈现！”他笑着叫了一声，起身离开了。</p><p id="6be5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">就这样，会议结束了，我还没来得及说什么，人们就开始鱼贯离开会议室，奔向他们的下一个会议。</p><p id="2126" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我刚刚注册自己做什么，我在现在空荡荡的房间里面无表情。</p><h1 id="12b0" class="ki kj hi bd kk kl km kn ko kp kq kr ks io kt ip ku ir kv is kw iu kx iv ky kz bi translated">艰苦的工作现在开始了…</h1><p id="92b9" class="pw-post-body-paragraph jj jk hi jl b jm la ij jo jp lb im jr js lc ju jv jw ld jy jz ka le kc kd ke hb bi translated">我回到我的办公桌，再次打开我的笔记本电脑，回到 IDE。那一天，我意识到，如果我的判断没有被那次会议中的兴奋所蒙蔽，一些事情对我来说应该是非常明显的。在一个小时内完成的快速而肮脏的概念证明和对价值十亿美元的业务至关重要的有生产价值的系统之间有着巨大的差异。但是我已经在一个高级副总裁面前多嘴了。我花了几个月的时间和更多的工程师，把我在疯狂的编码咒语中完成的那个蹩脚的黑客技术变成了一个可靠的东西。</p><p id="3bae" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在设计任何系统时，你经常会面临权衡。你当然希望你的系统中有<em class="kg">精度</em>。如果您的负载测试应该每秒生成 100 个事务(“TPS”)，那么您希望它正好生成 100 个，而不是 99 或 101 个。但是在像亚马逊这样规模的公司中，你还需要一个负载生成器，在某些情况下能够生成高达数百万的 TPS，所以<em class="kg">可伸缩性</em>至关重要。在一个分布式系统中，你能无限扩展并且总是精确的吗？不。在某些时候，你必须愿意牺牲一点点来得到另一个。在设计 TPSGenerator 的过程中，我做了一些架构上的权衡，使可伸缩性比精度更好。当你试图以 100 万 TPS 的速度运行负载测试时，加减几个是可以的。更重要的是，您可以生成大量的负载。然而，当您以每分钟 1 个事务的速度运行金丝雀时，准确性很重要，它不可能是 59 秒或 61 秒。所以金丝雀需要的是精确度而不是可扩展性。</p><p id="a48f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这是另一个权衡。在一个负载测试中，可能有成千上万的机器协同工作来生成一个期望的负载，一两台机器在测试过程中死亡并不是什么大问题。机器本质上是牛而不是宠物。事实上，我的架构已经假设，在大规模测试中，至少有一些机器肯定会在测试中失败。所以其他人最终会接手<em class="kg">的工作</em>。金丝雀是低流量的，所以你不需要几千台机器，你需要一台，但是如果那台机器死了，它需要马上被<em class="kg">替换掉</em>。所以<a class="ae kf" href="http://cloudscaling.com/blog/cloud-computing/the-history-of-pets-vs-cattle/" rel="noopener ugc nofollow" target="_blank">是宠物，不是牛</a>。我们做了一些改变，以便在金丝雀模式下，我们有一个主机处于备用状态以获得弹性，这使我们进入了<a class="ae kf" href="https://aws.amazon.com/builders-library/leader-election-in-distributed-systems/" rel="noopener ugc nofollow" target="_blank">领导者选举</a>的业务(我在负载测试架构中设法避免了一点复杂性)。</p><p id="4cca" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在此期间学到的一个教训是，即使两个产品看起来完全相同，您在架构中做出的优化选择也有细微差别。针对可伸缩性而非精确性进行优化，以及针对牛而非宠物进行优化，是负载测试的正确架构选择，但结果却是对 canaries 的基本架构挑战。</p><h1 id="5e78" class="ki kj hi bd kk kl km kn ko kp kq kr ks io kt ip ku ir kv is kw iu kx iv ky kz bi translated">结束语</h1><p id="6124" class="pw-post-body-paragraph jj jk hi jl b jm la ij jo jp lb im jr js lc ju jv jw ld jy jz ka le kc kd ke hb bi translated">那么，最终，利用我为 canaries 构建的负载测试基础设施是一个好的选择吗？</p><p id="e6e1" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">看情况。</p><p id="99f5" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在<strong class="jl hj">技术</strong>方面，事后来看，没有，因为我把两个不一定属于彼此的东西放在一起，虽然表面上看起来<em class="kg">功能上</em>相似，但有完全不同的<em class="kg">非功能性</em>需求。代码中有几个分叉(如果负载测试做 X，如果金丝雀做 Y)是我非常不喜欢的。If 语句像那样把代码弄得乱七八糟，这是一个巨大的反模式，也是一个测试噩梦。</p><p id="5b60" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">而且在技术方面，我们能够用很少的额外代码提供大量的新功能，并利用我们多年来运营该平台积累的大量专业知识，因此也有技术上的胜利。</p><p id="b1ac" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">从商业角度来看，这很好。我们能够为数百项(最终是数千项)真正需要的服务提供即时的商业价值。我们用他们最少的工程劳动和最少的认知努力完成了它，因为它使用了他们已经知道并经常使用的工具。</p><p id="4ca8" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">就职业发展而言，我在金丝雀和可用性方面的工作让我受邀与安迪·贾西(现在是亚马逊的首席执行官，当时是 AWS 的首席执行官)、查理·贝尔和其他高管举行了多次会议。那是一个更亲密、更小的群体，直接接触高层领导对我今天的身份产生了巨大的影响。</p><p id="3b4b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">虽然利用金丝雀进行负载测试并不完美，但我倾向于务实而不是完美主义。今天，在 2022 年，我在 2016 年两个小时的会议中在一位高级副总裁面前疯狂编写的原始代码的惊人的大部分仍在<em class="kg">的生产中强劲运行——这让我笑了。世界以神秘的方式运转；有时候，你只需要顺其自然，拥抱意外之喜。</em></p></div></div>    
</body>
</html>