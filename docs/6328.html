<html>
<head>
<title>CI/CD for Android using GitHub Actions and Gradle Play Publisher</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitHub Actions和Gradle Play Publisher的Android CI/CD</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/ci-cd-for-android-using-github-actions-and-gradle-play-publisher-448bd8e42774?source=collection_archive---------1-----------------------#2022-02-04">https://medium.com/nerd-for-tech/ci-cd-for-android-using-github-actions-and-gradle-play-publisher-448bd8e42774?source=collection_archive---------1-----------------------#2022-02-04</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex if ig ih ii er es paragraph-image"><div class="ab fe cl ij"><img src="../Images/4c3a05569b404fbf04b59b89cc95085d.png" data-original-src="https://miro.medium.com/v2/format:webp/0*kvlk61jHfkDt409H.jpg"/></div></figure><p id="cf26" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">去年我发表了一篇关于使用BitBucket管道和Gradle Play Publisher 的文章。本文解释了如何使用<a class="ae jk" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>做同样的事情，有两个主要区别(除了它使用GitHub而不是BitBucket):</p><ul class=""><li id="0425" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">我将使用用Kotlin(不是Groovy)编写的gradle文件</li><li id="a730" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">我还将解释如何在<a class="ae jk" href="https://play.google.com/console/about/keymanagement/" rel="noopener ugc nofollow" target="_blank"> Play app Signing </a>中注册App</li></ul><p id="219a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">完整的代码样本可以在我的一个演示应用程序中找到:<a class="ae jk" href="https://github.com/1gravity/Android-ColorPicker" rel="noopener ugc nofollow" target="_blank">https://github.com/1gravity/Android-ColorPicker</a>。</p><h1 id="d8ba" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">概观</h1><p id="e64e" class="pw-post-body-paragraph im in hi io b ip kx ir is it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj hb bi translated">设置管道有五个步骤:</p><ol class=""><li id="fa3f" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj lc jr js jt bi translated">我们需要编程访问Google Play来发布和推广应用程序(并管理元数据)-&gt;我们需要一个用于<strong class="io hj"> Google Play开发者API </strong>的API密钥。</li><li id="8a0d" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj lc jr js jt bi translated">该应用需要在<a class="ae jk" href="https://play.google.com/console/about/keymanagement/" rel="noopener ugc nofollow" target="_blank">游戏签约</a>中注册</li><li id="a573" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj lc jr js jt bi translated">我们需要配置<strong class="io hj"> Gradle build </strong>来使用从环境变量中读取签名信息的签名配置。</li><li id="2eea" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj lc jr js jt bi translated">我们需要配置<strong class="io hj"> Gradle Play Publisher </strong>插件来与Google Play交互(上传、发布应用和管理元数据)。</li><li id="580e" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj lc jr js jt bi translated">我们需要配置一个<strong class="io hj"> GitHub动作</strong>来将所有的事情联系在一起。</li></ol><h1 id="129e" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">步骤1: Google Play开发者API</h1><p id="c07b" class="pw-post-body-paragraph im in hi io b ip kx ir is it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj hb bi translated">官方文档详细解释了所有步骤:<a class="ae jk" href="https://developers.google.com/android-publisher/getting_started" rel="noopener ugc nofollow" target="_blank">https://developers . Google . com/Android-publisher/getting _ started</a>。这里有一个总结:</p><ul class=""><li id="714c" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">以帐户所有者的身份进入您的<a class="ae jk" href="https://play.google.com/console/developers" rel="noopener ugc nofollow" target="_blank"> Google Play开发者控制台</a>，打开<a class="ae jk" href="https://play.google.com/console/api-access" rel="noopener ugc nofollow" target="_blank"> <em class="ld"> API访问</em> </a>页面:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es le"><img src="../Images/c7d015ab2d9e0f67c0f6ede4daa3856a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*b1tYdKiU2BNG8IGZ.png"/></div></figure><ul class=""><li id="3582" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">接受服务条款(如果尚未接受)</li><li id="d954" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">如果您还没有创建一个新的Google Cloud项目，请创建一个新的Google Cloud项目(否则请链接一个现有的项目)。</li><li id="ed4e" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">在“<em class="ld">服务账户”</em>下，点击<em class="ld">“创建新服务账户”</em>，打开谷歌云平台链接:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es le"><img src="../Images/f15d1732422eb140df8ac081df426d98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SwnbpaKxmF8-rOxU.png"/></div></div></figure><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es le"><img src="../Images/5cc92987184015c6e4e952e92ecdc689.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zShk_YP1mi2_No-J.png"/></div></figure><ul class=""><li id="49c9" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">在谷歌云平台中点击<em class="ld">“创建服务账户”</em>:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es le"><img src="../Images/56399c249d6649aab906d078628e0dea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*G45yFIpntqf-ugGH.png"/></div></figure><ul class=""><li id="1fb7" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">点击<em class="ld">“创建”</em>按钮之前，选择一个有意义的名称和描述:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es ln"><img src="../Images/ba17217e3f9c03eaf5b82d7c706b7c60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/0*VVpIlOarKxd4RU5-.png"/></div></figure><ul class=""><li id="87a8" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">账户需要角色<em class="ld">“服务账户用户”</em>:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es lo"><img src="../Images/2c4f342d40f9c69a534eda6dcb2a869d.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/0*MjpmudPztSjG8eSb.png"/></div></figure><ul class=""><li id="ea9f" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">您不需要授予用户访问新服务帐户的权限，Google Cloud会自动添加具有正确权限的所需用户(Google Play服务和您自己的用户)，因此只需点击<em class="ld">“完成”</em>:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es lp"><img src="../Images/51050496aef936986340e39341af303c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1380/format:webp/0*PZ-3ftinkpjf-ZKs.png"/></div></figure><ul class=""><li id="a66b" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">接下来，您需要为该帐户创建一个API密钥。<br/>打开动作菜单(三个点)，选择<em class="ld">“管理密钥”</em>:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es le"><img src="../Images/c8d5ce76d8bae3b2cd814a61197fe251.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qquiCwNC4WrJltGI.png"/></div></figure><ul class=""><li id="364a" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">在<em class="ld">“添加密钥”</em>下选择<em class="ld">“创建新密钥”</em>:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es lq"><img src="../Images/5ece7fb163730e67f42af31cae6182c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/0*yWBDTR-rPaJKnVxx.png"/></div></figure><ul class=""><li id="e65c" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">创建一个JSON密钥:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lr"><img src="../Images/06d847e6b9cd1320660d2f6fcd3a545a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/0*Ha8HYEavcakR8mM_.png"/></div></div></figure><ul class=""><li id="3b2e" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">点击<em class="ld">“创建”</em>按钮后，密钥文件将被下载到您的计算机上。我建议重命名该文件，使其目的更加明显:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es ls"><img src="../Images/8096d9b4ed87d3603cbf437e85e66ef7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/format:webp/0*rUt7U27gwNupn4wi.png"/></div></figure><ul class=""><li id="d84f" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">现在，您已经在Google云平台中完成了，您可以返回到Google Play控制台(到API访问屏幕)。新创建的账户应该出现在<em class="ld">“服务账户”</em>下(点击<em class="ld">“刷新服务账户”</em>按钮)。点击<em class="ld">“授权访问”</em>:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es le"><img src="../Images/0a8014d482f957cde8c20d713bf5d6c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BAMdOGw7SFUEhzoD.png"/></div></figure><ul class=""><li id="ec02" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">点击<em class="ld">“添加应用”</em>并选择您想要使用此服务帐户管理的所有应用:</li></ul><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es le"><img src="../Images/3e33c513950def0b2fed92d9f25fe023.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2kOGjtqQvzW98vuV.png"/></div></figure><ul class=""><li id="fff5" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">已经正确设置了帐户权限，因此服务可以管理所有与发布相关的活动(创建发布，包括发布到生产、元数据管理等。).</li><li id="64ed" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated">点击<em class="ld">“邀请用户”</em>就大功告成了。<br/>我们稍后将使用Gradle Play Publisher插件来验证API密钥设置。</li></ul><h1 id="81d7" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">步骤2:启用播放应用签名</h1><p id="a0d5" class="pw-post-body-paragraph im in hi io b ip kx ir is it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj hb bi translated">如果你最近刚刚发布了一个应用，它很可能已经注册了Play App Signing(在这种情况下，你可以跳过本章并转到步骤3)，否则你需要遵循这里解释的步骤:<a class="ae jk" href="https://developer.android.com/studio/publish/app-signing#enroll" rel="noopener ugc nofollow" target="_blank">https://developer . Android . com/studio/publish/App-Signing # enroll</a>。</p><p id="e58f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我将解释我已经在Google Play上发布的一个应用程序的过程。首先，您在Google Play控制台中打开“<em class="ld"> App integrity </em>”页面(在“<em class="ld"> Setup </em>”下):</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lt"><img src="../Images/1b964cb68264472dd7f31472da57bfbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kc-khg5jBe7B8ikprBceHw.png"/></div></div></figure><p id="0b1c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">选择选项“<em class="ld">使用来自Android Studio </em>的现有应用签名密钥”。在继续之前，打开Android Studio并导出密钥，方法是转到“<em class="ld">构建/生成签名捆绑包/APK </em>”，然后选择“<em class="ld"> Android应用捆绑包</em>”选项:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lu"><img src="../Images/e5bd12db06a284d368bcec46b2faae63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8cH3EALDuIYrDQUaLpLIbw.png"/></div></div></figure><p id="0beb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">点击“<em class="ld">下一步</em>，确保“<em class="ld">导出加密密钥，用于在Google Play应用签名中注册已发布的应用</em>”:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lv"><img src="../Images/300feeda38bef34707d8ad706f78395c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nR9Fh_pvaS-9qyE-rCzyLw.png"/></div></div></figure><p id="b6f8" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在下一个屏幕上，选择“<em class="ld">发布</em>”作为构建变体(因此它用发布键签名)，然后单击“<em class="ld">完成</em>”:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lw"><img src="../Images/3c5844cfd383ac11a22b924e25fb31ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6zou6pGg2NplxtimYZD7LQ.png"/></div></div></figure><p id="ef95" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在回到Google Play控制台，点击“<em class="ld">上传私钥</em>”链接，上传您在上一步中导出的密钥:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lx"><img src="../Images/94cf7d53f5491d3b6e8d564062b86c44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PTu0MjnWMGlWyzMbm1yUsg.png"/></div></div></figure><p id="8322" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="ld">接受</em>条款:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ly"><img src="../Images/8aca500ac1ed07e066239b5c4798c3af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*esypEPWFxgwgIBzFibgKwQ.png"/></div></div></figure><p id="b9f5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您现在应该会看到这样一个页面:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lz"><img src="../Images/eae5c45389d0d740e853391de3089ec0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BnrxsOGT8NoOvrBWjFv8cg.png"/></div></div></figure><h1 id="569b" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">第三步:梯度构建</h1><p id="8ed1" class="pw-post-body-paragraph im in hi io b ip kx ir is it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj hb bi translated">Gradle build需要配置成包含一个<a class="ae jk" href="https://developer.android.com/studio/publish/app-signing" rel="noopener ugc nofollow" target="_blank">签名配置</a>，它从环境变量(或者您的<em class="ld"> ~/中的<code class="du ma mb mc md b">gradle.properties</code>文件)中读取秘密。gradle文件夹</em>)。如果你已经有一个，那么你可以跳过这一章。</p><p id="2d5f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">假设您在Google Play中有一个已发布的应用程序，并且您有权访问密钥库和包括密码在内的签名密钥(或上传密钥)(否则您将无法完成上一步)。</p><p id="a488" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">对于本地构建，密钥库的位置、密钥库密码、密钥别名和密钥密码将在您的<code class="du ma mb mc md b">~/.gradle/gradle.properties</code>文件中配置。</p><p id="5a7f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您没有<code class="du ma mb mc md b">~/.gradle/gradle.properties</code>文件，请创建一个并添加以下四个参数(粗体部分需要根据您的设置进行配置):</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="8948" class="mi ka hi md b fi mj mk l ml mm">KEYSTORE_FILE=/<strong class="md hj">path to the keystore file</strong>/<strong class="md hj">playstore.keystore</strong><br/>KEYSTORE_PASSWORD=<strong class="md hj">keystore password</strong><br/>KEY_ALIAS=<strong class="md hj">key alias</strong><br/>KEY_PASSWORD=<strong class="md hj">key password</strong></span></pre><p id="8bf1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">注意:不要使用~作为您的主目录，而是使用绝对路径。~在shell上下文中工作，但不能与Gradle和Gradle Play Publisher一起使用。</p><p id="55d9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">在应用的<code class="du ma mb mc md b">gradle.build.kts</code>文件中创建签名配置:</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="238b" class="mi ka hi md b fi mj mk l ml mm">create("release") <strong class="md hj">{<br/>    </strong>storeFile = file(<em class="ld">project</em>.property("KEYSTORE_FILE").<em class="ld">toString</em>())<br/>    storePassword = <em class="ld">project</em>.property("KEYSTORE_PASSWORD").<em class="ld">toString</em>()<br/>    keyAlias = <em class="ld">project</em>.property("KEY_ALIAS").<em class="ld">toString</em>()<br/>    keyPassword = <em class="ld">project</em>.property("KEY_PASSWORD").<em class="ld">toString</em>()<br/><strong class="md hj">}</strong></span></pre><p id="9e06" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将签名配置添加到生成类型:</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="399f" class="mi ka hi md b fi mj mk l ml mm">buildTypes <strong class="md hj">{<br/></strong>    getByName("debug") {<br/>        // more stuff here<br/>        signingConfig = signingConfigs.getByName(<em class="ld">name</em>)<br/>    }<br/><br/><strong class="md hj">    </strong>getByName("release") <strong class="md hj">{<br/></strong>        // more stuff here<br/>        signingConfig = signingConfigs.getByName(<em class="ld">name</em>)<br/>    }<br/>}</span></pre><p id="bea1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果签名配置是正确的，那么下面的命令应该运行并在您的<em class="ld">构建/输出/捆绑包</em>文件夹中创建一个或多个aab文件</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="6af9" class="mi ka hi md b fi mj mk l ml mm">./gradlew bundle</span></pre><h1 id="6fca" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">版本代码</h1><p id="2548" class="pw-post-body-paragraph im in hi io b ip kx ir is it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj hb bi translated">应用程序的版本代码需要随着新版本的增加而增加(参见<a class="ae jk" href="https://developer.android.com/studio/publish/versioning" rel="noopener ugc nofollow" target="_blank">https://developer.android.com/studio/publish/versioning</a>)。因为没有简单的方法来定义自动递增的版本号，所以我们将使用从UTC时间戳派生的版本代码(参见步骤5)。在app的<code class="du ma mb mc md b"><em class="ld">gradle.build.kts</em></code>中的<em class="ld">替换为:</em></p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="ca48" class="mi ka hi md b fi mj mk l ml mm">versionCode = 124</span></pre><p id="3375" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">使用:</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="ac5c" class="mi ka hi md b fi mj mk l ml mm">versionCode = <em class="ld">project</em>.<em class="ld">properties</em>["BUILD_NUMBER"]<br/>    ?.toString()?.<em class="ld">toInt</em>()?.minus(1643952714)<br/>    ?: 124</span></pre><p id="a69e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这将读取版本代码作为一个属性，并减去1643952714 (1643952714 = Fri，2022年2月4日5:31:54 AM GMT)，以确保版本代码不会很快达到最大值21000000000(从现在起大约14年后，2100000000 = Fri，2036年7月18日1:20:00 PM GMT)。如果没有参数传入(本地构建)，它将在Elvis操作符？:.</p><h1 id="febf" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">第四步:格雷迪扮演出版商</h1><p id="a11d" class="pw-post-body-paragraph im in hi io b ip kx ir is it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj hb bi translated">我们现在能够构建应用程序并创建签名捆绑包(或apk ),但我们仍然需要配置<a class="ae jk" href="https://github.com/Triple-T/gradle-play-publisher" rel="noopener ugc nofollow" target="_blank"> Gradle Play Publisher </a>将签名应用程序发布到Google Play。</p><p id="dd18" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我们也可以使用<a class="ae jk" href="https://fastlane.tools/" rel="noopener ugc nofollow" target="_blank">浪子</a>来做这件事，但是我不推荐走那条路(去过那里，做过那件事)。相信我这一次…</p><p id="2ef0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">安装Gradle Play Publisher插件很简单(参见<a class="ae jk" href="https://github.com/Triple-T/gradle-play-publisher" rel="noopener ugc nofollow" target="_blank">https://github.com/Triple-T/gradle-play-publisher</a>):</p><ul class=""><li id="0e01" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">将插件添加到应用程序的<code class="du ma mb mc md b">gradle.build.kts</code>文件中:</li></ul><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="7dbf" class="mi ka hi md b fi mj mk l ml mm">plugins {<br/>    id("com.android.application")<br/><strong class="md hj">    id("com.github.triplet.play") version "3.7.0"<br/></strong>    // other plugins<br/>}</span></pre><ul class=""><li id="5517" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated">将配置块添加到应用程序的<code class="du ma mb mc md b">gradle.build.kts</code>(在android块之后):</li></ul><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="6ec8" class="mi ka hi md b fi mj mk l ml mm"><strong class="md hj"><em class="ld">play </em>{<br/>    val apiKeyFile = <em class="ld">project</em>.property("googlePlayApiKey").<em class="ld">toString</em>()<br/>    serviceAccountCredentials.set(file(apiKeyFile))<br/>    track.set("internal")<br/>}</strong></span></pre><p id="1ec4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">您会注意到“<em class="ld">Google playapikey”</em>参数。它是对我们在为服务帐户设置密钥时得到的api密钥文件的引用-&gt;<em class="ld">Google-play-API-key . JSON</em>。该参数需要在<code class="du ma mb mc md b">~/.gradle/gradle.properties</code>中定义(类似签约配置参数):</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="2894" class="mi ka hi md b fi mj mk l ml mm">googlePlayApiKey=/some-path/google-play-api-key.json</span></pre><p id="5bd7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果一切设置正确，当从应用程序的根目录运行以下命令时，将下载应用程序的元数据:</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="97de" class="mi ka hi md b fi mj mk l ml mm">./gradlew bootstrapListing</span></pre><h1 id="ba5e" class="jz ka hi bd kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw bi translated">步骤5: GitHub操作</h1><h2 id="04bf" class="mi ka hi bd kb mn mo mp kf mq mr ms kj ix mt mu kn jb mv mw kr jf mx my kv mz bi translated">仓库机密</h2><p id="3076" class="pw-post-body-paragraph im in hi io b ip kx ir is it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj hb bi translated">首先，我们需要配置作为参数传递给Gradle build的秘密:</p><ul class=""><li id="9230" class="jl jm hi io b ip iq it iu ix jn jb jo jf jp jj jq jr js jt bi translated"><em class="ld"> GOOGLE_PLAY_API_KEY </em></li><li id="238c" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><em class="ld">密钥库_文件</em></li><li id="013f" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><em class="ld">密钥库_密码</em></li><li id="4931" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><em class="ld"> KEY_ALIAS </em></li><li id="6f75" class="jl jm hi io b ip ju it jv ix jw jb jx jf jy jj jq jr js jt bi translated"><em class="ld">钥匙_密码</em></li></ul><p id="6258" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">很容易为<em class="ld"> KEYSTORE_PASSWORD、KEY_ALIAS </em>和<em class="ld"> KEY_PASSWORD </em>定义三个值，因为它们只是文本值。为此，进入<em class="ld">“存储库设置”</em>，选择<em class="ld">“机密/操作”</em>。用正确的值输入所有三个变量:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es na"><img src="../Images/d6fd96e3bb034f130109add325f644dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vonJTssLK0Xtojxn786fng.png"/></div></div></figure><p id="4da2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">为了将<em class="ld"> KEYSTORE_FILE和GOOGLE_PLAY_API_KEY </em>存储为存储库秘密变量，我们对文件进行了base64编码。构建管道将对其进行解码并重新创建原始文件(见下文)。</p><p id="91d3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">运行以下命令对这两个文件进行编码:</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="72cb" class="mi ka hi md b fi mj mk l ml mm">base64 google-play-api-key.json &gt; google-play-api-key.json.base64<br/>base64 playstore.keystore &gt; playstore.keystore.base64</span></pre><p id="7642" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">复制base64字符串并在GitHub中创建存储库机密。您现在应该有这样的东西:</p><figure class="lf lg lh li fd ii er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es nb"><img src="../Images/d8c30ee24f2c662c3d21e6f267e4764c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pQIKOHXuCB9VazBEjz67Tg.png"/></div></div></figure><h2 id="fcde" class="mi ka hi bd kb mn mo mp kf mq mr ms kj ix mt mu kn jb mv mw kr jf mx my kv mz bi translated">GitHub操作</h2><p id="151b" class="pw-post-body-paragraph im in hi io b ip kx ir is it ky iv iw ix kz iz ja jb la jd je jf lb jh ji jj hb bi translated">我们有了秘密，现在是时候创建GitHub操作了。首先创建一个目录<code class="du ma mb mc md b">.github/workflows</code>和文件<code class="du ma mb mc md b">publish_google_play.yml:</code></p><figure class="lf lg lh li fd ii er es paragraph-image"><div class="er es nc"><img src="../Images/2925074282f3bd7189dbe1424c65ea4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*pm5qSrtZGFiSuXz7W2mVBQ.png"/></div></figure><p id="f6e7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">你可以在我的一个演示应用<a class="ae jk" href="https://github.com/1gravity/Android-ColorPicker/blob/master/.github/workflows/publish_google_play.yml" rel="noopener ugc nofollow" target="_blank">这里</a>找到一个完整的例子，因为你可以在这里阅读关于GitHub动作<a class="ae jk" href="https://docs.github.com/en/actions" rel="noopener ugc nofollow" target="_blank">的基础知识，我不会解释所有的细节，而是专注于发布过程的细节。</a></p><p id="9f4c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><strong class="io hj">内部版本号</strong>:我们上面提到过我们想要创建一个基于时间戳的版本代码，这就是我们的做法:</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="2e95" class="mi ka hi md b fi mj mk l ml mm"><em class="ld"># Create a build number based on timestamp / UTC time<br/></em>- name: set release date<br/>  run: |<br/>    echo "BUILD_NUMBER=$(date +"%s")" &gt;&gt; ${GITHUB_ENV}</span></pre><p id="c047" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这定义了一个环境变量<code class="du ma mb mc md b">BUILD_NUMBER</code>，并将时间戳(UTC)赋值。</p><p id="9253" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">由于我们的Gradle构建将文件路径/名称作为参数，因此需要从秘密中提取出<strong class="io hj">密钥库文件</strong>并将其写入文件。我们将使用这个动作为这个:【https://github.com/timheuer/base64-to-file<a class="ae jk" href="https://github.com/timheuer/base64-to-file" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="b6aa" class="mi ka hi md b fi mj mk l ml mm"><em class="ld"># Decode the keystore file containing the signing key<br/></em>- name: Decode Keystore<br/>  id: decode_keystore<br/>  uses: timheuer/base64-to-file@v1.1<br/>  with:<br/>    fileDir: './secrets'<br/>    fileName: 'my.keystore'<br/>    encodedString: ${{ secrets.KEYSTORE_FILE }}</span></pre><p id="30c7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">Google Play API密钥文件的提取方式相同:</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="ff95" class="mi ka hi md b fi mj mk l ml mm"><em class="ld"># Decode the Google Play api key file<br/></em>- name: Decode Google Play API key<br/>  id: decode_api_key<br/>  uses: timheuer/base64-to-file@v1.1<br/>  with:<br/>    fileDir: './secrets'<br/>    fileName: 'google-play-api-key.json'<br/>    encodedString: ${{ secrets.GOOGLE_PLAY_API_KEY }}</span></pre><p id="7ea9" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">现在剩下要做的就是用正确的参数调用Gradle:</p><pre class="lf lg lh li fd me md mf mg aw mh bi"><span id="20fa" class="mi ka hi md b fi mj mk l ml mm"><em class="ld"># Build bundle and publish to Google Play<br/></em>- name: Build &amp; publish to Google Play<br/>  run: ./gradlew<br/>    -PBUILD_NUMBER="${{ env.BUILD_NUMBER }}"<br/>    -PgooglePlayApiKey="../${{ steps.decode_api_key.outputs.filePath }}"<br/>    -PKEYSTORE_FILE="../${{ steps.decode_keystore.outputs.filePath }}"<br/>    -PKEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}<br/>    -PKEY_ALIAS=${{ secrets.KEY_ALIAS }}<br/>    -PKEY_PASSWORD=${{ secrets.KEY_PASSWORD }}<br/>    publishBundle --max-workers 1</span></pre><p id="3a7b" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">就是这样。享受快乐编码！</p></div></div>    
</body>
</html>