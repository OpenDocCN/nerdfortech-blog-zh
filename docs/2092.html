<html>
<head>
<title>GraphQL and Search Engine with Laravel 8</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GraphQL和带有Laravel 8的搜索引擎</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/graphql-and-search-engine-with-laravel-8-eb47d6cf16ca?source=collection_archive---------6-----------------------#2021-04-20">https://medium.com/nerd-for-tech/graphql-and-search-engine-with-laravel-8-eb47d6cf16ca?source=collection_archive---------6-----------------------#2021-04-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7ffc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我使用<em class="jd"> GraphQL </em>作为REST APIs的替代品，允许我有一个单一的入口点，并在我需要的时候获取我需要的东西，并有可能浏览我雄辩的关系。这也使我能够大幅减少大量型号的控制器数量。</p><p id="3680" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">起点将取决于您的实际环境，就我个人而言，我使用的是<em class="jd"> Laradock </em>，这是一个Docker Compose栈，提供了许多现成可用的服务。以下内容针对我的工作方式，仅供参考。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="109d" class="jn jo hi jj b fi jp jq l jr js">docker-compose up -d workspace nginx mysql phpmyadmin</span><span id="39bf" class="jn jo hi jj b fi jt jq l jr js">docker-compose exec workspace bash</span><span id="a717" class="jn jo hi jj b fi jt jq l jr js">composer create-project laravel/laravel .</span><span id="aa45" class="jn jo hi jj b fi jt jq l jr js">php artisan migrate // after editing properly my .env to use same mysql credential as Laradock</span></pre></div><div class="ab cl ju jv gp jw" role="separator"><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz ka"/><span class="jx bw bk jy jz"/></div><div class="hb hc hd he hf"><p id="8250" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了制作我们的<em class="jd"> GraphQL </em> API，我们将使用nuwave/lighthouse包，它包含必要的功能和模式实现。</p><div class="kb kc ez fb kd ke"><a href="https://github.com/nuwave/lighthouse" rel="noopener  ugc nofollow" target="_blank"><div class="kf ab dw"><div class="kg ab kh cl cj ki"><h2 class="bd hj fi z dy kj ea eb kk ed ef hh bi translated">巨浪/灯塔</h2><div class="kl l"><h3 class="bd b fi z dy kj ea eb kk ed ef dx translated">Lighthouse是一个与您的Laravel应用程序集成的GraphQL框架。它吸收了两者的最佳思想…</h3></div><div class="km l"><p class="bd b fp z dy kj ea eb kk ed ef dx translated">github.com</p></div></div><div class="kn l"><div class="ko l kp kq kr kn ks kt ke"/></div></div></a></div><p id="666b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我还想添加一个搜索引擎。这是可选的，但我发现通过关键字找到我们的资源真的很有用，我们将使用<em class="jd"> Laravel Scout </em>和<em class="jd"> tntsearch </em>驱动程序将我们的索引存储到我们应用程序内的<em class="jd"> sqlite </em>数据库中，这是一个简单的驱动程序，可能会带来一些麻烦，主要是电子邮件索引，你可以使用其他驱动程序，如<em class="jd"> Algolia，Elastic，TypeSens，MeiliSearch </em>...如果你不想要，就忽略step around <em class="jd"> Scout </em>和<em class="jd"> tntsearch </em>。我真的更喜欢使用索引系统，而不是在代码中的某个地方制造一个难看的whereLike()链！</p><div class="kb kc ez fb kd ke"><a href="https://laravel.com/docs/8.x/scout" rel="noopener  ugc nofollow" target="_blank"><div class="kf ab dw"><div class="kg ab kh cl cj ki"><h2 class="bd hj fi z dy kj ea eb kk ed ef hh bi translated">拉勒维尔童子军</h2><div class="kl l"><h3 class="bd b fi z dy kj ea eb kk ed ef dx translated">Laravel Scout提供了一个简单的、基于驱动程序的解决方案，为您的雄辩模型添加全文搜索。使用模型…</h3></div><div class="km l"><p class="bd b fp z dy kj ea eb kk ed ef dx translated">laravel.com</p></div></div></div></a></div><div class="kb kc ez fb kd ke"><a href="https://github.com/teamtnt/tntsearch" rel="noopener  ugc nofollow" target="_blank"><div class="kf ab dw"><div class="kg ab kh cl cj ki"><h2 class="bd hj fi z dy kj ea eb kk ed ef hh bi translated">team TNT/TNT搜索</h2><div class="kl l"><h3 class="bd b fi z dy kj ea eb kk ed ef dx translated">TNTSearch是一个完全用PHP编写的全功能全文搜索(FTS)引擎。简单的配置允许您…</h3></div><div class="km l"><p class="bd b fp z dy kj ea eb kk ed ef dx translated">github.com</p></div></div><div class="kn l"><div class="ku l kp kq kr kn ks kt ke"/></div></div></a></div><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="e7e2" class="jn jo hi jj b fi jp jq l jr js">composer require nuwave/lighthouse laravel/scout teamtnt/laravel-scout-tntsearch-driver</span></pre><p id="f0bb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我们的包被安装，我们将配置我们的应用程序来使用它们，首先我们想通过编辑config/app.php文件将<em class="jd"> Laravel Scout </em>和<em class="jd"> tntseach </em>添加到我们的服务提供者中:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="6ec0" class="jn jo hi jj b fi jp jq l jr js">'providers' =&gt; [</span><span id="9e37" class="jn jo hi jj b fi jt jq l jr js">  // default Providers ...</span><span id="eaf4" class="jn jo hi jj b fi jt jq l jr js">  Laravel\Scout\ScoutServiceProvider::class,<br/>  TeamTNT\Scout\TNTSearchScoutServiceProvider::class,<br/>]</span></pre><p id="b423" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后我们会发布一些文件:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="5d92" class="jn jo hi jj b fi jp jq l jr js">php artisan vendor:publish --provider=”Laravel\Scout\ScoutServiceProvider”</span><span id="583d" class="jn jo hi jj b fi jt jq l jr js">php artisan vendor:publish --tag=lighthouse-schema</span></pre><p id="19e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们将编辑新发布的config/scout.php，添加tntsearch的默认配置:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="1bcd" class="jn jo hi jj b fi jp jq l jr js">'tntsearch' =&gt; [<br/>  'storage'  =&gt; storage_path(),<br/>  'fuzziness' =&gt; env('TNTSEARCH_FUZZINESS', false),<br/>  'fuzzy' =&gt; [<br/>    'prefix_length' =&gt; 2,<br/>    'max_expansions' =&gt; 50,<br/>    'distance' =&gt; 2<br/>  ],<br/>  'asYouType' =&gt; false,<br/>  'searchBoolean' =&gt; env('TNTSEARCH_BOOLEAN', false),<br/>  'maxDocs' =&gt; env('TNTSEARCH_MAX_DOCS', 500),<br/>],</span></pre><p id="a9bf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">而且精确到我们的。env我们想用它:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="f5da" class="jn jo hi jj b fi jp jq l jr js">SCOUT_DRIVER=tntsearch</span></pre><p id="e298" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">对于其余的，我想偷懒，用我的用户模型工作，我必须像这样编辑它，让tell Scout索引一些字段:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="a517" class="jn jo hi jj b fi jp jq l jr js">use Laravel\Scout\Searchable;</span><span id="8545" class="jn jo hi jj b fi jt jq l jr js">class User extends Authenticatable<br/>{<br/>  use HasFactory, Notifiable, Searchable;</span><span id="2677" class="jn jo hi jj b fi jt jq l jr js">  /**<br/>  * Get the indexable data array for the model.<br/>  *<br/>  * @return array<br/>  */<br/>  public function toSearchableArray() : array<br/>  {<br/>     return [<br/>       'id' =&gt; $this-&gt;id,<br/>       'name' =&gt; $this-&gt;name,<br/>       'email' =&gt; $this-&gt;email<br/>     ];<br/>  }</span><span id="d076" class="jn jo hi jj b fi jt jq l jr js">  // rest of User Model</span></pre><p id="4df7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Laravel已经为这个模型提供了一个工厂(database/factories/UserFactory)，所以我可以直接用Laravel Tinker生成一百个假用户:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="5e4c" class="jn jo hi jj b fi jp jq l jr js">php artisan tinker</span><span id="ac87" class="jn jo hi jj b fi jt jq l jr js">&gt;&gt; User::factory()-&gt;count(100)-&gt;create() // This will store 100 User in my database</span><span id="f135" class="jn jo hi jj b fi jt jq l jr js">php artisan tntsearch:import App\\Models\\User</span></pre><p id="0f94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所以，现在我们已经实现了<em class="jd"> GraphQL </em>并处理了一些数据。我们可以开始尝试这个了！对于它，我用的是altar<a class="ae kv" href="https://addons.mozilla.org/fr/firefox/addon/altair-graphql-client/" rel="noopener ugc nofollow" target="_blank">https://addons . Mozilla . org/fr/Firefox/addon/Altair-graph QL-client/</a>，Mozilla Firefox的一个扩展，随便用你喜欢的客户端。注意，Laravel的游乐场是存在的【https://github.com/graphql/graphql-playground T4】但是我不喜欢在我实现GraphQL的每个项目上都安装它，我更喜欢使用一个独特的外部工具。</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="bbfe" class="jn jo hi jj b fi jp jq l jr js">POST <a class="ae kv" href="http://localhost/graphql" rel="noopener ugc nofollow" target="_blank">http://localhost/graphql</a></span><span id="9659" class="jn jo hi jj b fi jt jq l jr js">{<br/>   users {<br/>     data {<br/>       name<br/>       email <br/>     }<br/>     paginatorInfo {<br/>       currentPage <br/>       hasMorePages<br/>       lastPage<br/>     }<br/>   }<br/>}</span></pre><p id="a9ee" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">它将返回如下内容:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="f9ae" class="jn jo hi jj b fi jp jq l jr js">{<br/>  "data": {<br/>    "users": {<br/>      "data": [<br/>        {<br/>          "name": "Dr. Alan Mitchell",<br/>          "email": "<a class="ae kv" href="mailto:pietro46@example.org" rel="noopener ugc nofollow" target="_blank">pietro46@example.org</a>"<br/>        },<br/>        ...<br/>      ],<br/>      "paginatorInfo": {<br/>        "currentPage": 1,<br/>        "hasMorePages": true,<br/>        "lastPage": 10<br/>      }<br/>    }  <br/>  }<br/>}</span></pre><p id="58d9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了添加我们的搜索引擎，我们必须编辑我们的graphql模式(默认情况下在。/graphl/schema.graphql)将“搜索”指令添加到用户查询中:</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="086d" class="jn jo hi jj b fi jp jq l jr js">type Query {<br/>  users(search: String @search): [User!]! @paginate(defaultCount: 10)<br/>}</span></pre><p id="6f54" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">并尝试它(双引号是强制性的，没有单引号！):</p><pre class="je jf jg jh fd ji jj jk jl aw jm bi"><span id="860a" class="jn jo hi jj b fi jp jq l jr js">POST <a class="ae kv" href="http://localhost/graphql" rel="noopener ugc nofollow" target="_blank">http://localhost/graphql</a></span><span id="54cf" class="jn jo hi jj b fi jt jq l jr js">{<br/>   users(search: "Alan") {<br/>     data {<br/>       name<br/>       email <br/>     }<br/>     paginatorInfo {<br/>       currentPage <br/>       hasMorePages<br/>       lastPage<br/>     }<br/>   }<br/>}</span></pre><p id="41f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这将返回这个名称或电子邮件中包含Alan的所有用户，这取决于在User::toSearchableArray()方法中确定的索引！</p><p id="ca61" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样，这是构建我们的GraphQL API的一个非常有效的起点！如果你真的不了解GraphQL，除了想了解更多，看看php lighthouse文档:<a class="ae kv" href="https://lighthouse-php.com/master/api-reference/directives.html" rel="noopener ugc nofollow" target="_blank">https://light house-PHP . com/master/API-reference/directives . html</a>。</p></div></div>    
</body>
</html>