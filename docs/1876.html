<html>
<head>
<title>Recursive DNS+AD-Blocker — Part 2: Installing Pi-hole without caching on Synology NAS with Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">递归DNS+广告拦截器—第2部分:使用Docker在Synology NAS上安装不带缓存的Pi-hole</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/recursive-dns-ad-blocker-part-2-installing-pi-hole-without-caching-on-synology-nas-with-docker-5363bc7258f4?source=collection_archive---------4-----------------------#2021-04-11">https://medium.com/nerd-for-tech/recursive-dns-ad-blocker-part-2-installing-pi-hole-without-caching-on-synology-nas-with-docker-5363bc7258f4?source=collection_archive---------4-----------------------#2021-04-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="9962" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">用Docker在Synology NAS上安装Pi-hole很简单，禁用缓存就不简单了，所以让我们看看如何做。您还将学习如何构建自己的docker映像来覆盖默认的缓存设置。如果你没有在Synology box上运行Docker，那么Key info是通用的，所以它对于其他Docker安装也是有价值的。</h2></div><p id="5630" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">【2021年4月18日更新:在Docker Hub上添加了我的公共<a class="ae ju" href="https://hub.docker.com/r/giannicostanzi/pihole-nocache" rel="noopener ugc nofollow" target="_blank"><em class="jt">giannicostanzi/pihole-nocache</em></a><em class="jt">图片的链接</em></p><p id="cd8b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">【2021年5月1日更新:在我的GitHub页面<a class="ae ju" href="https://github.com/MightySlaytanic/pihole-nocache" rel="noopener ugc nofollow" target="_blank"><em class="jt">MightySlaytanic/pihole-nocache</em></a>上添加了Dockerfile源文件的链接</p><p id="9738" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj"> <em class="jt">更新2023年1月26日</em> </strong> : <em class="jt">官方Pi-hole容器有CUSTOM_CACHE_SIZE，允许您将CACHE_SIZE设置为零，而不需要我的自定义图像</em></p><h2 id="89b7" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated"><strong class="ak">简介</strong></h2><p id="5a2d" class="pw-post-body-paragraph ix iy hi iz b ja kq ij jc jd kr im jf jg ks ji jj jk kt jm jn jo ku jq jr js hb bi translated">在上一篇文章<a class="ae ju" href="https://giannicostanzi.medium.com/recursive-dns-resolver-with-ad-blocking-features-dea766d4f703" rel="noopener"> <strong class="iz hj">具有广告拦截功能的递归DNS解析器</strong> </a> <strong class="iz hj"> </strong>中，我解释了如何在Raspberry Pi设备上实现一个DNS解析器，它可以拦截广告和恶意网站(Pi-hole)并递归解析域名(非绑定)，而不依赖于Google ones之类的官方DNS服务器。正如我在那篇文章中所说的，我已经在我的家庭网络中部署了两个Pi-hole和两个非绑定服务器，以便在我进行维护时有一点冗余，并获得一点乐趣:)第一个Pi-hole+非绑定堆栈部署在RPi3上，所以我必须为第二个堆栈选择另一个24x7x365活动的家庭设备:我的Synology DS218+ NAS with Docker是完美的解决方案。这一次我们将重点放在Pi-hole安装上，剩下的将在另一篇文章中讨论。</p><p id="122c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这篇文章是关于Synology Docker的，但是你能找到的信息可以完美地应用到任何你运行Docker的设备上。如果你开始在Synology上没有GUI的设备上使用docker，看看<a class="ae ju" href="https://registry.hub.docker.com/r/portainer/portainer" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj">portainer/portainer</strong></a>容器，它可以提供一个Web GUI来管理Docker的图像、容器、卷等。</p><p id="ad1d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我假设您已经通过包管理器在Synology上安装并配置了Docker。截图是意大利语的，但我认为通过查看界面上元素的定位，会很容易理解您的语言中的等效内容。</p><h2 id="e0cb" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated"><strong class="ak">安装墩孔</strong></h2><p id="e310" class="pw-post-body-paragraph ix iy hi iz b ja kq ij jc jd kr im jf jg ks ji jj jk kt jm jn jo ku jq jr js hb bi translated">首先打开Docker app，进入注册表，搜索pihole。选择<em class="jt"> pihole/pihole </em>图像，按下载，选择<em class="jt">最新</em>标签。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es kv"><img src="../Images/a01a171549783da655cdbd44c34b484f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IfL2-TfNFe9poEITpuFX1Q.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">Pi-hole图像下载</figcaption></figure><p id="3fad" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，在使用此映像启动新容器之前，准备以下文件夹结构(您可以通过File Station应用程序创建):</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="4a2d" class="jv jw hi lm b fi lq lr l ls lt">/volume1/docker/pihole/etc-dnsmasq.d<br/>/volume1/docker/pihole/etc-pihole<br/>/volume1/docker/pihole/etc.pihole_advanced</span></pre><p id="4c49" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注意:</strong> <em class="jt"> /volume1 </em>是一个您可以通过SSH CLI看到的文件夹，它包含您的NAS上的共享文件夹。我不记得docker共享文件夹是否是由Docker应用程序安装程序创建的，否则您可以通过Synology GUI创建它，然后您可以继续创建pihole子文件夹。</p><p id="85e9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如您在pihole/pihole 的<a class="ae ju" href="https://registry.hub.docker.com/r/pihole/pihole/" rel="noopener ugc nofollow" target="_blank"> Docker Hub页面上看到的，当您需要重新创建容器来更新映像时，前两个文件夹需要安装在容器中，以便为您的配置提供数据持久性。第三种方法是将CACHE_SIZE设置为零(阅读上一篇文章以理解为什么我们希望它为零)，我将在后面解释这种方法。</a></p><p id="3cc5" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">第一次钻孔运行</strong></p><p id="2708" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您可以进入Synology上Docker应用程序的图像部分，选择<em class="jt"> pihole/pihole:最新</em>并按下<em class="jt"> Launch </em>。应用程序会询问您容器的初始配置。根据需要设置名称(默认为<em class="jt">p hole-p hole 1</em>)并按下Advanced以配置高级选项。如果您愿意，启用自动重启，然后转到<em class="jt">卷</em>选项卡:这里我们将挂载前两个文件夹，忽略第三个，方法是按下Add Folder，选择您之前创建的文件夹，然后将它们挂载到具有读/写权限的正确路径上(我通常在synology上称文件夹为将使用破折号而不是斜线挂载的路径):</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lu"><img src="../Images/d8f753392b1488935a3f73310e7fe231.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mA75HS--75YBMsHrHFDOFg.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">卷的绑定装载</figcaption></figure><p id="fa88" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后在端口设置选项卡上移动，将您希望可到达的端口暴露给外部。特别是，我要揭露:</p><ul class=""><li id="55b9" class="lv lw hi iz b ja jb jd je jg lx jk ly jo lz js ma mb mc md bi translated">53/UDP和53/TCP端口上的DNS服务</li><li id="0e34" class="lv lw hi iz b ja me jd mf jg mg jk mh jo mi js ma mb mc md bi translated">8080/TCP端口上的HTTP服务(GUI)</li></ul><p id="647a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在将HTTP端口迁移到8080/TCP(Synology使用80/TCP)时，我将暴露原始端口上的DNS端口(家庭设备不能指向其他非标准端口进行DNS解析):</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es lu"><img src="../Images/d75139e494e3d2367fe28a1893f1852e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jIJ-TX9gfOzQyoAuri8sFQ.png"/></div></div></figure><p id="8216" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注意:</strong> Synology GUI向您展示了Dockerfile清单中声明的由容器公开的服务，默认情况下，它在自动分配的端口上公开这些服务。如果您不想公开一些容器的服务，或者您可以在静态已知的端口上公开它们，您可以删除这样的映射。</p><p id="9959" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">转到环境选项卡(最后一个),将名为<em class="jt"> WEBPASSWORD </em>的变量设置为您将用来访问HTTP GUI的管理员密码(如果您不设置它，它将随机生成，您可以通过双击容器然后双击日志选项卡在容器日志中看到它)。</p><p id="25a9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">配置完成后，应用设置并让Synology Docker启动新创建的容器。</p><p id="5057" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">将CACHE_SIZE设置为零</strong></p><p id="2d0e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">正如我们在上一篇文章中看到的，我们需要禁用缓存，以便让未绑定预取和缓存按预期工作。我试图通过环境变量或者修改synology共享文件夹中的<em class="jt">/etc/pihole/setup vars . conf</em>来设置<em class="jt"> CACHE_SIZE=0 </em>(就像我在RPi3上所做的那样),但是没有成功。经过一点研究，我明白了由容器自动执行的初始化脚本<em class="jt"> /root/ph_install.sh </em>通过替换包含在<em class="jt"> /etc/中的值来配置dnsmasq(负责整个dns解析和缓存的进程)。pi hole/advanced/01-pi hole . conf</em>与<em class="jt"> setupVars.conf </em>中包含的值，然后将该文件复制到<em class="jt">/etc/dnsmasq . d/01-pi hole . conf。</em>奇怪的是，它没有从<em class="jt"> setupVars.conf </em>中获取<em class="jt"> CACHE_SIZE </em>，而是在脚本中包含了一个<em class="jt"> CACHE_SIZE=10000 </em>。</p><p id="591a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这就是<em class="jt"> /etc/的内容。pi hole/advanced/01-pi hole . conf</em></p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="a178" class="jv jw hi lm b fi lq lr l ls lt"># Pi-hole: A black hole for Internet advertisements<br/># (c) 2017 Pi-hole, LLC (<a class="ae ju" href="https://pi-hole.net" rel="noopener ugc nofollow" target="_blank">https://pi-hole.net</a>)<br/># Network-wide ad blocking via your own hardware.<br/>#<br/># Dnsmasq config for Pi-hole's FTLDNS<br/>#<br/># This file is copyright under the latest version of the EUPL.<br/># Please see LICENSE file for your rights under this license.</span><span id="3972" class="jv jw hi lm b fi mj lr l ls lt">###############################################################################<br/>#      FILE AUTOMATICALLY POPULATED BY PI-HOLE INSTALL/UPDATE PROCEDURE.      #<br/># ANY CHANGES MADE TO THIS FILE AFTER INSTALL WILL BE LOST ON THE NEXT UPDATE #<br/>#                                                                             #<br/>#        IF YOU WISH TO CHANGE THE UPSTREAM SERVERS, CHANGE THEM IN:          #<br/>#                      /etc/pihole/setupVars.conf                             #<br/>#                                                                             #<br/>#        ANY OTHER CHANGES SHOULD BE MADE IN A SEPARATE CONFIG FILE           #<br/>#                    WITHIN /etc/dnsmasq.d/yourname.conf                      #<br/>###############################################################################</span><span id="ce26" class="jv jw hi lm b fi mj lr l ls lt">addn-hosts=/etc/pihole/local.list<br/>addn-hosts=/etc/pihole/custom.list</span><span id="c7e1" class="jv jw hi lm b fi mj lr l ls lt">domain-needed<br/>localise-queries<br/>bogus-priv<br/>no-resolv<br/>server=<a class="ae ju" href="http://twitter.com/DNS1" rel="noopener ugc nofollow" target="_blank">@DNS1</a>@<br/>server=<a class="ae ju" href="http://twitter.com/DNS2" rel="noopener ugc nofollow" target="_blank">@DNS2</a>@<br/>interface=<a class="ae ju" href="http://twitter.com/INT" rel="noopener ugc nofollow" target="_blank">@INT</a>@<br/><strong class="lm hj">cache-size=</strong><a class="ae ju" href="http://twitter.com/CACHE_SIZE" rel="noopener ugc nofollow" target="_blank"><strong class="lm hj">@CACHE_SIZE</strong></a><strong class="lm hj">@</strong><br/>log-queries<br/>log-facility=/var/log/pihole.log<br/>local-ttl=2<br/>log-async</span></pre><p id="c967" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以通过双击正在运行的容器，然后双击Terminal选项卡，创建一个新的bash会话来查看这个文件，正如您在这个截图中看到的，您可以在这个截图中编写突出显示的<em class="jt"> cat </em>命令:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mk"><img src="../Images/018ebb46784570ce22c5e050fddca169.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ReS0XvZJsSTSHFW55JUZhg.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">正在执行"<em class="ml"> cat /etc/。pihole/advanced/01-pihole.conf "在容器内</em></figcaption></figure><p id="14da" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">或者，您可以在成为root用户后，通过SSH连接到Synology NAS，通过cli运行相同的命令:</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="bc00" class="jv jw hi lm b fi lq lr l ls lt">docker exec -it pihole-pihole1 cat /etc/.pihole/advanced/01-pihole.conf</span></pre><p id="d474" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以将该文件保存在NAS上，创建<em class="jt">/volume 1/docker/pi hole/etc _。pi hole _ advanced/01-pi hole . conf</em>并修改<strong class="iz hj">CACHE-SIZE =</strong><a class="ae ju" href="http://twitter.com/CACHE_SIZE" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj">@ CACHE _ SIZE</strong></a><strong class="iz hj">@</strong>到<strong class="iz hj"> cache-size=0 </strong></p><p id="a81a" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，停止pihole-pihole1容器，选择它并点击modify并添加一个新的只读文件映射(这次不是文件夹映射)以便挂载<em class="jt">/volume 1/docker/pihole/etc _。关于<em class="jt">的pihole _ advanced/01-pihole . conf</em>/etc/。容器内的pi hole/advanced/01-pi hole . conf</em>:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mm"><img src="../Images/465acee8eaa89d734812445df279f396.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nQL8iRjFtCiHbDFSQq76gg.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">修改缓存大小后挂载01-pihole.conf</figcaption></figure><p id="3541" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您可以重新启动容器并连接到运行在<a class="ae ju" href="http://your-nas-ip:8080/admin" rel="noopener ugc nofollow" target="_blank">http://your-nas-IP:8080/admin</a>GUI上的Pi-hole GUI，输入管理员密码并在设置页面上检查DNS缓存是否设置为零:</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mn"><img src="../Images/2c6029f688f7c3a65cf78fa49aa5fa20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1jba287OFxeCKj9V4XacvA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">检查DNS缓存大小，如果一切正常，它必须为零</figcaption></figure><p id="46f9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您可以像在上一篇文章中看到的那样配置Pi-hole，并且可以将运行在Raspberry上的未绑定服务器作为上游DNS指向其他Pi-hole设置。通过这种方式，我们将Pi-hole服务器增加了一倍，这是冗余的第一步(我们仍然有一个未绑定的服务器，因此如果RPi关闭，DNS解析将不起作用，但现在让我们关注Pi-hole，在下一篇文章中关注double Unbound)。</p><p id="b86c" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，您可以尝试更新Synology上的容器的过程，并验证您的设置是否持久，缓存大小是否仍然为零:</p><ol class=""><li id="b9a7" class="lv lw hi iz b ja jb jd je jg lx jk ly jo lz js mo mb mc md bi translated">关闭容器</li><li id="2c6c" class="lv lw hi iz b ja me jd mf jg mg jk mh jo mi js mo mb mc md bi translated">点击操作-&gt;删除(不是删除)。在意大利语中，我们有Cancella和Elimina，第一个删除容器，但在Docker GUI中保留其配置(卷和端口映射等),以便让您再次启动容器，从而从您下载的最新映像重新创建它。相反，Elimina删除该容器及其所有设置。您必须选择第一个操作，因为我们不想再次重新配置它。我不知道英语中使用的确切单词，但我认为它们可以是Erase(cancela)和Delete (Elimina)，所以请尝试理解正确的单词(要避免的单词应该是菜单中最低的一个)。</li><li id="6d88" class="lv lw hi iz b ja me jd mf jg mg jk mh jo mi js mo mb mc md bi translated">回到注册表再次搜索pihole并重新下载最新版本。</li><li id="a808" class="lv lw hi iz b ja me jd mf jg mg jk mh jo mi js mo mb mc md bi translated">下载完成后，再次启动容器，它将使用新下载的映像和您所有的设置重新启动</li></ol><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mp"><img src="../Images/2f1901c3a9b4a3aa5f20de2f2d1df6e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gU8-HcuBjZSemcJGCAl00A.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">擦除容器，以便用更新的图像重新创建它</figcaption></figure><p id="edeb" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注意:</strong>如果你启动Pi-hole，贵由会通过查看页面的页脚来了解新版本。如果版本号以红色闪烁，这意味着有官方更新可用。顺便说一句，可能需要等待几天才能获得更新的容器映像(您可以访问pihole/pihole Docker Hub页面，检查最近是否更新了最新的标签)。自动容器更新可以通过Synology上运行的<a class="ae ju" href="https://registry.hub.docker.com/r/containrrr/watchtower" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj">container RR/watchtower</strong></a>容器来完成，但这超出了本文的范围。</p><h2 id="b1ab" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated"><strong class="ak">我不喜欢覆盖01-pihole.conf的地方</strong></h2><p id="4c9b" class="pw-post-body-paragraph ix iy hi iz b ja kq ij jc jd kr im jf jg ks ji jj jk kt jm jn jo ku jq jr js hb bi translated">正如你在上面看到的，我们已经覆盖了<em class="jt"> /etc/的内容。pihole/advanced/01-pihole . conf</em>文件与我们修改过的文件进行比较，以便将<em class="jt">缓存大小</em>强制为零。如果一个新版本的<em class="jt"> pihole/pihole </em>在那个文件中做了一些改变，我们不会使用它，因为我们在容器更新文件上挂载了我们的文件版本。所以，我想修改容器的<em class="jt"> ph_install.sh </em>设置脚本中的<em class="jt"> CACHE_SIZE=10000 </em>设置，以便将ti设置为<em class="jt"> CACHE_SIZE=0 </em>。</p><h2 id="f20c" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated"><strong class="ak">构建我自己的pihole-nocache映像</strong></h2><p id="64c8" class="pw-post-body-paragraph ix iy hi iz b ja kq ij jc jd kr im jf jg ks ji jj jk kt jm jn jo ku jq jr js hb bi translated">你能想到的第一件事是“让我们复制<em class="jt"> ph_install.sh </em>脚本，修改变量并在容器基础映像的ph_install.sh脚本上挂载该文件”，但这与覆盖<em class="jt"> 01-pihole.conf </em>文件完全相同。</p><p id="4913" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以我想我可以简单地替换掉<em class="jt"> ph_install.sh </em>中的指令，而不用我自己的副本替换整个文件。</p></div><div class="ab cl mq mr gp ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hb hc hd he hf"><p id="fa6e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">2021年4月18日更新:</strong>我已经上传了我修改过的图像，也在公共<a class="ae ju" href="https://hub.docker.com/r/giannicostanzi/pihole-nocache" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj">Docker Hub giannicostanzi/pihole-nocache页面</strong> </a>上，所以如果你不想自己构建它，你可以直接从那里获取。</p><p id="2225" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">2021年05月01日更新:</strong>我已经在我的<a class="ae ju" href="https://github.com/MightySlaytanic/pihole-nocache" rel="noopener ugc nofollow" target="_blank"> <strong class="iz hj"> MightySlaytanic GitHub页面</strong> </a>上传了我的pihole-nocache Docker映像的<em class="jt"> Dockerfile </em></p></div><div class="ab cl mq mr gp ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="hb hc hd he hf"><p id="4e02" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">免责声明:</strong>以下说明要求SSH访问Synology NAS，并且能够成为root用户，因此您必须是NAS管理员。在生产环境中尝试之前，请理解这些命令。应该没有风险，但我不负责砖你的Synology Docker环境。</p><p id="b441" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我创建了以下文件夹:</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="908b" class="jv jw hi lm b fi lq lr l ls lt">mkdir /volume1/docker/_IMAGES/pihole-nocache</span></pre><p id="2357" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我在该文件夹中创建了一个<em class="jt"> Dockerfile </em>文件，该文件指示docker build基于官方的<em class="jt"> pihole/pihole:latest </em>创建一个新的映像，我的修改是通过sed命令完成的:</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="14a9" class="jv jw hi lm b fi lq lr l ls lt"># cat /volume1/docker/_IMAGES/pihole-nocache/Dockerfile<br/>FROM pihole/pihole:latest<br/>RUN <strong class="lm hj">sed -i -e "s:CACHE_SIZE=[0-9]\+:CACHE_SIZE=0:g" /root/ph_install.sh</strong></span></pre><p id="7a36" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，我们用零替换在<em class="jt"> ph_install.sh </em>脚本中设置的任何值<em class="jt"> CACHE_SIZE </em>。</p><p id="9bb2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，您可以使用以下命令构建您的映像:</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="1873" class="jv jw hi lm b fi lq lr l ls lt"># <strong class="lm hj">docker build --pull /volume1/docker/_IMAGES/pihole-nocache/ -t pihole-nocache:latest</strong><br/>Sending build context to Docker daemon  2.048kB<br/><strong class="lm hj">Step 1/2 : FROM pihole/pihole:latest</strong><br/><strong class="lm hj">latest: Pulling from pihole/pihole</strong><br/>Digest: sha256:3a39992f3e0879a4705d87d0b059513af0749e6ea2579744653fe54ceae360a0<br/><strong class="lm hj">Status: Image is up to date for pihole/pihole:latest</strong><br/> ---&gt; eb777ee00e0c<br/><strong class="lm hj">Step 2/2 : RUN sed -i -e "s:CACHE_SIZE=[0-9]\+:CACHE_SIZE=0:g" /root/ph_install.sh</strong><br/> ---&gt; Running in 4305759e9f70<br/>Removing intermediate container 4305759e9f70<br/> ---&gt; ffb77613b225<br/>Successfully built ffb77613b225<br/><strong class="lm hj">Successfully tagged pihole-nocache:latest</strong></span></pre><p id="d826" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">完成此操作后，您将在Synology上Docker应用程序的images部分找到pihole-nocache图像，并且您将能够按照之前为<em class="jt"> pihole/pihole </em>图像所做的步骤，基于它创建一个新的容器。如果您删除了<em class="jt"> pihole-pihole1 </em>容器，您可以使用相同的卷和端口映射重新创建一个新容器，除了<em class="jt"> /etc/。不再需要的pi hole/advanced/01-pi hole . conf</em>文件。让我们启动新的容器，检查缓存是否设置为零，而没有像预期的那样挂载<em class="jt"> 01-pihole.conf </em>文件。</p><p id="0dd7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更新容器需要您重新启动docker构建命令(— pull选项强制构建过程搜索基础映像的更新版本),而不是执行步骤3中描述的下载。在之前描述的更新过程中。</p><h2 id="a7a6" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated"><strong class="ak">将图像上传到您的私人容器上</strong></h2><p id="457e" class="pw-post-body-paragraph ix iy hi iz b ja kq ij jc jd kr im jf jg ks ji jj jk kt jm jn jo ku jq jr js hb bi translated">正如我以前说过的，我有一个在Synology NAS上运行的瞭望塔容器，它通过自动提取新图像并重新创建它们来定期更新我的容器。为了允许它更新我的pihole-nocache映像，我创建了一个私有注册表，每天晚上我用上面解释的命令重建pihole-nocache映像，并将其上传到我的注册表。</p><p id="eb25" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我用以下命令创建了一个注册表容器:</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="mx my l"/></div><figcaption class="lh li et er es lj lk bd b be z dx translated">创建并启动名为Registry的私有注册表容器</figcaption></figure><p id="8911" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="iz hj">注意:</strong>在我的家庭网络中，我有一个我的nas的公共名称my-<em class="jt">NAS-FQDN . Synology . me</em>的本地解析，以便在我的Synology box的私有IP地址上解析它。这样，我在注册表容器中安装的Synology证书和密钥将会很好地工作，因为它们与我用来指向容器的FQDN名称相匹配。关于在普通HTTP中部署私有注册表的更多细节可以在官方文档中找到。</p><p id="ae70" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，您可以通过以下命令(CTRL^C终止执行)测试注册表是否正在侦听端口55000/TCP，该命令将向您显示NAS的公共证书:</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="27ca" class="jv jw hi lm b fi lq lr l ls lt">openssl s_client -connect my-nas-fqdn.synology.me:55000</span></pre><p id="1bf4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">您可以在Docker应用程序的Images部分添加此注册表，并使用<em class="jt"> my-nas-fqdn </em>名称激活它，例如，单击添加，然后从URL添加，并输入<a class="ae ju" href="https://my-nas-fqdn.synology.me:55000" rel="noopener ugc nofollow" target="_blank"><em class="jt">https://my-nas-FQDN . synology . me:55000</em></a><em class="jt"/>作为URL。</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es mz"><img src="../Images/32c86ee468f8c781c0769b1c4efc9f40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*89GEmQIwu3rci_txPxmOkQ.png"/></div></div></figure><p id="f6a3" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这允许您在您的私人注册表中搜索图像。当你需要搜索官方图片时，记得重新激活默认的。</p><p id="cbb6" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，我们必须构建标记它的映像，以便让docker知道这是一个将在我们的私有注册中心而不是Docker hub上找到的映像，方法是以如下方式更改-t选项:</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="027a" class="jv jw hi lm b fi lq lr l ls lt">docker build --pull /volume1/docker/_IMAGES/pihole-nocache/ <strong class="lm hj">-t my-nas-fqdn.synology.me:55000/</strong>pihole-nocache:latest</span></pre><p id="f8bd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果您转到Docker Hub的Images部分，您会看到新创建的映像的注册表是<em class="jt"> my-nas-fqdn </em>而不是Docker Hub。</p><p id="7052" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后，我们可以将图像上传到我们的注册中心(这里我的图像在注册中心已经是最新的):</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="a2df" class="jv jw hi lm b fi lq lr l ls lt"># docker push my-nas-fqdn.synology.me:55000/pihole-nocache:latest<br/>The push refers to repository [my-nas-fqdn:55000/pihole-nocache]<br/>b6d5ed12d029: Layer already exists<br/>e996f48635d0: Layer already exists<br/>010e0146144d: Layer already exists<br/>ef63252a9627: Layer already exists<br/>8eeede195441: Layer already exists<br/>d3088e548a33: Layer already exists<br/>8ac01c752962: Layer already exists<br/>4e3984d0f56b: Layer already exists<br/>3d64ad524bb4: Layer already exists<br/>56e1f33806ae: Layer already exists<br/>0990c4f0eff1: Layer already exists<br/>b546331c0c35: Layer already exists<br/>ea63252b317e: Layer already exists<br/>9eb82f04c782: Layer already exists<br/>latest: digest: sha256:b36cd790060f9f3fc20a5909b722a2f31a1c9c24ed235f03e533884dda3a244e size: 3244</span></pre><p id="af22" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，如果你从Synology上的Docker应用程序搜索你的私人注册表，你会找到<em class="jt"> pihole-nocache </em>图片，你还可以下载它的最新标签。</p><h2 id="22a2" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated"><strong class="ak">在我的私人注册表上启用pihole-nocache的自动重建和上传</strong></h2><p id="2a2d" class="pw-post-body-paragraph ix iy hi iz b ja kq ij jc jd kr im jf jg ks ji jj jk kt jm jn jo ku jq jr js hb bi translated">最后，为了让Watchtower在我的私人注册表上找到更新版本的<em class="jt"> pihole-nocache </em>，我在我的NAS上安排了以下脚本每天运行，该脚本将使用最新标签重新创建并重新上传由<em class="jt"> /volume1/docker_IMAGES </em>文件夹的每个子文件夹中的docker文件描述的所有图像:</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="mx my l"/></div><figcaption class="lh li et er es lj lk bd b be z dx translated">docker_images_rebuild.sh</figcaption></figure><p id="ab2f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当您使用最新的标签创建新图像时，前一个图像的标签将变为<em class="jt"> &lt;无&gt; </em>。因为仍在使用中，所以在容器更新之前不能移除它。</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="mx my l"/></div><figcaption class="lh li et er es lj lk bd b be z dx translated">查看悬挂图像</figcaption></figure><p id="6781" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">当不再使用它时，您可以通过以下命令将其删除:</p><pre class="kw kx ky kz fd ll lm ln lo aw lp bi"><span id="e2a9" class="jv jw hi lm b fi lq lr l ls lt">docker rmi <em class="jt">IMAGE_ID</em></span></pre><p id="33a4" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">将<em class="jt"> IMAGE_ID </em>替换为<em class="jt"> docker image ls显示的ID。</em></p><p id="7e7e" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为了节省空间，我已经安排了一个每周删除悬挂图像的任务(它还向您展示了如何通过<em class="jt"> synodsmnotify </em>工具在Synology web GUI内向用户发送通知):</p><figure class="kw kx ky kz fd la"><div class="bz dy l di"><div class="mx my l"/></div></figure><p id="9518" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">今天我更新了图像，瞭望塔的日常运行也对其进行了升级，并删除了悬挂的旧图像(我使用<a class="ae ju" href="https://registry.hub.docker.com/r/soulassassin85/docker-telegram-notifier/" rel="noopener ugc nofollow" target="_blank"><strong class="iz hj">soulassassin 85/docker-Telegram-notifier</strong></a>容器向私人电报通道发送通知)</p><figure class="kw kx ky kz fd la er es paragraph-image"><div role="button" tabindex="0" class="lb lc di ld bf le"><div class="er es na"><img src="../Images/1168e5aece4e96e6c2fbb4fe8e4e7acc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C6ZIt5PwFw7Nzx3Rm5FvMQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">了望塔发出的电报通知</figcaption></figure><h2 id="a430" class="jv jw hi bd jx jy jz ka kb kc kd ke kf jg kg kh ki jk kj kk kl jo km kn ko kp bi translated"><strong class="ak">结论</strong></h2><p id="7a75" class="pw-post-body-paragraph ix iy hi iz b ja kq ij jc jd kr im jf jg ks ji jj jk kt jm jn jo ku jq jr js hb bi translated">我希望你喜欢读这篇文章，如果你想解决像在Docker化的Pi-hole上禁用缓存这样的问题，或者如果你正在学习Docker并且想像我一样尝试一下，它可能会节省你一点时间。如果您有任何意见，请随时给我写信，我两周前开始学习docker，所以有些事情可以做得更好或更有效:)</p><p id="6733" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在，让我们继续Synology NAS上的Unbound:<a class="ae ju" rel="noopener" href="/nerd-for-tech/recursive-dns-ad-blocker-part-3-installing-unbound-with-dnssec-on-synology-nas-with-docker-d40bb36035dc"><strong class="iz hj">递归DNS+广告拦截器—第3部分:在Synology NAS上安装Unbound with DNSSEC，Docker </strong> </a></p><div class="nb nc ez fb nd ne"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/recursive-dns-ad-blocker-part-3-installing-unbound-with-dnssec-on-synology-nas-with-docker-d40bb36035dc"><div class="nf ab dw"><div class="ng ab nh cl cj ni"><h2 class="bd hj fi z dy nj ea eb nk ed ef hh bi translated">递归DNS+广告拦截器—第3部分:用Docker在Synology NAS上安装未绑定的DNSSEC</h2><div class="nl l"><p class="bd b fp z dy nj ea eb nk ed ef dx translated">medium.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr lf ne"/></div></div></a></div><p id="8dd7" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">【2021年5月10日更新:在本系列的第4篇文章中，我将向您展示我是如何实现一个监控脚本的，该脚本从Pi-hole服务器收集指标并上传到InfluxDB2服务器，从而允许我在Grafana仪表板上绘制有用的信息:</p><div class="nb nc ez fb nd ne"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/recursive-dns-ad-blocker-part-4-pihole2influxdb2-how-to-monitor-your-pi-hole-servers-b2f03de2baf2"><div class="nf ab dw"><div class="ng ab nh cl cj ni"><h2 class="bd hj fi z dy nj ea eb nk ed ef hh bi translated">递归DNS+广告拦截器—第4部分:pihole 2 influxd 2—如何监控您的pihole服务器</h2><div class="nl l"><p class="bd b fp z dy nj ea eb nk ed ef dx translated">medium.com</p></div></div><div class="nm l"><div class="ns l no np nq nm nr lf ne"/></div></div></a></div></div></div>    
</body>
</html>