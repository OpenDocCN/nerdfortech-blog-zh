<html>
<head>
<title>Integrate Language-Server with VS-Code extension</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">集成语言服务器和 VS 代码扩展</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/integrate-language-server-with-vs-code-extension-ffe8f33a79cf?source=collection_archive---------1-----------------------#2022-11-11">https://medium.com/nerd-for-tech/integrate-language-server-with-vs-code-extension-ffe8f33a79cf?source=collection_archive---------1-----------------------#2022-11-11</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/7273d618ce0c7aff16eaf0f307d3a6df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9-1YR7JTGl9-bBpjPc4U-w.png"/></div></div></figure><p id="a977" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本周，我和我的团队想为公司内部语言创建一个新的语言服务器。已经有人在努力创建一个基于 XText 的 Eclipse 语言插件。为了能够在 Eclipse 之外的其他 ide 上使用语言服务器，我们基于微软<a class="ae jo" href="https://microsoft.github.io/language-server-protocol/" rel="noopener ugc nofollow" target="_blank">语言服务器协议</a> (LSP)创建了一个新的语言服务器。</p><p id="63b0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我的任务是将新创建的语言服务器与 VS-Code 集成起来。我选择这个编辑器而不是 IntelliJ IDEA，因为众所周知，它比 IntelliJ 更容易和更好地集成语言服务器。</p><h1 id="89ea" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">客户端和语言服务器之间的通信</h1><p id="c846" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">首先，当用户打开一个文档时，客户端向语言服务器发送一个包含文档内容的通知。</p><p id="6a9d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">服务器将带有当前文档诊断信息的通知发送回客户端。</p><p id="e18a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果用户编辑一个文档，客户端会发送一个新的通知，通知中包含该文档的当前 url 以及与旧版本的不同之处。这样就不必在每次修改后都上传整个文档。</p><p id="15a9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果用户执行“Go to definition ”,他会向服务器发送一个带有当前 documentURI 和光标位置的请求。</p><p id="cdc1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">服务器发回一个响应，其中包含链接的类、方法或变量的位置。</p><p id="72f1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当用户最终关闭文档时，它会向服务器发送一个带有 documentURI 的通知，以便服务器可以从当前上下文中删除文档。</p><figure class="kt ku kv kw fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ks"><img src="../Images/27bc6ca0e0390155a4e40c70ef008080.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GVy1hQq_KqepEO9O.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">图自<a class="ae jo" href="https://microsoft.github.io" rel="noopener ugc nofollow" target="_blank">https://Microsoft . github . io</a></figcaption></figure><p id="2658" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">语言服务器的默认端口是端口 5007。在这个例子中，我们也将在这个端口上启动我们的语言服务器。</p><p id="9987" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你可以在<a class="ae jo" href="https://code.visualstudio.com/api/language-extensions/language-server-extension-guide" rel="noopener ugc nofollow" target="_blank">https://code . visual studio . com/API/language-extensions/language-server-extension-guide</a>上了解更多关于服务器和客户端之间的通信</p><h1 id="ebab" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">创建扩展</h1><p id="abcb" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">要创建语言扩展，您需要创建具有以下项目结构的项目:</p><blockquote class="lb"><p id="acc1" class="lc ld hi bd le lf lg lh li lj lk jn dx translated">/package.json <br/> / &lt;扩展&gt;. configuration . JSON<br/>/src/extension . ts<br/>/src/ts config . JSON</p></blockquote><p id="5755" class="pw-post-body-paragraph iq ir hi is b it ll iv iw ix lm iz ja jb ln jd je jf lo jh ji jj lp jl jm jn hb bi translated">其中<extension>应该是你想要支持的新语言的扩展。</extension></p><p id="b04f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本教程的以下部分中，我将继续使用“<strong class="is hj"> gui </strong>作为语言文件的扩展名。</p><p id="9f31" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">package.json 文件的内容如下所示:</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="773e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请注意从第 22 行到第 35 行的零件，因为这是与扩展相关的零件。在第 33 行的扩展名前添加点非常重要。</p><p id="0f17" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">gui.configuration.json 文件将用于该语言的本地支持，如自动结束括号和注释。</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="0608" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">需要所有这些配置来改进最终用户的工作流程，并提供自动完成的基本功能。</p><p id="574d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">基本的/src/tsconfig.json 文件如下所示:</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="1aae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在真正有趣的部分位于 extension.ts 文件中。</p><p id="ccb1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个 LanguageClient，并连接到本地主机上的端口 5007。</p><figure class="kt ku kv kw fd ij"><div class="bz dy l di"><div class="lq lr l"/></div></figure><p id="8a36" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">第 27 行需要 gui 扩展，以便服务器知道应该跟踪哪些文件。</p><p id="1f4e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">应该通知服务器的文件事件在第 29 行定义。使用这种配置，客户端仅在出现“<strong class="is hj">”时通知服务器。gui" </strong>文件已更改。</p><p id="853d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在第 37 行，客户端被启动。</p><p id="7582" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">deactivate()函数是必需的，这样，如果扩展被禁用，服务器就可以关闭连接。</p><h1 id="1bd3" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">运行扩展</h1><p id="ceda" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">要运行扩展，您需要在 VS-Code 中打开这个项目，如果您还没有使用它，然后按“Debug/Run”。这将打开一个新的 VS-Code 窗口，其中已经安装并启用了您的自定义扩展。现在，您可以使用定义的扩展名创建一个新文件。您现在应该能够使用 LSP 服务器的自动完成功能和语义检查了。</p></div><div class="ab cl ls lt gp lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="hb hc hd he hf"><p id="82f7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">更多信息可在以下网站找到:</p><ul class=""><li id="e7c7" class="lz ma hi is b it iu ix iy jb mb jf mc jj md jn me mf mg mh bi translated"><a class="ae jo" href="https://code.visualstudio.com/api/language-extensions/language-server-extension-guide" rel="noopener ugc nofollow" target="_blank">https://code . visual studio . com/API/language-extensions/language-server-extension-guide</a></li><li id="fe08" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated"><a class="ae jo" href="https://learn.microsoft.com/en-us/visualstudio/extensibility/adding-an-lsp-extension?view=vs-2022" rel="noopener ugc nofollow" target="_blank">https://learn . Microsoft . com/en-us/visual studio/extensibility/adding-an-LSP-extension？view=vs-2022 </a></li><li id="c2e6" class="lz ma hi is b it mi ix mj jb mk jf ml jj mm jn me mf mg mh bi translated"><a class="ae jo" href="https://idiomaticsoft.com/post/2022-04-29-create-vscode-client/" rel="noopener ugc nofollow" target="_blank">https://idiomatic soft . com/post/2022-04-29-create-vs code-client/</a></li></ul><h1 id="54f0" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">反射</h1><h2 id="979b" class="mn jq hi bd jr mo mp mq jv mr ms mt jz jb mu mv kd jf mw mx kh jj my mz kl na bi translated">什么进展顺利</h2><p id="6d2d" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">我认为扩展的实际实现并不困难，我在很短的时间内就让它工作了。</p><h2 id="8a73" class="mn jq hi bd jr mo mp mq jv mr ms mt jz jb mu mv kd jf mw mx kh jj my mz kl na bi translated">什么需要改进</h2><p id="1d71" class="pw-post-body-paragraph iq ir hi is b it kn iv iw ix ko iz ja jb kp jd je jf kq jh ji jj kr jl jm jn hb bi translated">这个小项目中最难的部分是理解语言服务器协议到底是什么以及它是如何工作的。开始的时候，我并没有在官方文件中读到太多，而是试图找到当时我在 StackOverflow 上遇到的具体问题的答案。这种方法的问题是，我从来没有完全理解这个主题本身，因此遇到了一些问题，如果我事先对这个主题有更好的了解，我就不会遇到这些问题。</p></div></div>    
</body>
</html>