# 实现 AWS 节约的第一步

> 原文：<https://medium.com/nerd-for-tech/first-step-to-savings-in-aws-aebf49925be7?source=collection_archive---------3----------------------->

![](img/20f6b87bd156e41536a92ce239f00070.png)

图一。成本利用率(PC。NetApp)

采用 AWS 云当然可以增强企业的实力，但如果迁移不正确且管理不善，也会拖累企业。成功的答案完全取决于 IT 团队如何选择战略和执行其 AWS 云迁移，然后以持续的方式优化其 AWS 立场。

通常遇到的复杂性是在 AWS 云中超支。

**现在使用亚马逊网络服务(AWS) Spot 车队可以节省高达 90%的费用。**

亚马逊网络服务(AWS) Spot 车队是 [AWS spot 实例](https://spot.io/what-are-ec2-spot-instances/)的集合，来自亚马逊备用容量池的虚拟服务器，以高达 90%的折扣提供。现货实例需要小心管理，因为当市场价格接近你的出价时，亚马逊会在短时间内终止它们。

应用程序可以通过 Spot 车队应用程序编程接口(API)或命令行接口(CLI)请求 Spot 车队。因为 spot instances 定价经常变化，EC2 不断尝试根据预定义的值来平衡容量。

# 你知道如何计划现货船队的要求吗？

*   确定您是要创建一个提交所需目标容量的一次性请求的现货船队，还是要创建一个长期保持目标容量的现货船队。(请求或维护)
*   确定满足应用程序要求的实例类型。
*   为您的现货车队请求确定目标容量。您可以以实例或自定义单位设置目标容量。更多信息，见[点舰队实例权重](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-instance-weighting.html)。
*   确定现货车队目标产能中的哪一部分必须是按需产能。您可以将按需产能指定为 0。
*   如果您使用实例加权，请确定您的单位价格。要计算单位价格，请将每个实例小时的价格除以该实例所代表的单位(或重量)数。如果不使用实例加权，默认的单位价格是每个实例小时的价格。

# Spot 实例的分配策略

## `[1] LowestPrice:`

现货实例来自具有可用容量的最低价格池。这是 spot 实例的默认策略。

如果最便宜的池没有可用容量，则 Spot 实例来自下一个有可用容量的最便宜的池。

如果一个池在满足您的期望容量之前用完了容量，Spot Fleet 将通过从下一个最便宜的池中提取容量来继续满足您的请求。为了确保满足所需的容量，您可能会从几个池中接收 Spot 实例。

## `[2] Diversified:`

Spot 实例分布在所有池中。

## `[3] CapacityOptimized:`

在现货实例中，价格会根据长期供求趋势缓慢变化，但产能会实时波动。`capacityOptimized`策略通过查看实时容量数据并预测哪个最可用，自动将 Spot 实例放入最可用的池中。这非常适用于大数据和分析、图像和媒体渲染、机器学习和高性能计算等工作负载，这些工作负载可能会因重启工作和检查点而产生更高的中断成本。通过提供更少中断的可能性，`capacityOptimized`策略可以降低你工作的总成本。

## `InstancePoolsToUseCount`

用于分配目标 Spot 容量的 Spot 池数量。仅当分配策略设置为`lowest-price`时有效。Spot Fleet 选择最便宜的 Spot 池，并在指定数量的 Spot 池中平均分配您的目标 Spot 容量。

# 现货车队自动缩放

自动缩放允许您根据当前需求自动增加或减少 Spot 车队的目标容量。Spot Fleet 可以根据几种扩展策略之一，在指定范围内启动更多实例(向外扩展)或终止实例(向内扩展)。

Spot Fleet 支持以下类型的自动缩放:

*   **目标跟踪—** 根据具体指标的目标值增减产能。例如，您可以指定 Spot Fleet 中实例的 CPU 利用率不能高于 80%。
*   **步进缩放** —根据一系列渐进调整增加或减少车队的容量，由 CloudWatch 警报触发。
*   **计划扩展** —在特定日期和时间按预定量增加或减少容量。

关于 Spot 车队自动缩放工作原理的几个要点:

*   Spot Fleet 使用冷却时间来缩放事件。这意味着，在扩展事件后的几秒钟内，它会等待系统指示器进行调整，并且不会执行其他扩展事件。例如，在向外扩展后，它会等待几秒钟来调整 CPU 利用率，然后再确定是否需要进一步向外扩展。
*   如果在冷却期间触发了额外的 CloudWatch 警报，则会立即执行扩大或缩小事件。
*   Amazon 建议使用频率为 1 分钟的实例度量来扩展事件，以便更快地响应应用程序需求。这需要在 CloudWatch 中启用详细的监控，这会产生额外的成本。

# 选择合适的分配策略

您可以根据您的使用情况优化您的 Spot 车队。

如果您的车队运行的工作负载可能会因重启工作和检查点而产生更高的中断成本，那么就使用`capacityOptimized`策略。这种策略提供了减少中断的可能性，可以降低工作负载的总成本。这是推荐的策略。对于必须最大限度地降低中断的可能性并且对某些实例类型的偏好很重要的工作负载，使用`capacityOptimizedPrioritized`策略。

如果您的车队很小或者运行时间很短，那么您的 Spot 实例被中断的可能性很低，即使所有实例都在一个 Spot 容量池中。因此，`lowestPrice`策略很可能在提供最低成本的同时满足您的需求。

如果您的车队很大或者运行了很长时间，您可以通过将 Spot 实例分布在多个池中来提高车队的可用性。例如，如果您的 Spot 机群请求指定 10 个池和 100 个实例的目标容量，则机群在每个池中启动 10 个 Spot 实例。如果一个池的现货价格超过了这个池的最高价格，只有 10%的船队受到影响。使用这种策略还可以让你的船队对任何一个池的现货价格的上涨不那么敏感。使用`diversified`策略，Spot 舰队不会以等于或高于[按需价格](https://aws.amazon.com/ec2/pricing/)的现货价格将 Spot 实例发送到任何池中。

# 发现最佳实践

## [1]现货规则:

了解要最大限度地节省计算成本需要遵循的两条简单规则:

1.  现货容量池有单独的价格，不经常变化
2.  当我们需要恢复容量时，亚马逊 EC2 会给你 2 分钟的警告

## [2]实例灵活性:

尽可能在不同的实例类型上测试您的应用程序。由于可用性区域中每个实例类型的价格独立波动，因此当您拥有实例类型灵活性时，您通常可以以相同的价格获得更多的计算能力。

## [3]车队空气污染指数:

当在 EC2 自动扩展组中运行 Spot 实例时，使用*容量优化分配策略*来访问具有最大可用容量的 Spot 容量池。容量优化指示 EC2 自动扩展组启动具有最深容量池的 Spot 实例，从而降低中断的可能性。

观看视频了解更多详情:

# 现场车队限制

**以下是 spot Fleet 不提供的与 Spot 实例管理相关的关键功能。**

*   **无法保证提前预测实例终止** —即使使用 spot 车队，Spot 实例也会在提前 2 分钟通知的情况下终止。虽然亚马逊提供了“重新平衡警告”，但它不保证警告会在终止前 2 分钟以上发出。这意味着您无法在足够的时间内将工作负载可靠地迁移到另一个实例。
*   **不保证存储持久性** —如果 spot 实例终止，Spot Fleet 不保证新实例可以连接到旧的 EBS 卷。这取决于同一个实例池中 EBS 卷容量的可用性，并且要求将 spot 请求定义为“持久的”。
*   **对容器的有限支持** —容器自动缩放需要高级配置，不支持容器正确调整大小。
*   **不能自动回退到按需** —当 Spot 实例出现故障时，Spot Fleet 不允许您自动故障转移到按需实例。
*   **不支持主动实例自动恢复** — Spot Fleet 仅在 Spot 实例终止后恢复实例，并且仅用于“维护”请求。
*   **不保证 IP 持久性** —仅当实例或群组分别被定义为“持久性”或“维护”时，才支持 IP 持久性。

# **参考文献:**

 [## 现场车队示例配置

### 以下示例显示了启动配置，您可以使用 request-spot-fleet 命令来创建 Spot…

docs.aws.amazon.com](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-fleet-examples.html)  [## Spot 实例的分配策略

### 您的启动配置决定了来自…的所有可能的现场容量池(实例类型和可用性区域)

docs.aws.amazon.com](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-fleet-allocation-strategy.html)