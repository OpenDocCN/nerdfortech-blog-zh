<html>
<head>
<title>OPA Gatekeeper on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes 上的 OPA 看门人</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/opa-gatekeeper-on-kubernetes-69ca657c8631?source=collection_archive---------0-----------------------#2022-12-07">https://medium.com/nerd-for-tech/opa-gatekeeper-on-kubernetes-69ca657c8631?source=collection_archive---------0-----------------------#2022-12-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="d8f5" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">OPA 看门人:Kubernetes 的政策和治理</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/0157fbad92d9e1a024c1ebc5bd14e362.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AkrEbqlA_j76u2I5Tm8npg.png"/></div></div></figure><h2 id="f909" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">什么是 OPA:</h2><p id="a1fc" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated"><a class="ae la" href="https://www.openpolicyagent.org/docs/latest/" rel="noopener ugc nofollow" target="_blank">开放策略代理(OPA) </a>是一个开源的通用策略引擎，可以在整个堆栈中统一策略实施。OPA 提供了一种高级声明性语言，让我们可以将策略指定为代码和简单的 API，以从我们的软件中卸载策略决策。我们可以使用 OPA 在微服务、Kubernetes、CI/CD 管道、API 网关等方面实施策略。<strong class="kj hj">在 kubernetes，OPA 使用准入控制器。</strong></p><h2 id="91e2" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">什么是 OPA 看门人？</h2><p id="9d93" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated"><a class="ae la" href="https://open-policy-agent.github.io/gatekeeper" rel="noopener ugc nofollow" target="_blank"> OPA Gatekeeper </a>是在 OPA 和 Kubernetes 之间提供一流集成的专业项目。</p><p id="7964" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">OPA 网关守护设备在普通 OPA 的基础上增加了以下内容:</p><blockquote class="lg lh li"><p id="2454" class="kh ki lj kj b kk lb ij km kn lc im kp lk ld kr ks ll le ku kv lm lf kx ky kz hb bi translated"><em class="hi"> ●可扩展、参数化的策略库。<br/> ●用于实例化策略库的本地 Kubernetes CRDs(又名“</em> <strong class="kj hj"> <em class="hi">约束</em> </strong> <em class="hi">”)。<br/> ●用于扩展策略库的原生 Kubernetes CRDs(又名“</em> <strong class="kj hj"> <em class="hi">约束模板</em> </strong> <em class="hi">”)。<br/> ●审计功能。</em></p></blockquote><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ln"><img src="../Images/98059a753be0e1a2cacb35738666ca23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8CR0eFAp0xGZ4xZ6.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">来自:<a class="ae la" href="https://kubernetes.io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-for-kubernetes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes 博客</a></figcaption></figure><h2 id="6383" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">网关守护设备安装:</h2><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="d476" class="lx jk hi lt b be ly lz l ma mb">&gt;&gt; kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml</span></pre><p id="6ccf" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">以下是作为网关守护设备安装的一部分而创建的对象:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="1bf7" class="lx jk hi lt b be ly lz l ma mb">&gt;&gt; kubectl get all -n gatekeeper-system<br/><br/>NAME                                                 READY   STATUS    RESTARTS   AGE<br/>pod/gatekeeper-audit-56ddcd8749-mlvjv                1/1     Running   0          2m50s<br/>pod/gatekeeper-controller-manager-64fd6c8cfd-cqvnw   1/1     Running   0          2m49s<br/>pod/gatekeeper-controller-manager-64fd6c8cfd-xgmxv   1/1     Running   0          2m49s<br/>pod/gatekeeper-controller-manager-64fd6c8cfd-znxfh   1/1     Running   0          2m49s<br/><br/>NAME                                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE<br/>service/gatekeeper-webhook-service   ClusterIP   10.245.56.27   &lt;none&gt;        443/TCP   2m51s<br/><br/>NAME                                            READY   UP-TO-DATE   AVAILABLE   AGE<br/>deployment.apps/gatekeeper-audit                1/1     1            1           2m51s<br/>deployment.apps/gatekeeper-controller-manager   3/3     3            3           2m50s<br/><br/>NAME                                                       DESIRED   CURRENT   READY   AGE<br/>replicaset.apps/gatekeeper-audit-56ddcd8749                1         1         1       2m51s<br/>replicaset.apps/gatekeeper-controller-manager-64fd6c8cfd   3         3         3       2m50s</span></pre><h2 id="fd76" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">验证准入控制</h2><p id="c3aa" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">一旦在我们的集群中安装了所有的网关守护设备组件，每当集群中的资源被创建、更新或删除时，API 服务器将触发网关守护设备准入 webhook 来处理准入请求。<br/>在验证过程中，网守充当 API 服务器和 OPA 之间的桥梁。API 服务器将执行 OPA 执行的所有策略。</p><h2 id="be3e" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated"><strong class="ak">自定义资源定义</strong></h2><p id="9f7d" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated"><strong class="kj hj">自定义资源定义</strong> ( <a class="ae la" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#customresourcedefinitions" rel="noopener ugc nofollow" target="_blank"> CRD </a> ) API 允许我们定义自定义资源。定义一个 CRD 对象会创建一个新的定制资源，它具有我们指定的名称和模式。Kubernetes API 服务并处理定制资源的存储。</p><p id="7e57" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">Gatekeeper 在内部使用<a class="ae la" href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/" rel="noopener ugc nofollow" target="_blank">customresourcediations</a>，并允许我们定义<strong class="kj hj"> ConstraintTemplates </strong>和<strong class="kj hj"> Constraints </strong>来对 Kubernetes 资源(如 pod、部署和作业)实施策略。</p><p id="bf98" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">网关守护设备在安装过程中会创建几个 CRD:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="a328" class="lx jk hi lt b be ly lz l ma mb">&gt;&gt; kubectl get crd | grep -i gatekeeper<br/><br/>assign.mutations.gatekeeper.sh                       2022-11-29T07:04:42Z<br/>assignmetadata.mutations.gatekeeper.sh               2022-11-29T07:04:43Z<br/>configs.config.gatekeeper.sh                         2022-11-29T07:04:43Z<br/>constraintpodstatuses.status.gatekeeper.sh           2022-11-29T07:04:43Z<br/>constrainttemplatepodstatuses.status.gatekeeper.sh   2022-11-29T07:04:43Z<br/>constrainttemplates.templates.gatekeeper.sh          2022-11-29T07:04:44Z #&lt;---<br/>expansiontemplate.expansion.gatekeeper.sh            2022-11-29T07:04:44Z<br/>modifyset.mutations.gatekeeper.sh                    2022-11-29T07:04:44Z<br/>mutatorpodstatuses.status.gatekeeper.sh              2022-11-29T07:04:44Z<br/>providers.externaldata.gatekeeper.sh                 2022-11-29T07:04:44Z</span></pre><p id="6abf" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">其中之一是<strong class="kj hj">" Constraint Templates . Templates . gatekeeper . sh "</strong>，使用它我们可以创建<strong class="kj hj">约束</strong>和<strong class="kj hj">约束模板</strong>来与 gate keeper 一起工作:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mc"><img src="../Images/1d36a80f916efc094b6a211b13737ad8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3RPmJpG7k42gRrhz.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">来自:<a class="ae la" href="https://dev.to/ashokan/kubernetes-policy-management-ii-opa-gatekeeper-465g" rel="noopener ugc nofollow" target="_blank">https://dev . to/ashokan/kubernetes-policy-management-ii-opa-gate keeper-465g</a></figcaption></figure><p id="41f4" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">●<a class="ae la" href="https://open-policy-agent.github.io/gatekeeper/website/docs/howto" rel="noopener ugc nofollow" target="_blank"><strong class="kj hj">constraint templates</strong></a>定义了一种验证网守的 Kubernetes 准入控制器中的某组 Kubernetes 对象的方法。它们由两个主要元素组成:</p><ol class=""><li id="7dd6" class="md me hi kj b kk lb kn lc ju mf jy mg kc mh kz mi mj mk ml bi translated"><a class="ae la" href="https://www.openpolicyagent.org/docs/latest/#rego" rel="noopener ugc nofollow" target="_blank">定义策略违规的减压阀</a>代码</li><li id="e0ac" class="md me hi kj b kk mm kn mn ju mo jy mp kc mq kz mi mj mk ml bi translated">伴随的<code class="du mr ms mt lt b"><strong class="kj hj">Constraint</strong></code> <strong class="kj hj"> </strong>对象的模式，表示<code class="du mr ms mt lt b"><strong class="kj hj">ConstraintTemplate</strong></code>的实例化</li></ol><p id="5966" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">●约束是系统需要满足的需求声明。换句话说，<strong class="kj hj">约束</strong>用于通知看门人管理员想要强制实施约束模板，以及如何实施。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mu"><img src="../Images/175cd65b553f8d489e57ae4f00968559.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FmfaihS_LjhywVuX.png"/></div></div><figcaption class="lo lp et er es lq lr bd b be z dx translated">来自:<a class="ae la" href="https://grumpygrace.dev/posts/intro-to-gatekeeper-policies/" rel="noopener ugc nofollow" target="_blank">https://grumpygrace.dev/posts/intro-to-gatekeeper-policies/</a></figcaption></figure><p id="6c58" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">下图说明了 CRD、约束模板和约束是如何相互连接的:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mv"><img src="../Images/409bbab459a0b0c1fc4ee3097b65d017.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QhjEpT-EE2lBzFcW73_kVg.png"/></div></div></figure><h2 id="c7ae" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">游戏攻略</h2><p id="9542" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">现在，假设我们想要实施一个策略，使得 kubernetes 资源(比如 pod、名称空间等)必须定义一个特定的标签。为了实现这一点，让我们先创建一个<code class="du mr ms mt lt b"><strong class="kj hj">ConstraintTemplate</strong></code> <strong class="kj hj"> </strong>，然后再创建一个<code class="du mr ms mt lt b"><strong class="kj hj">Constraint</strong></code> <strong class="kj hj"> </strong>:</p><h2 id="bcfc" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">约束模板:</h2><p id="5bb7" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">下面是<code class="du mr ms mt lt b"><strong class="kj hj">ConstraintTemplate.yaml</strong></code>文件，我们将使用该文件在 k8s 集群上创建一个<code class="du mr ms mt lt b"><strong class="kj hj">ConstraintTemplate</strong></code> <strong class="kj hj"> </strong>:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="3b2c" class="lx jk hi lt b be ly lz l ma mb"># ConstraintTemplate.yaml<br/># ---------------------------------------------------------------<br/>apiVersion: templates.gatekeeper.sh/v1<br/>kind: ConstraintTemplate                    # Template Identifying Info<br/>metadata:<br/>  name: k8srequiredlabels<br/># ----------------------------------------------------------------<br/>spec:<br/>  crd:<br/>    spec:<br/>      names:<br/>        kind: K8sRequiredLabels        # Template values for constraint crd's                                          <br/>      validation:<br/>        # Schema for the `parameters` field<br/>        openAPIV3Schema:<br/>          type: object<br/>          properties:<br/>            labels:<br/>              type: array<br/>              items:<br/>                type: string<br/># ----------------------------------------------------------------<br/>  targets:<br/>    - target: admission.k8s.gatekeeper.sh<br/>      rego: |                                     # Rego<br/>        package k8srequiredlabels<br/><br/>        violation[{"msg": msg, "details": {"missing_labels": missing}}] {<br/>          provided := {label | input.review.object.metadata.labels[label]}<br/>          required := {label | label := input.parameters.labels[_]}<br/>          missing := required - provided<br/>          count(missing) &gt; 0<br/>          msg := sprintf("you must provide labels: %v", [missing])<br/>        }<br/># ----------------------------------------------------------------</span></pre><p id="2ec7" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">使用上面定义的清单创建<code class="du mr ms mt lt b"><strong class="kj hj">ConstraintTemplate</strong></code> <strong class="kj hj"> </strong>:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="8dec" class="lx jk hi lt b be ly lz l ma mb">&gt;&gt; kubectl create -f ConstraintTemplate.yaml<br/><br/>#　List the available ConstraintTemplate's <br/>&gt;&gt; kubectl get ConstraintTemplate<br/>NAME                AGE<br/>k8srequiredlabels   29s</span></pre><h2 id="a64d" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">约束:<strong class="ak"> pod 标签</strong></h2><p id="3718" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">现在，让我们创建一个<code class="du mr ms mt lt b"><strong class="kj hj">Constraint</strong></code>，它将强制每次创建一个 pod 时，pod 必须有一个名为“<strong class="kj hj"> app </strong>的策略。下面是名为<strong class="kj hj">“pod-must-have-app-level . YAML”</strong>的<code class="du mr ms mt lt b"><strong class="kj hj">Constraint</strong></code> <strong class="kj hj"> </strong>文件</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="dd83" class="lx jk hi lt b be ly lz l ma mb"># pod-must-have-app-level.yaml<br/><br/>apiVersion: constraints.gatekeeper.sh/v1beta1<br/>kind: K8sRequiredLabels<br/>metadata:<br/>  name: pod-must-have-app-level<br/>spec:<br/>  match:<br/>    kinds:<br/>      - apiGroups: [""]<br/>        kinds: ["Pod"]   <br/>  parameters:<br/>    labels: ["app"]    </span></pre><p id="045c" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">在我们的 kubernetes 集群上创建<code class="du mr ms mt lt b"><strong class="kj hj">Constraint</strong></code> <strong class="kj hj"> </strong>并列出可用的约束:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="1d7f" class="lx jk hi lt b be ly lz l ma mb">&gt;&gt; kubectl create -f pod-must-have-app-level.yaml<br/><br/># List the available Constraint's<br/>&gt;&gt; kubectl get constraints<br/><br/>NAME                      ENFORCEMENT-ACTION   TOTAL-VIOLATIONS<br/>pod-must-have-app-level                        13</span></pre><p id="9cdd" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">现在，让我们在不定义标签的情况下创建一个 pod，并观察会发生什么:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="ffb7" class="lx jk hi lt b be ly lz l ma mb"># Create a pod without labels<br/>&gt;&gt; kubectl run nginx --image=nginx <br/>Error from server (Forbidden): admission webhook "validation.gatekeeper.sh" denied the request: [pod-must-have-app-level] you must provide labels: {"app"}</span></pre><p id="717a" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">正如我们在上面的演示中看到的，pod 创建请求被拒绝，因为在创建 pod 时没有提供所需的“标签”。</p><p id="1920" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">现在，让我们创建一个标签为“<strong class="kj hj"> app </strong>的 pod，并观察其行为:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="1287" class="lx jk hi lt b be ly lz l ma mb"># Create a pod with label<br/>&gt;&gt; kubectl run nginx --image=nginx --labels=app=test<br/>pod/nginx created</span></pre><p id="0f89" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">在上面的演示中，我们可以看到 pod 的部署没有任何问题，因为我们在创建 pod 时指定了所需的标签。</p><h2 id="4541" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated"><strong class="ak">约束:名称空间标签</strong></h2><p id="904e" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">一个<code class="du mr ms mt lt b"><strong class="kj hj">ConstraintTemplate</strong></code> <strong class="kj hj"> </strong>可以被几个<code class="du mr ms mt lt b"><strong class="kj hj">Constraint</strong></code>使用。在前一阶段，我们指定了一个<code class="du mr ms mt lt b"><strong class="kj hj">Constraint </strong></code>，这样一个 pod 必须有一个特定的标签。如果需要，我们可以使用同一个<code class="du mr ms mt lt b"><strong class="kj hj">ConstraintTemplate</strong></code> <strong class="kj hj"> </strong>创建另一个<code class="du mr ms mt lt b"><strong class="kj hj">Constraint </strong></code>，但这一次它将用于一个名称空间。我们可以写一个<code class="du mr ms mt lt b"><strong class="kj hj">Constraint</strong></code>，这样一个名称空间必须有一个特定的标签。</p><p id="dd08" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">下面是名为<strong class="kj hj">“ns-must-label-state . YAML”</strong>的<code class="du mr ms mt lt b"><strong class="kj hj">Constraint</strong></code> <strong class="kj hj"> </strong>文件，用于强制名称空间具有名为<strong class="kj hj"> state </strong>的特定标签:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="c48e" class="lx jk hi lt b be ly lz l ma mb"># ns-must-label-state.yaml<br/><br/>apiVersion: constraints.gatekeeper.sh/v1beta1<br/>kind: K8sRequiredLabels<br/>metadata:<br/>  name: ns-must-label-state<br/>spec:<br/>  match:<br/>    kinds:<br/>      - apiGroups: [""]<br/>        kinds: ["Namespace"]<br/>  parameters:<br/>    labels: ["state"]</span></pre><p id="a9e6" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">让我们使用上面定义的<strong class="kj hj">“ns-must-label-state . YAML”来创建<code class="du mr ms mt lt b"><strong class="kj hj">Constraint </strong></code>:</strong></p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="c81e" class="lx jk hi lt b be ly lz l ma mb">&gt;&gt; kubectl create -f ns-must-label-state.yaml<br/><br/># List the available Constraint's<br/>&gt;&gt; kubectl get constraints<br/><br/>NAME                      ENFORCEMENT-ACTION   TOTAL-VIOLATIONS<br/>ns-must-label-state                            5<br/>pod-must-have-app-level                        13</span></pre><p id="81cd" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">然后创建一个<strong class="kj hj">名称空间</strong>，而没有定义所需的标签，在当前情况下标签为“<strong class="kj hj">状态</strong>”:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="3c99" class="lx jk hi lt b be ly lz l ma mb">&gt;&gt; kubectl create ns test<br/><br/>Error from server (Forbidden): admission webhook "validation.gatekeeper.sh" denied the request: [ns-must-label-state] you must provide labels: {"state"}</span></pre><p id="a985" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">现在，使用所需的标签创建一个名称空间，看看会发生什么:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="fe32" class="lx jk hi lt b be ly lz l ma mb"># test-ns.yaml<br/><br/>apiVersion: v1<br/>kind: Namespace<br/>metadata:<br/>  name: test<br/>  labels:<br/>    state: dev   #&lt;---<br/><br/>---<br/><br/>&gt;&gt; kubectl create -f test-ns.yaml<br/>namespace/test created</span></pre><p id="af5a" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">在上面的演示中，我们可以看到命名空间的创建没有任何问题，因为我们指定了所需的标签。</p><h2 id="883a" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">检查违规情况</h2><p id="3873" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">我们可以描述或检查一个<code class="du mr ms mt lt b"><strong class="kj hj">Constraint</strong></code>来找出现有 kubernetes 资源的违反政策的情况:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="20e7" class="lx jk hi lt b be ly lz l ma mb"># To describe a Constraint<br/>&gt;&gt; kubectl describe &lt;ConstraintTemplate&gt;  &lt;Constraint&gt;</span></pre><p id="dd33" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">让我们描述一下"<strong class="kj hj"> ns-must-label-state </strong>"约束:</p><pre class="iy iz ja jb fd ls lt lu bn lv lw bi"><span id="5619" class="lx jk hi lt b be ly lz l ma mb">                     [ConstraintTemplate]  [Constraint]<br/>&gt;&gt; kubectl describe  k8srequiredlabels     ns-must-label-state<br/><br/>#--------------------------------------------------------------------------<br/><br/>Name:         ns-must-label-state<br/>Namespace:    <br/>...<br/>...<br/>Status:<br/>  Audit Timestamp:  2022-11-30T02:32:48Z<br/>  By Pod:<br/>    Constraint UID:       846a2d86-5d00-4eba-bd6a-669cd27fc703<br/>    Enforced:             true<br/>    Id:                   gatekeeper-audit-56ddcd8749-htgk5<br/>    Observed Generation:  1<br/>    Operations:<br/>      audit<br/>      mutation-status<br/>      status<br/>    Constraint UID:       846a2d86-5d00-4eba-bd6a-669cd27fc703<br/>    Enforced:             true<br/>    Id:                   gatekeeper-controller-manager-64fd6c8cfd-jh7qr<br/>    Observed Generation:  1<br/>    Operations:<br/>      mutation-webhook<br/>      webhook<br/>    Constraint UID:       846a2d86-5d00-4eba-bd6a-669cd27fc703<br/>    Enforced:             true<br/>    Id:                   gatekeeper-controller-manager-64fd6c8cfd-q6ds9<br/>    Observed Generation:  1<br/>    Operations:<br/>      mutation-webhook<br/>      webhook<br/>    Constraint UID:       846a2d86-5d00-4eba-bd6a-669cd27fc703<br/>    Enforced:             true<br/>    Id:                   gatekeeper-controller-manager-64fd6c8cfd-rbvsz<br/>    Observed Generation:  1<br/>    Operations:<br/>      mutation-webhook<br/>      webhook<br/>  Total Violations:  5        #&lt;-------------<br/>  Violations:<br/>    Enforcement Action:  deny<br/>    Group:               <br/>    Kind:                Namespace<br/>    Message:             you must provide labels: {"state"}<br/>    Name:                kube-public<br/>    Version:             v1<br/>    Enforcement Action:  deny<br/>    Group:               <br/>    Kind:                Namespace<br/>    Message:             you must provide labels: {"state"}<br/>    Name:                kube-node-lease<br/>    Version:             v1<br/>    Enforcement Action:  deny<br/>    Group:               <br/>    Kind:                Namespace<br/>    Message:             you must provide labels: {"state"}<br/>    Name:                gatekeeper-system<br/>    Version:             v1<br/>    Enforcement Action:  deny<br/>    Group:               <br/>    Kind:                Namespace<br/>    Message:             you must provide labels: {"state"}<br/>    Name:                kube-system<br/>    Version:             v1<br/>    Enforcement Action:  deny<br/>    Group:               <br/>    Kind:                Namespace<br/>    Message:             you must provide labels: {"state"}<br/>    Name:                default<br/>    Version:             v1<br/>Events:                  &lt;none&gt;</span></pre><p id="b8d3" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">在上图中，我们可以看到有几个名称空间违反了策略，这是因为它们(名称空间)是在创建<strong class="kj hj"> "ns-must-label-state" </strong>约束之前创建的。</p><h2 id="2816" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">OPA 网守库</h2><p id="c8e1" class="pw-post-body-paragraph kh ki hi kj b kk kl ij km kn ko im kp ju kq kr ks jy kt ku kv kc kw kx ky kz hb bi translated">有一个社区拥有的 OPA 看门人项目政策库。</p><p id="6d10" class="pw-post-body-paragraph kh ki hi kj b kk lb ij km kn lc im kp ju ld kr ks jy le ku kv kc lf kx ky kz hb bi translated">● <a class="ae la" href="https://open-policy-agent.github.io/gatekeeper-library/website/" rel="noopener ugc nofollow" target="_blank"> OPA 网守库</a></p></div><div class="ab cl mw mx gp my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="hb hc hd he hf"><blockquote class="lg lh li"><p id="3f5c" class="kh ki lj kj b kk lb ij km kn lc im kp lk ld kr ks ll le ku kv lm lf kx ky kz hb bi translated"><em class="hi">如果你觉得这篇文章很有帮助，请</em> <strong class="kj hj"> <em class="hi">别忘了</em> </strong> <em class="hi">来砸</em> <strong class="kj hj"> <em class="hi">跟着</em> </strong> <em class="hi">👉</em><strong class="kj hj"><em class="hi"/></strong><em class="hi"/><strong class="kj hj"><em class="hi">拍拍</em> </strong> <em class="hi">👏</em> <strong class="kj hj"> <em class="hi"> </em> </strong> <em class="hi">按钮帮助我写更多这样的文章。<br/>谢谢🖤 </em></p></blockquote></div><div class="ab cl mw mx gp my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="hb hc hd he hf"><h2 id="a129" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">🚀👉<strong class="ak">Kubernetes 上的所有文章</strong></h2><div class="nd ne ez fb nf"><div role="button" tabindex="0" class="ab bv ff cb dy ng nh bn ni jh nj"><div class="nk l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw nl nm du" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="dr bw l nl nm ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" rel="noopener follow" target="_top" href="/@shamimice03?source=post_page-----69ca657c8631--------------------------------"> Md 沙米姆</a></p></div></div><div class="np nq fg l"><h2 class="bd hj td md dy te ea eb tf ed ef hh bi translated">关于 Kubernetes 的所有文章</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi tg au th ti tj qg tk an fx fy tl tm tn gb gc gd de bk ge" rel="noopener follow" target="_top" href="/@shamimice03/list/all-articles-on-kubernetes-7ae1a0f96f3b?source=post_page-----69ca657c8631--------------------------------">View list</a></div><div class="to l dw"><span class="bd b fp z dx">24 stories</span></div></div></div><div class="oc dh od dy ab oe dw di"><div class="di nu bv nv nw"><div class="dh l"><img alt="" class="dh" src="../Images/f1050aa27a3ef03122558b1ba1de1f58.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7DhVxBWLKw_5M_jP"/></div></div><div class="di nu bv nx ny nz"><div class="dh l"><img alt="" class="dh" src="../Images/f1c4131e92176033bce05392de197205.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/1*AkrEbqlA_j76u2I5Tm8npg.png"/></div></div><div class="di bv oa ob nz"><div class="dh l"><img alt="" class="dh" src="../Images/27d4385154af67764cf37713dbbdc38e.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*98RmgcHgM1cyOobu"/></div></div></div></div></div><h2 id="1724" class="jj jk hi bd jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg bi translated">🚀👉<strong class="ak"> HelmーSeries </strong></h2><div class="nd ne ez fb nf"><div role="button" tabindex="0" class="ab bv ff cb dy ng nh bn ni jh nj"><div class="nk l"><div class="ab q"><div class="l di"><img alt="Md Shamim" class="l de bw nl nm du" src="../Images/b46bdc53005abde6c6cb3e8ff0c200c3.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*Hqd8Xz1WHsoL1s2To3awnA.png"/><div class="dr bw l nl nm ds n aw dt"/></div><div class="gg l dw"><p class="bd b fp z dy dz ea eb ec ed ee ef dx translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" rel="noopener follow" target="_top" href="/@shamimice03?source=post_page-----69ca657c8631--------------------------------"> Md 沙米姆</a></p></div></div><div class="np nq fg l"><h2 class="bd hj td md dy te ea eb tf ed ef hh bi translated">HelmーSeries</h2></div><div class="ab q"><div class="l dw"><a class="bd b be z bi tg au th ti tj qg tk an fx fy tl tm tn gb gc gd de bk ge" rel="noopener follow" target="_top" href="/@shamimice03/list/helmseries-6e2076d48ba8?source=post_page-----69ca657c8631--------------------------------">View list</a></div><div class="to l dw"><span class="bd b fp z dx">11 stories</span></div></div></div><div class="oc dh od dy ab oe dw di"><div class="di nu bv nv nw"><div class="dh l"><img alt="" class="dh" src="../Images/9ba5df61339b6f5d2ad01696050835e3.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*3NGLzkzV47jeWMX8"/></div></div><div class="di nu bv nx ny nz"><div class="dh l"><img alt="" class="dh" src="../Images/74e4f8812ce0aceba2616e176b3021c2.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*wzqjRqAlMOjlwt7x"/></div></div><div class="di bv oa ob nz"><div class="dh l"><img alt="" class="dh" src="../Images/a734d6746ba78eda4d8d1347c4231bae.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*6RKJMoeEspoXyjGN"/></div></div></div></div></div></div></div>    
</body>
</html>