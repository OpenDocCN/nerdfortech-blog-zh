<html>
<head>
<title>PKI Certs Injection to K8s Pods with Vault Agent Injector</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用保险库代理注入器向 K8s Pods 注入 PKI 证书</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/pki-certs-injection-to-k8s-pods-with-vault-agent-injector-d97482b48f3d?source=collection_archive---------0-----------------------#2022-04-22">https://medium.com/nerd-for-tech/pki-certs-injection-to-k8s-pods-with-vault-agent-injector-d97482b48f3d?source=collection_archive---------0-----------------------#2022-04-22</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5d38" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用保管库代理注入器将 PKI 证书动态注入到 Kubernetes Pods</p><p id="10da" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">想象你的应用在 Kubernetes 上运行。想象一下，在运行 Pod 之前，你也有一大堆秘密要被拉入 Pod。所以你有一个保险库代理注入器运行并从中提取秘密。啊，太好了。你正在遵循存储和提取秘密的最佳实践。你都准备好了，不是吗？坚持住！！你是如何获得 SSL / TLS 证书的？又是库伯内特的秘密？不要。！为什么我们不用同一个保险库代理注射器？可能吗？是的，为什么不呢。所以你可能已经猜到了这篇文章的内容。在本文中，我们将了解如何使用 Vault Agent Injector 动态生成 PKI 证书并将其注入 Pod。Vault Agent Injector 更改了 pod 规范，以包括使用<a class="ae jd" href="https://www.vaultproject.io/docs/agent/template" rel="noopener ugc nofollow" target="_blank"> Vault Agent 模板</a>将 Vault 机密呈现到共享内存卷的 Vault Agent 容器。通过将机密呈现给共享卷，pod 中的容器可以在不知道 Vault 的情况下使用 Vault 机密。</p><p id="bee6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">注射器是一个<a class="ae jd" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" rel="noopener ugc nofollow" target="_blank"> Kubernetes 突变 Webhook 控制器</a>。如果请求中存在注释，控制器会截获 pod 事件并对 pod 应用突变。该功能由<a class="ae jd" href="https://github.com/hashicorp/vault-k8s" rel="noopener ugc nofollow" target="_blank"> vault-k8s </a>项目提供，可以使用<a class="ae jd" href="https://github.com/hashicorp/vault-helm" rel="noopener ugc nofollow" target="_blank"> Vault Helm </a>图表自动安装和配置。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/0e3aec93b0192e43ad0b305eac6074a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*R4qMCAW2yXRVRUCp.jpg"/></div></div></figure><h1 id="4472" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">整个故事是关于什么的？(TLDR)</h1><ol class=""><li id="b0c7" class="ko kp hi ih b ii kq im kr iq ks iu kt iy ku jc kv kw kx ky bi translated">使用 Vault K8s 注入器生成 PKI 证书。</li><li id="dc49" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">动态生成 PKI 证书。</li></ol><h1 id="7899" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">先决条件</h1><ol class=""><li id="e1da" class="ko kp hi ih b ii kq im kr iq ks iu kt iy ku jc kv kw kx ky bi translated">一个库贝内特斯集群(EKS、阿克、金德等)</li></ol><h1 id="dd8b" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">故事资源</h1><ol class=""><li id="3fd9" class="ko kp hi ih b ii kq im kr iq ks iu kt iy ku jc kv kw kx ky bi translated">GitHub 链接:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests</a></li><li id="9cc1" class="ko kp hi ih b ii kz im la iq lb iu lc iy ld jc kv kw kx ky bi translated">GitHub 分支:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/tree/pki-agent-injector" rel="noopener ugc nofollow" target="_blank"> pki 代理注入器</a></li></ol><h1 id="1959" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">使用舵图安装 Hashicorp 保险库</h1><p id="4f0d" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">我们将为金库安装官方头盔图，并手动解封。但是，这不是在生产环境中运行存储库的理想方式。您可能希望使用 KMS 密钥(如果安装在 AWS 中)或谷歌 KMS 密钥(如果安装在 GCP)来解封保险库。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div></figure><h2 id="6bd1" class="lj jr hi bd js lk ll lm jw ln lo lp ka iq lq lr ke iu ls lt ki iy lu lv km lw bi translated">掌舵安装 PKI 保险库</h2><p id="a447" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">一旦安装了 helm chart，您应该会发现创建了一个名为 vault 的有状态集合，还创建了一个名为<strong class="ih hj"> vault-0 </strong>的 pod。但是，pod 未处于就绪状态，这是因为保险库尚未启封。现在让我们通过执行进入吊舱来打开保险库。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="0035" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">vault _ pki _ 开封. sh</p><p id="24af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们理解 init 命令的作用</p><blockquote class="lx ly lz"><p id="9fb3" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated"><em class="hi">金库操作员 init-key-shares = 1-key-threshold = 1</em></p><p id="440f" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated"><em class="hi">-key-shares =将生成的主密钥拆分成的密钥份额数。默认情况下是 5 把，需要 3 把钥匙才能打开保险库</em></p><p id="a0ba" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated"><em class="hi">-key-threshold =重建主密钥所需的密钥份额数。这必须小于或等于密钥份额。默认为 3。</em></p></blockquote><h1 id="2684" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">生成根 CA 和中间 CA</h1><p id="b2b5" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">Vault PKI 后端可以生成自己的自签名 CA。但是让我们创建我们自己的 CA，然后将它上传到 vault PKI 中，以签署我们的证书。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="f66f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在已经生成了我们的证书，现在让我们配置我们的 vault PKI 后端，以将这些证书添加为 CA。我们还必须创建保管库角色以及保管库发布和 CRL URLs。</p><h1 id="999e" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">配置保管库的 PKI 后端</h1><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="c313" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们一个一个地理解这些命令</p><blockquote class="lx ly lz"><p id="2972" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated"><em class="hi">vault log in $ VAULT _ ROOT _ TOKEN =用于使用根令牌登录 VAULT。</em></p><p id="0532" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated"><em class="hi"> vault secrets enable pki =用于启用 vault pki 后端。</em></p><p id="9df1" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated"><em class="hi">vault secrets tune-max-lease-ttl = 8760h pki =我们将 PKI 后端的 TTL 配置为 8760 小时。</em></p><p id="59a1" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated"><em class="hi">vault write PKI/config/ca PEM _ bundle = @ PEM _ bundle ttl = 8760h =&gt;我们将 CA 证书写入 vault，并将其 TTL 设置为 8760h </em></p></blockquote><p id="775c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经将 PKI 证书上传到了保险库中。现在让我们创建一个 Vault PKI 角色。角色定义设置生成证书的条件。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="1c6d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了角色，我们就应该配置可以颁发和撤销证书的端点。</p><p id="6bf7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们为相应的 vault PKI 角色创建一个 vault 策略。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div></figure><h1 id="aa63" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">启用 Kubernetes 身份验证方法</h1><p id="ee49" class="pw-post-body-paragraph if ig hi ih b ii kq ik il im kr io ip iq le is it iu lf iw ix iy lg ja jb jc hb bi translated">Kubernetes auth 方法可用于使用 Kubernetes 服务帐户令牌对 vault 进行身份验证。这将帮助保管库将保管库令牌注入到 Kubernetes Pod 中。为此，让我们通过 exec 在 pod 中启用 vault Kubernetes 后端，因为必须从 vault pod 中传递<strong class="ih hj"> token_reviewer_jwt </strong>。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div></figure><p id="8e6c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在已经创建了一个 Kubernetes auth 角色。此角色被绑定到服务帐户名 issuer 和名为 default 的命名空间以及先前创建的名为 betttercallpavan_pki 的策略。</p><pre class="jf jg jh ji fd me mf mg mh aw mi bi"><span id="f2ad" class="lj jr hi mf b fi mj mk l ml mm">$ git clone <a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b pki-agent-injector</span><span id="f473" class="lj jr hi mf b fi mn mk l ml mm">$ cd medium-manifests</span><span id="330d" class="lj jr hi mf b fi mn mk l ml mm">$ kubectl apply -f pki-pod.yaml</span></pre><p id="1cfa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用带有 PKI 证书的 Vault 注入器。</p><p id="66fb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">所有注释的列表可以在<a class="ae jd" href="https://www.vaultproject.io/docs/platform/k8s/injector/annotations" rel="noopener ugc nofollow" target="_blank">这里</a>找到</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lh li l"/></div></figure><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es mo"><img src="../Images/f0907896196442a4dd187e551992fc0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cohFgXwIdyT1HleI77FFZw.png"/></div></div></figure><blockquote class="lx ly lz"><p id="1e09" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated">kubectl exec-it PKI-test-c PKI-test—/bin/bash-c " ls/vault/secrets "</p><p id="6ba7" class="if ig ma ih b ii ij ik il im in io ip mb ir is it mc iv iw ix md iz ja jb jc hb bi translated">ku bectl exec-it PKI-test-c PKI-test—/bin/bash-c " cat/vault/secrets/server . CRT "</p></blockquote><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mp"><img src="../Images/e6dd2d993e32efbb1ba8d48832adbbeb.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/0*lCypFN7fSPAeTE-_.gif"/></div></figure><p id="204e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您应该可以看到 pod 中的证书和密钥。这就是 PKI 证书可以自动注入的方式，而不需要任何 sidecar 或 init 容器或任何其他额外的更改。因此，每当 pod 重新启动时，证书会自动重新生成并注入到 Pod 中。</p><p id="e74d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">清理</strong></p><pre class="jf jg jh ji fd me mf mg mh aw mi bi"><span id="9af9" class="lj jr hi mf b fi mj mk l ml mm">$ git clone <a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b pki-agent-injector</span><span id="7ecc" class="lj jr hi mf b fi mn mk l ml mm">$ cd medium-manifests</span><span id="b7f5" class="lj jr hi mf b fi mn mk l ml mm">$ kubectl delete -f pki-pod.yaml</span></pre><h1 id="75bc" class="jq jr hi bd js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn bi translated">被推荐的</h1><div class="mq mr ez fb ms mt"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/using-hashicorp-vault-as-a-certificate-issuer-in-cert-manager-9e19d7239d3d"><div class="mu ab dw"><div class="mv ab mw cl cj mx"><h2 class="bd hj fi z dy my ea eb mz ed ef hh bi translated">在证书管理器中将 Hashicorp Vault 用作证书颁发者</h2><div class="na l"><h3 class="bd b fi z dy my ea eb mz ed ef dx translated">在证书管理器中将 vault PKI 后端配置为证书提供商</h3></div><div class="nb l"><p class="bd b fp z dy my ea eb mz ed ef dx translated">medium.com</p></div></div><div class="nc l"><div class="nd l ne nf ng nc nh jo mt"/></div></div></a></div><div class="mq mr ez fb ms mt"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/terraforming-the-cost-with-infracost-c28dc6c981c9"><div class="mu ab dw"><div class="mv ab mw cl cj mx"><h2 class="bd hj fi z dy my ea eb mz ed ef hh bi translated">用 Infracost 分析地形成本(GitOps 方法)</h2><div class="na l"><h3 class="bd b fi z dy my ea eb mz ed ef dx translated">用基础成本分析土地改造成本</h3></div><div class="nb l"><p class="bd b fp z dy my ea eb mz ed ef dx translated">medium.com</p></div></div><div class="nc l"><div class="ni l ne nf ng nc nh jo mt"/></div></div></a></div><div class="mq mr ez fb ms mt"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/terraforming-the-gitops-way-9417cf4abf58"><div class="mu ab dw"><div class="mv ab mw cl cj mx"><h2 class="bd hj fi z dy my ea eb mz ed ef hh bi translated">地球化吉托普斯之路！！！</h2><div class="na l"><h3 class="bd b fi z dy my ea eb mz ed ef dx translated">使用 Atlantis(拉式请求自动化)通过 GitOps 建立 Terraform。</h3></div><div class="nb l"><p class="bd b fp z dy my ea eb mz ed ef dx translated">medium.com</p></div></div><div class="nc l"><div class="nj l ne nf ng nc nh jo mt"/></div></div></a></div><div class="mq mr ez fb ms mt"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/kubernetes-cluster-autoscaler-in-action-6172a023f542"><div class="mu ab dw"><div class="mv ab mw cl cj mx"><h2 class="bd hj fi z dy my ea eb mz ed ef hh bi translated">Kubernetes 集群自动缩放器正在运行</h2><div class="na l"><h3 class="bd b fi z dy my ea eb mz ed ef dx translated">使用 Kubernetes 集群自动缩放器有效节约成本</h3></div><div class="nb l"><p class="bd b fp z dy my ea eb mz ed ef dx translated">medium.com</p></div></div><div class="nc l"><div class="nk l ne nf ng nc nh jo mt"/></div></div></a></div></div></div>    
</body>
</html>