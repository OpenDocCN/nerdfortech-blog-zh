<html>
<head>
<title>Threat Modeling — Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">威胁建模— Lambda</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/threat-modelling-lambda-dac9c6f7ac06?source=collection_archive---------1-----------------------#2022-05-13">https://medium.com/nerd-for-tech/threat-modelling-lambda-dac9c6f7ac06?source=collection_archive---------1-----------------------#2022-05-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1976" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">将安全性嵌入lambda服务产品中</p><p id="e25e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在上一篇博客<a class="ae jd" rel="noopener" href="/nerd-for-tech/threat-modeling-eks-c1e06f6814f">威胁建模— EKS </a>中，我们看到了如何评估EKS的安全态势，在这篇博客中，我们将为AWS Lambda做一个类似的练习。</p><h2 id="f3db" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">分担责任模式</h2><p id="a769" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated"><strong class="ih hj">客户</strong></p><blockquote class="ke kf kg"><p id="2af0" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated">功能代码、库、扩展、层<br/>云中数据<br/>在途数据<br/>资源配置<br/> IAM <br/>其他服务配置</p></blockquote><p id="69f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> AWS </strong>:</p><blockquote class="ke kf kg"><p id="4401" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated">计算<br/>联网<br/>执行环境<br/>运行时语言<br/>服务器软件硬件AZ，地区</p></blockquote><p id="cea6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">下图描述了lambda服务的各种参与者、入口和出口点。</p><figure class="km kn ko kp fd kq er es paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="er es kl"><img src="../Images/9aa58d20d7f41fed37cfd2c24c3c4f6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9BqxZQ7IOPdVEkZIaFGxqQ.png"/></div></div><figcaption class="kx ky et er es kz la bd b be z dx translated">lambda(安全视图)的数据流</figcaption></figure><h2 id="1511" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">资源</h2><ul class=""><li id="68a1" class="lb lc hi ih b ii jz im ka iq ld iu le iy lf jc lg lh li lj bi translated">λ函数</li><li id="06a6" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">Lambda函数URL</li><li id="00f7" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">λ层</li><li id="fce2" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">Lambda EventSourceMapping对象</li><li id="e8ca" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">拉姆达DLQ &amp;活动目的地</li><li id="e97c" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">Lambda版本和别名</li><li id="2538" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">λ资源策略</li><li id="5ab2" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">拉姆达·EFS坐骑</li><li id="cefe" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">Lambda服务端点</li><li id="cbdb" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">Docker图像的ECR</li></ul><h2 id="5be4" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">威胁</h2><ul class=""><li id="d63b" class="lb lc hi ih b ii jz im ka iq ld iu le iy lf jc lg lh li lj bi translated">不适当的访问控制</li><li id="5cea" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">权限提升</li><li id="98a7" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">不安全的资源配置</li><li id="5780" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">功能监控和记录不足</li><li id="03ef" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">异常处理不当&amp;详细错误</li><li id="19c2" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">敏感数据暴露</li><li id="8dad" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">不安全的第三方依赖</li><li id="188c" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">事件有效负载操作</li><li id="a2e7" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">不安全的秘密存储</li><li id="0bb2" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">资源枯竭</li><li id="41bc" class="lb lc hi ih b ii lk im ll iq lm iu ln iy lo jc lg lh li lj bi translated">执行流操作</li></ul><p id="f422" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在查看威胁向量后，我们有以下几点来确保安全的lambda使用:</p><p id="d4d3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">设置访问控制标准和<strong class="ih hj">限制对Lambda API</strong>和部署流程的访问——我们应该避免从控制台创建Lambda函数。应该使用IaC将其映射到CI/CD流程。这将允许我们将lambda的管理API控制到几个角色。我们还需要限制可以传递给lambda函数的角色。有问题的API如下:</p><p id="b54b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du lp lq lr ls b">lambda:AddPermission</code><code class="du lp lq lr ls b">lambda:CreateAlias</code><code class="du lp lq lr ls b">lambda:CreateEventSourceMapping</code><code class="du lp lq lr ls b">lambda:CreateFunction</code><code class="du lp lq lr ls b">lambda:CreateFunctionUrlConfig</code><code class="du lp lq lr ls b">lambda:DeleteEventSourceMapping</code><code class="du lp lq lr ls b">lambda:DeleteFunction</code><code class="du lp lq lr ls b">lambda:DeleteFunctionEventInvokeConfig</code><code class="du lp lq lr ls b">lambda:DeleteLayerVersion</code><code class="du lp lq lr ls b">lambda:InvokeFunction</code><code class="du lp lq lr ls b">lambda:InvokeFunctionUrl</code><code class="du lp lq lr ls b">lambda:PublishLayerVersion</code><code class="du lp lq lr ls b">lambda:PublishVersion</code><code class="du lp lq lr ls b">lambda:PutFunctionEventInvokeConfig</code><code class="du lp lq lr ls b">lambda:RemovePermisison</code><code class="du lp lq lr ls b">lambda:UpdateAlias</code><code class="du lp lq lr ls b">lambda:EventSourceMapping</code><code class="du lp lq lr ls b">lambda:UpdateFunctionCode</code><code class="du lp lq lr ls b">lambda:UpdateFunctionConfiguration</code><code class="du lp lq lr ls b">lambda:UpdateFunctionEventInvokeConfig</code><code class="du lp lq lr ls b">lambda:UpdateFunctionUrlConfig</code></p><p id="0097" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">避免monolambdas  —通过保持函数的粒度，我们可以限制它们的特权，从而减少攻击面。一个lambda函数应该服务于一个目的，并且应该映射到一个Lambda专有的角色。</p><p id="2dd1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">授予最小特权</strong> —我们只需要授予功能角色所需的访问权限。例如，如果函数只需要对S3存储桶路径进行读写访问，我们应该只授予这个权限。我们应该具体到API动作和资源。</p><p id="5a29" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">保留并发</strong> —对于关键功能，确保保留并发。这有助于我们将该函数与其他函数隔离开来。此外，这还设置了上限，以便在DoS攻击的情况下，函数不会超出帐户并发调用的限制。它还改善了冷启动。提供的并发数为5将使5个执行环境在函数调用之前做好准备。</p><p id="f18e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">实现断路器</strong> —对于事件源映射对象，我们应该总是实现断路器模式。基于定制的CloudWatch指标，我们应该启用或禁用事件源映射。此模式防止DDoS使用源泛洪。</p><p id="d175" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">带有lambda的RDS代理</strong> —使用RDS代理连接数据库允许我们共享连接，并且我们不需要传递数据库凭证。<code class="du lp lq lr ls b"><strong class="ih hj">rds-dc:connect</strong></code></p><p id="4ff2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">事件数据验证</strong> —我们应该利用lambda代码中的事件验证框架来确保lambda得到预期的事件。我们可以利用python的<code class="du lp lq lr ls b">pydantic</code>来进行事件验证。</p><pre class="km kn ko kp fd lt ls lu lv aw lw bi"><span id="a930" class="je jf hi ls b fi lx ly l lz ma">pip install aws-lambda-powertools[pydantic]</span></pre><p id="aa32" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">从日志中删除PII</strong>—由于log/print语句会将数据放入CloudWatch，我们应该避免为了数据而这样做。应该只记录执行流信息/错误。</p><p id="ab3a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">在构建过程中实现依赖扫描</strong>——我们不希望在产品中出现不安全的代码。所以我们希望依赖扫描成为我们构建过程的一部分，例如lambda层和Lambda代码。Lambda层需要特别注意，因为它也用于扩展。像<code class="du lp lq lr ls b"><strong class="ih hj">trivy &amp; safety</strong></code>这样的包可以用来做扫描。</p><pre class="km kn ko kp fd lt ls lu lv aw lw bi"><span id="1f7e" class="je jf hi ls b fi lx ly l lz ma">pip install safety<br/>safety check -r requirements.txt --full-report # manual<br/>safety check -r requirements --bare # get vulnerable package &amp; fail</span></pre><p id="b3dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">图像扫描</strong> —类似于依赖扫描，我们应该对lambda函数中使用的ECR图像进行连续扫描。<code class="du lp lq lr ls b"><strong class="ih hj">twistlock</strong></code>可在映像构建过程中作为扫描工具添加。</p><p id="c579" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">限制对ECR的访问</strong> —由于lambda使用相同的角色来提供和执行功能，我们应该将对ECR(docker功能)的访问仅限于特定的映像报告。</p><p id="14c7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">限制访问EFS坐骑</p><p id="4cb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">Lambda函数代码或配置中没有凭证</strong> —我们应该始终从系统管理器或秘密管理器获取凭证(第三方API凭证)。函数代码或env中没有硬编码。</p><p id="3e34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">删除不用的函数</strong> —清理不用的lambda函数总是好的。这减少了攻击媒介，因为旧的lambdas可能有过时和未打补丁的运行时。</p><p id="b9ed" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">版本化&amp;别名</strong> —我们应该避免使用$LATEST。这是默认的，很容易猜到。更好的选择是使用版本控制并为其添加一个别名。授予别名的执行权限。这有助于减少点击&amp;试用漏洞。</p><pre class="km kn ko kp fd lt ls lu lv aw lw bi"><span id="cc9d" class="je jf hi ls b fi lx ly l lz ma">{<br/>  "Sid": "Invoke",<br/>  "Effect": "Allow",<br/>  "Action": [<br/>    "lambda:InvokeFunction"<br/>  ],<br/>  "Resource": "arn:aws:lambda:us-east-1:123456789012:function:our-function:<strong class="ls hj">cool-alias</strong>"<br/>}</span></pre><p id="17b8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">安全死信队列</strong> —由于DLQ用于传递失败事件，我们需要保护dlq，因为它们可能包含敏感事件。</p><p id="88a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">删除弃用的运行时</strong> —因为AWS不对弃用的运行时(如python 2)应用安全补丁。* python 3.4|5|6，我们不应该使用那些运行时。</p><p id="c9bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">加密环境变量</strong> —如果我们使用env对lambda进行参数化，我们应该使用KMS对这些变量进行加密，这样在控制台中以及lambda函数被未授权的角色描述时，这些变量就不可见了。此外，将敏感信息存储在SSM/秘密管理器中，按需索取，不要在功能代码中记录或打印这些信息。</p><p id="b3af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">API Gateway(Implement Auth)后面的Lambda</strong>—应该避免直接调用Lambda函数。我们应该把它们放在API网关后面，在API网关实现auth。对于ALB后面的lambda，我们应该在lambda代码中有认证和授权逻辑。同样对于ALB，我们应该实现IP &amp;协议边界。对于具有函数URL的lambda，请确保启用了AUTH。此外，我们应该将<code class="du lp lq lr ls b"><strong class="ih hj">lambda:InvokeFunctionUrl</strong></code> API限制为尽可能少的角色。</p><p id="e408" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">将VPC端点</strong>策略锁定为仅允许的操作或资源—为AWS服务添加尽可能严格的端点策略是一个好主意。另外，为VPC的lambdas添加一个使用vpce进行调用的条件</p><pre class="km kn ko kp fd lt ls lu lv aw lw bi"><span id="0c10" class="je jf hi ls b fi lx ly l lz ma">{<br/>  "Action": ["lambda:InvokeFunction"],<br/>  "Resource": [<br/>    "arn:aws:lambda:us-east-1:123456789012:function:our-function:cool-alias"<br/>  ],<br/>  "Effect": "Allow"<br/>  <strong class="ls hj">"Condition":<br/>    StringEquals:<br/>     'aws:sourceVpce': "vpce-xxxxx"</strong><br/>}</span></pre><p id="7b85" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">短函数超时</strong> —函数超时越短，恶意代码运行时间越长的风险就越小。但是要确保您的超时考虑到了某些延迟的执行。P95持续时间+ 10%。</p><p id="88d4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj"> Clean /tmp </strong> —在连续的调用之间/tmp文件夹被重用，因此在函数执行期间必须清理写入/tmp的文件。因为它可能包含敏感信息。使用带有上下文处理程序的运行时临时文件，比如<code class="du lp lq lr ls b"><strong class="ih hj">tempfile</strong></code>。</p><p id="1219" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">日志&amp;监控</strong> —我们应该确保启用了lambda日志，对于生产工作负载，我们已经增强了监控。我们应该创建关于Lambda故障、超时、&amp;节流的警报。</p><p id="0729" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">主动跟踪</strong> —对于与其他lambda或无服务器组件一起使用的lambda，我们应启用X射线跟踪。这使我们能够看到服务地图，并跟踪端到端的执行流程。</p><h2 id="046a" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">侦探规则</h2><p id="49e2" class="pw-post-body-paragraph if ig hi ih b ii jz ik il im ka io ip iq kb is it iu kc iw ix iy kd ja jb jc hb bi translated">我们可以尽快创建配置规则来主动应对安全问题。可以使用以下配置规则:</p><blockquote class="ke kf kg"><p id="ba5e" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated"><em class="hi">检查具有通配符IAM权限的Lambda函数<br/>检查没有死信队列的Lambda函数<br/>检查没有授权的函数URL<br/>检查没有触发器的Lambda函数<br/>检查具有多个触发器的Lambda函数<br/>检查未知的跨帐户访问<br/>检查具有不推荐使用的运行时的Lambda函数<br/>检查单个IAM角色是否被多个Lambda函数使用<br/>检查使用控制台(CloudTrail规则)创建的Lambda函数</em></p></blockquote><h2 id="df20" class="je jf hi bd jg jh ji jj jk jl jm jn jo iq jp jq jr iu js jt ju iy jv jw jx jy bi translated">最佳实践</h2><blockquote class="ke kf kg"><p id="ab46" class="if ig kh ih b ii ij ik il im in io ip ki ir is it kj iv iw ix kk iz ja jb jc hb bi translated"><em class="hi"> Graviton运行时节省成本<br/>将公共代码部署到lambda层<br/>较小的Docker映像<br/>将lambda处理程序与服务逻辑分开<br/>为lambda启用DLQ<br/>为Lambda日志谨慎设置保留期<br/>利用Lambda Powertools </em></p></blockquote><p id="9a0a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">安全快乐！！</p><p id="6582" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">资源:</p><div class="mb mc ez fb md me"><a href="https://awslabs.github.io/aws-lambda-powertools-python/latest/" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab dw"><div class="mg ab mh cl cj mi"><h2 class="bd hj fi z dy mj ea eb mk ed ef hh bi translated">主页</h2><div class="ml l"><h3 class="bd b fi z dy mj ea eb mk ed ef dx translated">AWS Lambda函数的一套实用程序，用于简化采用最佳实践，如跟踪、结构化日志记录…</h3></div><div class="mm l"><p class="bd b fp z dy mj ea eb mk ed ef dx translated">awslabs.github.io</p></div></div><div class="mn l"><div class="mo l mp mq mr mn ms kv me"/></div></div></a></div><div class="mb mc ez fb md me"><a href="https://pydantic-docs.helpmanual.io/" rel="noopener  ugc nofollow" target="_blank"><div class="mf ab dw"><div class="mg ab mh cl cj mi"><h2 class="bd hj fi z dy mj ea eb mk ed ef hh bi translated">pydantic</h2><div class="ml l"><h3 class="bd b fi z dy mj ea eb mk ed ef dx translated">版本文档:1.9.0使用python类型注释的数据验证和设置管理。pydantic…</h3></div><div class="mm l"><p class="bd b fp z dy mj ea eb mk ed ef dx translated">pydantic-docs.helpmanual.io</p></div></div></div></a></div></div></div>    
</body>
</html>