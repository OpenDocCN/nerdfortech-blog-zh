<html>
<head>
<title>Spark Join Types Visualized</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可视化火花连接类型</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/spark-join-types-visualized-30d784068c8a?source=collection_archive---------4-----------------------#2021-07-23">https://medium.com/nerd-for-tech/spark-join-types-visualized-30d784068c8a?source=collection_archive---------4-----------------------#2021-07-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8fc2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi jd translated">oin是任何数据分析或整合过程中不可或缺的一部分。根据<strong class="ih hj"> <em class="jm">连接类型</em> </strong>，通过比较一个或多个列(读取键)以及连接条件将左、右两组数据集合在一起，以确定最终输出，该输出可以包含来自左、右或两者的数据。</p><p id="9109" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Apache Spark提供了以下连接类型，</p><ol class=""><li id="6056" class="jn jo hi ih b ii ij im in iq jp iu jq iy jr jc js jt ju jv bi translated"><strong class="ih hj">内部</strong>联接(左右数据集中关键字匹配的记录)</li><li id="1527" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><strong class="ih hj">外部</strong>连接(左或右数据集中关键字匹配的记录)</li><li id="bb80" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><strong class="ih hj">左外部</strong>连接(左数据集中带有键的记录)</li><li id="7650" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><strong class="ih hj">右外部</strong>连接(右数据集中带有键的记录)</li><li id="2217" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><strong class="ih hj">左半部</strong>连接(左数据集中的记录与右数据集中的匹配键)</li><li id="d70f" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><strong class="ih hj">左反</strong>联接(左数据集中的记录与右数据集中的键不匹配)</li><li id="a304" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><strong class="ih hj">自然</strong>连接(使用数据集之间的隐式列匹配完成)</li><li id="18cc" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><strong class="ih hj">交叉</strong>连接(左右数据集的笛卡尔乘积)</li></ol></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><p id="a296" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们创建一些数据来演示各种连接。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><p id="4606" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我已经创建了2个data frame(names df，typesDF ),可以使用'<strong class="ih hj"> Id </strong>'列将它们链接起来。这是它们的样子，</p><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es kp"><img src="../Images/6d322e9b382db82a71e1d92cc0e5aed9.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*7__KOhkO-ztoMNX50ekm-Q.png"/></div></figure><p id="7afa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我将更多地关注DataFrame APIs，因为SparkSQL的语法与任何其他SQL都相似。使用DataFrame APIs进行连接的语法是，</p><pre class="ki kj kk kl fd ks kt ku kv aw kw bi"><span id="b6bd" class="kx ky hi kt b fi kz la l lb lc">DataFrame1.join(DataFrame2, [on=keys], [how=joinType])</span></pre><p id="5b95" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jm">连接条件和连接类型可选。</em><strong class="ih hj"><em class="jm">data frame 1</em></strong><em class="jm">称为</em> <strong class="ih hj"> <em class="jm">左侧</em> </strong> <em class="jm">和</em><strong class="ih hj"><em class="jm">data frame 2</em></strong><em class="jm">称为</em> <strong class="ih hj"> <em class="jm">右侧</em> </strong></p><h1 id="8c57" class="ld ky hi bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">内部联接</h1><p id="1ba0" class="pw-post-body-paragraph if ig hi ih b ii ma ik il im mb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">这是默认连接，即如果没有提及连接类型，Spark将执行内部连接。只有那些左右两个数据集的键匹配的记录才会被提取到输出中。不存在于两个数据集中的关键字被忽略，即不显示/输出。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mf"><img src="../Images/62572f41c04083b56367b881bee27d75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*akN3WEIt8AecJnIcqd8hFg.jpeg"/></div></div></figure><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es mk"><img src="../Images/dc9b4b3d9723d94f80f84c6539351b99.png" data-original-src="https://miro.medium.com/v2/resize:fit:968/format:webp/1*8fV_5RpOTTujwDUmtvkaTA.png"/></div></figure><h1 id="9585" class="ld ky hi bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">外部联接也称为完全外部联接</h1><p id="39d6" class="pw-post-body-paragraph if ig hi ih b ii ma ik il im mb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">来自左侧和右侧数据集的记录都包括在输出中。在键与<strong class="ih hj">不匹配的地方，空值</strong>被插入。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es ml"><img src="../Images/bc9c893fb05e3765ee0ec050704bd2cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ftgP-j6Ywe6beMt0BqqFzA.jpeg"/></div></div></figure><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es mm"><img src="../Images/e45215eca8f21ca4f5ed87b6b513273d.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*8yXpp21l0p58jo4DrWfetQ.png"/></div></figure><h1 id="028b" class="ld ky hi bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">左连接也称为左外部连接</h1><p id="87e4" class="pw-post-body-paragraph if ig hi ih b ii ma ik il im mb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">左侧数据集中的所有记录都是输出的一部分。右数据集中的记录包含在匹配键的位置。对于剩余的<strong class="ih hj">，空值</strong>被插入。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mf"><img src="../Images/31de61c7e2de8115ae754e4bcfca8153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WGMkmg0p4HQRe6zgMaNFKA.jpeg"/></div></div></figure><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es mn"><img src="../Images/534e0adfc5ec8244d353ac250905f6c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1096/format:webp/1*3iaSClvu32HFQ0OpG5zd_g.png"/></div></figure><h1 id="df10" class="ld ky hi bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">右外部联接也称为右联接</h1><p id="a0a6" class="pw-post-body-paragraph if ig hi ih b ii ma ik il im mb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">右侧数据集中的所有记录都是输出的一部分。左侧数据集中的记录包含在匹配键的位置。剩余的空值被插入。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mo"><img src="../Images/63bfcc07ce1d08a8a71b5313fef5be5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HK-WNcCBI1HPveMEER5Rtg.jpeg"/></div></div></figure><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es mp"><img src="../Images/1dde2d4ec10060a5547479f418fc3c32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*uYyFgCe1Kli57IpFZtjPsw.png"/></div></figure><h1 id="c4dc" class="ld ky hi bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">左半连接</h1><p id="272a" class="pw-post-body-paragraph if ig hi ih b ii ma ik il im mb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">只有左侧数据集中的记录在右侧数据集中具有匹配键，才会被包括在内。如果左侧数据集有重复项，则输出将包含重复项。它可以被看作是一个过滤器，而不是一个连接。我们根据右边数据集中的匹配关键字过滤左边的数据集。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mq"><img src="../Images/2a83e82433e2ff6483e52056e66fbccc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XX9jRco6AC0qJxOLLFGvBQ.jpeg"/></div></div></figure><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es mr"><img src="../Images/9d63b53a475e894b66574c351121863b.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/format:webp/1*dlYjdcyGvs83jP7kc6NJXQ.png"/></div></figure><h1 id="85b0" class="ld ky hi bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">左反连接</h1><p id="79ab" class="pw-post-body-paragraph if ig hi ih b ii ma ik il im mb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">与左半连接相反。<br/>只有来自左侧数据集中的记录被包括在内，而这些记录在右侧数据集中没有匹配的关键字。类似于NOT IN SQL筛选器。</p><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es ms"><img src="../Images/f787bc88270e01c0da57432653c61293.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N5Aix4JO3hem6Lni1v-Ntg.jpeg"/></div></div></figure><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es mt"><img src="../Images/7499328360afe60dd0673de9e7bd8e9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/format:webp/1*DrLrC74Gs2aZuNyujKxvXA.png"/></div></figure><h1 id="4145" class="ld ky hi bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">自然连接</h1><p id="a061" class="pw-post-body-paragraph if ig hi ih b ii ma ik il im mb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">当使用自然连接时，Spark试图隐式地猜测要连接的列。隐式连接总是有风险的，因此应该谨慎使用这种连接。<em class="jm">此外，它仅在Spark SQL中可用，在DataFrame APIs中不可用。</em></p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><h1 id="7ce7" class="ld ky hi bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">交叉连接又名笛卡儿积</h1><p id="bcf4" class="pw-post-body-paragraph if ig hi ih b ii ma ik il im mb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">左侧数据集中的每条记录都连接到右侧数据集中的每条记录。这导致了爆炸🎆记录的🧨。如果我们交叉两个各有1000条记录的数据集，那么结果输出将是1000 * 1000 = 1，000，000条记录。这很容易导致OOM错误。<br/>但是可能存在这样一种有效的情况，即您想要生成两个数据集的每一种可能的组合。所以为了避免混淆，你可以使用<strong class="ih hj">交叉连接</strong>方法显式地调用它。</p><p id="f050" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="jm">注意:我认为作为预防措施，避免创建可能导致应用程序崩溃的笛卡尔乘积，低于3.x版本的Spark默认将交叉连接配置设置为False。您将得到如下所示的错误(在v2.4.4上检查)，它将要求您显式地将</em><strong class="ih hj"><em class="jm">spark . SQL . cross join . enabled</em></strong><em class="jm">设置设置为</em> <strong class="ih hj"> <em class="jm"> True。</em> </strong> <em class="jm">从v3.x开始，该设置默认设置为True。</em></p><pre class="ki kj kk kl fd ks kt ku kv aw kw bi"><span id="d6f9" class="kx ky hi kt b fi kz la l lb lc">pyspark.sql.utils.AnalysisException: 'Detected implicit cartesian product for INNER join between logical plans<br/>Join condition is missing or trivial.<br/>Either: use the CROSS JOIN syntax to allow cartesian products between these relations, <br/>or: enable implicit cartesian products by setting the configuration <br/>variable spark.sql.crossJoin.enabled=True;'</span></pre><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mu"><img src="../Images/7e292c0789eaaa43921ef13df2badff6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0zixLCyH5V-8B6PYsDvFOw.jpeg"/></div></div></figure><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es mv"><img src="../Images/4b94dbb9d64f7841c2ac167ef72af668.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*0GewFeaqonnMrjUvW_AmUg.png"/></div></figure><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es mw"><img src="../Images/58dc46a6659e76b18a902350abaf51f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hE2VL1rLZ3fnC5tQPLOPOQ.png"/></div></div></figure></div><div class="ab cl kb kc gp kd" role="separator"><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg kh"/><span class="ke bw bk kf kg"/></div><div class="hb hc hd he hf"><h1 id="c2e2" class="ld ky hi bd le lf mx lh li lj my ll lm ln mz lp lq lr na lt lu lv nb lx ly lz bi translated">笔记</h1><ol class=""><li id="c1c2" class="jn jo hi ih b ii ma im mb iq nc iu nd iy ne jc js jt ju jv bi translated">许多关于SQL连接的维恩图没有沟通的一件事是，如果在您的源中有重复，它们将会出现在您的连接输出中</li></ol><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div class="er es nf"><img src="../Images/eecd72013d2337387a6b8fe58153f866.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*Slld7pijyXEUqJS1iVFmRQ.png"/></div></figure><p id="afb3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.通常你连接的键不会包含空值。但是如果你想在空键上连接，那么你可以在连接条件中使用<strong class="ih hj"> eqNullSafe </strong>选项。</p><figure class="ki kj kk kl fd km"><div class="bz dy l di"><div class="kn ko l"/></div></figure><figure class="ki kj kk kl fd km er es paragraph-image"><div role="button" tabindex="0" class="mg mh di mi bf mj"><div class="er es ng"><img src="../Images/057c55baade159ccac080509c99c8a71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kiKt_k9xTOxW9pkOmXxAyA.png"/></div></div></figure><p id="f7e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您花时间阅读这篇文章。祝你愉快😃</p><h1 id="ec76" class="ld ky hi bd le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz bi translated">参考</h1><ol class=""><li id="3354" class="jn jo hi ih b ii ma im mb iq nc iu nd iy ne jc js jt ju jv bi translated"><a class="ae nh" href="https://spark.apache.org/docs/3.1.1/api/python/reference/api/pyspark.sql.DataFrame.join.html" rel="noopener ugc nofollow" target="_blank">火花文件</a></li><li id="2afe" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><a class="ae nh" href="https://stackoverflow.com/questions/41728762/including-null-values-in-an-apache-spark-join" rel="noopener ugc nofollow" target="_blank">堆栈溢出</a></li><li id="f5cf" class="jn jo hi ih b ii jw im jx iq jy iu jz iy ka jc js jt ju jv bi translated"><a class="ae nh" href="https://stackoverflow.com/questions/41728762/including-null-values-in-an-apache-spark-join" rel="noopener ugc nofollow" target="_blank"> Stackoverflow空安全检查</a></li></ol></div></div>    
</body>
</html>