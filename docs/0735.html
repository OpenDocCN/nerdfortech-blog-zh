<html>
<head>
<title>ESP32 Tensorflow micro speech with the external microphone</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带外置麦克风的ESP32 Tensorflow微型语音</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/esp32-tensorflow-micro-speech-with-the-external-microphone-92e9823ba86d?source=collection_archive---------9-----------------------#2021-02-09">https://medium.com/nerd-for-tech/esp32-tensorflow-micro-speech-with-the-external-microphone-92e9823ba86d?source=collection_archive---------9-----------------------#2021-02-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/5e9d4ab221faf972f0e2a3cc03a64388.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-BdJVOcjP6NQ0_51.png"/></div></div></figure><p id="b520" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本教程涵盖<strong class="is hj">如何将Tensorflow micro speech与ESP32 </strong>和外置麦克风I2S配合使用。换句话说，我们想要定制Tensorflow micro speech示例，以便它可以在使用I2S协议连接到外部麦克风的ESP32上运行。本例中，我们将使用连接到ESP32的INMP441来捕捉音频。虽然ESP32-EYE有内置麦克风，但如果我们想在ESP32上使用Tensorflow micro speech，我们需要一个支持I2S的外置麦克风。此外，在本教程中，我们将使用一个自定义模型，以便带有INMP441的ESP32不仅可以识别是或否单词，还可以识别其他单词。</p><h1 id="fd20" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">设置编译和运行Tensorflow micro speech的环境</h1><p id="d385" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在编译和执行微语音代码之前，需要安装和配置环境。</p><h1 id="42fc" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">安装和配置ESP-IDF</h1><p id="b57c" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">要安装ESP-IDF，您有两种不同的选择:</p><ul class=""><li id="6b67" class="kr ks hi is b it iu ix iy jb kt jf ku jj kv jn kw kx ky kz bi translated">遵循ESP-IDF指南进行安装。在这种情况下，你必须遵循这个<a class="ae la" href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/#get-started-get-prerequisites" rel="noopener ugc nofollow" target="_blank">指南</a>。</li><li id="45a6" class="kr ks hi is b it lb ix lc jb ld jf le jj lf jn kw kx ky kz bi translated">否则，您可以安装ESP-IDF作为PlatformIO插件，该插件将指导您完成所有步骤</li></ul><h1 id="c89e" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">克隆Tensorflow存储库</h1><p id="4833" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">下一步是克隆Tensorflow存储库，这样我们就可以修改Tensorflow微型语音代码，以支持I2S外置麦克风，在本例中为INMP441。要克隆存储库，您可以使用以下命令:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="d284" class="lp jp hi ll b fi lq lr l ls lt">git clone https://github.com/tensorflow/tensorflow.git</span></pre><p id="0930" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在你有了源代码，所以我们可以定制代码。在接下来的步骤中，我们将遵循Tensorflow <a class="ae la" href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/lite/micro/examples/micro_speech#deploy-to-esp32" rel="noopener ugc nofollow" target="_blank"> Github </a>中涵盖的步骤。</p><h1 id="f8d3" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">为ESP32准备Tensorflow微型演讲</h1><p id="6ad9" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">打开命令外壳并生成源代码:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="76aa" class="lp jp hi ll b fi lq lr l ls lt">make -f tensorflow/lite/micro/tools/make/Makefile TARGET=esp generate_micro_speech_esp_project</span></pre><p id="7550" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在移到以下目录下:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="55e4" class="lp jp hi ll b fi lq lr l ls lt">tensorflow/lite/micro/tools/make/gen/esp_xtensa-esp32_default/prj/micro_speech</span></pre><p id="7d2d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这是Tensorflow微型语音源代码，我们将对其进行修改，以使用带有I2S麦克风的ESP32。如Github中所述，为了支持外部麦克风，有必要修改类<code class="du lu lv lw ll b">audio_provider.cc</code>。</p><h1 id="e97d" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">如何将ESP32连接到I2S INMP411话筒</h1><p id="557f" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">现在我们可以将ESP332连接到I2S的INMP411:</p><p id="7069" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">ESP32引脚→inmp 411<br/>Vcc→Vdd<br/>GND→GND<br/>33→标清<br/> 26 → SCK <br/> 25 → WS</p><h1 id="8145" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">修改Tensorflow以支持外部麦克风</h1><p id="00af" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">是时候修改类<code class="du lu lv lw ll b">audio_provider.cc</code>来支持连接到ESP32的INMP411了。转到:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="8635" class="lp jp hi ll b fi lq lr l ls lt">micro_speech/esp-idf/main/esp</span></pre><p id="0f94" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">打开<code class="du lu lv lw ll b">audio_provider.cc</code>,通过添加以下几行来修改它:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="8c06" class="lp jp hi ll b fi lq lr l ls lt">// I2S Microphone PIN <br/>#define I2S_WS 25 <br/>#define I2S_SD 33 <br/>#define I2S_SCK 26</span></pre><p id="81a2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">查找以下行:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="4f3c" class="lp jp hi ll b fi lq lr l ls lt">i2s_pin_config_t pin_config = { <br/> .bck_io_num = 26, // IIS_SCLK <br/> .ws_io_num = 32, // IIS_LCLK <br/> .data_out_num = -1, // IIS_DSIN <br/> .data_in_num = 33, // IIS_DOUT <br/>};</span></pre><p id="dee2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并用以下代码行替换它们:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="1dbf" class="lp jp hi ll b fi lq lr l ls lt">i2s_pin_config_t pin_config = { <br/>  .bck_io_num = I2S_SCK, <br/>  .ws_io_num = I2S_WS, <br/>  .data_out_num = -1, <br/>  .data_in_num = I2S_SD <br/>};</span></pre><p id="5ae0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已。我们现在可以将ESP32 Tensorflow micro speech与外置麦克风INMP411配合使用。</p><h1 id="5f30" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">在ESP32上测试微语音代码</h1><p id="dfe0" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">我们现在可以使用以下命令编译并运行代码:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="382b" class="lp jp hi ll b fi lq lr l ls lt">idf.py build idf.py -p /dev/tty.SLAB_USBtoUART flash idf.py --port /dev/tty.SLAB_USBtoUART monitor</span></pre><p id="9c4c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将端口更换为您电脑中使用的端口。现在，您可以说出是或否，并使用Tensorflow和ESP32测试语音识别。</p><p id="cafd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">更多资源</strong>:</p><p id="fad8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae la" href="https://www.survivingwithandroid.com/esp32-machine-learning-knn-classifier-tcs3200/" rel="noopener ugc nofollow" target="_blank">如何配合KNN使用ESP32识别物体</a> <br/> <a class="ae la" href="https://www.survivingwithandroid.com/run-tensorflow-lite-esp32-platformio/" rel="noopener ugc nofollow" target="_blank">如何使用PlatformIO </a> <br/> <a class="ae la" href="https://www.survivingwithandroid.com/esp32-cam-object-detection-tensorflow-js/" rel="noopener ugc nofollow" target="_blank">在ESP32上编译运行Tensorflow如何使用ESP32-CAM和Tensorflow.js识别物体</a></p><h1 id="3f97" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">如何通过ESP32 Tensorflow micro speech使用自定义模型</h1><p id="6081" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">如果你喜欢使用自定义模型，你必须建立自己的模型并训练它。为此，您可以使用这个<a class="ae la" href="https://colab.research.google.com/github/tensorflow/tensorflow/blob/master/tensorflow/lite/micro/examples/micro_speech/train/train_micro_speech_model.ipynb" rel="noopener ugc nofollow" target="_blank"> colab代码</a>。我们在过去训练了一个模型，它能够识别四个不同的单词:</p><ul class=""><li id="7c6f" class="kr ks hi is b it iu ix iy jb kt jf ku jj kv jn kw kx ky kz bi translated">去</li><li id="cb16" class="kr ks hi is b it lb ix lc jb ld jf le jj lf jn kw kx ky kz bi translated">停止</li><li id="d490" class="kr ks hi is b it lb ix lc jb ld jf le jj lf jn kw kx ky kz bi translated">左边的</li><li id="ef9e" class="kr ks hi is b it lb ix lc jb ld jf le jj lf jn kw kx ky kz bi translated">正确</li></ul><p id="cf77" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你想知道如何做到这一点，你可以阅读我的教程涵盖<a class="ae la" href="https://www.survivingwithandroid.com/arduino-machine-learning-edge-impulse-keywords-detection/" rel="noopener ugc nofollow" target="_blank">如何使用与Arduino Nano 33 BLE</a>tensor flow。在本教程中，我们简单地将这个自定义Tensorflow lite模型与ESP32一起使用。打开文件<code class="du lu lv lw ll b">micro_model_settings.cc</code>,用以下几行替换内容:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="2d35" class="lp jp hi ll b fi lq lr l ls lt">#include "micro_model_settings.h"  <br/>const char* kCategoryLabels[kCategoryCount] = {     <br/>  "silence",    <br/>  "unknown",    <br/>  "go",    <br/>  "stop",     <br/>  "left",     <br/>  "right", <br/>};</span></pre><p id="7f26" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，打开文件<code class="du lu lv lw ll b">micro_model_settings.h</code>,寻找下面一行:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="4fee" class="lp jp hi ll b fi lq lr l ls lt">constexpr int kCategoryCount</span></pre><p id="df93" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">并替换为:</p><pre class="lg lh li lj fd lk ll lm ln aw lo bi"><span id="ce2d" class="lp jp hi ll b fi lq lr l ls lt">constexpr int kCategoryCount = 6;</span></pre><p id="834e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后把这个<a class="ae la" href="https://github.com/survivingwithandroid/Arduino-Machine-Learning/blob/master/model.cc" rel="noopener ugc nofollow" target="_blank">文件</a>的内容复制到<code class="du lu lv lw ll b">model.cc.</code></p><p id="f662" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已。重新编译代码并运行它。现在你的ESP32可以识别四个不同的单词。</p><h1 id="bd82" class="jo jp hi bd jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl bi translated">包扎</h1><p id="9e4e" class="pw-post-body-paragraph iq ir hi is b it km iv iw ix kn iz ja jb ko jd je jf kp jh ji jj kq jl jm jn hb bi translated">在这篇文章的最后，我们已经介绍了如何使用ESP32 Tensorflow micro speech。我们已经了解了如何使用ESP32 Tensorflow micro speech支持外部麦克风。此外，我们还扩展了ESP32示例，使用定制的Tensorflow lite模型，以便带有I2S INMP411的ESP32可以识别几个单词。您可以开发您的自定义Tensorflow模型以在您的ESP32上运行。</p></div><div class="ab cl lx ly gp lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="hb hc hd he hf"><p id="d177" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="me">原载于2021年2月9日</em><a class="ae la" href="https://www.survivingwithandroid.com/esp32-tensorflow-micro-speech-i2s-external-microphone/" rel="noopener ugc nofollow" target="_blank"><em class="me">【https://www.survivingwithandroid.com】</em></a><em class="me">。</em></p></div></div>    
</body>
</html>