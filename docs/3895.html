<html>
<head>
<title>A funny thing happened on the way to Rust</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">生锈的路上发生了一件有趣的事</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/a-funny-thing-happened-on-the-way-to-rust-75379c74e99a?source=collection_archive---------5-----------------------#2021-06-28">https://medium.com/nerd-for-tech/a-funny-thing-happened-on-the-way-to-rust-75379c74e99a?source=collection_archive---------5-----------------------#2021-06-28</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/2afe7fc15e49a9e9d705cbd0a3e0419a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/0*cCbUgWOlwNM6RWUD"/></div></figure><p id="7243" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我最近开始花时间学习Rust，因为它有很多我想要的Dart之外的语言的特性。对我来说，Rust提供了一种编译到本机的语言，也可以在没有大型标准库/运行时的情况下使用，支持简洁的二进制文件，并能够在“裸机”环境中运行，既可以在大型设备上运行，如Raspberry Pi，也可以在更小的微控制器上运行，如ARM cortex-M和ESP32等。它也是一种现代语言，具有函数特性、不可变数据、没有GC的良好内存管理，同样重要的是，它不是极其复杂的C++。除此之外，它还使得与现有C库的互操作变得容易，并且同样允许容易地创建公开C APIs的库。最后，易于交叉编译、丰富的包生态系统和优秀的工具是程序员学习和使用的非常有吸引力的选择。</p><p id="942d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然而，尽管如此，Rust并不是一门容易掌握并开始使用的语言，所以我很惊喜地偶然发现了另一种与Rust类似的新语言<a class="ae jk" href="https://vlang.io/" rel="noopener ugc nofollow" target="_blank">叫做“V”</a>。</p><p id="bc3c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然而，与Rust不同，我能够在一个小时左右的时间里学会使用V的核心概念，这似乎是该语言的主要目标之一。它实际上让我想起了Dart，它的目标是让已经知道另一种类似C语言的程序员变得容易和熟悉。</p><h1 id="e8e5" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">安装和使用V</h1><p id="c2db" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">V的另一个关键卖点是它简单的安装方法和极快的编译时间。这种说法至少被证明是正确的，按照它的<a class="ae jk" href="https://github.com/vlang/v/blob/master/doc/docs.md#linux-macos-freebsd-etc" rel="noopener ugc nofollow" target="_blank"> Linux安装指令</a>在Debian上安装它是非常容易的，我发现V使用自己的单个C文件实现来启动自己的编译器给我留下了非常深刻的印象。</p><p id="89cf" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">编写hello world示例非常简单，V工具提供了搭建新项目的功能、在工作时运行代码的简单命令等，Dart程序员(甚至Node、Deno、Rust用户等)也会非常熟悉这些功能，并期望将其作为标准。</p><h1 id="8a3b" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">FFI或半身像</h1><p id="085a" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">在学习了这门语言的基础知识之后，我决定尝试快速创建一个简单的动态库，我可以通过FFI从Dart应用程序中调用它。</p><p id="1d7a" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">正是在这一点上，我碰到了V的一个粗糙的边缘，仍然是一个相当新的语言和小项目。文档中没有提到如何创建动态库，甚至在v tooling帮助中也没有。我最终找到了<a class="ae jk" href="https://github.com/vlang/v/issues/2379" rel="noopener ugc nofollow" target="_blank">一个GitHub问题</a>，它碰巧有所需的信息，你需要执行以下命令:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="e126" class="kx jm hi kt b fi ky kz l la lb">v -shared -prod fib.v</span></pre><p id="3611" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">那期杂志还评价了V为其C abi函数命名所使用的相当“简单”的名称处理方案，以及V中现在可用的新功能，即使用V所谓的函数属性来设置函数的C ABI名称:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="3baa" class="kx jm hi kt b fi ky kz l la lb">[export: 'fibv'] pub fn fib(n int) int { ...</span></pre><p id="bfe3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">从Dart调用该函数就是标准的Dart FFI机制:</p><pre class="ko kp kq kr fd ks kt ku kv aw kw bi"><span id="a1bc" class="kx jm hi kt b fi ky kz l la lb">import 'dart:ffi'; </span><span id="726e" class="kx jm hi kt b fi lc kz l la lb">// Fib function from V <br/>typedef FibFunc = Int32 Function(Int32 a); typedef Fib = int Function(int a); </span><span id="642b" class="kx jm hi kt b fi lc kz l la lb">void main() async { // expect this being run from same dir that contains the dyn shared-lib file </span><span id="a0ec" class="kx jm hi kt b fi lc kz l la lb">  final dylib = DynamicLibrary.open('./fibrec.so');<!-- --> </span><span id="46df" class="kx jm hi kt b fi lc kz l la lb">  final fibPointer = dylib.lookup&lt;NativeFunction&lt;FibFunc&gt;&gt;('fibv');     <br/>  final fib = fibPointer.asFunction&lt;Fib&gt;(); <br/>  print('Fib 7 = ${fib(7)}'); <br/>}</span></pre><p id="2df3" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">包含上述代码样本的完整示例可以在<a class="ae jk" href="https://github.com/maks/v_dart_ffi_example" rel="noopener ugc nofollow" target="_blank"> my github repo </a>中找到。</p><h1 id="6f04" class="jl jm hi bd jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki bi translated">没有独角兽</h1><p id="296d" class="pw-post-body-paragraph im in hi io b ip kj ir is it kk iv iw ix kl iz ja jb km jd je jf kn jh ji jj hb bi translated">和所有的语言和技术一样，使用V也有很多缺点和优点。虽然它很简单，并且有很好的文档记录，但是我还是设法在编译器文档中找到了使用V的漏洞。也因为它相对较新，社区和生态系统才刚刚开始发展，所以，例如，虽然有一个跨平台音频库的绑定，但它本身非常不成熟，非常不完整(没有音频输入)，对我当前项目所需的其他东西的支持，如Midi和有机发光二极管I2C显示器，是不存在的。</p><p id="68aa" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">另一个问题是，虽然V很自豪它生成的二进制文件比同类语言Go(和Dart)的要小得多，但它似乎仍然需要一个相当大的标准库/运行时来包含在它的二进制文件中。即使使用了<code class="du ld le lf kt b">-prod</code>标志，我发现我的几乎像hello-world一样的代码产生了一个大约300kb的共享动态库，一个大约100kb的可执行文件。虽然这些非常小，但它们远没有达到使用其<code class="du ld le lf kt b">#![no_std]</code>时Rust可能产生的微小尺寸，在使用小型微控制器时，即使几kb也是至关重要的。</p><p id="a1d0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以最后我会用V代替Rust吗？嗯，没有。</p><p id="0a28" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">虽然我对V印象非常深刻，并将在未来继续检查它的进展，但需要为ARM和嵌入式设备提供成熟且经过充分测试的交叉编译工具链，以及Rust现在拥有的巨大社区和软件包生态系统，这意味着尽管V的简单性有巨大的吸引力，但目前我仍在学习Rust，并计划在桌面、移动、wasm和嵌入式微控制器的许多未来项目中使用它。</p><p id="b400" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">如果您有兴趣阅读更多关于Dart FFI、在Flutter应用程序中使用FFI或在使用和不使用Dart的情况下使用Rust的信息，请关注我，了解我即将发布的新文章！</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><p id="7a84" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="ln">最初发表于</em><a class="ae jk" href="https://manichord.com/blog/posts/on-way-to-rust.html" rel="noopener ugc nofollow" target="_blank"><em class="ln">【https://manichord.com】</em></a><em class="ln">。</em></p></div></div>    
</body>
</html>