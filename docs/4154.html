<html>
<head>
<title>Setting up a secure reverse proxy with Nginx, certbot and Docker on ARM devices.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在 ARM 设备上使用 Nginx、certbot 和 Docker 设置安全反向代理。</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/setting-up-a-secure-reverse-proxy-with-nginx-certbot-and-docker-on-arm-devices-6a7bd50c92b2?source=collection_archive---------1-----------------------#2021-07-09">https://medium.com/nerd-for-tech/setting-up-a-secure-reverse-proxy-with-nginx-certbot-and-docker-on-arm-devices-6a7bd50c92b2?source=collection_archive---------1-----------------------#2021-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="c5cc" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">一个简单而完整的指南，介绍如何设置您的 ARM 设备作为一个完全安全的反向代理。</h2></div><p id="ecd9" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最近在我的 Raspberry Pi 设备上安装了<a class="ae jt" href="https://www.home-assistant.io/" rel="noopener ugc nofollow" target="_blank">家庭助手</a>的容器版本，这是一个流行的家庭自动化工具，我希望能够从互联网访问它。对于那些熟悉它的人来说，“监督”版本的配置非常简单，因为它提供了许多插件来无缝设置 nginx、动态 dns 甚至 wireguard vpn 服务器。但是对于它的其他版本，你几乎需要手动完成所有的事情，所以我决定划分责任，在不同的设备上自己配置所有的东西。</p><p id="73e2" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">因此，让我们看看如何用两个 docker 容器配置我们的设备，一个用于 nginx，一个用于 certbot，以启动和运行我们的 https 服务器。</p><h1 id="4b18" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">要求</h1><ul class=""><li id="920b" class="km kn hi iz b ja ko jd kp jg kq jk kr jo ks js kt ku kv kw bi translated">本指南假设您的设备上已经安装了 Docker 并且功能齐全。</li><li id="ce4f" class="km kn hi iz b ja kx jd ky jg kz jk la jo lb js kt ku kv kw bi translated">您应该已经订阅了动态 dns 服务，最后但同样重要的是，您的路由器应该已经正确配置为转发端口 80 和 443。</li><li id="14db" class="km kn hi iz b ja kx jd ky jg kz jk la jo lb js kt ku kv kw bi translated">熟悉 Nginx 者优先:)</li></ul><h2 id="458b" class="lc jv hi bd jw ld le lf ka lg lh li ke jg lj lk kg jk ll lm ki jo ln lo kk lp bi translated">文件夹配置</h2><p id="f698" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">首先，我们需要在 docker 主机上创建一些文件夹，以存储一些配置和 certbot 证书。此外，由于我们想要使用 2 个 docker 容器，我们还需要在容器之间共享这些证书。</p><blockquote class="lt lu lv"><p id="493d" class="ix iy lw iz b ja jb ij jc jd je im jf lx jh ji jj ly jl jm jn lz jp jq jr js hb bi translated">请注意:我假设你的 arm 设备是基于 linux 的，所以你实际上可以复制粘贴下面的命令，它们将会工作并以你的用户名创建文件夹</p></blockquote><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="31b8" class="lc jv hi mf b fi mj mk l ml mm">$ mkdir -p /etc/letsencrypt<br/>$ mkdir -p /nfs/$USER/nginx/www/letsencrypt/.well-known/acme-challenge</span></pre><p id="0d7d" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一个文件夹是我们存储证书的地方，第二个文件夹有双重功能:它在/nfs/$USER 下创建一个 nginx 文件夹来存储配置，同时创建一个 acme-challenge 文件夹供 certbot 使用。</p><h2 id="ef93" class="lc jv hi bd jw ld le lf ka lg lh li ke jg lj lk kg jk ll lm ki jo ln lo kk lp bi translated">安装 Nginx</h2><p id="8852" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">现在我们需要启动 nginx 并服务于一个<strong class="iz hj"> http </strong>位置来完成<em class="lw"> acme-challenge。</em></p><p id="9c89" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">用以下内容创建一个<em class="lw"> proxy.conf </em>文件:</p><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="afd9" class="lc jv hi mf b fi mj mk l ml mm">server {<br/> listen 80;<br/> server_name mycustomserver.anydyndns.org;</span><span id="707f" class="lc jv hi mf b fi mn mk l ml mm">location ^~ /.well-known/acme-challenge/ {<br/> allow all;<br/> root /var/www/letsencrypt;<br/> default_type “text/plain”;<br/> }<br/>}</span></pre><p id="127b" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">并将其放入/nfs/$USER/nginx 文件夹中。</p><blockquote class="lt lu lv"><p id="a86e" class="ix iy lw iz b ja jb ij jc jd je im jf lx jh ji jj ly jl jm jn lz jp jq jr js hb bi translated">请注意:您需要更改的唯一部分是 server_name，以及您选择的 dyndns 名称。</p></blockquote><p id="f195" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">现在我们准备启动我们的容器:</p><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="dcb4" class="lc jv hi mf b fi mj mk l ml mm">docker run --name nginx -d -p 7070:80 -p 7443:443 --restart always \<br/> -v /nfs/$USER/nginx/proxy.conf:/etc/nginx/conf.d/default.conf \<br/> -v /nfs/$USER/nginx/www/:/var/www/ \<br/> -v /etc/letsencrypt:/etc/letsencrypt nginx</span></pre><ul class=""><li id="8971" class="km kn hi iz b ja jb jd je jg mo jk mp jo mq js kt ku kv kw bi translated">“proxy.conf”文件完全取代了 default.conf(我不需要服务任何其他 http 位置，只需要 acme challenge 所需的位置)</li><li id="47d1" class="km kn hi iz b ja kx jd ky jg kz jk la jo lb js kt ku kv kw bi translated">我们将 www 文件夹本地绑定到先前创建的文件夹</li><li id="12aa" class="km kn hi iz b ja kx jd ky jg kz jk la jo lb js kt ku kv kw bi translated">我们绑定了 letsencrypt 证书文件夹，以便以后与 certbot 共享</li><li id="5906" class="km kn hi iz b ja kx jd ky jg kz jk la jo lb js kt ku kv kw bi translated">我分别在 7080 和 7443 上重新映射了端口 80 和 443，但是可以根据您的需要随意更改。</li></ul><blockquote class="lt lu lv"><p id="9067" class="ix iy lw iz b ja jb ij jc jd je im jf lx jh ji jj ly jl jm jn lz jp jq jr js hb bi translated"><strong class="iz hj">提示</strong>:如果你愿意，你可以通过在 acme-challenge 文件夹中添加一个包含任何内容的【test.html】文件并在<a class="ae jt" href="http://mycustomserver.anydyndns.org" rel="noopener ugc nofollow" target="_blank">http://mycustomserver.anydyndns.org</a>打开一个浏览器来测试 nginx 是否工作。如果一切正常，您应该会看到文件的内容。</p></blockquote><h2 id="d77f" class="lc jv hi bd jw ld le lf ka lg lh li ke jg lj lk kg jk ll lm ki jo ln lo kk lp bi translated">使用 Certbot 生成证书</h2><p id="599a" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">现在我们需要用 letsencrypt 生成证书。让我们运行 certbot:</p><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="ec01" class="lc jv hi mf b fi mj mk l ml mm">docker run -it --name certbot \<br/> -v "/etc/letsencrypt:/etc/letsencrypt" \<br/> -v "/nfs/$USER/nginx/www/letsencrypt/:/webroot/" \<br/> certbot/certbot:arm32v6-latest certonly \<br/> -d mycustomserver.anyddns.org --verbose --keep-until-expiring \<br/> --agree-tos --email <a class="ae jt" href="mailto:m.arciprete@gmail.com" rel="noopener ugc nofollow" target="_blank">myemail@provider.com</a> \<br/> --preferred-challenges=http \<br/> --webroot --webroot-path=/webroot</span></pre><p id="a2ab" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在本例中，我们为 certbot 创建了一个容器，它:</p><ul class=""><li id="f60c" class="km kn hi iz b ja jb jd je jg mo jk mp jo mq js kt ku kv kw bi translated">使用共享的/etc/letsencrypt 文件夹</li><li id="3950" class="km kn hi iz b ja kx jd ky jg kz jk la jo lb js kt ku kv kw bi translated">与 nginx 共享“acme-challenge”文件夹，存储挑战并通过 http 提供服务</li><li id="0769" class="km kn hi iz b ja kx jd ky jg kz jk la jo lb js kt ku kv kw bi translated">使用 arm32 版本的图像</li></ul><blockquote class="lt lu lv"><p id="84ca" class="ix iy lw iz b ja jb ij jc jd je im jf lx jh ji jj ly jl jm jn lz jp jq jr js hb bi translated">请注意:我们将所有参数都传递给了命令行，因为我们希望使用同一个容器在证书过期时自动更新证书。只是记得用你的动态域名和电子邮件来替换 mycustomserver.anyddns.org。</p></blockquote><p id="51ab" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果 certbot 正常工作，您应该会收到如下消息:</p><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="4a03" class="lc jv hi mf b fi mj mk l ml mm">Requesting a certificate for mycustomserver.anydyndns.org</span><span id="35d5" class="lc jv hi mf b fi mn mk l ml mm">Successfully received certificate.<br/>Certificate is saved at: /etc/letsencrypt/live/mycustomserver.anydyndns.org/fullchain.pem<br/>Key is saved at:         /etc/letsencrypt/live/mycustomserver.anydyndns.org/privkey.pem</span></pre><p id="d69f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">是时候完成 nginx 的配置了，创建一个 https 服务器。</p><h2 id="3546" class="lc jv hi bd jw ld le lf ka lg lh li ke jg lj lk kg jk ll lm ki jo ln lo kk lp bi translated">将 Nginx 更新为代理 https 请求</h2><p id="d9d0" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">让我们打开我们的<em class="lw"> proxy.conf </em>文件，并添加以下内容:</p><ol class=""><li id="70e8" class="km kn hi iz b ja jb jd je jg mo jk mp jo mq js mr ku kv kw bi translated">添加/位置，并重定向到 https</li><li id="85ec" class="km kn hi iz b ja kx jd ky jg kz jk la jo lb js mr ku kv kw bi translated">设置 https 部件为您的新位置服务(在我的例子中是 HomeAssistant)</li></ol><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="0ec3" class="lc jv hi mf b fi mj mk l ml mm">map $http_upgrade $connection_upgrade {<br/>    default upgrade;<br/>    ''      close;<br/>}</span><span id="f26b" class="lc jv hi mf b fi mn mk l ml mm">server {<br/>   listen 80;<br/>   location / {<br/>        return 301 <a class="ae jt" href="https://$host$request_uri" rel="noopener ugc nofollow" target="_blank">https://$host$request_uri</a>;<br/>   }</span><span id="d1c2" class="lc jv hi mf b fi mn mk l ml mm">location ^~ /.well-known/acme-challenge/ {<br/>        allow all;<br/>        root /var/www/letsencrypt;<br/>        default_type "text/plain";<br/>   }<br/>}</span><span id="ebaa" class="lc jv hi mf b fi mn mk l ml mm">server {</span><span id="388e" class="lc jv hi mf b fi mn mk l ml mm">    <!-- -->listen 443 ssl default_server ipv6only=off;<br/>    server_name <!-- -->mycustomserver.anydyndns.org<!-- -->;</span><span id="76e4" class="lc jv hi mf b fi mn mk l ml mm">    ssl_certificate  /e<!-- -->tc/letsencrypt/live/mycustomserver.anydyndns.org/fullchain.pem<!-- -->;<br/>    ssl_certificate_key  <!-- -->/etc/letsencrypt/live/mycustomserver.anydyndns.org/privkey.pem<!-- -->;</span><span id="a0a1" class="lc jv hi mf b fi mn mk l ml mm">    <!-- -->ssl_protocols TLSv1.2;                                                     <br/>    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";<br/>    ssl_prefer_server_ciphers on;                                            <br/>    ssl_session_cache shared:SSL:10m;                                                                       <br/>                                                              <br/>    proxy_buffering off;</span><span id="9df4" class="lc jv hi mf b fi mn mk l ml mm">access_log            /var/log/nginx/access.log;</span><span id="dd4a" class="lc jv hi mf b fi mn mk l ml mm">    location / {<br/>      proxy_pass              http://localhost:8080;                      <br/>      proxy_set_header        Host $host;<br/>      proxy_set_header        X-Real-IP $remote_addr;<br/>      proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;<br/>      proxy_set_header        X-Forwarded-Proto $scheme;<br/>      proxy_read_timeout  90;<br/>      <!-- -->proxy_set_header Upgrade $http_upgrade;                                                             <br/>      proxy_set_header Connection $connection_upgrade;<br/>    }<br/>  }</span></pre><p id="a797" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">proxy_pass 应该包含您想要到达的服务器的地址，例如<a class="ae jt" href="http://homeassistant.local:8123" rel="noopener ugc nofollow" target="_blank">http://home assistant . local:8123</a>或您想要的任何内容。</p><blockquote class="lt lu lv"><p id="ede7" class="ix iy lw iz b ja jb ij jc jd je im jf lx jh ji jj ly jl jm jn lz jp jq jr js hb bi translated">请注意:我还添加了升级和连接头，以及 nginx 中的“map”部分。只有当你打算像 HomeAssistant 那样使用 Websocket 时，才需要这样做。</p></blockquote><h1 id="e689" class="ju jv hi bd jw jx jy jz ka kb kc kd ke io kf ip kg ir kh is ki iu kj iv kk kl bi translated">证书的自动更新</h1><p id="d320" class="pw-post-body-paragraph ix iy hi iz b ja ko ij jc jd kp im jf jg lq ji jj jk lr jm jn jo ls jq jr js hb bi translated">Letsencrypt 证书将在 90 天后过期。为了自动更新它们，我使用一个 cron 任务来调用 certbot 容器，然后重新加载 nginx 来激活更改。如果您注意到了，certbot 容器是用“保留到过期”标志创建的，所以证书实际上只在需要时才更新。</p><p id="21cd" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">首先，我们通过输入以下命令编辑 crontab</p><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="7549" class="lc jv hi mf b fi mj mk l ml mm">$ crontab -e</span></pre><p id="9b3f" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">添加以下几行:</p><pre class="ma mb mc md fd me mf mg mh aw mi bi"><span id="f0a2" class="lc jv hi mf b fi mj mk l ml mm">30 2 * * * docker start certbot<br/>35 2 * * * docker exec nginx nginx -s reload</span></pre><p id="5c70" class="pw-post-body-paragraph ix iy hi iz b ja jb ij jc jd je im jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这指示 crontab 在每晚凌晨 2:30 运行“docker start certbot ”,然后在 5 分钟后的 2.35 重新加载 nginx 配置，以确保 certbot 过程完成。</p></div></div>    
</body>
</html>