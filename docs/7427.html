<html>
<head>
<title>weakref module in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python 中的 weakref 模块</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/weakref-module-in-python-35e105cd5033?source=collection_archive---------2-----------------------#2022-10-24">https://medium.com/nerd-for-tech/weakref-module-in-python-35e105cd5033?source=collection_archive---------2-----------------------#2022-10-24</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/9725573e8abe145d81545c770081405b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*_mXJnS1Ov8nrcXlqQjAXCw.jpeg"/></div><figcaption class="im in et er es io ip bd b be z dx translated">照片由<a class="ae iq" href="https://unsplash.com/@fakurian?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Milad Fakurian </a>在<a class="ae iq" href="https://unsplash.com/s/photos/shadow?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</figcaption></figure><p id="d0f5" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">自从我写了上一篇文章，已经有一段时间了，确切地说是两个月零两周。事不宜迟，我在写关于 Python 中的<code class="du jp jq jr js b">weakref</code>模块。让我们开始吧。</p><p id="1739" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">该模块允许 Python 程序员创建对对象的弱引用。弱引用是不保护对象不被垃圾回收的引用。</p><p id="fa8c" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我们知道，Python 使用引用计数机制进行<a class="ae iq" rel="noopener" href="/analytics-vidhya/memory-management-in-python-4332fbf95cd0">垃圾收集</a>，当存在强引用时，引用计数会增加。让我们看一个例子:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="74f7" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">运行文件<code class="du jp jq jr js b">python weak-ref-eg-0.py</code>时，输出是:</p><pre class="ju jv jw jx fd ka js kb kc aw kd bi"><span id="bb94" class="ke kf hi js b fi kg kh l ki kj">Reference count for yobj: 1<br/>Reference count of w_yobj is 1<br/>Reference count for yobj: 2</span></pre><p id="3b71" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我们看到，只有在行号为<code class="du jp jq jr js b">21</code>的行中存在强引用时，引用计数才会增加。</p><p id="7aac" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我们可以对这个程序进行更多的扩展，删除具有强引用的对象，并看到引用计数的减少。清理完对象后，如果我们调用弱引用对象<code class="du jp jq jr js b">w_yobj</code>，它将返回<code class="du jp jq jr js b">None</code>。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="7bae" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">输出是:</p><pre class="ju jv jw jx fd ka js kb kc aw kd bi"><span id="1bca" class="ke kf hi js b fi kg kh l ki kj">Reference count for yobj: 1<br/>Reference count of w_yobj: 1<br/>Reference count for yobj: 2</span><span id="9193" class="ke kf hi js b fi kk kh l ki kj">Cleaning...</span><span id="fd63" class="ke kf hi js b fi kk kh l ki kj">After deleting yobj_2, reference count for yobj: 1</span><span id="69d7" class="ke kf hi js b fi kk kh l ki kj">calling weakref object, w_yobj, after deleting both objects...<br/>Weak ref: None</span></pre><p id="81c0" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">weakref 为什么用于？非常好的问题。它用于</p><ol class=""><li id="2e02" class="kl km hi it b iu iv iy iz jc kn jg ko jk kp jo kq kr ks kt bi translated">在缓存或映射中，您持有的对象是昂贵的，并且您不希望它们仅仅因为在映射或缓存中就处于活动状态。</li></ol><p id="1281" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">2.为了使处理循环引用更容易。</p><p id="eeae" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">让我们看一个映射的例子:</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="126b" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">运行该文件时，输出是:</p><pre class="ju jv jw jx fd ka js kb kc aw kd bi"><span id="3e0c" class="ke kf hi js b fi kg kh l ki kj">cache type: &lt;class 'dict'&gt;<br/>reference count after initialization gem opal: 1<br/>reference count after caching gem opal: 2<br/>reference count after appending to list gem opal: 3</span><span id="c900" class="ke kf hi js b fi kk kh l ki kj">reference count after initialization gem ruby: 1<br/>reference count after caching gem ruby: 2<br/>reference count after appending to list gem ruby: 3</span><span id="fa41" class="ke kf hi js b fi kk kh l ki kj">reference count after initialization gem fluorite: 1<br/>reference count after caching gem fluorite: 2<br/>reference count after appending to list gem fluorite: 3</span><span id="dbbd" class="ke kf hi js b fi kk kh l ki kj">List length: 3, contents: [PriceyObject(opal), PriceyObject(ruby), PriceyObject(fluorite)]</span><span id="10ff" class="ke kf hi js b fi kk kh l ki kj">cleaning list...</span><span id="27b6" class="ke kf hi js b fi kk kh l ki kj">After cleaning list, cache contains: dict_keys(['opal', 'ruby', 'fluorite'])</span><span id="a5dc" class="ke kf hi js b fi kk kh l ki kj">opal=PriceyObject(opal)<br/>ruby=PriceyObject(ruby)<br/>fluorite=PriceyObject(fluorite)</span><span id="ac1d" class="ke kf hi js b fi kk kh l ki kj">demo returning</span><span id="2f60" class="ke kf hi js b fi kk kh l ki kj">Deleting PriceyObject(opal)<br/>Deleting PriceyObject(ruby)<br/>Deleting PriceyObject(fluorite)</span><span id="8a88" class="ke kf hi js b fi kk kh l ki kj">cache type: &lt;class 'weakref.WeakValueDictionary'&gt;<br/>reference count after initialization gem opal: 1<br/>reference count after caching gem opal: 1<br/>reference count after appending to list gem opal: 2</span><span id="068d" class="ke kf hi js b fi kk kh l ki kj">reference count after initialization gem ruby: 1<br/>reference count after caching gem ruby: 1<br/>reference count after appending to list gem ruby: 2</span><span id="60ba" class="ke kf hi js b fi kk kh l ki kj">reference count after initialization gem fluorite: 1<br/>reference count after caching gem fluorite: 1<br/>reference count after appending to list gem fluorite: 2</span><span id="6346" class="ke kf hi js b fi kk kh l ki kj">List length: 3, contents: [PriceyObject(opal), PriceyObject(ruby), PriceyObject(fluorite)]</span><span id="6139" class="ke kf hi js b fi kk kh l ki kj">cleaning list...</span><span id="4926" class="ke kf hi js b fi kk kh l ki kj">Deleting PriceyObject(fluorite)<br/>Deleting PriceyObject(ruby)<br/>Deleting PriceyObject(opal)</span><span id="8c29" class="ke kf hi js b fi kk kh l ki kj">After cleaning, cache contains: &lt;generator object WeakValueDictionary.keys at 0x7f8a700addd0&gt;</span><span id="b988" class="ke kf hi js b fi kk kh l ki kj">demo returning</span></pre><p id="7af1" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">标准<code class="du jp jq jr js b">dict</code>和<code class="du jp jq jr js b">weakref</code>模块的<code class="du jp jq jr js b">WeakValueDictionary</code>的区别在于，在删除包含强引用 gem 对象的列表时，<code class="du jp jq jr js b">WeakValueDictionary</code>不包含对 gems 对象的引用。而标准字典仍然有引用，并且能够对它们进行迭代。</p><p id="a822" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">现在让我们来看一个处理循环引用的例子。</p><p id="4612" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我从关于对称表亲关系的<a class="ae iq" rel="noopener" href="/analytics-vidhya/memory-management-in-python-4332fbf95cd0">内存管理</a>文章中提取了一个例子，这里是猫的系谱。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="f360" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">输出是:</p><pre class="ju jv jw jx fd ka js kb kc aw kd bi"><span id="e888" class="ke kf hi js b fi kg kh l ki kj">servy's refcount: 2<br/>whiky's refcount: 2</span><span id="7e36" class="ke kf hi js b fi kk kh l ki kj">AFTER DELETION OF servy<br/>whiky's refcount: 2</span><span id="5dbc" class="ke kf hi js b fi kk kh l ki kj">AFTER ASSIGNING whiky's cousin to be None<br/>whiky's refcount: 1</span></pre><p id="5eee" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我们看到了导致内存泄漏的循环引用，因为在删除了<code class="du jp jq jr js b">servy</code>对象后,<code class="du jp jq jr js b">whiky</code>对象的引用计数仍然为 2。我们通过手动设置<code class="du jp jq jr js b">whiky</code>的表亲为<code class="du jp jq jr js b">None</code>来克服这种循环引用。</p><p id="4216" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我们可以使用弱引用来处理这种类型的关系。</p><figure class="ju jv jw jx fd ij"><div class="bz dy l di"><div class="jy jz l"/></div></figure><p id="97f2" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">该文件的输出是:</p><pre class="ju jv jw jx fd ka js kb kc aw kd bi"><span id="3068" class="ke kf hi js b fi kg kh l ki kj">servy's refcount: 1<br/>whiky's refcount: 1</span><span id="ae37" class="ke kf hi js b fi kk kh l ki kj">AFTER DELETION OF servy</span><span id="a143" class="ke kf hi js b fi kk kh l ki kj">whiky's refcount: 1<br/>whiky's cousin: None</span></pre><p id="443d" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">我们看到引用计数并没有因为设置<code class="du jp jq jr js b">cousin</code>属性的值而增加，当<code class="du jp jq jr js b">servy</code>对象被删除时<code class="du jp jq jr js b">whiky</code>的<code class="du jp jq jr js b">cousin</code>属性的值为<code class="du jp jq jr js b">None</code>。</p><p id="bec1" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">那不是很容易吗？！</p><p id="b233" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">总之，<code class="du jp jq jr js b">weakref</code>模块提供了引用对象的方法，而不需要额外的巨大内存。</p><p id="0728" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">请浏览官方文档，查看所有方法。</p><p id="d555" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">感谢您的阅读。一会儿见。✨</p></div><div class="ab cl ku kv gp kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="hb hc hd he hf"><p id="6421" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated"><strong class="it hj">灵感:</strong></p><ul class=""><li id="a7b0" class="kl km hi it b iu iv iy iz jc kn jg ko jk kp jo lb kr ks kt bi translated"><a class="ae iq" href="http://pymotw.com/2/weakref/" rel="noopener ugc nofollow" target="_blank"> pymotw </a></li><li id="479a" class="kl km hi it b iu lc iy ld jc le jg lf jk lg jo lb kr ks kt bi translated"><a class="ae iq" href="https://docs.python.org/3/library/weakref.html" rel="noopener ugc nofollow" target="_blank">官方文件</a></li></ul><p id="290a" class="pw-post-body-paragraph ir is hi it b iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo hb bi translated">你可以在<a class="ae iq" href="https://www.patreon.com/dkhambu" rel="noopener ugc nofollow" target="_blank"> Patreon </a>上支持我！</p></div></div>    
</body>
</html>