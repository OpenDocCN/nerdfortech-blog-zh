<html>
<head>
<title>NestJs: Firebase Auth secured NestJs app using PassportJs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NestJs: Firebase Auth 使用 PassportJs 保护 NestJs 应用程序</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/nestjs-firebase-auth-secured-nestjs-app-using-passport-60e654681cff?source=collection_archive---------0-----------------------#2021-05-20">https://medium.com/nerd-for-tech/nestjs-firebase-auth-secured-nestjs-app-using-passport-60e654681cff?source=collection_archive---------0-----------------------#2021-05-20</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/cc30b98c392e6ee81461dfad7a470161.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hKMzzUOFT9cygi-KJe8TGw.png"/></div></div></figure><p id="c2df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">PassportJs 是 NodeJs 应用程序最好的认证中间件库之一。它支持 500 多种认证策略，包括最常见的策略，如用户名-密码、谷歌、脸书、Twitter 等。在为 NestJs 应用程序选择身份验证中间件库时，它的灵活性和易于集成性使它成为最优先考虑的对象。</p><p id="2a19" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您使用 Firebase 进行身份验证，可以使用 PassportJs 提供的'<em class="jo"> passport-jwt' </em>策略。按照下面的步骤来知道如何做。</p><h1 id="da4c" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> <em class="kn">步骤#1 </em> </strong>:创建一个 Firebase 项目</h1><p id="303b" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">创建一个 Firebase 项目并添加一个 web 应用程序。</p><p id="a052" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里按照步骤<a class="ae kt" rel="noopener" href="/@sharma.vikashkr/firebase-how-to-setup-an-app-in-firebase-9ddbacfe8ad1">进行</a>。</p><h1 id="c9f2" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak">第二步</strong>:创建一个 NestJs 应用程序</h1><p id="df72" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">创建一个 NestJs 项目。同样，我更喜欢使用 Nest CLI。如果您没有 Nest CLI，请使用以下命令通过 NPM 下载该软件包:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="3610" class="ld jq hi kz b fi le lf l lg lh"><strong class="kz hj">$ npm install -g @nestjs/cli</strong></span></pre><p id="61d9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建一个 NestJs 应用程序(我将我的项目命名为'<em class="jo">firebase-auth '</em>)；给出您选择的任何名称)，在您的首选文件夹中打开一个控制台，并运行命令:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="300a" class="ld jq hi kz b fi le lf l lg lh"><strong class="kz hj">$ nest new firebase-auth</strong></span></pre><figure class="ku kv kw kx fd ij er es paragraph-image"><div class="er es li"><img src="../Images/ee21c688cfc9e4137bd0d9a6503cbf82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/0*OAlaRWOs9P7XXc9K.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">创建新的 NestJs 项目</figcaption></figure><h1 id="bbb0" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> <em class="kn">第三步</em> </strong>:安装 PassportJs 依赖项</h1><p id="80d2" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">正如我们所知，Firebase 在认证时会生成<strong class="is hj"> JSON Web Token (JWT) </strong>，我们将需要'<em class="jo"> passport-jwt </em>'以及其他 passport 依赖项。控制台进入项目目录并安装这些依赖项:</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="e9aa" class="ld jq hi kz b fi le lf l lg lh"><strong class="kz hj">$ npm install </strong><a class="ae kt" href="http://twitter.com/nestjs/passport" rel="noopener ugc nofollow" target="_blank"><strong class="kz hj">@nestjs/passport</strong></a><strong class="kz hj"> passport passport-jwt<br/>$ npm install --save-dev </strong><a class="ae kt" href="http://twitter.com/types/passport-jwt" rel="noopener ugc nofollow" target="_blank"><strong class="kz hj">@types/passport-jwt</strong></a></span></pre><h1 id="78d6" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> <em class="kn">第四步</em> </strong>:确定你的秘钥</h1><p id="4d10" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated"><em class="jo"> passport-jwt </em>需要一个“<strong class="is hj"> secretOrKey </strong>”来验证令牌的签名。Firebase 使用 2 个可用的公钥<a class="ae kt" href="https://www.googleapis.com/robot/v1/metadata/x509/securetoken@system.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">在这里</a>对有效载荷进行签名(参考<a class="ae kt" href="https://firebase.google.com/docs/auth/admin/verify-id-tokens#verify_id_tokens_using_a_third-party_jwt_library" rel="noopener ugc nofollow" target="_blank"> Firebase 文档</a>)。要使用的密钥由 Firebase JWT 的解码报头中的'<strong class="is hj"> kid </strong>'参数标识。按照以下步骤识别您的'<strong class="is hj">秘密密钥</strong>':</p><p id="88be" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> a) </em> </strong>去<a class="ae kt" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank">https://jwt.io/</a>解码你的 JWT。这将给你一个<strong class="is hj"> keyId </strong>。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/57b5651866950ec01c324dfe98c36728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U3gno9sfc52kBDVpNDdfow.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">解码任何 JWT 火焰</figcaption></figure><p id="31cb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="jo"> b) </em> </strong>在此搜索此密钥 Id <a class="ae kt" href="https://www.googleapis.com/robot/v1/metadata/x509/securetoken@system.gserviceaccount.com" rel="noopener ugc nofollow" target="_blank">以获得一个公共证书，该证书将是您的'<strong class="is hj"> secretOrKey </strong>':</a></p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lo"><img src="../Images/e70adf8c071616e690565682d9239315.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iRbxA-6Y01XDGXLWgmkMbw.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">搜索您的签名</figcaption></figure><h1 id="f79c" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> <em class="kn">第五步</em> </strong>:创建一个授权策略</h1><p id="6162" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">在您喜欢的 IDE 中打开项目。创建一个文件夹，在 src 中说'<em class="jo"> auth </em>'。从<em class="jo"> passport-jwt </em>策略扩展创建您的授权策略。使用上一步获得的公共证书作为'<strong class="is hj"> secretOrKey </strong>'。此外，定义一个<strong class="is hj"> validate </strong>回调函数来接收经过验证的有效载荷，如下所示。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lp"><img src="../Images/220bb4ca4c947e0b77a15ad13322571a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0o2PxQ7yIixLFVTRN02Hg.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">由 passport-jwt 支持的授权策略</figcaption></figure><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="f003" class="ld jq hi kz b fi le lf l lg lh">jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken()</span></pre><p id="5d89" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(必需)指示 passport 从身份验证标头中提取 JWT 作为持有人。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="0c23" class="ld jq hi kz b fi le lf l lg lh">secretOrKey: “&lt;CERTIFICATE&gt;”</span></pre><p id="68c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(必需)指定用于验证 JWT 签名的 secretKey。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="2039" class="ld jq hi kz b fi le lf l lg lh">async validate(payload) {}</span></pre><p id="3dc2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这个被覆盖的函数“validate”允许您接受解码后的有效负载并返回一个自定义用户对象(从 DB？).这个返回的对象被设置为快速请求的“用户”字段。</p><h1 id="b9fe" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> <em class="kn">第六步</em>:为 DI </strong>提供你的认证策略</h1><p id="f3f9" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">在您的 AppModule 中提供 AuthStrategy。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lq"><img src="../Images/5426a7cadde1c67e8dd90e54e1380d30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CvPy1ZKvLtIWCopoAH1-EA.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">AppModule 中提供的 AuthStrategy</figcaption></figure><h1 id="9589" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> <em class="kn">步骤#7 </em> </strong>:为您的 API 启用 AuthGuard</h1><p id="8dd5" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">创建一个控制器，并启用带有“jwt”策略的 passport AuthGuard 来与您的 API 挂钩。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/5cdae13db070338a9beff33ebfcf8e30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kJnwRE6hycw1Uotl-IHt5w.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">控制器，带“jwt”策略的 passport AuthGuard</figcaption></figure><p id="c98d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在控制器方法中，我从 express 请求中读取用户字段。</p><h1 id="091c" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> <em class="kn">步骤#8 </em>:在 Firebase 上创建用户</strong></h1><p id="f9c5" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">在 Firebase 上创建用户。此外，创建任何客户端(<a class="ae kt" href="https://sharma-vikashkr.medium.com/vuejs-firebase-auth-in-vuejs-client-83c91a7cf4fd" rel="noopener"> VueJs 客户端示例</a>)来接受 firebase 登录并获取有效的 firebase idToken。使用这个 idToken 作为 API 调用的授权头中的承载令牌。</p><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ls"><img src="../Images/e508bf80ef05d2b3e3984b7e460df652.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TTjDBydCrdp4PsRubCfpzg.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">创建 firebase 用户</figcaption></figure><h1 id="c020" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated"><strong class="ak"> <em class="kn">步骤#9 </em> </strong>:运行 app 并验证</h1><p id="629f" class="pw-post-body-paragraph iq ir hi is b it ko iv iw ix kp iz ja jb kq jd je jf kr jh ji jj ks jl jm jn hb bi translated">运行您的应用程序并验证。</p><pre class="ku kv kw kx fd ky kz la lb aw lc bi"><span id="aead" class="ld jq hi kz b fi le lf l lg lh"><strong class="kz hj">$ npm run dev</strong></span></pre><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lt"><img src="../Images/03900344b2c27b508e2ebe1569242b78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3VGFlnXMwlcM6UmIkyNuEA.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">成功</figcaption></figure><figure class="ku kv kw kx fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lr"><img src="../Images/4998c200d8444ab0629fe0c6402c6829.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GBF65r2eij8R5apZg7HzWA.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx translated">不正确/过期的 JWT</figcaption></figure><blockquote class="lu lv lw"><p id="bc1c" class="iq ir jo is b it iu iv iw ix iy iz ja lx jc jd je ly jg jh ji lz jk jl jm jn hb bi translated">代码库:<br/><a class="ae kt" href="https://github.com/sharmavikashkr/firebase-auth-nestjs-passport" rel="noopener ugc nofollow" target="_blank">https://github . com/sharmavikashkr/firebase-auth-nestjs-passport</a></p></blockquote></div><div class="ab cl ma mb gp mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="hb hc hd he hf"><p id="477b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用中间件的 NestJs 中的 firebase auth &amp; firebase-admin-&gt;<a class="ae kt" href="https://sharma-vikashkr.medium.com/nestjs-firebase-auth-secured-nestjs-resource-server-9649bcebd0de" rel="noopener">此处</a>。</p></div></div>    
</body>
</html>