<html>
<head>
<title>Recording a session in K6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在K6中记录会话</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/recording-a-session-in-k6-f28daeffdabd?source=collection_archive---------0-----------------------#2022-02-23">https://medium.com/nerd-for-tech/recording-a-session-in-k6-f28daeffdabd?source=collection_archive---------0-----------------------#2022-02-23</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="cddd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在负载测试的上下文中，记录通常是指从用户会话记录中构造负载测试。该过程有三个步骤:创建用户或API会话记录，将记录的会话转换为测试，运行测试。</p><p id="e068" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然并不总是必要的，但在测试网站或移动应用程序的复杂场景时，通常会使用录音。记录允许测试人员查看请求序列和会话设置，允许他们快速生成复杂的请求链。假设您需要开发一个性能测试，用几十或几百个查询模拟用户旅程。在这种情况下，录音可以让您不必从头开始。</p><p id="8f89" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">为了从记录的用户体验中生成K6脚本，K6支持两种机制:</p><ol class=""><li id="9ab6" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">浏览器记录器使用浏览器会话来构建k6脚本。Chrome和Firefox都支持。</li><li id="cd39" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">HAR转换器根据HAR文件中的请求创建一个k6脚本。</li></ol><h1 id="6034" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">浏览器记录器</h1><p id="a460" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">浏览器记录器允许您从web体验中创建k6脚本。它以Chrome和Firefox扩展的形式提供。k6云支持浏览器记录器功能。当用户完成会话记录时，扩展将自动生成的k6测试上传到用户的k6云帐户。</p><p id="ab01" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">browser recorder允许您像用户一样访问您的站点或web应用程序，从而生成大多数测试脚本。准备好的脚本作为将来需要时进行编辑的基础。记录器将收集一切信息，包括你点击时载入浏览器的每一个HTTP(s)请求，包括广告、图片、文档等等，让你对正在发生的事情有一个更准确的了解。点击“记录”，开始冲浪，完成后脚本将存储到您的k6云帐户。</p><p id="2f27" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">要做的步骤</p><ol class=""><li id="2c74" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">安装<a class="ae ku" href="https://chrome.google.com/webstore/detail/k6-browser-recorder/phjdhndljphphehjpgbmpocddnnmdbda?hl=en" rel="noopener ugc nofollow" target="_blank"> Chrome </a>或<a class="ae ku" href="https://addons.mozilla.org/en-US/firefox/addon/k6-browser-recorder/" rel="noopener ugc nofollow" target="_blank"> Firefox </a>扩展。</li><li id="9696" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">要开始记录当前的浏览器标签，点击k6图标并按“开始记录”打开插件。记录用户会话时，请记住以下推荐做法:</li></ol><p id="5911" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">做</p><ul class=""><li id="0953" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc kv jj jk jl bi translated">像用户一样浏览</li><li id="82ef" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated">利用用户在阅读页面内容时会出现的自然停顿</li><li id="e04a" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated">关注最常见的用例，而不是所有可能的用例</li><li id="f7e9" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated">请注意表格/登录所在的页面；您将需要做额外的脚本，使其使用动态值。</li></ul><p id="d465" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">不</p><ul class=""><li id="9a7b" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc kv jj jk jl bi translated">在一次旅行中浏览每一页</li><li id="3ca1" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated">点击每个可能的选项</li><li id="bc3a" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated">尽可能快地导航</li><li id="5941" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc kv jj jk jl bi translated">离开你实际的站点或应用程序</li></ul><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es kw"><img src="../Images/78cd9d399695c28c25a4832543e72640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*neHIqvaFYELF7dbmHfiTgA.png"/></div></div></figure><p id="05a5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.完成后，按“停止记录”,您将被带到应用程序来查看记录的测试脚本</p><figure class="kx ky kz la fd lb er es paragraph-image"><div class="er es li"><img src="../Images/fa3bf358778d6273d982c03ff048bce1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1206/format:webp/1*98atxz2XjCA6Zq9pc6WDag.png"/></div></figure><p id="d14b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">4.将脚本记录保存在任何项目中。如果在录制过程中有任何第三方请求，它们将被自动过滤掉，因为:</p><p id="caae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些第三方请求会扭曲您的性能统计的百分比。<br/>您可能无法影响第三方服务的表现。<br/>负载测试可能违反您与提供商签订的服务合同的条件。</p><p id="112a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您希望将某些请求包括在第三方列表中，请取消选择您希望包括的请求，然后保存。</p><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lj"><img src="../Images/be181e2a2234fa4b2b69d83685b29558.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9xr_OiX4xF8wpd3aU9Qwvg.png"/></div></div></figure><p id="e1a0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">5.对脚本进行任何必要的更改。根据测试的类型，您可能需要修改脚本的某些部分。最常见的修改是:</p><p id="9ca5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最好是修改负载选择。默认情况下，上升时间设置为12分钟。<br/>你应该处理动态的相关数据。</p><p id="d24f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">6.在本地机器或k6云上运行测试。如果您希望通过k6 Cloud UI启动云测试，请点击Run。</p><p id="615e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您希望使用k6 CLI执行本地或云测试，请将创建的脚本复制到您的本地文本编辑器并运行</p><pre class="kx ky kz la fd lk ll lm ln aw lo bi"><span id="c927" class="lp js hi ll b fi lq lr l ls lt">k6 run or k6 cloud</span></pre><p id="26af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">命令开始测试。</p><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lu"><img src="../Images/5e8340ca1af60627042891ca522f4545.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IobX3GkGNTf6yv0CB2b9uQ.png"/></div></div></figure><h1 id="77de" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">HAR转炉</h1><p id="a06a" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">HAR转换器(所有主流浏览器和许多其他程序使用的一种文件格式，用于导出记录的HTTP请求。)是浏览器记录器的替代产品。它从HAR文件中的HTTP请求构建一个k6脚本。</p><p id="0d22" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">NodeJS用于运行har-to-k6转换器。与浏览器记录器不同，k6脚本不需要由k6云用户生成。使用HAR转换器时，程序如下:<br/> 1。使用您喜欢的浏览器或程序创建HAR文件。<br/> 2。要从HAR文件生成k6测试，请使用har-to-k6转换器。<br/> 3。在您的文本编辑器或IDE中，更新自动生成的k6测试。<br/> 4。用k6运行测试。</p><h1 id="38b6" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">1.记录HAR文件</h1><p id="a402" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">要以HAR格式导出HTTP流量，可以使用各种浏览器和技术。Chrome、Firefox和微软Edge就是几个例子。</p><p id="d4b5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是在Chrome中创建录音的基本步骤:<br/> 1。在Chrome中打开一个新的匿名窗口(严格来说不是必须的，但是使用匿名窗口意味着你不会传输那么多的cookies，等等。你的浏览器可能已经保存了)。<br/> 2。启动Chrome开发者工具(按F12) <br/> 3。导航到“网络”选项卡。<br/> 4。检查录音按钮(圆形按钮)是否打开(红色)。<br/> 5。如果您希望记录大量连续的页面加载，请单击“保留日志”选项。<br/> 6。输入您的站点的URL，并开始执行您希望您的模拟负载测试客户做的任何事情。<br/> 7。在Chrome开发者工具中，右键点击URL列表，选择“另存为HAR内容”</p><figure class="kx ky kz la fd lb er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lv"><img src="../Images/d209c4396dfda83c25cc6f0c37e3628f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m9DkkNt2nOZusRmKr6mxPg.png"/></div></div></figure><p id="b89a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在记录用户会话时，最好记住以下推荐做法:</p><p id="dfba" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">做</strong></p><ol class=""><li id="9ecd" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">像用户一样浏览。</li><li id="a0ca" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">采取自然停顿，消费者会采取摄取页面信息。</li><li id="0711" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">关注最常见的用例，而不是所有可能的用例。</li><li id="4502" class="jd je hi ih b ii jm im jn iq jo iu jp iy jq jc ji jj jk jl bi translated">记下任何带有表单或登录信息的页面；您很可能需要在那里编写一些脚本。</li></ol><p id="a646" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">不要</strong>1<br/>。在一次旅行中浏览每一页。</p><p id="3cd8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.选择每个可行的选项。</p><p id="131b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">3.尽可能快地离开你实际的站点或应用程序。</p><h1 id="bd16" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">2.将HAR文件转换成k6脚本</h1><p id="7918" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">har-to-k6转换器是一个NodeJS实用程序，用于将har文件(浏览器会话)转换为k6脚本。下载并安装har-to-k6转换器。必须按照要求安装NodeJS(版本&gt; =11.0.0)。您可以使用npm来安装转换器:</p><pre class="kx ky kz la fd lk ll lm ln aw lo bi"><span id="1884" class="lp js hi ll b fi lq lr l ls lt">npm install -g har-to-k6</span></pre><p id="5e66" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">执行convert命令。现在，您可以使用转换器从HAR文件创建k6脚本:</p><pre class="kx ky kz la fd lk ll lm ln aw lo bi"><span id="743c" class="lp js hi ll b fi lq lr l ls lt">har-to-k6 myfile.har -o loadtest.js</span></pre><p id="6794" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">上面的程序将为您生成一个k6脚本。它将读取HAR文件(myfile.har)并创建一个k6测试(loadtest.js)。</p><h1 id="ac34" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">3.修改自动生成的k6脚本</h1><p id="831a" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">转换器为前一阶段的测试创建了一个k6脚本。这将有助于确定k6脚本的任何部分是否需要更改。根据您的使用情况，您可能需要更改以下一些内容:</p><h2 id="496b" class="lp js hi bd jt lw lx ly jx lz ma mb kb iq mc md kf iu me mf kj iy mg mh kn mi bi translated">1.配置加载选项</h2><p id="953c" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">目前，k6已经开发了一个“功能”测试，默认情况下，它将使用一个“虚拟用户”运行一次“迭代”。是时候为您的性能测试设置“负载”参数了。k6可以通过多种方式进行配置:</p><ol class=""><li id="123b" class="jd je hi ih b ii ij im in iq jf iu jg iy jh jc ji jj jk jl bi translated">运行测试时作为CLI参数:</li></ol><pre class="kx ky kz la fd lk ll lm ln aw lo bi"><span id="5bbe" class="lp js hi ll b fi lq lr l ls lt">k6 run --vus 10 --duration 30s loadtest.js</span></pre><p id="3af9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2.脚本文件的选项。</p><pre class="kx ky kz la fd lk ll lm ln aw lo bi"><span id="73ed" class="lp js hi ll b fi lq lr l ls lt">export const options = {</span><span id="f005" class="lp js hi ll b fi mj lr l ls lt">vus: 10,</span><span id="4a8b" class="lp js hi ll b fi mj lr l ls lt">duration: '30s',</span><span id="7693" class="lp js hi ll b fi mj lr l ls lt">};</span></pre><h2 id="628e" class="lp js hi bd jt lw lx ly jx lz ma mb kb iq mc md kf iu me mf kj iy mg mh kn mi bi translated">2.删除第三方内容</h2><p id="4782" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">当您在网站上记录用户会话时，您将默认记录所有HTTP请求，包括来自您网站上使用的第三方工具的请求，如分析工具、脸书、Twitter、支持小部件、cdn等等。应该删除这些第三方查询，因为:</p><p id="6168" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这些第三方请求会扭曲您的性能统计的百分比。<br/>你可能无法影响第三方服务的表现。<br/>负载测试可能违反您与提供商签订的服务合同的条件。在您的k6脚本中，您有两种选择来跳过第三方请求。</p><p id="a6b6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">1 .编辑自动生成的k6脚本，并逐个消除对第三方服务的查询。</p><p id="fd86" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2 .下载一个HAR文件，其中只包含对所选域的请求。</p><p id="ec94" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以使用DevTools网络过滤器将你的搜索限制在Chrome的特定领域。为了匹配几个域，过滤器输入支持正则表达式。</p><p id="f075" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du mk ml mm ll b">/loadimpact.com|cloudfront.net/</code></p><figure class="kx ky kz la fd lb er es paragraph-image"><div class="er es mn"><img src="../Images/fb0381b0aeffb3451e64be2f961489a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*KtnUeUErEAWYESmN.png"/></div></figure><p id="ee39" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">过滤完您选择的域后，您可以按照本文第一步中的说明下载HAR文件，而HAR文件将只包含对所选域的请求。如果您不知道要过滤的所有域，那么利用网络过滤器的查询语言是一个好主意。在过滤器中输入domain:以查看网络面板记录的所有域。</p><figure class="kx ky kz la fd lb er es paragraph-image"><div class="er es mo"><img src="../Images/95c83ee2706beab556bd4efef70f281f.png" data-original-src="https://miro.medium.com/v2/resize:fit:594/format:webp/0*XcCrCCsIp4l-SnfN.png"/></div></figure><h2 id="d9fd" class="lp js hi bd jt lw lx ly jx lz ma mb kb iq mc md kf iu me mf kj iy mg mh kn mi bi translated">关联动态数据</h2><p id="1df1" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">负载测试中的相关性是指从一个请求的答案中检索一个或多个值，并在未来的请求中重用它们。获取令牌或某种形式的ID经常需要完成用户旅程中的一系列阶段。记录的HAR文件可能包含来自您站点的动态数据，如id、CSRF令牌、VIEWSTATE、wpnonce和其他动态变量，这些数据将被转换为k6脚本。为了正确执行负载测试，您可能需要用从以前的请求中获得的动态数据替换硬编码的数据。例如，令牌会很快过期，并且是消费者会与记录的会话相关联的最典型的项目之一。</p><h1 id="cf5f" class="jr js hi bd jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko bi translated">4.运行测试</h1><p id="af0e" class="pw-post-body-paragraph if ig hi ih b ii kp ik il im kq io ip iq kr is it iu ks iw ix iy kt ja jb jc hb bi translated">要运行k6脚本，请使用k6 run命令:</p><pre class="kx ky kz la fd lk ll lm ln aw lo bi"><span id="e234" class="lp js hi ll b fi lq lr l ls lt">k6 run loadtest.js</span></pre></div></div>    
</body>
</html>