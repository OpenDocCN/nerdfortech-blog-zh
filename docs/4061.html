<html>
<head>
<title>PostgreSQL Functions using PL/PGSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用 PL/PGSQL 的 PostgreSQL 函数</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/playing-with-functions-using-pl-pgsql-is-just-a-fun-e38889ddf382?source=collection_archive---------4-----------------------#2021-07-05">https://medium.com/nerd-for-tech/playing-with-functions-using-pl-pgsql-is-just-a-fun-e38889ddf382?source=collection_archive---------4-----------------------#2021-07-05</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/24133b35e68c9e746080b968d48f3f66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p3HRRyC-ZvialkjVIHz4VQ.png"/></div></div></figure><p id="dadb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">像其他编程语言一样，PostgreSQL 也支持用户自定义函数。用户自定义函数可以用 SQL 和 c 编写，它还支持过程语言(PLs) PostgreSQL-pgSQL、Python、Perl 和 Tcl。这四种过程语言包含在 PostgreSQL 的滞留分发版中。要定义一个功能，用户必须拥有该语言的权限。</p><p id="d653" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编写函数的基本语法是，</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="da60" class="jx jy hi jt b fi jz ka l kb kc">CREATE or REPLACE FUNCTION function_name(parameters_list)<br/>    RETURNS return_type<br/>    LANGUAGE plpgsqlAssociation, Aggregation, Composition<br/>    AS<br/>$$<br/>declare <br/>    -- define variables<br/>begin<br/>    -- define logic here<br/>end<br/>$$</span></pre><ul class=""><li id="f1e4" class="kd ke hi is b it iu ix iy jb kf jf kg jj kh jn ki kj kk kl bi translated"><em class="km">返回</em>定义函数的返回类型。返回类型可以是整数、字符串、查询、表列等。如果没有返回类型，可以指定<strong class="is hj"> void </strong>。如果参数列表包含 OUT 或 INOUT 参数，则可以跳过返回。</li><li id="ddc0" class="kd ke hi is b it kn ix ko jb kp jf kq jj kr jn ki kj kk kl bi translated">语言定义了函数实现的语言。</li><li id="8177" class="kd ke hi is b it kn ix ko jb kp jf kq jj kr jn ki kj kk kl bi translated">美元引用的字符串常量($$)指定块。</li></ul><p id="9ba3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们定义一个用户表，</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="d5e3" class="jx jy hi jt b fi jz ka l kb kc">DROP TABLE IF EXISTS users;</span><span id="29d5" class="jx jy hi jt b fi ks ka l kb kc">CREATE TABLE users(<br/> id INT GENERATED BY DEFAULT AS IDENTITY,<br/> name VARCHAR(50),<br/> gems DEC (10),<br/> PRIMARY KEY (id));</span></pre><p id="23a1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">用默认的宝石数量填充用户表，</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="d8f0" class="jx jy hi jt b fi jz ka l kb kc">INSERT INTO users (name, gems) VALUES ('David', 1000); <br/>INSERT INTO users (name, gems) VALUES ('John', 2000);<br/>INSERT INTO users (name, gems) VALUES ('Joe', 3000);</span></pre><p id="33e8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们编写一个函数，返回指定宝石数量的用户数量</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="2bd3" class="jx jy hi jt b fi jz ka l kb kc">CREATE or REPLACE FUNCTION users_count(number_of_gems int)<br/>    RETURNS int<br/>    LANGUAGE plpgsql<br/>    AS<br/>$$<br/>DECLARE <br/>    user_count integer;<br/>BEGIN<br/>    SELECT count(*) INTO user_count<br/>    FROM users WHERE gems &gt; number_of_gems;<br/>    <br/>    RETURN user_count;<br/>END;<br/>$$;</span></pre><p id="53a0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建函数后，用一个简单的 SELECT 语句调用它，并根据需要传递宝石的数量。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="5b67" class="jx jy hi jt b fi jz ka l kb kc">SELECT users_count(1500);</span></pre><p id="b3a5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">它将使拥有 gems 的用户数量恢复到 1500 以上。</p><figure class="jo jp jq jr fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kt"><img src="../Images/4d02895f8f6be4ace39c30614e877114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uiY_hSp2yNaG6BLwDGaCsQ.png"/></div></div></figure><p id="27ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上述函数从函数中返回整数值。要从函数中返回表，请在函数中使用以下 return 语句，</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="c474" class="jx jy hi jt b fi jz ka l kb kc">RETURNS table (column_list)</span></pre><p id="1150" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">column_list 包含列表中的指定列。让我们写一个函数，返回用户的 id、姓名和宝石。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="d4e2" class="jx jy hi jt b fi jz ka l kb kc">CREATE or REPLACE FUNCTION users_gems()<br/>    RETURNS table (id int, <br/>          name varchar,<br/>          gems DEC (10))<br/>    LANGUAGE plpgsql<br/>    AS<br/>$$<br/>BEGIN<br/>    RETURN query <br/>    SELECT * FROM users;<br/>    <br/>END;<br/>$$;</span></pre><p id="acf8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，获得上述函数的输出</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="3f0c" class="jx jy hi jt b fi jz ka l kb kc">SELECT users_gems();</span></pre><p id="e5e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">该函数接受三种类型的参数 IN、OUT 和 INOUT。users_count()函数有一个 IN 参数，它是默认类型。应该明确提到 OUT 和 INOUT 参数，</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="d7db" class="jx jy hi jt b fi jz ka l kb kc">OUT parameter type<br/>INOUT parameter type </span></pre><p id="c25e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">OUT 参数返回函数的输出，并且不需要在块的末尾提到 returns 类型和 return 语句。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="61fd" class="jx jy hi jt b fi jz ka l kb kc">CREATE or REPLACE FUNCTION total_user_count(OUT user_count int)<br/>    LANGUAGE plpgsql<br/>    AS<br/>$$<br/>BEGIN<br/>    SELECT count(*) INTO user_count<br/>    FROM users;<br/>    <br/>END;<br/>$$;</span></pre><p id="9e21" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">来获得输出、关联、聚集、合成</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="9c02" class="jx jy hi jt b fi jz ka l kb kc">SELECT total_user_count();</span></pre><p id="594c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">INOUT 参数可以接受来自调用者的值，并将返回更新后的值。</p><p id="7f14" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">PostgreSQL 也支持函数重载。函数重载意味着，函数名相同，但参数不同。当调用重载函数 PostgreSQL 时，根据参数选择最佳函数。</p><p id="8183" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要登记所有用户定义的函数及其详细信息，请使用命令。</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="b968" class="jx jy hi jt b fi jz ka l kb kc">\df </span></pre><p id="63ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">输出将显示函数的模式、名称、返回类型和参数列表。</p><p id="bf25" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">若要删除函数，请使用以下语句</p><pre class="jo jp jq jr fd js jt ju jv aw jw bi"><span id="bf0d" class="jx jy hi jt b fi jz ka l kb kc">DROP FUNCTION function_name(argument_type) [ CASCADE | RESTRICT ];</span></pre><p id="6765" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果函数接受任何参数，由于函数重载，您需要显式地提及参数类型。</p></div></div>    
</body>
</html>