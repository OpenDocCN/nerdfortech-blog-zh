<html>
<head>
<title>Running Apache Spark on EKS with AWS Spot Instances</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Spot实例在EKS上运行Apache Spark</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/running-apache-spark-on-eks-with-aws-spot-instances-f8ce91d319b9?source=collection_archive---------1-----------------------#2021-08-07">https://medium.com/nerd-for-tech/running-apache-spark-on-eks-with-aws-spot-instances-f8ce91d319b9?source=collection_archive---------1-----------------------#2021-08-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8340" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">通过AWS Spot实例为EKS上的Apache Spark工作负载有效节约成本</p><p id="e5e7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Apache Spark是一个数据处理框架，可以在巨大的数据集上执行快速处理任务，并可以将数据处理任务分布在多个节点上。随着应用程序的快速容器化，组织也开始在像Kubernetes这样的容器化平台上运行spark，并在生产中使用它们。理想情况下，在Kubernetes上运行spark有两种方式。</p><p id="b812" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a) Spark Submit:这是一个用于提交Spark程序和启动Kubernetes集群应用程序的脚本。</p><p id="9d12" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="47d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b) spark操作符:Spark操作符允许以声明的方式定义Spark应用程序，并支持使用<code class="du jk jl jm jn b">SparkApplication</code>的一次性Spark应用程序和使用<code class="du jk jl jm jn b">ScheduledSparkApplication</code>的cron调度应用程序。</p><p id="3c00" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">示例:</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="549e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦您确信了上面提到的任何模式，您就决定在EKS上运行您的spark工作负载。但是，你的经营方式正确吗？我在这里举个例子。让我们假设您的应用程序Kubernetes pods需要t2.micro类型的实例，但是您的spark工作负载可能需要t2.large类型的工作节点。这种分割节点的方式有50%的效率。我们如何实现剩下的50%？这可以通过使用AWS spot实例来完成。是的，由于spark工作负载并不保持24/7全天候运行，我们可以用spot实例配置一个自动伸缩组，并将最小计数设置为0。即时实例比按需实例便宜90%。在本文的范围内，我们将了解如何设置一个带有Spot Instances节点组的EKS集群来运行spark工作负载。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es jo"><img src="../Images/1568a3d15f0bd9861e55d673c16a98cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*I--i38hpPHmIs2l7.png"/></div></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">图片来源:<a class="ae jz" href="https://www.google.com/url?sa=i&amp;url=https%3A%2F%2Fanalyticsindiamag.com%2Fbeginners-guide-to-pyspark-how-to-set-up-apache-spark-on-aws%2F&amp;psig=AOvVaw3ChIFZKzCwVygzpPUpGE5p&amp;ust=1628411869919000&amp;source=images&amp;cd=vfe&amp;ved=0CAsQjRxqFwoTCKi64Y7BnvICFQAAAAAdAAAAABAD" rel="noopener ugc nofollow" target="_blank">谷歌图片</a></figcaption></figure><h1 id="88a5" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">整个故事是关于什么的？(TLDR)</h1><ol class=""><li id="b568" class="ky kz hi ih b ii la im lb iq lc iu ld iy le jc lf lg lh li bi translated">设置具有两个不同节点组(按需和现场实例节点组)的EKS集群。</li><li id="8c2d" class="ky kz hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">在Spot实例上执行spark工作负载(使用spark-submit和Spark Operator)。</li></ol><h2 id="7563" class="lo kb hi bd kc lp lq lr kg ls lt lu kk iq lv lw ko iu lx ly ks iy lz ma kw mb bi translated">这篇文章没有涉及到什么</h2><ol class=""><li id="ee12" class="ky kz hi ih b ii la im lb iq lc iu ld iy le jc lf lg lh li bi translated">如何写一个spark提交文件/ Spark操作符文件？</li><li id="5493" class="ky kz hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">如何建立基于生产的EKS集群？</li></ol><h1 id="13a8" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">先决条件</h1><ol class=""><li id="d9f1" class="ky kz hi ih b ii la im lb iq lc iu ld iy le jc lf lg lh li bi translated">AWS帐户。</li><li id="cf08" class="ky kz hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">Helm，eksctl，spark-提交二进制安装。</li></ol><h1 id="e203" class="ka kb hi bd kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx bi translated">故事资源</h1><ol class=""><li id="8f1f" class="ky kz hi ih b ii la im lb iq lc iu ld iy le jc lf lg lh li bi translated">GitHub链接:【https://github.com/pavan-kumar-99/medium-manifests T4】</li><li id="4cfc" class="ky kz hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated">GitHub分支:<a class="ae jz" href="https://github.com/pavan-kumar-99/medium-manifests/tree/aws-spot-spark" rel="noopener ugc nofollow" target="_blank"> aws-spot-spark </a></li></ol><h2 id="d0a9" class="lo kb hi bd kc lp lq lr kg ls lt lu kk iq lv lw ko iu lx ly ks iy lz ma kw mb bi translated">使用eksctl创建AWS EKS集群</h2><p id="eb27" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">市场上有很多方法可以创建EKS集群。其中使用最多的是Terraform，eksctl。我们将在本文的范围内使用eksctl。<a class="ae jz" href="https://eksctl.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj"> eksctl </strong> </a>是一个简单的CLI工具，用于在EKS上创建和管理集群——亚马逊为EC2提供的托管Kubernetes服务。它是用Go编写的，使用CloudFormation，由<a class="ae jz" href="https://www.weave.works/" rel="noopener ugc nofollow" target="_blank"> Weaveworks </a>创建。可以在文件(YAML格式)中定制集群配置。eksctl可以解析输入文件并从中创建集群。这里是我们将用来创建EKS集群的eksctl配置文件。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="2f4f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们了解一下配置文件</p><p id="ea0c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">a) metadata.name:要创建的EKS集群的名称。</p><p id="e56c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">b) managedNodeGroups.name:受管理的Kubernetes工作节点组的名称。</p><p id="72cd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">c)managednodegroups . instance type:要在节点组中使用的实例的类型。</p><p id="5799" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">d)managedNodeGroups.min/max/desired:自动缩放节点组的最小、最大、期望计数。</p><p id="785f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">e)<strong class="ih hj">managednodegroups . spot</strong>:指定节点组是否应该有spot实例的布尔值。</p><p id="c4eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，上面的配置创建了一个包含2个受管节点组的EKS集群。</p><ol class=""><li id="670a" class="ky kz hi ih b ii ij im in iq mf iu mg iy mh jc lf lg lh li bi translated"><strong class="ih hj">eks-medium-on-demand-node-group</strong>:这个节点组创建时最少需要1个t2.micro实例，并且可以自动扩展到8个。这里的所有实例都是按需实例。</li><li id="8ea4" class="ky kz hi ih b ii lj im lk iq ll iu lm iy ln jc lf lg lh li bi translated"><strong class="ih hj">eks-medium-spot-node-group:</strong>该节点组由<strong class="ih hj"> 0 </strong>个实例创建。是的，你没看错。节点组将有0个点实例，并且可扩展到最多5个实例。</li></ol><p id="9607" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们创建EKS集群。</p><pre class="jd je jf jg fd mi jn mj mk aw ml bi"><span id="dcd4" class="lo kb hi jn b fi mm mn l mo mp"><strong class="jn hj">$ </strong>git clone <a class="ae jz" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b aws-spot-spark</span><span id="8233" class="lo kb hi jn b fi mq mn l mo mp"><strong class="jn hj">$ </strong>cd medium-manifests/</span><span id="3044" class="lo kb hi jn b fi mq mn l mo mp"><strong class="jn hj">$ </strong>eksctl create cluster -f eksctl-cluster.yaml</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es mr"><img src="../Images/53440855d087f2a69f723f4ccfbac717.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iNfd6VqodZLP3kzwxa8jww.png"/></div></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">使用2个受管节点组创建的EKS集群</figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es ms"><img src="../Images/60a1ac44a0e1f667d2687880e3a4f85a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zHNpMftfM_u4-z_Iqf3zVQ.png"/></div></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">使用2个受管节点组创建的EKS集群</figcaption></figure><blockquote class="mt mu mv"><p id="ee90" class="if ig mw ih b ii ij ik il im in io ip mx ir is it my iv iw ix mz iz ja jb jc hb bi translated">需要注意的一点是，eksctl没有用配置文件中指定的标记来标记ASG。<a class="ae jz" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-can-i-scale-a-node-group-to-0" rel="noopener ugc nofollow" target="_blank"> <strong class="ih hj">应该为集群自动缩放器手动标记ASG，以向上扩展具有0个节点的ASG</strong></a>(以便nodeAffinity / nodeSelector工作)。</p></blockquote><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">ASG的标签</figcaption></figure><p id="8d63" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们安装Kubernetes集群自动分类器。kubernetes Cluster auto scaler<strong class="ih hj"/>根据您的工作负载需求，自动调整给定集群中工作节点的数量。您不需要手动添加或删除节点，也不需要过度配置集群。相反，您可以为集群指定最小和最大大小，扩展是自动的，由集群自动缩放器自行完成。我写了一篇关于Kubernetes集群自动缩放器的详细文章。一旦我发布了链接，我会在这里分享它。现在，让我们安装集群autosclaer舵图。</p><pre class="jd je jf jg fd mi jn mj mk aw ml bi"><span id="05cf" class="lo kb hi jn b fi mm mn l mo mp">$ git clone <a class="ae jz" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b aws-spot-spark</span><span id="726a" class="lo kb hi jn b fi mq mn l mo mp">$ cd medium-manifests/</span><span id="9ac9" class="lo kb hi jn b fi mq mn l mo mp">$ helm repo add autoscaler <a class="ae jz" href="https://kubernetes.github.io/autoscaler" rel="noopener ugc nofollow" target="_blank">https://kubernetes.github.io/autoscaler</a></span><span id="0be1" class="lo kb hi jn b fi mq mn l mo mp">$ helm upgrade -i medium-ca-aws autoscaler/cluster-autoscaler -f ca-values.yaml</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es na"><img src="../Images/36b63fbda78551978461e9b535ec5c27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X7Mc7DqyZFoljQE2HUc9-g.png"/></div></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">集群自动缩放日志</figcaption></figure><p id="ed47" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，您应该看到集群自动缩放窗格检测到了正确的自动缩放组。好了，现在让我们检查节点。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nb"><img src="../Images/3998b6aa8df66d4484cbe7d9abed3273.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z8qVJeV93lPyEAx3DAtZUQ.png"/></div></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">创建了单个节点</figcaption></figure><h2 id="1833" class="lo kb hi bd kc lp lq lr kg ls lt lu kk iq lv lw ko iu lx ly ks iy lz ma kw mb bi translated">使用Spark提交部署Spark应用程序</h2><p id="e822" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">我们现在创建了一个节点，这是一个按需节点。从节点显示的节点标签中也可以明显看出这一点。现在让我们使用spark-submit命令来提交一个spark作业。这次的不同之处是在spark-submit命令中添加了这个新的节点选择器参数。</p><pre class="jd je jf jg fd mi jn mj mk aw ml bi"><span id="eb86" class="lo kb hi jn b fi mm mn l mo mp">$ --conf spark.kubernetes.<strong class="jn hj">node.selector.nodegroup-type=spot</strong></span></pre><p id="283c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">根据spark的<a class="ae jz" href="https://spark.apache.org/docs/latest/running-on-kubernetes.html" rel="noopener ugc nofollow" target="_blank">文档</a>spark . kubernetes . node . selector .<strong class="ih hj">【label key】</strong>，添加到驱动程序舱和执行程序舱的节点选择器，键<code class="du jk jl jm jn b">labelKey</code>和值作为配置的值。因此，最终的spark-submit作业将如下所示</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="b69c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我们提交作业之前，应该为driver pods创建一个Kubernetes服务帐户，以创建executor pods并访问它们的服务。</p><pre class="jd je jf jg fd mi jn mj mk aw ml bi"><span id="1067" class="lo kb hi jn b fi mm mn l mo mp">$ git clone <a class="ae jz" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b aws-spot-spark</span><span id="135d" class="lo kb hi jn b fi mq mn l mo mp">$ cd medium-manifests/</span><span id="5896" class="lo kb hi jn b fi mq mn l mo mp">$ kubectl apply -f spark-rbac.yaml </span><span id="432c" class="lo kb hi jn b fi mq mn l mo mp">$ ./spark-submit.sh</span></pre><p id="a271" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦我提交了我的spark作业，我应该看到spot实例ASG中的节点开始从0扩展到2。(基于创建的spark-submit作业的数量)。</p><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nc"><img src="../Images/216d83ea80235bcc051255682f97cdf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QlRcYuBFllbYJQe7KTMU2w.png"/></div></div></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nd"><img src="../Images/eb0064c6a69223bab684415ffa5055b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ArFqgt4ysGIGK8gsOqi2MA.png"/></div></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">节点向上扩展(定点实例)</figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div class="er es ne"><img src="../Images/68b2be6419de494c5e9a3d25d588f664.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/0*brBAuqKrqqOHrLju"/></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">由于现货实例，我所有的钱都被节省了:)</figcaption></figure><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es nf"><img src="../Images/e5012e2b9164ea3b3db4d15abbd1d1d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6PcMCEPH08lQ2GzpqmUlEQ.png"/></div></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">正按比例放大的Spot实例</figcaption></figure><p id="e151" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们也用Spark操作符进行同样的尝试，看看这是否可行。</p><h2 id="f33a" class="lo kb hi bd kc lp lq lr kg ls lt lu kk iq lv lw ko iu lx ly ks iy lz ma kw mb bi translated">使用Spark Operator部署Spark应用程序</h2><p id="cf78" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated">spark操作符允许以声明的方式定义Spark应用程序，并支持使用<code class="du jk jl jm jn b">SparkApplication</code>的一次性Spark应用程序和使用<code class="du jk jl jm jn b">ScheduledSparkApplication</code>的cron调度应用程序。让我们首先部署spark操作符。</p><pre class="jd je jf jg fd mi jn mj mk aw ml bi"><span id="f407" class="lo kb hi jn b fi mm mn l mo mp">$ helm repo add spark-operator\ https://googlecloudplatform.github.io/spark-on-k8s-operator</span><span id="5e07" class="lo kb hi jn b fi mq mn l mo mp">$ helm install spark-operator spark-operator/spark-operator\ <br/>--namespace spark-operator --create-namespace</span><span id="d8f3" class="lo kb hi jn b fi mq mn l mo mp">$ k get po -n spark-operator</span><span id="40f5" class="lo kb hi jn b fi mq mn l mo mp">NAME                              READY   STATUS    RESTARTS   AGE</span><span id="9e2f" class="lo kb hi jn b fi mq mn l mo mp">spark-operator-5fb7bcf764-qm8np   1/1     Running   0          21m</span></pre><p id="1ad6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在让我们部署spark应用程序。spark应用程序如下所示。</p><figure class="jd je jf jg fd jh"><div class="bz dy l di"><div class="ji jj l"/></div></figure><p id="7c43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在整个yaml文件中，突出显示的部分是<strong class="ih hj"> nodeAffinity </strong>部分。这种相似性确保了spark应用程序(驱动程序和执行程序都可以部署在spot实例上)。与spark-submit不同，在Spark-submit中，驱动程序和执行器都有相同的nodeSelector ( Spark submit目前不支持节点关联)，在spark operator ( SparkApplication)中，我们可以灵活地为驱动程序和执行器指定不同的关联。有些情况下，我们可能希望在“按需”节点上运行驱动程序窗格，在“现场”节点上运行执行器窗格。在这种情况下，spark operator允许我们分别为驱动程序和执行程序创建关联。</p><pre class="jd je jf jg fd mi jn mj mk aw ml bi"><span id="f474" class="lo kb hi jn b fi mm mn l mo mp">$ git clone <a class="ae jz" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b aws-spot-spark</span><span id="c57b" class="lo kb hi jn b fi mq mn l mo mp">$ cd medium-manifests/</span><span id="c0da" class="lo kb hi jn b fi mq mn l mo mp">$ kubectl apply -f spark-app.yaml</span><span id="e3cb" class="lo kb hi jn b fi mq mn l mo mp">$ k get SparkApplication</span><span id="63fb" class="lo kb hi jn b fi mq mn l mo mp">NAME         STATUS      ATTEMPTS   START                  FINISH                 AGE</span><span id="4926" class="lo kb hi jn b fi mq mn l mo mp">pyspark-pi   COMPLETED   1          2021-08-07T12:19:30Z   2021-08-07T12:21:49Z   16m</span></pre><figure class="jd je jf jg fd jh er es paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="er es ng"><img src="../Images/295acc4aea800b39d7d206014f62970a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dliRKRZrZKFEZFsKvBC9QA.png"/></div></div><figcaption class="jv jw et er es jx jy bd b be z dx translated">被触发的Spot实例</figcaption></figure><h2 id="c2b6" class="lo kb hi bd kc lp lq lr kg ls lt lu kk iq lv lw ko iu lx ly ks iy lz ma kw mb bi translated">有效处理现场实例终止</h2><p id="5b9b" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq mc is it iu md iw ix iy me ja jb jc hb bi translated"><strong class="ih hj"> AWS节点终止处理程序:</strong>这个项目确保Kubernetes控制平面适当地响应可能导致您的EC2实例变得不可用的事件，例如<a class="ae jz" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/monitoring-instances-status-check_sched.html" rel="noopener ugc nofollow" target="_blank"> EC2维护事件</a>、<a class="ae jz" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-interruptions.html" rel="noopener ugc nofollow" target="_blank"> EC2现场中断</a>、<a class="ae jz" href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/AutoScalingGroupLifecycle.html#as-lifecycle-scale-in" rel="noopener ugc nofollow" target="_blank"> ASG扩大</a>、<a class="ae jz" href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/auto-scaling-benefits.html#AutoScalingBehavior.InstanceUsage" rel="noopener ugc nofollow" target="_blank"> ASG AZ重新平衡</a>，以及通过API或控制台终止EC2实例。如果处理不当，您的应用程序代码可能无法正常停止，需要更长的时间来恢复完全可用性，或者意外地将工作调度到正在关闭的节点。</p><p id="7dab" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">项目链接:<a class="ae jz" href="https://github.com/aws/aws-node-termination-handler" rel="noopener ugc nofollow" target="_blank">https://github.com/aws/aws-node-termination-handler</a></p><h2 id="982b" class="lo kb hi bd kc lp lq lr kg ls lt lu kk iq lv lw ko iu lx ly ks iy lz ma kw mb bi translated">清除</h2><pre class="jd je jf jg fd mi jn mj mk aw ml bi"><span id="a153" class="lo kb hi jn b fi mm mn l mo mp">$ eksctl delete cluster -f <a class="ae jz" href="https://github.com/pavan-kumar-99/medium-manifests/blob/aws-spot-spark/eksctl-cluster.yaml" rel="noopener ugc nofollow" target="_blank">eksctl-cluster.yaml</a></span></pre><p id="a0c6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我希望这篇文章能够介绍如何使用AWS Spot实例以最小的成本在Kubernetes集群上有效地部署spark应用程序。请在评论区随意评论您的想法和您对AWS spot实例的最佳体验。</p><p id="8fbd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">再次感谢您阅读我的文章。希望你喜欢它。以下是我的一些其他文章，你可能会感兴趣。</p><p id="7540" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">直到下次……..</p><div class="nh ni ez fb nj nk"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/deep-dive-into-thanos-part-i-f72ecba39f76"><div class="nl ab dw"><div class="nm ab nn cl cj no"><h2 class="bd hj fi z dy np ea eb nq ed ef hh bi translated">深入灭霸——第一部分</h2><div class="nr l"><h3 class="bd b fi z dy np ea eb nq ed ef dx translated">使用灭霸和普罗米修斯操作员监控Kubernetes的工作负载</h3></div><div class="ns l"><p class="bd b fp z dy np ea eb nq ed ef dx translated">medium.com</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny jt nk"/></div></div></a></div><div class="nh ni ez fb nj nk"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/free-and-automatic-ssl-certificates-in-kubernetes-using-cert-manager-6fb65ac63d5"><div class="nl ab dw"><div class="nm ab nn cl cj no"><h2 class="bd hj fi z dy np ea eb nq ed ef hh bi translated">使用证书管理器在Kubernetes中免费提供自动SSL证书</h2><div class="nr l"><h3 class="bd b fi z dy np ea eb nq ed ef dx translated">使用证书管理器获得免费和自动SSL证书，让我们加密</h3></div><div class="ns l"><p class="bd b fp z dy np ea eb nq ed ef dx translated">medium.com</p></div></div><div class="nt l"><div class="nz l nv nw nx nt ny jt nk"/></div></div></a></div><div class="nh ni ez fb nj nk"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/network-policies-demystified-in-kubernetes-d57fc2548043"><div class="nl ab dw"><div class="nm ab nn cl cj no"><h2 class="bd hj fi z dy np ea eb nq ed ef hh bi translated">Kubernetes揭秘网络政策</h2><div class="nr l"><h3 class="bd b fi z dy np ea eb nq ed ef dx translated">使用Cilium编辑器在Kubernetes中可视化网络策略</h3></div><div class="ns l"><p class="bd b fp z dy np ea eb nq ed ef dx translated">medium.com</p></div></div><div class="nt l"><div class="oa l nv nw nx nt ny jt nk"/></div></div></a></div><div class="nh ni ez fb nj nk"><a href="https://faun.pub/introduction-to-bitnami-sealed-secrets-bb5ae74d9a25" rel="noopener  ugc nofollow" target="_blank"><div class="nl ab dw"><div class="nm ab nn cl cj no"><h2 class="bd hj fi z dy np ea eb nq ed ef hh bi translated">比特纳米密封秘密介绍</h2><div class="nr l"><h3 class="bd b fi z dy np ea eb nq ed ef dx translated">如何使用Sealed Secrets和Kubese在GitHub中存储您的秘密</h3></div><div class="ns l"><p class="bd b fp z dy np ea eb nq ed ef dx translated">faun.pub</p></div></div><div class="nt l"><div class="ob l nv nw nx nt ny jt nk"/></div></div></a></div><div class="nh ni ez fb nj nk"><a rel="noopener follow" target="_blank" href="/swlh/introduction-to-jenkins-operator-f4cb7ebc2e0b"><div class="nl ab dw"><div class="nm ab nn cl cj no"><h2 class="bd hj fi z dy np ea eb nq ed ef hh bi translated">詹金斯算子简介</h2><div class="nr l"><h3 class="bd b fi z dy np ea eb nq ed ef dx translated">Kubernetes中的Jenkins运算符入门</h3></div><div class="ns l"><p class="bd b fp z dy np ea eb nq ed ef dx translated">medium.com</p></div></div><div class="nt l"><div class="oc l nv nw nx nt ny jt nk"/></div></div></a></div></div></div>    
</body>
</html>