<html>
<head>
<title>Using Hashicorp Vault as a Certificate issuer in Cert Manager</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在证书管理器中将Hashicorp Vault用作证书颁发者</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/using-hashicorp-vault-as-a-certificate-issuer-in-cert-manager-9e19d7239d3d?source=collection_archive---------0-----------------------#2022-01-16">https://medium.com/nerd-for-tech/using-hashicorp-vault-as-a-certificate-issuer-in-cert-manager-9e19d7239d3d?source=collection_archive---------0-----------------------#2022-01-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="7580" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在证书管理器中将vault PKI后端配置为证书提供商</p><p id="1feb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在我的<a class="ae jd" rel="noopener" href="/nerd-for-tech/free-and-automatic-ssl-certificates-in-kubernetes-using-cert-manager-6fb65ac63d5"> <strong class="ih hj">上一篇文章</strong> </a>中，我已经解释了如何使用let's encrypt作为证书颁发者。在本文中，我们将了解如何使用Hashicorp vault作为使用vault PKI和cert-manager的证书颁发者。PKI机密引擎生成动态X.509证书。使用这个vault PKI后端，用户可以获得证书，而不需要通过通常的手动过程来生成私钥和CSR，提交给CA，并等待验证和签名过程完成。证书通常在几秒钟内颁发。在本文中，我们将了解如何创建我们的根证书，并使用该证书对来自cert-manager的证书请求进行签名。</p><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es je"><img src="../Images/02f60f6645f327a6328a965298c80bc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v4ap4GTQbcSAgd-K"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图片来源:谷歌图片</figcaption></figure><h1 id="558b" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">整个故事是关于什么的？(TLDR)</h1><ol class=""><li id="d13a" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">创建我们自己的根CA。</li><li id="f0eb" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">使用Vault PKI作为证书颁发者，从证书管理器创建证书。</li></ol><h1 id="a955" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">先决条件</h1><ol class=""><li id="7695" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">Kubernetes集群(AKS、GKE、Kind、Local集群)。</li></ol><h1 id="ff64" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">故事资源</h1><ol class=""><li id="279f" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">GitHub链接:【https://github.com/pavan-kumar-99/medium-manifests T4】</li><li id="cc92" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">GitHub分支:<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/tree/cert-manager-vault" rel="noopener ugc nofollow" target="_blank"><strong class="ih hj">cert-manager-vault</strong></a></li></ol><h2 id="d1e4" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">使用舵图安装Hashicorp保险库</h2><p id="775f" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">我们将为金库安装官方头盔图，并手动解封。但是，这不是在生产环境中运行存储库的理想方式。您可能希望使用KMS密钥(如果安装在AWS中)或谷歌KMS密钥(如果安装在GCP)来解封保险库。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">掌舵安装PKI保险库</figcaption></figure><p id="5e65" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦安装了helm chart，您应该会发现创建了一个名为vault的有状态集合，还创建了一个名为<strong class="ih hj"> vault-0 </strong>的pod。但是，pod未处于就绪状态，这是因为保险库尚未启封。现在让我们通过执行进入吊舱来打开保险库。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">vault _ pki _开封. sh</figcaption></figure><p id="55d8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们理解init命令的作用</p><blockquote class="mb mc md"><p id="24a8" class="if ig me ih b ii ij ik il im in io ip mf ir is it mg iv iw ix mh iz ja jb jc hb bi translated">存储库操作员init-key-shares = 1-key-threshold = 1</p><p id="b9c1" class="if ig me ih b ii ij ik il im in io ip mf ir is it mg iv iw ix mh iz ja jb jc hb bi translated">-key-shares =要将生成的主密钥拆分成的密钥份额数。默认情况下，它是5，需要3把钥匙才能打开保险库</p><p id="58e8" class="if ig me ih b ii ij ik il im in io ip mf ir is it mg iv iw ix mh iz ja jb jc hb bi translated">-key-threshold =重建主密钥所需的密钥份额数。这必须小于或等于密钥份额。默认为3。</p></blockquote><h2 id="e678" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">生成根CA和中间CA</h2><p id="40f3" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">Vault PKI后端可以生成自己的自签名CA。但是让我们创建我们自己的CA，然后将它上传到vault PKI中，以签署我们的证书。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="27a9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在已经生成了我们的证书，现在让我们配置我们的vault PKI后端，以将这些证书添加为CA。我们还必须创建保管库角色以及保管库发布和CRL URLs。</p><h2 id="7407" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">配置保管库的PKI后端</h2><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="64b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们一个一个地理解这些命令</p><blockquote class="mb mc md"><p id="4076" class="if ig me ih b ii ij ik il im in io ip mf ir is it mg iv iw ix mh iz ja jb jc hb bi translated">vault登录$VAULT_ROOT_TOKEN =用于使用根令牌登录VAULT。</p><p id="1e19" class="if ig me ih b ii ij ik il im in io ip mf ir is it mg iv iw ix mh iz ja jb jc hb bi translated">vault secrets enable pki =用于启用vault pki后端。</p><p id="2807" class="if ig me ih b ii ij ik il im in io ip mf ir is it mg iv iw ix mh iz ja jb jc hb bi translated">vault secrets tune-max-lease-ttl = 8760h pki =我们将PKI后端的TTL配置为8760小时。</p><p id="c4cb" class="if ig me ih b ii ij ik il im in io ip mf ir is it mg iv iw ix mh iz ja jb jc hb bi translated">vault write PKI/config/ca PEM _ bundle = @ PEM _ bundle ttl = 8760h = &gt;我们正在将CA证书写入vault，并将其TTL设置为8760h</p></blockquote><p id="380d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，我们已经将PKI证书上传到了保险库中。现在让我们创建一个Vault PKI角色。角色定义设置生成证书的条件。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="64c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一旦创建了角色，我们就应该配置可以颁发和撤销证书的端点。</p><p id="25c8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，让我们为相应的vault PKI角色创建一个vault策略。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div></figure><h2 id="7cbf" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">启用Kubernetes身份验证方法</h2><p id="f95e" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">Kubernetes auth方法可用于使用Kubernetes服务帐户令牌对vault进行身份验证。这将帮助保管库将保管库令牌注入到Kubernetes Pod中。为此，让我们通过exec在pod中启用vault Kubernetes后端，因为必须从vault pod中传递<strong class="ih hj">令牌_reviewer_jwt </strong>。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div></figure><p id="ae20" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在已经创建了一个Kubernetes auth角色。此角色被绑定到服务帐户名issuer和名为default的命名空间以及先前创建的名为betttercallpavan_pki的策略。</p><h2 id="1d7a" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">安装证书管理器舵图</h2><p id="7a8e" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">让我们知道在我们的集群上安装证书管理器的舵图。</p><pre class="jf jg jh ji fd mi mj mk ml aw mm bi"><span id="21b5" class="li jv hi mj b fi mn mo l mp mq">$ helm repo add jetstack <a class="ae jd" href="https://charts.jetstack.io/" rel="noopener ugc nofollow" target="_blank">https://charts.jetstack.io</a></span><span id="af9d" class="li jv hi mj b fi mr mo l mp mq">$ helm repo add jetstack <a class="ae jd" href="https://charts.jetstack.io/" rel="noopener ugc nofollow" target="_blank">https://charts.jetstack.io</a></span><span id="7bd0" class="li jv hi mj b fi mr mo l mp mq">$ helm install \<br/>  cert-manager jetstack/cert-manager \<br/>  --namespace cert-manager \<br/>  --version v1.2.0 \<br/>  --create-namespace \<br/>  <em class="me">--set installCRDs=true</em></span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div role="button" tabindex="0" class="jk jl di jm bf jn"><div class="er es ms"><img src="../Images/2093b992a3f095e3206494c03104b538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0GiXYdj3g73yHbRF"/></div></div><figcaption class="jq jr et er es js jt bd b be z dx translated">图片来源:谷歌图片</figcaption></figure><h2 id="1f52" class="li jv hi bd jw lj lk ll ka lm ln lo ke iq lp lq ki iu lr ls km iy lt lu kq lv bi translated">正在生成证书</h2><p id="a267" class="pw-post-body-paragraph if ig hi ih b ii ku ik il im kv io ip iq lw is it iu lx iw ix iy ly ja jb jc hb bi translated">现在让我们创建发行者。<code class="du mt mu mv mj b">Issuers</code>和<code class="du mt mu mv mj b">ClusterIssuers</code>是Kubernetes资源，代表可以通过接受证书签名请求来生成签名证书的证书颁发机构(ca)。所有证书管理器证书都需要处于就绪状态的引用颁发者来尝试满足请求。一个<code class="du mt mu mv mj b">Issuer</code>是一个命名空间资源，不可能从不同的命名空间中的<code class="du mt mu mv mj b">Issuer</code>颁发证书。</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div></figure><pre class="jf jg jh ji fd mi mj mk ml aw mm bi"><span id="f6d6" class="li jv hi mj b fi mn mo l mp mq">$ git clone <a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b cert-manager-vault</span><span id="9381" class="li jv hi mj b fi mr mo l mp mq">$ cd medium-manifests</span><span id="4ba6" class="li jv hi mj b fi mr mo l mp mq">$ kubectl apply -f vault-pki-issuer.yaml</span></pre><p id="392e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在创建证书</p><figure class="jf jg jh ji fd jj"><div class="bz dy l di"><div class="lz ma l"/></div></figure><pre class="jf jg jh ji fd mi mj mk ml aw mm bi"><span id="627d" class="li jv hi mj b fi mn mo l mp mq">$ kubectl apply -f vault-issuer-cert.yaml</span></pre><p id="35e9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，一旦发送了证书请求，您应该会看到在创建证书资源的名称空间中创建了K8s秘密。现在，证书可以被任何客户机/服务器使用。</p><pre class="jf jg jh ji fd mi mj mk ml aw mm bi"><span id="1dac" class="li jv hi mj b fi mn mo l mp mq">$ kubectl get secret bettercallpavan-com-tls -n default</span></pre><p id="8912" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们现在将部署一个示例nginx应用程序来验证我们的证书。</p><pre class="jf jg jh ji fd mi mj mk ml aw mm bi"><span id="f44e" class="li jv hi mj b fi mn mo l mp mq">$ kubectl apply -f app.yaml</span><span id="c963" class="li jv hi mj b fi mr mo l mp mq">$ ip=$(k get ing certmanagerapp-ingress -o jsonpath='{.status.loadBalancer.ingress[0].ip}')</span><span id="e87e" class="li jv hi mj b fi mr mo l mp mq">$ echo | openssl s_client -connect $ip:443 2&gt;/dev/null | openssl x509 -noout -issuer</span><span id="1075" class="li jv hi mj b fi mr mo l mp mq">issuer=O = Acme Co, CN = www.bettercallpavan.com</span></pre><figure class="jf jg jh ji fd jj er es paragraph-image"><div class="er es mw"><img src="../Images/61c3861ff3b83bfb7d580b76c1a80613.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/0*gASKEbyFpdunPyup.gif"/></div><figcaption class="jq jr et er es js jt bd b be z dx translated">惊讶吗？</figcaption></figure><p id="ceb6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">是的，这些是在证书管理器中将Vault用作证书颁发者所需的所有步骤。我希望你喜欢这篇文章。欢迎在评论区分享你的想法和使用Hashicorp Vault PKI的经验。如果您在部署过程中遇到任何问题，请在此处提出问题<a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests/issues" rel="noopener ugc nofollow" target="_blank"/>或随时通过我的电子邮件联系我(pavan1999.kumar@gmail.com)。</p><p id="b229" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih hj">清理</strong></p><pre class="jf jg jh ji fd mi mj mk ml aw mm bi"><span id="a9ad" class="li jv hi mj b fi mn mo l mp mq">$ git clone <a class="ae jd" href="https://github.com/pavan-kumar-99/medium-manifests.git" rel="noopener ugc nofollow" target="_blank">https://github.com/pavan-kumar-99/medium-manifests.git</a> \<br/>-b cert-manager-vault</span><span id="b399" class="li jv hi mj b fi mr mo l mp mq">$ cd medium-manifests</span><span id="6382" class="li jv hi mj b fi mr mo l mp mq">$ kubectl delete -f ./*</span><span id="b462" class="li jv hi mj b fi mr mo l mp mq">$ kubectl delete secret bettercallpavan-com-tls -n default</span></pre><h1 id="660c" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论</h1><ol class=""><li id="14bf" class="ks kt hi ih b ii ku im kv iq kw iu kx iy ky jc kz la lb lc bi translated">Cert-Manager可用于获取有效期为90天的免费SSL证书。</li><li id="b5db" class="ks kt hi ih b ii ld im le iq lf iu lg iy lh jc kz la lb lc bi translated">这些证书可以在到期后一个月内自动尝试更新。</li></ol><p id="4fad" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是我的一些其他文章，你可能会感兴趣</p><p id="4442" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">直到下一次…..</p><h1 id="38e3" class="ju jv hi bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">被推荐的</h1><div class="mx my ez fb mz na"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/deep-dive-into-cortex-part-i-c228e01f8c58"><div class="nb ab dw"><div class="nc ab nd cl cj ne"><h2 class="bd hj fi z dy nf ea eb ng ed ef hh bi translated">深入探究皮层指标—第一部分</h2><div class="nh l"><h3 class="bd b fi z dy nf ea eb ng ed ef dx translated">深入探究Cortex Metrics.io第一部分</h3></div><div class="ni l"><p class="bd b fp z dy nf ea eb ng ed ef dx translated">medium.com</p></div></div><div class="nj l"><div class="nk l nl nm nn nj no jo na"/></div></div></a></div><div class="mx my ez fb mz na"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/running-apache-spark-on-eks-with-aws-spot-instances-f8ce91d319b9"><div class="nb ab dw"><div class="nc ab nd cl cj ne"><h2 class="bd hj fi z dy nf ea eb ng ed ef hh bi translated">使用AWS Spot实例在EKS上运行Apache Spark</h2><div class="nh l"><h3 class="bd b fi z dy nf ea eb ng ed ef dx translated">通过AWS Spot实例为EKS上的Apache Spark工作负载有效节约成本</h3></div><div class="ni l"><p class="bd b fp z dy nf ea eb ng ed ef dx translated">medium.com</p></div></div><div class="nj l"><div class="np l nl nm nn nj no jo na"/></div></div></a></div><div class="mx my ez fb mz na"><a rel="noopener follow" target="_blank" href="/nerd-for-tech/deep-dive-into-thanos-part-i-f72ecba39f76"><div class="nb ab dw"><div class="nc ab nd cl cj ne"><h2 class="bd hj fi z dy nf ea eb ng ed ef hh bi translated">深入灭霸——第一部分</h2><div class="nh l"><h3 class="bd b fi z dy nf ea eb ng ed ef dx translated">使用灭霸和普罗米修斯操作员监控Kubernetes的工作负载</h3></div><div class="ni l"><p class="bd b fp z dy nf ea eb ng ed ef dx translated">medium.com</p></div></div><div class="nj l"><div class="nq l nl nm nn nj no jo na"/></div></div></a></div><div class="mx my ez fb mz na"><a href="https://www.techmanyu.com/creating-self-hosted-github-runners-in-a-kubernetes-cluster-fd05560de34a" rel="noopener  ugc nofollow" target="_blank"><div class="nb ab dw"><div class="nc ab nd cl cj ne"><h2 class="bd hj fi z dy nf ea eb ng ed ef hh bi translated">在Kubernetes集群中创建自托管GitHub运行程序</h2><div class="nh l"><h3 class="bd b fi z dy nf ea eb ng ed ef dx translated">在您自己的Kubernetes集群上运行GitHub操作</h3></div><div class="ni l"><p class="bd b fp z dy nf ea eb ng ed ef dx translated">www.techmanyu.com</p></div></div><div class="nj l"><div class="nr l nl nm nn nj no jo na"/></div></div></a></div></div></div>    
</body>
</html>