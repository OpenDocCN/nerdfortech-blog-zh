<html>
<head>
<title>Pwning a Backend with a Backdoor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用后门程序运行后端程序</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/pwning-a-backend-with-a-backdoor-1e0d5b3e9b72?source=collection_archive---------6-----------------------#2021-05-31">https://medium.com/nerd-for-tech/pwning-a-backend-with-a-backdoor-1e0d5b3e9b72?source=collection_archive---------6-----------------------#2021-05-31</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8f4d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">发展是一项重要任务。但是有意识的安全发展更为重要。在这篇简短的博文中，我详细介绍了一种不寻常的方法，通过这种方法，我能够在一个适当安全的网络后面提升对几个生产实例的访问。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/38863006f8eca71f45d3f5a7d103fc7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ndJucQiomuW764Vlauw85g.png"/></div></div></figure><h1 id="8a74" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">怎么开始的。</h1><p id="7700" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">这一切都是从我在GitHub上为一个工具偶然检查一些流量数据开始的。GitHub允许您查看过去14天的一些统计数据，即。知识库中的访问者、克隆人等。</p><p id="21c1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">一个特别有趣的推荐网站URL引起了我的注意:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ks"><img src="../Images/dfa570324b97e3ef27c1b05f1f252073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lecEGIwFddfz7S-kZAkgQQ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">GitHub存储库统计</figcaption></figure><p id="852a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你是如何抵御这样的诱惑的？不管怎样，我上钩了，开始挖。</p><p id="b87c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这种情况下，我总是做的第一件事是验证我的目标站点是否有安全联系人。这对<em class="kx">避免</em>陷入法律纠纷非常重要。幸运的是，这有一个独立的VDP运行，所以我决定继续前进。</p><p id="1f28" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里出现的一个明显的问题是，这个特定的URL是如何出现在统计页面上的？很明显，有人从某个“仪表板”上点击了指向这个存储库的链接。根据我的理解，GitHub从浏览器发送的<code class="du ky kz la lb b">Referer </code>头中积累这些流量统计数据，其中包含了发出请求的前一个网页的URL。所以可以相当安全地假设他们有某种“仪表板”,其中包含可以点击的链接。</p><h1 id="78ee" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">映射目标。</h1><p id="f391" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">我花了半个小时试图绘制目标地图。对它所指向的IP进行快速nmap快速扫描，发现两个开放的端口，都运行HTTP— <code class="du ky kz la lb b">3000, 8008</code>。我的第一反应是Grafana——因为<code class="du ky kz la lb b">3000 </code>通常是Grafana实例的默认端口。然而，事实证明并非如此。在浏览器中访问<code class="du ky kz la lb b">http://redacted.com:3000</code> <em class="kx"> </em>毫无结果，浏览器只是显示“重定向太多”错误。我认为这可能是一个生产实例，所以它被适当地保护在ACL后面。</p><p id="d260" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我决定快速启动<a class="ae lc" href="https://github.com/ffuf/ffuf" rel="noopener ugc nofollow" target="_blank"> <em class="kx"> ffuf </em> </a>并为端口<code class="du ky kz la lb b">8008</code> ( <code class="du ky kz la lb b"><a class="ae lc" href="https://github.com/duyet/bruteforce-database" rel="noopener ugc nofollow" target="_blank">bruteforce-database</a></code>是我在生产服务器上发现内容的最爱之一)做一些基本的内容枚举。几分钟后，这是我看到的终端画面:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es ld"><img src="../Images/ad83737b6f4fa6d4781131b4f555e752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FY4HSScSP4npdXtt-Y0O7Q.png"/></div></div></figure><p id="fedc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有趣的权利，让我们访问我们的浏览器中的路径？当我被重定向了几次后，我惊讶地发现这个页面位于一个完全不同的子域(<code class="du ky kz la lb b">https://monitoring.redacted.com/dashboards</code>)。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es le"><img src="../Images/22c29d13e87c4d46c41b78123fa1f2c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OgjkOKSQcAkffjMhAI29ug.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">等等，什么？巧合吗？</figcaption></figure><p id="a6b9" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">稍微摆弄了一下，但仔细地看，我发现我是以管理员权限登录的。我可以删除仪表板，创建/删除新的播放列表和快照，当然还可以查看几个生产服务器的敏感监控数据。此外，仪表盘还显示了一个相关的Prometheus REST代理API，该API完全未经身份验证。我以前不熟悉<em class="kx"> PromQL </em>，所以在<a class="ae lc" href="https://promlabs.com/promql-cheat-sheet/" rel="noopener ugc nofollow" target="_blank">读到它</a>之后，我想我可以通过API提取更多敏感数据。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lf"><img src="../Images/1c3a710ed6899e7059f39b83f6cd8311.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*By7kpmok0oevDqwp2WUdBA.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">通过Prometheus API提取内部网络信息</figcaption></figure><p id="9227" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就在这时，我停止了测试，并决定将我的发现报告给安全联系人的电子邮件。</p><h1 id="000c" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">但是等等，那里发生了什么？</h1><p id="31fa" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">当涉及到我遇到的奇怪的错综复杂时，网络应用经常让我着迷。这一个也不例外，真的引起了我的注意。我决定深入调查是什么引发了这种行为。长话短说，我的结论是,<code class="du ky kz la lb b">/cont_useradmin/</code>路径以某种方式充当了一个代理，它给了我对他们内部VPN的<em class="kx">认证</em>访问，这就是为什么我能够以管理员权限直接访问Grafana监控仪表板。<strong class="ih hj">已验证的</strong>——因为很少有额外的头以某种方式与请求中的默认头集一起添加:</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lg"><img src="../Images/19264155c7e89f3fe2bb3483c16ed3d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4mb6eritxrQ0--gf43xGDA.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">请求和响应捕获</figcaption></figure><p id="a67a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然而，这显然没有满足我的好奇心，所以我礼貌地问安全联系人，让我知道到底是什么导致了这种行为。几天后，我收到了回复，说他们已经修复了这个问题，并给了我一个开发者联系人，我可以从他那里得到我的问题的答案。和他交谈了几句，我终于了解了事情的全貌。</p><p id="ee34" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">原来我接入的确实是一个故意引入的<em class="kx">开发者后门</em>。造成这种情况的实际原因是端口<code class="du ky kz la lb b">8008 </code>上的nginx服务器配置错误，允许开发人员(暗示任何人)直接访问生产环境进行调试。他很坦率地承认，他直接从一个在线论坛的答案中实现了配置文件，而没有真正理解该场景的安全上下文。</p><p id="5569" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">HTTP服务器的<em class="kx"> nginx.conf </em>文件如下所示:</p><pre class="je jf jg jh fd lh lb li lj aw lk bi"><span id="c46b" class="ll jq hi lb b fi lm ln l lo lp">user              www-data;<br/>worker_processes  1;<br/>error_log         /var/log/nginx/error.log;<br/>pid               /var/run/nginx.pid;<br/><br/>events {<br/>  worker_connections  1024;<br/>}</span><span id="c1f7" class="ll jq hi lb b fi lq ln l lo lp">...snip...</span><span id="10ac" class="ll jq hi lb b fi lq ln l lo lp">http {<br/>  include            /etc/nginx/mime.types;<br/>  access_log         /var/log/nginx/access.log;<br/>  sendfile           on;<br/>  keepalive_timeout  65;<br/>  tcp_nodelay        on;<br/><br/>  server {<br/>    listen      *:8008;<br/>    access_log  /var/log/nginx/access.8008.log;<br/>    location    /cont_useradmin/ {<br/>      rewrite           /cont_useradmin(.*) $1 break;<br/>      proxy_pass        http://172.20.0.1:60000;<br/>      proxy_redirect    off;<br/>      proxy_set_header  Host             $host;<br/>      proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;<br/>      proxy_set_header  X-Ingress-Token  <!-- -->e44c571c-e313-4720-80ed-ee13ed4eebe4<br/>        }<br/>    }<br/>}</span><span id="ccf3" class="ll jq hi lb b fi lq ln l lo lp">...snip...</span></pre><p id="2d43" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">已经注意到什么不对了吗？让我把它分解一下。该配置将任何<em class="kx">请求转发到端口<code class="du ky kz la lb b">8008</code>上的<code class="du ky kz la lb b">/cont_useradmin/</code>端点，以及带有<code class="du ky kz la lb b">X-Ingress-Token </code>认证报头的内部IP <code class="du ky kz la lb b">172.20.0.1:60000 </code>。端口<code class="du ky kz la lb b">60000</code>托管着一个内部路由器守护进程，它映射了所有的内部生产端点。该路由器不可公开访问，并接受来自特定白名单IP的连接，并进行适当的身份验证，即开发人员有意嵌入nginx配置中的<code class="du ky kz la lb b">X-Ingress-Token </code>报头。</em></p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es lr"><img src="../Images/85796ce384a4d10a70b6dac37b9063f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1kfx81CPCgP1LSwnlUpYdQ.png"/></div></div><figcaption class="kt ku et er es kv kw bd b be z dx translated">整体攻击面可视化</figcaption></figure><p id="0df5" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，路由器看到我已经通过了身份验证，并且正在尝试访问<em class="kx"> dashboard-prod </em>子域，它根据它的映射配置将我重定向到Grafana实例。此外，所有通过路由器的请求都被明确列入白名单，这意味着我实际上是作为一名管理员。</p><p id="fa3e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">开发人员解释说，这是一个自托管的吉拉板，我的GitHub库的链接就是从这里开始的。默认情况下，路由器通过我在GitHub的统计页面上看到的<code class="du ky kz la lb b">dashboard-prod </code>子域映射所有来自内部HTTP端点的出站HTTP流量。</p><h1 id="f15a" class="jp jq hi bd jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km bi translated">外卖食品</h1><h2 id="9881" class="ll jq hi bd jr ls lt lu jv lv lw lx jz iq ly lz kd iu ma mb kh iy mc md kl me bi translated">对于开发人员</h2><p id="4c25" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">发展的确是一项艰巨的任务，但确保安全更为重要。尽管开发人员采取了相当多的措施来保护他们的生产环境，将它放在VPN之后，我仍然能够通过简单的错误配置访问他们的内部网络。开发者后门很酷，允许快速访问，但如果其他人发现它，可能会致命——因为他们通常拥有较高的特权级别。</p><p id="467b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在几个地方实现访问控制也是一个很好的做法。在这种情况下，路由器映射的每个服务都应该有额外的身份验证，从本质上防止横向移动。我本可以通过查询来探测路由器，从而找到更敏感的服务，因此可能会破坏他们的内部网络。想象一下这样一个简单的错误会导致如此毁灭性的结果。</p><p id="196f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这里有一个有趣的引用，来自评论这篇文章的Somdev(感谢他！):</p><blockquote class="mf"><p id="8ce0" class="mg mh hi bd mi mj mk ml mm mn mo jc dx translated">有后门的后端只是前门。</p></blockquote><h2 id="ecab" class="ll jq hi bd jr ls mp lu jv lv mq lx jz iq mr lz kd iu ms mb kh iy mt md kl me bi translated">对于安全人员</h2><p id="a06c" class="pw-post-body-paragraph if ig hi ih b ii kn ik il im ko io ip iq kp is it iu kq iw ix iy kr ja jb jc hb bi translated">永远不要退而求其次。总是留意网络应用程序中的怪异行为，并试着改变它。你可能会在最意想不到的地方发现一些东西。</p><p id="1843" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">就是这样！经过深思熟虑，我在此总结。下次见。干杯！🥂</p></div></div>    
</body>
</html>