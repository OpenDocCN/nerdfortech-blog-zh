<html>
<head>
<title>Subnet-to-Subnet SNAT/DNAT on Fortinet Firewalls with Central NAT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带中央NAT的Fortinet防火墙上的子网到子网SNAT/DNAT</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/subnet-to-subnet-snat-dnat-on-fortinet-firewalls-with-central-nat-604a6102b21f?source=collection_archive---------0-----------------------#2021-04-26">https://medium.com/nerd-for-tech/subnet-to-subnet-snat-dnat-on-fortinet-firewalls-with-central-nat-604a6102b21f?source=collection_archive---------0-----------------------#2021-04-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="7c7b" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">在Fortinet防火墙上实现SNAT/DNAT从来没有像在Checkpoint等其他平台上那样简单，在我看来，至少在引入中央NAT之前是这样。让我们看看如何使用虚拟化(DNAT)和固定端口范围的IP池(SNAT)，通过确定性映射实现子网到子网的一对一转换。</h2></div><h2 id="8c73" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">介绍</h2><p id="16b2" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">我最近不得不将一些防火墙安全和NAT规则从Checkpoint迁移到Fortinet防火墙，并且由于这两种技术的不同行为而面临一些挑战。Checkpoint首先应用安全策略(至少是我正在使用的版本)，然后检查NAT策略并应用源和目的地NAT。相反，Fortinet有不同的操作顺序，更像带有Iptables的Linux:数据包从传入接口到达，有一个预路由步骤，其中目的地NAT(从现在起DNAT)发生，遵循确定传出接口的路由决策(因为现在最终目的地是已知的)，安全策略(IPv4策略)被检查，最后源NAT(从现在起SNAT)发生，数据包可以在传出接口上发送出去(更多细节可以在此处找到<a class="ae ko" href="https://docs.fortinet.com/document/fortigate/6.2.0/parallel-path-processing-life-of-a-packet/86811/packet-flow-ingress-and-egress-fortigates-without-network-processor-offloading" rel="noopener ugc nofollow" target="_blank"/>，我已经省略了许多其他中间步骤)。</p><p id="6561" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">在规则的迁移过程中，我有必要实现SNAT和DNAT规则，用确定性映射将一个/22网络映射到另一个/22网络。下面我们来举个例子:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ku"><img src="../Images/155943fd9f3fa531e7e59ed88a96dea5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DdQ_vbYN11iuqFV9MKgIZQ.png"/></div></div></figure><p id="fdbc" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">右侧是合作伙伴的网络10.0.100.0/22(即IP范围从10.0.100.0到10.0.103.255 ),我们的防火墙有一条已知路由。我们有一些规则，要求从左侧网络到合作伙伴网络的通信必须通过别名网络10.0.200.0/22，该网络在我们的网络中路由到我们的边界防火墙。重要的是，在两个方向上的映射必须是确定性的，即10.0.101.55必须映射到10.0.201.55，反之亦然，或者以更一般的方式，10.0.10x.y必须映射到10.0.20x.y(反之亦然)。更复杂的是，从合作伙伴网络到我们的SNAT必须只发生在10.0.100.0/22范围内的一些IP上。</p><p id="cf0c" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">注意:显示的示例和图像取自<strong class="jx hj"> FortiManager </strong>，这是用于管理FortiGate防火墙的接口/虚拟机。您可以在FortiGate防火墙上直接应用相同的概念(可能术语略有不同)。</p><h2 id="5b9b" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated"><strong class="ak">中央国家公园</strong></h2><p id="5a7b" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">正如我之前提到的，在Fortinet FortiGate防火墙上实施DNAT和SNAT从未像在其他平台上那样简单，但他们在中央NAT方面向前迈出了一大步，在标准IPv4表中添加了两个策略表，这些表包含我们通常在FortiManager上拥有的安全规则。仍然有一些东西使人想起配置nat的老方法(中央DNAT规则创建以前用于实现DNAT的VirtualIP对象，但是现在您不必在标准安全规则中将它们应用为目的地)，但是它更容易使用和阅读(并且不容易出错)。</p><h2 id="03a5" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated"><strong class="ak">安全规则</strong></h2><p id="6cb5" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">正如我以前解释过的，DNAT发生在安全策略被评估之前，所以当你写安全策略时，你必须考虑到DNAT已经转换了目的地址。相反，SNAT还没有发生，所以必须使用原始源地址。为了实现上图所示的双向通信，我们需要两条规则:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lg"><img src="../Images/86bef3623bfc361421456f29008a3837.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*et0CMpRbNncCVRsK-NknzQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">IPv4安全策略</figcaption></figure><p id="a65c" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">如您所见，规则<em class="ll"> #1 </em>将10.0.100.0/22作为目的地，因为从10.0.200.0/22到10.0.100.0/22的DNAT已经被应用。</p><h2 id="c548" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated"><strong class="ak"> DNAT </strong></h2><p id="d852" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">DNAT很容易实现，它需要在中央DNAT表中有一个规则，这又会创建一个VIP对象:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lm"><img src="../Images/b36b6e639623d0a9252da76256e20720.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v13Evs2aaq6FmrkoMPN6RQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">DNAT 10.0.200.0/22至10.0.100.0/22</figcaption></figure><p id="87a4" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">如您所见，您设置了我们“知道”的/22网络的IP地址范围，然后您只指定了合作伙伴的真实映射(或内部)网络的第一个地址。GUI计算该网络的最终IP，以获得一对一的静态和确定性映射。</p><h2 id="66a3" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">SNAT和固定端口范围IP池</h2><p id="a9e9" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">我在实现相反的方面遇到了一些挑战，因为为了从旧的防火墙中迁移规则，我们必须能够实现10.0.10x.y到10.0.20x.y IP地址的确定性SNAT，但仅限于特定的来源。源NAT是在中央SNAT表中实现的，在该表中，您可以编写一个类似于安全策略的策略，指定流量的源/目的地地址和端口以进行匹配(与后DNAT目的地相匹配)，然后您可以选择将流量SNAT到传出接口的IP或<em class="ll"> IP池</em>。IP池可以有不同的种类:<em class="ll">过载</em>、<em class="ll">一对一</em>、<em class="ll">固定端口范围</em>和<em class="ll">端口阻塞分配</em>。<em class="ll">一对一</em>对我来说似乎是正确的，因为我们希望在两个子网之间实现一对一的映射……但该对象允许您指定单一范围的IP地址，因此FortiGate无法知道哪个源IP(这是您在中央SNAT策略中指定的内容，一个单独的对象)将被映射到IP池对象中指定的IP上。因此，在我的第一个测试中，我实施了一个集中的SNAT策略，该策略规定“来自测试外部且源IP在10.0.100.0/22中的流量必须被捕获到指定10.0.200.0/22为范围的IP池一对一对象上”。然后我做了一些测试，从10.0.100.10到10.0.200 <strong class="jx hj"> .1 </strong>的一个流，从10.0.100.x到10.0.200 <strong class="jx hj"> .2 </strong>的第二个流等等，所以我不能实现我需要的确定性的1对1映射。</p><p id="a4a5" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">我搜索了一下文档，了解了<em class="ll">固定端口范围IP-Pool </em>对象的工作原理:固定端口范围允许您将a /22网络映射到a /24网络，因此IP地址比例为4:1，以确定的方式为每个IP保留1/4的端口。你可以在官方Fortinet文档中找到更多细节。你能看到的是，如果你在真实网络和映射网络之间有1:1的IP地址比例，你可以实现10.0.10 <em class="ll"> x.y </em>端口<em class="ll"> w </em>到10.0.20 <em class="ll"> x.y </em>端口<em class="ll"> w </em>的确定性1对1映射，具有固定的端口范围SNAT。</p><p id="6349" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">以下公式可在官方文件的第<em class="ll">节公式</em>中找到:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ln"><img src="../Images/3f5bb0eeac6d443439e6135f4fe03315.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zycJKAblQoCx5lh8yvuUcQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">图片取自<a class="ae ko" href="https://docs.fortinet.com/document/fortigate/5.4.0/cookbook/414467/fixed-port-range-ip-pools-algorithm" rel="noopener ugc nofollow" target="_blank">https://docs . fortinet . com/document/fortigate/5 . 4 . 0/cookbook/414467/fixed-port-range-IP-pools-algorithm</a></figcaption></figure><p id="d887" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">让我们尝试一下我们的特定案例，合作伙伴的源IP为10.0.102.55:</p><pre class="kv kw kx ky fd lo lp lq lr aw ls bi"><span id="3d7a" class="ix iy hi lp b fi lt lu l lv lw"><strong class="lp hj">factor</strong> = (10.0.103.255–10.0.100.0 + 10.0.203.255–10.0.200.0 + 1) / (10.0.203.255–10.0.200.0 + 1) = (1024 + 1024 + 1) / (1024 + 1) = 2049 / 1025 = 1,999024 = <strong class="lp hj">1</strong> (there is an integer conversion that cuts the decimal part)</span><span id="a3da" class="ix iy hi lp b fi lx lu l lv lw"><strong class="lp hj">new IP</strong> = 10.0.200.0 + (<strong class="lp hj">10.0.102.55</strong>–10.0.100.0) / <strong class="lp hj">1</strong> = 10.0.200.0 + (256 + 256 + 55) = <strong class="lp hj">10.0.202.55</strong></span></pre><p id="f211" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">给你:<em class="ll"> 10.0.102.55翻译成10.0.202.55 </em>！答对了。</p><p id="abe2" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">子网和IP地址的数学运算一开始可能看起来不那么直观，但是在我展示的这个例子中应该非常清楚。</p><p id="8ede" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">如下图所示，使用固定端口范围，您可以通过告诉FortiManager什么是外部IP范围(我方已知的IP地址)和内部(或映射的)IP地址(合作伙伴网络上的真实IP地址)来指定确切的映射:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ly"><img src="../Images/b59887e077b2aefa3c4667d166366c25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HA09ubH5IGyXIoubLOIrBA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">固定端口范围IP池</figcaption></figure><p id="dc13" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">现在，我们可以在中央SNAT规则中使用这个IP池对象，确定我们希望确定性NAT发生在合作伙伴网络的哪些IP地址上:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es lz"><img src="../Images/b2daf505b5abcdf2b8b87ef9ee6db770.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QwxupnC4I2BlK87e6ZRsLA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">中央SNAT规则详细信息</figcaption></figure><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es ma"><img src="../Images/ec0e9d51b6528ca8521f7df9e7f3713c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MQtaohFI_7KiA37Vi3JvAQ.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">中央SNAT规则</figcaption></figure><p id="3dca" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">显然，您可以用3条规则实现上述SNAT，每条规则都有自己的过载/一对一IP池，将单个IP转换到相应的IP上，但在我的示例中，您有一个确定性的从原始/22网络到目标/22网络的一对一映射，然后您用SNAT策略来确定它何时发生。</p><p id="079c" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">根据上面的规则，来自10.0.100.5的流量到达我们的网络，其源为10.0.200.5，这是意料之中的，而来自10.0.101.100的流量到达时使用其原始IP地址，因为它与中央SNAT策略不匹配。</p><p id="be9c" class="pw-post-body-paragraph jv jw hi jx b jy kp ij ka kb kq im kd ji kr kf kg jm ks ki kj jq kt kl km kn hb bi translated">在一个更简单的设置中，您可以通过在中央SNAT规则中将SNAT设置为源地址，使其适用于整个10.0.100.0/22:</p><figure class="kv kw kx ky fd kz er es paragraph-image"><div role="button" tabindex="0" class="la lb di lc bf ld"><div class="er es mb"><img src="../Images/eee324ad2a84d2cf02d6b016a380dd51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*knmGo_wgHpBEsSoCg1u9Mw.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx translated">整个合作伙伴网络的SNAT</figcaption></figure><h2 id="fc54" class="ix iy hi bd iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju bi translated">结论</h2><p id="9ade" class="pw-post-body-paragraph jv jw hi jx b jy jz ij ka kb kc im kd ji ke kf kg jm kh ki kj jq kk kl km kn hb bi translated">我想分享这一点知识，因为我在找到子网间这种确定性SNAT问题的解决方案之前有些头疼，也许它对那些从未想过(像我一样)使用<em class="ll">固定端口范围</em> <em class="ll"> IP池</em>对象来实现它的人有用，直到我阅读了文档并理解了它在我们IP地址比率为1:1的情况下是如何工作的。</p></div></div>    
</body>
</html>