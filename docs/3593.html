<html>
<head>
<title>Everything about databases — How to implement Sequelize? [Part-2]</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于数据库的一切——如何实现 Sequelize？[第二部分]</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/everything-about-databases-how-to-implement-sequelize-part-2-23f2df3eaf47?source=collection_archive---------10-----------------------#2021-06-15">https://medium.com/nerd-for-tech/everything-about-databases-how-to-implement-sequelize-part-2-23f2df3eaf47?source=collection_archive---------10-----------------------#2021-06-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/b064bde1df8f87636838e3047d10c325.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CXkW09ru573y6YNYl3OiIg.png"/></div></div></figure><div class=""/><h1 id="68ce" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">前一篇文章的总结</h1><p id="a282" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">感谢<a class="ae km" href="https://faraz-faraji.medium.com/everything-about-databases-how-to-choose-part-1-35a7d1a0c9d1" rel="noopener"> <strong class="jq hu"> Part-1 </strong> </a>我们可以决定使用哪个数据库更好，之后我们已经讨论了在我们的操作系统中通过 docker 运行 Postgres。</p><h1 id="0112" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated"><strong class="ak">什么是 ORM </strong></h1><p id="8f91" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi kn translated"><span class="l ko kp kq bm kr ks kt ku kv di">正如我在<a class="ae km" href="https://www.instagram.com/p/CQGpSEeD_j6/?utm_source=ig_web_button_share_sheet" rel="noopener ugc nofollow" target="_blank">中提到的</a></span>我的 Instagram 帖子 ORM 是一个工具，你可以轻松地连接到你的数据库，并获取你想要的数据。获得更容易的数据不仅仅是使用 ORM 的目的，还有，增加安全性(SQL 注入)，清洁代码，避免硬代码，以及许多其他有价值的事情。由于这些原因，我们将继续通过 ORM 使用数据库。</p><p id="cc28" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">我们有很多针对 node js 的 ORM 工具，比如<a class="ae km" href="https://typeorm.io" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hu"> typeORM </strong> </a>和<a class="ae km" href="http://sequelize.org" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hu"> sequelize </strong> </a>。</p><h1 id="0f1f" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">熟悉一些术语</h1><h2 id="75e5" class="lb ir ht bd is lc ld le iw lf lg lh ja jz li lj je kd lk ll ji kh lm ln jm lo bi translated">1-迁移:(模式迁移)</h2><p id="c45d" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">正如<a class="ae km" href="https://en.wikipedia.org/wiki/Schema_migration" rel="noopener ugc nofollow" target="_blank">维基百科</a>所解释的:</p><blockquote class="lp lq lr"><p id="6b7d" class="jo jp ls jq b jr kw jt ju jv kx jx jy lt ky kb kc lu kz kf kg lv la kj kk kl hb bi translated">在软件工程中，模式迁移是指对关系数据库模式的增量、可逆更改和版本控制的管理。每当需要将数据库的模式更新或恢复到某个较新或较旧的版本时，都会在数据库上执行模式迁移。</p></blockquote><p id="232a" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">这意味着迁移类似于表的版本控制器(例如 Git)。如果您想要添加一个新列，您可以很容易地将其添加到您的迁移文件中，并且它将自动影响您的表。</p><p id="472e" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">没有必要使用迁移，但最好在您的项目中使用。</p><h2 id="7d6f" class="lb ir ht bd is lc ld le iw lf lg lh ja jz li lj je kd lk ll ji kh lm ln jm lo bi translated">双种子:</h2><p id="3020" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">假设您创建了一个表来插入您的用户数据，但是您需要其上的数据来编写测试函数。一种方法是手动向表中添加数据。但是另一种方法是使用种子数据来填充您的表。</p><h2 id="fd8d" class="lb ir ht bd is lc ld le iw lf lg lh ja jz li lj je kd lk ll ji kh lm ln jm lo bi translated">3 种型号:</h2><p id="25fa" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">模型是一种抽象，代表数据库中的一个表。</p><h1 id="ba2c" class="iq ir ht bd is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn bi translated">让我们试试顺序</h1><p id="aacd" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在我们的项目中，我们有许多步骤来用 sequelize 完成数据库。<br/>在本例中，我们将创建迁移、种子和模型文件来实现用户的表。</p><p id="4533" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">1-安装 sequelize 和 sequelize-cli 以及您的数据库的依赖项(这里是 Postgres)。在你的项目中初始化 Postgres 结构。3-生成迁移、模型和种子数据 4-在你的项目中使用它</p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><h1 id="3792" class="iq ir ht bd is it md iv iw ix me iz ja jb mf jd je jf mg jh ji jj mh jl jm jn bi translated">1:安装 Sequelize 和 sequelize-cli。</h1><p id="2cdc" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">根据<a class="ae km" href="https://faraz-faraji.medium.com/everything-about-databases-how-to-choose-part-1-35a7d1a0c9d1" rel="noopener"> <strong class="jq hu">之前的帖子</strong> </a>，我们已经通过 docker 在我们的机器上运行了 Postgres，这里安装了我们需要的所有东西，运行下面的代码:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="819c" class="lb ir ht mn b fi mr ms l mt mu">mkdir sequelize-test<br/>cd sequelize-test<br/>npm init<br/>npm i sequelize sequelize-cli pg pg-hstore faker<br/>npx sequelize-cli init</span></pre><p id="c7bd" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">要了解更多信息并熟悉 CLI 命令，请看一下它们的<a class="ae km" href="https://www.npmjs.com/package/sequelize-cli" rel="noopener ugc nofollow" target="_blank"> <strong class="jq hu">文档</strong> </a>。</p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><h1 id="40de" class="iq ir ht bd is it md iv iw ix me iz ja jb mf jd je jf mg jh ji jj mh jl jm jn bi translated">2:使用。Sequelize 项目中的 env 文件(可选)</h1><p id="6fe7" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">在正常模式下，sequelize 不能接受。env 文件自动生成，所以我们必须编辑我们的项目中的一些文件。</p><p id="bb94" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">首先，转到 Sequelize 生成的<strong class="jq hu">数据库</strong>文件夹，打开<strong class="jq hu">配置</strong>文件夹。然后将文件名改为 config.js，并将这些内容放在上面:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="c281" class="lb ir ht mn b fi mr ms l mt mu">require('dotenv').config(); <em class="ls">// this is important!<br/></em>module.exports = {<br/>    "development": {<br/>        "username": process.env.DB_USERNAME_DEV,<br/>        "password": process.env.DB_PASSWORD_DEV,<br/>        "database": process.env.DB_DATABASE_DEV,<br/>        "host": process.env.DB_HOST_DEV,<br/>        "dialect": "postgres"<br/>    },<br/>    "test": {<br/>        "username": process.env.DB_USERNAME_TEST,<br/>        "password": process.env.DB_PASSWORD_TEST,<br/>        "database": process.env.DB_DATABASE_TEST,<br/>        "host": process.env.DB_HOST_TEST,<br/>        "dialect": "postgres"<br/>    },<br/>    "production": {<br/>        "username": process.env.DB_USERNAME,<br/>        "password": process.env.DB_PASSWORD,<br/>        "database": process.env.DB_DATABASE,<br/>        "host": process.env.DB_HOST,<br/>        "dialect": "postgres"<br/>    }<br/>};</span></pre><p id="8c09" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">然后创建一个文件，命名为<strong class="jq hu">。将这些内容放在上面:</strong></p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="995b" class="lb ir ht mn b fi mr ms l mt mu">const path = require('path');<br/><br/>module.exports = {<br/>  'config': 'database/config/config.js', //config file path<br/>  'models-path': 'database/models', //model path<br/>  'migrations-path': 'database/migrations', //migration path<br/>  'seeders-path': 'database/seeders' //seeders path<br/>};</span></pre><p id="c7b7" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">现在，您的序列化 CLI 将使用您的。env 文件来应用您的更改。</p></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><h1 id="dfde" class="iq ir ht bd is it md iv iw ix me iz ja jb mf jd je jf mg jh ji jj mh jl jm jn bi translated">3:创建迁移文件</h1><p id="b08c" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">通过以下命令生成迁移文件:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="1aa3" class="lb ir ht mn b fi mr ms l mt mu">npx <!-- -->sequelize migration:create --name name_of_your_migration</span></pre><p id="c020" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">正如您在 migrations 文件夹中看到的，有一个以时间戳开始的文件。意思是什么时候。您想要运行迁移，CLI 将从较旧的文件运行到较新的文件。</p><p id="7cd8" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">将以下代码放入生成的文件中:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="c932" class="lb ir ht mn b fi mr ms l mt mu">'use strict';<br/><br/>module.exports = {<br/>    up: <em class="ls">async </em>(queryInterface, Sequelize) =&gt; {<br/>        <em class="ls">return </em>queryInterface.createTable('users',<br/>            {<br/>                user_id: {<br/>                    type: Sequelize.INTEGER,<br/>                    autoIncrement: <em class="ls">true</em>,<br/>                    primaryKey: <em class="ls">true</em>,<br/>                },<br/>                username: {<br/>                    type: Sequelize.STRING<br/>                },<br/>                email: {<br/>                    type: Sequelize.STRING<br/>                },<br/>                password: {<br/>                    type: Sequelize.STRING<br/>                },                <br/>                createdAt: {<br/>                    type: Sequelize.DATE<br/>                },<br/>                updatedAt: {<br/>                    type: Sequelize.DATE<br/>                },<br/>            }<br/>        );<br/>    },<br/><br/>    down: <em class="ls">async </em>(queryInterface, Sequelize) =&gt; {<br/>        <em class="ls">await </em>queryInterface.dropTable('users');<br/>    }<br/>};</span></pre><p id="e7b2" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">现在您有了一个包含迁移脚本的文件。这意味着无论何时运行迁移命令，您的表都会自动创建。让我们通过这个命令来完成它:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="5bf3" class="lb ir ht mn b fi mr ms l mt mu">npx sequelize db:migrate</span></pre><h2 id="b662" class="lb ir ht bd is lc ld le iw lf lg lh ja jz li lj je kd lk ll ji kh lm ln jm lo bi translated">有关更多信息:(更新您的表模式)</h2><p id="8f18" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">假设过一段时间，当您有很多用户时，您决定添加每个客户的昵称。</p><p id="615f" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">让我们通过这个命令<strong class="jq hu">创建</strong>另一个<strong class="jq hu">迁移</strong>文件:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="108b" class="lb ir ht mn b fi mr ms l mt mu">npx <!-- -->sequelize migration:create --name name_of_your_migration</span></pre><p id="d252" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">然后将内容更改为:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="77a3" class="lb ir ht mn b fi mr ms l mt mu">module.exports = {<br/>  up: function(queryInterface, Sequelize) {<br/>    return queryInterface.addColumn(<br/>      '<!-- -->users<!-- -->',<br/>      'nickname',<br/>     Sequelize.STRING<br/>    );<br/><br/>  },<br/><br/>  down: function(queryInterface, Sequelize) {<br/>    // logic for reverting the changes<br/>    return queryInterface.removeColumn(<br/>      '<!-- -->users<!-- -->',<br/>      'nickname'<br/>    );<br/>  }<br/>}</span></pre><p id="6928" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">并再次运行生成命令:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="3d72" class="lb ir ht mn b fi mr ms l mt mu">npx sequelize-cli db:migrate</span></pre><p id="2548" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">您将会看到，昵称列是<strong class="jq hu">添加到您的用户表中的</strong>。你可以随时通过这个命令<strong class="jq hu">撤销</strong>你一个版本接一个版本的修改:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="531f" class="lb ir ht mn b fi mr ms l mt mu">npx sequelize db:migrate:undo</span></pre></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><h1 id="2d03" class="iq ir ht bd is it md iv iw ix me iz ja jb mf jd je jf mg jh ji jj mh jl jm jn bi translated">4:创建种子文件</h1><p id="f148" class="pw-post-body-paragraph jo jp ht jq b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl hb bi translated">让我们通过创建一个种子文件来开始这个过程:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="ee2b" class="lb ir ht mn b fi mr ms l mt mu">npx sequelize seed:create --name <!-- -->name_of_your_seeds</span></pre><p id="e79f" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">然后将以下代码放入文件中</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="164f" class="lb ir ht mn b fi mr ms l mt mu">'use strict';<br/><br/>var faker = require("faker");<br/><br/>module.exports = {<br/><br/>    up: (queryInterface, Sequelize) =&gt; {<br/><br/>        var newData = [];<br/><br/>        for (let i = 0; i &lt; 10; i++) {<br/>            const seedData = {<br/>                nickname: faker.<!-- -->name.findName()<!-- -->,<br/>                username: faker.<!-- -->internet<!-- -->.username(),<br/>                email: faker.<!-- -->internet<!-- -->.<!-- -->email<!-- -->(),<br/>                password: faker.internet.<!-- -->password<!-- -->(),<br/>                createdAt: new Date(),<br/>                updatedAt: new Date()<br/>            };<br/>            newData.push(seedData);<br/>        }<br/><br/>        return queryInterface.bulkInsert('users', newData);<br/>    },<br/><br/>    down: (queryInterface, Sequelize) =&gt; {<br/>        return queryInterface.bulkDelete('users', null, {});<br/>    }<br/>};</span></pre><p id="928a" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">现在你已经有了关于数据库和序列的所有基本知识</p><p id="d3ae" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">只需运行此命令，通过 seeder 填充您的数据:</p><pre class="mi mj mk ml fd mm mn mo mp aw mq bi"><span id="3377" class="lb ir ht mn b fi mr ms l mt mu">npx sequelize-cli db:seed:all</span></pre></div><div class="ab cl lw lx gp ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="hb hc hd he hf"><p id="9f5e" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">在下一篇文章中，我将深入解释 Sequelize 以及如何在表中获取和插入数据。</p><p id="f3c3" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated">别忘了关注我的 Instagram 页面，获取更新和通知。</p><p id="74b5" class="pw-post-body-paragraph jo jp ht jq b jr kw jt ju jv kx jx jy jz ky kb kc kd kz kf kg kh la kj kk kl hb bi translated"><a class="ae km" href="https://www.instagram.com/p/CQGpSEeD_j6/?utm_source=ig_web_copy_link" rel="noopener ugc nofollow" target="_blank"><strong class="jq hu">https://www.instagram.com/p/CQGpSEeD_j6/?UTM _ source = ig _ web _ button _ share _ sheet</strong></a></p></div></div>    
</body>
</html>