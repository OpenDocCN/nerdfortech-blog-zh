<html>
<head>
<title>How to connect GCP Composer to Cloud SQL using Proxy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用代理将GCP作曲家连接到云SQL</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/connecting-gcp-composer-to-cloud-sql-via-proxy-305743a388a?source=collection_archive---------2-----------------------#2021-03-13">https://medium.com/nerd-for-tech/connecting-gcp-composer-to-cloud-sql-via-proxy-305743a388a?source=collection_archive---------2-----------------------#2021-03-13</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/125522b90632f8c51c4ac5c800d0263c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wfDGWRinurkboIvf"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com/@mitchel3uo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米切尔罗</a>在<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></figcaption></figure><p id="2964" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是一个分步指南，使用代理将从Kubernetes集群运行的GCP Composer连接到PostgreSQL的GCP SQL实例。</p><p id="d838" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是一个比理论更实用的指南。因此，如果您希望了解这些技术的小细节和架构，您可以随时查看每个部分中的链接。</p><p id="5e60" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有一个关于设置这些技术的指南，所以在我们继续之前，请确保该指南已经完成。</p><div class="jt ju ez fb jv jw"><a href="https://dorlabor1.medium.com/setting-up-cloud-composer-cloud-sql-and-google-cloud-sdk-22f02bc0d1cd" rel="noopener follow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">设置Cloud Composer、云SQL和Google Cloud SDK</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">这是设置Cloud Composer、Cloud SQL和Google Cloud SDK的分步指南。本指南是…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">dorlabor1.medium.com</p></div></div><div class="kf l"><div class="kg l kh ki kj kf kk io jw"/></div></div></a></div><h1 id="a280" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">为什么我会在这里？</h1><p id="d077" class="pw-post-body-paragraph iv iw hi ix b iy lj ja jb jc lk je jf jg ll ji jj jk lm jm jn jo ln jq jr js hb bi translated">帮助您从Composer集群连接到GCP SQL。为此，建议使用云SQL代理。</p><p id="b16e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">目前，还没有简单完整的指南。我找不到在一个地方收集所有必要信息的指南，事实上，在我看来，文档中的一些信息有点误导。理解这一切，知道它们在哪里，并通过阅读不同的相关文档来学习如何做，是相当复杂和耗时的</p><p id="d24b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以我来了😎。</p><h1 id="e9e3" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">什么是云SQL代理？</h1><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/sql/docs/postgres/sql-proxy" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">关于云SQL代理|云SQL for PostgreSQL | Google Cloud</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">此页面提供了云SQL代理的基本介绍，并描述了代理选项。对于循序渐进的…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="lo l kh ki kj kf kk io jw"/></div></div></a></div><p id="3d8a" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">云SQL代理</strong>提供对实例的安全访问，无需<a class="ae iu" href="https://cloud.google.com/sql/docs/postgres/configure-ip" rel="noopener ugc nofollow" target="_blank">授权网络</a>或<a class="ae iu" href="https://cloud.google.com/sql/docs/postgres/configure-ssl-instance" rel="noopener ugc nofollow" target="_blank">配置SSL </a>。</p><p id="3263" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">使用云SQL代理访问云SQL实例具有以下优势:</p><ul class=""><li id="e3c1" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated"><strong class="ix hj">安全连接:</strong>云SQL代理使用TLS 1.2和128位AES密码自动加密进出数据库的流量；SSL证书用于验证客户端和服务器身份。</li><li id="5c7e" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated"><strong class="ix hj">更简单的连接管理:</strong>云SQL代理使用云SQL处理身份验证，无需提供静态IP地址。</li></ul><p id="3863" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">云SQL代理不提供新的连接路径；它依赖于现有的IP连接。</p><p id="df39" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">简单地说，通过云SQL代理将GCP作曲家连接到云SQL有点痛苦，但从长远来看，这是值得的。</p><p id="b0d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">保守秘密🤫。</p><h1 id="0c2c" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">什么是秘密？</h1><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/secret?hl=en#creating_a_secret" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">秘密| Kubernetes引擎文档|谷歌云</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">本页描述了Kubernetes中的秘密对象及其在Google Kubernetes引擎(GKE)中的使用。秘密是安全的…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="md l kh ki kj kf kk io jw"/></div></div></a></div><p id="9f89" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj"> Secrets </strong>是存储敏感数据的安全对象，比如密码、OAuth令牌和SSH密钥。</p><p id="1709" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在Kubernetes中，<a class="ae iu" href="https://cloud.google.com/kubernetes-engine/docs/concepts/secret" rel="noopener ugc nofollow" target="_blank">秘密</a>是一种将配置细节传递给应用程序的安全方式。您可以创建一个包含数据库名称、用户和密码等细节的秘密，它可以作为env变量注入到您的应用程序中。</p><p id="8bd5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">根据连接类型的不同，使用机密的方式有很多种:</p><ul class=""><li id="0935" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated">数据库凭据机密包括您正在连接的数据库的用户名和用户的数据库密码。</li><li id="d0a2" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">如果与代理连接，可以使用一个密码来保存您的服务帐户的凭据文件。</li></ul><h1 id="8f2a" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">为数据库信息创建秘密对象</h1><ul class=""><li id="3760" class="lp lq hi ix b iy lj jc lk jg me jk mf jo mg js lu lv lw lx bi translated">进入“导航菜单”-&gt;“Kubernetes引擎”。</li><li id="5554" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated"><strong class="ix hj">注意“姓名”和“地点”字段的详细信息。</strong></li><li id="5537" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">“名称”将被称为“群集名称”。</li><li id="feb6" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">转到“Kubernetes引擎”下的“配置”。</li><li id="91ab" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">并排打开:代码编辑器和“配置”页面中的终端。</li></ul><p id="86f5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行:</p><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="c16f" class="mq km hi mm b fi mr ms l mt mu">gcloud container clusters get-credentials CLUSTER_NAME</span></pre><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/sql/docs/postgres/connect-kubernetes-engine#creating_a_secret_object" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">从Google Kubernetes引擎|云SQL for PostgreSQL连接</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">本页描述了如何建立从运行在Google Kubernetes引擎中的应用程序到云SQL的连接…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="mv l kh ki kj kf kk io jw"/></div></div></a></div><ul class=""><li id="66c5" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated">运行:</li></ul><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="bc8d" class="mq km hi mm b fi mr ms l mt mu">kubectl create secret generic &lt;YOUR-DB-SECRET&gt; \<br/>  --from-literal=username=&lt;YOUR-DATABASE-USER&gt; \<br/>  --from-literal=password=&lt;YOUR-DATABASE-PASSWORD&gt; \<br/>  --from-literal=database=&lt;YOUR-DATABASE-NAME&gt;</span></pre><ul class=""><li id="886a" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated"><your-db-secret> =给它起一个你想要的名字(<strong class="ix hj">请注意)。</strong></your-db-secret></li></ul><p id="83d3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">名称必须由小写字母数字字符、'-'或'.'组成，并且必须以字母数字字符开始和结束(例如' example.com '，用于验证的regex是'[a-z0–9]([-a-z0–9]*[a-z0–9])？(\.[a-z0–9]([-a-z0–9]*[a-z0–9])？)*').</p><ul class=""><li id="03ef" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated"><your-database-user>、<your-database-password>和<your-database-name>它们是您用SQL实例创建的(我告诉过您要注意这一点)。</your-database-name></your-database-password></your-database-user></li></ul><p id="36bc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请刷新您的“配置”页面，然后单击您刚刚创建的密码。</p><p id="38c1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">注意“名称空间”(</strong>应该是默认的<strong class="ix hj">)。</strong></p><p id="7949" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">转到下面的链接，通过单击“Enable API”按钮验证云SQL Admin API是否已启用:</p><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/sql/docs/postgres/connect-kubernetes-engine#proxy" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">从Google Kubernetes引擎|云SQL for PostgreSQL连接</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">本页描述了如何建立从运行在Google Kubernetes引擎中的应用程序到云SQL的连接…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="mw l kh ki kj kf kk io jw"/></div></div></a></div><p id="0c57" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们现在需要向代理提供服务帐户。</p><p id="5009" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">为此，我们需要配置GKE(Google Kubernetes引擎)来为云SQL代理提供服务帐户。有两种推荐的方法可以做到这一点:<a class="ae iu" href="https://cloud.google.com/sql/docs/postgres/connect-kubernetes-engine#workload-identity" rel="noopener ugc nofollow" target="_blank">工作负载标识</a>或者一个<a class="ae iu" href="https://cloud.google.com/sql/docs/postgres/connect-kubernetes-engine#service-account-key-file" rel="noopener ugc nofollow" target="_blank">服务帐户密钥文件</a>。</p><p id="1d64" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">所以…工作负载身份…👷‍♀️</p><h1 id="e1bd" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">工作量身份…啊？</h1><p id="eff4" class="pw-post-body-paragraph iv iw hi ix b iy lj ja jb jc lk je jf jg ll ji jj jk lm jm jn jo ln jq jr js hb bi translated">您可以在此阅读有关工作负载身份的信息:</p><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#concepts" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">使用工作负载标识| Kubernetes引擎文档</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">本页解释了推荐您的Google Kubernetes引擎(GKE)应用程序使用服务的方式…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="mx l kh ki kj kf kk io jw"/></div></div></a></div><p id="54d2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果你正在使用<a class="ae iu" href="https://cloud.google.com/kubernetes-engine" rel="noopener ugc nofollow" target="_blank"> Google Kubernetes引擎</a>，首选方法是使用GKE的<a class="ae iu" href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity" rel="noopener ugc nofollow" target="_blank">工作负载身份</a>特性。这个方法允许您将一个<a class="ae iu" href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/" rel="noopener ugc nofollow" target="_blank"> Kubernetes服务帐户(KSA) </a>绑定到一个Google服务帐户(GSA)。然后，GSA将可供使用匹配KSA的应用程序访问。</p><p id="dc2b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">Google服务帐户(GSA)是一个IAM身份，代表您在Google Cloud中的应用程序。类似地，Kubernetes服务帐户(KSA)是在Google Kubernetes引擎集群中代表您的应用程序的身份。</p><p id="eb11" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">工作负载身份将一个KSA绑定到一个GSA，使得任何使用该KSA的部署在与Google Cloud交互时都被认证为GSA。</p><p id="b52b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><strong class="ix hj">请记住术语</strong> : GKE、KSA、GSA。</p><h1 id="16e7" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">创建工作负荷标识</h1><ol class=""><li id="20dc" class="lp lq hi ix b iy lj jc lk jg me jk mf jo mg js my lv lw lx bi translated">请在集群中启用工作负荷标识:</li></ol><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#enable_on_cluster" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">使用工作负载标识| Kubernetes引擎文档</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">本页解释了推荐您的Google Kubernetes引擎(GKE)应用程序使用服务的方式…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="mz l kh ki kj kf kk io jw"/></div></div></a></div><p id="a803" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">验证是否已启用IAM服务帐户凭据API:</p><ul class=""><li id="f3fc" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated">请单击“启用IAM凭据API”。</li></ul><p id="d947" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(您不需要“创建凭证”)</p><ul class=""><li id="e4bd" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated">要在现有集群中启用工作负载标识，请使用以下命令修改集群:</li></ul><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="9909" class="mq km hi mm b fi mr ms l mt mu">gcloud container clusters update CLUSTER_NAME \<br/>  --workload-pool=PROJECT_ID.svc.id.goog</span></pre><ul class=""><li id="7722" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated">要查找您的PROJECT_ID，请访问:</li></ul><figure class="mh mi mj mk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es na"><img src="../Images/909b877f97e852662dabc92f02b03144.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jzmyoT9BHiYjyPP9BGjWKQ.png"/></div></div></figure><ul class=""><li id="7adb" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated">“ID”下面是您的项目ID。</li></ul><p id="d9cb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">2.为您的应用程序创建KSA:</p><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/sql/docs/postgres/connect-kubernetes-engine#workload-identity" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">从Google Kubernetes引擎|云SQL for PostgreSQL连接</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">本页描述了如何建立从运行在Google Kubernetes引擎中的应用程序到云SQL的连接…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="nb l kh ki kj kf kk io jw"/></div></div></a></div><p id="98c7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">通常，每个应用程序都有自己的身份，由一对KSA和GSA表示。通过激活来创建它:</p><p id="be4d" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du nc nd ne mm b">kubectl apply -f NameOfYourFile.yaml</code></p><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="2bd0" class="mq km hi mm b fi mr ms l mt mu">apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: &lt;YOUR-KSA-NAME&gt; # TODO(developer): replace these values</span></pre><ul class=""><li id="f5c0" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated"><your-ksa-name> =选择自己喜欢的名字(<strong class="ix hj">请注意</strong>)。</your-ksa-name></li></ul><figure class="mh mi mj mk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es nf"><img src="../Images/fd61a8ead1755c0d0ef37afb2beb717d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*frI8fMFTrbTpo2L8PwuTJQ.png"/></div></div></figure><p id="c139" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">在我的例子中:</p><ul class=""><li id="d17b" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated"><your-ksa-name> =测试-ksa。</your-ksa-name></li><li id="8a86" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">转到“Configuration”并<strong class="ix hj">注意您新创建的KSA的“Name”及其“Namespace”(</strong>该名称可能略有不同，例如，<a class="ae iu" href="https://console.cloud.google.com/kubernetes/secret/us-central1-a/us-central1-composer-b80be761-gke/default/test-ksa-token-rgfj8?project=lateral-now-306513" rel="noopener ugc nofollow" target="_blank">test-ksa-token-s</a>something<strong class="ix hj">)，</strong>“Type”应该是Secret，而“Namespace”是默认的。</li></ul><p id="75ef" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">3.启用您的-GSA-NAME和您的-KSA-NAME之间的IAM绑定:</p><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#authenticating_to" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">使用工作负载标识| Kubernetes引擎文档</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">本页解释了推荐您的Google Kubernetes引擎(GKE)应用程序使用服务的方式…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="ng l kh ki kj kf kk io jw"/></div></div></a></div><p id="5d14" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">(转到第5题。)</p><p id="5821" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行:</p><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="28bb" class="mq km hi mm b fi mr ms l mt mu">gcloud iam service-accounts add-iam-policy-binding \<br/>  --role roles/iam.workloadIdentityUser \ <br/>--member "serviceAccount:PROJECT_ID.svc.id.goog[K8S_NAMESPACE/KSA_NAME]" \<br/>  GSA_NAME@PROJECT_ID.iam.gserviceaccount.com</span></pre><p id="211b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">K8S代表Kubernetes，8在“K”和“S”之间交替八个字母。8="ubernete "。</p><p id="52dd" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不知道他们为什么要写K8S_NAMESPACE。它应该写成KSA命名空间，在我们的例子中，这意味着默认。</p><p id="4cd7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">4.添加注释以完成绑定:</p><p id="a7b3" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行:</p><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="92af" class="mq km hi mm b fi mr ms l mt mu">kubectl annotate serviceaccount \<br/>  --namespace K8S_NAMESPACE \<br/>  KSA_NAME \<br/>  iam.gke.io/gcp-service-account=GSA_NAME@PROJECT_ID.iam.gserviceaccount.com</span></pre><ul class=""><li id="b46d" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated">这里的KSA名字应该是你给它的原始名字，而不是在它被改变之后。</li></ul><p id="912f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">例如:在我的情况下，原始名称是<em class="nh"> test-ksa。</em></p><p id="e5be" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">5.确保为k8s对象指定服务帐户，并将代理作为sidecar运行:</p><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/sql/docs/postgres/connect-kubernetes-engine#running_the_proxy_as_a_sidecar" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">从Google Kubernetes引擎|云SQL for PostgreSQL连接</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">本页描述了如何建立从运行在Google Kubernetes引擎中的应用程序到云SQL的连接…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="ni l kh ki kj kf kk io jw"/></div></div></a></div><p id="8151" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">运行:</p><p id="ff08" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated"><code class="du nc nd ne mm b">kubectl apply -f NameOfYourFile.yaml</code></p><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="47e1" class="mq km hi mm b fi mr ms l mt mu">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: &lt;YOUE-DEPLOYMENT-NAME&gt;<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app:  &lt;YOUR-APPLICATION-NAME&gt;<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app:  &lt;YOUR-APPLICATION-NAME&gt;<br/>    spec:<br/>      serviceAccountName: &lt;YOUR-KSA-NAME&gt;<br/>      containers:<br/>      - name: cloud-sql-proxy<br/>        image: gcr.io/cloudsql-docker/gce-proxy:1.17<br/>        env:<br/>        - name: DB_USER<br/>          valueFrom:<br/>            secretKeyRef:<br/>               name: &lt;YOUR-DB-SECRET&gt;<br/>               key: username<br/>        - name: DB_PASS<br/>          valueFrom:<br/>            secretKeyRef:<br/>               name: &lt;YOUR-DB-SECRET&gt;<br/>               key: password<br/>        - name: DB_NAME<br/>          valueFrom:<br/>            secretKeyRef:<br/>              name: &lt;YOUR-DB-SECRET&gt;<br/>              key: database<br/>        command:<br/>        - "/cloud_sql_proxy"<br/>        - "-instances=&lt;INSTANCE_CONNECTION_NAME&gt;=tcp:&lt;DB_PORT&gt;"<br/>        securityContext:<br/>          runAsNonRoot: true</span></pre><ul class=""><li id="9aa4" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated"><your-deployment-name> =给它一个合适的名称(您可以在“Kubernetes Engine”下的“Workloads”中看到您的部署)。</your-deployment-name></li><li id="9381" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated"><your-application-name>其实就是你的<gke-name>意思是<cluster_name>。</cluster_name></gke-name></your-application-name></li><li id="a03b" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated"><your-ksa-name>(你给它起的原名)。</your-ksa-name></li><li id="53b9" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">你可以随意调用“cloud-sql-proxy”。既然我们创建了一个代理，那么称之为“cloud-sql-proxy”是有意义的。</li><li id="6ea2" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated"><your-db-secret>(您在为数据库信息创建秘密对象一节中创建了它)。</your-db-secret></li><li id="eae3" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated"><instance_connection_name>是一个SQL实例的连接名。</instance_connection_name></li><li id="c723" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">因为我们使用PostgreSQL，所以<db_port>是5432。</db_port></li><li id="5ec7" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">转到“Kubernetes引擎”下的“工作负载”。</li><li id="10dd" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">您的最后一个部署应该是您刚刚创建的部署。</li><li id="52f9" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">单击您的部署名称。</li><li id="2941" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">向下滚动，直到看到“Managed pods ”,然后单击其链接。</li><li id="fe89" class="lp lq hi ix b iy ly jc lz jg ma jk mb jo mc js lu lv lw lx bi translated">向下滚动，直到你看到“容器”，下面你应该看到“云-SQL-代理”。</li></ul><p id="b700" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">恭喜你！我们已经配置好了一切。现在，我们所要做的就是在Airflow Webserver中执行我们的代码。🐱‍🏍</p><h1 id="232c" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">执行您的代码</h1><div class="jt ju ez fb jv jw"><a href="https://airflow.apache.org/docs/apache-airflow/1.10.9/_modules/airflow/contrib/example_dags/example_gcp_sql_query.html" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">air flow . contrib . example _ DAGs . example _ GCP _ SQL _ query-air flow文档</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">编辑描述</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">airflow.apache.org</p></div></div></div></a></div><p id="0df1" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请将下面的代码输入到file.py中(除了“可选的”，除非你想)。</p><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="9f91" class="mq km hi mm b fi mr ms l mt mu"><em class="nh">import</em> os<br/><em class="nh">from</em> os.path <em class="nh">import</em> expanduser<br/><em class="nh">from</em> datetime <em class="nh">import</em> timedelta</span><span id="ec89" class="mq km hi mm b fi nj ms l mt mu"><em class="nh">from</em> six.moves.urllib.parse <em class="nh">import</em> quote_plus</span><span id="60d7" class="mq km hi mm b fi nj ms l mt mu"><em class="nh">from</em> airflow <em class="nh">import</em> DAG<br/><em class="nh">from</em> airflow.models <em class="nh">import</em> Variable<br/><em class="nh">from</em> airflow.contrib.operators.gcp_sql_operator <em class="nh">import</em> CloudSqlQueryOperator<br/><em class="nh">from</em> airflow.operators.python_operator <em class="nh">import</em> PythonOperator<br/><em class="nh">from</em> airflow.utils.dates <em class="nh">import</em> days_ago</span><span id="36b4" class="mq km hi mm b fi nj ms l mt mu"><em class="nh">from</em> google.cloud <em class="nh">import</em> storage<br/><em class="nh">from</em> google.cloud.storage._helpers <em class="nh">import</em> _PropertyMixin</span></pre></div><div class="ab cl nk nl gp nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="hb hc hd he hf"><pre class="ml mm mn mo aw mp bi"><span id="b80d" class="mq km hi mm b fi nr ns nt nu nv ms l mt mu">(this part is optional! it is called "Airflow variables" and its mainly usage is for hiding sensitive data information)</span><span id="a33d" class="mq km hi mm b fi nj ms l mt mu">dag_config=Variable.get("proxy_con_variables",deserialize_json=True)<br/>GCP_PROJECT_ID_VARIABLE = dag_config["gcp_project_id"]<br/>GCP_REGION_VARIABLE = dag_config["gcp_region"]<br/>GCSQL_POSTGRES_INSTANCE_NAME_QUERY_VARIABLE=dag_config["gcsql_postgres_instance_name_query"]<br/>GCSQL_POSTGRES_DATABASE_NAME_VARIABLE=dag_config["gcsql_postgres_database_name"]<br/>GCSQL_POSTGRES_USER_VARIABLE = dag_config["gcsql_postgres_user"]<br/>GCSQL_POSTGRES_PASSWORD_VARIABLE=dag_config["gcsql_postgres_password"]<br/>GCSQL_POSTGRES_PUBLIC_IP_VARIABLE=dag_config["gcsql_postgres_public_ip"]<br/>GCSQL_POSTGRES_PUBLIC_PORT_VARIABLE=dag_config["gcsql_postgres_public_port"]</span><span id="d527" class="mq km hi mm b fi nj ms l mt mu">(this part is optional! it is called "Airflow variables" and its mainly usage is for hiding sensitive data information)</span><span id="a707" class="mq km hi mm b fi nj ms l mt mu">GCP_PROJECT_ID=os.environ.get('GCP_PROJECT_ID',GCP_PROJECT_ID_VARIABLE)<br/>GCP_REGION = os.environ.get('GCP_REGION', GCP_REGION_VARIABLE)<br/>GCSQL_POSTGRES_INSTANCE_NAME_QUERY=os.environ.get('GCSQL_POSTGRES_INSTANCE_NAME_QUERY', GCSQL_POSTGRES_INSTANCE_NAME_QUERY_VARIABLE)<br/>GCSQL_POSTGRES_DATABASE_NAME=os.environ.get('GCSQL_POSTGRES_DATABASE_NAME', GCSQL_POSTGRES_DATABASE_NAME_VARIABLE)<br/>GCSQL_POSTGRES_USER = os.environ.get('GCSQL_POSTGRES_USER',GCSQL_POSTGRES_USER_VARIABLE)</span><span id="203e" class="mq km hi mm b fi nj ms l mt mu">GCSQL_POSTGRES_PASSWORD = os.environ.get('GCSQL_POSTGRES_PASSWORD', GCSQL_POSTGRES_PASSWORD_VARIABLE)</span><span id="167b" class="mq km hi mm b fi nj ms l mt mu">GCSQL_POSTGRES_PUBLIC_IP = os.environ.get('GCSQL_POSTGRES_PUBLIC_IP', GCSQL_POSTGRES_PUBLIC_IP_VARIABLE)</span><span id="3d75" class="mq km hi mm b fi nj ms l mt mu">GCSQL_POSTGRES_PUBLIC_PORT = os.environ.get('GCSQL_POSTGRES_PUBLIC_PORT', GCSQL_POSTGRES_PUBLIC_PORT_VARIABLE)</span></pre><p id="c0b4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">要了解更多信息，我推荐以下指南:</p><figure class="mh mi mj mk fd ij"><div class="bz dy l di"><div class="nw nx l"/></div></figure></div><div class="ab cl nk nl gp nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="hb hc hd he hf"><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="c464" class="mq km hi mm b fi mr ms l mt mu">SQL = [<br/>    'CREATE TABLE IF NOT EXISTS TABLE_TEST (I INTEGER)',<br/>    'CREATE TABLE IF NOT EXISTS TABLE_TEST (I INTEGER)',<br/>    'INSERT INTO TABLE_TEST VALUES (0)',<br/>    'CREATE TABLE IF NOT EXISTS TABLE_TEST2 (I INTEGER)',<br/>    'DROP TABLE TABLE_TEST',<br/>    'DROP TABLE TABLE_TEST2',<br/>]</span><span id="f6f3" class="mq km hi mm b fi nj ms l mt mu">default_args = {<br/>    'email': ['enter your email',],<br/>    'email_on_retry': False,<br/>    'email_on_failure': False,<br/>    'retries': 1,<br/>    'retry_delay': timedelta(minutes=5),<br/>    'depends_on_past': False,<br/>    'start_date': days_ago(1),<br/>}</span><span id="9335" class="mq km hi mm b fi nj ms l mt mu">HOME_DIR = expanduser("~")</span><span id="3443" class="mq km hi mm b fi nj ms l mt mu">def get_absolute_path(path):<br/>    <em class="nh">if</em> path.startswith("/"):<br/>        <em class="nh">return</em> path<br/>    <em class="nh">else</em>:<br/>        <em class="nh">return</em> os.path.join(HOME_DIR, path)</span><span id="5f6c" class="mq km hi mm b fi nj ms l mt mu">postgres_kwargs = dict(<br/>    user=quote_plus(GCSQL_POSTGRES_USER),<br/>    password=quote_plus(GCSQL_POSTGRES_PASSWORD),<br/>    public_port=GCSQL_POSTGRES_PUBLIC_PORT,<br/>    public_ip=quote_plus(GCSQL_POSTGRES_PUBLIC_IP),<br/>    project_id=quote_plus(GCP_PROJECT_ID),<br/>    location=quote_plus(GCP_REGION),<br/>    instance=quote_plus(GCSQL_POSTGRES_INSTANCE_NAME_QUERY),<br/>    database=quote_plus(GCSQL_POSTGRES_DATABASE_NAME),<br/>)</span></pre><ul class=""><li id="9ff4" class="lp lq hi ix b iy iz jc jd jg lr jk ls jo lt js lu lv lw lx bi translated">这里找到的都应该是字符串，像这样("")，除了public_port = 5432是数字。</li></ul><p id="905e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">GCSQL_POSTGRES_USER是云中的SQL用户。GCSQL_POSTGRES_PASSWORD是同一用户的密码。CSQL_POSTGRES_PUBLIC_IP是SQL云的公共IP地址。GCP地区是您选择的“位置”。例如，“美国中心1”。GCP项目标识是我们已经提到的项目标识。GCSQL _ POSTGRES _ INSTANCE _ NAME _ QUERY是SQL cloud实例的<strong class="ix hj">原始名称</strong>，也就是您在更改前赋予它的名称。GCSQL_POSTGRES_DATABASE_NAME是云中的SQL数据库。GCSQL_POSTGRES_PUBLIC_PORT是5432。</p><pre class="mh mi mj mk fd ml mm mn mo aw mp bi"><span id="dc57" class="mq km hi mm b fi mr ms l mt mu">os.environ['AIRFLOW_CONN_PROXY_POSTGRES_TCP'] = \<br/>    "gcpcloudsql://{user}:{password}@{public_ip}:{public_port}/{database}?" \<br/>    "database_type=postgres&amp;" \<br/>    "project_id={project_id}&amp;" \<br/>    "location={location}&amp;" \<br/>    "instance={instance}&amp;" \\<br/>    "use_proxy=True&amp;" \<br/>    "sql_proxy_use_tcp=True".format(**postgres_kwargs)</span><span id="f4d5" class="mq km hi mm b fi nj ms l mt mu">connection_names = [<br/>    "proxy_postgres_tcp",<br/>]</span><span id="8ef6" class="mq km hi mm b fi nj ms l mt mu">dag = DAG(<br/>    'con_SQL',<br/>    default_args=default_args,<br/>    description='A DAG that connect to the SQL server.',<br/>    schedule_interval=timedelta(days=1),<br/>)</span><span id="598d" class="mq km hi mm b fi nj ms l mt mu">def print_client(ds, **kwargs):<br/>    client = storage.Client()<br/>    print(client)</span><span id="f867" class="mq km hi mm b fi nj ms l mt mu">print_task = PythonOperator(<br/>    task_id='print_the_client',<br/>    provide_context=True,<br/>    python_callable=print_client,<br/>    dag=dag,<br/>)</span><span id="1dfc" class="mq km hi mm b fi nj ms l mt mu"><em class="nh">for</em> connection_name <em class="nh">in</em> connection_names:<br/>    task = CloudSqlQueryOperator(<br/>         gcp_cloudsql_conn_id=connection_name,<br/>         task_id="example_gcp_sql_task_" + connection_name,<br/>         sql=SQL,<br/>         dag=dag<br/>    )<br/>print_task &gt;&gt; task</span></pre><p id="ab0c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">总之:</p><p id="8e68" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">有两项任务:</p><p id="f1f7" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">第一个任务是task_id="print_the_client "，第二个任务是task _ id = " example _ GCP _ SQL _ task _ "+connection _ name，称为" example _ GCP _ SQL _ task _ proxy _ postgres _ TCP "。</p><p id="939e" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">“print_the_client”是一个简单的任务，它仅打印客户端详细信息，以查看DAG是否正常工作，但它也可以是任何其他简单且容易工作的任务。</p><p id="db3c" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如果“print_the_client”不工作，请解决问题以继续第二项任务。这可能就是“example _ GCP _ SQL _ task _ proxy _ postgres _ TCP”不会工作的原因(DAG结构的问题)。</p><p id="b2fb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">“example _ GCP _ sql _ task _ proxy _ postgres _ TCP”连接到SQL cloud并执行我们的SQL。这就是我们在这里的原因。</p><p id="bff2" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">太好了！我们制作了文件，现在我们需要将它上传到Airflow服务器。👌</p><h1 id="d3d9" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">Airflow服务器</h1><div class="jt ju ez fb jv jw"><a href="https://cloud.google.com/composer/docs/how-to/accessing/airflow-web-interface" rel="noopener  ugc nofollow" target="_blank"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">Airflow web界面| Cloud Composer |谷歌云</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">Apache Airflow包括一个web界面，您可以使用它来管理工作流(Dag)、管理气流环境…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">cloud.google.com</p></div></div><div class="kf l"><div class="ny l kh ki kj kf kk io jw"/></div></div></a></div><p id="af41" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">进入“导航菜单”-&gt;“Composer”，选择DAGs文件夹下的链接(会带你去云存储，给你看一个我们已经连接过的桶)。</p><p id="fa98" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请选择“上传文件”，并上传新创建的file.py。返回“Composer”并选择Airflow服务器下的链接。</p><p id="b5c6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">等待大约1–2分钟，刷新页面，您将看到您的DAG名称“con_SQL”。</p><p id="6fa6" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">输入您的Dag并“触发DAG”来运行您的代码。</p><p id="261b" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">不断刷新页面，看看有没有变化。对于每个问题，选择任务的方格并“查看日志”。</p><p id="fe5f" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">任务完成！👏🙌🎉</p><p id="5e16" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">请继续关注更新和您可能需要的任何其他信息。请对流程中出现的任何问题发表评论。</p><p id="2945" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">祝你好运！</p><h1 id="f995" class="kl km hi bd kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf lg lh li bi translated">感谢:</h1><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/@ariklevliber/connecting-to-gcp-composer-tasks-to-cloud-sql-7566350c5f53"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">将GCP合成器任务连接到云SQL</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">从本地开发机器和GCP Composer连接到GCP SQL实例所需的步骤</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="nz l kh ki kj kf kk io jw"/></div></div></a></div><div class="jt ju ez fb jv jw"><a rel="noopener follow" target="_blank" href="/@diggingfork/how-to-connect-cloud-sql-on-cloud-composer-via-proxy-31202191a55c"><div class="jx ab dw"><div class="jy ab jz cl cj ka"><h2 class="bd hj fi z dy kb ea eb kc ed ef hh bi translated">如何通过代理连接Cloud Composer上的云SQL</h2><div class="kd l"><h3 class="bd b fi z dy kb ea eb kc ed ef dx translated">有些情况下，我们希望在Cloud Composer的PythonOperator中转换数据，然后连接并抛出…</h3></div><div class="ke l"><p class="bd b fp z dy kb ea eb kc ed ef dx translated">medium.com</p></div></div><div class="kf l"><div class="oa l kh ki kj kf kk io jw"/></div></div></a></div><p id="2462" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">它们都是解决这种连接问题的主要场所。所以谢谢大家！</p></div></div>    
</body>
</html>