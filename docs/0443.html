<html>
<head>
<title>Reactive WebClient</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反应式web客户端</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/reactive-webclient-2c402f99584e?source=collection_archive---------0-----------------------#2020-12-16">https://medium.com/nerd-for-tech/reactive-webclient-2c402f99584e?source=collection_archive---------0-----------------------#2020-12-16</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c2fbd5d59e9c8ef12f55666b98416303.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qm2XDMQEPSwAqWjhGXHSZg.jpeg"/></div></div></figure><p id="b305" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Spring WebFlux提供了被动的WebClient来进行异步api调用。它是完全无阻塞的。我喜欢WebClient的一点是，它与<a class="ae jo" href="https://projectreactor.io/docs/core/release/reference/" rel="noopener ugc nofollow" target="_blank"> reactor </a> api集成得很好，提供了非常可读的代码，并且它可以以各种方式进行配置，我们马上就会看到这一点。</p><p id="1d1c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们从创建WebClient的实例开始。有两种方法可以做到:</p><ol class=""><li id="b44b" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">使用<strong class="is hj"> WebCient.create() </strong>或<strong class="is hj"> WebClient.builder() </strong>函数</li><li id="d6f9" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">自动连接<strong class="is hj">web客户端。spring提供的构建器</strong> Bean</li></ol><p id="7d71" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦创建，WebClient是不可变的，这使得它是线程安全的。您可以使用<strong class="is hj"> webClient.mutate() </strong>来重新配置它并获得一个新的实例。</p><p id="57c1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">由于我们已经创建了我们的WebClient，现在让我们进行一个api调用。</p><figure class="kd ke kf kg fd ij"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="fae7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已。仅用四行代码，我们就能够进行一个<strong class="is hj"> GET </strong> api <strong class="is hj"> </strong>调用。让我们分解代码，看看各个部分</p><ol class=""><li id="2697" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><strong class="is hj"> get() </strong>方法指定这是一个GET api调用</li><li id="1dd6" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj"> uri() </strong>接受uri字符串。您还可以使用另一种风格的<strong class="is hj"> uri() </strong>,它接受一个允许您使用UriBuilder配置uri的函数</li><li id="9284" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj"> retrieve() </strong>方法用于检索响应体。</li><li id="ed71" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is hj">body tomono(Customer::class . Java)</strong>真有意思。它使用<strong class="is hj"> Spring编解码器</strong>将数据反序列化为所需的域类。关于编解码器的更多信息；在这篇博客的后面</li></ol><p id="39fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">类似地，我们可以进行下面的post api调用。</p><figure class="kd ke kf kg fd ij"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="b255" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里唯一的区别是我们用来发送请求体的<strong class="is hj"> bodyValue() </strong>方法、<strong class="is hj"> </strong></p></div><div class="ab cl kj kk gp kl" role="separator"><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko kp"/><span class="km bw bk kn ko"/></div><div class="hb hc hd he hf"><p id="2255" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们看看我们可以对WebClient进行的一些配置。</p><blockquote class="kq kr ks"><p id="c2a0" class="iq ir kt is b it iu iv iw ix iy iz ja ku jc jd je kv jg jh ji kw jk jl jm jn hb bi translated">我们在项目中遵循的一件事，我发现它非常有用:在starter/library中的一个地方配置WebClient，并在所有微服务中使用它。这个实例将有一切配置:默认头，过滤器，编解码器，错误处理等。</p></blockquote><p id="09ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">默认标题</strong></p><p id="4c8a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们可以为来自应用程序的每个请求配置默认头</p><figure class="kd ke kf kg fd ij"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="3560" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">过滤器</strong></p><p id="deca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以创建自定义过滤器并将其插入到WebClient中，以拦截请求和/或响应。这有助于处理跨领域的问题，如身份验证或日志记录。下面是这种过滤器的一个例子:</p><figure class="kd ke kf kg fd ij"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="9b3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要将这个过滤器插入到WebClient中，我们可以使用WebClient builder提供的<strong class="is hj"> filter() </strong>方法</p><p id="96a7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">网络客户端编解码器</strong></p><p id="e6d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编解码器负责编码/解码来自网络呼叫的数据。WebClient为此使用了<a class="ae jo" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-codecs" rel="noopener ugc nofollow" target="_blank"> spring编解码器</a>，所以我们不必担心所有这些。</p><p id="d9ff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">但是，在某些情况下，我们必须使用自定义的编解码器；WebClient允许我们配置自定义编解码器，如下所示</p><figure class="kd ke kf kg fd ij"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="4773" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以通过扩展<strong class="is hj"> HttpMessageReader </strong>来创建自定义编解码器</p><p id="6192" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">关于编解码器的更多信息</strong></p><p id="ba40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">默认情况下，web客户端编解码器可以将256 KB的数据缓冲到内存中。因此，如果您得到一个大小超过256 KB的api响应，您将得到一个<strong class="is hj"> DataBufferLimitException </strong></p><p id="3e5d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以通过修改默认编解码器的设置来更改此限制，如下所示:</p><figure class="kd ke kf kg fd ij"><div class="bz dy l di"><div class="kh ki l"/></div></figure><p id="21f4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您也可以通过应用程序属性进行配置，设置<strong class="is hj">spring . codec . max-in-memore-size</strong>如下</p><pre class="kd ke kf kg fd kx ky kz la aw lb bi"><span id="f8f4" class="lc ld hi ky b fi le lf l lg lh">spring:<br/>  codec:<br/>    max-in-memory-size: 1048576</span></pre><blockquote class="kq kr ks"><p id="90e8" class="iq ir kt is b it iu iv iw ix iy iz ja ku jc jd je kv jg jh ji kw jk jl jm jn hb bi translated">但是要做到这一点，你必须使用网络客户端。spring boot提供的构建器bean。</p></blockquote><p id="1c24" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj"> <em class="kt">参考文献:</em> </strong></p><p id="6f49" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><a class="ae jo" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux" rel="noopener ugc nofollow" target="_blank"><em class="kt">Spring web flux的文档</em> </a></p><p id="8211" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">如果你喜欢这个博客，请鼓掌和/或在下面留下回应</strong></p><p id="d9fd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is hj">关注我，了解更多关于Kotlin、Spring Webflux、Reactor等的博客……</strong></p></div></div>    
</body>
</html>