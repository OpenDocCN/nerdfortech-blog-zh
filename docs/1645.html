<html>
<head>
<title>Log4J2 and JUnit 5 | How to test logs with JUnit 5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Log4J2 和 JUnit 5 |如何用 JUnit 5 测试日志</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/log4j2-and-junit-5-how-to-test-logs-with-junit-5-e5fa3eec82d2?source=collection_archive---------3-----------------------#2021-03-30">https://medium.com/nerd-for-tech/log4j2-and-junit-5-how-to-test-logs-with-junit-5-e5fa3eec82d2?source=collection_archive---------3-----------------------#2021-03-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/da5a1ebedd1653e1f8ea2e08f5bb9a93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cmGVDBdmz1PIRb3K"/></div></div><figcaption class="iq ir et er es is it bd b be z dx translated">照片由<a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae iu" href="https://unsplash.com/@petri_r?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Petri R </a>拍摄</figcaption></figure><p id="b6f9" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">最近我遇到了一个问题，我需要为我的应用程序记录一些警告。因为我通常从事测试驱动的工作，这对我来说非常重要，我可以为它创建一些单元测试。我的测试引擎是<a class="ae iu" href="https://junit.org/junit5/" rel="noopener ugc nofollow" target="_blank"> JUnit </a> 5。我找到了日志库<a class="ae iu" href="https://logging.apache.org/log4j/log4j-2.2/index.html" rel="noopener ugc nofollow" target="_blank"> Log4J </a>，从版本 2 (Log4J2)开始有了新名字，用的就是这个。</p><h1 id="bca2" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">Log4J2 是什么？</h1><p id="a912" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">Apache Log4j 2 是 Log4j 的升级版，Log4j 在业界很常见，它提供了对其前身 Log4j 1.x 的重大改进，并提供了 Logback 中的许多改进，同时修复了 Logback 架构中的一些固有问题。</p><h1 id="5e75" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">如何使用 Log4J2</h1><p id="b9e9" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">在我们使用 Log4J2 之前，我们必须配置一些东西。</p><h2 id="6e1b" class="kw ju hi bd jv kx ky kz jz la lb lc kd jg ld le kh jk lf lg kl jo lh li kp lj bi translated">属国</h2><p id="2469" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">首先，我们来看看<a class="ae iu" href="https://logging.apache.org/log4j/log4j-2.2/maven-artifacts.html" rel="noopener ugc nofollow" target="_blank">的依赖关系</a>:</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="7bcb" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">如您所见，我为 log4j 添加了两个实现，一个是 api，另一个是核心本身。应该是同一个版本。另外，我增加了 hakky54 的<a class="ae iu" href="https://github.com/Hakky54/log-captor" rel="noopener ugc nofollow" target="_blank">日志捕获者</a>。这对以后的单元测试非常重要。</p><h2 id="1bee" class="kw ju hi bd jv kx ky kz jz la lb lc kd jg ld le kh jk lf lg kl jo lh li kp lj bi translated">配置文件</h2><p id="de88" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">Log4J 需要<a class="ae iu" href="https://logging.apache.org/log4j/log4j-2.2/manual/configuration.html" rel="noopener ugc nofollow" target="_blank">配置</a>文件，这样它可以只显示相关的日志，而不是全部。</p><ol class=""><li id="2cfc" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js lv lw lx ly bi translated">Log4j 将检查“log4j.configurationFile”系统属性，如果设置了该属性，将尝试使用与文件扩展名匹配的 ConfigurationFactory 加载配置。</li><li id="e00e" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">如果没有设置系统属性，YAML 配置工厂将在类路径中查找 log4j2-test.yaml 或 log4j2-test.yml。</li><li id="85eb" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">如果没有找到这样的文件，JSON ConfigurationFactory 将在类路径中查找 log4j2-test.json 或 log4j2-test.jsn。</li><li id="908a" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">如果没有找到这样的文件，XML ConfigurationFactory 将在类路径中查找 log4j2-test.xml。</li><li id="1e0d" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">如果找不到测试文件，YAML 配置工厂将在类路径中查找 log4j2.yaml 或 log4j2.yml。</li><li id="d5fa" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">如果找不到 YAML 文件，JSON ConfigurationFactory 将在类路径中查找 log4j2.json 或 log4j2.jsn。</li><li id="f119" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">如果找不到 JSON 文件，XML ConfigurationFactory 将尝试在类路径中找到 log4j2.xml。</li><li id="a8f4" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">如果找不到配置文件，将使用默认配置。这将导致日志记录输出到控制台。</li></ol><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="83bc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是一个基本 xml 配置文件的示例。它使用控制台以定义的模式打印出日志。它看起来会像这样:</p><pre class="lk ll lm ln fd me mf mg mh aw mi bi"><span id="72b8" class="kw ju hi mf b fi mj mk l ml mm">07:39:56.263 [main] WARN  ClassToLog - Error Message</span></pre><p id="af85" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">可能最重要的部分是 Logger 标签。我们可以定义它的名称，它通常是我们需要记录的类的名称。</p><p id="e183" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">接下来是关卡。这是我们可以定义的日志级别，确切地说应该记录什么。例如，可能的值有:错误、警告、信息等。</p><p id="9da5" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">可加性也很重要。如果我们把这部分去掉，信息会打印两次。第一次来自根记录器，第二次来自自定义记录器。为了防止这种情况，我们必须将 additivity 设置为 false。</p><p id="5e67" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">关于日志级别的更多信息，我创建了另一个<a class="ae iu" rel="noopener" href="/codex/log4j2-create-custom-log-levels-and-how-to-use-them-48685e133fd1">博客</a>:</p><h2 id="0a83" class="kw ju hi bd jv kx ky kz jz la lb lc kd jg ld le kh jk lf lg kl jo lh li kp lj bi translated">如何记录</h2><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><p id="4af4" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">这是我要记录的班级。它在日志管理器的帮助下创建一个新的日志记录器。getLogger()也可以有一个 string 参数，但是因为我们无论如何都会使用 classname，这是默认的，所以我们不必设置它。</p><p id="41fc" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">然后我们可以调用 logger.warn(" ")，并在其中显示错误消息。它不一定是一个字符串。它也可能是一个例外或一个数字。</p><p id="23ee" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">我们也可以设置一些其他的值来代替 warn。此属性的有效值为“跟踪”、“调试”、“信息”、“警告”、“错误”和“致命”。</p><h1 id="b823" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">如何测试日志</h1><p id="c6be" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">因为我们喜欢用单元测试来测试一切，所以让我们也用日志来测试。遗憾的是，JUnit 中没有集成 appender 来测试日志。我们需要自己定义它，因此会产生大量样板代码。</p><p id="a6d0" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">更好的解决方案是使用我之前在 build.gradle.kts 中添加的插件。它为我们管理所有的东西，非常容易使用。</p><figure class="lk ll lm ln fd ij"><div class="bz dy l di"><div class="lo lp l"/></div></figure><ol class=""><li id="8aea" class="lq lr hi ix b iy iz jc jd jg ls jk lt jo lu js lv lw lx ly bi translated">创建我们想要测试的类的对象，这样我们可以稍后对它执行函数调用。</li><li id="6309" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">创建日志捕获器。类名需要与之前定义的相同。</li><li id="6621" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">现在我们可以调用应该记录警告的函数。</li><li id="f54e" class="lq lr hi ix b iy lz jc ma jg mb jk mc jo md js lv lw lx ly bi translated">使用 logCaptor.warnLogs，我们可以准确地看到为这个类记录器记录了哪些级别为“warning”的日志。因为我们在这个类中只记录了一个警告，所以我们可以使用 containsExactly()。</li></ol><h1 id="e1ca" class="jt ju hi bd jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">反射</h1><h2 id="6daa" class="kw ju hi bd jv kx ky kz jz la lb lc kd jg ld le kh jk lf lg kl jo lh li kp lj bi translated">什么进展顺利？</h2><p id="f4d1" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">Log4J2 的日志本身工作得非常好，非常快。我能够很容易地记录一些非常基础的东西。此外，logCaptor 的表现比预期的要好。</p><h2 id="1016" class="kw ju hi bd jv kx ky kz jz la lb lc kd jg ld le kh jk lf lg kl jo lh li kp lj bi translated">有哪些需要改进的地方？</h2><p id="e425" class="pw-post-body-paragraph iv iw hi ix b iy kr ja jb jc ks je jf jg kt ji jj jk ku jm jn jo kv jq jr js hb bi translated">我遇到的最大问题是，有很多关于如何用 JUnit 测试日志的资源，但实际上它们都使用旧版本的 Log4J，或者使用与 JUnit5 非常不同的 JUnit4。例如，JUnit 5 中不赞成使用规则注释。我自己尝试了很多编写 appender 的方法，但是总是失败。最后，logCaptor 对我来说是唯一真正的解决方案。</p><p id="dd20" class="pw-post-body-paragraph iv iw hi ix b iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js hb bi translated">希望这篇文章能帮到你。快乐伐木😊</p></div></div>    
</body>
</html>