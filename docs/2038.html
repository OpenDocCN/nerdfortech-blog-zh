<html>
<head>
<title>Build a Forum with GraphQL Powered API in Laravel — [Part 2] Auth</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Laravel中用GraphQL驱动的API构建一个论坛—[第2部分] Auth</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/build-a-forum-with-graphql-powered-api-in-laravel-part-2-auth-ede9b57a3cf0?source=collection_archive---------6-----------------------#2021-04-18">https://medium.com/nerd-for-tech/build-a-forum-with-graphql-powered-api-in-laravel-part-2-auth-ede9b57a3cf0?source=collection_archive---------6-----------------------#2021-04-18</a></blockquote><div><div class="dt gx gy gz ha hb"/><div class="hc hd he hf hg"><div class=""/><p id="dbf6" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">在这一部分中，我们将讨论用户的认证。为此，我们将使用Laravel护照。运行以下命令来安装该软件包。</p></div><div class="ab cl je jf gq jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hc hd he hf hg"><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="ea84" class="ju jv hj jq b fj jw jx l jy jz">composer require laravel/passport</span></pre><p id="b6e1" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">现在让我们从Laravel Passport开始配置每个包，因为我们将首先运行迁移。</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="9a46" class="ju jv hj jq b fj jw jx l jy jz">php artisan migrate</span></pre><figure class="jl jm jn jo fe kb es et paragraph-image"><div class="es et ka"><img src="../Images/29eec833d627493fa16f25a2e18ee0a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*mx2D3962G2tP8F4lK_-3-Q.png"/></div></figure><p id="6a3a" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">运行迁移后，我们需要安装laravel/passport，为此我们需要运行以下命令:</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="f91f" class="ju jv hj jq b fj jw jx l jy jz">php artisan passport:install</span></pre><figure class="jl jm jn jo fe kb es et paragraph-image"><div class="es et ke"><img src="../Images/025bd0eb6a1c2ab1ef430433be31bdb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1038/format:webp/1*8ChQxmv_TjiqTgi3DplvJQ.png"/></div></figure><p id="216c" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">然后将HasApiTokens特征添加到您的用户模型中</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="f141" class="ju jv hj jq b fj jw jx l jy jz">use Illuminate\Database\Eloquent\Factories\HasFactory;<br/>use Illuminate\Foundation\Auth\User as Authenticatable;<br/>use Illuminate\Notifications\Notifiable;<br/>use Laravel\Passport\HasApiTokens;<br/><br/>class User extends <em class="kf">Authenticatable<br/></em>{<br/>    use HasApiTokens, HasFactory, Notifiable;<br/>}</span></pre><p id="7102" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">我们需要在AuthServiceProvider中添加以下引导方法:</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="ce13" class="ju jv hj jq b fj jw jx l jy jz">public function boot()<br/>{<br/>    $this-&gt;registerPolicies();<br/><br/>    Passport::<em class="kf">routes</em>();<br/><br/>    Passport::<em class="kf">enableImplicitGrant</em>();<br/><br/>    Passport::<em class="kf">tokensExpireIn</em>(now()-&gt;addDays(15));<br/><br/>    Passport::<em class="kf">refreshTokensExpireIn</em>(now()-&gt;addDays(30));<br/>}</span></pre></div><div class="ab cl je jf gq jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hc hd he hf hg"><p id="e322" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">让我们看看GraphQl模式应该是什么样子。我们已经在之前的文章中定义了用户类型。</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="40e2" class="ju jv hj jq b fj jw jx l jy jz">type Mutation {<br/>  loginUser(email: String!, password: String!): AuthPayload<br/>}</span><span id="a419" class="ju jv hj jq b fj kg jx l jy jz">type AuthPayload {<br/>  access_token: String!<br/>  refresh_token: String!<br/>  expires_in: Int!<br/>  token_type: String!<br/>  user: User!<br/>}</span></pre><p id="46cf" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">现在让我们用PHP代码定义我们的AuthPayloadType。它应该看起来像下面这样:</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="4dda" class="ju jv hj jq b fj jw jx l jy jz">class AuthPayload extends <em class="kf">GraphQLType </em>{<br/><br/>    protected $attributes = [<br/>        'name'          =&gt; 'AuthPayload',<br/>        'description'   =&gt; 'AuthPayload response',<br/>    ];<br/><br/>    public function fields(): array<br/>    {<br/>        return [<br/>            'access_token' =&gt; [<br/>                'type'          =&gt; Type::<em class="kf">nonNull</em>(Type::<em class="kf">string</em>()),<br/>                'description'   =&gt; 'access token',<br/>            ],<br/>            'refresh_token' =&gt; [<br/>                'type'          =&gt; Type::<em class="kf">nonNull</em>(Type::<em class="kf">string</em>()),<br/>                'description'   =&gt; 'refresh token',<br/>            ],<br/>            'expires_in' =&gt; [<br/>                'type'          =&gt; Type::<em class="kf">nonNull</em>(Type::<em class="kf">int</em>()),<br/>                'description'   =&gt; 'expires in',<br/>            ],<br/>            'token_type' =&gt; [<br/>                'type'          =&gt; Type::<em class="kf">nonNull</em>(Type::<em class="kf">string</em>()),<br/>                'description'   =&gt; 'token type',<br/>            ],<br/>            'user' =&gt; [<br/>                'type'          =&gt; Type::<em class="kf">nonNull</em>(GraphQL::<em class="kf">type</em>('User')),<br/>                'description'   =&gt; 'User profile',<br/>            ],<br/>        ];<br/>    }<br/>}</span></pre><p id="140c" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">Laravel passport没有GraphQl的默认实现，为此我们需要做一些变通来获得auth令牌。为此，我查看了这个资源库<a class="ae kh" href="https://github.com/joselfonseca/lighthouse-graphql-passport-auth" rel="noopener ugc nofollow" target="_blank">https://github . com/joselfonseca/light house-graph QL-passport-auth</a>。为了获得访问令牌，他向passport端点发出请求。这些请求看起来像这样:</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="25c1" class="ju jv hj jq b fj jw jx l jy jz">$credentials = [<br/>'client_id' =&gt; 'test'<br/>'scope' =&gt; '*'<br/>'client_secret' =&gt; 'test'<br/>'grant_type' =&gt; 'password'<br/>'username' =&gt; 'test'<br/>'password' =&gt; 'test'<br/>];<br/>$request = Request::<em class="kf">create</em>('oauth/token', 'POST', $credentials, [], [], [<br/>    'HTTP_Accept' =&gt; 'application/json',<br/>]);<br/><br/>$response = app()-&gt;handle($request);</span></pre><p id="d2f0" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">在我们的例子中，我们将它包装在一个简单的服务中，该服务将会处理它，它看起来像这样:</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="a8b5" class="ju jv hj jq b fj jw jx l jy jz">class PassportService<br/>{<br/>    public function buildCredentials(array $args = [], $grantType = 'password'): array<br/>    {<br/>        $args = collect($args);<br/>        $credentials = $args-&gt;except('directive')-&gt;toArray();<br/>        $credentials['client_id'] = $args-&gt;get('client_id', env('PASSPORT_CLIENT_ID'));<br/>        $credentials['client_secret'] = $args-&gt;get('client_secret', env('PASSPORT_CLIENT_SECRET'));<br/>        $credentials['grant_type'] = $grantType;<br/>        $credentials['scope'] = '*';<br/><br/>        return $credentials;<br/>    }<br/><br/>    public function makeRequest(array $credentials)<br/>    {<br/>        $request = Request::<em class="kf">create</em>('oauth/token', 'POST', $credentials, [], [], [<br/>            'HTTP_Accept' =&gt; 'application/json',<br/>        ]);<br/><br/>        $response = app()-&gt;handle($request);<br/><br/>        $decodedResponse = json_decode($response-&gt;getContent(), true);<br/><br/>        if ($response-&gt;getStatusCode() != 200) {<br/>            if ($decodedResponse['message'] === 'The provided authorization grant (e.g., authorization code, resource owner credentials) or refresh token is invalid, expired, revoked, does not match the redirection URI used in the authorization request, or was issued to another client.') {<br/>                throw new AuthenticationException(__('Authentication exception'), __('Incorrect username or password'));<br/>            }<br/><br/>            throw new AuthenticationException(__($decodedResponse['error']), __($decodedResponse['message']));<br/>        }<br/><br/>        return $decodedResponse;<br/>    }<br/><br/>}</span></pre><p id="2304" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">到目前为止，我们创建了我们的AuthPayload，我们制作了passport令牌的包装器，接下来我们需要为登录创建突变。它是这样显示的:</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="d716" class="ju jv hj jq b fj jw jx l jy jz">class Login extends Mutation<br/>{<br/>    protected PassportService $passportService;<br/><br/>    public function __construct(PassportService $passportService)<br/>    {<br/>        $this-&gt;passportService = $passportService;<br/>    }<br/><br/>    public function args(): array<br/>    {<br/>        return [<br/>            'username' =&gt; [<br/>                'name' =&gt; 'username',<br/>                'type' =&gt;  Type::<em class="kf">nonNull</em>(Type::<em class="kf">string</em>()),<br/>            ],<br/>            'password' =&gt; [<br/>                'name' =&gt; 'password',<br/>                'type' =&gt;  Type::<em class="kf">nonNull</em>(Type::<em class="kf">string</em>()),<br/>            ],<br/>        ];<br/>    }<br/><br/>    public function resolve($root, $args, $context, ResolveInfo $resolveInfo, Closure $getSelectFields)<br/>    {<br/>        $credentials = $this-&gt;passportService-&gt;buildCredentials($args);<br/><br/>        $response = $this-&gt;passportService-&gt;makeRequest($credentials);<br/><br/>        $user = User::<em class="kf">where</em>('email', $args['username'])-&gt;first();<br/><br/>        return array_merge(<br/>            $response,<br/>            [<br/>                'user' =&gt; $user,<br/>            ]<br/>        );<br/>    }<br/><br/>    public function rules(array $args = []): array<br/>    {<br/>        return [<br/>            'username' =&gt; [<br/>                'required', 'email',<br/>            ],<br/>            'password' =&gt; [<br/>                'required', 'string', 'min:5'<br/>            ],<br/>        ];<br/>    }<br/><br/>    public function type(): Type<br/>    {<br/>        return GraphQL::<em class="kf">type</em>('AuthPayload');<br/>    }<br/>}</span></pre><p id="3917" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">这样一来，让我们测试一下，看看结果。响应中应该有access_token、refresh_token和用户详细信息。</p><figure class="jl jm jn jo fe kb es et paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="es et ki"><img src="../Images/71d6f764275994fd4766203146c659ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EopDhOF6hujJNdQBpMgbbg.png"/></div></div></figure><p id="a4dd" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">为了使<code class="dv kn ko kp jq b">config/graphql.php</code>更具可读性，我为我们的模式创建了一些类。默认方案是这样的:</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="4563" class="ju jv hj jq b fj jw jx l jy jz">use Rebing\GraphQL\Support\Contracts\ConfigConvertible;<br/><br/>class DefaultSchema implements ConfigConvertible<br/>{<br/>    public function toConfig(): array<br/>    {<br/>        return [<br/>            'query' =&gt; [<br/>                'user' =&gt; UserQuery::class,<br/>                'users' =&gt; UsersQuery::class,<br/>            ],<br/>            'mutation' =&gt; [<br/>                'createUser' =&gt; CreateUserMutation::class,<br/>                'loginUser' =&gt; Login::class,<br/>            ],<br/>            'types' =&gt; [<br/>                'User' =&gt; UserType::class,<br/>                'AuthPayload' =&gt; AuthPayload::class,<br/>            ],<br/>            'middleware' =&gt; [],<br/>            'method' =&gt; ['get', 'post'],<br/>        ];<br/>    }<br/>}</span></pre><p id="edbb" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">我们需要在<code class="dv kn ko kp jq b">config/graphql.php </code>模式中为登录用户定义一个受保护的区域。定义GraphQL端点需要模式。除了全局中间件之外，您还可以定义多个模式，并为它们分配不同的HTTP中间件。例如:</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="ab53" class="ju jv hj jq b fj jw jx l jy jz">'schema' =&gt; 'default',<br/><br/>'schemas' =&gt; [<br/>    'default' =&gt; [<br/>        'query' =&gt; [<br/>            'someQuery' =&gt; AnotherExampleQuery::class,<br/>        ],<br/>        'mutation' =&gt; [<br/>            ExampleMutation::class,<br/>        ],<br/>        'types' =&gt; [<br/>        ],<br/>    ],<br/>    'user' =&gt; [<br/>        'query' =&gt; [<br/>            App\GraphQL\Queries\ProfileQuery::class<br/>        ],<br/>        'middleware' =&gt; ['auth'],<br/>    ],<br/>],</span></pre><p id="b9fc" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">在我们的例子中，这看起来有点不同，因为我们在类中分离了模式，它看起来像这样:</p><pre class="jl jm jn jo fe jp jq jr js aw jt bi"><span id="90f2" class="ju jv hj jq b fj jw jx l jy jz">'schemas' =&gt; [<br/>    'default' =&gt; \App\GraphQL\Schemas\DefaultSchema::class,<br/>    'auth' =&gt; \App\GraphQL\Schemas\AuthSchema::class,<br/>],</span></pre><p id="9782" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">对于您将定义的每个模式，链接将看起来像这样<a class="ae kh" href="http://127.0.0.1:8000/graphql/auth" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8000/graph QL/</a>{ schema }在我们的例子中是<a class="ae kh" href="http://127.0.0.1:8000/graphql/auth" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8000/graph QL/auth</a></p><p id="3751" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">为了让用户登录，我们需要在请求中添加授权头，并放入获得的访问令牌。结果应该是如下所示:</p><figure class="jl jm jn jo fe kb es et paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="es et kq"><img src="../Images/753cf7426f33be713be41de6b77b63a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3RSEsyNJX-kDnaE8sGButw.png"/></div></div></figure></div><div class="ab cl je jf gq jg" role="separator"><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj jk"/><span class="jh bw bk ji jj"/></div><div class="hc hd he hf hg"><p id="1e15" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">回购环节:<a class="ae kh" href="https://github.com/mihaisolomon/forum-app" rel="noopener ugc nofollow" target="_blank">https://github.com/mihaisolomon/forum-app</a></p><p id="8a70" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">第1部分:<a class="ae kh" href="https://solomons.work/build-a-forum-with-graphql-powered-api-in-laravel-part-1-de032d13d628" rel="noopener ugc nofollow" target="_blank">用GraphQL驱动的API构建一个论坛——构建我们的第一个查询和变异。</a></p><p id="ebf0" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">第2部分:<a class="ae kh" rel="noopener" href="/nerd-for-tech/build-a-forum-with-graphql-powered-api-in-laravel-part-2-auth-ede9b57a3cf0">用GraphQL驱动的API构建一个论坛——用passport进行用户认证</a></p><p id="bc4a" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">第3部分:<a class="ae kh" rel="noopener" href="/nerd-for-tech/build-a-forum-with-graphql-powered-api-in-laravel-part-3-channels-threads-and-replies-bd7423ee1c98">在Laravel中用GraphQL Powered API构建一个论坛—【第3部分】通道、线程和回复</a></p><p id="7184" class="pw-post-body-paragraph ig ih hj ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc jd hc bi translated">第4部分:<a class="ae kh" href="https://solomons.work/search-in-threads-forum-graphql-powered-api-in-laravel-part-4-ead4ed28b70f" rel="noopener ugc nofollow" target="_blank">线程中的搜索Laravel中的论坛GraphQL Powered API【第4部分】</a></p></div></div>    
</body>
</html>