<html>
<head>
<title>What I built (4) — browser extension to generate QR Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我构建了什么(4) —生成二维码的浏览器扩展</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/what-i-built-4-browser-extension-to-generate-qr-code-1ac6c17d00f7?source=collection_archive---------25-----------------------#2021-03-15">https://medium.com/nerd-for-tech/what-i-built-4-browser-extension-to-generate-qr-code-1ac6c17d00f7?source=collection_archive---------25-----------------------#2021-03-15</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="8808" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个浏览器扩展，为选定文本或当前页面 URL 生成 QR 代码。</p><h1 id="7e17" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">意图和背景</h1><p id="7ed8" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">这是我重新思考 OCR 解决方案的一个项目:</p><div class="kg kh ez fb ki kj"><a rel="noopener follow" target="_blank" href="/swlh/what-i-built-1-a-website-that-ocr-selected-text-on-screen-fca8f107228c"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">我建立了什么(1)-一个网站，光学字符识别选择屏幕上的文本</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">这是我在 WFH 期间建造的第一批东西之一。</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">medium.com</p></div></div><div class="ks l"><div class="kt l ku kv kw ks kx ky kj"/></div></div></a></div><p id="f34b" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">OCR 解决方案的问题是准确性和速度不令人满意，因此考虑从 PC 复制文本并在移动电话中使用它的相同问题，一种方法是使用中间人，如 Signal、WhatsApp、email…但我的观点是使用相机(以前解决方案中的 OCR 或本解决方案中的 QR 码扫描)。</p><h1 id="0984" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">它的作用</h1><p id="949f" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">它显示当前 URL 或选定文本的 QR 码，并允许手机扫描它以获取文本。</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es kz"><img src="../Images/9a7deca2045f5527d670dfbc8bf5295f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RB2-YrL-vizsF7V-rnhgzQ.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">右上方的弹出窗口(单击扩展图标时)，通过单击按钮，它将当前 URL 或所选文本转换为 QR 码并显示在此面板中</figcaption></figure><h1 id="8bfa" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">使用的主要技术</h1><ul class=""><li id="6808" class="lo lp hi ih b ii kb im kc iq lq iu lr iy ls jc lt lu lv lw bi translated">React.js 带“创建-反应-应用”</li><li id="a5ee" class="lo lp hi ih b ii lx im ly iq lz iu ma iy mb jc lt lu lv lw bi translated">“customize-cra”包创建多个入口点(因为 create-react-app 默认提供单个入口点)</li><li id="a645" class="lo lp hi ih b ii lx im ly iq lz iu ma iy mb jc lt lu lv lw bi translated">“二维码”包生成二维码</li></ul><h1 id="957d" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">开始吧</h1><p id="a59d" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我遵循的主要参考是:</p><div class="kg kh ez fb ki kj"><a href="https://dev.to/jamalx31/use-create-react-app-to-develop-a-chrome-extension-14ld" rel="noopener  ugc nofollow" target="_blank"><div class="kk ab dw"><div class="kl ab km cl cj kn"><h2 class="bd hj fi z dy ko ea eb kp ed ef hh bi translated">使用 create-react-app 开发 Chrome 扩展</h2><div class="kq l"><h3 class="bd b fi z dy ko ea eb kp ed ef dx translated">create-react-app (CRA)可能是构建、开发和部署 react 应用程序最常见的方式。几周前…</h3></div><div class="kr l"><p class="bd b fp z dy ko ea eb kp ed ef dx translated">开发到</p></div></div><div class="ks l"><div class="mc l ku kv kw ks kx ky kj"/></div></div></a></div><h2 id="05fa" class="md je hi bd jf me mf mg jj mh mi mj jn iq mk ml jr iu mm mn jv iy mo mp jz mq bi translated">为什么我需要多个入口点</h2><p id="1950" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">答案是当前的实现还不需要这样做，但我觉得将来可能需要，所以我最好做好准备。人们可能会建议使用 webpack 来管理解决方案打包，我只是没有足够的经验来管理 webpack，create-react-app 有默认设置，应该会做得很好，在 customize-cra 的帮助下，确实达到了目的，这是我目前的“目标”，毕竟，学习新的东西是令人兴奋的。</p><h1 id="9b9f" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">代码/配置片段</h1><h2 id="ab99" class="md je hi bd jf me mf mg jj mh mi mj jn iq mk ml jr iu mm mn jv iy mo mp jz mq bi translated">Manifest.json</h2><p id="ac25" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">我的清单文件如下所示:</p><pre class="la lb lc ld fd mr ms mt mu aw mv bi"><span id="0a80" class="md je hi ms b fi mw mx l my mz">{<br/>  "name": "Selected Text QR Extension",<br/>  "version": "0.0.0.1",<br/>  "manifest_version": 2,<br/>  "description": "extensions to generate QR code for selected text",<br/>  "icons": {<br/>    "128": "logo192.png"<br/>  },<br/>  "permissions": ["activeTab", "tabs"],<br/>  "browser_action": {<br/>    "default_icon": "logo192.png",<br/>    "default_popup": "pages/popup.html"<br/>  },<br/>  "options_ui":{ "page": "pages/options.html" }<br/>}</span></pre><p id="5521" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">老实说，我不确定所定义的权限是否有点太多，但我使用 browser.tabs.executeScript()来调用“window.getSelection()。toString()”，我敢打赌这不是使文本被选中的最合适的方式，但这是我目前找到的第一个解决方案，这导致我添加“制表符”权限。</p><p id="8548" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我添加了 2 个路由(页面)，将调用“pages/popup.html”来打开主弹出页面，pages/options.html 用于 option_ui 页面(目前是一个虚拟页面，但在将来的增强中应该是其他页面)。</p><p id="1463" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">清单中的“options_page”的行为似乎与“options_ui”不同，我还不知道“options_page”应该是什么样子。</p><figure class="la lb lc ld fd le er es paragraph-image"><div role="button" tabindex="0" class="lf lg di lh bf li"><div class="er es kz"><img src="../Images/aacf185747c0b819c9dd462caeea62d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JOaWR7MivUSPzImyqcwhAw.png"/></div></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">虚拟选项用户界面页面。</figcaption></figure><h2 id="a22c" class="md je hi bd jf me mf mg jj mh mi mj jn iq mk ml jr iu mm mn jv iy mo mp jz mq bi translated">配置-覆盖. js</h2><p id="8400" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">此文件用于 customize-cra，multipleEntry 允许 create-react-app 有多个入口点(而不是只有“/”)，结果会将“Entry”和“template”文件复制到“outPath”。</p><p id="437d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">“copyPlugin”是将配置中指示的非入口点文件复制到“build”文件夹根目录，因为我们的扩展将被压缩，并且这些文件应该在 zip 的根目录中找到,“to”是空字符串以指示根目录。</p><p id="64eb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">其余部分来自参考网页，我没有接触过它们。</p><pre class="la lb lc ld fd mr ms mt mu aw mv bi"><span id="bf51" class="md je hi ms b fi mw mx l my mz">const {<br/> override,<br/> overrideDevServer,<br/> addWebpackPlugin<br/>} = require("customize-cra");<br/>const CopyPlugin = require('copy-webpack-plugin');</span><span id="a08d" class="md je hi ms b fi na mx l my mz">const multipleEntry = require('react-app-rewire-multiple-entry')([<br/> {<br/>   // points to the popup entry point<br/>   entry: 'src/popup/index.js',<br/>   template: 'public/pages/popup.html',<br/>   outPath: 'pages/popup.html'<br/> },<br/> {<br/>   // points to the options page entry point<br/>   entry: 'src/options/index.js',<br/>   template: 'public/pages/options.html',<br/>   outPath: 'pages/options.html'<br/> }<br/>]);</span><span id="4028" class="md je hi ms b fi na mx l my mz">const devServerConfig = () =&gt; config =&gt; {<br/> return {<br/>   ...config,<br/>   // webpackDevService doesn't write the files to desk<br/>   // so we need to tell it to do so so we can load the<br/>   // extension with chrome<br/>   writeToDisk: true<br/> }<br/>}</span><span id="22f5" class="md je hi ms b fi na mx l my mz">const copyPlugin = new CopyPlugin({<br/> patterns: [<br/>  // copy assets<br/>  { from: 'public', to: '' },<br/>  { from: 'src/background.js', to: '' },<br/>  // { from: 'src/content.js', to: '' }<br/>  { from: 'node_modules/webextension-polyfill/dist/browser-polyfill.js' },<br/> ]<br/>})</span><span id="a979" class="md je hi ms b fi na mx l my mz">module.exports = {<br/> webpack: override(<br/>   addWebpackPlugin(<br/>    copyPlugin<br/>   ),<br/>   multipleEntry.addMultiEntry,<br/> ),<br/> devServer: overrideDevServer(<br/>   devServerConfig()<br/> ),</span><span id="52da" class="md je hi ms b fi na mx l my mz">};</span></pre><h2 id="2359" class="md je hi bd jf me mf mg jj mh mi mj jn iq mk ml jr iu mm mn jv iy mo mp jz mq bi translated">文件夹结构</h2><p id="5ea3" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">文件夹结构主要遵循 create-react-app 提供的内容，但以下内容除外:</p><pre class="la lb lc ld fd mr ms mt mu aw mv bi"><span id="2812" class="md je hi ms b fi mw mx l my mz">Root<br/> &gt; build/ // this is create by webpack<br/> &gt; node_modules/<br/> &gt; public/<br/>   &gt; pages/ // this is created to host the "templates" html <br/>     &gt; options.html // copy of the index.html of create-react-app<br/>     &gt; popup.html // copy of the index.html of create-react-app<br/>     &gt; ...<br/> &gt; src/<br/>    &gt; options/ // the files below are copy from create-react-app<br/>      &gt; App.js // modified to serve option page component<br/>      &gt; App.test.js<br/>      &gt; index.js // entry point of options page<br/>    &gt; popup/<br/>      &gt; ... // similar to options above<br/>    ... // the rest from create-react-app<br/> &gt; config-overrides.js // the override config file for customize-cra<br/> ... // the rest from create-react-app</span></pre><figure class="la lb lc ld fd le er es paragraph-image"><div class="er es nb"><img src="../Images/a29d6be31aafa0e634d2015f9fefe236.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*Dx44cTsv28yQOwLHXPmqyg.png"/></div><figcaption class="lk ll et er es lm ln bd b be z dx translated">为了补充上面的解释</figcaption></figure><p id="11b2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">请注意，src 文件夹级别仍然有 App.js 和 index.js，即使它们没有被使用，如果没有它们，构建将无法工作，它们可能是空文件。</p><h2 id="bf33" class="md je hi bd jf me mf mg jj mh mi mj jn iq mk ml jr iu mm mn jv iy mo mp jz mq bi translated">获取选择文本并生成 QR 码的核心代码</h2><p id="1af1" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">这是我觉得我做得不是最好的部分(至少从安全角度来看，因为我使用 browser.tabs.executeScript，我觉得它在未来会受到限制)，下面是按钮单击事件处理程序的代码。</p><pre class="la lb lc ld fd mr ms mt mu aw mv bi"><span id="2434" class="md je hi ms b fi mw mx l my mz">function handleClickGetUrl() {<br/>  browser.tabs.executeScript( {<br/>    code: "window.location.href.toString();"<br/>  }).then(text =&gt; {<br/>    QRCode.toCanvas(canvasRef.current, text);<br/>  })<br/>}</span></pre><h1 id="89c9" class="jd je hi bd jf jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka bi translated">结论</h1><p id="9b57" class="pw-post-body-paragraph if ig hi ih b ii kb ik il im kc io ip iq kd is it iu ke iw ix iy kf ja jb jc hb bi translated">对我自己来说，最快乐的收获是开始知道如何用 customize-cra 允许 create-react-app 的多个条目，这在我的其他项目中可能非常有用。</p></div></div>    
</body>
</html>