<html>
<head>
<title>Monitoring &amp; Alerting for WireGuard VPN</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">WireGuard VPN的监控和警报</h1>
<blockquote>原文：<a href="https://medium.com/nerd-for-tech/wireguard-vpn-monitoring-alerting-e1e1d1eaaa4e?source=collection_archive---------0-----------------------#2021-10-08">https://medium.com/nerd-for-tech/wireguard-vpn-monitoring-alerting-e1e1d1eaaa4e?source=collection_archive---------0-----------------------#2021-10-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/d99dd4ccdc3cc80612b75ab57bf0a20d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*N6uC8kg_cMXzhn-Rc_dTdg.png"/></div></figure><h1 id="4adb" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">介绍</h1><p id="c75d" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">WireGuard是Jason A. Donenfeld开发的一款快速、现代、安全的VPN隧道软件。它的目标是比IPsec更快、更简单、更精简、更有用，或者比OpenVPN性能更好。</p><blockquote class="ki"><p id="5364" class="kj kk hi bd kl km kn ko kp kq kr kh dx translated">Wireguard是“艺术品”——莱纳斯·托沃兹</p></blockquote><p id="0ef4" class="pw-post-body-paragraph jk jl hi jm b jn ks jp jq jr kt jt ju jv ku jx jy jz kv kb kc kd kw kf kg kh hb bi translated">当您的WireGuard VPN隧道为关键服务供电时，监控VPN隧道的健康状况并设置警报非常重要。</p><p id="1d0c" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">在本文中，我们将设置Prometheus WireGuard exporter、Grafana仪表板和警报管理器。</p></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h1 id="e7b0" class="im in hi bd io ip lj ir is it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj bi translated">WireGuard普罗米修斯出口商</h1><p id="a5c5" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">首先，我们将在WireGuard实例上安装WireGuard Prometheus exporter。基本上，导出器以普罗米修斯理解的格式公开<code class="du lo lp lq lr b">wg show all dump</code>结果。</p><p id="4754" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">导出器是用Rust编写的，无论是在内存还是CPU使用方面，它对服务器资源的占用都非常少。</p><p id="cfe8" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">目前，还没有为导出程序预先构建的二进制文件。因此，我们必须建造它。因为它是用Rust编写的，所以相当简单。</p><p id="b35d" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated"><strong class="jm hj">注意:</strong>使用的是<code class="du lo lp lq lr b">yum</code>，你可以任意选择包管理器。</p><h2 id="a54c" class="ls in hi bd io lt lu lv is lw lx ly iw jv lz ma ja jz mb mc je kd md me ji mf bi translated">1.建立和安装wireguard普罗米修斯出口商</h2><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="8ff2" class="ls in hi lr b fi mo mp l mq mr">$ yum install cargo  # RedHat-based<br/>$ cargo install prometheus_wireguard_exporter<br/>$ install -m755 /root/.cargo/bin/prometheus_wireguard_exporter /usr/local/bin/<br/>$ yum remove cargo</span></pre><h2 id="55bc" class="ls in hi bd io lt lu lv is lw lx ly iw jv lz ma ja jz mb mc je kd md me ji mf bi translated">2.为导出程序安装systemd服务</h2><p id="98ee" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated"><strong class="jm hj">注意:</strong>如果您使用定制的WireGuard配置，请指定替代<code class="du lo lp lq lr b">/etc/wireguard/wg0.conf</code></p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="89ab" class="ls in hi lr b fi mo mp l mq mr">$ cat &lt;&lt;EOF  &gt; /etc/systemd/system/prometheus-wireguard-exporter.service<br/>[Unit]<br/>Description=Prometheus WireGuard Exporter<br/>Wants=network-online.target<br/>After=network-online.target<br/><br/>[Service]<br/>User=root<br/>Group=root<br/>Type=simple<br/>ExecStart=/usr/local/bin/prometheus_wireguard_exporter -n /etc/wireguard/wg0.conf<br/><br/>[Install]<br/>WantedBy=multi-user.target<br/>EOF</span></pre><p id="cc0a" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">并通过运行以下命令启用导出器服务:</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="a382" class="ls in hi lr b fi mo mp l mq mr">$ systemctl enable --now prometheus-wireguard-exporter.service</span></pre><h2 id="87fd" class="ls in hi bd io lt lu lv is lw lx ly iw jv lz ma ja jz mb mc je kd md me ji mf bi translated">3.验证导出器服务正在运行</h2><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="e283" class="ls in hi lr b fi mo mp l mq mr">$ curl localhost:9586/metrics</span></pre></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h1 id="4de3" class="im in hi bd io ip lj ir is it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj bi translated">配置普罗米修斯</h1><p id="99a2" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">接下来，我们将配置Prometheus来收集Wireguard导出器指标。</p><p id="97bf" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">将以下scape配置作业添加到<code class="du lo lp lq lr b">/etc/prometheus/prometheus.yaml</code></p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="698f" class="ls in hi lr b fi mo mp l mq mr">- job_name: wireguard-exporter<br/>    static_configs:<br/>    - labels:<br/>        instance: my-wireguard-tunnel<br/>      targets:<br/>      - IP_OF_EXPORTER:9586</span></pre><p id="9cc1" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">并重新加载普罗米修斯服务</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="d915" class="ls in hi lr b fi mo mp l mq mr">$ systemctl reload prometheus</span></pre></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h1 id="6147" class="im in hi bd io ip lj ir is it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj bi translated">Wireguard Grafana仪表板</h1><ol class=""><li id="bd10" class="ms mt hi jm b jn jo jr js jv mu jz mv kd mw kh mx my mz na bi translated">登录您的Grafana用户界面</li><li id="162d" class="ms mt hi jm b jn nb jr nc jv nd jz ne kd nf kh mx my mz na bi translated">下载以下JSON文件并将dashboard作为JSON文件导入</li></ol><p id="11ff" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated"><a class="ae ng" href="https://github.com/tuladhar/wireguard-connectivity-monitoring/blob/main/wireguard-grafana-dashboard.json" rel="noopener ugc nofollow" target="_blank">https://github . com/tuladhar/wire guard-connectivity-monitoring/blob/main/wire guard-grafana-dashboard . JSON</a></p><figure class="mg mh mi mj fd ij er es paragraph-image"><div class="er es nh"><img src="../Images/4bf89adf3f7bb095ba8a75ee221840e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:518/format:webp/1*d5goC8YTTwyPexeQ2R0JuA.png"/></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:导入仪表板按钮屏幕</figcaption></figure><figure class="mg mh mi mj fd ij er es paragraph-image"><div class="er es nm"><img src="../Images/530d39e588b1a9374ac0618b10a33ce3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*K56lDSqwPhDYNad2s7gpbA.png"/></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:从文件导入屏幕</figcaption></figure><p id="1aed" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">3.最后，点击导入。</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="er es nn"><img src="../Images/1680cb18af923bb689de1890216f05a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EupekWV0O72m-0Shl_Tj2g.png"/></div></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:导入仪表板屏幕</figcaption></figure><p id="354e" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">现在，复制“最后一次握手”面板并定制它，这样我们就可以在它上面创建警报。</p><ol class=""><li id="126b" class="ms mt hi jm b jn kx jr ky jv ns jz nt kd nu kh mx my mz na bi translated">创建“上次握手”的复制面板</li></ol><figure class="mg mh mi mj fd ij er es paragraph-image"><div class="er es nv"><img src="../Images/1c4faa0c1f917d6dd84edfcc8b783d3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*Pa3kBZANqdNUhhet1-fxBQ.png"/></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:复制上次握手”面板</figcaption></figure><p id="ae28" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">2.编辑复制面板</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div class="er es nw"><img src="../Images/d34bf4d5c88a8baef305c43041067125.png" data-original-src="https://miro.medium.com/v2/resize:fit:814/format:webp/1*bhP16vFhQTKldoqCFv_PSQ.png"/></div></figure><p id="a3f7" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">3.将指标修改为以下内容:</p><pre class="mg mh mi mj fd mk lr ml mm aw mn bi"><span id="0192" class="ls in hi lr b fi mo mp l mq mr">time() - wireguard_latest_handshake_seconds</span></pre><p id="4114" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">3.将图例设置为<code class="du lo lp lq lr b">{{instance}}</code></p><p id="906b" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">4.关闭<code class="du lo lp lq lr b">Instant</code>指标。</p><p id="ae72" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">3.从面板选项卡中选择图形可视化</p><p id="8f05" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">4.从<code class="du lo lp lq lr b">Field</code>选项卡，将单位从<code class="du lo lp lq lr b">From Now</code>更改为<code class="du lo lp lq lr b">short</code></p><figure class="mg mh mi mj fd ij er es paragraph-image"><div class="er es nx"><img src="../Images/9e031b7d7c988572342e9e83c23f00bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/format:webp/1*n6zV6TvDh_2pc_YvZ146nw.png"/></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:单位变更屏幕</figcaption></figure><p id="1ea6" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">5.最后，单击保存</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="er es ny"><img src="../Images/64f127afc3fdd4da78cfc5dd2565e454.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cN5szLQmEXcWNSxjsTTT7w.png"/></div></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:定制面板</figcaption></figure></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h1 id="4ab8" class="im in hi bd io ip lj ir is it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj bi translated">警报管理器</h1><p id="1f3c" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">现在，让我们创建WireGuard连接丢失时的警报。</p><ol class=""><li id="5585" class="ms mt hi jm b jn kx jr ky jv ns jz nt kd nu kh mx my mz na bi translated">编辑面板</li></ol><figure class="mg mh mi mj fd ij er es paragraph-image"><div class="er es nz"><img src="../Images/d8b7682e852c17de83f374b52ce70262.png" data-original-src="https://miro.medium.com/v2/resize:fit:802/format:webp/1*npbX2zh9AYmoCTw_l6e85A.png"/></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:编辑面板屏幕</figcaption></figure><p id="319d" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">2.单击“警报”选项卡，然后单击“创建警报”</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="er es oa"><img src="../Images/afdf2b1023cb6227701de44f819f093f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uJeEY9kcoQXBrt__YOxZpA.png"/></div></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:创建警报屏幕</figcaption></figure><p id="4536" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">3.将条件设置为<code class="du lo lp lq lr b">WHEN avg() OF query(A, 1m, now) IS ABOVE 180</code></p><p id="70a6" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated"><strong class="jm hj">注意:</strong>警报阈值栏应该出现在仪表板中。</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div role="button" tabindex="0" class="no np di nq bf nr"><div class="er es ob"><img src="../Images/9319d2a1d853cdfeef9d8e74b681b85b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V6FssHr9pYCBzYdSy4d3ig.png"/></div></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:警报条件屏幕</figcaption></figure><p id="3a02" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">4.创建寻呼机工作警报或时差警报</p><figure class="mg mh mi mj fd ij er es paragraph-image"><div class="er es oc"><img src="../Images/cca7f09d2c03bbdfc404743e819291be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*pwAhB92c4UE8ywO2N8zXWw.png"/></div><figcaption class="ni nj et er es nk nl bd b be z dx translated">图:发送到屏幕</figcaption></figure><p id="e7ab" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">5.最后点击“保存”</p><p id="9695" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated"><strong class="jm hj">注意:</strong>通常情况下，WireGuard每2分钟发送一次健康检查，因此保持3分钟(即180秒)作为警报阈值是安全的。</p></div><div class="ab cl lc ld gp le" role="separator"><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh li"/><span class="lf bw bk lg lh"/></div><div class="hb hc hd he hf"><h1 id="32ae" class="im in hi bd io ip lj ir is it lk iv iw ix ll iz ja jb lm jd je jf ln jh ji jj bi translated">结论</h1><p id="cf0c" class="pw-post-body-paragraph jk jl hi jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh hb bi translated">除了WireGuard隧道监控之外，监控WireGuard隧道实例也很重要，这不在本文讨论范围之内。</p><p id="e057" class="pw-post-body-paragraph jk jl hi jm b jn kx jp jq jr ky jt ju jv kz jx jy jz la kb kc kd lb kf kg kh hb bi translated">我希望这篇文章对您有所帮助——保持安全👋</p><h1 id="9f4b" class="im in hi bd io ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj bi translated">参考</h1><ul class=""><li id="3379" class="ms mt hi jm b jn jo jr js jv mu jz mv kd mw kh od my mz na bi translated"><a class="ae ng" href="https://github.com/MindFlavor/prometheus_wireguard_exporter" rel="noopener ugc nofollow" target="_blank">https://github.com/MindFlavor/prometheus_wireguard_exporter</a></li><li id="ccbb" class="ms mt hi jm b jn nb jr nc jv nd jz ne kd nf kh od my mz na bi translated"><a class="ae ng" href="https://github.com/tuladhar/wireguard-connectivity-monitoring" rel="noopener ugc nofollow" target="_blank">https://github . com/tuladhar/wire guard-连接-监控</a></li></ul></div></div>    
</body>
</html>